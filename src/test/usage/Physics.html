<!DOCTYPE html>
<html>
<head>
  <title>Physics Usage - Monogatari</title>
  <link href="style.css" rel="stylesheet">
  <script src="../../../lib/require.js"></script>
  <script src="../setup.js"></script>
  <script>
    require(
        [ 'Monogatari' ], function( m ) {
          m.init();

          m.physicsManager.createWorld( new THREE.Vector2( 0, 10 ), true );

          // zombie1
          var zombie = new m.GameObject( 'zombie1' );
          var rb1 = new m.RigidBody( 50 );

          rb1.setType( rb1.DYNAMIC );
          rb1.setDensity( 1 );
          rb1.setFriction( 0 );
          rb1.setBounciness( 1 );
          rb1.setPosition( new THREE.Vector2( 3, 1 ) );

          m.physicsManager.attachToWorld( rb1 );
          rb1.createFixture();

          var sprite = new m.Sprite( '../resources/assets/zombies.png', 64, 64, 1, 3 );
          sprite.getMaterial().transparent = true;

          zombie.addComponent( sprite );
          zombie.addComponent( rb1 );

          m.sceneManager.attachToScene( zombie );
          m.world.children.push( zombie );

          // zombie2
          var zombie2 = new m.GameObject( 'zombie2' );
          var rb2 = new m.RigidBody( 50 );

          rb2.setType( rb2.DYNAMIC );
          rb2.setDensity( 1 );
          rb2.setFriction( 0 );
          rb2.setBounciness( 1 );
          rb2.setPosition( new THREE.Vector2( 2.7, 0.5 ) );

          m.physicsManager.attachToWorld( rb2 );
          rb2.createFixture();

          //<hacking>
          var buffer = Box2D.allocate( Box2D.intArrayFromString( "bolovo" ), 'i8', Box2D.ALLOC_STACK );

          rb2.body.SetUserData( buffer );
          //rb2.body.SetUserData( 35 );
          //console.log(  rb2.body.GetUserData() );

          var userData = rb2.body.GetUserData();
          console.log( String.fromCharCode( Box2D.getValue( userData, 'i8' ) ) ); // b
          console.log( String.fromCharCode( Box2D.getValue( userData+1, 'i8' ) ) ); // o
          console.log( String.fromCharCode( Box2D.getValue( userData+2, 'i8' ) ) ); // l
          console.log( String.fromCharCode( Box2D.getValue( userData+3, 'i8' ) ) ); // o
          console.log( String.fromCharCode( Box2D.getValue( userData+4, 'i8' ) ) ); // v
          console.log( String.fromCharCode( Box2D.getValue( userData+5, 'i8' ) ) ); // o
          //</hacking>

          zombie2.addComponent( new m.Sprite( '../resources/assets/zombies.png', 64, 64, 1, 3 ) );
          zombie2.addComponent( rb2 );

          m.sceneManager.attachToScene( zombie2 );
          m.world.children.push( zombie2 );

          //zombie3
          var zombie3 = new m.GameObject( 'zombie3' );
          var rb3 = new m.RigidBody( 50 );

          rb3.setType( rb3.DYNAMIC );
          rb3.setDensity( 1 );
          rb3.setFriction( 0 );
          rb3.setBounciness( 1 );
          rb3.setPosition( new THREE.Vector2( 1, 0.5 ) );

          m.physicsManager.attachToWorld( rb3 );

          rb3.createFixture();

          zombie3.addComponent( new m.Sprite( '../resources/assets/zombies.png', 64, 64, 1, 3 ) );
          zombie3.addComponent( rb3 );

          m.sceneManager.attachToScene( zombie3 );
          m.world.children.push( zombie3 );

          // ground
          var ground = new m.GameObject( 'ground' );
          var groundBody = new m.RigidBody( 50 );

          groundBody.setType( rb3.STATIC );
          groundBody.setDensity( 1 );
          groundBody.setFriction( 0 );
          groundBody.setBounciness( 1 );
          groundBody.setPosition( new THREE.Vector2( 0, 10 ) );

          m.physicsManager.attachToWorld( groundBody );

          var groundShape = new Box2D.b2PolygonShape();
          groundShape.SetAsBox( 100, 0.5 );
          groundBody.setShape( groundShape );
          groundBody.createFixture();

          ground.addComponent( groundBody );
          m.world.children.push( ground );

          // wall shape
          var wallShape = new Box2D.b2PolygonShape();
          wallShape.SetAsBox( 0.5, 100 );

          // left wall
          var lWall = new m.GameObject( 'lWall' );
          var lWallBody = new m.RigidBody( 50 );

          lWallBody.setType( rb3.STATIC );
          lWallBody.setDensity( 1 );
          lWallBody.setFriction( 0 );
          lWallBody.setBounciness( 1 );
          lWallBody.setPosition( new THREE.Vector2( 0, 0 ) );

          m.physicsManager.attachToWorld( lWallBody  );

          lWallBody.setShape( wallShape );
          lWallBody.createFixture();

          lWall.addComponent( lWallBody );
          m.world.children.push( lWall );


          // right wall
          var rWall = new m.GameObject( 'lWall' );
          var rWallBody = new m.RigidBody( 50 );

          rWallBody.setType( rb3.STATIC );
          rWallBody.setDensity( 1 );
          rWallBody.setFriction( 0 );
          rWallBody.setBounciness( 1 );
          rWallBody.setPosition( new THREE.Vector2( 10, 0 ) );

          m.physicsManager.attachToWorld( rWallBody  );

          rWallBody.setShape( wallShape );
          rWallBody.createFixture();

          rWall.addComponent( rWallBody );
          m.world.children.push( rWall );
          m.run();
        }
    );
  </script>
</head>
<body>

</body>
</html>