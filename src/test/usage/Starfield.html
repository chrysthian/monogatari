<!DOCTYPE html>
<meta charset="UTF-8">
<html>
<head>
  <title>Starfield - Monogatari</title>
  <link href="style.css" rel="stylesheet">
  <link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono' rel='stylesheet' type='text/css'>
  <script src="../../../lib/require.js"></script>
  <script src="../setup.js"></script>
  <script>
    require(
        [ 'Monogatari' ], function( m ) {
          var Starfield;
          var r = new m.Random();

          m.init( '#000', null, null, document.getElementById( 'c' ) );

          //STAR
          var Star = function( id ) {
            m.GameObject.call( this, 'star_' + id );

            this.speed = r.floating( { min: 100, max: 400 } );

            var material = new THREE.MeshBasicMaterial( { color: 0xFFFFFF } );
            var geometry = null;

            if( this.speed < 200 ) {
              geometry = new THREE.BoxGeometry( 1, 1, 1 )
            } else if( this.speed < 300 ) {
              geometry = new THREE.BoxGeometry( 2, 2, 1 )
            } else if( this.speed < 350 ) {
              geometry = new THREE.BoxGeometry( 3, 3, 1 )
            } else {
              geometry = new THREE.BoxGeometry( 4, 4, 1 )
            }

            this.addComponent( new m.BaseThree( material, geometry ) );

            this.init();
          };

          Star.prototype = Object.create( m.GameObject.prototype );

          Star.prototype.init = function() {
            this.isActive = false;
            this.isVisible = false;
            this.direction.x = 0;
            this.direction.y = 1;
          };

          Star.prototype.update = function() {
            var s = this.speed / m.timer.fps;
            this.position.x += this.direction.x * s;
            this.position.y += this.direction.y * s;

            if( this.position.x < 0 || this.position.y > m.sceneManager.canvasHeight )
              this.init();
          };
          //STAR

          //STARFIELD
          var STAR_COUNT = 100;
          Starfield = function() {
            this.buffer = new m.Map();
            this.it = this.buffer.iterator();

            for( var i = 0; i < STAR_COUNT; i++ ) {
              var star = new Star( i );

              this.buffer.put( star.id, star );
              m.world.children.push( star );
            }
          };

          Starfield.prototype.spawn = function() {
            this.it.first();
            var star = null;

            while( this.it.hasNext() ) {
              star = this.it.next();

              if( star && !star.isActive && !star.isVisible ) {
                star.isActive = true;
                star.isVisible = true;
                star.position.x = r.floating( { min: 0, max: m.sceneManager.canvasWidth } );
                star.position.y = -r.floating( { min: 0, max: m.sceneManager.canvasHeight } );
                star.position.z = 0;
              }
            }
          };
          //STARFIELD

          //DIALOG
          var dialog = new m.GameObject( 'dialog' );
          dialog.position.set( m.sceneManager.canvasWidth / 2 + 100, m.sceneManager.canvasHeight - 200, 0 );

          var t = 'We need to have people up there who can communicate what it FEELS like, not just pilots and engineers';
          dialog.addComponent( new m.FlyText( t, 25, 'Ubuntu Mono', m.sceneManager.canvasWidth, 200, '#FFFFFF' ) );

          dialog.update = function() {
            var text = this.findComponent( m.Base.FLY_TEXT );
            if( text.isLoaded ) {
              m.sceneManager.attachToScene( text );
            }

            if ( m.keyboard.isDown( m.keyboard.SPACE ) ){
              text.setText("Be humble for you are made of earth. Be noble for you are made of stars.");
            }
          };
          m.world.children.push( dialog );
          //DIALOG

          var stars = new Starfield();

          m.world.update = function() {
            stars.spawn();
          };
          m.run();
        }
    );
  </script>
</head>
<body>
<div id="ui" style="z-index: 10; position: absolute; width: 100%; height: 100%"></div>
<div id="c" style="z-index: 1;"></div>
</body>
</html>