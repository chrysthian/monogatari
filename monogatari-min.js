function extend(a,b){for(var c in b)a[c]=b[c]}function isInstanceOf(a,b){for(;"object"==typeof a;){if(a.constructor===b)return!0;a=a._super}return!1}!function(){var a=!1,b=/xyz/.test(function(){})?/\b_super\b/:/.*/;window.Class=function(){},Class.extend=function(c){function d(){!a&&this.init&&this.init.apply(this,arguments)}var e=this.prototype;a=!0;var f=new this;a=!1;for(var g in c)f[g]="function"==typeof c[g]&&"function"==typeof e[g]&&b.test(c[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,c[g]):c[g];return d.prototype=f,d.prototype.constructor=d,d.extend=arguments.callee,d}}(),define("lib/Class",function(){}),function(){function a(a,b){if(a||(a={}),!b)return a;for(var c in b)"undefined"==typeof a[c]&&(a[c]=b[c]);return a}function b(a,b){if(a)throw new RangeError(b)}var c=function(a){void 0!==a&&("function"==typeof a?this.random=a:this.seed=a),"undefined"==typeof this.random&&(this.mt=this.mersenne_twister(a),this.random=function(){return this.mt.random(this.seed)})};c.prototype.bool=function(c){return c=a(c,{likelihood:50}),b(0>c.likelihood||100<c.likelihood,"Chance: Likelihood accepts values from 0 to 100."),100*this.random()<c.likelihood},c.prototype.character=function(c){c=a(c);var d;return b(c.alpha&&c.symbols,"Chance: Cannot specify both alpha and symbols."),d="lower"===c.casing?"abcdefghijklmnopqrstuvwxyz":"upper"===c.casing?"ABCDEFGHIJKLMNOPQRSTUVWXYZ":"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",c=c.pool?c.pool:c.alpha?d:c.symbols?"!@#$%^&*()[]":d+"0123456789!@#$%^&*()[]",c.charAt(this.natural({max:c.length-1}))},c.prototype.floating=function(c){c=a(c,{fixed:4});var d=Math.pow(10,c.fixed);b(c.fixed&&c.precision,"Chance: Cannot specify both fixed and precision.");var e=9007199254740992/d,f=-e;return b(c.min&&c.fixed&&c.min<f,"Chance: Min specified is out of range with fixed. Min should be, at least, "+f),b(c.max&&c.fixed&&c.max>e,"Chance: Max specified is out of range with fixed. Max should be, at most, "+e),c=a(c,{min:f,max:e}),c=(this.integer({min:c.min*d,max:c.max*d})/d).toFixed(c.fixed),parseFloat(c)},c.prototype.integer=function(b){var c,d;b=a(b,{min:-9007199254740992,max:9007199254740992}),d=Math.max(Math.abs(b.min),Math.abs(b.max));do c=this.natural({max:d}),c=this.bool()?c:-1*c;while(c<b.min||c>b.max);return c},c.prototype.natural=function(c){return c=a(c,{min:0,max:9007199254740992}),b(c.min>c.max,"Chance: Min cannot be greater than Max."),Math.floor(this.random()*(c.max-c.min+1)+c.min)},c.prototype.normal=function(b){b=a(b,{mean:0,dev:1});var c,d,e=b.mean;b=b.dev;do d=2*this.random()-1,c=2*this.random()-1,c=d*d+c*c;while(c>=1);return d*=Math.sqrt(-2*Math.log(c)/c),b*d+e},c.prototype.string=function(b){b=a(b);var c=b.length||this.natural({min:5,max:20}),d="";b=b.pool;for(var e=0;c>e;e++)d+=this.character({pool:b});return d},c.prototype.capitalize=function(a){return a.charAt(0).toUpperCase()+a.substr(1)},c.prototype.mixin=function(a){for(var b in a)c.prototype[b]=a[b];return this},c.prototype.pick=function(a,b){return b&&1!==b?this.shuffle(a).slice(0,b):a[this.natural({max:a.length-1})]},c.prototype.shuffle=function(a){a=a.slice(0);for(var b=[],c=0,d=Number(a.length),e=0;d>e;e++)c=this.natural({max:a.length-1}),b[e]=a[c],a.splice(c,1);return b},c.prototype.ampm=function(){return this.bool()?"am":"pm"},c.prototype.date=function(b){var c=this.month({raw:!0});b=a(b,{year:parseInt(this.year(),10),month:c.numeric-1,day:this.natural({min:1,max:c.days}),hour:this.hour(),minute:this.minute(),second:this.second(),millisecond:this.millisecond(),american:!0,string:!1});var d=new Date(b.year,b.month,b.day,b.hour,b.minute,b.second,b.millisecond),c=b.american?d.getMonth()+1+"/"+d.getDate()+"/"+d.getFullYear():d.getDate()+"/"+(d.getMonth()+1)+"/"+d.getFullYear();return b.string?c:d},c.prototype.hammertime=function(a){return this.date(a).getTime()},c.prototype.hour=function(b){return b=a(b),this.natural({min:1,max:b.twentyfour?24:12})},c.prototype.millisecond=function(){return this.natural({max:999})},c.prototype.minute=c.prototype.second=function(){return this.natural({max:59})},c.prototype.month=function(b){b=a(b);var c=this.pick(this.months());return b.raw?c:c.name},c.prototype.months=function(){return[{name:"January",short_name:"Jan",numeric:"01",days:31},{name:"February",short_name:"Feb",numeric:"02",days:28},{name:"March",short_name:"Mar",numeric:"03",days:31},{name:"April",short_name:"Apr",numeric:"04",days:30},{name:"May",short_name:"May",numeric:"05",days:31},{name:"June",short_name:"Jun",numeric:"06",days:30},{name:"July",short_name:"Jul",numeric:"07",days:31},{name:"August",short_name:"Aug",numeric:"08",days:31},{name:"September",short_name:"Sep",numeric:"09",days:30},{name:"October",short_name:"Oct",numeric:"10",days:31},{name:"November",short_name:"Nov",numeric:"11",days:30},{name:"December",short_name:"Dec",numeric:"12",days:31}]},c.prototype.second=function(){return this.natural({max:59})},c.prototype.timestamp=function(){return this.natural({min:1,max:parseInt((new Date).getTime()/1e3,10)})},c.prototype.year=function(b){return b=a(b,{min:(new Date).getFullYear()}),b.max="undefined"!=typeof b.max?b.max:b.min+100,this.natural(b).toString()},c.prototype.d4=function(){return this.natural({min:1,max:4})},c.prototype.d6=function(){return this.natural({min:1,max:6})},c.prototype.d8=function(){return this.natural({min:1,max:8})},c.prototype.d10=function(){return this.natural({min:1,max:10})},c.prototype.d12=function(){return this.natural({min:1,max:12})},c.prototype.d20=function(){return this.natural({min:1,max:20})},c.prototype.d30=function(){return this.natural({min:1,max:30})},c.prototype.d100=function(){return this.natural({min:1,max:100})},c.prototype.rpg=function(b,c){if(c=a(c),null===b)throw Error("A type of die roll must be included");var d=b.toLowerCase().split("d"),e=[];if(2!==d.length||!parseInt(d[0],10)||!parseInt(d[1],10))throw Error("Invalid format provided. Please provide #d# where the first # is the number of dice to roll, the second # is the max of each die");for(var f=d[0];f>0;f--)e[f-1]=this.natural({min:1,max:d[1]});return"undefined"!=typeof c.sum&&c.sum?e.reduce(function(a,b){return a+b}):e},c.prototype.guid=function(a){return a=a||{version:5},this.string({pool:"ABCDEF1234567890",length:8})+"-"+this.string({pool:"ABCDEF1234567890",length:4})+"-"+a.version+this.string({pool:"ABCDEF1234567890",length:3})+"-"+this.string({pool:"AB89",length:1})+this.string({pool:"ABCDEF1234567890",length:3})+"-"+this.string({pool:"ABCDEF1234567890",length:12})},c.prototype.hash=function(b){return b=a(b,{length:40,casing:"lower"}),this.string({pool:"upper"===b.casing?"0123456789ABCDEF":"0123456789abcdef",length:b.length})},c.prototype.luhn_check=function(a){return a=a.toString(),+a.substring(a.length-1)===this.luhn_calculate(+a.substring(0,a.length-1))},c.prototype.luhn_calculate=function(a){a=a.toString().split("").reverse();for(var b=0,c=0,d=a.length;d>c;++c){var e=+a[c];0===c%2&&(e*=2,e>9&&(e-=9)),b+=e}return 9*b%10},c.prototype.mersenne_twister=function(a){return new d(a)},c.prototype.VERSION="0.5.4";var d=function(a){void 0===a&&(a=(new Date).getTime()),this.N=624,this.M=397,this.MATRIX_A=2567483615,this.UPPER_MASK=2147483648,this.LOWER_MASK=2147483647,this.mt=Array(this.N),this.mti=this.N+1,this.init_genrand(a)};d.prototype.init_genrand=function(a){for(this.mt[0]=a>>>0,this.mti=1;this.mti<this.N;this.mti++)a=this.mt[this.mti-1]^this.mt[this.mti-1]>>>30,this.mt[this.mti]=(1812433253*((4294901760&a)>>>16)<<16)+1812433253*(65535&a)+this.mti,this.mt[this.mti]>>>=0},d.prototype.init_by_array=function(a,b){var c,d,e=1,f=0;for(this.init_genrand(19650218),c=this.N>b?this.N:b;c;c--)d=this.mt[e-1]^this.mt[e-1]>>>30,this.mt[e]=(this.mt[e]^(1664525*((4294901760&d)>>>16)<<16)+1664525*(65535&d))+a[f]+f,this.mt[e]>>>=0,e++,f++,e>=this.N&&(this.mt[0]=this.mt[this.N-1],e=1),f>=b&&(f=0);for(c=this.N-1;c;c--)d=this.mt[e-1]^this.mt[e-1]>>>30,this.mt[e]=(this.mt[e]^(1566083941*((4294901760&d)>>>16)<<16)+1566083941*(65535&d))-e,this.mt[e]>>>=0,e++,e>=this.N&&(this.mt[0]=this.mt[this.N-1],e=1);this.mt[0]=2147483648},d.prototype.genrand_int32=function(){var a,b=[0,this.MATRIX_A];if(this.mti>=this.N){var c;for(this.mti===this.N+1&&this.init_genrand(5489),c=0;c<this.N-this.M;c++)a=this.mt[c]&this.UPPER_MASK|this.mt[c+1]&this.LOWER_MASK,this.mt[c]=this.mt[c+this.M]^a>>>1^b[1&a];for(;c<this.N-1;c++)a=this.mt[c]&this.UPPER_MASK|this.mt[c+1]&this.LOWER_MASK,this.mt[c]=this.mt[c+(this.M-this.N)]^a>>>1^b[1&a];a=this.mt[this.N-1]&this.UPPER_MASK|this.mt[0]&this.LOWER_MASK,this.mt[this.N-1]=this.mt[this.M-1]^a>>>1^b[1&a],this.mti=0}return a=this.mt[this.mti++],a^=a>>>11,a^=a<<7&2636928640,a^=a<<15&4022730752,(a^a>>>18)>>>0},d.prototype.genrand_int31=function(){return this.genrand_int32()>>>1},d.prototype.genrand_real1=function(){return this.genrand_int32()*(1/4294967295)},d.prototype.random=function(){return this.genrand_int32()*(1/4294967296)},d.prototype.genrand_real3=function(){return(this.genrand_int32()+.5)*(1/4294967296)},d.prototype.genrand_res53=function(){var a=this.genrand_int32()>>>5,b=this.genrand_int32()>>>6;return 1.1102230246251565e-16*(67108864*a+b)},"undefined"!=typeof exports&&("undefined"!=typeof module&&module.exports&&(exports=module.exports=c),exports.Chance=c),"function"==typeof define&&define.amd&&define("Chance",[],function(){return c}),"object"==typeof window&&"object"==typeof window.document&&(window.Chance=c,window.chance=new c)}(),define("lib/Random",function(){}),define("core/Monogatari",["lib/Class","lib/Random"],function(){function a(a){return a+(0>a?-.5:.5)>>0}function b(a){return a+(0>a?0:1)>>0}function c(a){return 0|a}function d(a){return a>0?a:-a}function e(a,b){return b>a?a:b}function f(a,b){return a>b?a:b}var g={};g._undefined=void 0,g.acos=Math.acos,g.sqrt=Math.sqrt,g.sin=Math.sin,g.cos=Math.cos,g.tan=Math.tan,g.atan=Math.atan,g.atan2=Math.atan2,g.pow=Math.pow,g.min=e,g.max=f,g.abs=d,g.round=a,g.ceil=b,g.floor=c,g.Random=chance,window.Monogatari=g}),define("core/Timer",["core/Monogatari"],function(){function a(){this._last=0,this._cycleTime=1e9,this.time=0,this.maxStep=60}function b(){this._lastTime=0,this._ticks=0,this._fps=0}Monogatari.Time=new a,a.prototype.tick=function(){var a=Date.now(),b=a-this._last;this.time>this._cycleTime&&(this.time=0),this.time+=Monogatari.min(b,this.maxStep),this._last=a},a.prototype.getTime=function(){return this.time>this._cycleTime&&(this.time=0),this.time},a.prototype.compare=function(a){return a>this.time?this.time+this._cycleTime-a:this.time-a},Monogatari.Frames=new b,b.prototype.getFps=function(){var a=Monogatari.Time.getTime(),b=a-this._lastTime;return b>=1e3&&(this._fps=this._ticks,this._ticks=0,this._lastTime=a),this._ticks++,this._fps}}),define("core/Constants",["core/Monogatari"],function(){function a(){this.BROWSER_ANDROID=1,this.BROWSER_CHROME=2,this.BROWSER_FIREFOX=3,this.BROWSER_IOS=4,this.BROWSER_SAFARI=5,this.BROWSER_OPERA=6,this.BROWSER_BLACKBERRY=7,this.BROWSER_IE=8,this.MODE_DEBUG=1,this.MODE_RELEASE=2,this.FRAME_RATE_60FPS=.016666666667,this.ONE_MEGABYTE=1048576,this.RADTODEG=57.295779513082,this.DEGTORAD=.0174532925199,this.SQRT_2=1.41421356237,this.PI=3.14159265358979,this.PI_2=6.28318530717958,this.PI_OVER_180=.0174532925199,this.PI_OVER_360=.0087266462599,this.ONE_DEGREE=this.PI_OVER_180,this.ASSET_STATE_LOADING=1,this.ASSET_STATE_LOADED=2,this.ASSET_STATE_FAILED=3,this.AUDIO_STATE_STOPED=0,this.AUDIO_STATE_PLAYING=1,this.AUDIO_STATE_PAUSED=2,this.AUDIO_STATE_FINISHED=3,this.COMPONENT_STATE_INITIALIZING=0,this.COMPONENT_STATE_BUFFERING=1,this.COMPONENT_STATE_READY=2,this.COMPONENT_STATE_FAILED=3,this.COMPONENT_BASE=0,this.COMPONENT_NODE=1,this.COMPONENT_THREE_OBJECT=2,this.COMPONENT_RIGID_BODY=3,this.COMPONENT_SPRITE=4,this.COMPONENT_STATIC_TEXT=5,this.COMPONENT_AUDIO_SOURCE=6,this.COMPONENT_PARTICLE_EMITTER=7,this.COMPONENT_CUSTOM=-1,this.FONT_CHARS_SIMPLE="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_()-,.[]!?@$* ",this.REGEXP_URL=/(http|https):\/\/[\w-]+(\.[\w-]+)+([\w.,@?^=%&amp;:\/~+#-]*[\w@?^=%&amp;\/~+#-])?/,this.REGEXP_BETWEEN_SQUARE_BRACKETS=/\[[\w|\W]+\]/,this.REGEXP_ENDLINE=/\r\n|\r|\n/,this.PHYSICS_BODYTYPE_STATIC=1,this.PHYSICS_BODYTYPE_KINEMATIC=2,this.PHYSICS_BODYTYPE_DYNAMIC=3,this.DEFAULT_CAMERA_ID="default_camera_id",this.DEFAULT_SCENE_ID="default_scene_id"}Monogatari.Constants=new a}),define("core/String",["core/Monogatari","core/Constants"],function(){function a(){}Monogatari.String=new a,a.prototype.left=function(a,b){return 0>=b?"":b>a.length?a:a.substring(0,b)},a.prototype.right=function(a,b){if(0>=b)return"";if(b>a.length)return a;var c=a.length;return a.substring(c,c-b)},a.prototype.endsWith=function(a,b){var c=a.length-b.length;return c>=0&&a.indexOf(b,c)===c},a.prototype.startsWith=function(a,b){return 0===a.lastIndexOf(b,0)},a.prototype.contains=function(a,b){return-1!=a.indexOf(b)},a.prototype.getFileExtension=function(a){return/\.([a-zA-Z0-9]+)/.exec(a)[1]},a.prototype.isBetweenSquareBraquets=function(a){return/\[[\w|\W]+\]/.test(a)},a.prototype.isUrl=function(a){return Monogatari.Constants.REGEXP_URL.test(a)},a.prototype.isAlpha=function(a){return!/[^a-zA-Z]/.test(a)},a.prototype.isNumeric=function(a){return!/[^0-9]/.test(a)},a.prototype.isAlphaNumeric=function(a){return!/[^a-zA-Z0-9]/.test(a)},a.prototype.countOf=function(a,b){return a&&b?a.split(b).length-1:0},a.prototype.format=function(a){var b,c=Monogatari.Array.flat(arguments);c.shift();for(var d=0,e=c.length;e>d;d++)b=new RegExp("\\{"+d+"\\}","gi"),a=a.replace(b,c[d]);return a},a.prototype.trim=function(a){return a.replace(/^[\s\xa0]+|[\s\xa0]+$/g,"")},a.prototype.utf8_encode=function(a){a=(a+"").replace(/\r\n/g,"\n").replace(/\r/g,"\n");var b="",c=0,d=0,e=0;e=a.length;for(var f=0;e>f;f++){var g=a.charCodeAt(f),h=null;128>g?d++:h=g>127&&2048>g?String.fromCharCode(g>>6|192)+String.fromCharCode(63&g|128):String.fromCharCode(g>>12|224)+String.fromCharCode(g>>6&63|128)+String.fromCharCode(63&g|128),null!=h&&(d>c&&(b+=a.substring(c,d)),b+=h,c=d=f+1)}return d>c&&(b+=a.substring(c,a.length)),b},a.prototype.utf8_decode=function(a){var b=[],c=0,d=0,e=0,f=0,g=0;for(a+="";c<a.length;)e=a.charCodeAt(c),128>e?(b[d++]=String.fromCharCode(e),c++):e>191&&224>e?(f=a.charCodeAt(c+1),b[d++]=String.fromCharCode((31&e)<<6|63&f),c+=2):(f=a.charCodeAt(c+1),g=a.charCodeAt(c+2),b[d++]=String.fromCharCode((15&e)<<12|(63&f)<<6|63&g),c+=3);return b.join("")}}),define("core/Util",["core/Monogatari","core/Constants"],function(){function a(){this._browserDetect={},this._browserDetect.agent=window.navigator.userAgent,this._browserDetect.version=window.navigator.appVersion,this._browserDetect.plataform=window.navigator.platform;var a=this._browserDetect.agent;this._browserDetect.isFirefox=a.indexOf("Firefox")>-1,this._browserDetect.isOpera=null!=window.opera,this._browserDetect.isChrome=a.indexOf("Chrome")>-1,this._browserDetect.isIOS=a.indexOf("iPod")>-1||a.indexOf("iPhone")>-1||a.indexOf("iPad")>-1,this._browserDetect.isAndroid=a.indexOf("Android")>-1,this._browserDetect.isBlackberry=a.indexOf("Blackberry")>-1,this._browserDetect.isIE=a.indexOf("MSIE")>-1}Monogatari.Util=new a,a.prototype.createUniqueId=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})},a.prototype.equals=function(a,b){return null===a||null===b?null===a&&null===b:"string"==typeof a?a===b:"object"!=typeof a?a===b:a.equals instanceof Function?a.equals(b):a===b},a.prototype.parseUnitSize=function(a){var b=a.length-2;return 0>b?a:a.indexOf("pt")===b?1.25*parseFloat(a.substring(0,b)):a.indexOf("pc")===b?15*parseFloat(a.substring(0,b)):a.indexOf("mm")===b?3.543307*parseFloat(a.substring(0,b)):a.indexOf("cm")===b?35.43307*parseFloat(a.substring(0,b)):a.indexOf("in")===b?90*parseFloat(a.substring(0,b)):parseFloat(a.indexOf("px")===b?a.substring(0,b):a)},a.prototype.typeOf=function(a){return Object.prototype.toString.apply(a)},a.prototype.store=function(a,b,c){c?localStorage.setItem(a,JSON.stringify(b)):localStorage.setItem(a,b)},a.prototype.getBrowser=function(){return this._browserDetect.isAndroid?Monogatari.Constants.BROWSER_ANDROID:this._browserDetect.isChrome?Monogatari.Constants.BROWSER_CHROME:this._browserDetect.isFirefox?Monogatari.Constants.BROWSER_FIREFOX:this._browserDetect.isIOS?Monogatari.Constants.BROWSER_IOS:this._browserDetect.isOpera?Monogatari.Constants.BROWSER_OPERA:this._browserDetect.isBlackberry?Monogatari.Constants.BROWSER_BLACKBERRY:this._browserDetect.isIE?Monogatari.Constants.BROWSER_IE:void 0}}),define("core/Array",["core/Monogatari","core/Util"],function(){function a(){}Monogatari.Array=new a,a.prototype.float32Concat=function(a,b){var c=a.length,d=new Float32Array(c+b.length);return d.set(a),d.set(b,c),d},a.prototype.quicksort=function(a){if(0==a.length)return new Array;for(var b=new Array,c=new Array,d=a[0],e=1,f=a.length;f>e;e++)a[e]<d?b[b.length]=a[e]:c[c.length]=a[e];return this.quicksort(b).concat(d,this.quicksort(c))},a.prototype.unique=function(a){for(var b=[],c=!1,d=0,e=a.length;e>d;d++){c=!1;for(var f=0;f<b.length;f++)if(Monogatari.Util.equals(a[d],b[f])){c=!0;break}c||b.push(a[d])}return b},a.prototype.aphabeticalSort=function(a){return this.isArray(a)?(a.sort(function(a,b){return a.group<b.group?-1:a.group<b.group?1:0}),a):null},a.prototype.isArray=function(a){return"[object Array]"===Object.prototype.toString.apply(a)},a.prototype.indexOf=function(a,b,c){var d;if(this.isArray(b)){if(b.indexOf&&"function"==typeof b.indexOf)return b.indexOf(a,c);for(d=b.length,c=c?0>c?max(0,d+c):c:0;d>c;c++)if(c in b&&b[c]===a)return c}return-1},a.prototype.inArray=function(a,b,c){return Monogatari.Array.indexOf(a,b,c)>=0?!0:!1},a.prototype.remove=function(a,b,c){var d=a.slice((c||b)+1||a.length);return a.length=0>b?a.length+b:b,a.push.apply(a,d)},a.prototype.equals=function(a,b){var c=a.length,d=b.length;if(c!=d)return!1;for(var e=0;d>e;e++)if(this.isArray(a[e])){if(!this.equals(a[e],b[e]))return!1}else if(!Monogatari.Util.equals(a[e],b[e]))return!1;return!0},a.prototype.intersection=function(a,b){var c=concat.apply(Array.prototype,slice.call(b,1));return Monogatari.Array.unique(a).filter(function(a){return Monogatari.Array.inArray(a,c)})},a.prototype.difference=function(a,b){var c=concat.apply(Array.prototype,slice.call(b,1)),d=Monogatari.Array.unique(a).filter(function(a){return!Monogatari.Array.inArray(a,c)});return d},a.prototype.chunk=function(a,b){for(var c,d=0,e=-1,f=a.length,g=[];f>d;d++)(c=d%b)?g[e][c]=a[d]:g[++e]=[a[d]];return g},a.prototype.flat=function(a){return a.reduce(function(a,b){return a.concat(b)},[])}}),define("core/collection/Iterator",["core/Monogatari","core/Array"],function(){Monogatari.Iterator=Class.extend({init:function(a){return a instanceof Array?(this.index=-1,this.hasNext=function(){return this.index+1<a.length},this.next=function(){return a[++this.index]},void 0):(console.log("Unable to iterate: "+a),null)}}),Monogatari.ListIterator=Monogatari.Iterator.extend({init:function(a){return a instanceof Array?(this._super(a),this.hasPrevious=function(){return this.index>0},this.previous=function(){return a[--this.index]},this.first=function(){return this.index=-1,a.length>0?a[0]:null},this.last=function(){return this.index=a.length-1,a.length>0?a[this.index]:null},void 0):(console.log("Unable to iterate: "+a),null)}}),Monogatari.MapIterator=Class.extend({init:function(a,b){this.index=-1,this.hasNext=function(){return this.index+1<a.length},this.hasPrevious=function(){return this.index>0},this.next=function(){return b[a[++this.index]]},this.previous=function(){return b[a[--this.index]]},this.first=function(){return this.index=-1,a.length>0?b[a[0]]:null},this.last=function(){return this.index=a.length-1,a.length>0?b[a[this.index]]:null}}}),Monogatari.TreeIterator=Class.extend({init:function(a,b){this.index=-1,this.hasNext=function(){return this.index+1<a.length},this.hasPrevious=function(){return this.index>0},this.next=function(){return b[a[++this.index]].value},this.previous=function(){return b[a[--this.index]].value},this.first=function(){return this.index=-1,a.length>0?b[a[0]]:null},this.last=function(){return this.index=a.length-1,a.length>0?b[a[this.index]].value:null}}})}),define("core/collection/Map",["core/Monogatari","core/Array","core/collection/Iterator"],function(){Monogatari.Map=Class.extend({init:function(a,b){this._keys=a?a:new Array,this._values=b?b:{}},contains:function(a){return Monogatari.Array.inArray(a,this._keys)},get:function(a){return this.contains(a)?this._values[a]:null},put:function(a,b){var c=a?a:this.size();return this.contains(c)||this._keys.push(c),b?this._values[c]=b:this._values[c]||(this._values[c]=null),this._values[c]},size:function(){return this._keys.length},nullify:function(a){this._values[a]&&(this._values[a]=null)},concat:function(a){for(var b=a.getKeys(),c=a.getValues(),d=0,e=b.length;e>d;d++)this.put(b[d],c[d])},remove:function(a){if(this.contains(a))for(var b=0,c=this._keys.length;c>b;b++)this._keys[b]===a&&this._keys.splice(b,1)},removeFromCache:function(a){if(this.contains(a)){this._values[a]=null,delete this._values[a];for(var b=0,c=this._keys.length;c>b;b++)this._keys[b]===a&&this._keys.splice(b,1)}},clear:function(){this._values.length=0,this._values={},this._keys.length=0},isEmpty:function(){return 0===this.size()},call:function(a,b){this.contains(a)&&"function"==typeof this._values[a]&&this._values[a](b)},getKeys:function(){return this._keys},getValues:function(){for(var a=new Array,b=0,c=this.size();c>b;b++)a[b]=this._values[this._keys[b]];return a},toArray:function(){return this.getValues()},toJSON:function(){for(var a={},b=0,c=this.size();c>b;b++)a[this._keys[b]]=this._values[this._keys[b]];return JSON.stringify(a)},clone:function(){return new Monogatari.Map(this._keys,this._values)},iterator:function(){return new Monogatari.MapIterator(this._keys,this._values)}})}),define("engine/EventManager",["core/Monogatari","core/Constants","core/collection/Map"],function(){function a(){this._listeners=new Monogatari.Map,this._iterator=this._listeners.iterator()}Monogatari.Event=function(a,b){this.type=a,this.handler=b},Monogatari.Message=function(a,b,c,d,e){this.from=a,this.to=b,this.type=c,this.message=d,this.handler=e},Monogatari.EventManager=new a,a.prototype.addListener=function(a,b,c){this._listeners.put(a,new Monogatari.Event(b,c))},a.prototype.notify=function(a,b){this._iterator.first();for(var c;this._iterator.hasNext();)c=this._iterator.next(),c.type==a&&c.handler(b)},a.prototype.removeListener=function(a){this._listeners.removeFromCache(a)}}),this.createjs=this.createjs||{},function(){var a=createjs.PreloadJS=createjs.PreloadJS||{};a.version="NEXT",a.buildDate="Thu, 12 Dec 2013 23:37:07 GMT"}(),this.createjs=this.createjs||{},function(){var a=function(a,b,c){this.initialize(a,b,c)},b=a.prototype;b.type=null,b.target=null,b.currentTarget=null,b.eventPhase=0,b.bubbles=!1,b.cancelable=!1,b.timeStamp=0,b.defaultPrevented=!1,b.propagationStopped=!1,b.immediatePropagationStopped=!1,b.removed=!1,b.initialize=function(a,b,c){this.type=a,this.bubbles=b,this.cancelable=c,this.timeStamp=(new Date).getTime()},b.preventDefault=function(){this.defaultPrevented=!0},b.stopPropagation=function(){this.propagationStopped=!0},b.stopImmediatePropagation=function(){this.immediatePropagationStopped=this.propagationStopped=!0},b.remove=function(){this.removed=!0},b.clone=function(){return new a(this.type,this.bubbles,this.cancelable)},b.toString=function(){return"[Event (type="+this.type+")]"},createjs.Event=a}(),this.createjs=this.createjs||{},function(){var a=function(){},b=a.prototype;a.initialize=function(a){a.addEventListener=b.addEventListener,a.on=b.on,a.removeEventListener=a.off=b.removeEventListener,a.removeAllEventListeners=b.removeAllEventListeners,a.hasEventListener=b.hasEventListener,a.dispatchEvent=b.dispatchEvent,a._dispatchEvent=b._dispatchEvent,a.willTrigger=b.willTrigger},b._listeners=null,b._captureListeners=null,b.initialize=function(){},b.addEventListener=function(a,b,c){var d;d=c?this._captureListeners=this._captureListeners||{}:this._listeners=this._listeners||{};var e=d[a];return e&&this.removeEventListener(a,b,c),e=d[a],e?e.push(b):d[a]=[b],b},b.on=function(a,b,c,d,e,f){return b.handleEvent&&(c=c||b,b=b.handleEvent),c=c||this,this.addEventListener(a,function(a){b.call(c,a,e),d&&a.remove()},f)},b.removeEventListener=function(a,b,c){var d=c?this._captureListeners:this._listeners;if(d){var e=d[a];if(e)for(var f=0,g=e.length;g>f;f++)if(e[f]==b){1==g?delete d[a]:e.splice(f,1);break}}},b.off=b.removeEventListener,b.removeAllEventListeners=function(a){a?(this._listeners&&delete this._listeners[a],this._captureListeners&&delete this._captureListeners[a]):this._listeners=this._captureListeners=null},b.dispatchEvent=function(a,b){if("string"==typeof a){var c=this._listeners;if(!c||!c[a])return!1;a=new createjs.Event(a)}if(a.target=b||this,a.bubbles&&this.parent){for(var d=this,e=[d];d.parent;)e.push(d=d.parent);var f,g=e.length;for(f=g-1;f>=0&&!a.propagationStopped;f--)e[f]._dispatchEvent(a,1+(0==f));for(f=1;g>f&&!a.propagationStopped;f++)e[f]._dispatchEvent(a,3)}else this._dispatchEvent(a,2);return a.defaultPrevented},b.hasEventListener=function(a){var b=this._listeners,c=this._captureListeners;return!!(b&&b[a]||c&&c[a])},b.willTrigger=function(a){for(var b=this;b;){if(b.hasEventListener(a))return!0;b=b.parent}return!1},b.toString=function(){return"[EventDispatcher]"},b._dispatchEvent=function(a,b){var c,d=1==b?this._captureListeners:this._listeners;if(a&&d){var e=d[a.type];if(!e||!(c=e.length))return;a.currentTarget=this,a.eventPhase=b,a.removed=!1,e=e.slice();for(var f=0;c>f&&!a.immediatePropagationStopped;f++){var g=e[f];g.handleEvent?g.handleEvent(a):g(a),a.removed&&(this.off(a.type,g,1==b),a.removed=!1)}}},createjs.EventDispatcher=a}(),this.createjs=this.createjs||{},function(){createjs.indexOf=function(a,b){for(var c=0,d=a.length;d>c;c++)if(b===a[c])return c;return-1}}(),this.createjs=this.createjs||{},function(){createjs.proxy=function(a,b){var c=Array.prototype.slice.call(arguments,2);return function(){return a.apply(b,Array.prototype.slice.call(arguments,0).concat(c))}}}(),this.createjs=this.createjs||{},function(){var a=function(){this.init()};a.prototype=new createjs.EventDispatcher;var b=a.prototype,c=a;c.FILE_PATTERN=/^(?:(\w+:)\/{2}(\w+(?:\.\w+)*\/?)|(.{0,2}\/{1}))?([/.]*?(?:[^?]+)?\/)?((?:[^/?]+)\.(\w+))(?:\?(\S+)?)?$/,c.PATH_PATTERN=/^(?:(\w+:)\/{2})|(.{0,2}\/{1})?([/.]*?(?:[^?]+)?\/?)?$/,b.loaded=!1,b.canceled=!1,b.progress=0,b._item=null,b.getItem=function(){return this._item},b.init=function(){},b.load=function(){},b.close=function(){},b._sendLoadStart=function(){this._isCanceled()||this.dispatchEvent("loadstart")},b._sendProgress=function(a){if(!this._isCanceled()){var b=null;"number"==typeof a?(this.progress=a,b=new createjs.Event("progress"),b.loaded=this.progress,b.total=1):(b=a,this.progress=a.loaded/a.total,(isNaN(this.progress)||1/0==this.progress)&&(this.progress=0)),b.progress=this.progress,this.hasEventListener("progress")&&this.dispatchEvent(b)}},b._sendComplete=function(){this._isCanceled()||this.dispatchEvent("complete")},b._sendError=function(a){!this._isCanceled()&&this.hasEventListener("error")&&(null==a&&(a=new createjs.Event("error")),this.dispatchEvent(a))},b._isCanceled=function(){return null==window.createjs||this.canceled?!0:!1},b._parseURI=function(a){return a?a.match(c.FILE_PATTERN):null},b._parsePath=function(a){return a?a.match(c.PATH_PATTERN):null},b._formatQueryString=function(a,b){if(null==a)throw new Error("You must specify data.");var c=[];for(var d in a)c.push(d+"="+escape(a[d]));return b&&(c=c.concat(b)),c.join("&")},b.buildPath=function(a,b){if(null==b)return a;var c=[],d=a.indexOf("?");if(-1!=d){var e=a.slice(d+1);c=c.concat(e.split("&"))}return-1!=d?a.slice(0,d)+"?"+this._formatQueryString(b,c):a+"?"+this._formatQueryString(b,c)},b._isCrossDomain=function(a){var b=document.createElement("a");b.href=a.src;var c=document.createElement("a");c.href=location.href;var d=""!=b.hostname&&(b.port!=c.port||b.protocol!=c.protocol||b.hostname!=c.hostname);return d},b._isLocal=function(a){var b=document.createElement("a");return b.href=a.src,""==b.hostname&&"file:"==b.protocol},b.toString=function(){return"[PreloadJS AbstractLoader]"},createjs.AbstractLoader=a}(),this.createjs=this.createjs||{},function(){var a=function(a,b,c){this.init(a,b,c)},b=a.prototype=new createjs.AbstractLoader,c=a;c.loadTimeout=8e3,c.LOAD_TIMEOUT=0,c.BINARY="binary",c.CSS="css",c.IMAGE="image",c.JAVASCRIPT="javascript",c.JSON="json",c.JSONP="jsonp",c.MANIFEST="manifest",c.SOUND="sound",c.SVG="svg",c.TEXT="text",c.XML="xml",c.POST="POST",c.GET="GET",b._basePath=null,b._crossOrigin="",b.useXHR=!0,b.stopOnError=!1,b.maintainScriptOrder=!0,b.next=null,b._typeCallbacks=null,b._extensionCallbacks=null,b._loadStartWasDispatched=!1,b._maxConnections=1,b._currentlyLoadingScript=null,b._currentLoads=null,b._loadQueue=null,b._loadQueueBackup=null,b._loadItemsById=null,b._loadItemsBySrc=null,b._loadedResults=null,b._loadedRawResults=null,b._numItems=0,b._numItemsLoaded=0,b._scriptOrder=null,b._loadedScripts=null,b.init=function(a,b,c){this._numItems=this._numItemsLoaded=0,this._paused=!1,this._loadStartWasDispatched=!1,this._currentLoads=[],this._loadQueue=[],this._loadQueueBackup=[],this._scriptOrder=[],this._loadedScripts=[],this._loadItemsById={},this._loadItemsBySrc={},this._loadedResults={},this._loadedRawResults={},this._typeCallbacks={},this._extensionCallbacks={},this._basePath=b,this.setUseXHR(a),this._crossOrigin=c===!0?"Anonymous":c===!1||null==c?"":c},b.setUseXHR=function(a){return this.useXHR=0!=a&&null!=window.XMLHttpRequest,this.useXHR},b.removeAll=function(){this.remove()},b.remove=function(a){var b=null;if(!a||a instanceof Array){if(a)b=a;else if(arguments.length>0)return}else b=[a];var c=!1;if(b){for(;b.length;){var d=b.pop(),e=this.getResult(d);for(f=this._loadQueue.length-1;f>=0;f--)if(g=this._loadQueue[f].getItem(),g.id==d||g.src==d){this._loadQueue.splice(f,1)[0].cancel();break}for(f=this._loadQueueBackup.length-1;f>=0;f--)if(g=this._loadQueueBackup[f].getItem(),g.id==d||g.src==d){this._loadQueueBackup.splice(f,1)[0].cancel();break}if(e)delete this._loadItemsById[e.id],delete this._loadItemsBySrc[e.src],this._disposeItem(e);else for(var f=this._currentLoads.length-1;f>=0;f--){var g=this._currentLoads[f].getItem();if(g.id==d||g.src==d){this._currentLoads.splice(f,1)[0].cancel(),c=!0;break}}}c&&this._loadNext()}else{this.close();for(var h in this._loadItemsById)this._disposeItem(this._loadItemsById[h]);this.init(this.useXHR)}},b.reset=function(){this.close();for(var a in this._loadItemsById)this._disposeItem(this._loadItemsById[a]);for(var b=[],c=0,d=this._loadQueueBackup.length;d>c;c++)b.push(this._loadQueueBackup[c].getItem());this.loadManifest(b,!1)},c.isBinary=function(a){switch(a){case createjs.LoadQueue.IMAGE:case createjs.LoadQueue.BINARY:return!0;default:return!1}},c.isText=function(a){switch(a){case createjs.LoadQueue.TEXT:case createjs.LoadQueue.JSON:case createjs.LoadQueue.MANIFEST:case createjs.LoadQueue.XML:case createjs.LoadQueue.HTML:case createjs.LoadQueue.CSS:case createjs.LoadQueue.SVG:case createjs.LoadQueue.JAVASCRIPT:return!0;default:return!1}},b.installPlugin=function(a){if(null!=a&&null!=a.getPreloadHandlers){var b=a.getPreloadHandlers();if(b.scope=a,null!=b.types)for(var c=0,d=b.types.length;d>c;c++)this._typeCallbacks[b.types[c]]=b;if(null!=b.extensions)for(c=0,d=b.extensions.length;d>c;c++)this._extensionCallbacks[b.extensions[c]]=b}},b.setMaxConnections=function(a){this._maxConnections=a,!this._paused&&this._loadQueue.length>0&&this._loadNext()},b.loadFile=function(a,b,c){if(null==a){var d=new createjs.Event("error");return d.text="PRELOAD_NO_FILE",void this._sendError(d)}this._addItem(a,null,c),this.setPaused(b!==!1?!1:!0)},b.loadManifest=function(a,b,d){var e=null,f=null;
if(a instanceof Array){if(0==a.length){var g=new createjs.Event("error");return g.text="PRELOAD_MANIFEST_EMPTY",void this._sendError(g)}e=a}else if("string"==typeof a)e=[{src:a,type:c.MANIFEST}];else{if("object"!=typeof a){var g=new createjs.Event("error");return g.text="PRELOAD_MANIFEST_NULL",void this._sendError(g)}if(void 0!==a.src){if(null==a.type)a.type=c.MANIFEST;else if(a.type!=c.MANIFEST){var g=new createjs.Event("error");g.text="PRELOAD_MANIFEST_ERROR",this._sendError(g)}e=[a]}else void 0!==a.manifest&&(e=a.manifest,f=a.path)}for(var h=0,i=e.length;i>h;h++)this._addItem(e[h],f,d);this.setPaused(b!==!1?!1:!0)},b.load=function(){this.setPaused(!1)},b.getItem=function(a){return this._loadItemsById[a]||this._loadItemsBySrc[a]},b.getResult=function(a,b){var c=this._loadItemsById[a]||this._loadItemsBySrc[a];if(null==c)return null;var d=c.id;return b&&this._loadedRawResults[d]?this._loadedRawResults[d]:this._loadedResults[d]},b.setPaused=function(a){this._paused=a,this._paused||this._loadNext()},b.close=function(){for(;this._currentLoads.length;)this._currentLoads.pop().cancel();this._scriptOrder.length=0,this._loadedScripts.length=0,this.loadStartWasDispatched=!1},b._addItem=function(a,b,c){var d=this._createLoadItem(a,b,c);if(null!=d){var e=this._createLoader(d);null!=e&&(this._loadQueue.push(e),this._loadQueueBackup.push(e),this._numItems++,this._updateProgress(),this.maintainScriptOrder&&d.type==createjs.LoadQueue.JAVASCRIPT&&e instanceof createjs.XHRLoader&&(this._scriptOrder.push(d),this._loadedScripts.push(null)))}},b._createLoadItem=function(a,b,c){var d=null;switch(typeof a){case"string":d={src:a};break;case"object":d=window.HTMLAudioElement&&a instanceof window.HTMLAudioElement?{tag:a,src:d.tag.src,type:createjs.LoadQueue.SOUND}:a;break;default:return null}var e=this._parseURI(d.src);null!=e&&(d.ext=e[6]),null==d.type&&(d.type=this._getTypeByExtension(d.ext));var f="",g=c||this._basePath,h=d.src;if(e&&null==e[1]&&null==e[3])if(b){f=b;var i=this._parsePath(b);h=b+h,null!=g&&i&&null==i[1]&&null==i[2]&&(f=g+f)}else null!=g&&(f=g);if(d.src=f+d.src,d.path=f,(d.type==createjs.LoadQueue.JSON||d.type==createjs.LoadQueue.MANIFEST)&&(d._loadAsJSONP=null!=d.callback),d.type==createjs.LoadQueue.JSONP&&null==d.callback)throw new Error("callback is required for loading JSONP requests.");(void 0===d.tag||null===d.tag)&&(d.tag=this._createTag(d)),(void 0===d.id||null===d.id||""===d.id)&&(d.id=h);var j=this._typeCallbacks[d.type]||this._extensionCallbacks[d.ext];if(j){var k=j.callback.call(j.scope,d.src,d.type,d.id,d.data,f,this);if(k===!1)return null;k===!0||(null!=k.src&&(d.src=k.src),null!=k.id&&(d.id=k.id),null!=k.tag&&(d.tag=k.tag),null!=k.completeHandler&&(d.completeHandler=k.completeHandler),k.type&&(d.type=k.type),e=this._parseURI(d.src),null!=e&&null!=e[6]&&(d.ext=e[6].toLowerCase()))}return this._loadItemsById[d.id]=d,this._loadItemsBySrc[d.src]=d,d},b._createLoader=function(a){var b=this.useXHR;switch(a.type){case createjs.LoadQueue.JSON:case createjs.LoadQueue.MANIFEST:b=!a._loadAsJSONP;break;case createjs.LoadQueue.XML:case createjs.LoadQueue.TEXT:b=!0;break;case createjs.LoadQueue.SOUND:case createjs.LoadQueue.JSONP:b=!1;break;case null:return null}return b?new createjs.XHRLoader(a,this._crossOrigin):new createjs.TagLoader(a)},b._loadNext=function(){if(!this._paused){this._loadStartWasDispatched||(this._sendLoadStart(),this._loadStartWasDispatched=!0),this._numItems==this._numItemsLoaded?(this.loaded=!0,this._sendComplete(),this.next&&this.next.load&&this.next.load()):this.loaded=!1;for(var a=0;a<this._loadQueue.length&&!(this._currentLoads.length>=this._maxConnections);a++){var b=this._loadQueue[a];if(this.maintainScriptOrder&&b instanceof createjs.TagLoader&&b.getItem().type==createjs.LoadQueue.JAVASCRIPT){if(this._currentlyLoadingScript)continue;this._currentlyLoadingScript=!0}this._loadQueue.splice(a,1),a--,this._loadItem(b)}}},b._loadItem=function(a){a.on("progress",this._handleProgress,this),a.on("complete",this._handleFileComplete,this),a.on("error",this._handleFileError,this),this._currentLoads.push(a),this._sendFileStart(a.getItem()),a.load()},b._handleFileError=function(a){var b=a.target;this._numItemsLoaded++,this._updateProgress();var c=new createjs.Event("error");c.text="FILE_LOAD_ERROR",c.item=b.getItem(),this._sendError(c),this.stopOnError||(this._removeLoadItem(b),this._loadNext())},b._handleFileComplete=function(a){var b=a.target,c=b.getItem();if(this._loadedResults[c.id]=b.getResult(),b instanceof createjs.XHRLoader&&(this._loadedRawResults[c.id]=b.getResult(!0)),this._removeLoadItem(b),this.maintainScriptOrder&&c.type==createjs.LoadQueue.JAVASCRIPT){if(!(b instanceof createjs.TagLoader))return this._loadedScripts[createjs.indexOf(this._scriptOrder,c)]=c,void this._checkScriptLoadOrder(b);this._currentlyLoadingScript=!1}if(delete c._loadAsJSONP,c.type==createjs.LoadQueue.MANIFEST){var d=b.getResult();null!=d&&void 0!==d.manifest&&this.loadManifest(d,!0)}this._processFinishedLoad(c,b)},b._processFinishedLoad=function(a,b){this._numItemsLoaded++,this._updateProgress(),this._sendFileComplete(a,b),this._loadNext()},b._checkScriptLoadOrder=function(){for(var a=this._loadedScripts.length,b=0;a>b;b++){var c=this._loadedScripts[b];if(null===c)break;if(c!==!0){var d=this._loadedResults[c.id];(document.body||document.getElementsByTagName("body")[0]).appendChild(d),this._processFinishedLoad(c),this._loadedScripts[b]=!0}}},b._removeLoadItem=function(a){for(var b=this._currentLoads.length,c=0;b>c;c++)if(this._currentLoads[c]==a){this._currentLoads.splice(c,1);break}},b._handleProgress=function(a){var b=a.target;this._sendFileProgress(b.getItem(),b.progress),this._updateProgress()},b._updateProgress=function(){var a=this._numItemsLoaded/this._numItems,b=this._numItems-this._numItemsLoaded;if(b>0){for(var c=0,d=0,e=this._currentLoads.length;e>d;d++)c+=this._currentLoads[d].progress;a+=c/b*(b/this._numItems)}this._sendProgress(a)},b._disposeItem=function(a){delete this._loadedResults[a.id],delete this._loadedRawResults[a.id],delete this._loadItemsById[a.id],delete this._loadItemsBySrc[a.src]},b._createTag=function(a){var b=null;switch(a.type){case createjs.LoadQueue.IMAGE:return b=document.createElement("img"),""==this._crossOrigin||this._isLocal(a)||(b.crossOrigin=this._crossOrigin),b;case createjs.LoadQueue.SOUND:return b=document.createElement("audio"),b.autoplay=!1,b;case createjs.LoadQueue.JSON:case createjs.LoadQueue.JSONP:case createjs.LoadQueue.JAVASCRIPT:case createjs.LoadQueue.MANIFEST:return b=document.createElement("script"),b.type="text/javascript",b;case createjs.LoadQueue.CSS:return b=document.createElement(this.useXHR?"style":"link"),b.rel="stylesheet",b.type="text/css",b;case createjs.LoadQueue.SVG:return this.useXHR?b=document.createElement("svg"):(b=document.createElement("object"),b.type="image/svg+xml"),b}return null},b._getTypeByExtension=function(a){if(null==a)return createjs.LoadQueue.TEXT;switch(a.toLowerCase()){case"jpeg":case"jpg":case"gif":case"png":case"webp":case"bmp":return createjs.LoadQueue.IMAGE;case"ogg":case"mp3":case"wav":return createjs.LoadQueue.SOUND;case"json":return createjs.LoadQueue.JSON;case"xml":return createjs.LoadQueue.XML;case"css":return createjs.LoadQueue.CSS;case"js":return createjs.LoadQueue.JAVASCRIPT;case"svg":return createjs.LoadQueue.SVG;default:return createjs.LoadQueue.TEXT}},b._sendFileProgress=function(a,b){if(this._isCanceled())return void this._cleanUp();if(this.hasEventListener("fileprogress")){var c=new createjs.Event("fileprogress");c.progress=b,c.loaded=b,c.total=1,c.item=a,this.dispatchEvent(c)}},b._sendFileComplete=function(a,b){if(!this._isCanceled()){var c=new createjs.Event("fileload");c.loader=b,c.item=a,c.result=this._loadedResults[a.id],c.rawResult=this._loadedRawResults[a.id],a.completeHandler&&a.completeHandler(c),this.hasEventListener("fileload")&&this.dispatchEvent(c)}},b._sendFileStart=function(a){var b=new createjs.Event("filestart");b.item=a,this.hasEventListener("filestart")&&this.dispatchEvent(b)},b.toString=function(){return"[PreloadJS LoadQueue]"},createjs.LoadQueue=a;var d=function(){};d.init=function(){var a=navigator.userAgent;d.isFirefox=a.indexOf("Firefox")>-1,d.isOpera=null!=window.opera,d.isChrome=a.indexOf("Chrome")>-1,d.isIOS=a.indexOf("iPod")>-1||a.indexOf("iPhone")>-1||a.indexOf("iPad")>-1},d.init(),createjs.LoadQueue.BrowserDetect=d}(),this.createjs=this.createjs||{},function(){var a=function(a){this.init(a)},b=a.prototype=new createjs.AbstractLoader;b._loadTimeout=null,b._tagCompleteProxy=null,b._isAudio=!1,b._tag=null,b._jsonResult=null,b.init=function(a){this._item=a,this._tag=a.tag,this._isAudio=window.HTMLAudioElement&&a.tag instanceof window.HTMLAudioElement,this._tagCompleteProxy=createjs.proxy(this._handleLoad,this)},b.getResult=function(){return this._item.type==createjs.LoadQueue.JSONP||this._item.type==createjs.LoadQueue.MANIFEST?this._jsonResult:this._tag},b.cancel=function(){this.canceled=!0,this._clean()},b.load=function(){var a=this._item,b=this._tag;clearTimeout(this._loadTimeout);var c=createjs.LoadQueue.LOAD_TIMEOUT;0==c&&(c=createjs.LoadQueue.loadTimeout),this._loadTimeout=setTimeout(createjs.proxy(this._handleTimeout,this),c),this._isAudio&&(b.src=null,b.preload="auto"),b.onerror=createjs.proxy(this._handleError,this),this._isAudio?(b.onstalled=createjs.proxy(this._handleStalled,this),b.addEventListener("canplaythrough",this._tagCompleteProxy,!1)):(b.onload=createjs.proxy(this._handleLoad,this),b.onreadystatechange=createjs.proxy(this._handleReadyStateChange,this));var d=this.buildPath(a.src,a.values);switch(a.type){case createjs.LoadQueue.CSS:b.href=d;break;case createjs.LoadQueue.SVG:b.data=d;break;default:b.src=d}if(a.type==createjs.LoadQueue.JSONP||a.type==createjs.LoadQueue.JSON||a.type==createjs.LoadQueue.MANIFEST){if(null==a.callback)throw new Error("callback is required for loading JSONP requests.");if(null!=window[a.callback])throw new Error('JSONP callback "'+a.callback+'" already exists on window. You need to specify a different callback. Or re-name the current one.');window[a.callback]=createjs.proxy(this._handleJSONPLoad,this)}(a.type==createjs.LoadQueue.SVG||a.type==createjs.LoadQueue.JSONP||a.type==createjs.LoadQueue.JSON||a.type==createjs.LoadQueue.MANIFEST||a.type==createjs.LoadQueue.JAVASCRIPT||a.type==createjs.LoadQueue.CSS)&&(this._startTagVisibility=b.style.visibility,b.style.visibility="hidden",(document.body||document.getElementsByTagName("body")[0]).appendChild(b)),null!=b.load&&b.load()},b._handleJSONPLoad=function(a){this._jsonResult=a},b._handleTimeout=function(){this._clean();var a=new createjs.Event("error");a.text="PRELOAD_TIMEOUT",this._sendError(a)},b._handleStalled=function(){},b._handleError=function(){this._clean();var a=new createjs.Event("error");this._sendError(a)},b._handleReadyStateChange=function(){clearTimeout(this._loadTimeout);var a=this.getItem().tag;("loaded"==a.readyState||"complete"==a.readyState)&&this._handleLoad()},b._handleLoad=function(){if(!this._isCanceled()){var a=this.getItem(),b=a.tag;if(!(this.loaded||this._isAudio&&4!==b.readyState)){switch(this.loaded=!0,a.type){case createjs.LoadQueue.SVG:case createjs.LoadQueue.JSON:case createjs.LoadQueue.JSONP:case createjs.LoadQueue.MANIFEST:case createjs.LoadQueue.CSS:b.style.visibility=this._startTagVisibility,(document.body||document.getElementsByTagName("body")[0]).removeChild(b)}this._clean(),this._sendComplete()}}},b._clean=function(){clearTimeout(this._loadTimeout);var a=this.getItem(),b=a.tag;null!=b&&(b.onload=null,b.removeEventListener&&b.removeEventListener("canplaythrough",this._tagCompleteProxy,!1),b.onstalled=null,b.onprogress=null,b.onerror=null,null!=b.parentNode&&a.type==createjs.LoadQueue.SVG&&a.type==createjs.LoadQueue.JSON&&a.type==createjs.LoadQueue.MANIFEST&&a.type==createjs.LoadQueue.CSS&&a.type==createjs.LoadQueue.JSONP&&b.parentNode.removeChild(b));var a=this.getItem();(a.type==createjs.LoadQueue.JSONP||a.type==createjs.LoadQueue.MANIFEST)&&(window[a.callback]=null)},b.toString=function(){return"[PreloadJS TagLoader]"},createjs.TagLoader=a}(),this.createjs=this.createjs||{},function(){var a=function(a,b){this.init(a,b)},b=a.prototype=new createjs.AbstractLoader;b._request=null,b._loadTimeout=null,b._xhrLevel=1,b._response=null,b._rawResponse=null,b._crossOrigin="",b.init=function(a,b){this._item=a,this._crossOrigin=b,!this._createXHR(a)},b.getResult=function(a){return a&&this._rawResponse?this._rawResponse:this._response},b.cancel=function(){this.canceled=!0,this._clean(),this._request.abort()},b.load=function(){if(null==this._request)return void this._handleError();if(this._request.onloadstart=createjs.proxy(this._handleLoadStart,this),this._request.onprogress=createjs.proxy(this._handleProgress,this),this._request.onabort=createjs.proxy(this._handleAbort,this),this._request.onerror=createjs.proxy(this._handleError,this),this._request.ontimeout=createjs.proxy(this._handleTimeout,this),1==this._xhrLevel){var a=createjs.LoadQueue.LOAD_TIMEOUT;if(0==a)a=createjs.LoadQueue.loadTimeout;else try{console.warn("LoadQueue.LOAD_TIMEOUT has been deprecated in favor of LoadQueue.loadTimeout")}catch(b){}this._loadTimeout=setTimeout(createjs.proxy(this._handleTimeout,this),a)}this._request.onload=createjs.proxy(this._handleLoad,this),this._request.onreadystatechange=createjs.proxy(this._handleReadyStateChange,this);try{this._item.values&&this._item.method!=createjs.LoadQueue.GET?this._item.method==createjs.LoadQueue.POST&&this._request.send(this._formatQueryString(this._item.values)):this._request.send()}catch(c){var d=new createjs.Event("error");d.error=c,this._sendError(d)}},b.getAllResponseHeaders=function(){return this._request.getAllResponseHeaders instanceof Function?this._request.getAllResponseHeaders():null},b.getResponseHeader=function(a){return this._request.getResponseHeader instanceof Function?this._request.getResponseHeader(a):null},b._handleProgress=function(a){if(a&&!(a.loaded>0&&0==a.total)){var b=new createjs.Event("progress");b.loaded=a.loaded,b.total=a.total,this._sendProgress(b)}},b._handleLoadStart=function(){clearTimeout(this._loadTimeout),this._sendLoadStart()},b._handleAbort=function(){this._clean();var a=new createjs.Event("error");a.text="XHR_ABORTED",this._sendError(a)},b._handleError=function(){this._clean();var a=new createjs.Event("error");this._sendError(a)},b._handleReadyStateChange=function(){4==this._request.readyState&&this._handleLoad()},b._handleLoad=function(){if(!this.loaded){if(this.loaded=!0,!this._checkError())return void this._handleError();this._response=this._getResponse(),this._clean();var a=this._generateTag();a&&this._sendComplete()}},b._handleTimeout=function(a){this._clean();var b=new createjs.Event("error");b.text="PRELOAD_TIMEOUT",this._sendError(a)},b._checkError=function(){var a=parseInt(this._request.status);switch(a){case 404:case 0:return!1}return!0},b._getResponse=function(){if(null!=this._response)return this._response;if(null!=this._request.response)return this._request.response;try{if(null!=this._request.responseText)return this._request.responseText}catch(a){}try{if(null!=this._request.responseXML)return this._request.responseXML}catch(a){}return null},b._createXHR=function(a){var b=this._isCrossDomain(a),c=null;if(b&&window.XDomainRequest)c=new XDomainRequest;else if(window.XMLHttpRequest)c=new XMLHttpRequest;else try{c=new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(d){try{c=new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(d){try{c=new ActiveXObject("Msxml2.XMLHTTP")}catch(d){return!1}}}createjs.LoadQueue.isText(a.type)&&c.overrideMimeType&&c.overrideMimeType("text/plain; charset=utf-8"),this._xhrLevel="string"==typeof c.responseType?2:1;var e=null;return e=a.method==createjs.LoadQueue.GET?this.buildPath(a.src,a.values):a.src,c.open(a.method||createjs.LoadQueue.GET,e,!0),b&&c instanceof XMLHttpRequest&&1==this._xhrLevel&&c.setRequestHeader("Origin",location.origin),a.values&&a.method==createjs.LoadQueue.POST&&c.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),createjs.LoadQueue.isBinary(a.type)&&(c.responseType="arraybuffer"),this._request=c,!0},b._clean=function(){clearTimeout(this._loadTimeout);var a=this._request;a.onloadstart=null,a.onprogress=null,a.onabort=null,a.onerror=null,a.onload=null,a.ontimeout=null,a.onloadend=null,a.onreadystatechange=null},b._generateTag=function(){var a=this._item.type,b=this._item.tag;switch(a){case createjs.LoadQueue.IMAGE:return b.onload=createjs.proxy(this._handleTagReady,this),""!=this._crossOrigin&&(b.crossOrigin="Anonymous"),b.src=this.buildPath(this._item.src,this._item.values),this._rawResponse=this._response,this._response=b,!1;case createjs.LoadQueue.JAVASCRIPT:return b=document.createElement("script"),b.text=this._response,this._rawResponse=this._response,this._response=b,!0;case createjs.LoadQueue.CSS:var c=document.getElementsByTagName("head")[0];if(c.appendChild(b),b.styleSheet)b.styleSheet.cssText=this._response;else{var d=document.createTextNode(this._response);b.appendChild(d)}return this._rawResponse=this._response,this._response=b,!0;case createjs.LoadQueue.XML:var e=this._parseXML(this._response,"text/xml");return this._rawResponse=this._response,this._response=e,!0;case createjs.LoadQueue.SVG:var e=this._parseXML(this._response,"image/svg+xml");return this._rawResponse=this._response,null!=e.documentElement?(b.appendChild(e.documentElement),this._response=b):this._response=e,!0;case createjs.LoadQueue.JSON:case createjs.LoadQueue.MANIFEST:var f={};try{f=JSON.parse(this._response)}catch(g){f=g}return this._rawResponse=this._response,this._response=f,!0}return!0},b._parseXML=function(a,b){var c=null;try{if(window.DOMParser){var d=new DOMParser;c=d.parseFromString(a,b)}else c=new ActiveXObject("Microsoft.XMLDOM"),c.async=!1,c.loadXML(a)}catch(e){}return c},b._handleTagReady=function(){this._sendComplete()},b.toString=function(){return"[PreloadJS XHRLoader]"},createjs.XHRLoader=a}(),"object"!=typeof JSON&&(JSON={}),function(){function f(a){return 10>a?"0"+a:a}function quote(a){return escapable.lastIndex=0,escapable.test(a)?'"'+a.replace(escapable,function(a){var b=meta[a];return"string"==typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'}function str(a,b){var c,d,e,f,g,h=gap,i=b[a];switch(i&&"object"==typeof i&&"function"==typeof i.toJSON&&(i=i.toJSON(a)),"function"==typeof rep&&(i=rep.call(b,a,i)),typeof i){case"string":return quote(i);case"number":return isFinite(i)?String(i):"null";case"boolean":case"null":return String(i);case"object":if(!i)return"null";if(gap+=indent,g=[],"[object Array]"===Object.prototype.toString.apply(i)){for(f=i.length,c=0;f>c;c+=1)g[c]=str(c,i)||"null";return e=0===g.length?"[]":gap?"[\n"+gap+g.join(",\n"+gap)+"\n"+h+"]":"["+g.join(",")+"]",gap=h,e}if(rep&&"object"==typeof rep)for(f=rep.length,c=0;f>c;c+=1)"string"==typeof rep[c]&&(d=rep[c],e=str(d,i),e&&g.push(quote(d)+(gap?": ":":")+e));else for(d in i)Object.prototype.hasOwnProperty.call(i,d)&&(e=str(d,i),e&&g.push(quote(d)+(gap?": ":":")+e));return e=0===g.length?"{}":gap?"{\n"+gap+g.join(",\n"+gap)+"\n"+h+"}":"{"+g.join(",")+"}",gap=h,e}}"function"!=typeof Date.prototype.toJSON&&(Date.prototype.toJSON=function(){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null},String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(){return this.valueOf()});var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","  ":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;"function"!=typeof JSON.stringify&&(JSON.stringify=function(a,b,c){var d;if(gap="",indent="","number"==typeof c)for(d=0;c>d;d+=1)indent+=" ";else"string"==typeof c&&(indent=c);if(rep=b,!b||"function"==typeof b||"object"==typeof b&&"number"==typeof b.length)return str("",{"":a});throw new Error("JSON.stringify")}),"function"!=typeof JSON.parse&&(JSON.parse=function(text,reviver){function walk(a,b){var c,d,e=a[b];if(e&&"object"==typeof e)for(c in e)Object.prototype.hasOwnProperty.call(e,c)&&(d=walk(e,c),void 0!==d?e[c]=d:delete e[c]);return reviver.call(a,b,e)}var j;if(text=String(text),cx.lastIndex=0,cx.test(text)&&(text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return j=eval("("+text+")"),"function"==typeof reviver?walk({"":j},""):j;throw new SyntaxError("JSON.parse")})}(),this.createjs=this.createjs||{},function(){var a=createjs.SoundJS=createjs.SoundJS||{};a.version="0.5.2",a.buildDate="Thu, 12 Dec 2013 23:33:37 GMT"}(),this.createjs=this.createjs||{},function(){var a=function(){},b=a.prototype;a.initialize=function(a){a.addEventListener=b.addEventListener,a.on=b.on,a.removeEventListener=a.off=b.removeEventListener,a.removeAllEventListeners=b.removeAllEventListeners,a.hasEventListener=b.hasEventListener,a.dispatchEvent=b.dispatchEvent,a._dispatchEvent=b._dispatchEvent,a.willTrigger=b.willTrigger},b._listeners=null,b._captureListeners=null,b.initialize=function(){},b.addEventListener=function(a,b,c){var d;d=c?this._captureListeners=this._captureListeners||{}:this._listeners=this._listeners||{};var e=d[a];return e&&this.removeEventListener(a,b,c),e=d[a],e?e.push(b):d[a]=[b],b},b.on=function(a,b,c,d,e,f){return b.handleEvent&&(c=c||b,b=b.handleEvent),c=c||this,this.addEventListener(a,function(a){b.call(c,a,e),d&&a.remove()},f)},b.removeEventListener=function(a,b,c){var d=c?this._captureListeners:this._listeners;if(d){var e=d[a];if(e)for(var f=0,g=e.length;g>f;f++)if(e[f]==b){1==g?delete d[a]:e.splice(f,1);break}}},b.off=b.removeEventListener,b.removeAllEventListeners=function(a){a?(this._listeners&&delete this._listeners[a],this._captureListeners&&delete this._captureListeners[a]):this._listeners=this._captureListeners=null},b.dispatchEvent=function(a,b){if("string"==typeof a){var c=this._listeners;if(!c||!c[a])return!1;a=new createjs.Event(a)}if(a.target=b||this,a.bubbles&&this.parent){for(var d=this,e=[d];d.parent;)e.push(d=d.parent);var f,g=e.length;for(f=g-1;f>=0&&!a.propagationStopped;f--)e[f]._dispatchEvent(a,1+(0==f));for(f=1;g>f&&!a.propagationStopped;f++)e[f]._dispatchEvent(a,3)}else this._dispatchEvent(a,2);return a.defaultPrevented},b.hasEventListener=function(a){var b=this._listeners,c=this._captureListeners;return!!(b&&b[a]||c&&c[a])},b.willTrigger=function(a){for(var b=this;b;){if(b.hasEventListener(a))return!0;b=b.parent}return!1},b.toString=function(){return"[EventDispatcher]"},b._dispatchEvent=function(a,b){var c,d=1==b?this._captureListeners:this._listeners;if(a&&d){var e=d[a.type];if(!e||!(c=e.length))return;a.currentTarget=this,a.eventPhase=b,a.removed=!1,e=e.slice();for(var f=0;c>f&&!a.immediatePropagationStopped;f++){var g=e[f];g.handleEvent?g.handleEvent(a):g(a),a.removed&&(this.off(a.type,g,1==b),a.removed=!1)}}},createjs.EventDispatcher=a}(),this.createjs=this.createjs||{},function(){var a=function(a,b,c){this.initialize(a,b,c)},b=a.prototype;b.type=null,b.target=null,b.currentTarget=null,b.eventPhase=0,b.bubbles=!1,b.cancelable=!1,b.timeStamp=0,b.defaultPrevented=!1,b.propagationStopped=!1,b.immediatePropagationStopped=!1,b.removed=!1,b.initialize=function(a,b,c){this.type=a,this.bubbles=b,this.cancelable=c,this.timeStamp=(new Date).getTime()},b.preventDefault=function(){this.defaultPrevented=!0},b.stopPropagation=function(){this.propagationStopped=!0},b.stopImmediatePropagation=function(){this.immediatePropagationStopped=this.propagationStopped=!0},b.remove=function(){this.removed=!0},b.clone=function(){return new a(this.type,this.bubbles,this.cancelable)},b.toString=function(){return"[Event (type="+this.type+")]"},createjs.Event=a}(),this.createjs=this.createjs||{},function(){createjs.indexOf=function(a,b){for(var c=0,d=a.length;d>c;c++)if(b===a[c])return c;return-1}}(),this.createjs=this.createjs||{},function(){createjs.proxy=function(a,b){var c=Array.prototype.slice.call(arguments,2);return function(){return a.apply(b,Array.prototype.slice.call(arguments,0).concat(c))}}}(),this.createjs=this.createjs||{},function(){function a(){throw"Sound cannot be instantiated"}function b(a,b){this.init(a,b)}function c(){this.isDefault=!0,this.addEventListener=this.removeEventListener=this.removeAllEventListeners=this.dispatchEvent=this.hasEventListener=this._listeners=this._interrupt=this._playFailed=this.pause=this.resume=this.play=this._beginPlaying=this._cleanUp=this.stop=this.setMasterVolume=this.setVolume=this.mute=this.setMute=this.getMute=this.setPan=this.getPosition=this.setPosition=this.playFailed=function(){return!1},this.getVolume=this.getPan=this.getDuration=function(){return 0},this.playState=a.PLAY_FAILED,this.toString=function(){return"[Sound Default Sound Instance]"}}function d(){}var e=a;e.DELIMITER="|",e.INTERRUPT_ANY="any",e.INTERRUPT_EARLY="early",e.INTERRUPT_LATE="late",e.INTERRUPT_NONE="none",e.PLAY_INITED="playInited",e.PLAY_SUCCEEDED="playSucceeded",e.PLAY_INTERRUPTED="playInterrupted",e.PLAY_FINISHED="playFinished",e.PLAY_FAILED="playFailed",e.SUPPORTED_EXTENSIONS=["mp3","ogg","mpeg","wav","m4a","mp4","aiff","wma","mid"],e.EXTENSION_MAP={m4a:"mp4"},e.FILE_PATTERN=/^(?:(\w+:)\/{2}(\w+(?:\.\w+)*\/?))?([/.]*?(?:[^?]+)?\/)?((?:[^/?]+)\.(\w+))(?:\?(\S+)?)?$/,e.defaultInterruptBehavior=e.INTERRUPT_NONE,e.alternateExtensions=[],e._lastID=0,e.activePlugin=null,e._pluginsRegistered=!1,e._masterVolume=1,e._masterMute=!1,e._instances=[],e._idHash={},e._preloadHash={},e._defaultSoundInstance=null,e.addEventListener=null,e.removeEventListener=null,e.removeAllEventListeners=null,e.dispatchEvent=null,e.hasEventListener=null,e._listeners=null,createjs.EventDispatcher.initialize(e),e._sendFileLoadEvent=function(a){if(e._preloadHash[a])for(var b=0,c=e._preloadHash[a].length;c>b;b++){var d=e._preloadHash[a][b];if(e._preloadHash[a][b]=!0,e.hasEventListener("fileload")){var f=new createjs.Event("fileload");f.src=d.src,f.id=d.id,f.data=d.data,e.dispatchEvent(f)}}},e.getPreloadHandlers=function(){return{callback:createjs.proxy(e.initLoad,e),types:["sound"],extensions:e.SUPPORTED_EXTENSIONS}},e.registerPlugin=function(a){try{console.log("createjs.Sound.registerPlugin has been deprecated. Please use registerPlugins.")}catch(b){}return e._registerPlugin(a)},e._registerPlugin=function(a){return e._pluginsRegistered=!0,null==a?!1:a.isSupported()?(e.activePlugin=new a,!0):!1},e.registerPlugins=function(a){for(var b=0,c=a.length;c>b;b++){var d=a[b];if(e._registerPlugin(d))return!0}return!1},e.initializeDefaultPlugins=function(){return null!=e.activePlugin?!0:e._pluginsRegistered?!1:e.registerPlugins([createjs.WebAudioPlugin,createjs.HTMLAudioPlugin])?!0:!1},e.isReady=function(){return null!=e.activePlugin},e.getCapabilities=function(){return null==e.activePlugin?null:e.activePlugin._capabilities},e.getCapability=function(a){return null==e.activePlugin?null:e.activePlugin._capabilities[a]},e.initLoad=function(a,b,c,d,f){a=a.replace(f,"");var g=e.registerSound(a,c,d,!1,f);return null==g?!1:g},e.registerSound=function(a,c,d,f,g){if(!e.initializeDefaultPlugins())return!1;if(a instanceof Object&&(g=c,c=a.id,d=a.data,a=a.src),e.alternateExtensions.length)var h=e._parsePath2(a,"sound",c,d);else var h=e._parsePath(a,"sound",c,d);if(null==h)return!1;null!=g&&(a=g+a,h.src=g+h.src),null!=c&&(e._idHash[c]=h.src);var i=null;null!=d&&(isNaN(d.channels)?isNaN(d)||(i=parseInt(d)):i=parseInt(d.channels));var j=e.activePlugin.register(h.src,i);if(null!=j&&(null!=j.numChannels&&(i=j.numChannels),b.create(h.src,i),null!=d&&isNaN(d)?d.channels=h.data.channels=i||b.maxPerChannel():d=h.data=i||b.maxPerChannel(),null!=j.tag?h.tag=j.tag:j.src&&(h.src=j.src),null!=j.completeHandler&&(h.completeHandler=j.completeHandler),j.type&&(h.type=j.type)),0!=f)if(e._preloadHash[h.src]||(e._preloadHash[h.src]=[]),e._preloadHash[h.src].push({src:a,id:c,data:d}),1==e._preloadHash[h.src].length)e.activePlugin.preload(h.src,j);else if(1==e._preloadHash[h.src][0])return!0;return h},e.registerManifest=function(a,b){for(var c=[],d=0,e=a.length;e>d;d++)c[d]=createjs.Sound.registerSound(a[d].src,a[d].id,a[d].data,a[d].preload,b);return c},e.removeSound=function(a,c){if(null==e.activePlugin)return!1;if(a instanceof Object&&(a=a.src),a=e._getSrcById(a),e.alternateExtensions.length)var d=e._parsePath2(a);else var d=e._parsePath(a);if(null==d)return!1;null!=c&&(d.src=c+d.src),a=d.src;for(var f in e._idHash)e._idHash[f]==a&&delete e._idHash[f];return b.removeSrc(a),delete e._preloadHash[a],e.activePlugin.removeSound(a),!0},e.removeManifest=function(a,b){for(var c=[],d=0,e=a.length;e>d;d++)c[d]=createjs.Sound.removeSound(a[d].src,b);return c},e.removeAllSounds=function(){e._idHash={},e._preloadHash={},b.removeAll(),e.activePlugin.removeAllSounds()},e.loadComplete=function(a){if(e.alternateExtensions.length)var b=e._parsePath2(a,"sound");else var b=e._parsePath(a,"sound");return a=e._getSrcById(b?b.src:a),1==e._preloadHash[a][0]},e._parsePath=function(a,b,c,d){"string"!=typeof a&&(a=a.toString());var f=a.split(e.DELIMITER);if(f.length>1)try{console.log('createjs.Sound.DELIMITER "|" loading approach has been deprecated. Please use the new alternateExtensions property.')}catch(g){}for(var h={type:b||"sound",id:c,data:d},i=e.getCapabilities(),j=0,k=f.length;k>j;j++){var l=f[j],m=l.match(e.FILE_PATTERN);if(null==m)return!1;var n=m[4],o=m[5];if(i[o]&&createjs.indexOf(e.SUPPORTED_EXTENSIONS,o)>-1)return h.name=n,h.src=l,h.extension=o,h}return null},e._parsePath2=function(a,b,c,d){"string"!=typeof a&&(a=a.toString());var f=a.match(e.FILE_PATTERN);if(null==f)return!1;for(var g=f[4],h=f[5],i=e.getCapabilities(),j=0;!i[h];)if(h=e.alternateExtensions[j++],j>e.alternateExtensions.length)return null;a=a.replace("."+f[5],"."+h);var k={type:b||"sound",id:c,data:d};return k.name=g,k.src=a,k.extension=h,k},e.play=function(a,b,c,d,f,g,h){var i=e.createInstance(a),j=e._playInstance(i,b,c,d,f,g,h);return j||i.playFailed(),i},e.createInstance=function(c){if(!e.initializeDefaultPlugins())return e._defaultSoundInstance;if(c=e._getSrcById(c),e.alternateExtensions.length)var d=e._parsePath2(c,"sound");else var d=e._parsePath(c,"sound");var f=null;return null!=d&&null!=d.src?(b.create(d.src),f=e.activePlugin.create(d.src)):f=a._defaultSoundInstance,f.uniqueId=e._lastID++,f},e.setVolume=function(a){if(null==Number(a))return!1;if(a=Math.max(0,Math.min(1,a)),e._masterVolume=a,!this.activePlugin||!this.activePlugin.setVolume||!this.activePlugin.setVolume(a))for(var b=this._instances,c=0,d=b.length;d>c;c++)b[c].setMasterVolume(a)},e.getVolume=function(){return e._masterVolume},e.setMute=function(a){if(null==a||void 0==a)return!1;if(this._masterMute=a,!this.activePlugin||!this.activePlugin.setMute||!this.activePlugin.setMute(a))for(var b=this._instances,c=0,d=b.length;d>c;c++)b[c].setMasterMute(a);return!0},e.getMute=function(){return this._masterMute},e.stop=function(){for(var a=this._instances,b=a.length;b--;)a[b].stop()},e._playInstance=function(a,b,c,d,f,g,h){if(b instanceof Object&&(c=b.delay,d=b.offset,f=b.loop,g=b.volume,h=b.pan,b=b.interrupt),b=b||e.defaultInterruptBehavior,null==c&&(c=0),null==d&&(d=a.getPosition()),null==f&&(f=0),null==g&&(g=a.volume),null==h&&(h=a.pan),0==c){var i=e._beginPlaying(a,b,d,f,g,h);if(!i)return!1}else{var j=setTimeout(function(){e._beginPlaying(a,b,d,f,g,h)},c);a._delayTimeoutId=j}return this._instances.push(a),!0},e._beginPlaying=function(a,c,d,e,f,g){if(!b.add(a,c))return!1;var h=a._beginPlaying(d,e,f,g);if(!h){var i=createjs.indexOf(this._instances,a);
return i>-1&&this._instances.splice(i,1),!1}return!0},e._getSrcById=function(a){return null==e._idHash||null==e._idHash[a]?a:e._idHash[a]},e._playFinished=function(a){b.remove(a);var c=createjs.indexOf(this._instances,a);c>-1&&this._instances.splice(c,1)},createjs.Sound=a,b.channels={},b.create=function(a,c){var d=b.get(a);return null==d?(b.channels[a]=new b(a,c),!0):!1},b.removeSrc=function(a){var c=b.get(a);return null==c?!1:(c.removeAll(),delete b.channels[a],!0)},b.removeAll=function(){for(var a in b.channels)b.channels[a].removeAll();b.channels={}},b.add=function(a,c){var d=b.get(a.src);return null==d?!1:d.add(a,c)},b.remove=function(a){var c=b.get(a.src);return null==c?!1:(c.remove(a),!0)},b.maxPerChannel=function(){return f.maxDefault},b.get=function(a){return b.channels[a]};var f=b.prototype;f.src=null,f.max=null,f.maxDefault=100,f.length=0,f.init=function(a,b){this.src=a,this.max=b||this.maxDefault,-1==this.max&&(this.max=this.maxDefault),this._instances=[]},f.get=function(a){return this._instances[a]},f.add=function(a,b){return this.getSlot(b,a)?(this._instances.push(a),this.length++,!0):!1},f.remove=function(a){var b=createjs.indexOf(this._instances,a);return-1==b?!1:(this._instances.splice(b,1),this.length--,!0)},f.removeAll=function(){for(var a=this.length-1;a>=0;a--)this._instances[a].stop()},f.getSlot=function(b){for(var c,d,e=0,f=this.max;f>e;e++){if(c=this.get(e),null==c)return!0;(b!=a.INTERRUPT_NONE||c.playState==a.PLAY_FINISHED)&&(0!=e?c.playState==a.PLAY_FINISHED||c.playState==a.PLAY_INTERRUPTED||c.playState==a.PLAY_FAILED?d=c:(b==a.INTERRUPT_EARLY&&c.getPosition()<d.getPosition()||b==a.INTERRUPT_LATE&&c.getPosition()>d.getPosition())&&(d=c):d=c)}return null!=d?(d._interrupt(),this.remove(d),!0):!1},f.toString=function(){return"[Sound SoundChannel]"},a._defaultSoundInstance=new c,d.init=function(){var a=window.navigator.userAgent;d.isFirefox=a.indexOf("Firefox")>-1,d.isOpera=null!=window.opera,d.isChrome=a.indexOf("Chrome")>-1,d.isIOS=a.indexOf("iPod")>-1||a.indexOf("iPhone")>-1||a.indexOf("iPad")>-1,d.isAndroid=a.indexOf("Android")>-1,d.isBlackberry=a.indexOf("Blackberry")>-1},d.init(),createjs.Sound.BrowserDetect=d}(),this.createjs=this.createjs||{},function(){function a(){this._init()}var b=a;b._capabilities=null,b.isSupported=function(){var a=createjs.Sound.BrowserDetect.isIOS||createjs.Sound.BrowserDetect.isAndroid||createjs.Sound.BrowserDetect.isBlackberry;return"file:"!=location.protocol||a||this._isFileXHRSupported()?(b._generateCapabilities(),null==b.context?!1:!0):!1},b._isFileXHRSupported=function(){var a=!0,b=new XMLHttpRequest;try{b.open("GET","fail.fail",!1)}catch(c){return a=!1}b.onerror=function(){a=!1},b.onload=function(){a=404==this.status||200==this.status||0==this.status&&""!=this.response};try{b.send()}catch(c){a=!1}return a},b._generateCapabilities=function(){if(null==b._capabilities){var a=document.createElement("audio");if(null==a.canPlayType)return null;if(window.webkitAudioContext)b.context=new webkitAudioContext;else{if(!window.AudioContext)return null;b.context=new AudioContext}b._compatibilitySetUp(),b.playEmptySound(),b._capabilities={panning:!0,volume:!0,tracks:-1};for(var c=createjs.Sound.SUPPORTED_EXTENSIONS,d=createjs.Sound.EXTENSION_MAP,e=0,f=c.length;f>e;e++){var g=c[e],h=d[g]||g;b._capabilities[g]="no"!=a.canPlayType("audio/"+g)&&""!=a.canPlayType("audio/"+g)||"no"!=a.canPlayType("audio/"+h)&&""!=a.canPlayType("audio/"+h)}b.context.destination.numberOfChannels<2&&(b._capabilities.panning=!1),b.dynamicsCompressorNode=b.context.createDynamicsCompressor(),b.dynamicsCompressorNode.connect(b.context.destination),b.gainNode=b.context.createGain(),b.gainNode.connect(b.dynamicsCompressorNode)}},b._compatibilitySetUp=function(){if(!b.context.createGain){b.context.createGain=b.context.createGainNode;var a=b.context.createBufferSource();a.__proto__.start=a.__proto__.noteGrainOn,a.__proto__.stop=a.__proto__.noteOff,this._panningModel=0}},b.playEmptySound=function(){var a=this.context.createBuffer(1,1,22050),b=this.context.createBufferSource();b.buffer=a,b.connect(this.context.destination),b.start(0,0,0)};var c=a.prototype;c._capabilities=null,c._volume=1,c.context=null,c._panningModel="equalpower",c.dynamicsCompressorNode=null,c.gainNode=null,c._arrayBuffers=null,c._init=function(){this._capabilities=b._capabilities,this._arrayBuffers={},this.context=b.context,this.gainNode=b.gainNode,this.dynamicsCompressorNode=b.dynamicsCompressorNode},c.register=function(a){this._arrayBuffers[a]=!0;var b=new createjs.WebAudioPlugin.Loader(a,this);return{tag:b}},c.isPreloadStarted=function(a){return null!=this._arrayBuffers[a]},c.isPreloadComplete=function(a){return null!=this._arrayBuffers[a]&&1!=this._arrayBuffers[a]},c.removeSound=function(a){delete this._arrayBuffers[a]},c.removeAllSounds=function(){this._arrayBuffers={}},c.addPreloadResults=function(a,b){this._arrayBuffers[a]=b},c._handlePreloadComplete=function(){createjs.Sound._sendFileLoadEvent(this.src)},c.preload=function(a){this._arrayBuffers[a]=!0;var b=new createjs.WebAudioPlugin.Loader(a,this);b.onload=this._handlePreloadComplete,b.load()},c.create=function(a){return this.isPreloadStarted(a)||this.preload(a),new createjs.WebAudioPlugin.SoundInstance(a,this)},c.setVolume=function(a){return this._volume=a,this._updateVolume(),!0},c._updateVolume=function(){var a=createjs.Sound._masterMute?0:this._volume;a!=this.gainNode.gain.value&&(this.gainNode.gain.value=a)},c.getVolume=function(){return this._volume},c.setMute=function(){return this._updateVolume(),!0},c.toString=function(){return"[WebAudioPlugin]"},createjs.WebAudioPlugin=a}(),function(){function a(a,b){this._init(a,b)}var b=a.prototype=new createjs.EventDispatcher;b.src=null,b.uniqueId=-1,b.playState=null,b._owner=null,b._offset=0,b._delay=0,b._volume=1;try{Object.defineProperty(b,"volume",{get:function(){return this._volume},set:function(a){return null==Number(a)?!1:(a=Math.max(0,Math.min(1,a)),this._volume=a,void this._updateVolume())}})}catch(c){}b._pan=0;try{Object.defineProperty(b,"pan",{get:function(){return this._pan},set:function(a){return this._owner._capabilities.panning&&null!=Number(a)?(a=Math.max(-1,Math.min(1,a)),this._pan=a,void this.panNode.setPosition(a,0,-.5)):!1}})}catch(c){}b._duration=0,b._remainingLoops=0,b._delayTimeoutId=null,b._soundCompleteTimeout=null,b.gainNode=null,b.panNode=null,b.sourceNode=null,b._sourceNodeNext=null,b._muted=!1,b._paused=!1,b._startTime=0,b._endedHandler=null,b._sendEvent=function(a){var b=new createjs.Event(a);this.dispatchEvent(b)},b._init=function(a,b){this._owner=b,this.src=a,this.gainNode=this._owner.context.createGain(),this.panNode=this._owner.context.createPanner(),this.panNode.panningModel=this._owner._panningModel,this.panNode.connect(this.gainNode),this._owner.isPreloadComplete(this.src)&&(this._duration=1e3*this._owner._arrayBuffers[this.src].duration),this._endedHandler=createjs.proxy(this._handleSoundComplete,this)},b._cleanUp=function(){this.sourceNode&&this.playState==createjs.Sound.PLAY_SUCCEEDED&&(this.sourceNode=this._cleanUpAudioNode(this.sourceNode),this._sourceNodeNext=this._cleanUpAudioNode(this._sourceNodeNext)),0!=this.gainNode.numberOfOutputs&&this.gainNode.disconnect(0),clearTimeout(this._delayTimeoutId),clearTimeout(this._soundCompleteTimeout),this._startTime=0,null!=window.createjs&&createjs.Sound._playFinished(this)},b._cleanUpAudioNode=function(a){return a&&(a.stop(0),a.disconnect(this.panNode),a=null),a},b._interrupt=function(){this._cleanUp(),this.playState=createjs.Sound.PLAY_INTERRUPTED,this._paused=!1,this._sendEvent("interrupted")},b._handleSoundReady=function(){if(null!=window.createjs){if(1e3*this._offset>this.getDuration())return void this.playFailed();this._offset<0&&(this._offset=0),this.playState=createjs.Sound.PLAY_SUCCEEDED,this._paused=!1,this.gainNode.connect(this._owner.gainNode);var a=this._owner._arrayBuffers[this.src].duration;this.sourceNode=this._createAndPlayAudioNode(this._owner.context.currentTime-a,this._offset),this._duration=1e3*a,this._startTime=this.sourceNode.startTime-this._offset,this._soundCompleteTimeout=setTimeout(this._endedHandler,1e3*(a-this._offset)),0!=this._remainingLoops&&(this._sourceNodeNext=this._createAndPlayAudioNode(this._startTime,0))}},b._createAndPlayAudioNode=function(a,b){var c=this._owner.context.createBufferSource();return c.buffer=this._owner._arrayBuffers[this.src],c.connect(this.panNode),this._owner.context.currentTime,c.startTime=a+c.buffer.duration,c.start(c.startTime,b,c.buffer.duration-b),c},b.play=function(a,b,c,d,e,f){this._cleanUp(),createjs.Sound._playInstance(this,a,b,c,d,e,f)},b._beginPlaying=function(a,b,c,d){return null!=window.createjs&&this.src?(this._offset=a/1e3,this._remainingLoops=b,this.volume=c,this.pan=d,this._owner.isPreloadComplete(this.src)?(this._handleSoundReady(null),this._sendEvent("succeeded"),1):void this.playFailed()):void 0},b.pause=function(){return this._paused||this.playState!=createjs.Sound.PLAY_SUCCEEDED?!1:(this._paused=!0,this._offset=this._owner.context.currentTime-this._startTime,this._cleanUpAudioNode(this.sourceNode),this._cleanUpAudioNode(this._sourceNodeNext),0!=this.gainNode.numberOfOutputs&&this.gainNode.disconnect(),clearTimeout(this._delayTimeoutId),clearTimeout(this._soundCompleteTimeout),!0)},b.resume=function(){return this._paused?(this._handleSoundReady(null),!0):!1},b.stop=function(){return this._cleanUp(),this.playState=createjs.Sound.PLAY_FINISHED,this._offset=0,!0},b.setVolume=function(a){return this.volume=a,!0},b._updateVolume=function(){var a=this._muted?0:this._volume;return a!=this.gainNode.gain.value?(this.gainNode.gain.value=a,!0):!1},b.getVolume=function(){return this.volume},b.setMute=function(a){return null==a||void 0==a?!1:(this._muted=a,this._updateVolume(),!0)},b.getMute=function(){return this._muted},b.setPan=function(a){return this.pan=a,this.pan!=a?!1:void 0},b.getPan=function(){return this.pan},b.getPosition=function(){if(this._paused||null==this.sourceNode)var a=this._offset;else var a=this._owner.context.currentTime-this._startTime;return 1e3*a},b.setPosition=function(a){return this._offset=a/1e3,this.sourceNode&&this.playState==createjs.Sound.PLAY_SUCCEEDED&&(this._cleanUpAudioNode(this.sourceNode),this._cleanUpAudioNode(this._sourceNodeNext),clearTimeout(this._soundCompleteTimeout)),this._paused||this.playState!=createjs.Sound.PLAY_SUCCEEDED||this._handleSoundReady(null),!0},b.getDuration=function(){return this._duration},b._handleSoundComplete=function(){return this._offset=0,0!=this._remainingLoops?(this._remainingLoops--,this._sourceNodeNext?(this._cleanUpAudioNode(this.sourceNode),this.sourceNode=this._sourceNodeNext,this._startTime=this.sourceNode.startTime,this._sourceNodeNext=this._createAndPlayAudioNode(this._startTime,0),this._soundCompleteTimeout=setTimeout(this._endedHandler,this._duration)):this._handleSoundReady(null),void this._sendEvent("loop")):void(null!=window.createjs&&(this._cleanUp(),this.playState=createjs.Sound.PLAY_FINISHED,this._sendEvent("complete")))},b.playFailed=function(){null!=window.createjs&&(this._cleanUp(),this.playState=createjs.Sound.PLAY_FAILED,this._sendEvent("failed"))},b.toString=function(){return"[WebAudioPlugin SoundInstance]"},createjs.WebAudioPlugin.SoundInstance=a}(),function(){function a(a,b){this._init(a,b)}var b=a.prototype;b.request=null,b.owner=null,b.progress=-1,b.src=null,b.originalSrc=null,b.result=null,b.onload=null,b.onprogress=null,b.onError=null,b._init=function(a,b){this.src=a,this.originalSrc=a,this.owner=b},b.load=function(a){null!=a&&(this.src=a),this.request=new XMLHttpRequest,this.request.open("GET",this.src,!0),this.request.responseType="arraybuffer",this.request.onload=createjs.proxy(this.handleLoad,this),this.request.onError=createjs.proxy(this.handleError,this),this.request.onprogress=createjs.proxy(this.handleProgress,this),this.request.send()},b.handleProgress=function(a,b){this.progress=a/b,null!=this.onprogress&&this.onprogress({loaded:a,total:b,progress:this.progress})},b.handleLoad=function(){this.owner.context.decodeAudioData(this.request.response,createjs.proxy(this.handleAudioDecoded,this),createjs.proxy(this.handleError,this))},b.handleAudioDecoded=function(a){this.progress=1,this.result=a,this.src=this.originalSrc,this.owner.addPreloadResults(this.src,this.result),this.onload&&this.onload()},b.handleError=function(a){this.owner.removeSound(this.src),this.onerror&&this.onerror(a)},b.toString=function(){return"[WebAudioPlugin Loader]"},createjs.WebAudioPlugin.Loader=a}(),this.createjs=this.createjs||{},function(){function a(){this._init()}var b=a;b.MAX_INSTANCES=30,b._AUDIO_READY="canplaythrough",b._AUDIO_ENDED="ended",b._AUDIO_SEEKED="seeked",b._AUDIO_STALLED="stalled",b._capabilities=null,b.enableIOS=!1,b.isSupported=function(){if(createjs.Sound.BrowserDetect.isIOS&&!b.enableIOS)return!1;b._generateCapabilities();var a=b.tag;return null==a||null==b._capabilities?!1:!0},b._generateCapabilities=function(){if(null==b._capabilities){var a=b.tag=document.createElement("audio");if(null==a.canPlayType)return null;b._capabilities={panning:!0,volume:!0,tracks:-1};for(var c=createjs.Sound.SUPPORTED_EXTENSIONS,d=createjs.Sound.EXTENSION_MAP,e=0,f=c.length;f>e;e++){var g=c[e],h=d[g]||g;b._capabilities[g]="no"!=a.canPlayType("audio/"+g)&&""!=a.canPlayType("audio/"+g)||"no"!=a.canPlayType("audio/"+h)&&""!=a.canPlayType("audio/"+h)}}};var c=a.prototype;c._capabilities=null,c._audioSources=null,c.defaultNumChannels=2,c.loadedHandler=null,c._init=function(){this._capabilities=b._capabilities,this._audioSources={}},c.register=function(a,b){this._audioSources[a]=!0;for(var c=createjs.HTMLAudioPlugin.TagPool.get(a),d=null,e=b||this.defaultNumChannels,f=0;e>f;f++)d=this._createTag(a),c.add(d);if(d.id=a,this.loadedHandler=createjs.proxy(this._handleTagLoad,this),d.addEventListener&&d.addEventListener("canplaythrough",this.loadedHandler),null==d.onreadystatechange)d.onreadystatechange=this.loadedHandler;else{var g=d.onreadystatechange;d.onreadystatechange=function(){g(),this.loadedHandler()}}return{tag:d,numChannels:e}},c._handleTagLoad=function(a){a.target.removeEventListener&&a.target.removeEventListener("canplaythrough",this.loadedHandler),a.target.onreadystatechange=null,a.target.src!=a.target.id&&createjs.HTMLAudioPlugin.TagPool.checkSrc(a.target.id)},c._createTag=function(a){var b=document.createElement("audio");return b.autoplay=!1,b.preload="none",b.src=a,b},c.removeSound=function(a){delete this._audioSources[a],createjs.HTMLAudioPlugin.TagPool.remove(a)},c.removeAllSounds=function(){this._audioSources={},createjs.HTMLAudioPlugin.TagPool.removeAll()},c.create=function(a){if(!this.isPreloadStarted(a)){var b=createjs.HTMLAudioPlugin.TagPool.get(a),c=this._createTag(a);c.id=a,b.add(c),this.preload(a,{tag:c})}return new createjs.HTMLAudioPlugin.SoundInstance(a,this)},c.isPreloadStarted=function(a){return null!=this._audioSources[a]},c.preload=function(a,b){this._audioSources[a]=!0,new createjs.HTMLAudioPlugin.Loader(a,b.tag)},c.toString=function(){return"[HTMLAudioPlugin]"},createjs.HTMLAudioPlugin=a}(),function(){function a(a,b){this._init(a,b)}var b=a.prototype=new createjs.EventDispatcher;b.src=null,b.uniqueId=-1,b.playState=null,b._owner=null,b.loaded=!1,b._offset=0,b._delay=0,b._volume=1;try{Object.defineProperty(b,"volume",{get:function(){return this._volume},set:function(a){null!=Number(a)&&(a=Math.max(0,Math.min(1,a)),this._volume=a,this._updateVolume())}})}catch(c){}b.pan=0,b._duration=0,b._remainingLoops=0,b._delayTimeoutId=null,b.tag=null,b._muted=!1,b._paused=!1,b._endedHandler=null,b._readyHandler=null,b._stalledHandler=null,b.loopHandler=null,b._init=function(a,b){this.src=a,this._owner=b,this._endedHandler=createjs.proxy(this._handleSoundComplete,this),this._readyHandler=createjs.proxy(this._handleSoundReady,this),this._stalledHandler=createjs.proxy(this._handleSoundStalled,this),this.loopHandler=createjs.proxy(this.handleSoundLoop,this)},b._sendEvent=function(a){var b=new createjs.Event(a);this.dispatchEvent(b)},b._cleanUp=function(){var a=this.tag;if(null!=a){a.pause(),a.removeEventListener(createjs.HTMLAudioPlugin._AUDIO_ENDED,this._endedHandler,!1),a.removeEventListener(createjs.HTMLAudioPlugin._AUDIO_READY,this._readyHandler,!1),a.removeEventListener(createjs.HTMLAudioPlugin._AUDIO_SEEKED,this.loopHandler,!1);try{a.currentTime=0}catch(b){}createjs.HTMLAudioPlugin.TagPool.setInstance(this.src,a),this.tag=null}clearTimeout(this._delayTimeoutId),null!=window.createjs&&createjs.Sound._playFinished(this)},b._interrupt=function(){null!=this.tag&&(this.playState=createjs.Sound.PLAY_INTERRUPTED,this._cleanUp(),this._paused=!1,this._sendEvent("interrupted"))},b.play=function(a,b,c,d,e,f){this._cleanUp(),createjs.Sound._playInstance(this,a,b,c,d,e,f)},b._beginPlaying=function(a,b,c,d){if(null==window.createjs)return-1;var e=this.tag=createjs.HTMLAudioPlugin.TagPool.getInstance(this.src);return null==e?(this.playFailed(),-1):(e.addEventListener(createjs.HTMLAudioPlugin._AUDIO_ENDED,this._endedHandler,!1),this._offset=a,this.volume=c,this.pan=d,this._updateVolume(),this._remainingLoops=b,4!==e.readyState?(e.addEventListener(createjs.HTMLAudioPlugin._AUDIO_READY,this._readyHandler,!1),e.addEventListener(createjs.HTMLAudioPlugin._AUDIO_STALLED,this._stalledHandler,!1),e.preload="auto",e.load()):this._handleSoundReady(null),this._sendEvent("succeeded"),1)},b._handleSoundStalled=function(){this._cleanUp(),this._sendEvent("failed")},b._handleSoundReady=function(){if(null!=window.createjs){if(this._duration=1e3*this.tag.duration,this.playState=createjs.Sound.PLAY_SUCCEEDED,this._paused=!1,this.tag.removeEventListener(createjs.HTMLAudioPlugin._AUDIO_READY,this._readyHandler,!1),this._offset>=this.getDuration())return void this.playFailed();this._offset>0&&(this.tag.currentTime=.001*this._offset),-1==this._remainingLoops&&(this.tag.loop=!0),0!=this._remainingLoops&&(this.tag.addEventListener(createjs.HTMLAudioPlugin._AUDIO_SEEKED,this.loopHandler,!1),this.tag.loop=!0),this.tag.play()}},b.pause=function(){return this._paused||this.playState!=createjs.Sound.PLAY_SUCCEEDED||null==this.tag?!1:(this._paused=!0,this.tag.pause(),clearTimeout(this._delayTimeoutId),!0)},b.resume=function(){return this._paused&&null!=this.tag?(this._paused=!1,this.tag.play(),!0):!1},b.stop=function(){return this._offset=0,this.pause(),this.playState=createjs.Sound.PLAY_FINISHED,this._cleanUp(),!0},b.setMasterVolume=function(){return this._updateVolume(),!0},b.setVolume=function(a){return this.volume=a,!0},b._updateVolume=function(){if(null!=this.tag){var a=this._muted||createjs.Sound._masterMute?0:this._volume*createjs.Sound._masterVolume;return a!=this.tag.volume&&(this.tag.volume=a),!0}return!1},b.getVolume=function(){return this.volume},b.setMasterMute=function(){return this._updateVolume(),!0},b.setMute=function(a){return null==a||void 0==a?!1:(this._muted=a,this._updateVolume(),!0)},b.getMute=function(){return this._muted},b.setPan=function(){return!1},b.getPan=function(){return 0},b.getPosition=function(){return null==this.tag?this._offset:1e3*this.tag.currentTime},b.setPosition=function(a){if(null==this.tag)this._offset=a;else{this.tag.removeEventListener(createjs.HTMLAudioPlugin._AUDIO_SEEKED,this.loopHandler,!1);try{this.tag.currentTime=.001*a}catch(b){return!1}this.tag.addEventListener(createjs.HTMLAudioPlugin._AUDIO_SEEKED,this.loopHandler,!1)}return!0},b.getDuration=function(){return this._duration},b._handleSoundComplete=function(){this._offset=0,null!=window.createjs&&(this.playState=createjs.Sound.PLAY_FINISHED,this._cleanUp(),this._sendEvent("complete"))},b.handleSoundLoop=function(){this._offset=0,this._remainingLoops--,0==this._remainingLoops&&(this.tag.loop=!1,this.tag.removeEventListener(createjs.HTMLAudioPlugin._AUDIO_SEEKED,this.loopHandler,!1)),this._sendEvent("loop")},b.playFailed=function(){null!=window.createjs&&(this.playState=createjs.Sound.PLAY_FAILED,this._cleanUp(),this._sendEvent("failed"))},b.toString=function(){return"[HTMLAudioPlugin SoundInstance]"},createjs.HTMLAudioPlugin.SoundInstance=a}(),function(){function a(a,b){this._init(a,b)}var b=a.prototype;b.src=null,b.tag=null,b.preloadTimer=null,b.loadedHandler=null,b._init=function(a,b){if(this.src=a,this.tag=b,this.preloadTimer=setInterval(createjs.proxy(this.preloadTick,this),200),this.loadedHandler=createjs.proxy(this.sendLoadedEvent,this),this.tag.addEventListener&&this.tag.addEventListener("canplaythrough",this.loadedHandler),null==this.tag.onreadystatechange)this.tag.onreadystatechange=createjs.proxy(this.sendLoadedEvent,this);else{var c=this.tag.onreadystatechange;this.tag.onreadystatechange=function(){c(),this.tag.onreadystatechange=createjs.proxy(this.sendLoadedEvent,this)}}this.tag.preload="auto",this.tag.load()},b.preloadTick=function(){var a=this.tag.buffered,b=this.tag.duration;a.length>0&&a.end(0)>=b-1&&this.handleTagLoaded()},b.handleTagLoaded=function(){clearInterval(this.preloadTimer)},b.sendLoadedEvent=function(){this.tag.removeEventListener&&this.tag.removeEventListener("canplaythrough",this.loadedHandler),this.tag.onreadystatechange=null,createjs.Sound._sendFileLoadEvent(this.src)},b.toString=function(){return"[HTMLAudioPlugin Loader]"},createjs.HTMLAudioPlugin.Loader=a}(),function(){function a(a){this._init(a)}var b=a;b.tags={},b.get=function(c){var d=b.tags[c];return null==d&&(d=b.tags[c]=new a(c)),d},b.remove=function(a){var c=b.tags[a];return null==c?!1:(c.removeAll(),delete b.tags[a],!0)},b.removeAll=function(){for(var a in b.tags)b.tags[a].removeAll();b.tags={}},b.getInstance=function(a){var c=b.tags[a];return null==c?null:c.get()},b.setInstance=function(a,c){var d=b.tags[a];return null==d?null:d.set(c)},b.checkSrc=function(a){var c=b.tags[a];return null==c?null:void c.checkSrcChange()};var c=a.prototype;c.src=null,c.length=0,c.available=0,c.tags=null,c._init=function(a){this.src=a,this.tags=[]},c.add=function(a){this.tags.push(a),this.length++,this.available++},c.removeAll=function(){for(;this.length--;)delete this.tags[this.length];this.src=null,this.tags.length=0},c.get=function(){if(0==this.tags.length)return null;this.available=this.tags.length;var a=this.tags.pop();return null==a.parentNode&&document.body.appendChild(a),a},c.set=function(a){var b=createjs.indexOf(this.tags,a);-1==b&&this.tags.push(a),this.available=this.tags.length},c.checkSrcChange=function(){for(var a=this.tags.length-1,b=this.tags[a].src;a--;)this.tags[a].src=b},c.toString=function(){return"[HTMLAudioPlugin TagPool]"},createjs.HTMLAudioPlugin.TagPool=a}(),define("lib/Sound",function(){}),define("engine/AudioManager",["core/Monogatari","core/Constants","lib/Sound"],function(){function a(){createjs.Sound.registerPlugins([createjs.WebAudioPlugin,createjs.HTMLAudioPlugin]),this.queue=new createjs.LoadQueue,createjs.Sound.alternateExtensions=["mp3"],this.queue.installPlugin(createjs.Sound),this.queue.addEventListener("complete",function(){Monogatari.EventManager.notify("AudioManager.allAudioLoaded")}),this.queue.addEventListener("fileload",function(a){Monogatari.EventManager.notify("AudioManager.audioFileLoaded",a.result.src)}),this.queue.addEventListener("error",function(a){Monogatari.EventManager.notify("AudioManager.audioFailed",a)}),this.queue.addEventListener("progress",function(){Monogatari.EventManager.notify("AudioManager.audioLoading",100*Monogatari.AudioManager.queue.progress.toFixed(2))})}Monogatari.AudioManager=new a,a.prototype.load=function(a){if(a){var b={src:a};this.queue.loadFile(b,!0)}},a.prototype.isLoaded=function(a){return this.queue._loadItemsById[a]||this.queue._loadItemsBySrc[a]?!0:!1},a.prototype.get=function(a){return createjs.Sound.createInstance(a)}}),function(a,b){function c(a){return function(){return this[a]}}function d(a,b){var c=a.split("."),d=fb;!(c[0]in d)&&d.execScript&&d.execScript("var "+c[0]);for(var e;c.length&&(e=c.shift());)c.length||b===bb?d=d[e]?d[e]:d[e]={}:d[e]=b}function e(a){return a.call.apply(a.bind,arguments)}function f(a,b){if(!a)throw Error();if(2<arguments.length){var c=Array.prototype.slice.call(arguments,2);return function(){var d=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(d,c),a.apply(b,d)}}return function(){return a.apply(b,arguments)}}function g(){return g=Function.prototype.bind&&-1!=Function.prototype.bind.toString().indexOf("native code")?e:f,g.apply(db,arguments)}function h(a,b){this.G=a,this.u=b||a,this.z=this.u.document,this.R=bb}function i(a,c,d){a=a.z.getElementsByTagName(c)[0],a||(a=b.documentElement),a&&a.lastChild&&a.insertBefore(d,a.lastChild)}function j(a,b){return a.createElement("link",{rel:"stylesheet",href:b})}function k(a,b){return a.createElement("script",{src:b})}function l(a,b){for(var c=a.className.split(/\s+/),d=0,e=c.length;e>d;d++)if(c[d]==b)return;c.push(b),a.className=c.join(" ").replace(/\s+/g," ").replace(/^\s+|\s+$/,"")}function m(a,b){for(var c=a.className.split(/\s+/),d=[],e=0,f=c.length;f>e;e++)c[e]!=b&&d.push(c[e]);a.className=d.join(" ").replace(/\s+/g," ").replace(/^\s+|\s+$/,"")}function n(a,b){for(var c=a.className.split(/\s+/),d=0,e=c.length;e>d;d++)if(c[d]==b)return cb;return eb}function o(a){if(a.R===bb){var b=a.z.createElement("p");b.innerHTML='<a style="top:1px;">w</a>',a.R=/top/.test(b.getElementsByTagName("a")[0].getAttribute("style"))}return a.R}function p(a){var b=a.u.location.protocol;return"about:"==b&&(b=a.G.location.protocol),"https:"==b?"https:":"http:"}function q(a,b,c){this.w=a,this.T=b,this.Aa=c}function r(a,b,c,d){this.e=a!=db?a:db,this.o=b!=db?b:db,this.ba=c!=db?c:db,this.f=d!=db?d:db}function s(a){a=hb.exec(a);var b=db,c=db,d=db,e=db;return a&&(a[1]!==db&&a[1]&&(b=parseInt(a[1],10)),a[2]!==db&&a[2]&&(c=parseInt(a[2],10)),a[3]!==db&&a[3]&&(d=parseInt(a[3],10)),a[4]!==db&&a[4]&&(e=/^[0-9]+$/.test(a[4])?parseInt(a[4],10):a[4])),new r(b,c,d,e)}function t(a,b,c,d,e,f,g,h,i,j,k){this.J=a,this.Ga=b,this.za=c,this.ga=d,this.Ea=e,this.fa=f,this.xa=g,this.Fa=h,this.wa=i,this.ea=j,this.k=k}function u(a,b){this.a=a,this.H=b}function v(a){var b=y(a.a,/(iPod|iPad|iPhone|Android|Windows Phone|BB\d{2}|BlackBerry)/,1);return""!=b?(/BB\d{2}/.test(b)&&(b="BlackBerry"),b):(a=y(a.a,/(Linux|Mac_PowerPC|Macintosh|Windows|CrOS)/,1),""!=a?("Mac_PowerPC"==a&&(a="Macintosh"),a):"Unknown")}function w(a){var b=y(a.a,/(OS X|Windows NT|Android) ([^;)]+)/,2);if(b||(b=y(a.a,/Windows Phone( OS)? ([^;)]+)/,2))||(b=y(a.a,/(iPhone )?OS ([\d_]+)/,2)))return b;if(b=y(a.a,/(?:Linux|CrOS) ([^;)]+)/,1))for(var b=b.split(/\s/),c=0;c<b.length;c+=1)if(/^[\d\._]+$/.test(b[c]))return b[c];return(a=y(a.a,/(BB\d{2}|BlackBerry).*?Version\/([^\s]*)/,2))?a:"Unknown"}function x(a){var b=v(a),c=w(a),d=s(c),e=y(a.a,/AppleWeb(?:K|k)it\/([\d\.\+]+)/,1),f=s(e),g="Unknown",h=new r,i="Unknown",j=eb;return/OPR\/[\d.]+/.test(a.a)?g="Opera":-1!=a.a.indexOf("Chrome")||-1!=a.a.indexOf("CrMo")||-1!=a.a.indexOf("CriOS")?g="Chrome":/Silk\/\d/.test(a.a)?g="Silk":"BlackBerry"==b||"Android"==b?g="BuiltinBrowser":-1!=a.a.indexOf("PhantomJS")?g="PhantomJS":-1!=a.a.indexOf("Safari")?g="Safari":-1!=a.a.indexOf("AdobeAIR")&&(g="AdobeAIR"),"BuiltinBrowser"==g?i="Unknown":"Silk"==g?i=y(a.a,/Silk\/([\d\._]+)/,1):"Chrome"==g?i=y(a.a,/(Chrome|CrMo|CriOS)\/([\d\.]+)/,2):-1!=a.a.indexOf("Version/")?i=y(a.a,/Version\/([\d\.\w]+)/,1):"AdobeAIR"==g?i=y(a.a,/AdobeAIR\/([\d\.]+)/,1):"Opera"==g?i=y(a.a,/OPR\/([\d.]+)/,1):"PhantomJS"==g&&(i=y(a.a,/PhantomJS\/([\d.]+)/,1)),h=s(i),j="AdobeAIR"==g?2<h.e||2==h.e&&5<=h.o:"BlackBerry"==b?10<=d.e:"Android"==b?2<d.e||2==d.e&&1<d.o:526<=f.e||525<=f.e&&13<=f.o,new t(g,h,i,"AppleWebKit",f,e,b,d,c,z(a.H),new q(j,536>f.e||536==f.e&&11>f.o,"iPhone"==b||"iPad"==b||"iPod"==b||"Macintosh"==b))}function y(a,b,c){return(a=a.match(b))&&a[c]?a[c]:""}function z(a){return a.documentMode?a.documentMode:void 0}function A(a){this.va=a||"-"}function B(a,b){this.J=a,this.U=4,this.K="n";var c=(b||"n4").match(/^([nio])([1-9])$/i);c&&(this.K=c[1],this.U=parseInt(c[2],10))}function C(a){return a.K+a.U}function D(a){var b=4,c="n",d=db;return a&&((d=a.match(/(normal|oblique|italic)/i))&&d[1]&&(c=d[1].substr(0,1).toLowerCase()),(d=a.match(/([1-9]00|normal|bold)/i))&&d[1]&&(/bold/i.test(d[1])?b=7:/[1-9]00/.test(d[1])&&(b=parseInt(d[1].substr(0,1),10)))),c+b}function E(a,b,c){this.c=a,this.h=b,this.M=c,this.j="wf",this.g=new A("-")}function F(a){l(a.h,a.g.f(a.j,"loading")),H(a,"loading")}function G(a){m(a.h,a.g.f(a.j,"loading")),n(a.h,a.g.f(a.j,"active"))||l(a.h,a.g.f(a.j,"inactive")),H(a,"inactive")}function H(a,b,c){a.M[b]&&(c?a.M[b](c.getName(),C(c)):a.M[b]())}function I(a,b){this.c=a,this.C=b,this.s=this.c.createElement("span",{"aria-hidden":"true"},this.C)}function J(a,b){var c,d=a.s;c=[];for(var e=b.J.split(/,\s*/),f=0;f<e.length;f++){var g=e[f].replace(/['"]/g,"");c.push(-1==g.indexOf(" ")?g:"'"+g+"'")}c=c.join(","),e="normal",f=b.U+"00","o"===b.K?e="oblique":"i"===b.K&&(e="italic"),c="position:absolute;top:-999px;left:-999px;font-size:300px;width:auto;height:auto;line-height:normal;margin:0;padding:0;font-variant:normal;white-space:nowrap;font-family:"+c+";"+("font-style:"+e+";font-weight:"+f+";"),o(a.c)?d.setAttribute("style",c):d.style.cssText=c}function K(a){i(a.c,"body",a.s)}function L(a,b,c,d,e,f,g,h){this.V=a,this.ta=b,this.c=c,this.q=d,this.C=h||"BESbswy",this.k=e,this.F={},this.S=f||5e3,this.Z=g||db,this.B=this.A=db,a=new I(this.c,this.C),K(a);for(var i in jb)jb.hasOwnProperty(i)&&(J(a,new B(jb[i],C(this.q))),this.F[jb[i]]=a.s.offsetWidth);a.remove()}function M(a,b,c){for(var d in jb)if(jb.hasOwnProperty(d)&&b===a.F[jb[d]]&&c===a.F[jb[d]])return cb;return eb}function N(a){var b=a.A.s.offsetWidth,c=a.B.s.offsetWidth;b===a.F.serif&&c===a.F["sans-serif"]||a.k.T&&M(a,b,c)?gb()-a.ya>=a.S?a.k.T&&M(a,b,c)&&(a.Z===db||a.Z.hasOwnProperty(a.q.getName()))?O(a,a.V):O(a,a.ta):setTimeout(g(function(){N(this)},a),25):O(a,a.V)}function O(a,b){a.A.remove(),a.B.remove(),b(a.q)}function P(a,b,c,d){this.c=b,this.t=c,this.N=0,this.ca=this.Y=eb,this.S=d,this.k=a.k}function Q(a,b,c,d,e){if(0===b.length&&e)G(a.t);else for(a.N+=b.length,e&&(a.Y=e),e=0;e<b.length;e++){var f=b[e],h=c[f.getName()],i=a.t,j=f;l(i.h,i.g.f(i.j,j.getName(),C(j).toString(),"loading")),H(i,"fontloading",j),new L(g(a.ha,a),g(a.ia,a),a.c,f,a.k,a.S,d,h).start()}}function R(a){0==--a.N&&a.Y&&(a.ca?(a=a.t,m(a.h,a.g.f(a.j,"loading")),m(a.h,a.g.f(a.j,"inactive")),l(a.h,a.g.f(a.j,"active")),H(a,"active")):G(a.t))}function S(a,b,c){this.G=a,this.W=b,this.a=c,this.O=this.P=0}function T(a,b){mb.W.$[a]=b}function U(a,b,c){this.a=a,this.c=b,this.d=c,this.m=[]}function V(a,b){this.c=a,this.d=b,this.m=[]}function W(a,b,c){this.L=a?a:b+nb,this.p=[],this.Q=[],this.da=c||""}function X(a){this.p=a,this.aa=[],this.I={}}function Y(a,b,c){this.a=a,this.c=b,this.d=c}function Z(a,b){this.c=a,this.d=b}function $(a){var b=a.split(":");if(a=b[0],b[1]){for(var c=b[1].split(","),b=[],d=0,e=c.length;e>d;d++){var f=c[d];if(f){var g=tb[f];b.push(g?g:f)}}for(c=[],d=0;d<b.length;d+=1)c.push(new B(a,b[d]));return c}return[new B(a)]}function _(a,b){this.c=a,this.d=b}function ab(a,b){this.c=a,this.d=b,this.m=[]}var bb=void 0,cb=!0,db=null,eb=!1,fb=this,gb=Date.now||function(){return+new Date};h.prototype.createElement=function(a,b,c){if(a=this.z.createElement(a),b)for(var d in b)if(b.hasOwnProperty(d))if("style"==d){var e=a,f=b[d];o(this)?e.setAttribute("style",f):e.style.cssText=f}else a.setAttribute(d,b[d]);return c&&a.appendChild(this.z.createTextNode(c)),a},d("webfont.BrowserInfo",q),q.prototype.qa=c("w"),q.prototype.hasWebFontSupport=q.prototype.qa,q.prototype.ra=c("T"),q.prototype.hasWebKitFallbackBug=q.prototype.ra,q.prototype.sa=c("Aa"),q.prototype.hasWebKitMetricsBug=q.prototype.sa;var hb=/^([0-9]+)(?:[\._-]([0-9]+))?(?:[\._-]([0-9]+))?(?:[\._+-]?(.*))?$/;r.prototype.toString=function(){return[this.e,this.o||"",this.ba||"",this.f||""].join("")},d("webfont.UserAgent",t),t.prototype.getName=c("J"),t.prototype.getName=t.prototype.getName,t.prototype.pa=c("za"),t.prototype.getVersion=t.prototype.pa,t.prototype.la=c("ga"),t.prototype.getEngine=t.prototype.la,t.prototype.ma=c("fa"),t.prototype.getEngineVersion=t.prototype.ma,t.prototype.na=c("xa"),t.prototype.getPlatform=t.prototype.na,t.prototype.oa=c("wa"),t.prototype.getPlatformVersion=t.prototype.oa,t.prototype.ka=c("ea"),t.prototype.getDocumentMode=t.prototype.ka,t.prototype.ja=c("k"),t.prototype.getBrowserInfo=t.prototype.ja;
var ib=new t("Unknown",new r,"Unknown","Unknown",new r,"Unknown","Unknown",new r,"Unknown",bb,new q(eb,eb,eb));u.prototype.parse=function(){var a;if(-1!=this.a.indexOf("MSIE")){a=v(this);var b=w(this),c=s(b),d=y(this.a,/MSIE ([\d\w\.]+)/,1),e=s(d);a=new t("MSIE",e,d,"MSIE",e,d,a,c,b,z(this.H),new q("Windows"==a&&6<=e.e||"Windows Phone"==a&&8<=c.e,eb,eb))}else if(-1!=this.a.indexOf("Opera"))a:{a="Unknown";var b=y(this.a,/Presto\/([\d\w\.]+)/,1),c=s(b),d=w(this),e=s(d),f=z(this.H);if(c.e!==db?a="Presto":(-1!=this.a.indexOf("Gecko")&&(a="Gecko"),b=y(this.a,/rv:([^\)]+)/,1),c=s(b)),-1!=this.a.indexOf("Opera Mini/")){var g=y(this.a,/Opera Mini\/([\d\.]+)/,1),h=s(g);a=new t("OperaMini",h,g,a,c,b,v(this),e,d,f,new q(eb,eb,eb))}else{if(-1!=this.a.indexOf("Version/")&&(g=y(this.a,/Version\/([\d\.]+)/,1),h=s(g),h.e!==db)){a=new t("Opera",h,g,a,c,b,v(this),e,d,f,new q(10<=h.e,eb,eb));break a}g=y(this.a,/Opera[\/ ]([\d\.]+)/,1),h=s(g),a=h.e!==db?new t("Opera",h,g,a,c,b,v(this),e,d,f,new q(10<=h.e,eb,eb)):new t("Opera",new r,"Unknown",a,c,b,v(this),e,d,f,new q(eb,eb,eb))}}else/OPR\/[\d.]+/.test(this.a)?a=x(this):/AppleWeb(K|k)it/.test(this.a)?a=x(this):-1!=this.a.indexOf("Gecko")?(a="Unknown",b=new r,c="Unknown",d=w(this),e=s(d),f=eb,-1!=this.a.indexOf("Firefox")?(a="Firefox",c=y(this.a,/Firefox\/([\d\w\.]+)/,1),b=s(c),f=3<=b.e&&5<=b.o):-1!=this.a.indexOf("Mozilla")&&(a="Mozilla"),g=y(this.a,/rv:([^\)]+)/,1),h=s(g),f||(f=1<h.e||1==h.e&&9<h.o||1==h.e&&9==h.o&&2<=h.ba||g.match(/1\.9\.1b[123]/)!=db||g.match(/1\.9\.1\.[\d\.]+/)!=db),a=new t(a,b,c,"Gecko",h,g,v(this),e,d,z(this.H),new q(f,eb,eb))):a=ib;return a},A.prototype.f=function(){for(var a=[],b=0;b<arguments.length;b++)a.push(arguments[b].replace(/[\W_]+/g,"").toLowerCase());return a.join(this.va)},B.prototype.getName=c("J"),I.prototype.remove=function(){var a=this.s;a.parentNode&&a.parentNode.removeChild(a)};var jb={Da:"serif",Ca:"sans-serif",Ba:"monospace"};L.prototype.start=function(){this.A=new I(this.c,this.C),K(this.A),this.B=new I(this.c,this.C),K(this.B),this.ya=gb(),J(this.A,new B(this.q.getName()+",serif",C(this.q))),J(this.B,new B(this.q.getName()+",sans-serif",C(this.q))),N(this)},P.prototype.ha=function(a){var b=this.t;m(b.h,b.g.f(b.j,a.getName(),C(a).toString(),"loading")),m(b.h,b.g.f(b.j,a.getName(),C(a).toString(),"inactive")),l(b.h,b.g.f(b.j,a.getName(),C(a).toString(),"active")),H(b,"fontactive",a),this.ca=cb,R(this)},P.prototype.ia=function(a){var b=this.t;m(b.h,b.g.f(b.j,a.getName(),C(a).toString(),"loading")),n(b.h,b.g.f(b.j,a.getName(),C(a).toString(),"active"))||l(b.h,b.g.f(b.j,a.getName(),C(a).toString(),"inactive")),H(b,"fontinactive",a),R(this)},S.prototype.load=function(a){var b=a.context||this.G;if(this.c=new h(this.G,b),b=new E(this.c,b.document.documentElement,a),this.a.k.w){var c,d=this.W,e=this.c,f=[];for(c in a)if(a.hasOwnProperty(c)){var i=d.$[c];i&&f.push(i(a[c],e))}for(a=a.timeout,this.O=this.P=f.length,a=new P(this.a,this.c,b,a),c=0,d=f.length;d>c;c++)e=f[c],e.v(this.a,g(this.ua,this,e,b,a))}else G(b)},S.prototype.ua=function(a,b,c,d){var e=this;d?a.load(function(a,d,f){var g=0==--e.P;g&&F(b),setTimeout(function(){Q(c,a,d||{},f||db,g)},0)}):(a=0==--this.P,this.O--,a&&(0==this.O?G(b):F(b)),Q(c,[],{},db,a))};var kb=a,lb=new u(navigator.userAgent,b).parse(),mb=kb.WebFont=new S(a,new function(){this.$={}},lb);mb.load=mb.load,U.prototype.v=function(a,b){var c=this,d=c.d.projectId,e=c.d.version;if(d){var f=c.c.u,g=c.c.createElement("script");g.id="__MonotypeAPIScript__"+d;var h=eb;g.onload=g.onreadystatechange=function(){if(!(h||this.readyState&&"loaded"!==this.readyState&&"complete"!==this.readyState)){if(h=cb,f["__mti_fntLst"+d]){var e=f["__mti_fntLst"+d]();if(e)for(var i=0;i<e.length;i++)c.m.push(new B(e[i].fontfamily))}b(a.k.w),g.onload=g.onreadystatechange=db}},g.src=c.D(d,e),i(this.c,"head",g)}else b(cb)},U.prototype.D=function(a,b){var c=p(this.c),d=(this.d.api||"fast.fonts.com/jsapi").replace(/^.*http(s?):(\/\/)?/,"");return c+"//"+d+"/"+a+".js"+(b?"?v="+b:"")},U.prototype.load=function(a){a(this.m)},T("monotype",function(a,c){var d=new u(navigator.userAgent,b).parse();return new U(d,c,a)}),V.prototype.D=function(a){return p(this.c)+(this.d.api||"//f.fontdeck.com/s/css/js/")+(this.c.u.location.hostname||this.c.G.location.hostname)+"/"+a+".js"},V.prototype.v=function(a,b){var c=this.d.id,d=this.c.u,e=this;c?(d.__webfontfontdeckmodule__||(d.__webfontfontdeckmodule__={}),d.__webfontfontdeckmodule__[c]=function(a,c){for(var d=0,f=c.fonts.length;f>d;++d){var g=c.fonts[d];e.m.push(new B(g.name,D("font-weight:"+g.weight+";font-style:"+g.style)))}b(a)},c=k(this.c,this.D(c)),i(this.c,"head",c)):b(cb)},V.prototype.load=function(a){a(this.m)},T("fontdeck",function(a,b){return new V(b,a)});var nb="//fonts.googleapis.com/css";W.prototype.f=function(){if(0==this.p.length)throw Error("No fonts to load !");if(-1!=this.L.indexOf("kit="))return this.L;for(var a=this.p.length,b=[],c=0;a>c;c++)b.push(this.p[c].replace(/ /g,"+"));return a=this.L+"?family="+b.join("%7C"),0<this.Q.length&&(a+="&subset="+this.Q.join(",")),0<this.da.length&&(a+="&text="+encodeURIComponent(this.da)),a};var ob={latin:"BESbswy",cyrillic:"&#1081;&#1103;&#1046;",greek:"&#945;&#946;&#931;",khmer:"&#x1780;&#x1781;&#x1782;",Hanuman:"&#x1780;&#x1781;&#x1782;"},pb={thin:"1",extralight:"2","extra-light":"2",ultralight:"2","ultra-light":"2",light:"3",regular:"4",book:"4",medium:"5","semi-bold":"6",semibold:"6","demi-bold":"6",demibold:"6",bold:"7","extra-bold":"8",extrabold:"8","ultra-bold":"8",ultrabold:"8",black:"9",heavy:"9",l:"3",r:"4",b:"7"},qb={i:"i",italic:"i",n:"n",normal:"n"},rb=RegExp("^(thin|(?:(?:extra|ultra)-?)?light|regular|book|medium|(?:(?:semi|demi|extra|ultra)-?)?bold|black|heavy|l|r|b|[1-9]00)?(n|i|normal|italic)?$");X.prototype.parse=function(){for(var a=this.p.length,b=0;a>b;b++){var c=this.p[b].split(":"),d=c[0].replace(/\+/g," "),e=["n4"];if(2<=c.length){var f,g=c[1];if(f=[],g)for(var g=g.split(","),h=g.length,i=0;h>i;i++){var j;if(j=g[i],j.match(/^[\w]+$/)){j=rb.exec(j.toLowerCase());var k=bb;if(j==db)k="";else{if(k=bb,k=j[1],k==db||""==k)k="4";else var l=pb[k],k=l?l:isNaN(k)?"4":k.substr(0,1);k=[j[2]==db||""==j[2]?"n":qb[j[2]],k].join("")}j=k}else j="";j&&f.push(j)}0<f.length&&(e=f),3==c.length&&(c=c[2],f=[],c=c?c.split(","):f,0<c.length&&(c=ob[c[0]])&&(this.I[d]=c))}for(this.I[d]||(c=ob[d])&&(this.I[d]=c),c=0;c<e.length;c+=1)this.aa.push(new B(d,e[c]))}};var sb={Arimo:cb,Cousine:cb,Tinos:cb};Y.prototype.v=function(a,b){b(a.k.w)},Y.prototype.load=function(a){var b=this.c;if("MSIE"==this.a.getName()&&this.d.blocking!=cb){var c=g(this.X,this,a),d=function(){b.z.body?c():setTimeout(d,0)};d()}else this.X(a)},Y.prototype.X=function(a){for(var b=this.c,c=new W(this.d.api,p(b),this.d.text),d=this.d.families,e=d.length,f=0;e>f;f++){var g=d[f].split(":");3==g.length&&c.Q.push(g.pop());var h="";2==g.length&&""!=g[1]&&(h=":"),c.p.push(g.join(h))}d=new X(d),d.parse(),i(b,"head",j(b,c.f())),a(d.aa,d.I,sb)},T("google",function(a,c){var d=new u(navigator.userAgent,b).parse();return new Y(d,c,a)});var tb={regular:"n4",bold:"n7",italic:"i4",bolditalic:"i7",r:"n4",b:"n7",i:"i4",bi:"i7"};Z.prototype.v=function(a,b){return b(a.k.w)},Z.prototype.load=function(a){i(this.c,"head",j(this.c,p(this.c)+"//webfonts.fontslive.com/css/"+this.d.key+".css"));for(var b=this.d.families,c=[],d=0,e=b.length;e>d;d++)c.push.apply(c,$(b[d]));a(c)},T("ascender",function(a,b){return new Z(b,a)}),_.prototype.load=function(a){var b,c,d=this.d.urls||[],e=this.d.families||[];for(b=0,c=d.length;c>b;b++)i(this.c,"head",j(this.c,d[b]));for(d=[],b=0,c=e.length;c>b;b++){var f=e[b].split(":");if(f[1])for(var g=f[1].split(","),h=0;h<g.length;h+=1)d.push(new B(f[0],g[h]));else d.push(new B(f[0]))}a(d)},_.prototype.v=function(a,b){return b(a.k.w)},T("custom",function(a,b){return new _(b,a)}),ab.prototype.D=function(a){var b=p(this.c);return(this.d.api||b+"//use.typekit.net")+"/"+a+".js"},ab.prototype.v=function(a,b){var c=this.d.id,d=this.d,e=this.c.u,f=this;c?(e.__webfonttypekitmodule__||(e.__webfonttypekitmodule__={}),e.__webfonttypekitmodule__[c]=function(c){c(a,d,function(a,c,d){for(var e=0;e<c.length;e+=1){var g=d[c[e]];if(g)for(var h=0;h<g.length;h+=1)f.m.push(new B(c[e],g[h]));else f.m.push(new B(c[e]))}b(a)})},c=k(this.c,this.D(c)),i(this.c,"head",c)):b(cb)},ab.prototype.load=function(a){a(this.m)},T("typekit",function(a,b){return new ab(b,a)}),a.WebFontConfig&&mb.load(a.WebFontConfig)}(this,document),define("lib/Webfont",function(){}),define("core/io/file/FontLoader",["core/Monogatari","lib/Webfont"],function(){function a(){}Monogatari.FontLoader=new a,a.prototype.load=function(a,b,c,d){var e=d||this;WebFont.load({google:{families:[a]},fontactive:function(a,c){b.apply(e,[a,c])},fontinactive:function(a,b){c.apply(e,[a,b])}})}}),define("engine/entity/asset/FontAsset",["core/Monogatari"],function(){Monogatari.FontAsset=function(){this.name,this.family,this.status,this.color}}),define("engine/FontManager",["core/Monogatari","core/Constants","core/collection/Map","core/io/file/FontLoader","engine/entity/asset/FontAsset"],function(){function a(){this.fonts=new Monogatari.Map,this._fontIterator=this.fonts.iterator()}Monogatari.FontManager=new a,a.prototype.load=function(a){if(!this.fonts.contains(a)){var b=new Monogatari.FontAsset;b.family=a,b.status=Monogatari.Constants.ASSET_STATE_LOADING,this.fonts.put(a,b),Monogatari.FontLoader.load(a,this.onload,this.onloadFailed)}},a.prototype.isLoaded=function(a){var b=this.fonts.get(a);return b&&b.status===Monogatari.Constants.ASSET_STATE_LOADED?!0:!1},a.prototype.isAllLoaded=function(){var a;for(this._fontIterator.first();this._fontIterator.hasNext();)if(a=this._fontIterator.next(),a&&a.status!=Monogatari.Constants.ASSET_STATE_LOADED)return!1;return!0},a.prototype.onload=function(a){var b=Monogatari.FontManager.fonts.get(a);b.status=Monogatari.Constants.ASSET_STATE_LOADED},a.prototype.onloadFailed=function(a){var b=Monogatari.FontManager.fonts.get(a);b.status=Monogatari.Constants.ASSET_STATE_FAILED},a.prototype.unloadAll=function(){fonts.clear()}});var THREE={REVISION:"66"};self.console=self.console||{info:function(){},log:function(){},debug:function(){},warn:function(){},error:function(){}},function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!self.requestAnimationFrame;++c)self.requestAnimationFrame=self[b[c]+"RequestAnimationFrame"],self.cancelAnimationFrame=self[b[c]+"CancelAnimationFrame"]||self[b[c]+"CancelRequestAnimationFrame"];void 0===self.requestAnimationFrame&&void 0!==self.setTimeout&&(self.requestAnimationFrame=function(b){var c=Date.now(),d=Math.max(0,16-(c-a)),e=self.setTimeout(function(){b(c+d)},d);return a=c+d,e}),void 0===self.cancelAnimationFrame&&void 0!==self.clearTimeout&&(self.cancelAnimationFrame=function(a){self.clearTimeout(a)})}(),THREE.CullFaceNone=0,THREE.CullFaceBack=1,THREE.CullFaceFront=2,THREE.CullFaceFrontBack=3,THREE.FrontFaceDirectionCW=0,THREE.FrontFaceDirectionCCW=1,THREE.BasicShadowMap=0,THREE.PCFShadowMap=1,THREE.PCFSoftShadowMap=2,THREE.FrontSide=0,THREE.BackSide=1,THREE.DoubleSide=2,THREE.NoShading=0,THREE.FlatShading=1,THREE.SmoothShading=2,THREE.NoColors=0,THREE.FaceColors=1,THREE.VertexColors=2,THREE.NoBlending=0,THREE.NormalBlending=1,THREE.AdditiveBlending=2,THREE.SubtractiveBlending=3,THREE.MultiplyBlending=4,THREE.CustomBlending=5,THREE.AddEquation=100,THREE.SubtractEquation=101,THREE.ReverseSubtractEquation=102,THREE.ZeroFactor=200,THREE.OneFactor=201,THREE.SrcColorFactor=202,THREE.OneMinusSrcColorFactor=203,THREE.SrcAlphaFactor=204,THREE.OneMinusSrcAlphaFactor=205,THREE.DstAlphaFactor=206,THREE.OneMinusDstAlphaFactor=207,THREE.DstColorFactor=208,THREE.OneMinusDstColorFactor=209,THREE.SrcAlphaSaturateFactor=210,THREE.MultiplyOperation=0,THREE.MixOperation=1,THREE.AddOperation=2,THREE.UVMapping=function(){},THREE.CubeReflectionMapping=function(){},THREE.CubeRefractionMapping=function(){},THREE.SphericalReflectionMapping=function(){},THREE.SphericalRefractionMapping=function(){},THREE.RepeatWrapping=1e3,THREE.ClampToEdgeWrapping=1001,THREE.MirroredRepeatWrapping=1002,THREE.NearestFilter=1003,THREE.NearestMipMapNearestFilter=1004,THREE.NearestMipMapLinearFilter=1005,THREE.LinearFilter=1006,THREE.LinearMipMapNearestFilter=1007,THREE.LinearMipMapLinearFilter=1008,THREE.UnsignedByteType=1009,THREE.ByteType=1010,THREE.ShortType=1011,THREE.UnsignedShortType=1012,THREE.IntType=1013,THREE.UnsignedIntType=1014,THREE.FloatType=1015,THREE.UnsignedShort4444Type=1016,THREE.UnsignedShort5551Type=1017,THREE.UnsignedShort565Type=1018,THREE.AlphaFormat=1019,THREE.RGBFormat=1020,THREE.RGBAFormat=1021,THREE.LuminanceFormat=1022,THREE.LuminanceAlphaFormat=1023,THREE.RGB_S3TC_DXT1_Format=2001,THREE.RGBA_S3TC_DXT1_Format=2002,THREE.RGBA_S3TC_DXT3_Format=2003,THREE.RGBA_S3TC_DXT5_Format=2004,THREE.Color=function(a){return 3===arguments.length?this.setRGB(arguments[0],arguments[1],arguments[2]):this.set(a)},THREE.Color.prototype={constructor:THREE.Color,r:1,g:1,b:1,set:function(a){return a instanceof THREE.Color?this.copy(a):"number"==typeof a?this.setHex(a):"string"==typeof a&&this.setStyle(a),this},setHex:function(a){return a=Math.floor(a),this.r=(a>>16&255)/255,this.g=(a>>8&255)/255,this.b=(255&a)/255,this},setRGB:function(a,b,c){return this.r=a,this.g=b,this.b=c,this},setHSL:function(a,b,c){if(0===b)this.r=this.g=this.b=c;else{var d=function(a,b,c){return 0>c&&(c+=1),c>1&&(c-=1),1/6>c?a+6*(b-a)*c:.5>c?b:2/3>c?a+6*(b-a)*(2/3-c):a};b=.5>=c?c*(1+b):c+b-c*b,c=2*c-b,this.r=d(c,b,a+1/3),this.g=d(c,b,a),this.b=d(c,b,a-1/3)}return this},setStyle:function(a){return/^rgb\((\d+), ?(\d+), ?(\d+)\)$/i.test(a)?(a=/^rgb\((\d+), ?(\d+), ?(\d+)\)$/i.exec(a),this.r=Math.min(255,parseInt(a[1],10))/255,this.g=Math.min(255,parseInt(a[2],10))/255,this.b=Math.min(255,parseInt(a[3],10))/255,this):/^rgb\((\d+)\%, ?(\d+)\%, ?(\d+)\%\)$/i.test(a)?(a=/^rgb\((\d+)\%, ?(\d+)\%, ?(\d+)\%\)$/i.exec(a),this.r=Math.min(100,parseInt(a[1],10))/100,this.g=Math.min(100,parseInt(a[2],10))/100,this.b=Math.min(100,parseInt(a[3],10))/100,this):/^\#([0-9a-f]{6})$/i.test(a)?(a=/^\#([0-9a-f]{6})$/i.exec(a),this.setHex(parseInt(a[1],16)),this):/^\#([0-9a-f])([0-9a-f])([0-9a-f])$/i.test(a)?(a=/^\#([0-9a-f])([0-9a-f])([0-9a-f])$/i.exec(a),this.setHex(parseInt(a[1]+a[1]+a[2]+a[2]+a[3]+a[3],16)),this):/^(\w+)$/i.test(a)?(this.setHex(THREE.ColorKeywords[a]),this):void 0},copy:function(a){return this.r=a.r,this.g=a.g,this.b=a.b,this},copyGammaToLinear:function(a){return this.r=a.r*a.r,this.g=a.g*a.g,this.b=a.b*a.b,this},copyLinearToGamma:function(a){return this.r=Math.sqrt(a.r),this.g=Math.sqrt(a.g),this.b=Math.sqrt(a.b),this},convertGammaToLinear:function(){var a=this.r,b=this.g,c=this.b;return this.r=a*a,this.g=b*b,this.b=c*c,this},convertLinearToGamma:function(){return this.r=Math.sqrt(this.r),this.g=Math.sqrt(this.g),this.b=Math.sqrt(this.b),this},getHex:function(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0},getHexString:function(){return("000000"+this.getHex().toString(16)).slice(-6)},getHSL:function(a){a=a||{h:0,s:0,l:0};var b,c=this.r,d=this.g,e=this.b,f=Math.max(c,d,e),g=Math.min(c,d,e),h=(g+f)/2;if(g===f)g=b=0;else{var i=f-g,g=.5>=h?i/(f+g):i/(2-f-g);switch(f){case c:b=(d-e)/i+(e>d?6:0);break;case d:b=(e-c)/i+2;break;case e:b=(c-d)/i+4}b/=6}return a.h=b,a.s=g,a.l=h,a},getStyle:function(){return"rgb("+(255*this.r|0)+","+(255*this.g|0)+","+(255*this.b|0)+")"},offsetHSL:function(a,b,c){var d=this.getHSL();return d.h+=a,d.s+=b,d.l+=c,this.setHSL(d.h,d.s,d.l),this},add:function(a){return this.r+=a.r,this.g+=a.g,this.b+=a.b,this},addColors:function(a,b){return this.r=a.r+b.r,this.g=a.g+b.g,this.b=a.b+b.b,this},addScalar:function(a){return this.r+=a,this.g+=a,this.b+=a,this},multiply:function(a){return this.r*=a.r,this.g*=a.g,this.b*=a.b,this},multiplyScalar:function(a){return this.r*=a,this.g*=a,this.b*=a,this},lerp:function(a,b){return this.r+=(a.r-this.r)*b,this.g+=(a.g-this.g)*b,this.b+=(a.b-this.b)*b,this},equals:function(a){return a.r===this.r&&a.g===this.g&&a.b===this.b},fromArray:function(a){return this.r=a[0],this.g=a[1],this.b=a[2],this},toArray:function(){return[this.r,this.g,this.b]},clone:function(){return(new THREE.Color).setRGB(this.r,this.g,this.b)}},THREE.ColorKeywords={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},THREE.Quaternion=function(a,b,c,d){this._x=a||0,this._y=b||0,this._z=c||0,this._w=void 0!==d?d:1},THREE.Quaternion.prototype={constructor:THREE.Quaternion,_x:0,_y:0,_z:0,_w:0,_euler:void 0,_updateEuler:function(){void 0!==this._euler&&this._euler.setFromQuaternion(this,void 0,!1)},get x(){return this._x},set x(a){this._x=a,this._updateEuler()},get y(){return this._y},set y(a){this._y=a,this._updateEuler()},get z(){return this._z},set z(a){this._z=a,this._updateEuler()},get w(){return this._w},set w(a){this._w=a,this._updateEuler()},set:function(a,b,c,d){return this._x=a,this._y=b,this._z=c,this._w=d,this._updateEuler(),this},copy:function(a){return this._x=a._x,this._y=a._y,this._z=a._z,this._w=a._w,this._updateEuler(),this},setFromEuler:function(a,b){if(0==a instanceof THREE.Euler)throw Error("ERROR: Quaternion's .setFromEuler() now expects a Euler rotation rather than a Vector3 and order.  Please update your code.");var c=Math.cos(a._x/2),d=Math.cos(a._y/2),e=Math.cos(a._z/2),f=Math.sin(a._x/2),g=Math.sin(a._y/2),h=Math.sin(a._z/2);return"XYZ"===a.order?(this._x=f*d*e+c*g*h,this._y=c*g*e-f*d*h,this._z=c*d*h+f*g*e,this._w=c*d*e-f*g*h):"YXZ"===a.order?(this._x=f*d*e+c*g*h,this._y=c*g*e-f*d*h,this._z=c*d*h-f*g*e,this._w=c*d*e+f*g*h):"ZXY"===a.order?(this._x=f*d*e-c*g*h,this._y=c*g*e+f*d*h,this._z=c*d*h+f*g*e,this._w=c*d*e-f*g*h):"ZYX"===a.order?(this._x=f*d*e-c*g*h,this._y=c*g*e+f*d*h,this._z=c*d*h-f*g*e,this._w=c*d*e+f*g*h):"YZX"===a.order?(this._x=f*d*e+c*g*h,this._y=c*g*e+f*d*h,this._z=c*d*h-f*g*e,this._w=c*d*e-f*g*h):"XZY"===a.order&&(this._x=f*d*e-c*g*h,this._y=c*g*e-f*d*h,this._z=c*d*h+f*g*e,this._w=c*d*e+f*g*h),!1!==b&&this._updateEuler(),this},setFromAxisAngle:function(a,b){var c=b/2,d=Math.sin(c);return this._x=a.x*d,this._y=a.y*d,this._z=a.z*d,this._w=Math.cos(c),this._updateEuler(),this},setFromRotationMatrix:function(a){var b=a.elements,c=b[0];a=b[4];var d=b[8],e=b[1],f=b[5],g=b[9],h=b[2],i=b[6],b=b[10],j=c+f+b;return j>0?(c=.5/Math.sqrt(j+1),this._w=.25/c,this._x=(i-g)*c,this._y=(d-h)*c,this._z=(e-a)*c):c>f&&c>b?(c=2*Math.sqrt(1+c-f-b),this._w=(i-g)/c,this._x=.25*c,this._y=(a+e)/c,this._z=(d+h)/c):f>b?(c=2*Math.sqrt(1+f-c-b),this._w=(d-h)/c,this._x=(a+e)/c,this._y=.25*c,this._z=(g+i)/c):(c=2*Math.sqrt(1+b-c-f),this._w=(e-a)/c,this._x=(d+h)/c,this._y=(g+i)/c,this._z=.25*c),this._updateEuler(),this},inverse:function(){return this.conjugate().normalize(),this},conjugate:function(){return this._x*=-1,this._y*=-1,this._z*=-1,this._updateEuler(),this},lengthSq:function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w},length:function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)},normalize:function(){var a=this.length();return 0===a?(this._z=this._y=this._x=0,this._w=1):(a=1/a,this._x*=a,this._y*=a,this._z*=a,this._w*=a),this},multiply:function(a,b){return void 0!==b?(console.warn("DEPRECATED: Quaternion's .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(a,b)):this.multiplyQuaternions(this,a)},multiplyQuaternions:function(a,b){var c=a._x,d=a._y,e=a._z,f=a._w,g=b._x,h=b._y,i=b._z,j=b._w;return this._x=c*j+f*g+d*i-e*h,this._y=d*j+f*h+e*g-c*i,this._z=e*j+f*i+c*h-d*g,this._w=f*j-c*g-d*h-e*i,this._updateEuler(),this},multiplyVector3:function(a){return console.warn("DEPRECATED: Quaternion's .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead."),a.applyQuaternion(this)},slerp:function(a,b){var c=this._x,d=this._y,e=this._z,f=this._w,g=f*a._w+c*a._x+d*a._y+e*a._z;if(0>g?(this._w=-a._w,this._x=-a._x,this._y=-a._y,this._z=-a._z,g=-g):this.copy(a),g>=1)return this._w=f,this._x=c,this._y=d,this._z=e,this;var h=Math.acos(g),i=Math.sqrt(1-g*g);return.001>Math.abs(i)?(this._w=.5*(f+this._w),this._x=.5*(c+this._x),this._y=.5*(d+this._y),this._z=.5*(e+this._z),this):(g=Math.sin((1-b)*h)/i,h=Math.sin(b*h)/i,this._w=f*g+this._w*h,this._x=c*g+this._x*h,this._y=d*g+this._y*h,this._z=e*g+this._z*h,this._updateEuler(),this)},equals:function(a){return a._x===this._x&&a._y===this._y&&a._z===this._z&&a._w===this._w},fromArray:function(a){return this._x=a[0],this._y=a[1],this._z=a[2],this._w=a[3],this._updateEuler(),this},toArray:function(){return[this._x,this._y,this._z,this._w]},clone:function(){return new THREE.Quaternion(this._x,this._y,this._z,this._w)}},THREE.Quaternion.slerp=function(a,b,c,d){return c.copy(a).slerp(b,d)},THREE.Vector2=function(a,b){this.x=a||0,this.y=b||0},THREE.Vector2.prototype={constructor:THREE.Vector2,set:function(a,b){return this.x=a,this.y=b,this},setX:function(a){return this.x=a,this},setY:function(a){return this.y=a,this},setComponent:function(a,b){switch(a){case 0:this.x=b;break;case 1:this.y=b;break;default:throw Error("index is out of range: "+a)}},getComponent:function(a){switch(a){case 0:return this.x;case 1:return this.y;default:throw Error("index is out of range: "+a)}},copy:function(a){return this.x=a.x,this.y=a.y,this},add:function(a,b){return void 0!==b?(console.warn("DEPRECATED: Vector2's .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(a,b)):(this.x+=a.x,this.y+=a.y,this)},addVectors:function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this},addScalar:function(a){return this.x+=a,this.y+=a,this},sub:function(a,b){return void 0!==b?(console.warn("DEPRECATED: Vector2's .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(a,b)):(this.x-=a.x,this.y-=a.y,this)},subVectors:function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this},multiplyScalar:function(a){return this.x*=a,this.y*=a,this},divideScalar:function(a){return 0!==a?(a=1/a,this.x*=a,this.y*=a):this.y=this.x=0,this},min:function(a){return this.x>a.x&&(this.x=a.x),this.y>a.y&&(this.y=a.y),this},max:function(a){return this.x<a.x&&(this.x=a.x),this.y<a.y&&(this.y=a.y),this},clamp:function(a,b){return this.x<a.x?this.x=a.x:this.x>b.x&&(this.x=b.x),this.y<a.y?this.y=a.y:this.y>b.y&&(this.y=b.y),this},clampScalar:function(){var a,b;return function(c,d){return void 0===a&&(a=new THREE.Vector2,b=new THREE.Vector2),a.set(c,c),b.set(d,d),this.clamp(a,b)}}(),floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},roundToZero:function(){return this.x=0>this.x?Math.ceil(this.x):Math.floor(this.x),this.y=0>this.y?Math.ceil(this.y):Math.floor(this.y),this},negate:function(){return this.multiplyScalar(-1)},dot:function(a){return this.x*a.x+this.y*a.y},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){return this.divideScalar(this.length())},distanceTo:function(a){return Math.sqrt(this.distanceToSquared(a))},distanceToSquared:function(a){var b=this.x-a.x;return a=this.y-a.y,b*b+a*a},setLength:function(a){var b=this.length();return 0!==b&&a!==b&&this.multiplyScalar(a/b),this},lerp:function(a,b){return this.x+=(a.x-this.x)*b,this.y+=(a.y-this.y)*b,this},equals:function(a){return a.x===this.x&&a.y===this.y},fromArray:function(a){return this.x=a[0],this.y=a[1],this},toArray:function(){return[this.x,this.y]},clone:function(){return new THREE.Vector2(this.x,this.y)}},THREE.Vector3=function(a,b,c){this.x=a||0,this.y=b||0,this.z=c||0},THREE.Vector3.prototype={constructor:THREE.Vector3,set:function(a,b,c){return this.x=a,this.y=b,this.z=c,this},setX:function(a){return this.x=a,this},setY:function(a){return this.y=a,this},setZ:function(a){return this.z=a,this},setComponent:function(a,b){switch(a){case 0:this.x=b;break;case 1:this.y=b;break;case 2:this.z=b;break;default:throw Error("index is out of range: "+a)}},getComponent:function(a){switch(a){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw Error("index is out of range: "+a)}},copy:function(a){return this.x=a.x,this.y=a.y,this.z=a.z,this},add:function(a,b){return void 0!==b?(console.warn("DEPRECATED: Vector3's .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(a,b)):(this.x+=a.x,this.y+=a.y,this.z+=a.z,this)},addScalar:function(a){return this.x+=a,this.y+=a,this.z+=a,this},addVectors:function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this.z=a.z+b.z,this},sub:function(a,b){return void 0!==b?(console.warn("DEPRECATED: Vector3's .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(a,b)):(this.x-=a.x,this.y-=a.y,this.z-=a.z,this)},subVectors:function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this.z=a.z-b.z,this},multiply:function(a,b){return void 0!==b?(console.warn("DEPRECATED: Vector3's .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(a,b)):(this.x*=a.x,this.y*=a.y,this.z*=a.z,this)},multiplyScalar:function(a){return this.x*=a,this.y*=a,this.z*=a,this},multiplyVectors:function(a,b){return this.x=a.x*b.x,this.y=a.y*b.y,this.z=a.z*b.z,this},applyEuler:function(){var a;return function(b){return 0==b instanceof THREE.Euler&&console.error("ERROR: Vector3's .applyEuler() now expects a Euler rotation rather than a Vector3 and order.  Please update your code."),void 0===a&&(a=new THREE.Quaternion),this.applyQuaternion(a.setFromEuler(b)),this}}(),applyAxisAngle:function(){var a;return function(b,c){return void 0===a&&(a=new THREE.Quaternion),this.applyQuaternion(a.setFromAxisAngle(b,c)),this}}(),applyMatrix3:function(a){var b=this.x,c=this.y,d=this.z;return a=a.elements,this.x=a[0]*b+a[3]*c+a[6]*d,this.y=a[1]*b+a[4]*c+a[7]*d,this.z=a[2]*b+a[5]*c+a[8]*d,this},applyMatrix4:function(a){var b=this.x,c=this.y,d=this.z;return a=a.elements,this.x=a[0]*b+a[4]*c+a[8]*d+a[12],this.y=a[1]*b+a[5]*c+a[9]*d+a[13],this.z=a[2]*b+a[6]*c+a[10]*d+a[14],this},applyProjection:function(a){var b=this.x,c=this.y,d=this.z;a=a.elements;var e=1/(a[3]*b+a[7]*c+a[11]*d+a[15]);return this.x=(a[0]*b+a[4]*c+a[8]*d+a[12])*e,this.y=(a[1]*b+a[5]*c+a[9]*d+a[13])*e,this.z=(a[2]*b+a[6]*c+a[10]*d+a[14])*e,this},applyQuaternion:function(a){var b=this.x,c=this.y,d=this.z,e=a.x,f=a.y,g=a.z;a=a.w;var h=a*b+f*d-g*c,i=a*c+g*b-e*d,j=a*d+e*c-f*b,b=-e*b-f*c-g*d;return this.x=h*a+b*-e+i*-g-j*-f,this.y=i*a+b*-f+j*-e-h*-g,this.z=j*a+b*-g+h*-f-i*-e,this},transformDirection:function(a){var b=this.x,c=this.y,d=this.z;return a=a.elements,this.x=a[0]*b+a[4]*c+a[8]*d,this.y=a[1]*b+a[5]*c+a[9]*d,this.z=a[2]*b+a[6]*c+a[10]*d,this.normalize(),this},divide:function(a){return this.x/=a.x,this.y/=a.y,this.z/=a.z,this},divideScalar:function(a){return 0!==a?(a=1/a,this.x*=a,this.y*=a,this.z*=a):this.z=this.y=this.x=0,this},min:function(a){return this.x>a.x&&(this.x=a.x),this.y>a.y&&(this.y=a.y),this.z>a.z&&(this.z=a.z),this},max:function(a){return this.x<a.x&&(this.x=a.x),this.y<a.y&&(this.y=a.y),this.z<a.z&&(this.z=a.z),this},clamp:function(a,b){return this.x<a.x?this.x=a.x:this.x>b.x&&(this.x=b.x),this.y<a.y?this.y=a.y:this.y>b.y&&(this.y=b.y),this.z<a.z?this.z=a.z:this.z>b.z&&(this.z=b.z),this},clampScalar:function(){var a,b;return function(c,d){return void 0===a&&(a=new THREE.Vector3,b=new THREE.Vector3),a.set(c,c,c),b.set(d,d,d),this.clamp(a,b)}}(),floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this},roundToZero:function(){return this.x=0>this.x?Math.ceil(this.x):Math.floor(this.x),this.y=0>this.y?Math.ceil(this.y):Math.floor(this.y),this.z=0>this.z?Math.ceil(this.z):Math.floor(this.z),this},negate:function(){return this.multiplyScalar(-1)},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length())},setLength:function(a){var b=this.length();return 0!==b&&a!==b&&this.multiplyScalar(a/b),this},lerp:function(a,b){return this.x+=(a.x-this.x)*b,this.y+=(a.y-this.y)*b,this.z+=(a.z-this.z)*b,this},cross:function(a,b){if(void 0!==b)return console.warn("DEPRECATED: Vector3's .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(a,b);var c=this.x,d=this.y,e=this.z;return this.x=d*a.z-e*a.y,this.y=e*a.x-c*a.z,this.z=c*a.y-d*a.x,this},crossVectors:function(a,b){var c=a.x,d=a.y,e=a.z,f=b.x,g=b.y,h=b.z;return this.x=d*h-e*g,this.y=e*f-c*h,this.z=c*g-d*f,this},projectOnVector:function(){var a,b;return function(c){return void 0===a&&(a=new THREE.Vector3),a.copy(c).normalize(),b=this.dot(a),this.copy(a).multiplyScalar(b)}}(),projectOnPlane:function(){var a;return function(b){return void 0===a&&(a=new THREE.Vector3),a.copy(this).projectOnVector(b),this.sub(a)}}(),reflect:function(){var a;
return function(b){return void 0===a&&(a=new THREE.Vector3),this.sub(a.copy(b).multiplyScalar(2*this.dot(b)))}}(),angleTo:function(a){return a=this.dot(a)/(this.length()*a.length()),Math.acos(THREE.Math.clamp(a,-1,1))},distanceTo:function(a){return Math.sqrt(this.distanceToSquared(a))},distanceToSquared:function(a){var b=this.x-a.x,c=this.y-a.y;return a=this.z-a.z,b*b+c*c+a*a},setEulerFromRotationMatrix:function(){console.error("REMOVED: Vector3's setEulerFromRotationMatrix has been removed in favor of Euler.setFromRotationMatrix(), please update your code.")},setEulerFromQuaternion:function(){console.error("REMOVED: Vector3's setEulerFromQuaternion: has been removed in favor of Euler.setFromQuaternion(), please update your code.")},getPositionFromMatrix:function(a){return console.warn("DEPRECATED: Vector3's .getPositionFromMatrix() has been renamed to .setFromMatrixPosition(). Please update your code."),this.setFromMatrixPosition(a)},getScaleFromMatrix:function(a){return console.warn("DEPRECATED: Vector3's .getScaleFromMatrix() has been renamed to .setFromMatrixScale(). Please update your code."),this.setFromMatrixScale(a)},getColumnFromMatrix:function(a,b){return console.warn("DEPRECATED: Vector3's .getColumnFromMatrix() has been renamed to .setFromMatrixColumn(). Please update your code."),this.setFromMatrixColumn(a,b)},setFromMatrixPosition:function(a){return this.x=a.elements[12],this.y=a.elements[13],this.z=a.elements[14],this},setFromMatrixScale:function(a){var b=this.set(a.elements[0],a.elements[1],a.elements[2]).length(),c=this.set(a.elements[4],a.elements[5],a.elements[6]).length();return a=this.set(a.elements[8],a.elements[9],a.elements[10]).length(),this.x=b,this.y=c,this.z=a,this},setFromMatrixColumn:function(a,b){var c=4*a,d=b.elements;return this.x=d[c],this.y=d[c+1],this.z=d[c+2],this},equals:function(a){return a.x===this.x&&a.y===this.y&&a.z===this.z},fromArray:function(a){return this.x=a[0],this.y=a[1],this.z=a[2],this},toArray:function(){return[this.x,this.y,this.z]},clone:function(){return new THREE.Vector3(this.x,this.y,this.z)}},THREE.Vector4=function(a,b,c,d){this.x=a||0,this.y=b||0,this.z=c||0,this.w=void 0!==d?d:1},THREE.Vector4.prototype={constructor:THREE.Vector4,set:function(a,b,c,d){return this.x=a,this.y=b,this.z=c,this.w=d,this},setX:function(a){return this.x=a,this},setY:function(a){return this.y=a,this},setZ:function(a){return this.z=a,this},setW:function(a){return this.w=a,this},setComponent:function(a,b){switch(a){case 0:this.x=b;break;case 1:this.y=b;break;case 2:this.z=b;break;case 3:this.w=b;break;default:throw Error("index is out of range: "+a)}},getComponent:function(a){switch(a){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw Error("index is out of range: "+a)}},copy:function(a){return this.x=a.x,this.y=a.y,this.z=a.z,this.w=void 0!==a.w?a.w:1,this},add:function(a,b){return void 0!==b?(console.warn("DEPRECATED: Vector4's .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(a,b)):(this.x+=a.x,this.y+=a.y,this.z+=a.z,this.w+=a.w,this)},addScalar:function(a){return this.x+=a,this.y+=a,this.z+=a,this.w+=a,this},addVectors:function(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this.z=a.z+b.z,this.w=a.w+b.w,this},sub:function(a,b){return void 0!==b?(console.warn("DEPRECATED: Vector4's .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(a,b)):(this.x-=a.x,this.y-=a.y,this.z-=a.z,this.w-=a.w,this)},subVectors:function(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this.z=a.z-b.z,this.w=a.w-b.w,this},multiplyScalar:function(a){return this.x*=a,this.y*=a,this.z*=a,this.w*=a,this},applyMatrix4:function(a){var b=this.x,c=this.y,d=this.z,e=this.w;return a=a.elements,this.x=a[0]*b+a[4]*c+a[8]*d+a[12]*e,this.y=a[1]*b+a[5]*c+a[9]*d+a[13]*e,this.z=a[2]*b+a[6]*c+a[10]*d+a[14]*e,this.w=a[3]*b+a[7]*c+a[11]*d+a[15]*e,this},divideScalar:function(a){return 0!==a?(a=1/a,this.x*=a,this.y*=a,this.z*=a,this.w*=a):(this.z=this.y=this.x=0,this.w=1),this},setAxisAngleFromQuaternion:function(a){this.w=2*Math.acos(a.w);var b=Math.sqrt(1-a.w*a.w);return 1e-4>b?(this.x=1,this.z=this.y=0):(this.x=a.x/b,this.y=a.y/b,this.z=a.z/b),this},setAxisAngleFromRotationMatrix:function(a){var b,c,d;a=a.elements;var e=a[0];d=a[4];var f=a[8],g=a[1],h=a[5],i=a[9];c=a[2],b=a[6];var j=a[10];return.01>Math.abs(d-g)&&.01>Math.abs(f-c)&&.01>Math.abs(i-b)?.1>Math.abs(d+g)&&.1>Math.abs(f+c)&&.1>Math.abs(i+b)&&.1>Math.abs(e+h+j-3)?(this.set(1,0,0,0),this):(a=Math.PI,e=(e+1)/2,h=(h+1)/2,j=(j+1)/2,d=(d+g)/4,f=(f+c)/4,i=(i+b)/4,e>h&&e>j?.01>e?(b=0,d=c=.707106781):(b=Math.sqrt(e),c=d/b,d=f/b):h>j?.01>h?(b=.707106781,c=0,d=.707106781):(c=Math.sqrt(h),b=d/c,d=i/c):.01>j?(c=b=.707106781,d=0):(d=Math.sqrt(j),b=f/d,c=i/d),this.set(b,c,d,a),this):(a=Math.sqrt((b-i)*(b-i)+(f-c)*(f-c)+(g-d)*(g-d)),.001>Math.abs(a)&&(a=1),this.x=(b-i)/a,this.y=(f-c)/a,this.z=(g-d)/a,this.w=Math.acos((e+h+j-1)/2),this)},min:function(a){return this.x>a.x&&(this.x=a.x),this.y>a.y&&(this.y=a.y),this.z>a.z&&(this.z=a.z),this.w>a.w&&(this.w=a.w),this},max:function(a){return this.x<a.x&&(this.x=a.x),this.y<a.y&&(this.y=a.y),this.z<a.z&&(this.z=a.z),this.w<a.w&&(this.w=a.w),this},clamp:function(a,b){return this.x<a.x?this.x=a.x:this.x>b.x&&(this.x=b.x),this.y<a.y?this.y=a.y:this.y>b.y&&(this.y=b.y),this.z<a.z?this.z=a.z:this.z>b.z&&(this.z=b.z),this.w<a.w?this.w=a.w:this.w>b.w&&(this.w=b.w),this},clampScalar:function(){var a,b;return function(c,d){return void 0===a&&(a=new THREE.Vector4,b=new THREE.Vector4),a.set(c,c,c,c),b.set(d,d,d,d),this.clamp(a,b)}}(),floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this},roundToZero:function(){return this.x=0>this.x?Math.ceil(this.x):Math.floor(this.x),this.y=0>this.y?Math.ceil(this.y):Math.floor(this.y),this.z=0>this.z?Math.ceil(this.z):Math.floor(this.z),this.w=0>this.w?Math.ceil(this.w):Math.floor(this.w),this},negate:function(){return this.multiplyScalar(-1)},dot:function(a){return this.x*a.x+this.y*a.y+this.z*a.z+this.w*a.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)},normalize:function(){return this.divideScalar(this.length())},setLength:function(a){var b=this.length();return 0!==b&&a!==b&&this.multiplyScalar(a/b),this},lerp:function(a,b){return this.x+=(a.x-this.x)*b,this.y+=(a.y-this.y)*b,this.z+=(a.z-this.z)*b,this.w+=(a.w-this.w)*b,this},equals:function(a){return a.x===this.x&&a.y===this.y&&a.z===this.z&&a.w===this.w},fromArray:function(a){return this.x=a[0],this.y=a[1],this.z=a[2],this.w=a[3],this},toArray:function(){return[this.x,this.y,this.z,this.w]},clone:function(){return new THREE.Vector4(this.x,this.y,this.z,this.w)}},THREE.Euler=function(a,b,c,d){this._x=a||0,this._y=b||0,this._z=c||0,this._order=d||THREE.Euler.DefaultOrder},THREE.Euler.RotationOrders="XYZ YZX ZXY XZY YXZ ZYX".split(" "),THREE.Euler.DefaultOrder="XYZ",THREE.Euler.prototype={constructor:THREE.Euler,_x:0,_y:0,_z:0,_order:THREE.Euler.DefaultOrder,_quaternion:void 0,_updateQuaternion:function(){void 0!==this._quaternion&&this._quaternion.setFromEuler(this,!1)},get x(){return this._x},set x(a){this._x=a,this._updateQuaternion()},get y(){return this._y},set y(a){this._y=a,this._updateQuaternion()},get z(){return this._z},set z(a){this._z=a,this._updateQuaternion()},get order(){return this._order},set order(a){this._order=a,this._updateQuaternion()},set:function(a,b,c,d){return this._x=a,this._y=b,this._z=c,this._order=d||this._order,this._updateQuaternion(),this},copy:function(a){return this._x=a._x,this._y=a._y,this._z=a._z,this._order=a._order,this._updateQuaternion(),this},setFromRotationMatrix:function(a,b){function c(a){return Math.min(Math.max(a,-1),1)}var d=a.elements,e=d[0],f=d[4],g=d[8],h=d[1],i=d[5],j=d[9],k=d[2],l=d[6],d=d[10];return b=b||this._order,"XYZ"===b?(this._y=Math.asin(c(g)),.99999>Math.abs(g)?(this._x=Math.atan2(-j,d),this._z=Math.atan2(-f,e)):(this._x=Math.atan2(l,i),this._z=0)):"YXZ"===b?(this._x=Math.asin(-c(j)),.99999>Math.abs(j)?(this._y=Math.atan2(g,d),this._z=Math.atan2(h,i)):(this._y=Math.atan2(-k,e),this._z=0)):"ZXY"===b?(this._x=Math.asin(c(l)),.99999>Math.abs(l)?(this._y=Math.atan2(-k,d),this._z=Math.atan2(-f,i)):(this._y=0,this._z=Math.atan2(h,e))):"ZYX"===b?(this._y=Math.asin(-c(k)),.99999>Math.abs(k)?(this._x=Math.atan2(l,d),this._z=Math.atan2(h,e)):(this._x=0,this._z=Math.atan2(-f,i))):"YZX"===b?(this._z=Math.asin(c(h)),.99999>Math.abs(h)?(this._x=Math.atan2(-j,i),this._y=Math.atan2(-k,e)):(this._x=0,this._y=Math.atan2(g,d))):"XZY"===b?(this._z=Math.asin(-c(f)),.99999>Math.abs(f)?(this._x=Math.atan2(l,i),this._y=Math.atan2(g,e)):(this._x=Math.atan2(-j,d),this._y=0)):console.warn("WARNING: Euler.setFromRotationMatrix() given unsupported order: "+b),this._order=b,this._updateQuaternion(),this},setFromQuaternion:function(a,b,c){function d(a){return Math.min(Math.max(a,-1),1)}var e=a.x*a.x,f=a.y*a.y,g=a.z*a.z,h=a.w*a.w;return b=b||this._order,"XYZ"===b?(this._x=Math.atan2(2*(a.x*a.w-a.y*a.z),h-e-f+g),this._y=Math.asin(d(2*(a.x*a.z+a.y*a.w))),this._z=Math.atan2(2*(a.z*a.w-a.x*a.y),h+e-f-g)):"YXZ"===b?(this._x=Math.asin(d(2*(a.x*a.w-a.y*a.z))),this._y=Math.atan2(2*(a.x*a.z+a.y*a.w),h-e-f+g),this._z=Math.atan2(2*(a.x*a.y+a.z*a.w),h-e+f-g)):"ZXY"===b?(this._x=Math.asin(d(2*(a.x*a.w+a.y*a.z))),this._y=Math.atan2(2*(a.y*a.w-a.z*a.x),h-e-f+g),this._z=Math.atan2(2*(a.z*a.w-a.x*a.y),h-e+f-g)):"ZYX"===b?(this._x=Math.atan2(2*(a.x*a.w+a.z*a.y),h-e-f+g),this._y=Math.asin(d(2*(a.y*a.w-a.x*a.z))),this._z=Math.atan2(2*(a.x*a.y+a.z*a.w),h+e-f-g)):"YZX"===b?(this._x=Math.atan2(2*(a.x*a.w-a.z*a.y),h-e+f-g),this._y=Math.atan2(2*(a.y*a.w-a.x*a.z),h+e-f-g),this._z=Math.asin(d(2*(a.x*a.y+a.z*a.w)))):"XZY"===b?(this._x=Math.atan2(2*(a.x*a.w+a.y*a.z),h-e+f-g),this._y=Math.atan2(2*(a.x*a.z+a.y*a.w),h+e-f-g),this._z=Math.asin(d(2*(a.z*a.w-a.x*a.y)))):console.warn("WARNING: Euler.setFromQuaternion() given unsupported order: "+b),this._order=b,!1!==c&&this._updateQuaternion(),this},reorder:function(){var a=new THREE.Quaternion;return function(b){a.setFromEuler(this),this.setFromQuaternion(a,b)}}(),fromArray:function(a){return this._x=a[0],this._y=a[1],this._z=a[2],void 0!==a[3]&&(this._order=a[3]),this._updateQuaternion(),this},toArray:function(){return[this._x,this._y,this._z,this._order]},equals:function(a){return a._x===this._x&&a._y===this._y&&a._z===this._z&&a._order===this._order},clone:function(){return new THREE.Euler(this._x,this._y,this._z,this._order)}},THREE.Line3=function(a,b){this.start=void 0!==a?a:new THREE.Vector3,this.end=void 0!==b?b:new THREE.Vector3},THREE.Line3.prototype={constructor:THREE.Line3,set:function(a,b){return this.start.copy(a),this.end.copy(b),this},copy:function(a){return this.start.copy(a.start),this.end.copy(a.end),this},center:function(a){return(a||new THREE.Vector3).addVectors(this.start,this.end).multiplyScalar(.5)},delta:function(a){return(a||new THREE.Vector3).subVectors(this.end,this.start)},distanceSq:function(){return this.start.distanceToSquared(this.end)},distance:function(){return this.start.distanceTo(this.end)},at:function(a,b){var c=b||new THREE.Vector3;return this.delta(c).multiplyScalar(a).add(this.start)},closestPointToPointParameter:function(){var a=new THREE.Vector3,b=new THREE.Vector3;return function(c,d){a.subVectors(c,this.start),b.subVectors(this.end,this.start);var e=b.dot(b),e=b.dot(a)/e;return d&&(e=THREE.Math.clamp(e,0,1)),e}}(),closestPointToPoint:function(a,b,c){return a=this.closestPointToPointParameter(a,b),c=c||new THREE.Vector3,this.delta(c).multiplyScalar(a).add(this.start)},applyMatrix4:function(a){return this.start.applyMatrix4(a),this.end.applyMatrix4(a),this},equals:function(a){return a.start.equals(this.start)&&a.end.equals(this.end)},clone:function(){return(new THREE.Line3).copy(this)}},THREE.Box2=function(a,b){this.min=void 0!==a?a:new THREE.Vector2(1/0,1/0),this.max=void 0!==b?b:new THREE.Vector2(-1/0,-1/0)},THREE.Box2.prototype={constructor:THREE.Box2,set:function(a,b){return this.min.copy(a),this.max.copy(b),this},setFromPoints:function(a){if(0<a.length){var b=a[0];this.min.copy(b),this.max.copy(b);for(var c=1,d=a.length;d>c;c++)b=a[c],b.x<this.min.x?this.min.x=b.x:b.x>this.max.x&&(this.max.x=b.x),b.y<this.min.y?this.min.y=b.y:b.y>this.max.y&&(this.max.y=b.y)}else this.makeEmpty();return this},setFromCenterAndSize:function(){var a=new THREE.Vector2;return function(b,c){var d=a.copy(c).multiplyScalar(.5);return this.min.copy(b).sub(d),this.max.copy(b).add(d),this}}(),copy:function(a){return this.min.copy(a.min),this.max.copy(a.max),this},makeEmpty:function(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this},empty:function(){return this.max.x<this.min.x||this.max.y<this.min.y},center:function(a){return(a||new THREE.Vector2).addVectors(this.min,this.max).multiplyScalar(.5)},size:function(a){return(a||new THREE.Vector2).subVectors(this.max,this.min)},expandByPoint:function(a){return this.min.min(a),this.max.max(a),this},expandByVector:function(a){return this.min.sub(a),this.max.add(a),this},expandByScalar:function(a){return this.min.addScalar(-a),this.max.addScalar(a),this},containsPoint:function(a){return a.x<this.min.x||a.x>this.max.x||a.y<this.min.y||a.y>this.max.y?!1:!0},containsBox:function(a){return this.min.x<=a.min.x&&a.max.x<=this.max.x&&this.min.y<=a.min.y&&a.max.y<=this.max.y?!0:!1},getParameter:function(a,b){return(b||new THREE.Vector2).set((a.x-this.min.x)/(this.max.x-this.min.x),(a.y-this.min.y)/(this.max.y-this.min.y))},isIntersectionBox:function(a){return a.max.x<this.min.x||a.min.x>this.max.x||a.max.y<this.min.y||a.min.y>this.max.y?!1:!0},clampPoint:function(a,b){return(b||new THREE.Vector2).copy(a).clamp(this.min,this.max)},distanceToPoint:function(){var a=new THREE.Vector2;return function(b){return a.copy(b).clamp(this.min,this.max).sub(b).length()}}(),intersect:function(a){return this.min.max(a.min),this.max.min(a.max),this},union:function(a){return this.min.min(a.min),this.max.max(a.max),this},translate:function(a){return this.min.add(a),this.max.add(a),this},equals:function(a){return a.min.equals(this.min)&&a.max.equals(this.max)},clone:function(){return(new THREE.Box2).copy(this)}},THREE.Box3=function(a,b){this.min=void 0!==a?a:new THREE.Vector3(1/0,1/0,1/0),this.max=void 0!==b?b:new THREE.Vector3(-1/0,-1/0,-1/0)},THREE.Box3.prototype={constructor:THREE.Box3,set:function(a,b){return this.min.copy(a),this.max.copy(b),this},addPoint:function(a){a.x<this.min.x?this.min.x=a.x:a.x>this.max.x&&(this.max.x=a.x),a.y<this.min.y?this.min.y=a.y:a.y>this.max.y&&(this.max.y=a.y),a.z<this.min.z?this.min.z=a.z:a.z>this.max.z&&(this.max.z=a.z)},setFromPoints:function(a){if(0<a.length){var b=a[0];this.min.copy(b),this.max.copy(b);for(var b=1,c=a.length;c>b;b++)this.addPoint(a[b])}else this.makeEmpty();return this},setFromCenterAndSize:function(){var a=new THREE.Vector3;return function(b,c){var d=a.copy(c).multiplyScalar(.5);return this.min.copy(b).sub(d),this.max.copy(b).add(d),this}}(),setFromObject:function(){var a=new THREE.Vector3;return function(b){var c=this;return b.updateMatrixWorld(!0),this.makeEmpty(),b.traverse(function(b){if(void 0!==b.geometry&&void 0!==b.geometry.vertices)for(var d=b.geometry.vertices,e=0,f=d.length;f>e;e++)a.copy(d[e]),a.applyMatrix4(b.matrixWorld),c.expandByPoint(a)}),this}}(),copy:function(a){return this.min.copy(a.min),this.max.copy(a.max),this},makeEmpty:function(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this},empty:function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},center:function(a){return(a||new THREE.Vector3).addVectors(this.min,this.max).multiplyScalar(.5)},size:function(a){return(a||new THREE.Vector3).subVectors(this.max,this.min)},expandByPoint:function(a){return this.min.min(a),this.max.max(a),this},expandByVector:function(a){return this.min.sub(a),this.max.add(a),this},expandByScalar:function(a){return this.min.addScalar(-a),this.max.addScalar(a),this},containsPoint:function(a){return a.x<this.min.x||a.x>this.max.x||a.y<this.min.y||a.y>this.max.y||a.z<this.min.z||a.z>this.max.z?!1:!0},containsBox:function(a){return this.min.x<=a.min.x&&a.max.x<=this.max.x&&this.min.y<=a.min.y&&a.max.y<=this.max.y&&this.min.z<=a.min.z&&a.max.z<=this.max.z?!0:!1},getParameter:function(a,b){return(b||new THREE.Vector3).set((a.x-this.min.x)/(this.max.x-this.min.x),(a.y-this.min.y)/(this.max.y-this.min.y),(a.z-this.min.z)/(this.max.z-this.min.z))},isIntersectionBox:function(a){return a.max.x<this.min.x||a.min.x>this.max.x||a.max.y<this.min.y||a.min.y>this.max.y||a.max.z<this.min.z||a.min.z>this.max.z?!1:!0},clampPoint:function(a,b){return(b||new THREE.Vector3).copy(a).clamp(this.min,this.max)},distanceToPoint:function(){var a=new THREE.Vector3;return function(b){return a.copy(b).clamp(this.min,this.max).sub(b).length()}}(),getBoundingSphere:function(){var a=new THREE.Vector3;return function(b){return b=b||new THREE.Sphere,b.center=this.center(),b.radius=.5*this.size(a).length(),b}}(),intersect:function(a){return this.min.max(a.min),this.max.min(a.max),this},union:function(a){return this.min.min(a.min),this.max.max(a.max),this},applyMatrix4:function(){var a=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];return function(b){return a[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(b),a[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(b),a[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(b),a[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(b),a[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(b),a[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(b),a[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(b),a[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(b),this.makeEmpty(),this.setFromPoints(a),this}}(),translate:function(a){return this.min.add(a),this.max.add(a),this},equals:function(a){return a.min.equals(this.min)&&a.max.equals(this.max)},clone:function(){return(new THREE.Box3).copy(this)}},THREE.Matrix3=function(a,b,c,d,e,f,g,h,i){this.elements=new Float32Array(9),this.set(void 0!==a?a:1,b||0,c||0,d||0,void 0!==e?e:1,f||0,g||0,h||0,void 0!==i?i:1)},THREE.Matrix3.prototype={constructor:THREE.Matrix3,set:function(a,b,c,d,e,f,g,h,i){var j=this.elements;return j[0]=a,j[3]=b,j[6]=c,j[1]=d,j[4]=e,j[7]=f,j[2]=g,j[5]=h,j[8]=i,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},copy:function(a){return a=a.elements,this.set(a[0],a[3],a[6],a[1],a[4],a[7],a[2],a[5],a[8]),this},multiplyVector3:function(a){return console.warn("DEPRECATED: Matrix3's .multiplyVector3() has been removed. Use vector.applyMatrix3( matrix ) instead."),a.applyMatrix3(this)},multiplyVector3Array:function(){var a=new THREE.Vector3;return function(b){for(var c=0,d=b.length;d>c;c+=3)a.x=b[c],a.y=b[c+1],a.z=b[c+2],a.applyMatrix3(this),b[c]=a.x,b[c+1]=a.y,b[c+2]=a.z;return b}}(),multiplyScalar:function(a){var b=this.elements;return b[0]*=a,b[3]*=a,b[6]*=a,b[1]*=a,b[4]*=a,b[7]*=a,b[2]*=a,b[5]*=a,b[8]*=a,this},determinant:function(){var a=this.elements,b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],a=a[8];return b*f*a-b*g*i-c*e*a+c*g*h+d*e*i-d*f*h},getInverse:function(a,b){var c=a.elements,d=this.elements;if(d[0]=c[10]*c[5]-c[6]*c[9],d[1]=-c[10]*c[1]+c[2]*c[9],d[2]=c[6]*c[1]-c[2]*c[5],d[3]=-c[10]*c[4]+c[6]*c[8],d[4]=c[10]*c[0]-c[2]*c[8],d[5]=-c[6]*c[0]+c[2]*c[4],d[6]=c[9]*c[4]-c[5]*c[8],d[7]=-c[9]*c[0]+c[1]*c[8],d[8]=c[5]*c[0]-c[1]*c[4],c=c[0]*d[0]+c[1]*d[3]+c[2]*d[6],0===c){if(b)throw Error("Matrix3.getInverse(): can't invert matrix, determinant is 0");return console.warn("Matrix3.getInverse(): can't invert matrix, determinant is 0"),this.identity(),this}return this.multiplyScalar(1/c),this},transpose:function(){var a,b=this.elements;return a=b[1],b[1]=b[3],b[3]=a,a=b[2],b[2]=b[6],b[6]=a,a=b[5],b[5]=b[7],b[7]=a,this},getNormalMatrix:function(a){return this.getInverse(a).transpose(),this},transposeIntoArray:function(a){var b=this.elements;return a[0]=b[0],a[1]=b[3],a[2]=b[6],a[3]=b[1],a[4]=b[4],a[5]=b[7],a[6]=b[2],a[7]=b[5],a[8]=b[8],this},fromArray:function(a){return this.elements.set(a),this},toArray:function(){var a=this.elements;return[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8]]},clone:function(){var a=this.elements;return new THREE.Matrix3(a[0],a[3],a[6],a[1],a[4],a[7],a[2],a[5],a[8])}},THREE.Matrix4=function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){var q=this.elements=new Float32Array(16);q[0]=void 0!==a?a:1,q[4]=b||0,q[8]=c||0,q[12]=d||0,q[1]=e||0,q[5]=void 0!==f?f:1,q[9]=g||0,q[13]=h||0,q[2]=i||0,q[6]=j||0,q[10]=void 0!==k?k:1,q[14]=l||0,q[3]=m||0,q[7]=n||0,q[11]=o||0,q[15]=void 0!==p?p:1},THREE.Matrix4.prototype={constructor:THREE.Matrix4,set:function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){var q=this.elements;return q[0]=a,q[4]=b,q[8]=c,q[12]=d,q[1]=e,q[5]=f,q[9]=g,q[13]=h,q[2]=i,q[6]=j,q[10]=k,q[14]=l,q[3]=m,q[7]=n,q[11]=o,q[15]=p,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},copy:function(a){return this.elements.set(a.elements),this},extractPosition:function(a){return console.warn("DEPRECATED: Matrix4's .extractPosition() has been renamed to .copyPosition()."),this.copyPosition(a)},copyPosition:function(a){var b=this.elements;return a=a.elements,b[12]=a[12],b[13]=a[13],b[14]=a[14],this},extractRotation:function(){var a=new THREE.Vector3;return function(b){var c=this.elements;b=b.elements;var d=1/a.set(b[0],b[1],b[2]).length(),e=1/a.set(b[4],b[5],b[6]).length(),f=1/a.set(b[8],b[9],b[10]).length();return c[0]=b[0]*d,c[1]=b[1]*d,c[2]=b[2]*d,c[4]=b[4]*e,c[5]=b[5]*e,c[6]=b[6]*e,c[8]=b[8]*f,c[9]=b[9]*f,c[10]=b[10]*f,this}}(),makeRotationFromEuler:function(a){0==a instanceof THREE.Euler&&console.error("ERROR: Matrix's .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.  Please update your code.");var b=this.elements,c=a.x,d=a.y,e=a.z,f=Math.cos(c),c=Math.sin(c),g=Math.cos(d),d=Math.sin(d),h=Math.cos(e),e=Math.sin(e);if("XYZ"===a.order){a=f*h;var i=f*e,j=c*h,k=c*e;b[0]=g*h,b[4]=-g*e,b[8]=d,b[1]=i+j*d,b[5]=a-k*d,b[9]=-c*g,b[2]=k-a*d,b[6]=j+i*d,b[10]=f*g}else"YXZ"===a.order?(a=g*h,i=g*e,j=d*h,k=d*e,b[0]=a+k*c,b[4]=j*c-i,b[8]=f*d,b[1]=f*e,b[5]=f*h,b[9]=-c,b[2]=i*c-j,b[6]=k+a*c,b[10]=f*g):"ZXY"===a.order?(a=g*h,i=g*e,j=d*h,k=d*e,b[0]=a-k*c,b[4]=-f*e,b[8]=j+i*c,b[1]=i+j*c,b[5]=f*h,b[9]=k-a*c,b[2]=-f*d,b[6]=c,b[10]=f*g):"ZYX"===a.order?(a=f*h,i=f*e,j=c*h,k=c*e,b[0]=g*h,b[4]=j*d-i,b[8]=a*d+k,b[1]=g*e,b[5]=k*d+a,b[9]=i*d-j,b[2]=-d,b[6]=c*g,b[10]=f*g):"YZX"===a.order?(a=f*g,i=f*d,j=c*g,k=c*d,b[0]=g*h,b[4]=k-a*e,b[8]=j*e+i,b[1]=e,b[5]=f*h,b[9]=-c*h,b[2]=-d*h,b[6]=i*e+j,b[10]=a-k*e):"XZY"===a.order&&(a=f*g,i=f*d,j=c*g,k=c*d,b[0]=g*h,b[4]=-e,b[8]=d*h,b[1]=a*e+k,b[5]=f*h,b[9]=i*e-j,b[2]=j*e-i,b[6]=c*h,b[10]=k*e+a);return b[3]=0,b[7]=0,b[11]=0,b[12]=0,b[13]=0,b[14]=0,b[15]=1,this},setRotationFromQuaternion:function(a){return console.warn("DEPRECATED: Matrix4's .setRotationFromQuaternion() has been deprecated in favor of makeRotationFromQuaternion.  Please update your code."),this.makeRotationFromQuaternion(a)},makeRotationFromQuaternion:function(a){var b=this.elements,c=a.x,d=a.y,e=a.z,f=a.w,g=c+c,h=d+d,i=e+e;a=c*g;var j=c*h,c=c*i,k=d*h,d=d*i,e=e*i,g=f*g,h=f*h,f=f*i;return b[0]=1-(k+e),b[4]=j-f,b[8]=c+h,b[1]=j+f,b[5]=1-(a+e),b[9]=d-g,b[2]=c-h,b[6]=d+g,b[10]=1-(a+k),b[3]=0,b[7]=0,b[11]=0,b[12]=0,b[13]=0,b[14]=0,b[15]=1,this},lookAt:function(){var a=new THREE.Vector3,b=new THREE.Vector3,c=new THREE.Vector3;return function(d,e,f){var g=this.elements;return c.subVectors(d,e).normalize(),0===c.length()&&(c.z=1),a.crossVectors(f,c).normalize(),0===a.length()&&(c.x+=1e-4,a.crossVectors(f,c).normalize()),b.crossVectors(c,a),g[0]=a.x,g[4]=b.x,g[8]=c.x,g[1]=a.y,g[5]=b.y,g[9]=c.y,g[2]=a.z,g[6]=b.z,g[10]=c.z,this}}(),multiply:function(a,b){return void 0!==b?(console.warn("DEPRECATED: Matrix4's .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(a,b)):this.multiplyMatrices(this,a)},multiplyMatrices:function(a,b){var c=a.elements,d=b.elements,e=this.elements,f=c[0],g=c[4],h=c[8],i=c[12],j=c[1],k=c[5],l=c[9],m=c[13],n=c[2],o=c[6],p=c[10],q=c[14],r=c[3],s=c[7],t=c[11],c=c[15],u=d[0],v=d[4],w=d[8],x=d[12],y=d[1],z=d[5],A=d[9],B=d[13],C=d[2],D=d[6],E=d[10],F=d[14],G=d[3],H=d[7],I=d[11],d=d[15];return e[0]=f*u+g*y+h*C+i*G,e[4]=f*v+g*z+h*D+i*H,e[8]=f*w+g*A+h*E+i*I,e[12]=f*x+g*B+h*F+i*d,e[1]=j*u+k*y+l*C+m*G,e[5]=j*v+k*z+l*D+m*H,e[9]=j*w+k*A+l*E+m*I,e[13]=j*x+k*B+l*F+m*d,e[2]=n*u+o*y+p*C+q*G,e[6]=n*v+o*z+p*D+q*H,e[10]=n*w+o*A+p*E+q*I,e[14]=n*x+o*B+p*F+q*d,e[3]=r*u+s*y+t*C+c*G,e[7]=r*v+s*z+t*D+c*H,e[11]=r*w+s*A+t*E+c*I,e[15]=r*x+s*B+t*F+c*d,this},multiplyToArray:function(a,b,c){var d=this.elements;return this.multiplyMatrices(a,b),c[0]=d[0],c[1]=d[1],c[2]=d[2],c[3]=d[3],c[4]=d[4],c[5]=d[5],c[6]=d[6],c[7]=d[7],c[8]=d[8],c[9]=d[9],c[10]=d[10],c[11]=d[11],c[12]=d[12],c[13]=d[13],c[14]=d[14],c[15]=d[15],this},multiplyScalar:function(a){var b=this.elements;return b[0]*=a,b[4]*=a,b[8]*=a,b[12]*=a,b[1]*=a,b[5]*=a,b[9]*=a,b[13]*=a,b[2]*=a,b[6]*=a,b[10]*=a,b[14]*=a,b[3]*=a,b[7]*=a,b[11]*=a,b[15]*=a,this},multiplyVector3:function(a){return console.warn("DEPRECATED: Matrix4's .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) or vector.applyProjection( matrix ) instead."),a.applyProjection(this)},multiplyVector4:function(a){return console.warn("DEPRECATED: Matrix4's .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead."),a.applyMatrix4(this)},multiplyVector3Array:function(){var a=new THREE.Vector3;return function(b){for(var c=0,d=b.length;d>c;c+=3)a.x=b[c],a.y=b[c+1],a.z=b[c+2],a.applyProjection(this),b[c]=a.x,b[c+1]=a.y,b[c+2]=a.z;return b}}(),rotateAxis:function(a){console.warn("DEPRECATED: Matrix4's .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead."),a.transformDirection(this)},crossVector:function(a){return console.warn("DEPRECATED: Matrix4's .crossVector() has been removed. Use vector.applyMatrix4( matrix ) instead."),a.applyMatrix4(this)},determinant:function(){var a=this.elements,b=a[0],c=a[4],d=a[8],e=a[12],f=a[1],g=a[5],h=a[9],i=a[13],j=a[2],k=a[6],l=a[10],m=a[14];return a[3]*(+e*h*k-d*i*k-e*g*l+c*i*l+d*g*m-c*h*m)+a[7]*(+b*h*m-b*i*l+e*f*l-d*f*m+d*i*j-e*h*j)+a[11]*(+b*i*k-b*g*m-e*f*k+c*f*m+e*g*j-c*i*j)+a[15]*(-d*g*j-b*h*k+b*g*l+d*f*k-c*f*l+c*h*j)},transpose:function(){var a,b=this.elements;return a=b[1],b[1]=b[4],b[4]=a,a=b[2],b[2]=b[8],b[8]=a,a=b[6],b[6]=b[9],b[9]=a,a=b[3],b[3]=b[12],b[12]=a,a=b[7],b[7]=b[13],b[13]=a,a=b[11],b[11]=b[14],b[14]=a,this},flattenToArray:function(a){var b=this.elements;return a[0]=b[0],a[1]=b[1],a[2]=b[2],a[3]=b[3],a[4]=b[4],a[5]=b[5],a[6]=b[6],a[7]=b[7],a[8]=b[8],a[9]=b[9],a[10]=b[10],a[11]=b[11],a[12]=b[12],a[13]=b[13],a[14]=b[14],a[15]=b[15],a},flattenToArrayOffset:function(a,b){var c=this.elements;return a[b]=c[0],a[b+1]=c[1],a[b+2]=c[2],a[b+3]=c[3],a[b+4]=c[4],a[b+5]=c[5],a[b+6]=c[6],a[b+7]=c[7],a[b+8]=c[8],a[b+9]=c[9],a[b+10]=c[10],a[b+11]=c[11],a[b+12]=c[12],a[b+13]=c[13],a[b+14]=c[14],a[b+15]=c[15],a},getPosition:function(){var a=new THREE.Vector3;return function(){console.warn("DEPRECATED: Matrix4's .getPosition() has been removed. Use Vector3.setFromMatrixPosition( matrix ) instead.");var b=this.elements;return a.set(b[12],b[13],b[14])}}(),setPosition:function(a){var b=this.elements;return b[12]=a.x,b[13]=a.y,b[14]=a.z,this},getInverse:function(a,b){var c=this.elements,d=a.elements,e=d[0],f=d[4],g=d[8],h=d[12],i=d[1],j=d[5],k=d[9],l=d[13],m=d[2],n=d[6],o=d[10],p=d[14],q=d[3],r=d[7],s=d[11],d=d[15];if(c[0]=k*p*r-l*o*r+l*n*s-j*p*s-k*n*d+j*o*d,c[4]=h*o*r-g*p*r-h*n*s+f*p*s+g*n*d-f*o*d,c[8]=g*l*r-h*k*r+h*j*s-f*l*s-g*j*d+f*k*d,c[12]=h*k*n-g*l*n-h*j*o+f*l*o+g*j*p-f*k*p,c[1]=l*o*q-k*p*q-l*m*s+i*p*s+k*m*d-i*o*d,c[5]=g*p*q-h*o*q+h*m*s-e*p*s-g*m*d+e*o*d,c[9]=h*k*q-g*l*q-h*i*s+e*l*s+g*i*d-e*k*d,c[13]=g*l*m-h*k*m+h*i*o-e*l*o-g*i*p+e*k*p,c[2]=j*p*q-l*n*q+l*m*r-i*p*r-j*m*d+i*n*d,c[6]=h*n*q-f*p*q-h*m*r+e*p*r+f*m*d-e*n*d,c[10]=f*l*q-h*j*q+h*i*r-e*l*r-f*i*d+e*j*d,c[14]=h*j*m-f*l*m-h*i*n+e*l*n+f*i*p-e*j*p,c[3]=k*n*q-j*o*q-k*m*r+i*o*r+j*m*s-i*n*s,c[7]=f*o*q-g*n*q+g*m*r-e*o*r-f*m*s+e*n*s,c[11]=g*j*q-f*k*q-g*i*r+e*k*r+f*i*s-e*j*s,c[15]=f*k*m-g*j*m+g*i*n-e*k*n-f*i*o+e*j*o,c=e*c[0]+i*c[4]+m*c[8]+q*c[12],0==c){if(b)throw Error("Matrix4.getInverse(): can't invert matrix, determinant is 0");return console.warn("Matrix4.getInverse(): can't invert matrix, determinant is 0"),this.identity(),this}return this.multiplyScalar(1/c),this},translate:function(){console.warn("DEPRECATED: Matrix4's .translate() has been removed.")},rotateX:function(){console.warn("DEPRECATED: Matrix4's .rotateX() has been removed.")},rotateY:function(){console.warn("DEPRECATED: Matrix4's .rotateY() has been removed.")},rotateZ:function(){console.warn("DEPRECATED: Matrix4's .rotateZ() has been removed.")},rotateByAxis:function(){console.warn("DEPRECATED: Matrix4's .rotateByAxis() has been removed.")},scale:function(a){var b=this.elements,c=a.x,d=a.y;return a=a.z,b[0]*=c,b[4]*=d,b[8]*=a,b[1]*=c,b[5]*=d,b[9]*=a,b[2]*=c,b[6]*=d,b[10]*=a,b[3]*=c,b[7]*=d,b[11]*=a,this},getMaxScaleOnAxis:function(){var a=this.elements;return Math.sqrt(Math.max(a[0]*a[0]+a[1]*a[1]+a[2]*a[2],Math.max(a[4]*a[4]+a[5]*a[5]+a[6]*a[6],a[8]*a[8]+a[9]*a[9]+a[10]*a[10])))},makeTranslation:function(a,b,c){return this.set(1,0,0,a,0,1,0,b,0,0,1,c,0,0,0,1),this},makeRotationX:function(a){var b=Math.cos(a);return a=Math.sin(a),this.set(1,0,0,0,0,b,-a,0,0,a,b,0,0,0,0,1),this},makeRotationY:function(a){var b=Math.cos(a);return a=Math.sin(a),this.set(b,0,a,0,0,1,0,0,-a,0,b,0,0,0,0,1),this},makeRotationZ:function(a){var b=Math.cos(a);return a=Math.sin(a),this.set(b,-a,0,0,a,b,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(a,b){var c=Math.cos(b),d=Math.sin(b),e=1-c,f=a.x,g=a.y,h=a.z,i=e*f,j=e*g;return this.set(i*f+c,i*g-d*h,i*h+d*g,0,i*g+d*h,j*g+c,j*h-d*f,0,i*h-d*g,j*h+d*f,e*h*h+c,0,0,0,0,1),this},makeScale:function(a,b,c){return this.set(a,0,0,0,0,b,0,0,0,0,c,0,0,0,0,1),this},compose:function(a,b,c){return this.makeRotationFromQuaternion(b),this.scale(c),this.setPosition(a),this},decompose:function(){var a=new THREE.Vector3,b=new THREE.Matrix4;return function(c,d,e){var f=this.elements,g=a.set(f[0],f[1],f[2]).length(),h=a.set(f[4],f[5],f[6]).length(),i=a.set(f[8],f[9],f[10]).length();0>this.determinant()&&(g=-g),c.x=f[12],c.y=f[13],c.z=f[14],b.elements.set(this.elements),c=1/g;var f=1/h,j=1/i;return b.elements[0]*=c,b.elements[1]*=c,b.elements[2]*=c,b.elements[4]*=f,b.elements[5]*=f,b.elements[6]*=f,b.elements[8]*=j,b.elements[9]*=j,b.elements[10]*=j,d.setFromRotationMatrix(b),e.x=g,e.y=h,e.z=i,this}}(),makeFrustum:function(a,b,c,d,e,f){var g=this.elements;return g[0]=2*e/(b-a),g[4]=0,g[8]=(b+a)/(b-a),g[12]=0,g[1]=0,g[5]=2*e/(d-c),g[9]=(d+c)/(d-c),g[13]=0,g[2]=0,g[6]=0,g[10]=-(f+e)/(f-e),g[14]=-2*f*e/(f-e),g[3]=0,g[7]=0,g[11]=-1,g[15]=0,this},makePerspective:function(a,b,c,d){a=c*Math.tan(THREE.Math.degToRad(.5*a));var e=-a;return this.makeFrustum(e*b,a*b,e,a,c,d)},makeOrthographic:function(a,b,c,d,e,f){var g=this.elements,h=b-a,i=c-d,j=f-e;return g[0]=2/h,g[4]=0,g[8]=0,g[12]=-((b+a)/h),g[1]=0,g[5]=2/i,g[9]=0,g[13]=-((c+d)/i),g[2]=0,g[6]=0,g[10]=-2/j,g[14]=-((f+e)/j),g[3]=0,g[7]=0,g[11]=0,g[15]=1,this},fromArray:function(a){return this.elements.set(a),this},toArray:function(){var a=this.elements;return[a[0],a[1],a[2],a[3],a[4],a[5],a[6],a[7],a[8],a[9],a[10],a[11],a[12],a[13],a[14],a[15]]
},clone:function(){var a=this.elements;return new THREE.Matrix4(a[0],a[4],a[8],a[12],a[1],a[5],a[9],a[13],a[2],a[6],a[10],a[14],a[3],a[7],a[11],a[15])}},THREE.Ray=function(a,b){this.origin=void 0!==a?a:new THREE.Vector3,this.direction=void 0!==b?b:new THREE.Vector3},THREE.Ray.prototype={constructor:THREE.Ray,set:function(a,b){return this.origin.copy(a),this.direction.copy(b),this},copy:function(a){return this.origin.copy(a.origin),this.direction.copy(a.direction),this},at:function(a,b){return(b||new THREE.Vector3).copy(this.direction).multiplyScalar(a).add(this.origin)},recast:function(){var a=new THREE.Vector3;return function(b){return this.origin.copy(this.at(b,a)),this}}(),closestPointToPoint:function(a,b){var c=b||new THREE.Vector3;c.subVectors(a,this.origin);var d=c.dot(this.direction);return 0>d?c.copy(this.origin):c.copy(this.direction).multiplyScalar(d).add(this.origin)},distanceToPoint:function(){var a=new THREE.Vector3;return function(b){var c=a.subVectors(b,this.origin).dot(this.direction);return 0>c?this.origin.distanceTo(b):(a.copy(this.direction).multiplyScalar(c).add(this.origin),a.distanceTo(b))}}(),distanceSqToSegment:function(a,b,c,d){var e=a.clone().add(b).multiplyScalar(.5),f=b.clone().sub(a).normalize(),g=.5*a.distanceTo(b),h=this.origin.clone().sub(e);a=-this.direction.dot(f),b=h.dot(this.direction);var i,j,k=-h.dot(f),l=h.lengthSq(),m=Math.abs(1-a*a);return m>=0?(h=a*k-b,i=a*b-k,j=g*m,h>=0?i>=-j?j>=i?(g=1/m,h*=g,i*=g,a=h*(h+a*i+2*b)+i*(a*h+i+2*k)+l):(i=g,h=Math.max(0,-(a*i+b)),a=-h*h+i*(i+2*k)+l):(i=-g,h=Math.max(0,-(a*i+b)),a=-h*h+i*(i+2*k)+l):-j>=i?(h=Math.max(0,-(-a*g+b)),i=h>0?-g:Math.min(Math.max(-g,-k),g),a=-h*h+i*(i+2*k)+l):j>=i?(h=0,i=Math.min(Math.max(-g,-k),g),a=i*(i+2*k)+l):(h=Math.max(0,-(a*g+b)),i=h>0?g:Math.min(Math.max(-g,-k),g),a=-h*h+i*(i+2*k)+l)):(i=a>0?-g:g,h=Math.max(0,-(a*i+b)),a=-h*h+i*(i+2*k)+l),c&&c.copy(this.direction.clone().multiplyScalar(h).add(this.origin)),d&&d.copy(f.clone().multiplyScalar(i).add(e)),a},isIntersectionSphere:function(a){return this.distanceToPoint(a.center)<=a.radius},isIntersectionPlane:function(a){var b=a.distanceToPoint(this.origin);return 0===b||0>a.normal.dot(this.direction)*b?!0:!1},distanceToPlane:function(a){var b=a.normal.dot(this.direction);return 0==b?0==a.distanceToPoint(this.origin)?0:null:(a=-(this.origin.dot(a.normal)+a.constant)/b,a>=0?a:null)},intersectPlane:function(a,b){var c=this.distanceToPlane(a);return null===c?null:this.at(c,b)},isIntersectionBox:function(){var a=new THREE.Vector3;return function(b){return null!==this.intersectBox(b,a)}}(),intersectBox:function(a,b){var c,d,e,f,g;d=1/this.direction.x,f=1/this.direction.y,g=1/this.direction.z;var h=this.origin;return d>=0?(c=(a.min.x-h.x)*d,d*=a.max.x-h.x):(c=(a.max.x-h.x)*d,d*=a.min.x-h.x),f>=0?(e=(a.min.y-h.y)*f,f*=a.max.y-h.y):(e=(a.max.y-h.y)*f,f*=a.min.y-h.y),c>f||e>d?null:((e>c||c!==c)&&(c=e),(d>f||d!==d)&&(d=f),g>=0?(e=(a.min.z-h.z)*g,g*=a.max.z-h.z):(e=(a.max.z-h.z)*g,g*=a.min.z-h.z),c>g||e>d?null:((e>c||c!==c)&&(c=e),(d>g||d!==d)&&(d=g),0>d?null:this.at(c>=0?c:d,b)))},intersectTriangle:function(){var a=new THREE.Vector3,b=new THREE.Vector3,c=new THREE.Vector3,d=new THREE.Vector3;return function(e,f,g,h,i){if(b.subVectors(f,e),c.subVectors(g,e),d.crossVectors(b,c),f=this.direction.dot(d),f>0){if(h)return null;h=1}else{if(!(0>f))return null;h=-1,f=-f}return a.subVectors(this.origin,e),e=h*this.direction.dot(c.crossVectors(a,c)),0>e?null:(g=h*this.direction.dot(b.cross(a)),0>g||e+g>f?null:(e=-h*a.dot(d),0>e?null:this.at(e/f,i)))}}(),applyMatrix4:function(a){return this.direction.add(this.origin).applyMatrix4(a),this.origin.applyMatrix4(a),this.direction.sub(this.origin),this.direction.normalize(),this},equals:function(a){return a.origin.equals(this.origin)&&a.direction.equals(this.direction)},clone:function(){return(new THREE.Ray).copy(this)}},THREE.Sphere=function(a,b){this.center=void 0!==a?a:new THREE.Vector3,this.radius=void 0!==b?b:0},THREE.Sphere.prototype={constructor:THREE.Sphere,set:function(a,b){return this.center.copy(a),this.radius=b,this},setFromPoints:function(){var a=new THREE.Box3;return function(b,c){var d=this.center;void 0!==c?d.copy(c):a.setFromPoints(b).center(d);for(var e=0,f=0,g=b.length;g>f;f++)e=Math.max(e,d.distanceToSquared(b[f]));return this.radius=Math.sqrt(e),this}}(),copy:function(a){return this.center.copy(a.center),this.radius=a.radius,this},empty:function(){return 0>=this.radius},containsPoint:function(a){return a.distanceToSquared(this.center)<=this.radius*this.radius},distanceToPoint:function(a){return a.distanceTo(this.center)-this.radius},intersectsSphere:function(a){var b=this.radius+a.radius;return a.center.distanceToSquared(this.center)<=b*b},clampPoint:function(a,b){var c=this.center.distanceToSquared(a),d=b||new THREE.Vector3;return d.copy(a),c>this.radius*this.radius&&(d.sub(this.center).normalize(),d.multiplyScalar(this.radius).add(this.center)),d},getBoundingBox:function(a){return a=a||new THREE.Box3,a.set(this.center,this.center),a.expandByScalar(this.radius),a},applyMatrix4:function(a){return this.center.applyMatrix4(a),this.radius*=a.getMaxScaleOnAxis(),this},translate:function(a){return this.center.add(a),this},equals:function(a){return a.center.equals(this.center)&&a.radius===this.radius},clone:function(){return(new THREE.Sphere).copy(this)}},THREE.Frustum=function(a,b,c,d,e,f){this.planes=[void 0!==a?a:new THREE.Plane,void 0!==b?b:new THREE.Plane,void 0!==c?c:new THREE.Plane,void 0!==d?d:new THREE.Plane,void 0!==e?e:new THREE.Plane,void 0!==f?f:new THREE.Plane]},THREE.Frustum.prototype={constructor:THREE.Frustum,set:function(a,b,c,d,e,f){var g=this.planes;return g[0].copy(a),g[1].copy(b),g[2].copy(c),g[3].copy(d),g[4].copy(e),g[5].copy(f),this},copy:function(a){for(var b=this.planes,c=0;6>c;c++)b[c].copy(a.planes[c]);return this},setFromMatrix:function(a){var b=this.planes,c=a.elements;a=c[0];var d=c[1],e=c[2],f=c[3],g=c[4],h=c[5],i=c[6],j=c[7],k=c[8],l=c[9],m=c[10],n=c[11],o=c[12],p=c[13],q=c[14],c=c[15];return b[0].setComponents(f-a,j-g,n-k,c-o).normalize(),b[1].setComponents(f+a,j+g,n+k,c+o).normalize(),b[2].setComponents(f+d,j+h,n+l,c+p).normalize(),b[3].setComponents(f-d,j-h,n-l,c-p).normalize(),b[4].setComponents(f-e,j-i,n-m,c-q).normalize(),b[5].setComponents(f+e,j+i,n+m,c+q).normalize(),this},intersectsObject:function(){var a=new THREE.Sphere;return function(b){var c=b.geometry;return null===c.boundingSphere&&c.computeBoundingSphere(),a.copy(c.boundingSphere),a.applyMatrix4(b.matrixWorld),this.intersectsSphere(a)}}(),intersectsSphere:function(a){var b=this.planes,c=a.center;a=-a.radius;for(var d=0;6>d;d++)if(b[d].distanceToPoint(c)<a)return!1;return!0},intersectsBox:function(){var a=new THREE.Vector3,b=new THREE.Vector3;return function(c){for(var d=this.planes,e=0;6>e;e++){var f=d[e];a.x=0<f.normal.x?c.min.x:c.max.x,b.x=0<f.normal.x?c.max.x:c.min.x,a.y=0<f.normal.y?c.min.y:c.max.y,b.y=0<f.normal.y?c.max.y:c.min.y,a.z=0<f.normal.z?c.min.z:c.max.z,b.z=0<f.normal.z?c.max.z:c.min.z;var g=f.distanceToPoint(a),f=f.distanceToPoint(b);if(0>g&&0>f)return!1}return!0}}(),containsPoint:function(a){for(var b=this.planes,c=0;6>c;c++)if(0>b[c].distanceToPoint(a))return!1;return!0},clone:function(){return(new THREE.Frustum).copy(this)}},THREE.Plane=function(a,b){this.normal=void 0!==a?a:new THREE.Vector3(1,0,0),this.constant=void 0!==b?b:0},THREE.Plane.prototype={constructor:THREE.Plane,set:function(a,b){return this.normal.copy(a),this.constant=b,this},setComponents:function(a,b,c,d){return this.normal.set(a,b,c),this.constant=d,this},setFromNormalAndCoplanarPoint:function(a,b){return this.normal.copy(a),this.constant=-b.dot(this.normal),this},setFromCoplanarPoints:function(){var a=new THREE.Vector3,b=new THREE.Vector3;return function(c,d,e){return d=a.subVectors(e,d).cross(b.subVectors(c,d)).normalize(),this.setFromNormalAndCoplanarPoint(d,c),this}}(),copy:function(a){return this.normal.copy(a.normal),this.constant=a.constant,this},normalize:function(){var a=1/this.normal.length();return this.normal.multiplyScalar(a),this.constant*=a,this},negate:function(){return this.constant*=-1,this.normal.negate(),this},distanceToPoint:function(a){return this.normal.dot(a)+this.constant},distanceToSphere:function(a){return this.distanceToPoint(a.center)-a.radius},projectPoint:function(a,b){return this.orthoPoint(a,b).sub(a).negate()},orthoPoint:function(a,b){var c=this.distanceToPoint(a);return(b||new THREE.Vector3).copy(this.normal).multiplyScalar(c)},isIntersectionLine:function(a){var b=this.distanceToPoint(a.start);return a=this.distanceToPoint(a.end),0>b&&a>0||0>a&&b>0},intersectLine:function(){var a=new THREE.Vector3;return function(b,c){var d=c||new THREE.Vector3,e=b.delta(a),f=this.normal.dot(e);return 0!=f?(f=-(b.start.dot(this.normal)+this.constant)/f,0>f||f>1?void 0:d.copy(e).multiplyScalar(f).add(b.start)):0==this.distanceToPoint(b.start)?d.copy(b.start):void 0}}(),coplanarPoint:function(a){return(a||new THREE.Vector3).copy(this.normal).multiplyScalar(-this.constant)},applyMatrix4:function(){var a=new THREE.Vector3,b=new THREE.Vector3,c=new THREE.Matrix3;return function(d,e){var f=e||c.getNormalMatrix(d),f=a.copy(this.normal).applyMatrix3(f),g=this.coplanarPoint(b);return g.applyMatrix4(d),this.setFromNormalAndCoplanarPoint(f,g),this}}(),translate:function(a){return this.constant-=a.dot(this.normal),this},equals:function(a){return a.normal.equals(this.normal)&&a.constant==this.constant},clone:function(){return(new THREE.Plane).copy(this)}},THREE.Math={PI2:2*Math.PI,generateUUID:function(){var a,b="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),c=Array(36),d=0;return function(){for(var e=0;36>e;e++)8==e||13==e||18==e||23==e?c[e]="-":14==e?c[e]="4":(2>=d&&(d=33554432+16777216*Math.random()|0),a=15&d,d>>=4,c[e]=b[19==e?3&a|8:a]);return c.join("")}}(),clamp:function(a,b,c){return b>a?b:a>c?c:a},clampBottom:function(a,b){return b>a?b:a},mapLinear:function(a,b,c,d,e){return d+(a-b)*(e-d)/(c-b)},smoothstep:function(a,b,c){return b>=a?0:a>=c?1:(a=(a-b)/(c-b),a*a*(3-2*a))},smootherstep:function(a,b,c){return b>=a?0:a>=c?1:(a=(a-b)/(c-b),a*a*a*(a*(6*a-15)+10))},random16:function(){return(65280*Math.random()+255*Math.random())/65535},randInt:function(a,b){return a+Math.floor(Math.random()*(b-a+1))},randFloat:function(a,b){return a+Math.random()*(b-a)},randFloatSpread:function(a){return a*(.5-Math.random())},sign:function(a){return 0>a?-1:a>0?1:0},degToRad:function(){var a=Math.PI/180;return function(b){return b*a}}(),radToDeg:function(){var a=180/Math.PI;return function(b){return b*a}}(),isPowerOfTwo:function(a){return 0===(a&a-1)&&0!==a}},THREE.Spline=function(a){function b(a,b,c,d,e,f,g){return a=.5*(c-a),d=.5*(d-b),(2*(b-c)+a+d)*g+(-3*(b-c)-2*a-d)*f+a*e+b}this.points=a;var c,d,e,f,g,h,i,j,k,l=[],m={x:0,y:0,z:0};this.initFromArray=function(a){this.points=[];for(var b=0;b<a.length;b++)this.points[b]={x:a[b][0],y:a[b][1],z:a[b][2]}},this.getPoint=function(a){return c=(this.points.length-1)*a,d=Math.floor(c),e=c-d,l[0]=0===d?d:d-1,l[1]=d,l[2]=d>this.points.length-2?this.points.length-1:d+1,l[3]=d>this.points.length-3?this.points.length-1:d+2,h=this.points[l[0]],i=this.points[l[1]],j=this.points[l[2]],k=this.points[l[3]],f=e*e,g=e*f,m.x=b(h.x,i.x,j.x,k.x,e,f,g),m.y=b(h.y,i.y,j.y,k.y,e,f,g),m.z=b(h.z,i.z,j.z,k.z,e,f,g),m},this.getControlPointsArray=function(){var a,b,c=this.points.length,d=[];for(a=0;c>a;a++)b=this.points[a],d[a]=[b.x,b.y,b.z];return d},this.getLength=function(a){var b,c,d,e=b=b=0,f=new THREE.Vector3,g=new THREE.Vector3,h=[],i=0;for(h[0]=0,a||(a=100),c=this.points.length*a,f.copy(this.points[0]),a=1;c>a;a++)b=a/c,d=this.getPoint(b),g.copy(d),i+=g.distanceTo(f),f.copy(d),b*=this.points.length-1,b=Math.floor(b),b!=e&&(h[b]=i,e=b);return h[h.length]=i,{chunks:h,total:i}},this.reparametrizeByArcLength=function(a){var b,c,d,e,f,g,h=[],i=new THREE.Vector3,j=this.getLength();for(h.push(i.copy(this.points[0]).clone()),b=1;b<this.points.length;b++){for(c=j.chunks[b]-j.chunks[b-1],g=Math.ceil(a*c/j.total),e=(b-1)/(this.points.length-1),f=b/(this.points.length-1),c=1;g-1>c;c++)d=e+1/g*c*(f-e),d=this.getPoint(d),h.push(i.copy(d).clone());h.push(i.copy(this.points[b]).clone())}this.points=h}},THREE.Triangle=function(a,b,c){this.a=void 0!==a?a:new THREE.Vector3,this.b=void 0!==b?b:new THREE.Vector3,this.c=void 0!==c?c:new THREE.Vector3},THREE.Triangle.normal=function(){var a=new THREE.Vector3;return function(b,c,d,e){return e=e||new THREE.Vector3,e.subVectors(d,c),a.subVectors(b,c),e.cross(a),b=e.lengthSq(),b>0?e.multiplyScalar(1/Math.sqrt(b)):e.set(0,0,0)}}(),THREE.Triangle.barycoordFromPoint=function(){var a=new THREE.Vector3,b=new THREE.Vector3,c=new THREE.Vector3;return function(d,e,f,g,h){a.subVectors(g,e),b.subVectors(f,e),c.subVectors(d,e),d=a.dot(a),e=a.dot(b),f=a.dot(c);var i=b.dot(b);g=b.dot(c);var j=d*i-e*e;return h=h||new THREE.Vector3,0==j?h.set(-2,-1,-1):(j=1/j,i=(i*f-e*g)*j,d=(d*g-e*f)*j,h.set(1-i-d,d,i))}}(),THREE.Triangle.containsPoint=function(){var a=new THREE.Vector3;return function(b,c,d,e){return b=THREE.Triangle.barycoordFromPoint(b,c,d,e,a),0<=b.x&&0<=b.y&&1>=b.x+b.y}}(),THREE.Triangle.prototype={constructor:THREE.Triangle,set:function(a,b,c){return this.a.copy(a),this.b.copy(b),this.c.copy(c),this},setFromPointsAndIndices:function(a,b,c,d){return this.a.copy(a[b]),this.b.copy(a[c]),this.c.copy(a[d]),this},copy:function(a){return this.a.copy(a.a),this.b.copy(a.b),this.c.copy(a.c),this},area:function(){var a=new THREE.Vector3,b=new THREE.Vector3;return function(){return a.subVectors(this.c,this.b),b.subVectors(this.a,this.b),.5*a.cross(b).length()}}(),midpoint:function(a){return(a||new THREE.Vector3).addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)},normal:function(a){return THREE.Triangle.normal(this.a,this.b,this.c,a)},plane:function(a){return(a||new THREE.Plane).setFromCoplanarPoints(this.a,this.b,this.c)},barycoordFromPoint:function(a,b){return THREE.Triangle.barycoordFromPoint(a,this.a,this.b,this.c,b)},containsPoint:function(a){return THREE.Triangle.containsPoint(a,this.a,this.b,this.c)},equals:function(a){return a.a.equals(this.a)&&a.b.equals(this.b)&&a.c.equals(this.c)},clone:function(){return(new THREE.Triangle).copy(this)}},THREE.Vertex=function(a){return console.warn("THREE.Vertex has been DEPRECATED. Use THREE.Vector3 instead."),a},THREE.UV=function(a,b){return console.warn("THREE.UV has been DEPRECATED. Use THREE.Vector2 instead."),new THREE.Vector2(a,b)},THREE.Clock=function(a){this.autoStart=void 0!==a?a:!0,this.elapsedTime=this.oldTime=this.startTime=0,this.running=!1},THREE.Clock.prototype={constructor:THREE.Clock,start:function(){this.oldTime=this.startTime=void 0!==self.performance&&void 0!==self.performance.now?self.performance.now():Date.now(),this.running=!0},stop:function(){this.getElapsedTime(),this.running=!1},getElapsedTime:function(){return this.getDelta(),this.elapsedTime},getDelta:function(){var a=0;if(this.autoStart&&!this.running&&this.start(),this.running){var b=void 0!==self.performance&&void 0!==self.performance.now?self.performance.now():Date.now(),a=.001*(b-this.oldTime);this.oldTime=b,this.elapsedTime+=a}return a}},THREE.EventDispatcher=function(){},THREE.EventDispatcher.prototype={constructor:THREE.EventDispatcher,apply:function(a){a.addEventListener=THREE.EventDispatcher.prototype.addEventListener,a.hasEventListener=THREE.EventDispatcher.prototype.hasEventListener,a.removeEventListener=THREE.EventDispatcher.prototype.removeEventListener,a.dispatchEvent=THREE.EventDispatcher.prototype.dispatchEvent},addEventListener:function(a,b){void 0===this._listeners&&(this._listeners={});var c=this._listeners;void 0===c[a]&&(c[a]=[]),-1===c[a].indexOf(b)&&c[a].push(b)},hasEventListener:function(a,b){if(void 0===this._listeners)return!1;var c=this._listeners;return void 0!==c[a]&&-1!==c[a].indexOf(b)?!0:!1},removeEventListener:function(a,b){if(void 0!==this._listeners){var c=this._listeners[a];if(void 0!==c){var d=c.indexOf(b);-1!==d&&c.splice(d,1)}}},dispatchEvent:function(){var a=[];return function(b){if(void 0!==this._listeners){var c=this._listeners[b.type];if(void 0!==c){b.target=this;for(var d=c.length,e=0;d>e;e++)a[e]=c[e];for(e=0;d>e;e++)a[e].call(this,b)}}}}()},function(a){a.Raycaster=function(b,c,d,e){this.ray=new a.Ray(b,c),this.near=d||0,this.far=e||1/0};var b=new a.Sphere,c=new a.Ray;new a.Plane,new a.Vector3;var d=new a.Vector3,e=new a.Matrix4,f=function(a,b){return a.distance-b.distance},g=new a.Vector3,h=new a.Vector3,i=new a.Vector3,j=function(f,k,l){if(f instanceof a.Sprite){d.setFromMatrixPosition(f.matrixWorld);var m=k.ray.distanceToPoint(d);if(m>f.scale.x)return l;l.push({distance:m,point:f.position,face:null,object:f})}else if(f instanceof a.LOD)d.setFromMatrixPosition(f.matrixWorld),m=k.ray.origin.distanceTo(d),j(f.getObjectForDistance(m),k,l);else if(f instanceof a.Mesh){var n=f.geometry;if(null===n.boundingSphere&&n.computeBoundingSphere(),b.copy(n.boundingSphere),b.applyMatrix4(f.matrixWorld),!1===k.ray.isIntersectionSphere(b))return l;if(e.getInverse(f.matrixWorld),c.copy(k.ray).applyMatrix4(e),null!==n.boundingBox&&!1===c.isIntersectionBox(n.boundingBox))return l;if(n instanceof a.BufferGeometry){var o=f.material;if(void 0===o)return l;var p,q,r=n.attributes,s=k.precision;if(void 0!==r.index)for(var t=n.offsets,u=r.index.array,v=r.position.array,w=0,x=t.length;x>w;++w)for(var r=t[w].start,y=t[w].index,n=r,z=r+t[w].count;z>n;n+=3){r=y+u[n],p=y+u[n+1],q=y+u[n+2],g.set(v[3*r],v[3*r+1],v[3*r+2]),h.set(v[3*p],v[3*p+1],v[3*p+2]),i.set(v[3*q],v[3*q+1],v[3*q+2]);var A=o.side===a.BackSide?c.intersectTriangle(i,h,g,!0):c.intersectTriangle(g,h,i,o.side!==a.DoubleSide);null!==A&&(A.applyMatrix4(f.matrixWorld),m=k.ray.origin.distanceTo(A),s>m||m<k.near||m>k.far||l.push({distance:m,point:A,indices:[r,p,q],face:null,faceIndex:null,object:f}))}else for(v=r.position.array,n=0,z=r.position.array.length;z>n;n+=3)r=n,p=n+1,q=n+2,g.set(v[3*r],v[3*r+1],v[3*r+2]),h.set(v[3*p],v[3*p+1],v[3*p+2]),i.set(v[3*q],v[3*q+1],v[3*q+2]),A=o.side===a.BackSide?c.intersectTriangle(i,h,g,!0):c.intersectTriangle(g,h,i,o.side!==a.DoubleSide),null!==A&&(A.applyMatrix4(f.matrixWorld),m=k.ray.origin.distanceTo(A),s>m||m<k.near||m>k.far||l.push({distance:m,point:A,indices:[r,p,q],face:null,faceIndex:null,object:f}))}else if(n instanceof a.Geometry)for(u=f.material instanceof a.MeshFaceMaterial,v=!0===u?f.material.materials:null,s=k.precision,t=n.vertices,w=0,x=n.faces.length;x>w;w++)if(y=n.faces[w],o=!0===u?v[y.materialIndex]:f.material,void 0!==o){if(r=t[y.a],p=t[y.b],q=t[y.c],!0===o.morphTargets){m=n.morphTargets,A=f.morphTargetInfluences,g.set(0,0,0),h.set(0,0,0),i.set(0,0,0);for(var z=0,B=m.length;B>z;z++){var C=A[z];if(0!==C){var D=m[z].vertices;g.x+=(D[y.a].x-r.x)*C,g.y+=(D[y.a].y-r.y)*C,g.z+=(D[y.a].z-r.z)*C,h.x+=(D[y.b].x-p.x)*C,h.y+=(D[y.b].y-p.y)*C,h.z+=(D[y.b].z-p.z)*C,i.x+=(D[y.c].x-q.x)*C,i.y+=(D[y.c].y-q.y)*C,i.z+=(D[y.c].z-q.z)*C}}g.add(r),h.add(p),i.add(q),r=g,p=h,q=i}A=o.side===a.BackSide?c.intersectTriangle(q,p,r,!0):c.intersectTriangle(r,p,q,o.side!==a.DoubleSide),null!==A&&(A.applyMatrix4(f.matrixWorld),m=k.ray.origin.distanceTo(A),s>m||m<k.near||m>k.far||l.push({distance:m,point:A,face:y,faceIndex:w,object:f}))}}else if(f instanceof a.Line){if(s=k.linePrecision,o=s*s,n=f.geometry,null===n.boundingSphere&&n.computeBoundingSphere(),b.copy(n.boundingSphere),b.applyMatrix4(f.matrixWorld),!1===k.ray.isIntersectionSphere(b))return l;if(e.getInverse(f.matrixWorld),c.copy(k.ray).applyMatrix4(e),n instanceof a.Geometry)for(t=n.vertices,s=t.length,r=new a.Vector3,p=new a.Vector3,q=f.type===a.LineStrip?1:2,n=0;s-1>n;n+=q)c.distanceSqToSegment(t[n],t[n+1],p,r)>o||(m=c.origin.distanceTo(p),m<k.near||m>k.far||l.push({distance:m,point:r.clone().applyMatrix4(f.matrixWorld),face:null,faceIndex:null,object:f}))}},k=function(a,b,c){a=a.getDescendants();for(var d=0,e=a.length;e>d;d++)j(a[d],b,c)};a.Raycaster.prototype.precision=1e-4,a.Raycaster.prototype.linePrecision=1,a.Raycaster.prototype.set=function(a,b){this.ray.set(a,b)},a.Raycaster.prototype.intersectObject=function(a,b){var c=[];return!0===b&&k(a,this,c),j(a,this,c),c.sort(f),c},a.Raycaster.prototype.intersectObjects=function(a,b){for(var c=[],d=0,e=a.length;e>d;d++)j(a[d],this,c),!0===b&&k(a[d],this,c);return c.sort(f),c}}(THREE),THREE.Object3D=function(){this.id=THREE.Object3DIdCount++,this.uuid=THREE.Math.generateUUID(),this.name="",this.parent=void 0,this.children=[],this.up=new THREE.Vector3(0,1,0),this.position=new THREE.Vector3,this._rotation=new THREE.Euler,this._quaternion=new THREE.Quaternion,this.scale=new THREE.Vector3(1,1,1),this._rotation._quaternion=this.quaternion,this._quaternion._euler=this.rotation,this.renderDepth=null,this.rotationAutoUpdate=!0,this.matrix=new THREE.Matrix4,this.matrixWorld=new THREE.Matrix4,this.visible=this.matrixWorldNeedsUpdate=this.matrixAutoUpdate=!0,this.receiveShadow=this.castShadow=!1,this.frustumCulled=!0,this.userData={}},THREE.Object3D.prototype={constructor:THREE.Object3D,get rotation(){return this._rotation},set rotation(a){this._rotation=a,this._rotation._quaternion=this._quaternion,this._quaternion._euler=this._rotation,this._rotation._updateQuaternion()},get quaternion(){return this._quaternion},set quaternion(a){this._quaternion=a,this._quaternion._euler=this._rotation,this._rotation._quaternion=this._quaternion,this._quaternion._updateEuler()},get eulerOrder(){return console.warn("DEPRECATED: Object3D's .eulerOrder has been moved to Object3D's .rotation.order."),this.rotation.order},set eulerOrder(a){console.warn("DEPRECATED: Object3D's .eulerOrder has been moved to Object3D's .rotation.order."),this.rotation.order=a},get useQuaternion(){console.warn("DEPRECATED: Object3D's .useQuaternion has been removed. The library now uses quaternions by default.")},set useQuaternion(a){console.warn("DEPRECATED: Object3D's .useQuaternion has been removed. The library now uses quaternions by default.")},applyMatrix:function(a){this.matrix.multiplyMatrices(a,this.matrix),this.matrix.decompose(this.position,this.quaternion,this.scale)},setRotationFromAxisAngle:function(a,b){this.quaternion.setFromAxisAngle(a,b)},setRotationFromEuler:function(a){this.quaternion.setFromEuler(a,!0)},setRotationFromMatrix:function(a){this.quaternion.setFromRotationMatrix(a)},setRotationFromQuaternion:function(a){this.quaternion.copy(a)},rotateOnAxis:function(){var a=new THREE.Quaternion;return function(b,c){return a.setFromAxisAngle(b,c),this.quaternion.multiply(a),this}}(),rotateX:function(){var a=new THREE.Vector3(1,0,0);return function(b){return this.rotateOnAxis(a,b)}}(),rotateY:function(){var a=new THREE.Vector3(0,1,0);return function(b){return this.rotateOnAxis(a,b)}}(),rotateZ:function(){var a=new THREE.Vector3(0,0,1);return function(b){return this.rotateOnAxis(a,b)}}(),translateOnAxis:function(){var a=new THREE.Vector3;return function(b,c){return a.copy(b),a.applyQuaternion(this.quaternion),this.position.add(a.multiplyScalar(c)),this}}(),translate:function(a,b){return console.warn("DEPRECATED: Object3D's .translate() has been removed. Use .translateOnAxis( axis, distance ) instead. Note args have been changed."),this.translateOnAxis(b,a)},translateX:function(){var a=new THREE.Vector3(1,0,0);return function(b){return this.translateOnAxis(a,b)}}(),translateY:function(){var a=new THREE.Vector3(0,1,0);return function(b){return this.translateOnAxis(a,b)}}(),translateZ:function(){var a=new THREE.Vector3(0,0,1);return function(b){return this.translateOnAxis(a,b)}}(),localToWorld:function(a){return a.applyMatrix4(this.matrixWorld)},worldToLocal:function(){var a=new THREE.Matrix4;return function(b){return b.applyMatrix4(a.getInverse(this.matrixWorld))}}(),lookAt:function(){var a=new THREE.Matrix4;return function(b){a.lookAt(b,this.position,this.up),this.quaternion.setFromRotationMatrix(a)}}(),add:function(a){if(a===this)console.warn("THREE.Object3D.add: An object can't be added as a child of itself.");else if(a instanceof THREE.Object3D){void 0!==a.parent&&a.parent.remove(a),a.parent=this,a.dispatchEvent({type:"added"}),this.children.push(a);for(var b=this;void 0!==b.parent;)b=b.parent;void 0!==b&&b instanceof THREE.Scene&&b.__addObject(a)}},remove:function(a){var b=this.children.indexOf(a);if(-1!==b){for(a.parent=void 0,a.dispatchEvent({type:"removed"}),this.children.splice(b,1),b=this;void 0!==b.parent;)b=b.parent;void 0!==b&&b instanceof THREE.Scene&&b.__removeObject(a)}},traverse:function(a){a(this);for(var b=0,c=this.children.length;c>b;b++)this.children[b].traverse(a)},getObjectById:function(a,b){for(var c=0,d=this.children.length;d>c;c++){var e=this.children[c];if(e.id===a||!0===b&&(e=e.getObjectById(a,b),void 0!==e))return e}},getObjectByName:function(a,b){for(var c=0,d=this.children.length;d>c;c++){var e=this.children[c];if(e.name===a||!0===b&&(e=e.getObjectByName(a,b),void 0!==e))return e}},getChildByName:function(a,b){return console.warn("DEPRECATED: Object3D's .getChildByName() has been renamed to .getObjectByName()."),this.getObjectByName(a,b)},getDescendants:function(a){void 0===a&&(a=[]),Array.prototype.push.apply(a,this.children);for(var b=0,c=this.children.length;c>b;b++)this.children[b].getDescendants(a);return a},updateMatrix:function(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(a){!0===this.matrixAutoUpdate&&this.updateMatrix(),(!0===this.matrixWorldNeedsUpdate||!0===a)&&(void 0===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,a=!0);for(var b=0,c=this.children.length;c>b;b++)this.children[b].updateMatrixWorld(a)},clone:function(a,b){if(void 0===a&&(a=new THREE.Object3D),void 0===b&&(b=!0),a.name=this.name,a.up.copy(this.up),a.position.copy(this.position),a.quaternion.copy(this.quaternion),a.scale.copy(this.scale),a.renderDepth=this.renderDepth,a.rotationAutoUpdate=this.rotationAutoUpdate,a.matrix.copy(this.matrix),a.matrixWorld.copy(this.matrixWorld),a.matrixAutoUpdate=this.matrixAutoUpdate,a.matrixWorldNeedsUpdate=this.matrixWorldNeedsUpdate,a.visible=this.visible,a.castShadow=this.castShadow,a.receiveShadow=this.receiveShadow,a.frustumCulled=this.frustumCulled,a.userData=JSON.parse(JSON.stringify(this.userData)),!0===b)for(var c=0;c<this.children.length;c++)a.add(this.children[c].clone());return a}},THREE.EventDispatcher.prototype.apply(THREE.Object3D.prototype),THREE.Object3DIdCount=0,THREE.Projector=function(){function a(){if(i===t){var a=new THREE.RenderableVertex;return s.push(a),t++,i++,a}return s[i++]}function b(){if(k===v){var a=new THREE.RenderableFace;return u.push(a),v++,k++,a}return u[k++]}function c(){if(m===x){var a=new THREE.RenderableLine;return w.push(a),x++,m++,a}return w[m++]}function d(a,b){return a.z!==b.z?b.z-a.z:a.id!==b.id?a.id-b.id:0}function e(a,b){var c=0,d=1,e=a.z+a.w,f=b.z+b.w,g=-a.z+a.w,h=-b.z+b.w;return e>=0&&f>=0&&g>=0&&h>=0?!0:0>e&&0>f||0>g&&0>h?!1:(0>e?c=Math.max(c,e/(e-f)):0>f&&(d=Math.min(d,e/(e-f))),0>g?c=Math.max(c,g/(g-h)):0>h&&(d=Math.min(d,g/(g-h))),c>d?!1:(a.lerp(b,c),b.lerp(a,1-d),!0))}var f,g,h,i,j,k,l,m,n,o,p,q=[],r=0,s=[],t=0,u=[],v=0,w=[],x=0,y=[],z=0,A={objects:[],lights:[],elements:[]},B=new THREE.Vector3,C=new THREE.Vector3,D=new THREE.Vector3,E=new THREE.Vector3,F=new THREE.Vector4,G=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),H=new THREE.Box3,I=Array(3),J=new THREE.Matrix4,K=new THREE.Matrix4,L=new THREE.Matrix4,M=new THREE.Matrix3,N=new THREE.Frustum,O=new THREE.Vector4,P=new THREE.Vector4;this.projectVector=function(a,b){return b.matrixWorldInverse.getInverse(b.matrixWorld),K.multiplyMatrices(b.projectionMatrix,b.matrixWorldInverse),a.applyProjection(K)},this.unprojectVector=function(){var a=new THREE.Matrix4;return function(b,c){return a.getInverse(c.projectionMatrix),K.multiplyMatrices(c.matrixWorld,a),b.applyProjection(K)}}(),this.pickingRay=function(a,b){a.z=-1;var c=new THREE.Vector3(a.x,a.y,1);return this.unprojectVector(a,b),this.unprojectVector(c,b),c.sub(a).normalize(),new THREE.Raycaster(a,c)};var Q=function(a){if(!1!==a.visible){if(a instanceof THREE.Light)A.lights.push(a);else if((a instanceof THREE.Mesh||a instanceof THREE.Line||a instanceof THREE.Sprite)&&(!1===a.frustumCulled||!0===N.intersectsObject(a))){if(g===r){var b=new THREE.RenderableObject;q.push(b),r++,g++,f=b}else f=q[g++];f.id=a.id,f.object=a,null!==a.renderDepth?f.z=a.renderDepth:(E.setFromMatrixPosition(a.matrixWorld),E.applyProjection(K),f.z=E.z),A.objects.push(f)}for(var b=0,c=a.children.length;c>b;b++)Q(a.children[b])}},R=new function(){var d=[],e=null,f=new THREE.Matrix3,g=function(a){var b=a.positionWorld,c=a.positionScreen;b.copy(a.position).applyMatrix4(p),c.copy(b).applyMatrix4(K),b=1/c.w,c.x*=b,c.y*=b,c.z*=b,a.visible=-1<=c.x&&1>=c.x&&-1<=c.y&&1>=c.y&&-1<=c.z&&1>=c.z},i=function(a,b,c){return I[0]=a.positionScreen,I[1]=b.positionScreen,I[2]=c.positionScreen,!0===a.visible||!0===b.visible||!0===c.visible||G.isIntersectionBox(H.setFromPoints(I))?0>(c.positionScreen.x-a.positionScreen.x)*(b.positionScreen.y-a.positionScreen.y)-(c.positionScreen.y-a.positionScreen.y)*(b.positionScreen.x-a.positionScreen.x):!1};return{setObject:function(a){e=a,f.getNormalMatrix(e.matrixWorld),d.length=0},projectVertex:g,checkTriangleVisibility:i,pushVertex:function(b,c,d){h=a(),h.position.set(b,c,d),g(h)},pushNormal:function(a,b,c){d.push(a,b,c)},pushLine:function(a,b){var d=s[a],f=s[b];l=c(),l.id=e.id,l.v1.copy(d),l.v2.copy(f),l.z=(d.positionScreen.z+f.positionScreen.z)/2,l.material=e.material,A.elements.push(l)},pushTriangle:function(a,c,g){var h=s[a],k=s[c],l=s[g];if(!0===i(h,k,l)){for(j=b(),j.id=e.id,j.v1.copy(h),j.v2.copy(k),j.v3.copy(l),j.z=(h.positionScreen.z+k.positionScreen.z+l.positionScreen.z)/3,h=0;3>h;h++)k=3*arguments[h],l=j.vertexNormalsModel[h],l.set(d[k+0],d[k+1],d[k+2]),l.applyMatrix3(f).normalize();j.vertexNormalsLength=3,j.material=e.material,A.elements.push(j)}}}};this.projectScene=function(f,h,q,r){var t,u,v,w,x,E,G,H,I;for(o=m=k=0,A.elements.length=0,!0===f.autoUpdate&&f.updateMatrixWorld(),void 0===h.parent&&h.updateMatrixWorld(),J.copy(h.matrixWorldInverse.getInverse(h.matrixWorld)),K.multiplyMatrices(h.projectionMatrix,J),N.setFromMatrix(K),g=0,A.objects.length=0,A.lights.length=0,Q(f),!0===q&&A.objects.sort(d),f=0,q=A.objects.length;q>f;f++)if(t=A.objects[f].object,u=t.geometry,R.setObject(t),p=t.matrixWorld,i=0,t instanceof THREE.Mesh){if(u instanceof THREE.BufferGeometry){if(E=u.attributes,w=u.offsets,void 0!==E.position){for(H=E.position.array,t=0,u=H.length;u>t;t+=3)R.pushVertex(H[t],H[t+1],H[t+2]);for(I=E.normal.array,t=0,u=I.length;u>t;t+=3)R.pushNormal(I[t],I[t+1],I[t+2]);if(void 0!==E.index)if(E=E.index.array,0<w.length)for(f=0;f<w.length;f++)for(u=w[f],H=u.index,t=u.start,u=u.start+u.count;u>t;t+=3)R.pushTriangle(E[t]+H,E[t+1]+H,E[t+2]+H);else for(t=0,u=E.length;u>t;t+=3)R.pushTriangle(E[t],E[t+1],E[t+2]);else for(t=0,u=H.length/3;u>t;t+=3)R.pushTriangle(t,t+1,t+2)}}else if(u instanceof THREE.Geometry2)for(v=u.vertices,w=t=0,u=v.length;u>t;t+=9,w+=3)R.pushVertex(v[t+0],v[t+1],v[t+2]),R.pushVertex(v[t+3],v[t+4],v[t+5]),R.pushVertex(v[t+6],v[t+7],v[t+8]),R.pushTriangle(w+0,w+1,w+2);else if(u instanceof THREE.Geometry){v=u.vertices,w=u.faces,E=u.faceVertexUvs,M.getNormalMatrix(p),H=t.material instanceof THREE.MeshFaceMaterial,I=!0===H?t.material:null;for(var S=0,T=v.length;T>S;S++){var U=v[S];R.pushVertex(U.x,U.y,U.z)}for(S=0,T=w.length;T>S;S++){v=w[S];var V=!0===H?I.materials[v.materialIndex]:t.material;if(void 0!==V){G=V.side;var U=s[v.a],W=s[v.b],X=s[v.c];if(!0===V.morphTargets){x=u.morphTargets;var Y=t.morphTargetInfluences,Z=U.position,$=W.position,_=X.position;B.set(0,0,0),C.set(0,0,0),D.set(0,0,0);for(var ab=0,bb=x.length;bb>ab;ab++){var cb=Y[ab];if(0!==cb){var db=x[ab].vertices;B.x+=(db[v.a].x-Z.x)*cb,B.y+=(db[v.a].y-Z.y)*cb,B.z+=(db[v.a].z-Z.z)*cb,C.x+=(db[v.b].x-$.x)*cb,C.y+=(db[v.b].y-$.y)*cb,C.z+=(db[v.b].z-$.z)*cb,D.x+=(db[v.c].x-_.x)*cb,D.y+=(db[v.c].y-_.y)*cb,D.z+=(db[v.c].z-_.z)*cb
}}U.position.add(B),W.position.add(C),X.position.add(D),R.projectVertex(U),R.projectVertex(W),R.projectVertex(X)}if(Y=R.checkTriangleVisibility(U,W,X),!(!1===Y&&G===THREE.FrontSide||!0===Y&&G===THREE.BackSide)){for(j=b(),j.id=t.id,j.v1.copy(U),j.v2.copy(W),j.v3.copy(X),j.normalModel.copy(v.normal),!1!==Y||G!==THREE.BackSide&&G!==THREE.DoubleSide||j.normalModel.negate(),j.normalModel.applyMatrix3(M).normalize(),j.centroidModel.copy(v.centroid).applyMatrix4(p),x=v.vertexNormals,Z=0,$=Math.min(x.length,3);$>Z;Z++)_=j.vertexNormalsModel[Z],_.copy(x[Z]),!1!==Y||G!==THREE.BackSide&&G!==THREE.DoubleSide||_.negate(),_.applyMatrix3(M).normalize();for(j.vertexNormalsLength=x.length,x=0,Y=Math.min(E.length,3);Y>x;x++)if(G=E[x][S],void 0!==G)for(Z=0,$=G.length;$>Z;Z++)j.uvs[x][Z]=G[Z];j.color=v.color,j.material=V,j.z=(U.positionScreen.z+W.positionScreen.z+X.positionScreen.z)/3,A.elements.push(j)}}}}}else if(t instanceof THREE.Line){if(u instanceof THREE.BufferGeometry){if(E=u.attributes,void 0!==E.position){for(H=E.position.array,t=0,u=H.length;u>t;t+=3)R.pushVertex(H[t],H[t+1],H[t+2]);if(void 0!==E.index)for(E=E.index.array,t=0,u=E.length;u>t;t+=2)R.pushLine(E[t],E[t+1]);else for(t=0,u=H.length/3-1;u>t;t++)R.pushLine(t,t+1)}}else if(u instanceof THREE.Geometry&&(L.multiplyMatrices(K,p),v=t.geometry.vertices,0!==v.length))for(U=a(),U.positionScreen.copy(v[0]).applyMatrix4(L),u=t.type===THREE.LinePieces?2:1,S=1,T=v.length;T>S;S++)U=a(),U.positionScreen.copy(v[S]).applyMatrix4(L),(S+1)%u>0||(W=s[i-2],O.copy(U.positionScreen),P.copy(W.positionScreen),!0===e(O,P)&&(O.multiplyScalar(1/O.w),P.multiplyScalar(1/P.w),l=c(),l.id=t.id,l.v1.positionScreen.copy(O),l.v2.positionScreen.copy(P),l.z=Math.max(O.z,P.z),l.material=t.material,t.material.vertexColors===THREE.VertexColors&&(l.vertexColors[0].copy(t.geometry.colors[S]),l.vertexColors[1].copy(t.geometry.colors[S-1])),A.elements.push(l)))}else t instanceof THREE.Sprite&&(F.set(p.elements[12],p.elements[13],p.elements[14],1),F.applyMatrix4(K),u=1/F.w,F.z*=u,-1<=F.z&&1>=F.z&&(o===z?(w=new THREE.RenderableSprite,y.push(w),z++,o++,n=w):n=y[o++],n.id=t.id,n.x=F.x*u,n.y=F.y*u,n.z=F.z,n.object=t,n.rotation=t.rotation,n.scale.x=t.scale.x*Math.abs(n.x-(F.x+h.projectionMatrix.elements[0])/(F.w+h.projectionMatrix.elements[12])),n.scale.y=t.scale.y*Math.abs(n.y-(F.y+h.projectionMatrix.elements[5])/(F.w+h.projectionMatrix.elements[13])),n.material=t.material,A.elements.push(n)));return!0===r&&A.elements.sort(d),A}},THREE.Face3=function(a,b,c,d,e,f){this.a=a,this.b=b,this.c=c,this.normal=d instanceof THREE.Vector3?d:new THREE.Vector3,this.vertexNormals=d instanceof Array?d:[],this.color=e instanceof THREE.Color?e:new THREE.Color,this.vertexColors=e instanceof Array?e:[],this.vertexTangents=[],this.materialIndex=void 0!==f?f:0,this.centroid=new THREE.Vector3},THREE.Face3.prototype={constructor:THREE.Face3,clone:function(){var a=new THREE.Face3(this.a,this.b,this.c);a.normal.copy(this.normal),a.color.copy(this.color),a.centroid.copy(this.centroid),a.materialIndex=this.materialIndex;var b,c;for(b=0,c=this.vertexNormals.length;c>b;b++)a.vertexNormals[b]=this.vertexNormals[b].clone();for(b=0,c=this.vertexColors.length;c>b;b++)a.vertexColors[b]=this.vertexColors[b].clone();for(b=0,c=this.vertexTangents.length;c>b;b++)a.vertexTangents[b]=this.vertexTangents[b].clone();return a}},THREE.Face4=function(a,b,c,d,e,f,g){return console.warn("THREE.Face4 has been removed. A THREE.Face3 will be created instead."),new THREE.Face3(a,b,c,e,f,g)},THREE.Geometry=function(){this.id=THREE.GeometryIdCount++,this.uuid=THREE.Math.generateUUID(),this.name="",this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphColors=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingSphere=this.boundingBox=null,this.hasTangents=!1,this.dynamic=!0,this.buffersNeedUpdate=this.lineDistancesNeedUpdate=this.colorsNeedUpdate=this.tangentsNeedUpdate=this.normalsNeedUpdate=this.uvsNeedUpdate=this.elementsNeedUpdate=this.verticesNeedUpdate=!1},THREE.Geometry.prototype={constructor:THREE.Geometry,applyMatrix:function(a){for(var b=(new THREE.Matrix3).getNormalMatrix(a),c=0,d=this.vertices.length;d>c;c++)this.vertices[c].applyMatrix4(a);for(c=0,d=this.faces.length;d>c;c++){var e=this.faces[c];e.normal.applyMatrix3(b).normalize();for(var f=0,g=e.vertexNormals.length;g>f;f++)e.vertexNormals[f].applyMatrix3(b).normalize();e.centroid.applyMatrix4(a)}this.boundingBox instanceof THREE.Box3&&this.computeBoundingBox(),this.boundingSphere instanceof THREE.Sphere&&this.computeBoundingSphere()},computeCentroids:function(){var a,b,c;for(a=0,b=this.faces.length;b>a;a++)c=this.faces[a],c.centroid.set(0,0,0),c.centroid.add(this.vertices[c.a]),c.centroid.add(this.vertices[c.b]),c.centroid.add(this.vertices[c.c]),c.centroid.divideScalar(3)},computeFaceNormals:function(){for(var a=new THREE.Vector3,b=new THREE.Vector3,c=0,d=this.faces.length;d>c;c++){var e=this.faces[c],f=this.vertices[e.a],g=this.vertices[e.b];a.subVectors(this.vertices[e.c],g),b.subVectors(f,g),a.cross(b),a.normalize(),e.normal.copy(a)}},computeVertexNormals:function(a){var b,c,d;for(d=Array(this.vertices.length),b=0,c=this.vertices.length;c>b;b++)d[b]=new THREE.Vector3;if(a){var e,f,g,h=new THREE.Vector3,i=new THREE.Vector3;for(new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,a=0,b=this.faces.length;b>a;a++)c=this.faces[a],e=this.vertices[c.a],f=this.vertices[c.b],g=this.vertices[c.c],h.subVectors(g,f),i.subVectors(e,f),h.cross(i),d[c.a].add(h),d[c.b].add(h),d[c.c].add(h)}else for(a=0,b=this.faces.length;b>a;a++)c=this.faces[a],d[c.a].add(c.normal),d[c.b].add(c.normal),d[c.c].add(c.normal);for(b=0,c=this.vertices.length;c>b;b++)d[b].normalize();for(a=0,b=this.faces.length;b>a;a++)c=this.faces[a],c.vertexNormals[0]=d[c.a].clone(),c.vertexNormals[1]=d[c.b].clone(),c.vertexNormals[2]=d[c.c].clone()},computeMorphNormals:function(){var a,b,c,d,e;for(c=0,d=this.faces.length;d>c;c++)for(e=this.faces[c],e.__originalFaceNormal?e.__originalFaceNormal.copy(e.normal):e.__originalFaceNormal=e.normal.clone(),e.__originalVertexNormals||(e.__originalVertexNormals=[]),a=0,b=e.vertexNormals.length;b>a;a++)e.__originalVertexNormals[a]?e.__originalVertexNormals[a].copy(e.vertexNormals[a]):e.__originalVertexNormals[a]=e.vertexNormals[a].clone();var f=new THREE.Geometry;for(f.faces=this.faces,a=0,b=this.morphTargets.length;b>a;a++){if(!this.morphNormals[a]){this.morphNormals[a]={},this.morphNormals[a].faceNormals=[],this.morphNormals[a].vertexNormals=[],e=this.morphNormals[a].faceNormals;var g,h,i=this.morphNormals[a].vertexNormals;for(c=0,d=this.faces.length;d>c;c++)g=new THREE.Vector3,h={a:new THREE.Vector3,b:new THREE.Vector3,c:new THREE.Vector3},e.push(g),i.push(h)}for(i=this.morphNormals[a],f.vertices=this.morphTargets[a].vertices,f.computeFaceNormals(),f.computeVertexNormals(),c=0,d=this.faces.length;d>c;c++)e=this.faces[c],g=i.faceNormals[c],h=i.vertexNormals[c],g.copy(e.normal),h.a.copy(e.vertexNormals[0]),h.b.copy(e.vertexNormals[1]),h.c.copy(e.vertexNormals[2])}for(c=0,d=this.faces.length;d>c;c++)e=this.faces[c],e.normal=e.__originalFaceNormal,e.vertexNormals=e.__originalVertexNormals},computeTangents:function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r=[],s=[];c=new THREE.Vector3;var t=new THREE.Vector3,u=new THREE.Vector3,v=new THREE.Vector3,w=new THREE.Vector3;for(a=0,b=this.vertices.length;b>a;a++)r[a]=new THREE.Vector3,s[a]=new THREE.Vector3;for(a=0,b=this.faces.length;b>a;a++)e=this.faces[a],f=this.faceVertexUvs[0][a],d=e.a,q=e.b,e=e.c,g=this.vertices[d],h=this.vertices[q],i=this.vertices[e],j=f[0],k=f[1],l=f[2],f=h.x-g.x,m=i.x-g.x,n=h.y-g.y,o=i.y-g.y,h=h.z-g.z,g=i.z-g.z,i=k.x-j.x,p=l.x-j.x,k=k.y-j.y,j=l.y-j.y,l=1/(i*j-p*k),c.set((j*f-k*m)*l,(j*n-k*o)*l,(j*h-k*g)*l),t.set((i*m-p*f)*l,(i*o-p*n)*l,(i*g-p*h)*l),r[d].add(c),r[q].add(c),r[e].add(c),s[d].add(t),s[q].add(t),s[e].add(t);for(t=["a","b","c","d"],a=0,b=this.faces.length;b>a;a++)for(e=this.faces[a],c=0;c<Math.min(e.vertexNormals.length,3);c++)w.copy(e.vertexNormals[c]),d=e[t[c]],q=r[d],u.copy(q),u.sub(w.multiplyScalar(w.dot(q))).normalize(),v.crossVectors(e.vertexNormals[c],q),d=v.dot(s[d]),d=0>d?-1:1,e.vertexTangents[c]=new THREE.Vector4(u.x,u.y,u.z,d);this.hasTangents=!0},computeLineDistances:function(){for(var a=0,b=this.vertices,c=0,d=b.length;d>c;c++)c>0&&(a+=b[c].distanceTo(b[c-1])),this.lineDistances[c]=a},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new THREE.Box3),this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new THREE.Sphere),this.boundingSphere.setFromPoints(this.vertices)},mergeVertices:function(){var a,b,c,d={},e=[],f=[],g=Math.pow(10,4);for(b=0,c=this.vertices.length;c>b;b++)a=this.vertices[b],a=Math.round(a.x*g)+"_"+Math.round(a.y*g)+"_"+Math.round(a.z*g),void 0===d[a]?(d[a]=b,e.push(this.vertices[b]),f[b]=e.length-1):f[b]=f[d[a]];for(d=[],b=0,c=this.faces.length;c>b;b++)for(g=this.faces[b],g.a=f[g.a],g.b=f[g.b],g.c=f[g.c],g=[g.a,g.b,g.c],a=0;3>a;a++)if(g[a]==g[(a+1)%3]){d.push(b);break}for(b=d.length-1;b>=0;b--)for(g=d[b],this.faces.splice(g,1),f=0,c=this.faceVertexUvs.length;c>f;f++)this.faceVertexUvs[f].splice(g,1);return b=this.vertices.length-e.length,this.vertices=e,b},makeGroups:function(){var a=0;return function(b){var c,d,e,f,g={},h=this.morphTargets.length,i=this.morphNormals.length;for(this.geometryGroups={},c=0,d=this.faces.length;d>c;c++)e=this.faces[c],e=b?e.materialIndex:0,e in g||(g[e]={hash:e,counter:0}),f=g[e].hash+"_"+g[e].counter,f in this.geometryGroups||(this.geometryGroups[f]={faces3:[],materialIndex:e,vertices:0,numMorphTargets:h,numMorphNormals:i}),65535<this.geometryGroups[f].vertices+3&&(g[e].counter+=1,f=g[e].hash+"_"+g[e].counter,f in this.geometryGroups||(this.geometryGroups[f]={faces3:[],materialIndex:e,vertices:0,numMorphTargets:h,numMorphNormals:i})),this.geometryGroups[f].faces3.push(c),this.geometryGroups[f].vertices+=3;this.geometryGroupsList=[];for(var j in this.geometryGroups)this.geometryGroups[j].id=a++,this.geometryGroupsList.push(this.geometryGroups[j])}}(),clone:function(){for(var a=new THREE.Geometry,b=this.vertices,c=0,d=b.length;d>c;c++)a.vertices.push(b[c].clone());for(b=this.faces,c=0,d=b.length;d>c;c++)a.faces.push(b[c].clone());for(b=this.faceVertexUvs[0],c=0,d=b.length;d>c;c++){for(var e=b[c],f=[],g=0,h=e.length;h>g;g++)f.push(new THREE.Vector2(e[g].x,e[g].y));a.faceVertexUvs[0].push(f)}return a},dispose:function(){this.dispatchEvent({type:"dispose"})}},THREE.EventDispatcher.prototype.apply(THREE.Geometry.prototype),THREE.GeometryIdCount=0,THREE.Geometry2=function(a){this.id=THREE.GeometryIdCount++,this.uuid=THREE.Math.generateUUID(),this.name="",this.vertices=void 0!==a?new Float32Array(3*a):[],this.normals=void 0!==a?new Float32Array(3*a):[],this.uvs=void 0!==a?new Float32Array(2*a):[],this.boundingSphere=this.boundingBox=null},THREE.Geometry2.prototype={constructor:THREE.Geometry2,applyMatrix:function(a){a.multiplyVector3Array(this.vertices)},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new THREE.Box3);var a=this.vertices,b=this.boundingBox;3<=a.length&&(b.min.x=b.max.x=a[0],b.min.y=b.max.y=a[1],b.min.z=b.max.z=a[2]);for(var c=3,d=a.length;d>c;c+=3){var e=a[c],f=a[c+1],g=a[c+2];e<b.min.x?b.min.x=e:e>b.max.x&&(b.max.x=e),f<b.min.y?b.min.y=f:f>b.max.y&&(b.max.y=f),g<b.min.z?b.min.z=g:g>b.max.z&&(b.max.z=g)}},computeBoundingSphere:function(){var a=new THREE.Box3,b=new THREE.Vector3;return function(){null===this.boundingSphere&&(this.boundingSphere=new THREE.Sphere),a.makeEmpty();for(var c=this.vertices,d=this.boundingSphere.center,e=0,f=c.length;f>e;e+=3)b.set(c[e],c[e+1],c[e+2]),a.addPoint(b);a.center(d);for(var g=0,e=0,f=c.length;f>e;e+=3)b.set(c[e],c[e+1],c[e+2]),g=Math.max(g,d.distanceToSquared(b));this.boundingSphere.radius=Math.sqrt(g)}}(),dispose:function(){this.dispatchEvent({type:"dispose"})}},THREE.EventDispatcher.prototype.apply(THREE.Geometry2.prototype),THREE.BufferGeometry=function(){this.id=THREE.GeometryIdCount++,this.uuid=THREE.Math.generateUUID(),this.name="",this.attributes={},this.offsets=[],this.boundingSphere=this.boundingBox=null},THREE.BufferGeometry.prototype={constructor:THREE.BufferGeometry,addAttribute:function(a,b,c,d){this.attributes[a]={itemSize:d,array:new b(c*d)}},applyMatrix:function(a){var b=this.attributes.position;void 0!==b&&(a.multiplyVector3Array(b.array),b.needsUpdate=!0),b=this.attributes.normal,void 0!==b&&((new THREE.Matrix3).getNormalMatrix(a).multiplyVector3Array(b.array),b.needsUpdate=!0)},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new THREE.Box3);var a=this.attributes.position.array;if(a){var b=this.boundingBox;3<=a.length&&(b.min.x=b.max.x=a[0],b.min.y=b.max.y=a[1],b.min.z=b.max.z=a[2]);for(var c=3,d=a.length;d>c;c+=3){var e=a[c],f=a[c+1],g=a[c+2];e<b.min.x?b.min.x=e:e>b.max.x&&(b.max.x=e),f<b.min.y?b.min.y=f:f>b.max.y&&(b.max.y=f),g<b.min.z?b.min.z=g:g>b.max.z&&(b.max.z=g)}}(void 0===a||0===a.length)&&(this.boundingBox.min.set(0,0,0),this.boundingBox.max.set(0,0,0))},computeBoundingSphere:function(){var a=new THREE.Box3,b=new THREE.Vector3;return function(){null===this.boundingSphere&&(this.boundingSphere=new THREE.Sphere);var c=this.attributes.position.array;if(c){a.makeEmpty();for(var d=this.boundingSphere.center,e=0,f=c.length;f>e;e+=3)b.set(c[e],c[e+1],c[e+2]),a.addPoint(b);a.center(d);for(var g=0,e=0,f=c.length;f>e;e+=3)b.set(c[e],c[e+1],c[e+2]),g=Math.max(g,d.distanceToSquared(b));this.boundingSphere.radius=Math.sqrt(g)}}}(),computeVertexNormals:function(){if(this.attributes.position){var a,b,c,d;if(a=this.attributes.position.array.length,void 0===this.attributes.normal)this.attributes.normal={itemSize:3,array:new Float32Array(a)};else for(a=0,b=this.attributes.normal.array.length;b>a;a++)this.attributes.normal.array[a]=0;var e,f,g,h,i,j,k=this.attributes.position.array,l=this.attributes.normal.array,m=new THREE.Vector3,n=new THREE.Vector3,o=new THREE.Vector3,p=new THREE.Vector3,q=new THREE.Vector3;if(this.attributes.index){var r=this.attributes.index.array,s=this.offsets;for(c=0,d=s.length;d>c;++c){b=s[c].start,e=s[c].count;var t=s[c].index;for(a=b,b+=e;b>a;a+=3)e=t+r[a],f=t+r[a+1],g=t+r[a+2],h=k[3*e],i=k[3*e+1],j=k[3*e+2],m.set(h,i,j),h=k[3*f],i=k[3*f+1],j=k[3*f+2],n.set(h,i,j),h=k[3*g],i=k[3*g+1],j=k[3*g+2],o.set(h,i,j),p.subVectors(o,n),q.subVectors(m,n),p.cross(q),l[3*e]+=p.x,l[3*e+1]+=p.y,l[3*e+2]+=p.z,l[3*f]+=p.x,l[3*f+1]+=p.y,l[3*f+2]+=p.z,l[3*g]+=p.x,l[3*g+1]+=p.y,l[3*g+2]+=p.z}}else for(a=0,b=k.length;b>a;a+=9)h=k[a],i=k[a+1],j=k[a+2],m.set(h,i,j),h=k[a+3],i=k[a+4],j=k[a+5],n.set(h,i,j),h=k[a+6],i=k[a+7],j=k[a+8],o.set(h,i,j),p.subVectors(o,n),q.subVectors(m,n),p.cross(q),l[a]=p.x,l[a+1]=p.y,l[a+2]=p.z,l[a+3]=p.x,l[a+4]=p.y,l[a+5]=p.z,l[a+6]=p.x,l[a+7]=p.y,l[a+8]=p.z;this.normalizeNormals(),this.normalsNeedUpdate=!0}},normalizeNormals:function(){for(var a,b,c,d=this.attributes.normal.array,e=0,f=d.length;f>e;e+=3)a=d[e],b=d[e+1],c=d[e+2],a=1/Math.sqrt(a*a+b*b+c*c),d[e]*=a,d[e+1]*=a,d[e+2]*=a},computeTangents:function(){function a(a,b,c){l=d[3*a],m=d[3*a+1],n=d[3*a+2],o=d[3*b],p=d[3*b+1],q=d[3*b+2],r=d[3*c],s=d[3*c+1],t=d[3*c+2],u=f[2*a],v=f[2*a+1],w=f[2*b],x=f[2*b+1],y=f[2*c],z=f[2*c+1],A=o-l,B=r-l,C=p-m,D=s-m,E=q-n,F=t-n,G=w-u,H=y-u,I=x-v,J=z-v,K=1/(G*J-H*I),Q.set((J*A-I*B)*K,(J*C-I*D)*K,(J*E-I*F)*K),R.set((G*B-H*A)*K,(G*D-H*C)*K,(G*F-H*E)*K),i[a].add(Q),i[b].add(Q),i[c].add(Q),j[a].add(R),j[b].add(R),j[c].add(R)}function b(a){Z.x=e[3*a],Z.y=e[3*a+1],Z.z=e[3*a+2],$.copy(Z),V=i[a],X.copy(V),X.sub(Z.multiplyScalar(Z.dot(V))).normalize(),Y.crossVectors($,V),W=Y.dot(j[a]),U=0>W?-1:1,h[4*a]=X.x,h[4*a+1]=X.y,h[4*a+2]=X.z,h[4*a+3]=U}if(void 0===this.attributes.index||void 0===this.attributes.position||void 0===this.attributes.normal||void 0===this.attributes.uv)console.warn("Missing required attributes (index, position, normal or uv) in BufferGeometry.computeTangents()");else{var c=this.attributes.index.array,d=this.attributes.position.array,e=this.attributes.normal.array,f=this.attributes.uv.array,g=d.length/3;void 0===this.attributes.tangent&&(this.attributes.tangent={itemSize:4,array:new Float32Array(4*g)});for(var h=this.attributes.tangent.array,i=[],j=[],k=0;g>k;k++)i[k]=new THREE.Vector3,j[k]=new THREE.Vector3;var l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q=new THREE.Vector3,R=new THREE.Vector3,S=this.offsets,k=0;for(M=S.length;M>k;++k){L=S[k].start,N=S[k].count;var T=S[k].index,g=L;for(L+=N;L>g;g+=3)N=T+c[g],O=T+c[g+1],P=T+c[g+2],a(N,O,P)}var U,V,W,X=new THREE.Vector3,Y=new THREE.Vector3,Z=new THREE.Vector3,$=new THREE.Vector3,k=0;for(M=S.length;M>k;++k)for(L=S[k].start,N=S[k].count,T=S[k].index,g=L,L+=N;L>g;g+=3)N=T+c[g],O=T+c[g+1],P=T+c[g+2],b(N),b(O),b(P)}},computeOffsets:function(a){var b=a;void 0===a&&(b=65535),Date.now(),a=this.attributes.index.array;for(var c=this.attributes.position.array,d=a.length/3,e=new Uint16Array(a.length),f=0,g=0,h=[{start:0,count:0,index:0}],i=h[0],j=0,k=0,l=new Int32Array(6),m=new Int32Array(c.length),n=new Int32Array(c.length),o=0;o<c.length;o++)m[o]=-1,n[o]=-1;for(c=0;d>c;c++){for(var p=k=0;3>p;p++)o=a[3*c+p],-1==m[o]?(l[2*p]=o,l[2*p+1]=-1,k++):m[o]<i.index?(l[2*p]=o,l[2*p+1]=-1,j++):(l[2*p]=o,l[2*p+1]=m[o]);if(g+k>i.index+b)for(i={start:f,count:0,index:g},h.push(i),k=0;6>k;k+=2)p=l[k+1],p>-1&&p<i.index&&(l[k+1]=-1);for(k=0;6>k;k+=2)o=l[k],p=l[k+1],-1===p&&(p=g++),m[o]=p,n[p]=o,e[f++]=p-i.index,i.count++}return this.reorderBuffers(e,n,g),this.offsets=h},reorderBuffers:function(a,b,c){var d,e={},f=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];for(d in this.attributes)if("index"!=d)for(var g=this.attributes[d].array,h=0,i=f.length;i>h;h++){var j=f[h];if(g instanceof j){e[d]=new j(this.attributes[d].itemSize*c);break}}for(f=0;c>f;f++)for(d in g=b[f],this.attributes)if("index"!=d)for(var h=this.attributes[d].array,i=this.attributes[d].itemSize,j=e[d],k=0;i>k;k++)j[f*i+k]=h[g*i+k];this.attributes.index.array=a;for(d in this.attributes)"index"!=d&&(this.attributes[d].array=e[d],this.attributes[d].numItems=this.attributes[d].itemSize*c)},clone:function(){var a,b=new THREE.BufferGeometry,c=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];for(a in this.attributes){for(var d=this.attributes[a],e=d.array,f={itemSize:d.itemSize,array:null},d=0,g=c.length;g>d;d++){var h=c[d];if(e instanceof h){f.array=new h(e);break}}b.attributes[a]=f}for(d=0,g=this.offsets.length;g>d;d++)c=this.offsets[d],b.offsets.push({start:c.start,index:c.index,count:c.count});return b},dispose:function(){this.dispatchEvent({type:"dispose"})}},THREE.EventDispatcher.prototype.apply(THREE.BufferGeometry.prototype),THREE.Camera=function(){THREE.Object3D.call(this),this.matrixWorldInverse=new THREE.Matrix4,this.projectionMatrix=new THREE.Matrix4},THREE.Camera.prototype=Object.create(THREE.Object3D.prototype),THREE.Camera.prototype.lookAt=function(){var a=new THREE.Matrix4;return function(b){a.lookAt(this.position,b,this.up),this.quaternion.setFromRotationMatrix(a)}}(),THREE.Camera.prototype.clone=function(a){return void 0===a&&(a=new THREE.Camera),THREE.Object3D.prototype.clone.call(this,a),a.matrixWorldInverse.copy(this.matrixWorldInverse),a.projectionMatrix.copy(this.projectionMatrix),a},THREE.OrthographicCamera=function(a,b,c,d,e,f){THREE.Camera.call(this),this.left=a,this.right=b,this.top=c,this.bottom=d,this.near=void 0!==e?e:.1,this.far=void 0!==f?f:2e3,this.updateProjectionMatrix()},THREE.OrthographicCamera.prototype=Object.create(THREE.Camera.prototype),THREE.OrthographicCamera.prototype.updateProjectionMatrix=function(){this.projectionMatrix.makeOrthographic(this.left,this.right,this.top,this.bottom,this.near,this.far)},THREE.OrthographicCamera.prototype.clone=function(){var a=new THREE.OrthographicCamera;return THREE.Camera.prototype.clone.call(this,a),a.left=this.left,a.right=this.right,a.top=this.top,a.bottom=this.bottom,a.near=this.near,a.far=this.far,a},THREE.PerspectiveCamera=function(a,b,c,d){THREE.Camera.call(this),this.fov=void 0!==a?a:50,this.aspect=void 0!==b?b:1,this.near=void 0!==c?c:.1,this.far=void 0!==d?d:2e3,this.updateProjectionMatrix()},THREE.PerspectiveCamera.prototype=Object.create(THREE.Camera.prototype),THREE.PerspectiveCamera.prototype.setLens=function(a,b){void 0===b&&(b=24),this.fov=2*THREE.Math.radToDeg(Math.atan(b/(2*a))),this.updateProjectionMatrix()},THREE.PerspectiveCamera.prototype.setViewOffset=function(a,b,c,d,e,f){this.fullWidth=a,this.fullHeight=b,this.x=c,this.y=d,this.width=e,this.height=f,this.updateProjectionMatrix()},THREE.PerspectiveCamera.prototype.updateProjectionMatrix=function(){if(this.fullWidth){var a=this.fullWidth/this.fullHeight,b=Math.tan(THREE.Math.degToRad(.5*this.fov))*this.near,c=-b,d=a*c,a=Math.abs(a*b-d),c=Math.abs(b-c);this.projectionMatrix.makeFrustum(d+this.x*a/this.fullWidth,d+(this.x+this.width)*a/this.fullWidth,b-(this.y+this.height)*c/this.fullHeight,b-this.y*c/this.fullHeight,this.near,this.far)}else this.projectionMatrix.makePerspective(this.fov,this.aspect,this.near,this.far)},THREE.PerspectiveCamera.prototype.clone=function(){var a=new THREE.PerspectiveCamera;return THREE.Camera.prototype.clone.call(this,a),a.fov=this.fov,a.aspect=this.aspect,a.near=this.near,a.far=this.far,a},THREE.Light=function(a){THREE.Object3D.call(this),this.color=new THREE.Color(a)},THREE.Light.prototype=Object.create(THREE.Object3D.prototype),THREE.Light.prototype.clone=function(a){return void 0===a&&(a=new THREE.Light),THREE.Object3D.prototype.clone.call(this,a),a.color.copy(this.color),a},THREE.AmbientLight=function(a){THREE.Light.call(this,a)},THREE.AmbientLight.prototype=Object.create(THREE.Light.prototype),THREE.AmbientLight.prototype.clone=function(){var a=new THREE.AmbientLight;return THREE.Light.prototype.clone.call(this,a),a},THREE.AreaLight=function(a,b){THREE.Light.call(this,a),this.normal=new THREE.Vector3(0,-1,0),this.right=new THREE.Vector3(1,0,0),this.intensity=void 0!==b?b:1,this.height=this.width=1,this.constantAttenuation=1.5,this.linearAttenuation=.5,this.quadraticAttenuation=.1},THREE.AreaLight.prototype=Object.create(THREE.Light.prototype),THREE.DirectionalLight=function(a,b){THREE.Light.call(this,a),this.position.set(0,1,0),this.target=new THREE.Object3D,this.intensity=void 0!==b?b:1,this.onlyShadow=this.castShadow=!1,this.shadowCameraNear=50,this.shadowCameraFar=5e3,this.shadowCameraLeft=-500,this.shadowCameraTop=this.shadowCameraRight=500,this.shadowCameraBottom=-500,this.shadowCameraVisible=!1,this.shadowBias=0,this.shadowDarkness=.5,this.shadowMapHeight=this.shadowMapWidth=512,this.shadowCascade=!1,this.shadowCascadeOffset=new THREE.Vector3(0,0,-1e3),this.shadowCascadeCount=2,this.shadowCascadeBias=[0,0,0],this.shadowCascadeWidth=[512,512,512],this.shadowCascadeHeight=[512,512,512],this.shadowCascadeNearZ=[-1,.99,.998],this.shadowCascadeFarZ=[.99,.998,1],this.shadowCascadeArray=[],this.shadowMatrix=this.shadowCamera=this.shadowMapSize=this.shadowMap=null},THREE.DirectionalLight.prototype=Object.create(THREE.Light.prototype),THREE.DirectionalLight.prototype.clone=function(){var a=new THREE.DirectionalLight;return THREE.Light.prototype.clone.call(this,a),a.target=this.target.clone(),a.intensity=this.intensity,a.castShadow=this.castShadow,a.onlyShadow=this.onlyShadow,a},THREE.HemisphereLight=function(a,b,c){THREE.Light.call(this,a),this.position.set(0,100,0),this.groundColor=new THREE.Color(b),this.intensity=void 0!==c?c:1},THREE.HemisphereLight.prototype=Object.create(THREE.Light.prototype),THREE.HemisphereLight.prototype.clone=function(){var a=new THREE.HemisphereLight;return THREE.Light.prototype.clone.call(this,a),a.groundColor.copy(this.groundColor),a.intensity=this.intensity,a},THREE.PointLight=function(a,b,c){THREE.Light.call(this,a),this.intensity=void 0!==b?b:1,this.distance=void 0!==c?c:0},THREE.PointLight.prototype=Object.create(THREE.Light.prototype),THREE.PointLight.prototype.clone=function(){var a=new THREE.PointLight;return THREE.Light.prototype.clone.call(this,a),a.intensity=this.intensity,a.distance=this.distance,a},THREE.SpotLight=function(a,b,c,d,e){THREE.Light.call(this,a),this.position.set(0,1,0),this.target=new THREE.Object3D,this.intensity=void 0!==b?b:1,this.distance=void 0!==c?c:0,this.angle=void 0!==d?d:Math.PI/3,this.exponent=void 0!==e?e:10,this.onlyShadow=this.castShadow=!1,this.shadowCameraNear=50,this.shadowCameraFar=5e3,this.shadowCameraFov=50,this.shadowCameraVisible=!1,this.shadowBias=0,this.shadowDarkness=.5,this.shadowMapHeight=this.shadowMapWidth=512,this.shadowMatrix=this.shadowCamera=this.shadowMapSize=this.shadowMap=null},THREE.SpotLight.prototype=Object.create(THREE.Light.prototype),THREE.SpotLight.prototype.clone=function(){var a=new THREE.SpotLight;return THREE.Light.prototype.clone.call(this,a),a.target=this.target.clone(),a.intensity=this.intensity,a.distance=this.distance,a.angle=this.angle,a.exponent=this.exponent,a.castShadow=this.castShadow,a.onlyShadow=this.onlyShadow,a},THREE.Loader=function(a){this.statusDomElement=(this.showStatus=a)?THREE.Loader.prototype.addStatusElement():null,this.onLoadStart=function(){},this.onLoadProgress=function(){},this.onLoadComplete=function(){}},THREE.Loader.prototype={constructor:THREE.Loader,crossOrigin:void 0,addStatusElement:function(){var a=document.createElement("div");return a.style.position="absolute",a.style.right="0px",a.style.top="0px",a.style.fontSize="0.8em",a.style.textAlign="left",a.style.background="rgba(0,0,0,0.25)",a.style.color="#fff",a.style.width="120px",a.style.padding="0.5em 0.5em 0.5em 0.5em",a.style.zIndex=1e3,a.innerHTML="Loading ...",a},updateProgress:function(a){var b="Loaded ",b=a.total?b+((100*a.loaded/a.total).toFixed(0)+"%"):b+((a.loaded/1e3).toFixed(2)+" KB");this.statusDomElement.innerHTML=b},extractUrlBase:function(a){return a=a.split("/"),1===a.length?"./":(a.pop(),a.join("/")+"/")},initMaterials:function(a,b){for(var c=[],d=0;d<a.length;++d)c[d]=THREE.Loader.prototype.createMaterial(a[d],b);return c},needsTangents:function(a){for(var b=0,c=a.length;c>b;b++)if(a[b]instanceof THREE.ShaderMaterial)return!0;return!1},createMaterial:function(a,b){function c(a){return a=Math.log(a)/Math.LN2,Math.floor(a)==a}function d(a){return a=Math.log(a)/Math.LN2,Math.pow(2,Math.round(a))}function e(a,b){var e=new Image;e.onload=function(){if(c(this.width)&&c(this.height))a.image=this;else{var b=d(this.width),e=d(this.height);a.image.width=b,a.image.height=e,a.image.getContext("2d").drawImage(this,0,0,b,e)}a.needsUpdate=!0},void 0!==h.crossOrigin&&(e.crossOrigin=h.crossOrigin),e.src=b}function f(a,c,d,f,g,h,i){var j=/\.dds$/i.test(d),k=b+d;if(j){var l=THREE.ImageUtils.loadCompressedTexture(k);a[c]=l}else l=document.createElement("canvas"),a[c]=new THREE.Texture(l);a[c].sourceFile=d,f&&(a[c].repeat.set(f[0],f[1]),1!==f[0]&&(a[c].wrapS=THREE.RepeatWrapping),1!==f[1]&&(a[c].wrapT=THREE.RepeatWrapping)),g&&a[c].offset.set(g[0],g[1]),h&&(d={repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping},void 0!==d[h[0]]&&(a[c].wrapS=d[h[0]]),void 0!==d[h[1]]&&(a[c].wrapT=d[h[1]])),i&&(a[c].anisotropy=i),j||e(a[c],k)}function g(a){return(255*a[0]<<16)+(255*a[1]<<8)+255*a[2]}var h=this,i="MeshLambertMaterial",j={color:15658734,opacity:1,map:null,lightMap:null,normalMap:null,bumpMap:null,wireframe:!1};if(a.shading){var k=a.shading.toLowerCase();"phong"===k?i="MeshPhongMaterial":"basic"===k&&(i="MeshBasicMaterial")}return void 0!==a.blending&&void 0!==THREE[a.blending]&&(j.blending=THREE[a.blending]),(void 0!==a.transparent||1>a.opacity)&&(j.transparent=a.transparent),void 0!==a.depthTest&&(j.depthTest=a.depthTest),void 0!==a.depthWrite&&(j.depthWrite=a.depthWrite),void 0!==a.visible&&(j.visible=a.visible),void 0!==a.flipSided&&(j.side=THREE.BackSide),void 0!==a.doubleSided&&(j.side=THREE.DoubleSide),void 0!==a.wireframe&&(j.wireframe=a.wireframe),void 0!==a.vertexColors&&("face"===a.vertexColors?j.vertexColors=THREE.FaceColors:a.vertexColors&&(j.vertexColors=THREE.VertexColors)),a.colorDiffuse?j.color=g(a.colorDiffuse):a.DbgColor&&(j.color=a.DbgColor),a.colorSpecular&&(j.specular=g(a.colorSpecular)),a.colorAmbient&&(j.ambient=g(a.colorAmbient)),a.transparency&&(j.opacity=a.transparency),a.specularCoef&&(j.shininess=a.specularCoef),a.mapDiffuse&&b&&f(j,"map",a.mapDiffuse,a.mapDiffuseRepeat,a.mapDiffuseOffset,a.mapDiffuseWrap,a.mapDiffuseAnisotropy),a.mapLight&&b&&f(j,"lightMap",a.mapLight,a.mapLightRepeat,a.mapLightOffset,a.mapLightWrap,a.mapLightAnisotropy),a.mapBump&&b&&f(j,"bumpMap",a.mapBump,a.mapBumpRepeat,a.mapBumpOffset,a.mapBumpWrap,a.mapBumpAnisotropy),a.mapNormal&&b&&f(j,"normalMap",a.mapNormal,a.mapNormalRepeat,a.mapNormalOffset,a.mapNormalWrap,a.mapNormalAnisotropy),a.mapSpecular&&b&&f(j,"specularMap",a.mapSpecular,a.mapSpecularRepeat,a.mapSpecularOffset,a.mapSpecularWrap,a.mapSpecularAnisotropy),a.mapBumpScale&&(j.bumpScale=a.mapBumpScale),a.mapNormal?(i=THREE.ShaderLib.normalmap,k=THREE.UniformsUtils.clone(i.uniforms),k.tNormal.value=j.normalMap,a.mapNormalFactor&&k.uNormalScale.value.set(a.mapNormalFactor,a.mapNormalFactor),j.map&&(k.tDiffuse.value=j.map,k.enableDiffuse.value=!0),j.specularMap&&(k.tSpecular.value=j.specularMap,k.enableSpecular.value=!0),j.lightMap&&(k.tAO.value=j.lightMap,k.enableAO.value=!0),k.diffuse.value.setHex(j.color),k.specular.value.setHex(j.specular),k.ambient.value.setHex(j.ambient),k.shininess.value=j.shininess,void 0!==j.opacity&&(k.opacity.value=j.opacity),i=new THREE.ShaderMaterial({fragmentShader:i.fragmentShader,vertexShader:i.vertexShader,uniforms:k,lights:!0,fog:!0}),j.transparent&&(i.transparent=!0)):i=new THREE[i](j),void 0!==a.DbgName&&(i.name=a.DbgName),i}},THREE.XHRLoader=function(a){this.manager=void 0!==a?a:THREE.DefaultLoadingManager},THREE.XHRLoader.prototype={constructor:THREE.XHRLoader,load:function(a,b,c,d){var e=this,f=new XMLHttpRequest;void 0!==b&&f.addEventListener("load",function(c){b(c.target.responseText),e.manager.itemEnd(a)},!1),void 0!==c&&f.addEventListener("progress",function(a){c(a)},!1),void 0!==d&&f.addEventListener("error",function(a){d(a)},!1),void 0!==this.crossOrigin&&(f.crossOrigin=this.crossOrigin),f.open("GET",a,!0),f.send(null),e.manager.itemStart(a)},setCrossOrigin:function(a){this.crossOrigin=a}},THREE.ImageLoader=function(a){this.manager=void 0!==a?a:THREE.DefaultLoadingManager},THREE.ImageLoader.prototype={constructor:THREE.ImageLoader,load:function(a,b,c,d){var e=this,f=document.createElement("img");return void 0!==b&&f.addEventListener("load",function(){e.manager.itemEnd(a),b(this)},!1),void 0!==c&&f.addEventListener("progress",function(a){c(a)},!1),void 0!==d&&f.addEventListener("error",function(a){d(a)},!1),void 0!==this.crossOrigin&&(f.crossOrigin=this.crossOrigin),f.src=a,e.manager.itemStart(a),f},setCrossOrigin:function(a){this.crossOrigin=a}},THREE.JSONLoader=function(a){THREE.Loader.call(this,a),this.withCredentials=!1},THREE.JSONLoader.prototype=Object.create(THREE.Loader.prototype),THREE.JSONLoader.prototype.load=function(a,b,c){c=c&&"string"==typeof c?c:this.extractUrlBase(a),this.onLoadStart(),this.loadAjaxJSON(this,a,b,c)},THREE.JSONLoader.prototype.loadAjaxJSON=function(a,b,c,d,e){var f=new XMLHttpRequest,g=0;f.onreadystatechange=function(){if(f.readyState===f.DONE)if(200===f.status||0===f.status){if(f.responseText){var h=JSON.parse(f.responseText);if("scene"===h.metadata.type)return void console.error('THREE.JSONLoader: "'+b+'" seems to be a Scene. Use THREE.SceneLoader instead.');h=a.parse(h,d),c(h.geometry,h.materials)}else console.error('THREE.JSONLoader: "'+b+'" seems to be unreachable or the file is empty.');a.onLoadComplete()}else console.error("THREE.JSONLoader: Couldn't load \""+b+'" ('+f.status+")");else f.readyState===f.LOADING?e&&(0===g&&(g=f.getResponseHeader("Content-Length")),e({total:g,loaded:f.responseText.length})):f.readyState===f.HEADERS_RECEIVED&&void 0!==e&&(g=f.getResponseHeader("Content-Length"))
},f.open("GET",b,!0),f.withCredentials=this.withCredentials,f.send(null)},THREE.JSONLoader.prototype.parse=function(a,b){var c=new THREE.Geometry,d=void 0!==a.scale?1/a.scale:1;return function(b){var d,e,f,g,h,i,j,k,l,m,n,o,p,q=a.faces;i=a.vertices;var r=a.normals,s=a.colors,t=0;if(void 0!==a.uvs){for(d=0;d<a.uvs.length;d++)a.uvs[d].length&&t++;for(d=0;t>d;d++)c.faceVertexUvs[d]=[]}for(g=0,h=i.length;h>g;)d=new THREE.Vector3,d.x=i[g++]*b,d.y=i[g++]*b,d.z=i[g++]*b,c.vertices.push(d);for(g=0,h=q.length;h>g;)if(b=q[g++],l=1&b,f=2&b,d=8&b,j=16&b,m=32&b,i=64&b,b&=128,l){if(l=new THREE.Face3,l.a=q[g],l.b=q[g+1],l.c=q[g+3],n=new THREE.Face3,n.a=q[g+1],n.b=q[g+2],n.c=q[g+3],g+=4,f&&(f=q[g++],l.materialIndex=f,n.materialIndex=f),f=c.faces.length,d)for(d=0;t>d;d++)for(o=a.uvs[d],c.faceVertexUvs[d][f]=[],c.faceVertexUvs[d][f+1]=[],e=0;4>e;e++)k=q[g++],p=o[2*k],k=o[2*k+1],p=new THREE.Vector2(p,k),2!==e&&c.faceVertexUvs[d][f].push(p),0!==e&&c.faceVertexUvs[d][f+1].push(p);if(j&&(j=3*q[g++],l.normal.set(r[j++],r[j++],r[j]),n.normal.copy(l.normal)),m)for(d=0;4>d;d++)j=3*q[g++],m=new THREE.Vector3(r[j++],r[j++],r[j]),2!==d&&l.vertexNormals.push(m),0!==d&&n.vertexNormals.push(m);if(i&&(i=q[g++],i=s[i],l.color.setHex(i),n.color.setHex(i)),b)for(d=0;4>d;d++)i=q[g++],i=s[i],2!==d&&l.vertexColors.push(new THREE.Color(i)),0!==d&&n.vertexColors.push(new THREE.Color(i));c.faces.push(l),c.faces.push(n)}else{if(l=new THREE.Face3,l.a=q[g++],l.b=q[g++],l.c=q[g++],f&&(f=q[g++],l.materialIndex=f),f=c.faces.length,d)for(d=0;t>d;d++)for(o=a.uvs[d],c.faceVertexUvs[d][f]=[],e=0;3>e;e++)k=q[g++],p=o[2*k],k=o[2*k+1],p=new THREE.Vector2(p,k),c.faceVertexUvs[d][f].push(p);if(j&&(j=3*q[g++],l.normal.set(r[j++],r[j++],r[j])),m)for(d=0;3>d;d++)j=3*q[g++],m=new THREE.Vector3(r[j++],r[j++],r[j]),l.vertexNormals.push(m);if(i&&(i=q[g++],l.color.setHex(s[i])),b)for(d=0;3>d;d++)i=q[g++],l.vertexColors.push(new THREE.Color(s[i]));c.faces.push(l)}}(d),function(){if(a.skinWeights)for(var b=0,d=a.skinWeights.length;d>b;b+=2)c.skinWeights.push(new THREE.Vector4(a.skinWeights[b],a.skinWeights[b+1],0,0));if(a.skinIndices)for(b=0,d=a.skinIndices.length;d>b;b+=2)c.skinIndices.push(new THREE.Vector4(a.skinIndices[b],a.skinIndices[b+1],0,0));c.bones=a.bones,c.bones&&0<c.bones.length&&(c.skinWeights.length!==c.skinIndices.length||c.skinIndices.length!==c.vertices.length)&&console.warn("When skinning, number of vertices ("+c.vertices.length+"), skinIndices ("+c.skinIndices.length+"), and skinWeights ("+c.skinWeights.length+") should match."),c.animation=a.animation,c.animations=a.animations}(),function(b){if(void 0!==a.morphTargets){var d,e,f,g,h,i;for(d=0,e=a.morphTargets.length;e>d;d++)for(c.morphTargets[d]={},c.morphTargets[d].name=a.morphTargets[d].name,c.morphTargets[d].vertices=[],h=c.morphTargets[d].vertices,i=a.morphTargets[d].vertices,f=0,g=i.length;g>f;f+=3){var j=new THREE.Vector3;j.x=i[f]*b,j.y=i[f+1]*b,j.z=i[f+2]*b,h.push(j)}}if(void 0!==a.morphColors)for(d=0,e=a.morphColors.length;e>d;d++)for(c.morphColors[d]={},c.morphColors[d].name=a.morphColors[d].name,c.morphColors[d].colors=[],g=c.morphColors[d].colors,h=a.morphColors[d].colors,b=0,f=h.length;f>b;b+=3)i=new THREE.Color(16755200),i.setRGB(h[b],h[b+1],h[b+2]),g.push(i)}(d),c.computeCentroids(),c.computeFaceNormals(),c.computeBoundingSphere(),void 0===a.materials?{geometry:c}:(d=this.initMaterials(a.materials,b),this.needsTangents(d)&&c.computeTangents(),{geometry:c,materials:d})},THREE.LoadingManager=function(a,b,c){var d=this,e=0,f=0;this.onLoad=a,this.onProgress=b,this.onError=c,this.itemStart=function(){f++},this.itemEnd=function(a){e++,void 0!==d.onProgress&&d.onProgress(a,e,f),e===f&&void 0!==d.onLoad&&d.onLoad()}},THREE.DefaultLoadingManager=new THREE.LoadingManager,THREE.BufferGeometryLoader=function(a){this.manager=void 0!==a?a:THREE.DefaultLoadingManager},THREE.BufferGeometryLoader.prototype={constructor:THREE.BufferGeometryLoader,load:function(a,b,c){var d=this;c=new THREE.XHRLoader,c.setCrossOrigin(this.crossOrigin),c.load(a,function(a){b(d.parse(JSON.parse(a)))})},setCrossOrigin:function(a){this.crossOrigin=a},parse:function(a){var b=new THREE.BufferGeometry,c=a.attributes,d=a.offsets;a=a.boundingSphere;for(var e in c){var f=c[e];b.attributes[e]={itemSize:f.itemSize,array:new self[f.type](f.array)}}return void 0!==d&&(b.offsets=JSON.parse(JSON.stringify(d))),void 0!==a&&(b.boundingSphere=new THREE.Sphere((new THREE.Vector3).fromArray(void 0!==a.center?a.center:[0,0,0]),a.radius)),b}},THREE.Geometry2Loader=function(a){this.manager=void 0!==a?a:THREE.DefaultLoadingManager},THREE.Geometry2Loader.prototype={constructor:THREE.Geometry2Loader,load:function(a,b,c){var d=this;c=new THREE.XHRLoader,c.setCrossOrigin(this.crossOrigin),c.load(a,function(a){b(d.parse(JSON.parse(a)))})},setCrossOrigin:function(a){this.crossOrigin=a},parse:function(a){var b,c=new THREE.Geometry2(a.vertices.length/3),d=["vertices","normals","uvs"],e=a.boundingSphere;for(b in d){var f=d[b];c[f].set(a[f])}return void 0!==e&&(c.boundingSphere=new THREE.Sphere((new THREE.Vector3).fromArray(void 0!==e.center?e.center:[0,0,0]),e.radius)),c}},THREE.MaterialLoader=function(a){this.manager=void 0!==a?a:THREE.DefaultLoadingManager},THREE.MaterialLoader.prototype={constructor:THREE.MaterialLoader,load:function(a,b,c){var d=this;c=new THREE.XHRLoader,c.setCrossOrigin(this.crossOrigin),c.load(a,function(a){b(d.parse(JSON.parse(a)))})},setCrossOrigin:function(a){this.crossOrigin=a},parse:function(a){var b=new THREE[a.type];if(void 0!==a.color&&b.color.setHex(a.color),void 0!==a.ambient&&b.ambient.setHex(a.ambient),void 0!==a.emissive&&b.emissive.setHex(a.emissive),void 0!==a.specular&&b.specular.setHex(a.specular),void 0!==a.shininess&&(b.shininess=a.shininess),void 0!==a.vertexColors&&(b.vertexColors=a.vertexColors),void 0!==a.blending&&(b.blending=a.blending),void 0!==a.side&&(b.side=a.side),void 0!==a.opacity&&(b.opacity=a.opacity),void 0!==a.transparent&&(b.transparent=a.transparent),void 0!==a.wireframe&&(b.wireframe=a.wireframe),void 0!==a.materials)for(var c=0,d=a.materials.length;d>c;c++)b.materials.push(this.parse(a.materials[c]));return b}},THREE.ObjectLoader=function(a){this.manager=void 0!==a?a:THREE.DefaultLoadingManager},THREE.ObjectLoader.prototype={constructor:THREE.ObjectLoader,load:function(a,b,c){var d=this;c=new THREE.XHRLoader(d.manager),c.setCrossOrigin(this.crossOrigin),c.load(a,function(a){b(d.parse(JSON.parse(a)))})},setCrossOrigin:function(a){this.crossOrigin=a},parse:function(a){var b=this.parseGeometries(a.geometries),c=this.parseMaterials(a.materials);return this.parseObject(a.object,b,c)},parseGeometries:function(a){var b={};if(void 0!==a)for(var c=new THREE.JSONLoader,d=new THREE.Geometry2Loader,e=new THREE.BufferGeometryLoader,f=0,g=a.length;g>f;f++){var h,i=a[f];switch(i.type){case"PlaneGeometry":h=new THREE.PlaneGeometry(i.width,i.height,i.widthSegments,i.heightSegments);break;case"BoxGeometry":case"CubeGeometry":h=new THREE.BoxGeometry(i.width,i.height,i.depth,i.widthSegments,i.heightSegments,i.depthSegments);break;case"CircleGeometry":h=new THREE.CircleGeometry(i.radius,i.segments);break;case"CylinderGeometry":h=new THREE.CylinderGeometry(i.radiusTop,i.radiusBottom,i.height,i.radialSegments,i.heightSegments,i.openEnded);break;case"SphereGeometry":h=new THREE.SphereGeometry(i.radius,i.widthSegments,i.heightSegments,i.phiStart,i.phiLength,i.thetaStart,i.thetaLength);break;case"IcosahedronGeometry":h=new THREE.IcosahedronGeometry(i.radius,i.detail);break;case"TorusGeometry":h=new THREE.TorusGeometry(i.radius,i.tube,i.radialSegments,i.tubularSegments,i.arc);break;case"TorusKnotGeometry":h=new THREE.TorusKnotGeometry(i.radius,i.tube,i.radialSegments,i.tubularSegments,i.p,i.q,i.heightScale);break;case"BufferGeometry":h=e.parse(i.data);break;case"Geometry2":h=d.parse(i.data);break;case"Geometry":h=c.parse(i.data).geometry}h.uuid=i.uuid,void 0!==i.name&&(h.name=i.name),b[i.uuid]=h}return b},parseMaterials:function(a){var b={};if(void 0!==a)for(var c=new THREE.MaterialLoader,d=0,e=a.length;e>d;d++){var f=a[d],g=c.parse(f);g.uuid=f.uuid,void 0!==f.name&&(g.name=f.name),b[f.uuid]=g}return b},parseObject:function(){var a=new THREE.Matrix4;return function(b,c,d){var e;switch(b.type){case"Scene":e=new THREE.Scene;break;case"PerspectiveCamera":e=new THREE.PerspectiveCamera(b.fov,b.aspect,b.near,b.far);break;case"OrthographicCamera":e=new THREE.OrthographicCamera(b.left,b.right,b.top,b.bottom,b.near,b.far);break;case"AmbientLight":e=new THREE.AmbientLight(b.color);break;case"DirectionalLight":e=new THREE.DirectionalLight(b.color,b.intensity);break;case"PointLight":e=new THREE.PointLight(b.color,b.intensity,b.distance);break;case"SpotLight":e=new THREE.SpotLight(b.color,b.intensity,b.distance,b.angle,b.exponent);break;case"HemisphereLight":e=new THREE.HemisphereLight(b.color,b.groundColor,b.intensity);break;case"Mesh":e=c[b.geometry];var f=d[b.material];void 0===e&&console.error("THREE.ObjectLoader: Undefined geometry "+b.geometry),void 0===f&&console.error("THREE.ObjectLoader: Undefined material "+b.material),e=new THREE.Mesh(e,f);break;case"Sprite":f=d[b.material],void 0===f&&console.error("THREE.ObjectLoader: Undefined material "+b.material),e=new THREE.Sprite(f);break;default:e=new THREE.Object3D}if(e.uuid=b.uuid,void 0!==b.name&&(e.name=b.name),void 0!==b.matrix?(a.fromArray(b.matrix),a.decompose(e.position,e.quaternion,e.scale)):(void 0!==b.position&&e.position.fromArray(b.position),void 0!==b.rotation&&e.rotation.fromArray(b.rotation),void 0!==b.scale&&e.scale.fromArray(b.scale)),void 0!==b.visible&&(e.visible=b.visible),void 0!==b.userData&&(e.userData=b.userData),void 0!==b.children)for(var g in b.children)e.add(this.parseObject(b.children[g],c,d));return e}}()},THREE.SceneLoader=function(){this.onLoadStart=function(){},this.onLoadProgress=function(){},this.onLoadComplete=function(){},this.callbackSync=function(){},this.callbackProgress=function(){},this.geometryHandlers={},this.hierarchyHandlers={},this.addGeometryHandler("ascii",THREE.JSONLoader)},THREE.SceneLoader.prototype={constructor:THREE.SceneLoader,load:function(a,b,c){var d=this;c=new THREE.XHRLoader(d.manager),c.setCrossOrigin(this.crossOrigin),c.load(a,function(c){d.parse(JSON.parse(c),b,a)})},setCrossOrigin:function(a){this.crossOrigin=a},addGeometryHandler:function(a,b){this.geometryHandlers[a]={loaderClass:b}},addHierarchyHandler:function(a,b){this.hierarchyHandlers[a]={loaderClass:b}},parse:function(a,b,c){function d(a,b){return"relativeToHTML"==b?a:z+a}function e(){f(w.scene,B.objects)}function f(a,b){var c,e,g,h,j,k;for(k in b){var l=w.objects[k],p=b[k];if(void 0===l){if(p.type&&p.type in y.hierarchyHandlers){if(void 0===p.loading){c={type:1,url:1,material:1,position:1,rotation:1,scale:1,visible:1,children:1,userData:1,skin:1,morph:1,mirroredLoop:1,duration:1};var q,s={};for(q in p)q in c||(s[q]=p[q]);n=w.materials[p.material],p.loading=!0,c=y.hierarchyHandlers[p.type].loaderObject,c.options?c.load(d(p.url,B.urlBaseType),i(k,a,n,p)):c.load(d(p.url,B.urlBaseType),i(k,a,n,p),s)}}else if(void 0!==p.geometry){if(m=w.geometries[p.geometry]){if(l=!1,n=w.materials[p.material],l=n instanceof THREE.ShaderMaterial,e=p.position,g=p.rotation,h=p.scale,c=p.matrix,j=p.quaternion,p.material||(n=new THREE.MeshFaceMaterial(w.face_materials[p.geometry])),n instanceof THREE.MeshFaceMaterial&&0===n.materials.length&&(n=new THREE.MeshFaceMaterial(w.face_materials[p.geometry])),n instanceof THREE.MeshFaceMaterial)for(s=0;s<n.materials.length;s++)l=l||n.materials[s]instanceof THREE.ShaderMaterial;l&&m.computeTangents(),p.skin?l=new THREE.SkinnedMesh(m,n):p.morph?(l=new THREE.MorphAnimMesh(m,n),void 0!==p.duration&&(l.duration=p.duration),void 0!==p.time&&(l.time=p.time),void 0!==p.mirroredLoop&&(l.mirroredLoop=p.mirroredLoop),n.morphNormals&&m.computeMorphNormals()):l=new THREE.Mesh(m,n),l.name=k,c?(l.matrixAutoUpdate=!1,l.matrix.set(c[0],c[1],c[2],c[3],c[4],c[5],c[6],c[7],c[8],c[9],c[10],c[11],c[12],c[13],c[14],c[15])):(l.position.fromArray(e),j?l.quaternion.fromArray(j):l.rotation.fromArray(g),l.scale.fromArray(h)),l.visible=p.visible,l.castShadow=p.castShadow,l.receiveShadow=p.receiveShadow,a.add(l),w.objects[k]=l}}else if("AmbientLight"===p.type||"PointLight"===p.type||"DirectionalLight"===p.type||"SpotLight"===p.type||"HemisphereLight"===p.type||"AreaLight"===p.type){switch(s=p.color,c=p.intensity,e=p.distance,g=p.position,h=p.rotation,p.type){case"AmbientLight":r=new THREE.AmbientLight(s);break;case"PointLight":r=new THREE.PointLight(s,c,e),r.position.fromArray(g);break;case"DirectionalLight":r=new THREE.DirectionalLight(s,c),r.position.fromArray(p.direction);break;case"SpotLight":r=new THREE.SpotLight(s,c,e,1),r.angle=p.angle,r.position.fromArray(g),r.target.set(g[0],g[1]-e,g[2]),r.target.applyEuler(new THREE.Euler(h[0],h[1],h[2],"XYZ"));break;case"HemisphereLight":r=new THREE.DirectionalLight(s,c,e),r.target.set(g[0],g[1]-e,g[2]),r.target.applyEuler(new THREE.Euler(h[0],h[1],h[2],"XYZ"));break;case"AreaLight":r=new THREE.AreaLight(s,c),r.position.fromArray(g),r.width=p.size,r.height=p.size_y}a.add(r),r.name=k,w.lights[k]=r,w.objects[k]=r}else"PerspectiveCamera"===p.type||"OrthographicCamera"===p.type?(e=p.position,g=p.rotation,j=p.quaternion,"PerspectiveCamera"===p.type?o=new THREE.PerspectiveCamera(p.fov,p.aspect,p.near,p.far):"OrthographicCamera"===p.type&&(o=new THREE.OrthographicCamera(p.left,p.right,p.top,p.bottom,p.near,p.far)),o.name=k,o.position.fromArray(e),void 0!==j?o.quaternion.fromArray(j):void 0!==g&&o.rotation.fromArray(g),a.add(o),w.cameras[k]=o,w.objects[k]=o):(e=p.position,g=p.rotation,h=p.scale,j=p.quaternion,l=new THREE.Object3D,l.name=k,l.position.fromArray(e),j?l.quaternion.fromArray(j):l.rotation.fromArray(g),l.scale.fromArray(h),l.visible=void 0!==p.visible?p.visible:!1,a.add(l),w.objects[k]=l,w.empties[k]=l);if(l){if(void 0!==p.userData)for(var t in p.userData)l.userData[t]=p.userData[t];if(void 0!==p.groups)for(s=0;s<p.groups.length;s++)c=p.groups[s],void 0===w.groups[c]&&(w.groups[c]=[]),w.groups[c].push(k)}}void 0!==l&&void 0!==p.children&&f(l,p.children)}}function g(a,b,c,d,f){var g=f.rotation,h=f.quaternion,i=f.scale;a.position.fromArray(f.position),h?a.quaternion.fromArray(h):a.rotation.fromArray(g),a.scale.fromArray(i),d&&a.traverse(function(a){a.material=d});var j=void 0!==f.visible?f.visible:!0;a.traverse(function(a){a.visible=j}),c.add(a),a.name=b,w.objects[b]=a,e()}function h(a){return function(b,c){b.name=a,w.geometries[a]=b,w.face_materials[a]=c,e(),s-=1,y.onLoadComplete(),k()}}function i(a,b,c,d){return function(e){g(e.content?e.content:e.dae?e.scene:e,a,b,c,d),s-=1,y.onLoadComplete(),k()}}function j(a){return function(b,c){b.name=a,w.geometries[a]=b,w.face_materials[a]=c}}function k(){if(y.callbackProgress({totalModels:u,totalTextures:v,loadedModels:u-s,loadedTextures:v-t},w),y.onLoadProgress(),0===s&&0===t){for(var a=0;a<A.length;a++){var c=A[a],d=w.objects[c.targetName];d?c.object.target=d:(c.object.target=new THREE.Object3D,w.scene.add(c.object.target)),c.object.target.userData.targetInverse=c.object}b(w)}}function l(a,b){if(b(a),void 0!==a.children)for(var c in a.children)l(a.children[c],b)}var m,n,o,p,q,r,s,t,u,v,w,x,y=this,z=THREE.Loader.prototype.extractUrlBase(c),A=[],B=a;for(x in this.geometryHandlers)a=this.geometryHandlers[x].loaderClass,this.geometryHandlers[x].loaderObject=new a;for(x in this.hierarchyHandlers)a=this.hierarchyHandlers[x].loaderClass,this.hierarchyHandlers[x].loaderObject=new a;t=s=0,w={scene:new THREE.Scene,geometries:{},face_materials:{},materials:{},textures:{},objects:{},cameras:{},lights:{},fogs:{},empties:{},groups:{}},B.transform&&(x=B.transform.position,a=B.transform.rotation,c=B.transform.scale,x&&w.scene.position.fromArray(x),a&&w.scene.rotation.fromArray(a),c&&w.scene.scale.fromArray(c),x||a||c)&&(w.scene.updateMatrix(),w.scene.updateMatrixWorld()),x=function(a){return function(){t-=a,k(),y.onLoadComplete()}};for(var C in B.fogs)a=B.fogs[C],"linear"===a.type?p=new THREE.Fog(0,a.near,a.far):"exp2"===a.type&&(p=new THREE.FogExp2(0,a.density)),a=a.color,p.color.setRGB(a[0],a[1],a[2]),w.fogs[C]=p;for(var D in B.geometries)p=B.geometries[D],p.type in this.geometryHandlers&&(s+=1,y.onLoadStart());for(var E in B.objects)l(B.objects[E],function(a){a.type&&a.type in y.hierarchyHandlers&&(s+=1,y.onLoadStart())});u=s;for(D in B.geometries)if(p=B.geometries[D],"cube"===p.type)m=new THREE.BoxGeometry(p.width,p.height,p.depth,p.widthSegments,p.heightSegments,p.depthSegments),m.name=D,w.geometries[D]=m;else if("plane"===p.type)m=new THREE.PlaneGeometry(p.width,p.height,p.widthSegments,p.heightSegments),m.name=D,w.geometries[D]=m;else if("sphere"===p.type)m=new THREE.SphereGeometry(p.radius,p.widthSegments,p.heightSegments),m.name=D,w.geometries[D]=m;else if("cylinder"===p.type)m=new THREE.CylinderGeometry(p.topRad,p.botRad,p.height,p.radSegs,p.heightSegs),m.name=D,w.geometries[D]=m;else if("torus"===p.type)m=new THREE.TorusGeometry(p.radius,p.tube,p.segmentsR,p.segmentsT),m.name=D,w.geometries[D]=m;else if("icosahedron"===p.type)m=new THREE.IcosahedronGeometry(p.radius,p.subdivisions),m.name=D,w.geometries[D]=m;else if(p.type in this.geometryHandlers){E={};for(q in p)"type"!==q&&"url"!==q&&(E[q]=p[q]);this.geometryHandlers[p.type].loaderObject.load(d(p.url,B.urlBaseType),h(D),E)}else"embedded"===p.type&&(E=B.embeds[p.id],E.metadata=B.metadata,E&&(E=this.geometryHandlers.ascii.loaderObject.parse(E,""),j(D)(E.geometry,E.materials)));for(var F in B.textures)if(D=B.textures[F],D.url instanceof Array)for(t+=D.url.length,q=0;q<D.url.length;q++)y.onLoadStart();else t+=1,y.onLoadStart();v=t;for(F in B.textures){if(D=B.textures[F],void 0!==D.mapping&&void 0!==THREE[D.mapping]&&(D.mapping=new THREE[D.mapping]),D.url instanceof Array){for(E=D.url.length,p=[],q=0;E>q;q++)p[q]=d(D.url[q],B.urlBaseType);q=(q=/\.dds$/i.test(p[0]))?THREE.ImageUtils.loadCompressedTextureCube(p,D.mapping,x(E)):THREE.ImageUtils.loadTextureCube(p,D.mapping,x(E))}else q=/\.dds$/i.test(D.url),E=d(D.url,B.urlBaseType),p=x(1),q=q?THREE.ImageUtils.loadCompressedTexture(E,D.mapping,p):THREE.ImageUtils.loadTexture(E,D.mapping,p),void 0!==THREE[D.minFilter]&&(q.minFilter=THREE[D.minFilter]),void 0!==THREE[D.magFilter]&&(q.magFilter=THREE[D.magFilter]),D.anisotropy&&(q.anisotropy=D.anisotropy),D.repeat&&(q.repeat.set(D.repeat[0],D.repeat[1]),1!==D.repeat[0]&&(q.wrapS=THREE.RepeatWrapping),1!==D.repeat[1]&&(q.wrapT=THREE.RepeatWrapping)),D.offset&&q.offset.set(D.offset[0],D.offset[1]),D.wrap&&(E={repeat:THREE.RepeatWrapping,mirror:THREE.MirroredRepeatWrapping},void 0!==E[D.wrap[0]]&&(q.wrapS=E[D.wrap[0]]),void 0!==E[D.wrap[1]]&&(q.wrapT=E[D.wrap[1]]));w.textures[F]=q}var G,H;for(G in B.materials){F=B.materials[G];for(H in F.parameters)"envMap"===H||"map"===H||"lightMap"===H||"bumpMap"===H?F.parameters[H]=w.textures[F.parameters[H]]:"shading"===H?F.parameters[H]="flat"===F.parameters[H]?THREE.FlatShading:THREE.SmoothShading:"side"===H?F.parameters[H]="double"==F.parameters[H]?THREE.DoubleSide:"back"==F.parameters[H]?THREE.BackSide:THREE.FrontSide:"blending"===H?F.parameters[H]=F.parameters[H]in THREE?THREE[F.parameters[H]]:THREE.NormalBlending:"combine"===H?F.parameters[H]=F.parameters[H]in THREE?THREE[F.parameters[H]]:THREE.MultiplyOperation:"vertexColors"===H?"face"==F.parameters[H]?F.parameters[H]=THREE.FaceColors:F.parameters[H]&&(F.parameters[H]=THREE.VertexColors):"wrapRGB"===H&&(x=F.parameters[H],F.parameters[H]=new THREE.Vector3(x[0],x[1],x[2]));void 0!==F.parameters.opacity&&1>F.parameters.opacity&&(F.parameters.transparent=!0),F.parameters.normalMap?(x=THREE.ShaderLib.normalmap,D=THREE.UniformsUtils.clone(x.uniforms),q=F.parameters.color,E=F.parameters.specular,p=F.parameters.ambient,C=F.parameters.shininess,D.tNormal.value=w.textures[F.parameters.normalMap],F.parameters.normalScale&&D.uNormalScale.value.set(F.parameters.normalScale[0],F.parameters.normalScale[1]),F.parameters.map&&(D.tDiffuse.value=F.parameters.map,D.enableDiffuse.value=!0),F.parameters.envMap&&(D.tCube.value=F.parameters.envMap,D.enableReflection.value=!0,D.reflectivity.value=F.parameters.reflectivity),F.parameters.lightMap&&(D.tAO.value=F.parameters.lightMap,D.enableAO.value=!0),F.parameters.specularMap&&(D.tSpecular.value=w.textures[F.parameters.specularMap],D.enableSpecular.value=!0),F.parameters.displacementMap&&(D.tDisplacement.value=w.textures[F.parameters.displacementMap],D.enableDisplacement.value=!0,D.uDisplacementBias.value=F.parameters.displacementBias,D.uDisplacementScale.value=F.parameters.displacementScale),D.diffuse.value.setHex(q),D.specular.value.setHex(E),D.ambient.value.setHex(p),D.shininess.value=C,F.parameters.opacity&&(D.opacity.value=F.parameters.opacity),n=new THREE.ShaderMaterial({fragmentShader:x.fragmentShader,vertexShader:x.vertexShader,uniforms:D,lights:!0,fog:!0})):n=new THREE[F.type](F.parameters),n.name=G,w.materials[G]=n}for(G in B.materials)if(F=B.materials[G],F.parameters.materials){for(H=[],q=0;q<F.parameters.materials.length;q++)H.push(w.materials[F.parameters.materials[q]]);w.materials[G].materials=H}e(),w.cameras&&B.defaults.camera&&(w.currentCamera=w.cameras[B.defaults.camera]),w.fogs&&B.defaults.fog&&(w.scene.fog=w.fogs[B.defaults.fog]),y.callbackSync(w),k()}},THREE.TextureLoader=function(a){this.manager=void 0!==a?a:THREE.DefaultLoadingManager},THREE.TextureLoader.prototype={constructor:THREE.TextureLoader,load:function(a,b,c){c=new THREE.ImageLoader(this.manager),c.setCrossOrigin(this.crossOrigin),c.load(a,function(a){a=new THREE.Texture(a),a.needsUpdate=!0,void 0!==b&&b(a)})},setCrossOrigin:function(a){this.crossOrigin=a}},THREE.Material=function(){this.id=THREE.MaterialIdCount++,this.uuid=THREE.Math.generateUUID(),this.name="",this.side=THREE.FrontSide,this.opacity=1,this.transparent=!1,this.blending=THREE.NormalBlending,this.blendSrc=THREE.SrcAlphaFactor,this.blendDst=THREE.OneMinusSrcAlphaFactor,this.blendEquation=THREE.AddEquation,this.depthWrite=this.depthTest=!0,this.polygonOffset=!1,this.overdraw=this.alphaTest=this.polygonOffsetUnits=this.polygonOffsetFactor=0,this.needsUpdate=this.visible=!0},THREE.Material.prototype={constructor:THREE.Material,setValues:function(a){if(void 0!==a)for(var b in a){var c=a[b];if(void 0===c)console.warn("THREE.Material: '"+b+"' parameter is undefined.");else if(b in this){var d=this[b];d instanceof THREE.Color?d.set(c):d instanceof THREE.Vector3&&c instanceof THREE.Vector3?d.copy(c):this[b]="overdraw"==b?Number(c):c}}},clone:function(a){return void 0===a&&(a=new THREE.Material),a.name=this.name,a.side=this.side,a.opacity=this.opacity,a.transparent=this.transparent,a.blending=this.blending,a.blendSrc=this.blendSrc,a.blendDst=this.blendDst,a.blendEquation=this.blendEquation,a.depthTest=this.depthTest,a.depthWrite=this.depthWrite,a.polygonOffset=this.polygonOffset,a.polygonOffsetFactor=this.polygonOffsetFactor,a.polygonOffsetUnits=this.polygonOffsetUnits,a.alphaTest=this.alphaTest,a.overdraw=this.overdraw,a.visible=this.visible,a},dispose:function(){this.dispatchEvent({type:"dispose"})}},THREE.EventDispatcher.prototype.apply(THREE.Material.prototype),THREE.MaterialIdCount=0,THREE.LineBasicMaterial=function(a){THREE.Material.call(this),this.color=new THREE.Color(16777215),this.linewidth=1,this.linejoin=this.linecap="round",this.vertexColors=!1,this.fog=!0,this.setValues(a)},THREE.LineBasicMaterial.prototype=Object.create(THREE.Material.prototype),THREE.LineBasicMaterial.prototype.clone=function(){var a=new THREE.LineBasicMaterial;return THREE.Material.prototype.clone.call(this,a),a.color.copy(this.color),a.linewidth=this.linewidth,a.linecap=this.linecap,a.linejoin=this.linejoin,a.vertexColors=this.vertexColors,a.fog=this.fog,a},THREE.LineDashedMaterial=function(a){THREE.Material.call(this),this.color=new THREE.Color(16777215),this.scale=this.linewidth=1,this.dashSize=3,this.gapSize=1,this.vertexColors=!1,this.fog=!0,this.setValues(a)},THREE.LineDashedMaterial.prototype=Object.create(THREE.Material.prototype),THREE.LineDashedMaterial.prototype.clone=function(){var a=new THREE.LineDashedMaterial;return THREE.Material.prototype.clone.call(this,a),a.color.copy(this.color),a.linewidth=this.linewidth,a.scale=this.scale,a.dashSize=this.dashSize,a.gapSize=this.gapSize,a.vertexColors=this.vertexColors,a.fog=this.fog,a},THREE.MeshBasicMaterial=function(a){THREE.Material.call(this),this.color=new THREE.Color(16777215),this.envMap=this.specularMap=this.lightMap=this.map=null,this.combine=THREE.MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.fog=!0,this.shading=THREE.SmoothShading,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinejoin=this.wireframeLinecap="round",this.vertexColors=THREE.NoColors,this.morphTargets=this.skinning=!1,this.setValues(a)},THREE.MeshBasicMaterial.prototype=Object.create(THREE.Material.prototype),THREE.MeshBasicMaterial.prototype.clone=function(){var a=new THREE.MeshBasicMaterial;return THREE.Material.prototype.clone.call(this,a),a.color.copy(this.color),a.map=this.map,a.lightMap=this.lightMap,a.specularMap=this.specularMap,a.envMap=this.envMap,a.combine=this.combine,a.reflectivity=this.reflectivity,a.refractionRatio=this.refractionRatio,a.fog=this.fog,a.shading=this.shading,a.wireframe=this.wireframe,a.wireframeLinewidth=this.wireframeLinewidth,a.wireframeLinecap=this.wireframeLinecap,a.wireframeLinejoin=this.wireframeLinejoin,a.vertexColors=this.vertexColors,a.skinning=this.skinning,a.morphTargets=this.morphTargets,a},THREE.MeshLambertMaterial=function(a){THREE.Material.call(this),this.color=new THREE.Color(16777215),this.ambient=new THREE.Color(16777215),this.emissive=new THREE.Color(0),this.wrapAround=!1,this.wrapRGB=new THREE.Vector3(1,1,1),this.envMap=this.specularMap=this.lightMap=this.map=null,this.combine=THREE.MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.fog=!0,this.shading=THREE.SmoothShading,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinejoin=this.wireframeLinecap="round",this.vertexColors=THREE.NoColors,this.morphNormals=this.morphTargets=this.skinning=!1,this.setValues(a)},THREE.MeshLambertMaterial.prototype=Object.create(THREE.Material.prototype),THREE.MeshLambertMaterial.prototype.clone=function(){var a=new THREE.MeshLambertMaterial;return THREE.Material.prototype.clone.call(this,a),a.color.copy(this.color),a.ambient.copy(this.ambient),a.emissive.copy(this.emissive),a.wrapAround=this.wrapAround,a.wrapRGB.copy(this.wrapRGB),a.map=this.map,a.lightMap=this.lightMap,a.specularMap=this.specularMap,a.envMap=this.envMap,a.combine=this.combine,a.reflectivity=this.reflectivity,a.refractionRatio=this.refractionRatio,a.fog=this.fog,a.shading=this.shading,a.wireframe=this.wireframe,a.wireframeLinewidth=this.wireframeLinewidth,a.wireframeLinecap=this.wireframeLinecap,a.wireframeLinejoin=this.wireframeLinejoin,a.vertexColors=this.vertexColors,a.skinning=this.skinning,a.morphTargets=this.morphTargets,a.morphNormals=this.morphNormals,a},THREE.MeshPhongMaterial=function(a){THREE.Material.call(this),this.color=new THREE.Color(16777215),this.ambient=new THREE.Color(16777215),this.emissive=new THREE.Color(0),this.specular=new THREE.Color(1118481),this.shininess=30,this.wrapAround=this.metal=!1,this.wrapRGB=new THREE.Vector3(1,1,1),this.bumpMap=this.lightMap=this.map=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new THREE.Vector2(1,1),this.envMap=this.specularMap=null,this.combine=THREE.MultiplyOperation,this.reflectivity=1,this.refractionRatio=.98,this.fog=!0,this.shading=THREE.SmoothShading,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinejoin=this.wireframeLinecap="round",this.vertexColors=THREE.NoColors,this.morphNormals=this.morphTargets=this.skinning=!1,this.setValues(a)},THREE.MeshPhongMaterial.prototype=Object.create(THREE.Material.prototype),THREE.MeshPhongMaterial.prototype.clone=function(){var a=new THREE.MeshPhongMaterial;return THREE.Material.prototype.clone.call(this,a),a.color.copy(this.color),a.ambient.copy(this.ambient),a.emissive.copy(this.emissive),a.specular.copy(this.specular),a.shininess=this.shininess,a.metal=this.metal,a.wrapAround=this.wrapAround,a.wrapRGB.copy(this.wrapRGB),a.map=this.map,a.lightMap=this.lightMap,a.bumpMap=this.bumpMap,a.bumpScale=this.bumpScale,a.normalMap=this.normalMap,a.normalScale.copy(this.normalScale),a.specularMap=this.specularMap,a.envMap=this.envMap,a.combine=this.combine,a.reflectivity=this.reflectivity,a.refractionRatio=this.refractionRatio,a.fog=this.fog,a.shading=this.shading,a.wireframe=this.wireframe,a.wireframeLinewidth=this.wireframeLinewidth,a.wireframeLinecap=this.wireframeLinecap,a.wireframeLinejoin=this.wireframeLinejoin,a.vertexColors=this.vertexColors,a.skinning=this.skinning,a.morphTargets=this.morphTargets,a.morphNormals=this.morphNormals,a},THREE.MeshDepthMaterial=function(a){THREE.Material.call(this),this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(a)},THREE.MeshDepthMaterial.prototype=Object.create(THREE.Material.prototype),THREE.MeshDepthMaterial.prototype.clone=function(){var a=new THREE.MeshDepthMaterial;return THREE.Material.prototype.clone.call(this,a),a.wireframe=this.wireframe,a.wireframeLinewidth=this.wireframeLinewidth,a},THREE.MeshNormalMaterial=function(a){THREE.Material.call(this,a),this.shading=THREE.FlatShading,this.wireframe=!1,this.wireframeLinewidth=1,this.morphTargets=!1,this.setValues(a)},THREE.MeshNormalMaterial.prototype=Object.create(THREE.Material.prototype),THREE.MeshNormalMaterial.prototype.clone=function(){var a=new THREE.MeshNormalMaterial;return THREE.Material.prototype.clone.call(this,a),a.shading=this.shading,a.wireframe=this.wireframe,a.wireframeLinewidth=this.wireframeLinewidth,a},THREE.MeshFaceMaterial=function(a){this.materials=a instanceof Array?a:[]},THREE.MeshFaceMaterial.prototype.clone=function(){for(var a=new THREE.MeshFaceMaterial,b=0;b<this.materials.length;b++)a.materials.push(this.materials[b].clone());return a},THREE.ParticleSystemMaterial=function(a){THREE.Material.call(this),this.color=new THREE.Color(16777215),this.map=null,this.size=1,this.sizeAttenuation=!0,this.vertexColors=!1,this.fog=!0,this.setValues(a)},THREE.ParticleSystemMaterial.prototype=Object.create(THREE.Material.prototype),THREE.ParticleSystemMaterial.prototype.clone=function(){var a=new THREE.ParticleSystemMaterial;return THREE.Material.prototype.clone.call(this,a),a.color.copy(this.color),a.map=this.map,a.size=this.size,a.sizeAttenuation=this.sizeAttenuation,a.vertexColors=this.vertexColors,a.fog=this.fog,a},THREE.ParticleBasicMaterial=THREE.ParticleSystemMaterial,THREE.ShaderMaterial=function(a){THREE.Material.call(this),this.vertexShader=this.fragmentShader="void main() {}",this.uniforms={},this.defines={},this.attributes=null,this.shading=THREE.SmoothShading,this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.lights=this.fog=!1,this.vertexColors=THREE.NoColors,this.morphNormals=this.morphTargets=this.skinning=!1,this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName="position",this.setValues(a)},THREE.ShaderMaterial.prototype=Object.create(THREE.Material.prototype),THREE.ShaderMaterial.prototype.clone=function(){var a=new THREE.ShaderMaterial;return THREE.Material.prototype.clone.call(this,a),a.fragmentShader=this.fragmentShader,a.vertexShader=this.vertexShader,a.uniforms=THREE.UniformsUtils.clone(this.uniforms),a.attributes=this.attributes,a.defines=this.defines,a.shading=this.shading,a.wireframe=this.wireframe,a.wireframeLinewidth=this.wireframeLinewidth,a.fog=this.fog,a.lights=this.lights,a.vertexColors=this.vertexColors,a.skinning=this.skinning,a.morphTargets=this.morphTargets,a.morphNormals=this.morphNormals,a},THREE.SpriteMaterial=function(a){THREE.Material.call(this),this.color=new THREE.Color(16777215),this.map=null,this.rotation=0,this.fog=!1,this.setValues(a)},THREE.SpriteMaterial.prototype=Object.create(THREE.Material.prototype),THREE.SpriteMaterial.prototype.clone=function(){var a=new THREE.SpriteMaterial;
return THREE.Material.prototype.clone.call(this,a),a.color.copy(this.color),a.map=this.map,a.rotation=this.rotation,a.fog=this.fog,a},THREE.SpriteCanvasMaterial=function(a){THREE.Material.call(this),this.color=new THREE.Color(16777215),this.program=function(){},this.setValues(a)},THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype),THREE.SpriteCanvasMaterial.prototype.clone=function(){var a=new THREE.SpriteCanvasMaterial;return THREE.Material.prototype.clone.call(this,a),a.color.copy(this.color),a.program=this.program,a},THREE.ParticleCanvasMaterial=THREE.SpriteCanvasMaterial,THREE.Texture=function(a,b,c,d,e,f,g,h,i){this.id=THREE.TextureIdCount++,this.uuid=THREE.Math.generateUUID(),this.name="",this.image=a,this.mipmaps=[],this.mapping=void 0!==b?b:new THREE.UVMapping,this.wrapS=void 0!==c?c:THREE.ClampToEdgeWrapping,this.wrapT=void 0!==d?d:THREE.ClampToEdgeWrapping,this.magFilter=void 0!==e?e:THREE.LinearFilter,this.minFilter=void 0!==f?f:THREE.LinearMipMapLinearFilter,this.anisotropy=void 0!==i?i:1,this.format=void 0!==g?g:THREE.RGBAFormat,this.type=void 0!==h?h:THREE.UnsignedByteType,this.offset=new THREE.Vector2(0,0),this.repeat=new THREE.Vector2(1,1),this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this._needsUpdate=!1,this.onUpdate=null},THREE.Texture.prototype={constructor:THREE.Texture,get needsUpdate(){return this._needsUpdate},set needsUpdate(a){!0===a&&this.update(),this._needsUpdate=a},clone:function(a){return void 0===a&&(a=new THREE.Texture),a.image=this.image,a.mipmaps=this.mipmaps.slice(0),a.mapping=this.mapping,a.wrapS=this.wrapS,a.wrapT=this.wrapT,a.magFilter=this.magFilter,a.minFilter=this.minFilter,a.anisotropy=this.anisotropy,a.format=this.format,a.type=this.type,a.offset.copy(this.offset),a.repeat.copy(this.repeat),a.generateMipmaps=this.generateMipmaps,a.premultiplyAlpha=this.premultiplyAlpha,a.flipY=this.flipY,a.unpackAlignment=this.unpackAlignment,a},update:function(){this.dispatchEvent({type:"update"})},dispose:function(){this.dispatchEvent({type:"dispose"})}},THREE.EventDispatcher.prototype.apply(THREE.Texture.prototype),THREE.TextureIdCount=0,THREE.CompressedTexture=function(a,b,c,d,e,f,g,h,i,j,k){THREE.Texture.call(this,null,f,g,h,i,j,d,e,k),this.image={width:b,height:c},this.mipmaps=a,this.generateMipmaps=!1},THREE.CompressedTexture.prototype=Object.create(THREE.Texture.prototype),THREE.CompressedTexture.prototype.clone=function(){var a=new THREE.CompressedTexture;return THREE.Texture.prototype.clone.call(this,a),a},THREE.DataTexture=function(a,b,c,d,e,f,g,h,i,j,k){THREE.Texture.call(this,null,f,g,h,i,j,d,e,k),this.image={data:a,width:b,height:c}},THREE.DataTexture.prototype=Object.create(THREE.Texture.prototype),THREE.DataTexture.prototype.clone=function(){var a=new THREE.DataTexture;return THREE.Texture.prototype.clone.call(this,a),a},THREE.ParticleSystem=function(a,b){THREE.Object3D.call(this),this.geometry=void 0!==a?a:new THREE.Geometry,this.material=void 0!==b?b:new THREE.ParticleSystemMaterial({color:16777215*Math.random()}),this.frustumCulled=this.sortParticles=!1},THREE.ParticleSystem.prototype=Object.create(THREE.Object3D.prototype),THREE.ParticleSystem.prototype.clone=function(a){return void 0===a&&(a=new THREE.ParticleSystem(this.geometry,this.material)),a.sortParticles=this.sortParticles,THREE.Object3D.prototype.clone.call(this,a),a},THREE.Line=function(a,b,c){THREE.Object3D.call(this),this.geometry=void 0!==a?a:new THREE.Geometry,this.material=void 0!==b?b:new THREE.LineBasicMaterial({color:16777215*Math.random()}),this.type=void 0!==c?c:THREE.LineStrip},THREE.LineStrip=0,THREE.LinePieces=1,THREE.Line.prototype=Object.create(THREE.Object3D.prototype),THREE.Line.prototype.clone=function(a){return void 0===a&&(a=new THREE.Line(this.geometry,this.material,this.type)),THREE.Object3D.prototype.clone.call(this,a),a},THREE.Mesh=function(a,b){THREE.Object3D.call(this),this.geometry=void 0!==a?a:new THREE.Geometry,this.material=void 0!==b?b:new THREE.MeshBasicMaterial({color:16777215*Math.random()}),this.updateMorphTargets()},THREE.Mesh.prototype=Object.create(THREE.Object3D.prototype),THREE.Mesh.prototype.updateMorphTargets=function(){if(void 0!==this.geometry.morphTargets&&0<this.geometry.morphTargets.length){this.morphTargetBase=-1,this.morphTargetForcedOrder=[],this.morphTargetInfluences=[],this.morphTargetDictionary={};for(var a=0,b=this.geometry.morphTargets.length;b>a;a++)this.morphTargetInfluences.push(0),this.morphTargetDictionary[this.geometry.morphTargets[a].name]=a}},THREE.Mesh.prototype.getMorphTargetIndexByName=function(a){return void 0!==this.morphTargetDictionary[a]?this.morphTargetDictionary[a]:(console.log("THREE.Mesh.getMorphTargetIndexByName: morph target "+a+" does not exist. Returning 0."),0)},THREE.Mesh.prototype.clone=function(a){return void 0===a&&(a=new THREE.Mesh(this.geometry,this.material)),THREE.Object3D.prototype.clone.call(this,a),a},THREE.Bone=function(a){THREE.Object3D.call(this),this.skin=a,this.skinMatrix=new THREE.Matrix4},THREE.Bone.prototype=Object.create(THREE.Object3D.prototype),THREE.Bone.prototype.update=function(a,b){this.matrixAutoUpdate&&(b|=this.updateMatrix()),(b||this.matrixWorldNeedsUpdate)&&(a?this.skinMatrix.multiplyMatrices(a,this.matrix):this.skinMatrix.copy(this.matrix),this.matrixWorldNeedsUpdate=!1,b=!0);var c,d=this.children.length;for(c=0;d>c;c++)this.children[c].update(this.skinMatrix,b)},THREE.SkinnedMesh=function(a,b,c){THREE.Mesh.call(this,a,b),this.useVertexTexture=void 0!==c?c:!0,this.identityMatrix=new THREE.Matrix4,this.bones=[],this.boneMatrices=[];var d,e,f;if(this.geometry&&void 0!==this.geometry.bones){for(a=0;a<this.geometry.bones.length;a++)c=this.geometry.bones[a],d=c.pos,e=c.rotq,f=c.scl,b=this.addBone(),b.name=c.name,b.position.set(d[0],d[1],d[2]),b.quaternion.set(e[0],e[1],e[2],e[3]),void 0!==f?b.scale.set(f[0],f[1],f[2]):b.scale.set(1,1,1);for(a=0;a<this.bones.length;a++)c=this.geometry.bones[a],b=this.bones[a],-1===c.parent?this.add(b):this.bones[c.parent].add(b);a=this.bones.length,this.useVertexTexture?(this.boneTextureHeight=this.boneTextureWidth=a=a>256?64:a>64?32:a>16?16:8,this.boneMatrices=new Float32Array(this.boneTextureWidth*this.boneTextureHeight*4),this.boneTexture=new THREE.DataTexture(this.boneMatrices,this.boneTextureWidth,this.boneTextureHeight,THREE.RGBAFormat,THREE.FloatType),this.boneTexture.minFilter=THREE.NearestFilter,this.boneTexture.magFilter=THREE.NearestFilter,this.boneTexture.generateMipmaps=!1,this.boneTexture.flipY=!1):this.boneMatrices=new Float32Array(16*a),this.pose()}},THREE.SkinnedMesh.prototype=Object.create(THREE.Mesh.prototype),THREE.SkinnedMesh.prototype.addBone=function(a){return void 0===a&&(a=new THREE.Bone(this)),this.bones.push(a),a},THREE.SkinnedMesh.prototype.updateMatrixWorld=function(){var a=new THREE.Matrix4;return function(b){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||b)&&(this.parent?this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix):this.matrixWorld.copy(this.matrix),this.matrixWorldNeedsUpdate=!1),b=0;for(var c=this.children.length;c>b;b++){var d=this.children[b];d instanceof THREE.Bone?d.update(this.identityMatrix,!1):d.updateMatrixWorld(!0)}if(void 0==this.boneInverses)for(this.boneInverses=[],b=0,c=this.bones.length;c>b;b++)d=new THREE.Matrix4,d.getInverse(this.bones[b].skinMatrix),this.boneInverses.push(d);for(b=0,c=this.bones.length;c>b;b++)a.multiplyMatrices(this.bones[b].skinMatrix,this.boneInverses[b]),a.flattenToArrayOffset(this.boneMatrices,16*b);this.useVertexTexture&&(this.boneTexture.needsUpdate=!0)}}(),THREE.SkinnedMesh.prototype.pose=function(){this.updateMatrixWorld(!0),this.normalizeSkinWeights()},THREE.SkinnedMesh.prototype.normalizeSkinWeights=function(){if(this.geometry instanceof THREE.Geometry)for(var a=0;a<this.geometry.skinIndices.length;a++){var b=this.geometry.skinWeights[a],c=1/b.lengthManhattan();1/0!==c?b.multiplyScalar(c):b.set(1)}},THREE.SkinnedMesh.prototype.clone=function(a){return void 0===a&&(a=new THREE.SkinnedMesh(this.geometry,this.material,this.useVertexTexture)),THREE.Mesh.prototype.clone.call(this,a),a},THREE.MorphAnimMesh=function(a,b){THREE.Mesh.call(this,a,b),this.duration=1e3,this.mirroredLoop=!1,this.currentKeyframe=this.lastKeyframe=this.time=0,this.direction=1,this.directionBackwards=!1,this.setFrameRange(0,this.geometry.morphTargets.length-1)},THREE.MorphAnimMesh.prototype=Object.create(THREE.Mesh.prototype),THREE.MorphAnimMesh.prototype.setFrameRange=function(a,b){this.startKeyframe=a,this.endKeyframe=b,this.length=this.endKeyframe-this.startKeyframe+1},THREE.MorphAnimMesh.prototype.setDirectionForward=function(){this.direction=1,this.directionBackwards=!1},THREE.MorphAnimMesh.prototype.setDirectionBackward=function(){this.direction=-1,this.directionBackwards=!0},THREE.MorphAnimMesh.prototype.parseAnimations=function(){var a=this.geometry;a.animations||(a.animations={});for(var b,c=a.animations,d=/([a-z]+)(\d+)/,e=0,f=a.morphTargets.length;f>e;e++){var g=a.morphTargets[e].name.match(d);if(g&&1<g.length){g=g[1],c[g]||(c[g]={start:1/0,end:-1/0});var h=c[g];e<h.start&&(h.start=e),e>h.end&&(h.end=e),b||(b=g)}}a.firstAnimation=b},THREE.MorphAnimMesh.prototype.setAnimationLabel=function(a,b,c){this.geometry.animations||(this.geometry.animations={}),this.geometry.animations[a]={start:b,end:c}},THREE.MorphAnimMesh.prototype.playAnimation=function(a,b){var c=this.geometry.animations[a];c?(this.setFrameRange(c.start,c.end),this.duration=(c.end-c.start)/b*1e3,this.time=0):console.warn("animation["+a+"] undefined")},THREE.MorphAnimMesh.prototype.updateAnimation=function(a){var b=this.duration/this.length;this.time+=this.direction*a,this.mirroredLoop?(this.time>this.duration||0>this.time)&&(this.direction*=-1,this.time>this.duration&&(this.time=this.duration,this.directionBackwards=!0),0>this.time&&(this.time=0,this.directionBackwards=!1)):(this.time%=this.duration,0>this.time&&(this.time+=this.duration)),a=this.startKeyframe+THREE.Math.clamp(Math.floor(this.time/b),0,this.length-1),a!==this.currentKeyframe&&(this.morphTargetInfluences[this.lastKeyframe]=0,this.morphTargetInfluences[this.currentKeyframe]=1,this.morphTargetInfluences[a]=0,this.lastKeyframe=this.currentKeyframe,this.currentKeyframe=a),b=this.time%b/b,this.directionBackwards&&(b=1-b),this.morphTargetInfluences[this.currentKeyframe]=b,this.morphTargetInfluences[this.lastKeyframe]=1-b},THREE.MorphAnimMesh.prototype.clone=function(a){return void 0===a&&(a=new THREE.MorphAnimMesh(this.geometry,this.material)),a.duration=this.duration,a.mirroredLoop=this.mirroredLoop,a.time=this.time,a.lastKeyframe=this.lastKeyframe,a.currentKeyframe=this.currentKeyframe,a.direction=this.direction,a.directionBackwards=this.directionBackwards,THREE.Mesh.prototype.clone.call(this,a),a},THREE.LOD=function(){THREE.Object3D.call(this),this.objects=[]},THREE.LOD.prototype=Object.create(THREE.Object3D.prototype),THREE.LOD.prototype.addLevel=function(a,b){void 0===b&&(b=0),b=Math.abs(b);for(var c=0;c<this.objects.length&&!(b<this.objects[c].distance);c++);this.objects.splice(c,0,{distance:b,object:a}),this.add(a)},THREE.LOD.prototype.getObjectForDistance=function(a){for(var b=1,c=this.objects.length;c>b&&!(a<this.objects[b].distance);b++);return this.objects[b-1].object},THREE.LOD.prototype.update=function(){var a=new THREE.Vector3,b=new THREE.Vector3;return function(c){if(1<this.objects.length){a.setFromMatrixPosition(c.matrixWorld),b.setFromMatrixPosition(this.matrixWorld),c=a.distanceTo(b),this.objects[0].object.visible=!0;for(var d=1,e=this.objects.length;e>d&&c>=this.objects[d].distance;d++)this.objects[d-1].object.visible=!1,this.objects[d].object.visible=!0;for(;e>d;d++)this.objects[d].object.visible=!1}}}(),THREE.LOD.prototype.clone=function(a){void 0===a&&(a=new THREE.LOD),THREE.Object3D.prototype.clone.call(this,a);for(var b=0,c=this.objects.length;c>b;b++){var d=this.objects[b].object.clone();d.visible=0===b,a.addLevel(d,this.objects[b].distance)}return a},THREE.Sprite=function(){var a=new THREE.Geometry2(3);return a.vertices.set([-.5,-.5,0,.5,-.5,0,.5,.5,0]),function(b){THREE.Object3D.call(this),this.geometry=a,this.material=void 0!==b?b:new THREE.SpriteMaterial}}(),THREE.Sprite.prototype=Object.create(THREE.Object3D.prototype),THREE.Sprite.prototype.updateMatrix=function(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},THREE.Sprite.prototype.clone=function(a){return void 0===a&&(a=new THREE.Sprite(this.material)),THREE.Object3D.prototype.clone.call(this,a),a},THREE.Particle=THREE.Sprite,THREE.Scene=function(){THREE.Object3D.call(this),this.overrideMaterial=this.fog=null,this.autoUpdate=!0,this.matrixAutoUpdate=!1,this.__lights=[],this.__objectsAdded=[],this.__objectsRemoved=[]},THREE.Scene.prototype=Object.create(THREE.Object3D.prototype),THREE.Scene.prototype.__addObject=function(a){if(a instanceof THREE.Light)-1===this.__lights.indexOf(a)&&this.__lights.push(a),a.target&&void 0===a.target.parent&&this.add(a.target);else if(!(a instanceof THREE.Camera||a instanceof THREE.Bone)){this.__objectsAdded.push(a);var b=this.__objectsRemoved.indexOf(a);-1!==b&&this.__objectsRemoved.splice(b,1)}for(this.dispatchEvent({type:"objectAdded",object:a}),a.dispatchEvent({type:"addedToScene",scene:this}),b=0;b<a.children.length;b++)this.__addObject(a.children[b])},THREE.Scene.prototype.__removeObject=function(a){if(a instanceof THREE.Light){var b=this.__lights.indexOf(a);if(-1!==b&&this.__lights.splice(b,1),a.shadowCascadeArray)for(b=0;b<a.shadowCascadeArray.length;b++)this.__removeObject(a.shadowCascadeArray[b])}else a instanceof THREE.Camera||(this.__objectsRemoved.push(a),b=this.__objectsAdded.indexOf(a),-1!==b&&this.__objectsAdded.splice(b,1));for(this.dispatchEvent({type:"objectRemoved",object:a}),a.dispatchEvent({type:"removedFromScene",scene:this}),b=0;b<a.children.length;b++)this.__removeObject(a.children[b])},THREE.Scene.prototype.clone=function(a){return void 0===a&&(a=new THREE.Scene),THREE.Object3D.prototype.clone.call(this,a),null!==this.fog&&(a.fog=this.fog.clone()),null!==this.overrideMaterial&&(a.overrideMaterial=this.overrideMaterial.clone()),a.autoUpdate=this.autoUpdate,a.matrixAutoUpdate=this.matrixAutoUpdate,a},THREE.Fog=function(a,b,c){this.name="",this.color=new THREE.Color(a),this.near=void 0!==b?b:1,this.far=void 0!==c?c:1e3},THREE.Fog.prototype.clone=function(){return new THREE.Fog(this.color.getHex(),this.near,this.far)},THREE.FogExp2=function(a,b){this.name="",this.color=new THREE.Color(a),this.density=void 0!==b?b:25e-5},THREE.FogExp2.prototype.clone=function(){return new THREE.FogExp2(this.color.getHex(),this.density)},THREE.CanvasRenderer=function(a){function b(a,b,c){for(var d=0,e=v.length;e>d;d++){var f=v[d];if(ub.copy(f.color),f instanceof THREE.DirectionalLight){var g=Cb.setFromMatrixPosition(f.matrixWorld).normalize(),h=b.dot(g);0>=h||(h*=f.intensity,c.add(ub.multiplyScalar(h)))}else f instanceof THREE.PointLight&&(g=Cb.setFromMatrixPosition(f.matrixWorld),h=b.dot(Cb.subVectors(g,a).normalize()),0>=h||(h*=0==f.distance?1:1-Math.min(a.distanceTo(g)/f.distance,1),0!=h&&(h*=f.intensity,c.add(ub.multiplyScalar(h)))))}}function c(a,b,c,d){m(b),n(c),o(d),p(a.getStyle()),H.stroke(),yb.expandByScalar(2*b)}function d(a){q(a.getStyle()),H.fill()}function e(a){f(a.target)}function f(a){var b=a.wrapS===THREE.RepeatWrapping,c=a.wrapT===THREE.RepeatWrapping,d=a.image,e=document.createElement("canvas");e.width=d.width,e.height=d.height;var f=e.getContext("2d");f.setTransform(1,0,0,-1,0,d.height),f.drawImage(d,0,0),vb[a.id]=H.createPattern(e,!0===b&&!0===c?"repeat":!0===b&&!1===c?"repeat-x":!1===b&&!0===c?"repeat-y":"no-repeat")}function g(a,b,c,d,g,h,i,j,k,l,m,n,o){if(!(o instanceof THREE.DataTexture)){!1===o.hasEventListener("update",e)&&(void 0!==o.image&&0<o.image.width&&f(o),o.addEventListener("update",e));var p=vb[o.id];if(void 0!==p){q(p);var p=o.offset.x/o.repeat.x,r=o.offset.y/o.repeat.y,s=o.image.width*o.repeat.x;o=o.image.height*o.repeat.y,i=(i+p)*s,j=(j+r)*o,c-=a,d-=b,g-=a,h-=b,k=(k+p)*s-i,l=(l+r)*o-j,m=(m+p)*s-i,n=(n+r)*o-j,o=k*n-m*l,0!==o&&(p=1/o,o=(n*c-l*g)*p,l=(n*d-l*h)*p,c=(k*g-m*c)*p,d=(k*h-m*d)*p,a=a-o*i-c*j,b=b-l*i-d*j,H.save(),H.transform(o,l,c,d,a,b),H.fill(),H.restore())}else q("rgba(0,0,0,1)"),H.fill()}}function h(a,b,c,d,e,f,g,h,i,j,k,l,m){var n,o;n=m.width-1,o=m.height-1,g*=n,h*=o,c-=a,d-=b,e-=a,f-=b,i=i*n-g,j=j*o-h,k=k*n-g,l=l*o-h,o=1/(i*l-k*j),n=(l*c-j*e)*o,j=(l*d-j*f)*o,c=(i*e-k*c)*o,d=(i*f-k*d)*o,a=a-n*g-c*h,b=b-j*g-d*h,H.save(),H.transform(n,j,c,d,a,b),H.clip(),H.drawImage(m,0,0),H.restore()}function i(a,b,c,d){return kb[0]=255*a.r|0,kb[1]=255*a.g|0,kb[2]=255*a.b|0,kb[4]=255*b.r|0,kb[5]=255*b.g|0,kb[6]=255*b.b|0,kb[8]=255*c.r|0,kb[9]=255*c.g|0,kb[10]=255*c.b|0,kb[12]=255*d.r|0,kb[13]=255*d.g|0,kb[14]=255*d.b|0,ib.putImageData(jb,0,0),mb.drawImage(hb,0,0),lb}function j(a,b,c){var d=b.x-a.x,e=b.y-a.y,f=d*d+e*e;0!==f&&(c/=Math.sqrt(f),d*=c,e*=c,b.x+=d,b.y+=e,a.x-=d,a.y-=e)}function k(a){K!==a&&(K=H.globalAlpha=a)}function l(a){L!==a&&(a===THREE.NormalBlending?H.globalCompositeOperation="source-over":a===THREE.AdditiveBlending?H.globalCompositeOperation="lighter":a===THREE.SubtractiveBlending&&(H.globalCompositeOperation="darker"),L=a)}function m(a){O!==a&&(O=H.lineWidth=a)}function n(a){P!==a&&(P=H.lineCap=a)}function o(a){Q!==a&&(Q=H.lineJoin=a)}function p(a){M!==a&&(M=H.strokeStyle=a)}function q(a){N!==a&&(N=H.fillStyle=a)}function r(a,b){(R!==a||S!==b)&&(H.setLineDash([a,b]),R=a,S=b)}console.log("THREE.CanvasRenderer",THREE.REVISION);var s=THREE.Math.smoothstep;a=a||{};var t,u,v,w,x,y,z,A=this,B=new THREE.Projector,C=void 0!==a.canvas?a.canvas:document.createElement("canvas"),D=C.width,E=C.height,F=Math.floor(D/2),G=Math.floor(E/2),H=C.getContext("2d"),I=new THREE.Color(0),J=0,K=1,L=0,M=null,N=null,O=null,P=null,Q=null,R=null,S=0;new THREE.RenderableVertex,new THREE.RenderableVertex;var T,U,V,W,X,Y,Z,$,_,ab,bb,cb,db,eb,fb,gb,hb,ib,jb,kb,lb,mb,nb=new THREE.Color,ob=new THREE.Color,pb=new THREE.Color,qb=new THREE.Color,rb=new THREE.Color,sb=new THREE.Color,tb=new THREE.Color,ub=new THREE.Color,vb={},wb=new THREE.Box2,xb=new THREE.Box2,yb=new THREE.Box2,zb=new THREE.Color,Ab=new THREE.Color,Bb=new THREE.Color,Cb=new THREE.Vector3,Db=new THREE.Vector3,Eb=new THREE.Matrix3,Fb=16;hb=document.createElement("canvas"),hb.width=hb.height=2,ib=hb.getContext("2d"),ib.fillStyle="rgba(0,0,0,1)",ib.fillRect(0,0,2,2),jb=ib.getImageData(0,0,2,2),kb=jb.data,lb=document.createElement("canvas"),lb.width=lb.height=Fb,mb=lb.getContext("2d"),mb.translate(-Fb/2,-Fb/2),mb.scale(Fb,Fb),Fb--,void 0===H.setLineDash&&(H.setLineDash=void 0!==H.mozDash?function(a){H.mozDash=null!==a[0]?a:null}:function(){}),this.domElement=C,this.devicePixelRatio=void 0!==a.devicePixelRatio?a.devicePixelRatio:void 0!==self.devicePixelRatio?self.devicePixelRatio:1,this.sortElements=this.sortObjects=this.autoClear=!0,this.info={render:{vertices:0,faces:0}},this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.setSize=function(a,b,c){D=a*this.devicePixelRatio,E=b*this.devicePixelRatio,F=Math.floor(D/2),G=Math.floor(E/2),C.width=D,C.height=E,1!==this.devicePixelRatio&&!1!==c&&(C.style.width=a+"px",C.style.height=b+"px"),wb.min.set(-F,-G),wb.max.set(F,G),xb.min.set(-F,-G),xb.max.set(F,G),K=1,L=0,Q=P=O=N=M=null},this.setClearColor=function(a,b){I.set(a),J=void 0!==b?b:1,xb.min.set(-F,-G),xb.max.set(F,G)},this.setClearColorHex=function(a,b){console.warn("DEPRECATED: .setClearColorHex() is being removed. Use .setClearColor() instead."),this.setClearColor(a,b)},this.getMaxAnisotropy=function(){return 0},this.clear=function(){H.setTransform(1,0,0,-1,F,G),!1===xb.empty()&&(xb.intersect(wb),xb.expandByScalar(2),1>J&&H.clearRect(0|xb.min.x,0|xb.min.y,xb.max.x-xb.min.x|0,xb.max.y-xb.min.y|0),J>0&&(l(THREE.NormalBlending),k(1),q("rgba("+Math.floor(255*I.r)+","+Math.floor(255*I.g)+","+Math.floor(255*I.b)+","+J+")"),H.fillRect(0|xb.min.x,0|xb.min.y,xb.max.x-xb.min.x|0,xb.max.y-xb.min.y|0)),xb.makeEmpty())},this.clearColor=function(){},this.clearDepth=function(){},this.clearStencil=function(){},this.render=function(a,C){if(0==C instanceof THREE.Camera)console.error("THREE.CanvasRenderer.render: camera is not an instance of THREE.Camera.");else{!0===this.autoClear&&this.clear(),H.setTransform(1,0,0,-1,F,G),A.info.render.vertices=0,A.info.render.faces=0,t=B.projectScene(a,C,this.sortObjects,this.sortElements),u=t.elements,v=t.lights,w=C,Eb.getNormalMatrix(C.matrixWorldInverse),zb.setRGB(0,0,0),Ab.setRGB(0,0,0),Bb.setRGB(0,0,0);for(var D=0,E=v.length;E>D;D++){var I=v[D],J=I.color;I instanceof THREE.AmbientLight?zb.add(J):I instanceof THREE.DirectionalLight?Ab.add(J):I instanceof THREE.PointLight&&Bb.add(J)}for(D=0,E=u.length;E>D;D++){var K=u[D],L=K.material;if(void 0!==L&&!1!==L.visible){if(yb.makeEmpty(),K instanceof THREE.RenderableSprite){x=K,x.x*=F,x.y*=G,I=x,J=L,k(J.opacity),l(J.blending);var M=K.scale.x*F,K=K.scale.y*G,L=.5*Math.sqrt(M*M+K*K);if(yb.min.set(I.x-L,I.y-L),yb.max.set(I.x+L,I.y+L),J instanceof THREE.SpriteMaterial||J instanceof THREE.ParticleSystemMaterial){var N=J.map;if(null!==N){!1===N.hasEventListener("update",e)&&(void 0!==N.image&&0<N.image.width&&f(N),N.addEventListener("update",e)),L=vb[N.id],q(void 0!==L?L:"rgba( 0, 0, 0, 1 )");var O=N.image,L=O.width*N.offset.x,P=O.height*N.offset.y,Q=O.width*N.repeat.x,N=O.height*N.repeat.y,O=M/Q,R=K/N;H.save(),H.translate(I.x,I.y),0!==J.rotation&&H.rotate(J.rotation),H.translate(-M/2,-K/2),H.scale(O,R),H.translate(-L,-P),H.fillRect(L,P,Q,N)}else q(J.color.getStyle()),H.save(),H.translate(I.x,I.y),0!==J.rotation&&H.rotate(J.rotation),H.scale(M,-K),H.fillRect(-.5,-.5,1,1);H.restore()}else J instanceof THREE.SpriteCanvasMaterial&&(p(J.color.getStyle()),q(J.color.getStyle()),H.save(),H.translate(I.x,I.y),0!==J.rotation&&H.rotate(J.rotation),H.scale(M,K),J.program(H),H.restore())}else if(K instanceof THREE.RenderableLine){if(x=K.v1,y=K.v2,x.positionScreen.x*=F,x.positionScreen.y*=G,y.positionScreen.x*=F,y.positionScreen.y*=G,yb.setFromPoints([x.positionScreen,y.positionScreen]),!0===wb.isIntersectionBox(yb))if(I=x,J=y,M=K,K=L,k(K.opacity),l(K.blending),H.beginPath(),H.moveTo(I.positionScreen.x,I.positionScreen.y),H.lineTo(J.positionScreen.x,J.positionScreen.y),K instanceof THREE.LineBasicMaterial){if(m(K.linewidth),n(K.linecap),o(K.linejoin),K.vertexColors!==THREE.VertexColors)p(K.color.getStyle());else if(L=M.vertexColors[0].getStyle(),M=M.vertexColors[1].getStyle(),L===M)p(L);else{try{var S=H.createLinearGradient(I.positionScreen.x,I.positionScreen.y,J.positionScreen.x,J.positionScreen.y);S.addColorStop(0,L),S.addColorStop(1,M)}catch(hb){S=L}p(S)}H.stroke(),yb.expandByScalar(2*K.linewidth)}else K instanceof THREE.LineDashedMaterial&&(m(K.linewidth),n(K.linecap),o(K.linejoin),p(K.color.getStyle()),r(K.dashSize,K.gapSize),H.stroke(),yb.expandByScalar(2*K.linewidth),r(null,null))}else if(K instanceof THREE.RenderableFace){if(x=K.v1,y=K.v2,z=K.v3,-1>x.positionScreen.z||1<x.positionScreen.z)continue;if(-1>y.positionScreen.z||1<y.positionScreen.z)continue;if(-1>z.positionScreen.z||1<z.positionScreen.z)continue;if(x.positionScreen.x*=F,x.positionScreen.y*=G,y.positionScreen.x*=F,y.positionScreen.y*=G,z.positionScreen.x*=F,z.positionScreen.y*=G,0<L.overdraw&&(j(x.positionScreen,y.positionScreen,L.overdraw),j(y.positionScreen,z.positionScreen,L.overdraw),j(z.positionScreen,x.positionScreen,L.overdraw)),yb.setFromPoints([x.positionScreen,y.positionScreen,z.positionScreen]),!0===wb.isIntersectionBox(yb)){I=x,J=y,M=z,A.info.render.vertices+=3,A.info.render.faces++,k(L.opacity),l(L.blending),T=I.positionScreen.x,U=I.positionScreen.y,V=J.positionScreen.x,W=J.positionScreen.y,X=M.positionScreen.x,Y=M.positionScreen.y;var P=T,Q=U,N=V,O=W,R=X,ib=Y;H.beginPath(),H.moveTo(P,Q),H.lineTo(N,O),H.lineTo(R,ib),H.closePath(),(L instanceof THREE.MeshLambertMaterial||L instanceof THREE.MeshPhongMaterial)&&null===L.map?(sb.copy(L.color),tb.copy(L.emissive),L.vertexColors===THREE.FaceColors&&sb.multiply(K.color),!1===L.wireframe&&L.shading===THREE.SmoothShading&&3===K.vertexNormalsLength?(ob.copy(zb),pb.copy(zb),qb.copy(zb),b(K.v1.positionWorld,K.vertexNormalsModel[0],ob),b(K.v2.positionWorld,K.vertexNormalsModel[1],pb),b(K.v3.positionWorld,K.vertexNormalsModel[2],qb),ob.multiply(sb).add(tb),pb.multiply(sb).add(tb),qb.multiply(sb).add(tb),rb.addColors(pb,qb).multiplyScalar(.5),_=i(ob,pb,qb,rb),h(T,U,V,W,X,Y,0,0,1,0,0,1,_)):(nb.copy(zb),b(K.centroidModel,K.normalModel,nb),nb.multiply(sb).add(tb),!0===L.wireframe?c(nb,L.wireframeLinewidth,L.wireframeLinecap,L.wireframeLinejoin):d(nb))):L instanceof THREE.MeshBasicMaterial||L instanceof THREE.MeshLambertMaterial||L instanceof THREE.MeshPhongMaterial?null!==L.map?L.map.mapping instanceof THREE.UVMapping&&(ab=K.uvs[0],g(T,U,V,W,X,Y,ab[0].x,ab[0].y,ab[1].x,ab[1].y,ab[2].x,ab[2].y,L.map)):null!==L.envMap?L.envMap.mapping instanceof THREE.SphericalReflectionMapping&&(Db.copy(K.vertexNormalsModel[0]).applyMatrix3(Eb),bb=.5*Db.x+.5,cb=.5*Db.y+.5,Db.copy(K.vertexNormalsModel[1]).applyMatrix3(Eb),db=.5*Db.x+.5,eb=.5*Db.y+.5,Db.copy(K.vertexNormalsModel[2]).applyMatrix3(Eb),fb=.5*Db.x+.5,gb=.5*Db.y+.5,g(T,U,V,W,X,Y,bb,cb,db,eb,fb,gb,L.envMap)):(nb.copy(L.color),L.vertexColors===THREE.FaceColors&&nb.multiply(K.color),!0===L.wireframe?c(nb,L.wireframeLinewidth,L.wireframeLinecap,L.wireframeLinejoin):d(nb)):L instanceof THREE.MeshDepthMaterial?(Z=w.near,$=w.far,ob.r=ob.g=ob.b=1-s(I.positionScreen.z*I.positionScreen.w,Z,$),pb.r=pb.g=pb.b=1-s(J.positionScreen.z*J.positionScreen.w,Z,$),qb.r=qb.g=qb.b=1-s(M.positionScreen.z*M.positionScreen.w,Z,$),rb.addColors(pb,qb).multiplyScalar(.5),_=i(ob,pb,qb,rb),h(T,U,V,W,X,Y,0,0,1,0,0,1,_)):L instanceof THREE.MeshNormalMaterial&&(L.shading===THREE.FlatShading?(Db.copy(K.normalModel).applyMatrix3(Eb),nb.setRGB(Db.x,Db.y,Db.z).multiplyScalar(.5).addScalar(.5),!0===L.wireframe?c(nb,L.wireframeLinewidth,L.wireframeLinecap,L.wireframeLinejoin):d(nb)):L.shading===THREE.SmoothShading&&(Db.copy(K.vertexNormalsModel[0]).applyMatrix3(Eb),ob.setRGB(Db.x,Db.y,Db.z).multiplyScalar(.5).addScalar(.5),Db.copy(K.vertexNormalsModel[1]).applyMatrix3(Eb),pb.setRGB(Db.x,Db.y,Db.z).multiplyScalar(.5).addScalar(.5),Db.copy(K.vertexNormalsModel[2]).applyMatrix3(Eb),qb.setRGB(Db.x,Db.y,Db.z).multiplyScalar(.5).addScalar(.5),rb.addColors(pb,qb).multiplyScalar(.5),_=i(ob,pb,qb,rb),h(T,U,V,W,X,Y,0,0,1,0,0,1,_)))}}xb.union(yb)}}H.setTransform(1,0,0,1,0,0)}}},THREE.ShaderChunk={fog_pars_fragment:"#ifdef USE_FOG\nuniform vec3 fogColor;\n#ifdef FOG_EXP2\nuniform float fogDensity;\n#else\nuniform float fogNear;\nuniform float fogFar;\n#endif\n#endif",fog_fragment:"#ifdef USE_FOG\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n#ifdef FOG_EXP2\nconst float LOG2 = 1.442695;\nfloat fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );\nfogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );\n#else\nfloat fogFactor = smoothstep( fogNear, fogFar, depth );\n#endif\ngl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );\n#endif",envmap_pars_fragment:"#ifdef USE_ENVMAP\nuniform float reflectivity;\nuniform samplerCube envMap;\nuniform float flipEnvMap;\nuniform int combine;\n#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\nuniform bool useRefract;\nuniform float refractionRatio;\n#else\nvarying vec3 vReflect;\n#endif\n#endif",envmap_fragment:"#ifdef USE_ENVMAP\nvec3 reflectVec;\n#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\nvec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );\nif ( useRefract ) {\nreflectVec = refract( cameraToVertex, normal, refractionRatio );\n} else { \nreflectVec = reflect( cameraToVertex, normal );\n}\n#else\nreflectVec = vReflect;\n#endif\n#ifdef DOUBLE_SIDED\nfloat flipNormal = ( -1.0 + 2.0 * float( gl_FrontFacing ) );\nvec4 cubeColor = textureCube( envMap, flipNormal * vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n#else\nvec4 cubeColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n#endif\n#ifdef GAMMA_INPUT\ncubeColor.xyz *= cubeColor.xyz;\n#endif\nif ( combine == 1 ) {\ngl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularStrength * reflectivity );\n} else if ( combine == 2 ) {\ngl_FragColor.xyz += cubeColor.xyz * specularStrength * reflectivity;\n} else {\ngl_FragColor.xyz = mix( gl_FragColor.xyz, gl_FragColor.xyz * cubeColor.xyz, specularStrength * reflectivity );\n}\n#endif",envmap_pars_vertex:"#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP )\nvarying vec3 vReflect;\nuniform float refractionRatio;\nuniform bool useRefract;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( PHONG ) || defined( LAMBERT ) || defined ( USE_SHADOWMAP )\n#ifdef USE_SKINNING\nvec4 worldPosition = modelMatrix * skinned;\n#endif\n#if defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )\nvec4 worldPosition = modelMatrix * vec4( morphed, 1.0 );\n#endif\n#if ! defined( USE_MORPHTARGETS ) && ! defined( USE_SKINNING )\nvec4 worldPosition = modelMatrix * vec4( position, 1.0 );\n#endif\n#endif",envmap_vertex:"#if defined( USE_ENVMAP ) && ! defined( USE_BUMPMAP ) && ! defined( USE_NORMALMAP )\nvec3 worldNormal = mat3( modelMatrix[ 0 ].xyz, modelMatrix[ 1 ].xyz, modelMatrix[ 2 ].xyz ) * objectNormal;\nworldNormal = normalize( worldNormal );\nvec3 cameraToVertex = normalize( worldPosition.xyz - cameraPosition );\nif ( useRefract ) {\nvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n} else {\nvReflect = reflect( cameraToVertex, worldNormal );\n}\n#endif",map_particle_pars_fragment:"#ifdef USE_MAP\nuniform sampler2D map;\n#endif",map_particle_fragment:"#ifdef USE_MAP\ngl_FragColor = gl_FragColor * texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) );\n#endif",map_pars_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP )\nvarying vec2 vUv;\nuniform vec4 offsetRepeat;\n#endif",map_pars_fragment:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP )\nvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\nuniform sampler2D map;\n#endif",map_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP )\nvUv = uv * offsetRepeat.zw + offsetRepeat.xy;\n#endif",map_fragment:"#ifdef USE_MAP\nvec4 texelColor = texture2D( map, vUv );\n#ifdef GAMMA_INPUT\ntexelColor.xyz *= texelColor.xyz;\n#endif\ngl_FragColor = gl_FragColor * texelColor;\n#endif",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\nvarying vec2 vUv2;\nuniform sampler2D lightMap;\n#endif",lightmap_pars_vertex:"#ifdef USE_LIGHTMAP\nvarying vec2 vUv2;\n#endif",lightmap_fragment:"#ifdef USE_LIGHTMAP\ngl_FragColor = gl_FragColor * texture2D( lightMap, vUv2 );\n#endif",lightmap_vertex:"#ifdef USE_LIGHTMAP\nvUv2 = uv2;\n#endif",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\nuniform sampler2D bumpMap;\nuniform float bumpScale;\nvec2 dHdxy_fwd() {\nvec2 dSTdx = dFdx( vUv );\nvec2 dSTdy = dFdy( vUv );\nfloat Hll = bumpScale * texture2D( bumpMap, vUv ).x;\nfloat dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;\nfloat dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;\nreturn vec2( dBx, dBy );\n}\nvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {\nvec3 vSigmaX = dFdx( surf_pos );\nvec3 vSigmaY = dFdy( surf_pos );\nvec3 vN = surf_norm;\nvec3 R1 = cross( vSigmaY, vN );\nvec3 R2 = cross( vN, vSigmaX );\nfloat fDet = dot( vSigmaX, R1 );\nvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\nreturn normalize( abs( fDet ) * surf_norm - vGrad );\n}\n#endif",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\nuniform sampler2D normalMap;\nuniform vec2 normalScale;\nvec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm ) {\nvec3 q0 = dFdx( eye_pos.xyz );\nvec3 q1 = dFdy( eye_pos.xyz );\nvec2 st0 = dFdx( vUv.st );\nvec2 st1 = dFdy( vUv.st );\nvec3 S = normalize(  q0 * st1.t - q1 * st0.t );\nvec3 T = normalize( -q0 * st1.s + q1 * st0.s );\nvec3 N = normalize( surf_norm );\nvec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\nmapN.xy = normalScale * mapN.xy;\nmat3 tsn = mat3( S, T, N );\nreturn normalize( tsn * mapN );\n}\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\nuniform sampler2D specularMap;\n#endif",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\nvec4 texelSpecular = texture2D( specularMap, vUv );\nspecularStrength = texelSpecular.r;\n#else\nspecularStrength = 1.0;\n#endif",lights_lambert_pars_vertex:"uniform vec3 ambient;\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 ambientLightColor;\n#if MAX_DIR_LIGHTS > 0\nuniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];\nuniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];\n#endif\n#if MAX_HEMI_LIGHTS > 0\nuniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];\nuniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];\nuniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];\n#endif\n#if MAX_POINT_LIGHTS > 0\nuniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];\nuniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];\nuniform float pointLightDistance[ MAX_POINT_LIGHTS ];\n#endif\n#if MAX_SPOT_LIGHTS > 0\nuniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];\nuniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];\nuniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];\nuniform float spotLightDistance[ MAX_SPOT_LIGHTS ];\nuniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];\nuniform float spotLightExponent[ MAX_SPOT_LIGHTS ];\n#endif\n#ifdef WRAP_AROUND\nuniform vec3 wrapRGB;\n#endif",lights_lambert_vertex:"vLightFront = vec3( 0.0 );\n#ifdef DOUBLE_SIDED\nvLightBack = vec3( 0.0 );\n#endif\ntransformedNormal = normalize( transformedNormal );\n#if MAX_DIR_LIGHTS > 0\nfor( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {\nvec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );\nvec3 dirVector = normalize( lDirection.xyz );\nfloat dotProduct = dot( transformedNormal, dirVector );\nvec3 directionalLightWeighting = vec3( max( dotProduct, 0.0 ) );\n#ifdef DOUBLE_SIDED\nvec3 directionalLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );\n#ifdef WRAP_AROUND\nvec3 directionalLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );\n#endif\n#endif\n#ifdef WRAP_AROUND\nvec3 directionalLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );\ndirectionalLightWeighting = mix( directionalLightWeighting, directionalLightWeightingHalf, wrapRGB );\n#ifdef DOUBLE_SIDED\ndirectionalLightWeightingBack = mix( directionalLightWeightingBack, directionalLightWeightingHalfBack, wrapRGB );\n#endif\n#endif\nvLightFront += directionalLightColor[ i ] * directionalLightWeighting;\n#ifdef DOUBLE_SIDED\nvLightBack += directionalLightColor[ i ] * directionalLightWeightingBack;\n#endif\n}\n#endif\n#if MAX_POINT_LIGHTS > 0\nfor( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {\nvec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );\nvec3 lVector = lPosition.xyz - mvPosition.xyz;\nfloat lDistance = 1.0;\nif ( pointLightDistance[ i ] > 0.0 )\nlDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );\nlVector = normalize( lVector );\nfloat dotProduct = dot( transformedNormal, lVector );\nvec3 pointLightWeighting = vec3( max( dotProduct, 0.0 ) );\n#ifdef DOUBLE_SIDED\nvec3 pointLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );\n#ifdef WRAP_AROUND\nvec3 pointLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );\n#endif\n#endif\n#ifdef WRAP_AROUND\nvec3 pointLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );\npointLightWeighting = mix( pointLightWeighting, pointLightWeightingHalf, wrapRGB );\n#ifdef DOUBLE_SIDED\npointLightWeightingBack = mix( pointLightWeightingBack, pointLightWeightingHalfBack, wrapRGB );\n#endif\n#endif\nvLightFront += pointLightColor[ i ] * pointLightWeighting * lDistance;\n#ifdef DOUBLE_SIDED\nvLightBack += pointLightColor[ i ] * pointLightWeightingBack * lDistance;\n#endif\n}\n#endif\n#if MAX_SPOT_LIGHTS > 0\nfor( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {\nvec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );\nvec3 lVector = lPosition.xyz - mvPosition.xyz;\nfloat spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - worldPosition.xyz ) );\nif ( spotEffect > spotLightAngleCos[ i ] ) {\nspotEffect = max( pow( spotEffect, spotLightExponent[ i ] ), 0.0 );\nfloat lDistance = 1.0;\nif ( spotLightDistance[ i ] > 0.0 )\nlDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );\nlVector = normalize( lVector );\nfloat dotProduct = dot( transformedNormal, lVector );\nvec3 spotLightWeighting = vec3( max( dotProduct, 0.0 ) );\n#ifdef DOUBLE_SIDED\nvec3 spotLightWeightingBack = vec3( max( -dotProduct, 0.0 ) );\n#ifdef WRAP_AROUND\nvec3 spotLightWeightingHalfBack = vec3( max( -0.5 * dotProduct + 0.5, 0.0 ) );\n#endif\n#endif\n#ifdef WRAP_AROUND\nvec3 spotLightWeightingHalf = vec3( max( 0.5 * dotProduct + 0.5, 0.0 ) );\nspotLightWeighting = mix( spotLightWeighting, spotLightWeightingHalf, wrapRGB );\n#ifdef DOUBLE_SIDED\nspotLightWeightingBack = mix( spotLightWeightingBack, spotLightWeightingHalfBack, wrapRGB );\n#endif\n#endif\nvLightFront += spotLightColor[ i ] * spotLightWeighting * lDistance * spotEffect;\n#ifdef DOUBLE_SIDED\nvLightBack += spotLightColor[ i ] * spotLightWeightingBack * lDistance * spotEffect;\n#endif\n}\n}\n#endif\n#if MAX_HEMI_LIGHTS > 0\nfor( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {\nvec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );\nvec3 lVector = normalize( lDirection.xyz );\nfloat dotProduct = dot( transformedNormal, lVector );\nfloat hemiDiffuseWeight = 0.5 * dotProduct + 0.5;\nfloat hemiDiffuseWeightBack = -0.5 * dotProduct + 0.5;\nvLightFront += mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );\n#ifdef DOUBLE_SIDED\nvLightBack += mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeightBack );\n#endif\n}\n#endif\nvLightFront = vLightFront * diffuse + ambient * ambientLightColor + emissive;\n#ifdef DOUBLE_SIDED\nvLightBack = vLightBack * diffuse + ambient * ambientLightColor + emissive;\n#endif",lights_phong_pars_vertex:"#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP )\nvarying vec3 vWorldPosition;\n#endif",lights_phong_vertex:"#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP )\nvWorldPosition = worldPosition.xyz;\n#endif",lights_phong_pars_fragment:"uniform vec3 ambientLightColor;\n#if MAX_DIR_LIGHTS > 0\nuniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];\nuniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];\n#endif\n#if MAX_HEMI_LIGHTS > 0\nuniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];\nuniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];\nuniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];\n#endif\n#if MAX_POINT_LIGHTS > 0\nuniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];\nuniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];\nuniform float pointLightDistance[ MAX_POINT_LIGHTS ];\n#endif\n#if MAX_SPOT_LIGHTS > 0\nuniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];\nuniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];\nuniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];\nuniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];\nuniform float spotLightExponent[ MAX_SPOT_LIGHTS ];\nuniform float spotLightDistance[ MAX_SPOT_LIGHTS ];\n#endif\n#if MAX_SPOT_LIGHTS > 0 || defined( USE_BUMPMAP )\nvarying vec3 vWorldPosition;\n#endif\n#ifdef WRAP_AROUND\nuniform vec3 wrapRGB;\n#endif\nvarying vec3 vViewPosition;\nvarying vec3 vNormal;",lights_phong_fragment:"vec3 normal = normalize( vNormal );\nvec3 viewPosition = normalize( vViewPosition );\n#ifdef DOUBLE_SIDED\nnormal = normal * ( -1.0 + 2.0 * float( gl_FrontFacing ) );\n#endif\n#ifdef USE_NORMALMAP\nnormal = perturbNormal2Arb( -vViewPosition, normal );\n#elif defined( USE_BUMPMAP )\nnormal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );\n#endif\n#if MAX_POINT_LIGHTS > 0\nvec3 pointDiffuse  = vec3( 0.0 );\nvec3 pointSpecular = vec3( 0.0 );\nfor ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {\nvec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );\nvec3 lVector = lPosition.xyz + vViewPosition.xyz;\nfloat lDistance = 1.0;\nif ( pointLightDistance[ i ] > 0.0 )\nlDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );\nlVector = normalize( lVector );\nfloat dotProduct = dot( normal, lVector );\n#ifdef WRAP_AROUND\nfloat pointDiffuseWeightFull = max( dotProduct, 0.0 );\nfloat pointDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );\nvec3 pointDiffuseWeight = mix( vec3 ( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );\n#else\nfloat pointDiffuseWeight = max( dotProduct, 0.0 );\n#endif\npointDiffuse  += diffuse * pointLightColor[ i ] * pointDiffuseWeight * lDistance;\nvec3 pointHalfVector = normalize( lVector + viewPosition );\nfloat pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );\nfloat pointSpecularWeight = specularStrength * max( pow( pointDotNormalHalf, shininess ), 0.0 );\nfloat specularNormalization = ( shininess + 2.0001 ) / 8.0;\nvec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVector, pointHalfVector ), 5.0 );\npointSpecular += schlick * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * lDistance * specularNormalization;\n}\n#endif\n#if MAX_SPOT_LIGHTS > 0\nvec3 spotDiffuse  = vec3( 0.0 );\nvec3 spotSpecular = vec3( 0.0 );\nfor ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {\nvec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );\nvec3 lVector = lPosition.xyz + vViewPosition.xyz;\nfloat lDistance = 1.0;\nif ( spotLightDistance[ i ] > 0.0 )\nlDistance = 1.0 - min( ( length( lVector ) / spotLightDistance[ i ] ), 1.0 );\nlVector = normalize( lVector );\nfloat spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - vWorldPosition ) );\nif ( spotEffect > spotLightAngleCos[ i ] ) {\nspotEffect = max( pow( spotEffect, spotLightExponent[ i ] ), 0.0 );\nfloat dotProduct = dot( normal, lVector );\n#ifdef WRAP_AROUND\nfloat spotDiffuseWeightFull = max( dotProduct, 0.0 );\nfloat spotDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );\nvec3 spotDiffuseWeight = mix( vec3 ( spotDiffuseWeightFull ), vec3( spotDiffuseWeightHalf ), wrapRGB );\n#else\nfloat spotDiffuseWeight = max( dotProduct, 0.0 );\n#endif\nspotDiffuse += diffuse * spotLightColor[ i ] * spotDiffuseWeight * lDistance * spotEffect;\nvec3 spotHalfVector = normalize( lVector + viewPosition );\nfloat spotDotNormalHalf = max( dot( normal, spotHalfVector ), 0.0 );\nfloat spotSpecularWeight = specularStrength * max( pow( spotDotNormalHalf, shininess ), 0.0 );\nfloat specularNormalization = ( shininess + 2.0001 ) / 8.0;\nvec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVector, spotHalfVector ), 5.0 );\nspotSpecular += schlick * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * lDistance * specularNormalization * spotEffect;\n}\n}\n#endif\n#if MAX_DIR_LIGHTS > 0\nvec3 dirDiffuse  = vec3( 0.0 );\nvec3 dirSpecular = vec3( 0.0 );\nfor( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {\nvec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );\nvec3 dirVector = normalize( lDirection.xyz );\nfloat dotProduct = dot( normal, dirVector );\n#ifdef WRAP_AROUND\nfloat dirDiffuseWeightFull = max( dotProduct, 0.0 );\nfloat dirDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );\nvec3 dirDiffuseWeight = mix( vec3( dirDiffuseWeightFull ), vec3( dirDiffuseWeightHalf ), wrapRGB );\n#else\nfloat dirDiffuseWeight = max( dotProduct, 0.0 );\n#endif\ndirDiffuse  += diffuse * directionalLightColor[ i ] * dirDiffuseWeight;\nvec3 dirHalfVector = normalize( dirVector + viewPosition );\nfloat dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );\nfloat dirSpecularWeight = specularStrength * max( pow( dirDotNormalHalf, shininess ), 0.0 );\nfloat specularNormalization = ( shininess + 2.0001 ) / 8.0;\nvec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( dirVector, dirHalfVector ), 5.0 );\ndirSpecular += schlick * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight * specularNormalization;\n}\n#endif\n#if MAX_HEMI_LIGHTS > 0\nvec3 hemiDiffuse  = vec3( 0.0 );\nvec3 hemiSpecular = vec3( 0.0 );\nfor( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {\nvec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );\nvec3 lVector = normalize( lDirection.xyz );\nfloat dotProduct = dot( normal, lVector );\nfloat hemiDiffuseWeight = 0.5 * dotProduct + 0.5;\nvec3 hemiColor = mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );\nhemiDiffuse += diffuse * hemiColor;\nvec3 hemiHalfVectorSky = normalize( lVector + viewPosition );\nfloat hemiDotNormalHalfSky = 0.5 * dot( normal, hemiHalfVectorSky ) + 0.5;\nfloat hemiSpecularWeightSky = specularStrength * max( pow( hemiDotNormalHalfSky, shininess ), 0.0 );\nvec3 lVectorGround = -lVector;\nvec3 hemiHalfVectorGround = normalize( lVectorGround + viewPosition );\nfloat hemiDotNormalHalfGround = 0.5 * dot( normal, hemiHalfVectorGround ) + 0.5;\nfloat hemiSpecularWeightGround = specularStrength * max( pow( hemiDotNormalHalfGround, shininess ), 0.0 );\nfloat dotProductGround = dot( normal, lVectorGround );\nfloat specularNormalization = ( shininess + 2.0001 ) / 8.0;\nvec3 schlickSky = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVector, hemiHalfVectorSky ), 5.0 );\nvec3 schlickGround = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVectorGround, hemiHalfVectorGround ), 5.0 );\nhemiSpecular += hemiColor * specularNormalization * ( schlickSky * hemiSpecularWeightSky * max( dotProduct, 0.0 ) + schlickGround * hemiSpecularWeightGround * max( dotProductGround, 0.0 ) );\n}\n#endif\nvec3 totalDiffuse = vec3( 0.0 );\nvec3 totalSpecular = vec3( 0.0 );\n#if MAX_DIR_LIGHTS > 0\ntotalDiffuse += dirDiffuse;\ntotalSpecular += dirSpecular;\n#endif\n#if MAX_HEMI_LIGHTS > 0\ntotalDiffuse += hemiDiffuse;\ntotalSpecular += hemiSpecular;\n#endif\n#if MAX_POINT_LIGHTS > 0\ntotalDiffuse += pointDiffuse;\ntotalSpecular += pointSpecular;\n#endif\n#if MAX_SPOT_LIGHTS > 0\ntotalDiffuse += spotDiffuse;\ntotalSpecular += spotSpecular;\n#endif\n#ifdef METAL\ngl_FragColor.xyz = gl_FragColor.xyz * ( emissive + totalDiffuse + ambientLightColor * ambient + totalSpecular );\n#else\ngl_FragColor.xyz = gl_FragColor.xyz * ( emissive + totalDiffuse + ambientLightColor * ambient ) + totalSpecular;\n#endif",color_pars_fragment:"#ifdef USE_COLOR\nvarying vec3 vColor;\n#endif",color_fragment:"#ifdef USE_COLOR\ngl_FragColor = gl_FragColor * vec4( vColor, 1.0 );\n#endif",color_pars_vertex:"#ifdef USE_COLOR\nvarying vec3 vColor;\n#endif",color_vertex:"#ifdef USE_COLOR\n#ifdef GAMMA_INPUT\nvColor = color * color;\n#else\nvColor = color;\n#endif\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n#ifdef BONE_TEXTURE\nuniform sampler2D boneTexture;\nuniform int boneTextureWidth;\nuniform int boneTextureHeight;\nmat4 getBoneMatrix( const in float i ) {\nfloat j = i * 4.0;\nfloat x = mod( j, float( boneTextureWidth ) );\nfloat y = floor( j / float( boneTextureWidth ) );\nfloat dx = 1.0 / float( boneTextureWidth );\nfloat dy = 1.0 / float( boneTextureHeight );\ny = dy * ( y + 0.5 );\nvec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\nvec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\nvec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\nvec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\nmat4 bone = mat4( v1, v2, v3, v4 );\nreturn bone;\n}\n#else\nuniform mat4 boneGlobalMatrices[ MAX_BONES ];\nmat4 getBoneMatrix( const in float i ) {\nmat4 bone = boneGlobalMatrices[ int(i) ];\nreturn bone;\n}\n#endif\n#endif",skinbase_vertex:"#ifdef USE_SKINNING\nmat4 boneMatX = getBoneMatrix( skinIndex.x );\nmat4 boneMatY = getBoneMatrix( skinIndex.y );\nmat4 boneMatZ = getBoneMatrix( skinIndex.z );\nmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_vertex:"#ifdef USE_SKINNING\n#ifdef USE_MORPHTARGETS\nvec4 skinVertex = vec4( morphed, 1.0 );\n#else\nvec4 skinVertex = vec4( position, 1.0 );\n#endif\nvec4 skinned  = boneMatX * skinVertex * skinWeight.x;\nskinned      += boneMatY * skinVertex * skinWeight.y;\nskinned      += boneMatZ * skinVertex * skinWeight.z;\nskinned      += boneMatW * skinVertex * skinWeight.w;\n#endif",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n#ifndef USE_MORPHNORMALS\nuniform float morphTargetInfluences[ 8 ];\n#else\nuniform float morphTargetInfluences[ 4 ];\n#endif\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\nvec3 morphed = vec3( 0.0 );\nmorphed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];\nmorphed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];\nmorphed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];\nmorphed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];\n#ifndef USE_MORPHNORMALS\nmorphed += ( morphTarget4 - position ) * morphTargetInfluences[ 4 ];\nmorphed += ( morphTarget5 - position ) * morphTargetInfluences[ 5 ];\nmorphed += ( morphTarget6 - position ) * morphTargetInfluences[ 6 ];\nmorphed += ( morphTarget7 - position ) * morphTargetInfluences[ 7 ];\n#endif\nmorphed += position;\n#endif",default_vertex:"vec4 mvPosition;\n#ifdef USE_SKINNING\nmvPosition = modelViewMatrix * skinned;\n#endif\n#if !defined( USE_SKINNING ) && defined( USE_MORPHTARGETS )\nmvPosition = modelViewMatrix * vec4( morphed, 1.0 );\n#endif\n#if !defined( USE_SKINNING ) && ! defined( USE_MORPHTARGETS )\nmvPosition = modelViewMatrix * vec4( position, 1.0 );\n#endif\ngl_Position = projectionMatrix * mvPosition;",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\nvec3 morphedNormal = vec3( 0.0 );\nmorphedNormal +=  ( morphNormal0 - normal ) * morphTargetInfluences[ 0 ];\nmorphedNormal +=  ( morphNormal1 - normal ) * morphTargetInfluences[ 1 ];\nmorphedNormal +=  ( morphNormal2 - normal ) * morphTargetInfluences[ 2 ];\nmorphedNormal +=  ( morphNormal3 - normal ) * morphTargetInfluences[ 3 ];\nmorphedNormal += normal;\n#endif",skinnormal_vertex:"#ifdef USE_SKINNING\nmat4 skinMatrix = skinWeight.x * boneMatX;\nskinMatrix 	+= skinWeight.y * boneMatY;\n#ifdef USE_MORPHNORMALS\nvec4 skinnedNormal = skinMatrix * vec4( morphedNormal, 0.0 );\n#else\nvec4 skinnedNormal = skinMatrix * vec4( normal, 0.0 );\n#endif\n#endif",defaultnormal_vertex:"vec3 objectNormal;\n#ifdef USE_SKINNING\nobjectNormal = skinnedNormal.xyz;\n#endif\n#if !defined( USE_SKINNING ) && defined( USE_MORPHNORMALS )\nobjectNormal = morphedNormal;\n#endif\n#if !defined( USE_SKINNING ) && ! defined( USE_MORPHNORMALS )\nobjectNormal = normal;\n#endif\n#ifdef FLIP_SIDED\nobjectNormal = -objectNormal;\n#endif\nvec3 transformedNormal = normalMatrix * objectNormal;",shadowmap_pars_fragment:"#ifdef USE_SHADOWMAP\nuniform sampler2D shadowMap[ MAX_SHADOWS ];\nuniform vec2 shadowMapSize[ MAX_SHADOWS ];\nuniform float shadowDarkness[ MAX_SHADOWS ];\nuniform float shadowBias[ MAX_SHADOWS ];\nvarying vec4 vShadowCoord[ MAX_SHADOWS ];\nfloat unpackDepth( const in vec4 rgba_depth ) {\nconst vec4 bit_shift = vec4( 1.0 / ( 256.0 * 256.0 * 256.0 ), 1.0 / ( 256.0 * 256.0 ), 1.0 / 256.0, 1.0 );\nfloat depth = dot( rgba_depth, bit_shift );\nreturn depth;\n}\n#endif",shadowmap_fragment:"#ifdef USE_SHADOWMAP\n#ifdef SHADOWMAP_DEBUG\nvec3 frustumColors[3];\nfrustumColors[0] = vec3( 1.0, 0.5, 0.0 );\nfrustumColors[1] = vec3( 0.0, 1.0, 0.8 );\nfrustumColors[2] = vec3( 0.0, 0.5, 1.0 );\n#endif\n#ifdef SHADOWMAP_CASCADE\nint inFrustumCount = 0;\n#endif\nfloat fDepth;\nvec3 shadowColor = vec3( 1.0 );\nfor( int i = 0; i < MAX_SHADOWS; i ++ ) {\nvec3 shadowCoord = vShadowCoord[ i ].xyz / vShadowCoord[ i ].w;\nbvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\nbool inFrustum = all( inFrustumVec );\n#ifdef SHADOWMAP_CASCADE\ninFrustumCount += int( inFrustum );\nbvec3 frustumTestVec = bvec3( inFrustum, inFrustumCount == 1, shadowCoord.z <= 1.0 );\n#else\nbvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n#endif\nbool frustumTest = all( frustumTestVec );\nif ( frustumTest ) {\nshadowCoord.z += shadowBias[ i ];\n#if defined( SHADOWMAP_TYPE_PCF )\nfloat shadow = 0.0;\nconst float shadowDelta = 1.0 / 9.0;\nfloat xPixelOffset = 1.0 / shadowMapSize[ i ].x;\nfloat yPixelOffset = 1.0 / shadowMapSize[ i ].y;\nfloat dx0 = -1.25 * xPixelOffset;\nfloat dy0 = -1.25 * yPixelOffset;\nfloat dx1 = 1.25 * xPixelOffset;\nfloat dy1 = 1.25 * yPixelOffset;\nfDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy0 ) ) );\nif ( fDepth < shadowCoord.z ) shadow += shadowDelta;\nfDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy0 ) ) );\nif ( fDepth < shadowCoord.z ) shadow += shadowDelta;\nfDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy0 ) ) );\nif ( fDepth < shadowCoord.z ) shadow += shadowDelta;\nfDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, 0.0 ) ) );\nif ( fDepth < shadowCoord.z ) shadow += shadowDelta;\nfDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy ) );\nif ( fDepth < shadowCoord.z ) shadow += shadowDelta;\nfDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, 0.0 ) ) );\nif ( fDepth < shadowCoord.z ) shadow += shadowDelta;\nfDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy1 ) ) );\nif ( fDepth < shadowCoord.z ) shadow += shadowDelta;\nfDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy1 ) ) );\nif ( fDepth < shadowCoord.z ) shadow += shadowDelta;\nfDepth = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy1 ) ) );\nif ( fDepth < shadowCoord.z ) shadow += shadowDelta;\nshadowColor = shadowColor * vec3( ( 1.0 - shadowDarkness[ i ] * shadow ) );\n#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\nfloat shadow = 0.0;\nfloat xPixelOffset = 1.0 / shadowMapSize[ i ].x;\nfloat yPixelOffset = 1.0 / shadowMapSize[ i ].y;\nfloat dx0 = -1.0 * xPixelOffset;\nfloat dy0 = -1.0 * yPixelOffset;\nfloat dx1 = 1.0 * xPixelOffset;\nfloat dy1 = 1.0 * yPixelOffset;\nmat3 shadowKernel;\nmat3 depthKernel;\ndepthKernel[0][0] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy0 ) ) );\ndepthKernel[0][1] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, 0.0 ) ) );\ndepthKernel[0][2] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx0, dy1 ) ) );\ndepthKernel[1][0] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy0 ) ) );\ndepthKernel[1][1] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy ) );\ndepthKernel[1][2] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( 0.0, dy1 ) ) );\ndepthKernel[2][0] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy0 ) ) );\ndepthKernel[2][1] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, 0.0 ) ) );\ndepthKernel[2][2] = unpackDepth( texture2D( shadowMap[ i ], shadowCoord.xy + vec2( dx1, dy1 ) ) );\nvec3 shadowZ = vec3( shadowCoord.z );\nshadowKernel[0] = vec3(lessThan(depthKernel[0], shadowZ ));\nshadowKernel[0] *= vec3(0.25);\nshadowKernel[1] = vec3(lessThan(depthKernel[1], shadowZ ));\nshadowKernel[1] *= vec3(0.25);\nshadowKernel[2] = vec3(lessThan(depthKernel[2], shadowZ ));\nshadowKernel[2] *= vec3(0.25);\nvec2 fractionalCoord = 1.0 - fract( shadowCoord.xy * shadowMapSize[i].xy );\nshadowKernel[0] = mix( shadowKernel[1], shadowKernel[0], fractionalCoord.x );\nshadowKernel[1] = mix( shadowKernel[2], shadowKernel[1], fractionalCoord.x );\nvec4 shadowValues;\nshadowValues.x = mix( shadowKernel[0][1], shadowKernel[0][0], fractionalCoord.y );\nshadowValues.y = mix( shadowKernel[0][2], shadowKernel[0][1], fractionalCoord.y );\nshadowValues.z = mix( shadowKernel[1][1], shadowKernel[1][0], fractionalCoord.y );\nshadowValues.w = mix( shadowKernel[1][2], shadowKernel[1][1], fractionalCoord.y );\nshadow = dot( shadowValues, vec4( 1.0 ) );\nshadowColor = shadowColor * vec3( ( 1.0 - shadowDarkness[ i ] * shadow ) );\n#else\nvec4 rgbaDepth = texture2D( shadowMap[ i ], shadowCoord.xy );\nfloat fDepth = unpackDepth( rgbaDepth );\nif ( fDepth < shadowCoord.z )\nshadowColor = shadowColor * vec3( 1.0 - shadowDarkness[ i ] );\n#endif\n}\n#ifdef SHADOWMAP_DEBUG\n#ifdef SHADOWMAP_CASCADE\nif ( inFrustum && inFrustumCount == 1 ) gl_FragColor.xyz *= frustumColors[ i ];\n#else\nif ( inFrustum ) gl_FragColor.xyz *= frustumColors[ i ];\n#endif\n#endif\n}\n#ifdef GAMMA_OUTPUT\nshadowColor *= shadowColor;\n#endif\ngl_FragColor.xyz = gl_FragColor.xyz * shadowColor;\n#endif",shadowmap_pars_vertex:"#ifdef USE_SHADOWMAP\nvarying vec4 vShadowCoord[ MAX_SHADOWS ];\nuniform mat4 shadowMatrix[ MAX_SHADOWS ];\n#endif",shadowmap_vertex:"#ifdef USE_SHADOWMAP\nfor( int i = 0; i < MAX_SHADOWS; i ++ ) {\nvShadowCoord[ i ] = shadowMatrix[ i ] * worldPosition;\n}\n#endif",alphatest_fragment:"#ifdef ALPHATEST\nif ( gl_FragColor.a < ALPHATEST ) discard;\n#endif",linear_to_gamma_fragment:"#ifdef GAMMA_OUTPUT\ngl_FragColor.xyz = sqrt( gl_FragColor.xyz );\n#endif"},THREE.UniformsUtils={merge:function(a){var b,c,d,e={};
for(b=0;b<a.length;b++)for(c in d=this.clone(a[b]))e[c]=d[c];return e},clone:function(a){var b,c,d,e={};for(b in a)for(c in e[b]={},a[b])d=a[b][c],e[b][c]=d instanceof THREE.Color||d instanceof THREE.Vector2||d instanceof THREE.Vector3||d instanceof THREE.Vector4||d instanceof THREE.Matrix4||d instanceof THREE.Texture?d.clone():d instanceof Array?d.slice():d;return e}},THREE.UniformsLib={common:{diffuse:{type:"c",value:new THREE.Color(15658734)},opacity:{type:"f",value:1},map:{type:"t",value:null},offsetRepeat:{type:"v4",value:new THREE.Vector4(0,0,1,1)},lightMap:{type:"t",value:null},specularMap:{type:"t",value:null},envMap:{type:"t",value:null},flipEnvMap:{type:"f",value:-1},useRefract:{type:"i",value:0},reflectivity:{type:"f",value:1},refractionRatio:{type:"f",value:.98},combine:{type:"i",value:0},morphTargetInfluences:{type:"f",value:0}},bump:{bumpMap:{type:"t",value:null},bumpScale:{type:"f",value:1}},normalmap:{normalMap:{type:"t",value:null},normalScale:{type:"v2",value:new THREE.Vector2(1,1)}},fog:{fogDensity:{type:"f",value:25e-5},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2e3},fogColor:{type:"c",value:new THREE.Color(16777215)}},lights:{ambientLightColor:{type:"fv",value:[]},directionalLightDirection:{type:"fv",value:[]},directionalLightColor:{type:"fv",value:[]},hemisphereLightDirection:{type:"fv",value:[]},hemisphereLightSkyColor:{type:"fv",value:[]},hemisphereLightGroundColor:{type:"fv",value:[]},pointLightColor:{type:"fv",value:[]},pointLightPosition:{type:"fv",value:[]},pointLightDistance:{type:"fv1",value:[]},spotLightColor:{type:"fv",value:[]},spotLightPosition:{type:"fv",value:[]},spotLightDirection:{type:"fv",value:[]},spotLightDistance:{type:"fv1",value:[]},spotLightAngleCos:{type:"fv1",value:[]},spotLightExponent:{type:"fv1",value:[]}},particle:{psColor:{type:"c",value:new THREE.Color(15658734)},opacity:{type:"f",value:1},size:{type:"f",value:1},scale:{type:"f",value:1},map:{type:"t",value:null},fogDensity:{type:"f",value:25e-5},fogNear:{type:"f",value:1},fogFar:{type:"f",value:2e3},fogColor:{type:"c",value:new THREE.Color(16777215)}},shadowmap:{shadowMap:{type:"tv",value:[]},shadowMapSize:{type:"v2v",value:[]},shadowBias:{type:"fv1",value:[]},shadowDarkness:{type:"fv1",value:[]},shadowMatrix:{type:"m4v",value:[]}}},THREE.ShaderLib={basic:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.fog,THREE.UniformsLib.shadowmap]),vertexShader:[THREE.ShaderChunk.map_pars_vertex,THREE.ShaderChunk.lightmap_pars_vertex,THREE.ShaderChunk.envmap_pars_vertex,THREE.ShaderChunk.color_pars_vertex,THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.shadowmap_pars_vertex,"void main() {",THREE.ShaderChunk.map_vertex,THREE.ShaderChunk.lightmap_vertex,THREE.ShaderChunk.color_vertex,THREE.ShaderChunk.skinbase_vertex,"#ifdef USE_ENVMAP",THREE.ShaderChunk.morphnormal_vertex,THREE.ShaderChunk.skinnormal_vertex,THREE.ShaderChunk.defaultnormal_vertex,"#endif",THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.default_vertex,THREE.ShaderChunk.worldpos_vertex,THREE.ShaderChunk.envmap_vertex,THREE.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;\nuniform float opacity;",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_pars_fragment,THREE.ShaderChunk.lightmap_pars_fragment,THREE.ShaderChunk.envmap_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.specularmap_pars_fragment,"void main() {\ngl_FragColor = vec4( diffuse, opacity );",THREE.ShaderChunk.map_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.specularmap_fragment,THREE.ShaderChunk.lightmap_fragment,THREE.ShaderChunk.color_fragment,THREE.ShaderChunk.envmap_fragment,THREE.ShaderChunk.shadowmap_fragment,THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.fog_fragment,"}"].join("\n")},lambert:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.fog,THREE.UniformsLib.lights,THREE.UniformsLib.shadowmap,{ambient:{type:"c",value:new THREE.Color(16777215)},emissive:{type:"c",value:new THREE.Color(0)},wrapRGB:{type:"v3",value:new THREE.Vector3(1,1,1)}}]),vertexShader:["#define LAMBERT\nvarying vec3 vLightFront;\n#ifdef DOUBLE_SIDED\nvarying vec3 vLightBack;\n#endif",THREE.ShaderChunk.map_pars_vertex,THREE.ShaderChunk.lightmap_pars_vertex,THREE.ShaderChunk.envmap_pars_vertex,THREE.ShaderChunk.lights_lambert_pars_vertex,THREE.ShaderChunk.color_pars_vertex,THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.shadowmap_pars_vertex,"void main() {",THREE.ShaderChunk.map_vertex,THREE.ShaderChunk.lightmap_vertex,THREE.ShaderChunk.color_vertex,THREE.ShaderChunk.morphnormal_vertex,THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.skinnormal_vertex,THREE.ShaderChunk.defaultnormal_vertex,THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.default_vertex,THREE.ShaderChunk.worldpos_vertex,THREE.ShaderChunk.envmap_vertex,THREE.ShaderChunk.lights_lambert_vertex,THREE.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform float opacity;\nvarying vec3 vLightFront;\n#ifdef DOUBLE_SIDED\nvarying vec3 vLightBack;\n#endif",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_pars_fragment,THREE.ShaderChunk.lightmap_pars_fragment,THREE.ShaderChunk.envmap_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.specularmap_pars_fragment,"void main() {\ngl_FragColor = vec4( vec3 ( 1.0 ), opacity );",THREE.ShaderChunk.map_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.specularmap_fragment,"#ifdef DOUBLE_SIDED\nif ( gl_FrontFacing )\ngl_FragColor.xyz *= vLightFront;\nelse\ngl_FragColor.xyz *= vLightBack;\n#else\ngl_FragColor.xyz *= vLightFront;\n#endif",THREE.ShaderChunk.lightmap_fragment,THREE.ShaderChunk.color_fragment,THREE.ShaderChunk.envmap_fragment,THREE.ShaderChunk.shadowmap_fragment,THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.fog_fragment,"}"].join("\n")},phong:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.bump,THREE.UniformsLib.normalmap,THREE.UniformsLib.fog,THREE.UniformsLib.lights,THREE.UniformsLib.shadowmap,{ambient:{type:"c",value:new THREE.Color(16777215)},emissive:{type:"c",value:new THREE.Color(0)},specular:{type:"c",value:new THREE.Color(1118481)},shininess:{type:"f",value:30},wrapRGB:{type:"v3",value:new THREE.Vector3(1,1,1)}}]),vertexShader:["#define PHONG\nvarying vec3 vViewPosition;\nvarying vec3 vNormal;",THREE.ShaderChunk.map_pars_vertex,THREE.ShaderChunk.lightmap_pars_vertex,THREE.ShaderChunk.envmap_pars_vertex,THREE.ShaderChunk.lights_phong_pars_vertex,THREE.ShaderChunk.color_pars_vertex,THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.shadowmap_pars_vertex,"void main() {",THREE.ShaderChunk.map_vertex,THREE.ShaderChunk.lightmap_vertex,THREE.ShaderChunk.color_vertex,THREE.ShaderChunk.morphnormal_vertex,THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.skinnormal_vertex,THREE.ShaderChunk.defaultnormal_vertex,"vNormal = normalize( transformedNormal );",THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.default_vertex,"vViewPosition = -mvPosition.xyz;",THREE.ShaderChunk.worldpos_vertex,THREE.ShaderChunk.envmap_vertex,THREE.ShaderChunk.lights_phong_vertex,THREE.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 diffuse;\nuniform float opacity;\nuniform vec3 ambient;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_pars_fragment,THREE.ShaderChunk.lightmap_pars_fragment,THREE.ShaderChunk.envmap_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.lights_phong_pars_fragment,THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.bumpmap_pars_fragment,THREE.ShaderChunk.normalmap_pars_fragment,THREE.ShaderChunk.specularmap_pars_fragment,"void main() {\ngl_FragColor = vec4( vec3 ( 1.0 ), opacity );",THREE.ShaderChunk.map_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.specularmap_fragment,THREE.ShaderChunk.lights_phong_fragment,THREE.ShaderChunk.lightmap_fragment,THREE.ShaderChunk.color_fragment,THREE.ShaderChunk.envmap_fragment,THREE.ShaderChunk.shadowmap_fragment,THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.fog_fragment,"}"].join("\n")},particle_basic:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.particle,THREE.UniformsLib.shadowmap]),vertexShader:["uniform float size;\nuniform float scale;",THREE.ShaderChunk.color_pars_vertex,THREE.ShaderChunk.shadowmap_pars_vertex,"void main() {",THREE.ShaderChunk.color_vertex,"vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n#ifdef USE_SIZEATTENUATION\ngl_PointSize = size * ( scale / length( mvPosition.xyz ) );\n#else\ngl_PointSize = size;\n#endif\ngl_Position = projectionMatrix * mvPosition;",THREE.ShaderChunk.worldpos_vertex,THREE.ShaderChunk.shadowmap_vertex,"}"].join("\n"),fragmentShader:["uniform vec3 psColor;\nuniform float opacity;",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.map_particle_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,THREE.ShaderChunk.shadowmap_pars_fragment,"void main() {\ngl_FragColor = vec4( psColor, opacity );",THREE.ShaderChunk.map_particle_fragment,THREE.ShaderChunk.alphatest_fragment,THREE.ShaderChunk.color_fragment,THREE.ShaderChunk.shadowmap_fragment,THREE.ShaderChunk.fog_fragment,"}"].join("\n")},dashed:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.fog,{scale:{type:"f",value:1},dashSize:{type:"f",value:1},totalSize:{type:"f",value:2}}]),vertexShader:["uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;",THREE.ShaderChunk.color_pars_vertex,"void main() {",THREE.ShaderChunk.color_vertex,"vLineDistance = scale * lineDistance;\nvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\ngl_Position = projectionMatrix * mvPosition;\n}"].join("\n"),fragmentShader:["uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;",THREE.ShaderChunk.color_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,"void main() {\nif ( mod( vLineDistance, totalSize ) > dashSize ) {\ndiscard;\n}\ngl_FragColor = vec4( diffuse, opacity );",THREE.ShaderChunk.color_fragment,THREE.ShaderChunk.fog_fragment,"}"].join("\n")},depth:{uniforms:{mNear:{type:"f",value:1},mFar:{type:"f",value:2e3},opacity:{type:"f",value:1}},vertexShader:"void main() {\ngl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"uniform float mNear;\nuniform float mFar;\nuniform float opacity;\nvoid main() {\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\nfloat color = 1.0 - smoothstep( mNear, mFar, depth );\ngl_FragColor = vec4( vec3( color ), opacity );\n}"},normal:{uniforms:{opacity:{type:"f",value:1}},vertexShader:["varying vec3 vNormal;",THREE.ShaderChunk.morphtarget_pars_vertex,"void main() {\nvNormal = normalize( normalMatrix * normal );",THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.default_vertex,"}"].join("\n"),fragmentShader:"uniform float opacity;\nvarying vec3 vNormal;\nvoid main() {\ngl_FragColor = vec4( 0.5 * normalize( vNormal ) + 0.5, opacity );\n}"},normalmap:{uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.fog,THREE.UniformsLib.lights,THREE.UniformsLib.shadowmap,{enableAO:{type:"i",value:0},enableDiffuse:{type:"i",value:0},enableSpecular:{type:"i",value:0},enableReflection:{type:"i",value:0},enableDisplacement:{type:"i",value:0},tDisplacement:{type:"t",value:null},tDiffuse:{type:"t",value:null},tCube:{type:"t",value:null},tNormal:{type:"t",value:null},tSpecular:{type:"t",value:null},tAO:{type:"t",value:null},uNormalScale:{type:"v2",value:new THREE.Vector2(1,1)},uDisplacementBias:{type:"f",value:0},uDisplacementScale:{type:"f",value:1},diffuse:{type:"c",value:new THREE.Color(16777215)},specular:{type:"c",value:new THREE.Color(1118481)},ambient:{type:"c",value:new THREE.Color(16777215)},shininess:{type:"f",value:30},opacity:{type:"f",value:1},useRefract:{type:"i",value:0},refractionRatio:{type:"f",value:.98},reflectivity:{type:"f",value:.5},uOffset:{type:"v2",value:new THREE.Vector2(0,0)},uRepeat:{type:"v2",value:new THREE.Vector2(1,1)},wrapRGB:{type:"v3",value:new THREE.Vector3(1,1,1)}}]),fragmentShader:["uniform vec3 ambient;\nuniform vec3 diffuse;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\nuniform bool enableDiffuse;\nuniform bool enableSpecular;\nuniform bool enableAO;\nuniform bool enableReflection;\nuniform sampler2D tDiffuse;\nuniform sampler2D tNormal;\nuniform sampler2D tSpecular;\nuniform sampler2D tAO;\nuniform samplerCube tCube;\nuniform vec2 uNormalScale;\nuniform bool useRefract;\nuniform float refractionRatio;\nuniform float reflectivity;\nvarying vec3 vTangent;\nvarying vec3 vBinormal;\nvarying vec3 vNormal;\nvarying vec2 vUv;\nuniform vec3 ambientLightColor;\n#if MAX_DIR_LIGHTS > 0\nuniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];\nuniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];\n#endif\n#if MAX_HEMI_LIGHTS > 0\nuniform vec3 hemisphereLightSkyColor[ MAX_HEMI_LIGHTS ];\nuniform vec3 hemisphereLightGroundColor[ MAX_HEMI_LIGHTS ];\nuniform vec3 hemisphereLightDirection[ MAX_HEMI_LIGHTS ];\n#endif\n#if MAX_POINT_LIGHTS > 0\nuniform vec3 pointLightColor[ MAX_POINT_LIGHTS ];\nuniform vec3 pointLightPosition[ MAX_POINT_LIGHTS ];\nuniform float pointLightDistance[ MAX_POINT_LIGHTS ];\n#endif\n#if MAX_SPOT_LIGHTS > 0\nuniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];\nuniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];\nuniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];\nuniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];\nuniform float spotLightExponent[ MAX_SPOT_LIGHTS ];\nuniform float spotLightDistance[ MAX_SPOT_LIGHTS ];\n#endif\n#ifdef WRAP_AROUND\nuniform vec3 wrapRGB;\n#endif\nvarying vec3 vWorldPosition;\nvarying vec3 vViewPosition;",THREE.ShaderChunk.shadowmap_pars_fragment,THREE.ShaderChunk.fog_pars_fragment,"void main() {\ngl_FragColor = vec4( vec3( 1.0 ), opacity );\nvec3 specularTex = vec3( 1.0 );\nvec3 normalTex = texture2D( tNormal, vUv ).xyz * 2.0 - 1.0;\nnormalTex.xy *= uNormalScale;\nnormalTex = normalize( normalTex );\nif( enableDiffuse ) {\n#ifdef GAMMA_INPUT\nvec4 texelColor = texture2D( tDiffuse, vUv );\ntexelColor.xyz *= texelColor.xyz;\ngl_FragColor = gl_FragColor * texelColor;\n#else\ngl_FragColor = gl_FragColor * texture2D( tDiffuse, vUv );\n#endif\n}\nif( enableAO ) {\n#ifdef GAMMA_INPUT\nvec4 aoColor = texture2D( tAO, vUv );\naoColor.xyz *= aoColor.xyz;\ngl_FragColor.xyz = gl_FragColor.xyz * aoColor.xyz;\n#else\ngl_FragColor.xyz = gl_FragColor.xyz * texture2D( tAO, vUv ).xyz;\n#endif\n}\nif( enableSpecular )\nspecularTex = texture2D( tSpecular, vUv ).xyz;\nmat3 tsb = mat3( normalize( vTangent ), normalize( vBinormal ), normalize( vNormal ) );\nvec3 finalNormal = tsb * normalTex;\n#ifdef FLIP_SIDED\nfinalNormal = -finalNormal;\n#endif\nvec3 normal = normalize( finalNormal );\nvec3 viewPosition = normalize( vViewPosition );\n#if MAX_POINT_LIGHTS > 0\nvec3 pointDiffuse = vec3( 0.0 );\nvec3 pointSpecular = vec3( 0.0 );\nfor ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {\nvec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );\nvec3 pointVector = lPosition.xyz + vViewPosition.xyz;\nfloat pointDistance = 1.0;\nif ( pointLightDistance[ i ] > 0.0 )\npointDistance = 1.0 - min( ( length( pointVector ) / pointLightDistance[ i ] ), 1.0 );\npointVector = normalize( pointVector );\n#ifdef WRAP_AROUND\nfloat pointDiffuseWeightFull = max( dot( normal, pointVector ), 0.0 );\nfloat pointDiffuseWeightHalf = max( 0.5 * dot( normal, pointVector ) + 0.5, 0.0 );\nvec3 pointDiffuseWeight = mix( vec3 ( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );\n#else\nfloat pointDiffuseWeight = max( dot( normal, pointVector ), 0.0 );\n#endif\npointDiffuse += pointDistance * pointLightColor[ i ] * diffuse * pointDiffuseWeight;\nvec3 pointHalfVector = normalize( pointVector + viewPosition );\nfloat pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );\nfloat pointSpecularWeight = specularTex.r * max( pow( pointDotNormalHalf, shininess ), 0.0 );\nfloat specularNormalization = ( shininess + 2.0001 ) / 8.0;\nvec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( pointVector, pointHalfVector ), 5.0 );\npointSpecular += schlick * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * pointDistance * specularNormalization;\n}\n#endif\n#if MAX_SPOT_LIGHTS > 0\nvec3 spotDiffuse = vec3( 0.0 );\nvec3 spotSpecular = vec3( 0.0 );\nfor ( int i = 0; i < MAX_SPOT_LIGHTS; i ++ ) {\nvec4 lPosition = viewMatrix * vec4( spotLightPosition[ i ], 1.0 );\nvec3 spotVector = lPosition.xyz + vViewPosition.xyz;\nfloat spotDistance = 1.0;\nif ( spotLightDistance[ i ] > 0.0 )\nspotDistance = 1.0 - min( ( length( spotVector ) / spotLightDistance[ i ] ), 1.0 );\nspotVector = normalize( spotVector );\nfloat spotEffect = dot( spotLightDirection[ i ], normalize( spotLightPosition[ i ] - vWorldPosition ) );\nif ( spotEffect > spotLightAngleCos[ i ] ) {\nspotEffect = max( pow( spotEffect, spotLightExponent[ i ] ), 0.0 );\n#ifdef WRAP_AROUND\nfloat spotDiffuseWeightFull = max( dot( normal, spotVector ), 0.0 );\nfloat spotDiffuseWeightHalf = max( 0.5 * dot( normal, spotVector ) + 0.5, 0.0 );\nvec3 spotDiffuseWeight = mix( vec3 ( spotDiffuseWeightFull ), vec3( spotDiffuseWeightHalf ), wrapRGB );\n#else\nfloat spotDiffuseWeight = max( dot( normal, spotVector ), 0.0 );\n#endif\nspotDiffuse += spotDistance * spotLightColor[ i ] * diffuse * spotDiffuseWeight * spotEffect;\nvec3 spotHalfVector = normalize( spotVector + viewPosition );\nfloat spotDotNormalHalf = max( dot( normal, spotHalfVector ), 0.0 );\nfloat spotSpecularWeight = specularTex.r * max( pow( spotDotNormalHalf, shininess ), 0.0 );\nfloat specularNormalization = ( shininess + 2.0001 ) / 8.0;\nvec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( spotVector, spotHalfVector ), 5.0 );\nspotSpecular += schlick * spotLightColor[ i ] * spotSpecularWeight * spotDiffuseWeight * spotDistance * specularNormalization * spotEffect;\n}\n}\n#endif\n#if MAX_DIR_LIGHTS > 0\nvec3 dirDiffuse = vec3( 0.0 );\nvec3 dirSpecular = vec3( 0.0 );\nfor( int i = 0; i < MAX_DIR_LIGHTS; i++ ) {\nvec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );\nvec3 dirVector = normalize( lDirection.xyz );\n#ifdef WRAP_AROUND\nfloat directionalLightWeightingFull = max( dot( normal, dirVector ), 0.0 );\nfloat directionalLightWeightingHalf = max( 0.5 * dot( normal, dirVector ) + 0.5, 0.0 );\nvec3 dirDiffuseWeight = mix( vec3( directionalLightWeightingFull ), vec3( directionalLightWeightingHalf ), wrapRGB );\n#else\nfloat dirDiffuseWeight = max( dot( normal, dirVector ), 0.0 );\n#endif\ndirDiffuse += directionalLightColor[ i ] * diffuse * dirDiffuseWeight;\nvec3 dirHalfVector = normalize( dirVector + viewPosition );\nfloat dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );\nfloat dirSpecularWeight = specularTex.r * max( pow( dirDotNormalHalf, shininess ), 0.0 );\nfloat specularNormalization = ( shininess + 2.0001 ) / 8.0;\nvec3 schlick = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( dirVector, dirHalfVector ), 5.0 );\ndirSpecular += schlick * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight * specularNormalization;\n}\n#endif\n#if MAX_HEMI_LIGHTS > 0\nvec3 hemiDiffuse  = vec3( 0.0 );\nvec3 hemiSpecular = vec3( 0.0 );\nfor( int i = 0; i < MAX_HEMI_LIGHTS; i ++ ) {\nvec4 lDirection = viewMatrix * vec4( hemisphereLightDirection[ i ], 0.0 );\nvec3 lVector = normalize( lDirection.xyz );\nfloat dotProduct = dot( normal, lVector );\nfloat hemiDiffuseWeight = 0.5 * dotProduct + 0.5;\nvec3 hemiColor = mix( hemisphereLightGroundColor[ i ], hemisphereLightSkyColor[ i ], hemiDiffuseWeight );\nhemiDiffuse += diffuse * hemiColor;\nvec3 hemiHalfVectorSky = normalize( lVector + viewPosition );\nfloat hemiDotNormalHalfSky = 0.5 * dot( normal, hemiHalfVectorSky ) + 0.5;\nfloat hemiSpecularWeightSky = specularTex.r * max( pow( hemiDotNormalHalfSky, shininess ), 0.0 );\nvec3 lVectorGround = -lVector;\nvec3 hemiHalfVectorGround = normalize( lVectorGround + viewPosition );\nfloat hemiDotNormalHalfGround = 0.5 * dot( normal, hemiHalfVectorGround ) + 0.5;\nfloat hemiSpecularWeightGround = specularTex.r * max( pow( hemiDotNormalHalfGround, shininess ), 0.0 );\nfloat dotProductGround = dot( normal, lVectorGround );\nfloat specularNormalization = ( shininess + 2.0001 ) / 8.0;\nvec3 schlickSky = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVector, hemiHalfVectorSky ), 5.0 );\nvec3 schlickGround = specular + vec3( 1.0 - specular ) * pow( 1.0 - dot( lVectorGround, hemiHalfVectorGround ), 5.0 );\nhemiSpecular += hemiColor * specularNormalization * ( schlickSky * hemiSpecularWeightSky * max( dotProduct, 0.0 ) + schlickGround * hemiSpecularWeightGround * max( dotProductGround, 0.0 ) );\n}\n#endif\nvec3 totalDiffuse = vec3( 0.0 );\nvec3 totalSpecular = vec3( 0.0 );\n#if MAX_DIR_LIGHTS > 0\ntotalDiffuse += dirDiffuse;\ntotalSpecular += dirSpecular;\n#endif\n#if MAX_HEMI_LIGHTS > 0\ntotalDiffuse += hemiDiffuse;\ntotalSpecular += hemiSpecular;\n#endif\n#if MAX_POINT_LIGHTS > 0\ntotalDiffuse += pointDiffuse;\ntotalSpecular += pointSpecular;\n#endif\n#if MAX_SPOT_LIGHTS > 0\ntotalDiffuse += spotDiffuse;\ntotalSpecular += spotSpecular;\n#endif\n#ifdef METAL\ngl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * ambient + totalSpecular );\n#else\ngl_FragColor.xyz = gl_FragColor.xyz * ( totalDiffuse + ambientLightColor * ambient ) + totalSpecular;\n#endif\nif ( enableReflection ) {\nvec3 vReflect;\nvec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );\nif ( useRefract ) {\nvReflect = refract( cameraToVertex, normal, refractionRatio );\n} else {\nvReflect = reflect( cameraToVertex, normal );\n}\nvec4 cubeColor = textureCube( tCube, vec3( -vReflect.x, vReflect.yz ) );\n#ifdef GAMMA_INPUT\ncubeColor.xyz *= cubeColor.xyz;\n#endif\ngl_FragColor.xyz = mix( gl_FragColor.xyz, cubeColor.xyz, specularTex.r * reflectivity );\n}",THREE.ShaderChunk.shadowmap_fragment,THREE.ShaderChunk.linear_to_gamma_fragment,THREE.ShaderChunk.fog_fragment,"}"].join("\n"),vertexShader:["attribute vec4 tangent;\nuniform vec2 uOffset;\nuniform vec2 uRepeat;\nuniform bool enableDisplacement;\n#ifdef VERTEX_TEXTURES\nuniform sampler2D tDisplacement;\nuniform float uDisplacementScale;\nuniform float uDisplacementBias;\n#endif\nvarying vec3 vTangent;\nvarying vec3 vBinormal;\nvarying vec3 vNormal;\nvarying vec2 vUv;\nvarying vec3 vWorldPosition;\nvarying vec3 vViewPosition;",THREE.ShaderChunk.skinning_pars_vertex,THREE.ShaderChunk.shadowmap_pars_vertex,"void main() {",THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.skinnormal_vertex,"#ifdef USE_SKINNING\nvNormal = normalize( normalMatrix * skinnedNormal.xyz );\nvec4 skinnedTangent = skinMatrix * vec4( tangent.xyz, 0.0 );\nvTangent = normalize( normalMatrix * skinnedTangent.xyz );\n#else\nvNormal = normalize( normalMatrix * normal );\nvTangent = normalize( normalMatrix * tangent.xyz );\n#endif\nvBinormal = normalize( cross( vNormal, vTangent ) * tangent.w );\nvUv = uv * uRepeat + uOffset;\nvec3 displacedPosition;\n#ifdef VERTEX_TEXTURES\nif ( enableDisplacement ) {\nvec3 dv = texture2D( tDisplacement, uv ).xyz;\nfloat df = uDisplacementScale * dv.x + uDisplacementBias;\ndisplacedPosition = position + normalize( normal ) * df;\n} else {\n#ifdef USE_SKINNING\nvec4 skinVertex = vec4( position, 1.0 );\nvec4 skinned  = boneMatX * skinVertex * skinWeight.x;\nskinned 	  += boneMatY * skinVertex * skinWeight.y;\ndisplacedPosition  = skinned.xyz;\n#else\ndisplacedPosition = position;\n#endif\n}\n#else\n#ifdef USE_SKINNING\nvec4 skinVertex = vec4( position, 1.0 );\nvec4 skinned  = boneMatX * skinVertex * skinWeight.x;\nskinned 	  += boneMatY * skinVertex * skinWeight.y;\ndisplacedPosition  = skinned.xyz;\n#else\ndisplacedPosition = position;\n#endif\n#endif\nvec4 mvPosition = modelViewMatrix * vec4( displacedPosition, 1.0 );\nvec4 worldPosition = modelMatrix * vec4( displacedPosition, 1.0 );\ngl_Position = projectionMatrix * mvPosition;\nvWorldPosition = worldPosition.xyz;\nvViewPosition = -mvPosition.xyz;\n#ifdef USE_SHADOWMAP\nfor( int i = 0; i < MAX_SHADOWS; i ++ ) {\nvShadowCoord[ i ] = shadowMatrix[ i ] * worldPosition;\n}\n#endif\n}"].join("\n")},cube:{uniforms:{tCube:{type:"t",value:null},tFlip:{type:"f",value:-1}},vertexShader:"varying vec3 vWorldPosition;\nvoid main() {\nvec4 worldPosition = modelMatrix * vec4( position, 1.0 );\nvWorldPosition = worldPosition.xyz;\ngl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"uniform samplerCube tCube;\nuniform float tFlip;\nvarying vec3 vWorldPosition;\nvoid main() {\ngl_FragColor = textureCube( tCube, vec3( tFlip * vWorldPosition.x, vWorldPosition.yz ) );\n}"},depthRGBA:{uniforms:{},vertexShader:[THREE.ShaderChunk.morphtarget_pars_vertex,THREE.ShaderChunk.skinning_pars_vertex,"void main() {",THREE.ShaderChunk.skinbase_vertex,THREE.ShaderChunk.morphtarget_vertex,THREE.ShaderChunk.skinning_vertex,THREE.ShaderChunk.default_vertex,"}"].join("\n"),fragmentShader:"vec4 pack_depth( const in float depth ) {\nconst vec4 bit_shift = vec4( 256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0 );\nconst vec4 bit_mask  = vec4( 0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0 );\nvec4 res = fract( depth * bit_shift );\nres -= res.xxyz * bit_mask;\nreturn res;\n}\nvoid main() {\ngl_FragData[ 0 ] = pack_depth( gl_FragCoord.z );\n}"}},THREE.WebGLRenderer=function(a){function b(a,b){var c=a.vertices.length,d=b.material;if(d.attributes){void 0===a.__webglCustomAttributesList&&(a.__webglCustomAttributesList=[]);for(var e in d.attributes){var f=d.attributes[e];if(!f.__webglInitialized||f.createUniqueBuffers){f.__webglInitialized=!0;var g=1;"v2"===f.type?g=2:"v3"===f.type?g=3:"v4"===f.type?g=4:"c"===f.type&&(g=3),f.size=g,f.array=new Float32Array(c*g),f.buffer=S.createBuffer(),f.buffer.belongsToAttribute=e,f.needsUpdate=!0}a.__webglCustomAttributesList.push(f)}}}function c(a,b){var c=b.geometry,g=a.faces3,h=3*g.length,i=1*g.length,j=3*g.length,g=d(b,a),k=f(g),l=e(g),m=g.vertexColors?g.vertexColors:!1;if(a.__vertexArray=new Float32Array(3*h),l&&(a.__normalArray=new Float32Array(3*h)),c.hasTangents&&(a.__tangentArray=new Float32Array(4*h)),m&&(a.__colorArray=new Float32Array(3*h)),k&&(0<c.faceVertexUvs.length&&(a.__uvArray=new Float32Array(2*h)),1<c.faceVertexUvs.length&&(a.__uv2Array=new Float32Array(2*h))),b.geometry.skinWeights.length&&b.geometry.skinIndices.length&&(a.__skinIndexArray=new Float32Array(4*h),a.__skinWeightArray=new Float32Array(4*h)),a.__faceArray=new Uint16Array(3*i),a.__lineArray=new Uint16Array(2*j),a.numMorphTargets)for(a.__morphTargetsArrays=[],c=0,k=a.numMorphTargets;k>c;c++)a.__morphTargetsArrays.push(new Float32Array(3*h));if(a.numMorphNormals)for(a.__morphNormalsArrays=[],c=0,k=a.numMorphNormals;k>c;c++)a.__morphNormalsArrays.push(new Float32Array(3*h));if(a.__webglFaceCount=3*i,a.__webglLineCount=2*j,g.attributes){void 0===a.__webglCustomAttributesList&&(a.__webglCustomAttributesList=[]);for(var n in g.attributes){var o,i=g.attributes[n],j={};for(o in i)j[o]=i[o];(!j.__webglInitialized||j.createUniqueBuffers)&&(j.__webglInitialized=!0,c=1,"v2"===j.type?c=2:"v3"===j.type?c=3:"v4"===j.type?c=4:"c"===j.type&&(c=3),j.size=c,j.array=new Float32Array(h*c),j.buffer=S.createBuffer(),j.buffer.belongsToAttribute=n,i.needsUpdate=!0,j.__original=i),a.__webglCustomAttributesList.push(j)}}a.__inittedArrays=!0}function d(a,b){return a.material instanceof THREE.MeshFaceMaterial?a.material.materials[b.materialIndex]:a.material}function e(a){return a instanceof THREE.MeshBasicMaterial&&!a.envMap||a instanceof THREE.MeshDepthMaterial?!1:a&&void 0!==a.shading&&a.shading===THREE.SmoothShading?THREE.SmoothShading:THREE.FlatShading}function f(a){return a.map||a.lightMap||a.bumpMap||a.normalMap||a.specularMap||a instanceof THREE.ShaderMaterial?!0:!1}function g(a,b,c,d){var e,f,g,i;for(f in b)g=b[f],e=c[f],g>=0&&(e?(i=e.itemSize,S.bindBuffer(S.ARRAY_BUFFER,e.buffer),h(g),S.vertexAttribPointer(g,i,S.FLOAT,!1,0,d*i*4)):a.defaultAttributeValues&&(2===a.defaultAttributeValues[f].length?S.vertexAttrib2fv(g,a.defaultAttributeValues[f]):3===a.defaultAttributeValues[f].length&&S.vertexAttrib3fv(g,a.defaultAttributeValues[f])))}function h(a){0===wb[a]&&(S.enableVertexAttribArray(a),wb[a]=1)}function i(){for(var a in wb)1===wb[a]&&(S.disableVertexAttribArray(a),wb[a]=0)}function j(a,b){return a.z!==b.z?b.z-a.z:a.id-b.id}function k(a,b){return b[0]-a[0]}function l(a,b,c){if(a.length)for(var d=0,e=a.length;e>d;d++)cb=$=null,ab=bb=fb=eb=lb=kb=gb=-1,Cb=!0,a[d].render(b,c,ub,vb),cb=$=null,ab=bb=fb=eb=lb=kb=gb=-1,Cb=!0}function m(a,b,c,d,e,f,g,h){var i,j,k,l;b?(j=a.length-1,l=b=-1):(j=0,b=a.length,l=1);for(var m=j;m!==b;m+=l)if(i=a[m],i.render){if(j=i.object,k=i.buffer,h)i=h;else{if(i=i[c],!i)continue;g&&X.setBlending(i.blending,i.blendEquation,i.blendSrc,i.blendDst),X.setDepthTest(i.depthTest),X.setDepthWrite(i.depthWrite),A(i.polygonOffset,i.polygonOffsetFactor,i.polygonOffsetUnits)}X.setMaterialFaces(i),k instanceof THREE.BufferGeometry?X.renderBufferDirect(d,e,f,i,k,j):k instanceof THREE.Geometry2?X.renderBufferGeometry2(d,e,f,i,k,j):X.renderBuffer(d,e,f,i,k,j)}}function n(a,b,c,d,e,f,g){for(var h,i,j=0,k=a.length;k>j;j++)if(h=a[j],i=h.object,i.visible){if(g)h=g;else{if(h=h[b],!h)continue;f&&X.setBlending(h.blending,h.blendEquation,h.blendSrc,h.blendDst),X.setDepthTest(h.depthTest),X.setDepthWrite(h.depthWrite),A(h.polygonOffset,h.polygonOffsetFactor,h.polygonOffsetUnits)}X.renderImmediateObject(c,d,e,h,i)}}function o(a,d){var e,f,g;if(void 0===a.__webglInit&&(a.__webglInit=!0,a._modelViewMatrix=new THREE.Matrix4,a._normalMatrix=new THREE.Matrix3,void 0!==a.geometry&&void 0===a.geometry.__webglInit&&(a.geometry.__webglInit=!0,a.geometry.addEventListener("dispose",Qb)),f=a.geometry,void 0!==f))if(f instanceof THREE.BufferGeometry){var h,i;for(h in f.attributes)i="index"===h?S.ELEMENT_ARRAY_BUFFER:S.ARRAY_BUFFER,g=f.attributes[h],g.buffer=S.createBuffer(),S.bindBuffer(i,g.buffer),S.bufferData(i,g.array,S.STATIC_DRAW)}else if(f instanceof THREE.Geometry2){h={},i=["vertices","normals","uvs"];for(g in i){var j=f[i[g]],k=S.createBuffer();S.bindBuffer(S.ARRAY_BUFFER,k),S.bufferData(S.ARRAY_BUFFER,j,S.STATIC_DRAW),h[i[g]]=k}K[f.id]=h}else if(a instanceof THREE.Mesh){for(e in g=a.material,void 0===f.geometryGroups&&f.makeGroups(g instanceof THREE.MeshFaceMaterial),f.geometryGroups)if(g=f.geometryGroups[e],!g.__webglVertexBuffer){if(h=g,h.__webglVertexBuffer=S.createBuffer(),h.__webglNormalBuffer=S.createBuffer(),h.__webglTangentBuffer=S.createBuffer(),h.__webglColorBuffer=S.createBuffer(),h.__webglUVBuffer=S.createBuffer(),h.__webglUV2Buffer=S.createBuffer(),h.__webglSkinIndicesBuffer=S.createBuffer(),h.__webglSkinWeightsBuffer=S.createBuffer(),h.__webglFaceBuffer=S.createBuffer(),h.__webglLineBuffer=S.createBuffer(),j=i=void 0,h.numMorphTargets)for(h.__webglMorphTargetsBuffers=[],i=0,j=h.numMorphTargets;j>i;i++)h.__webglMorphTargetsBuffers.push(S.createBuffer());if(h.numMorphNormals)for(h.__webglMorphNormalsBuffers=[],i=0,j=h.numMorphNormals;j>i;i++)h.__webglMorphNormalsBuffers.push(S.createBuffer());X.info.memory.geometries++,c(g,a),f.verticesNeedUpdate=!0,f.morphTargetsNeedUpdate=!0,f.elementsNeedUpdate=!0,f.uvsNeedUpdate=!0,f.normalsNeedUpdate=!0,f.tangentsNeedUpdate=!0,f.colorsNeedUpdate=!0}}else a instanceof THREE.Line?f.__webglVertexBuffer||(g=f,g.__webglVertexBuffer=S.createBuffer(),g.__webglColorBuffer=S.createBuffer(),g.__webglLineDistanceBuffer=S.createBuffer(),X.info.memory.geometries++,g=f,h=g.vertices.length,g.__vertexArray=new Float32Array(3*h),g.__colorArray=new Float32Array(3*h),g.__lineDistanceArray=new Float32Array(1*h),g.__webglLineCount=h,b(g,a),f.verticesNeedUpdate=!0,f.colorsNeedUpdate=!0,f.lineDistancesNeedUpdate=!0):a instanceof THREE.ParticleSystem&&!f.__webglVertexBuffer&&(g=f,g.__webglVertexBuffer=S.createBuffer(),g.__webglColorBuffer=S.createBuffer(),X.info.memory.geometries++,g=f,h=g.vertices.length,g.__vertexArray=new Float32Array(3*h),g.__colorArray=new Float32Array(3*h),g.__sortArray=[],g.__webglParticleCount=h,b(g,a),f.verticesNeedUpdate=!0,f.colorsNeedUpdate=!0);
if(void 0===a.__webglActive){if(a instanceof THREE.Mesh){if(f=a.geometry,f instanceof THREE.BufferGeometry)p(d.__webglObjects,f,a);else if(f instanceof THREE.Geometry2)p(d.__webglObjects,f,a);else if(f instanceof THREE.Geometry)for(e in f.geometryGroups)g=f.geometryGroups[e],p(d.__webglObjects,g,a)}else a instanceof THREE.Line||a instanceof THREE.ParticleSystem?(f=a.geometry,p(d.__webglObjects,f,a)):a instanceof THREE.ImmediateRenderObject||a.immediateRenderCallback?d.__webglObjectsImmediate.push({id:null,object:a,opaque:null,transparent:null,z:0}):a instanceof THREE.Sprite?d.__webglSprites.push(a):a instanceof THREE.LensFlare&&d.__webglFlares.push(a);a.__webglActive=!0}}function p(a,b,c){a.push({id:null,buffer:b,object:c,opaque:null,transparent:null,z:0})}function q(a){for(var b in a.attributes)if(a.attributes[b].needsUpdate)return!0;return!1}function r(a){for(var b in a.attributes)a.attributes[b].needsUpdate=!1}function s(a,b){a instanceof THREE.Mesh||a instanceof THREE.ParticleSystem||a instanceof THREE.Line?t(b.__webglObjects,a):a instanceof THREE.Sprite?u(b.__webglSprites,a):a instanceof THREE.LensFlare?u(b.__webglFlares,a):(a instanceof THREE.ImmediateRenderObject||a.immediateRenderCallback)&&t(b.__webglObjectsImmediate,a),delete a.__webglActive}function t(a,b){for(var c=a.length-1;c>=0;c--)a[c].object===b&&a.splice(c,1)}function u(a,b){for(var c=a.length-1;c>=0;c--)a[c]===b&&a.splice(c,1)}function v(a,b,c,d,e){db=0,d.needsUpdate&&(d.program&&Vb(d),X.initMaterial(d,b,c,e),d.needsUpdate=!1),d.morphTargets&&!e.__webglMorphTargetInfluences&&(e.__webglMorphTargetInfluences=new Float32Array(X.maxMorphTargets));var f=!1,g=d.program,h=g.uniforms,i=d.uniforms;if(g!==$&&(S.useProgram(g),$=g,f=!0),d.id!==ab&&(ab=d.id,f=!0),(f||a!==cb)&&(S.uniformMatrix4fv(h.projectionMatrix,!1,a.projectionMatrix.elements),a!==cb&&(cb=a)),d.skinning)if(Jb&&e.useVertexTexture){if(null!==h.boneTexture){var j=w();S.uniform1i(h.boneTexture,j),X.setTexture(e.boneTexture,j)}null!==h.boneTextureWidth&&S.uniform1i(h.boneTextureWidth,e.boneTextureWidth),null!==h.boneTextureHeight&&S.uniform1i(h.boneTextureHeight,e.boneTextureHeight)}else null!==h.boneGlobalMatrices&&S.uniformMatrix4fv(h.boneGlobalMatrices,!1,e.boneMatrices);if(f){if(c&&d.fog&&(i.fogColor.value=c.color,c instanceof THREE.Fog?(i.fogNear.value=c.near,i.fogFar.value=c.far):c instanceof THREE.FogExp2&&(i.fogDensity.value=c.density)),d instanceof THREE.MeshPhongMaterial||d instanceof THREE.MeshLambertMaterial||d.lights){if(Cb){var k,l,m,n,o=j=0,p=0,q=Db,r=q.directional.colors,s=q.directional.positions,t=q.point.colors,u=q.point.positions,v=q.point.distances,z=q.spot.colors,A=q.spot.positions,B=q.spot.distances,C=q.spot.directions,E=q.spot.anglesCos,F=q.spot.exponents,I=q.hemi.skyColors,J=q.hemi.groundColors,K=q.hemi.positions,L=0,M=0,N=0,O=0,P=0,Q=0,R=0,T=0,U=k=0;for(c=n=U=0,f=b.length;f>c;c++)k=b[c],k.onlyShadow||(l=k.color,m=k.intensity,n=k.distance,k instanceof THREE.AmbientLight?k.visible&&(X.gammaInput?(j+=l.r*l.r,o+=l.g*l.g,p+=l.b*l.b):(j+=l.r,o+=l.g,p+=l.b)):k instanceof THREE.DirectionalLight?(P+=1,k.visible&&(Bb.setFromMatrixPosition(k.matrixWorld),Ab.setFromMatrixPosition(k.target.matrixWorld),Bb.sub(Ab),Bb.normalize(),0!==Bb.x||0!==Bb.y||0!==Bb.z)&&(k=3*L,s[k]=Bb.x,s[k+1]=Bb.y,s[k+2]=Bb.z,X.gammaInput?x(r,k,l,m*m):y(r,k,l,m),L+=1)):k instanceof THREE.PointLight?(Q+=1,k.visible&&(U=3*M,X.gammaInput?x(t,U,l,m*m):y(t,U,l,m),Ab.setFromMatrixPosition(k.matrixWorld),u[U]=Ab.x,u[U+1]=Ab.y,u[U+2]=Ab.z,v[M]=n,M+=1)):k instanceof THREE.SpotLight?(R+=1,k.visible&&(U=3*N,X.gammaInput?x(z,U,l,m*m):y(z,U,l,m),Ab.setFromMatrixPosition(k.matrixWorld),A[U]=Ab.x,A[U+1]=Ab.y,A[U+2]=Ab.z,B[N]=n,Bb.copy(Ab),Ab.setFromMatrixPosition(k.target.matrixWorld),Bb.sub(Ab),Bb.normalize(),C[U]=Bb.x,C[U+1]=Bb.y,C[U+2]=Bb.z,E[N]=Math.cos(k.angle),F[N]=k.exponent,N+=1)):k instanceof THREE.HemisphereLight&&(T+=1,k.visible&&(Bb.setFromMatrixPosition(k.matrixWorld),Bb.normalize(),0!==Bb.x||0!==Bb.y||0!==Bb.z))&&(n=3*O,K[n]=Bb.x,K[n+1]=Bb.y,K[n+2]=Bb.z,l=k.color,k=k.groundColor,X.gammaInput?(m*=m,x(I,n,l,m),x(J,n,k,m)):(y(I,n,l,m),y(J,n,k,m)),O+=1));for(c=3*L,f=Math.max(r.length,3*P);f>c;c++)r[c]=0;for(c=3*M,f=Math.max(t.length,3*Q);f>c;c++)t[c]=0;for(c=3*N,f=Math.max(z.length,3*R);f>c;c++)z[c]=0;for(c=3*O,f=Math.max(I.length,3*T);f>c;c++)I[c]=0;for(c=3*O,f=Math.max(J.length,3*T);f>c;c++)J[c]=0;q.directional.length=L,q.point.length=M,q.spot.length=N,q.hemi.length=O,q.ambient[0]=j,q.ambient[1]=o,q.ambient[2]=p,Cb=!1}c=Db,i.ambientLightColor.value=c.ambient,i.directionalLightColor.value=c.directional.colors,i.directionalLightDirection.value=c.directional.positions,i.pointLightColor.value=c.point.colors,i.pointLightPosition.value=c.point.positions,i.pointLightDistance.value=c.point.distances,i.spotLightColor.value=c.spot.colors,i.spotLightPosition.value=c.spot.positions,i.spotLightDistance.value=c.spot.distances,i.spotLightDirection.value=c.spot.directions,i.spotLightAngleCos.value=c.spot.anglesCos,i.spotLightExponent.value=c.spot.exponents,i.hemisphereLightSkyColor.value=c.hemi.skyColors,i.hemisphereLightGroundColor.value=c.hemi.groundColors,i.hemisphereLightDirection.value=c.hemi.positions}if(d instanceof THREE.MeshBasicMaterial||d instanceof THREE.MeshLambertMaterial||d instanceof THREE.MeshPhongMaterial){i.opacity.value=d.opacity,X.gammaInput?i.diffuse.value.copyGammaToLinear(d.color):i.diffuse.value=d.color,i.map.value=d.map,i.lightMap.value=d.lightMap,i.specularMap.value=d.specularMap,d.bumpMap&&(i.bumpMap.value=d.bumpMap,i.bumpScale.value=d.bumpScale),d.normalMap&&(i.normalMap.value=d.normalMap,i.normalScale.value.copy(d.normalScale));var V;d.map?V=d.map:d.specularMap?V=d.specularMap:d.normalMap?V=d.normalMap:d.bumpMap&&(V=d.bumpMap),void 0!==V&&(c=V.offset,V=V.repeat,i.offsetRepeat.value.set(c.x,c.y,V.x,V.y)),i.envMap.value=d.envMap,i.flipEnvMap.value=d.envMap instanceof THREE.WebGLRenderTargetCube?1:-1,i.reflectivity.value=d.reflectivity,i.refractionRatio.value=d.refractionRatio,i.combine.value=d.combine,i.useRefract.value=d.envMap&&d.envMap.mapping instanceof THREE.CubeRefractionMapping}if(d instanceof THREE.LineBasicMaterial?(i.diffuse.value=d.color,i.opacity.value=d.opacity):d instanceof THREE.LineDashedMaterial?(i.diffuse.value=d.color,i.opacity.value=d.opacity,i.dashSize.value=d.dashSize,i.totalSize.value=d.dashSize+d.gapSize,i.scale.value=d.scale):d instanceof THREE.ParticleSystemMaterial?(i.psColor.value=d.color,i.opacity.value=d.opacity,i.size.value=d.size,i.scale.value=H.height/2,i.map.value=d.map):d instanceof THREE.MeshPhongMaterial?(i.shininess.value=d.shininess,X.gammaInput?(i.ambient.value.copyGammaToLinear(d.ambient),i.emissive.value.copyGammaToLinear(d.emissive),i.specular.value.copyGammaToLinear(d.specular)):(i.ambient.value=d.ambient,i.emissive.value=d.emissive,i.specular.value=d.specular),d.wrapAround&&i.wrapRGB.value.copy(d.wrapRGB)):d instanceof THREE.MeshLambertMaterial?(X.gammaInput?(i.ambient.value.copyGammaToLinear(d.ambient),i.emissive.value.copyGammaToLinear(d.emissive)):(i.ambient.value=d.ambient,i.emissive.value=d.emissive),d.wrapAround&&i.wrapRGB.value.copy(d.wrapRGB)):d instanceof THREE.MeshDepthMaterial?(i.mNear.value=a.near,i.mFar.value=a.far,i.opacity.value=d.opacity):d instanceof THREE.MeshNormalMaterial&&(i.opacity.value=d.opacity),e.receiveShadow&&!d._shadowPass&&i.shadowMatrix)for(c=V=0,f=b.length;f>c;c++)j=b[c],j.castShadow&&(j instanceof THREE.SpotLight||j instanceof THREE.DirectionalLight&&!j.shadowCascade)&&(i.shadowMap.value[V]=j.shadowMap,i.shadowMapSize.value[V]=j.shadowMapSize,i.shadowMatrix.value[V]=j.shadowMatrix,i.shadowDarkness.value[V]=j.shadowDarkness,i.shadowBias.value[V]=j.shadowBias,V++);for(b=d.uniformsList,i=0,V=b.length;V>i;i++)if(f=g.uniforms[b[i][1]])if(c=b[i][0],o=c.type,j=c.value,"i"===o)S.uniform1i(f,j);else if("f"===o)S.uniform1f(f,j);else if("v2"===o)S.uniform2f(f,j.x,j.y);else if("v3"===o)S.uniform3f(f,j.x,j.y,j.z);else if("v4"===o)S.uniform4f(f,j.x,j.y,j.z,j.w);else if("c"===o)S.uniform3f(f,j.r,j.g,j.b);else if("iv1"===o)S.uniform1iv(f,j);else if("iv"===o)S.uniform3iv(f,j);else if("fv1"===o)S.uniform1fv(f,j);else if("fv"===o)S.uniform3fv(f,j);else if("v2v"===o){for(void 0===c._array&&(c._array=new Float32Array(2*j.length)),o=0,p=j.length;p>o;o++)q=2*o,c._array[q]=j[o].x,c._array[q+1]=j[o].y;S.uniform2fv(f,c._array)}else if("v3v"===o){for(void 0===c._array&&(c._array=new Float32Array(3*j.length)),o=0,p=j.length;p>o;o++)q=3*o,c._array[q]=j[o].x,c._array[q+1]=j[o].y,c._array[q+2]=j[o].z;S.uniform3fv(f,c._array)}else if("v4v"===o){for(void 0===c._array&&(c._array=new Float32Array(4*j.length)),o=0,p=j.length;p>o;o++)q=4*o,c._array[q]=j[o].x,c._array[q+1]=j[o].y,c._array[q+2]=j[o].z,c._array[q+3]=j[o].w;S.uniform4fv(f,c._array)}else if("m4"===o)void 0===c._array&&(c._array=new Float32Array(16)),j.flattenToArray(c._array),S.uniformMatrix4fv(f,!1,c._array);else if("m4v"===o){for(void 0===c._array&&(c._array=new Float32Array(16*j.length)),o=0,p=j.length;p>o;o++)j[o].flattenToArrayOffset(c._array,16*o);S.uniformMatrix4fv(f,!1,c._array)}else if("t"===o){if(q=j,j=w(),S.uniform1i(f,j),q)if(q.image instanceof Array&&6===q.image.length){if(c=q,f=j,6===c.image.length)if(c.needsUpdate){for(c.image.__webglTextureCube||(c.addEventListener("dispose",Rb),c.image.__webglTextureCube=S.createTexture(),X.info.memory.textures++),S.activeTexture(S.TEXTURE0+f),S.bindTexture(S.TEXTURE_CUBE_MAP,c.image.__webglTextureCube),S.pixelStorei(S.UNPACK_FLIP_Y_WEBGL,c.flipY),f=c instanceof THREE.CompressedTexture,j=[],o=0;6>o;o++)X.autoScaleCubemaps&&!f?(p=j,q=o,r=c.image[o],t=Gb,r.width<=t&&r.height<=t||(u=Math.max(r.width,r.height),s=Math.floor(r.width*t/u),t=Math.floor(r.height*t/u),u=document.createElement("canvas"),u.width=s,u.height=t,u.getContext("2d").drawImage(r,0,0,r.width,r.height,0,0,s,t),r=u),p[q]=r):j[o]=c.image[o];for(o=j[0],p=THREE.Math.isPowerOfTwo(o.width)&&THREE.Math.isPowerOfTwo(o.height),q=G(c.format),r=G(c.type),D(S.TEXTURE_CUBE_MAP,c,p),o=0;6>o;o++)if(f)for(t=j[o].mipmaps,u=0,v=t.length;v>u;u++)s=t[u],c.format!==THREE.RGBAFormat?S.compressedTexImage2D(S.TEXTURE_CUBE_MAP_POSITIVE_X+o,u,q,s.width,s.height,0,s.data):S.texImage2D(S.TEXTURE_CUBE_MAP_POSITIVE_X+o,u,q,s.width,s.height,0,q,r,s.data);else S.texImage2D(S.TEXTURE_CUBE_MAP_POSITIVE_X+o,0,q,q,r,j[o]);c.generateMipmaps&&p&&S.generateMipmap(S.TEXTURE_CUBE_MAP),c.needsUpdate=!1,c.onUpdate&&c.onUpdate()}else S.activeTexture(S.TEXTURE0+f),S.bindTexture(S.TEXTURE_CUBE_MAP,c.image.__webglTextureCube)}else q instanceof THREE.WebGLRenderTargetCube?(c=q,S.activeTexture(S.TEXTURE0+j),S.bindTexture(S.TEXTURE_CUBE_MAP,c.__webglTexture)):X.setTexture(q,j)}else if("tv"===o){for(void 0===c._array&&(c._array=[]),o=0,p=c.value.length;p>o;o++)c._array[o]=w();for(S.uniform1iv(f,c._array),o=0,p=c.value.length;p>o;o++)q=c.value[o],j=c._array[o],q&&X.setTexture(q,j)}else console.warn("THREE.WebGLRenderer: Unknown uniform type: "+o);(d instanceof THREE.ShaderMaterial||d instanceof THREE.MeshPhongMaterial||d.envMap)&&null!==h.cameraPosition&&(Ab.setFromMatrixPosition(a.matrixWorld),S.uniform3f(h.cameraPosition,Ab.x,Ab.y,Ab.z)),(d instanceof THREE.MeshPhongMaterial||d instanceof THREE.MeshLambertMaterial||d instanceof THREE.ShaderMaterial||d.skinning)&&null!==h.viewMatrix&&S.uniformMatrix4fv(h.viewMatrix,!1,a.matrixWorldInverse.elements)}return S.uniformMatrix4fv(h.modelViewMatrix,!1,e._modelViewMatrix.elements),h.normalMatrix&&S.uniformMatrix3fv(h.normalMatrix,!1,e._normalMatrix.elements),null!==h.modelMatrix&&S.uniformMatrix4fv(h.modelMatrix,!1,e.matrixWorld.elements),g}function w(){var a=db;return a>=Eb&&console.warn("WebGLRenderer: trying to use "+a+" texture units while this GPU supports only "+Eb),db+=1,a}function x(a,b,c,d){a[b]=c.r*c.r*d,a[b+1]=c.g*c.g*d,a[b+2]=c.b*c.b*d}function y(a,b,c,d){a[b]=c.r*d,a[b+1]=c.g*d,a[b+2]=c.b*d}function z(a){a!==pb&&(S.lineWidth(a),pb=a)}function A(a,b,c){mb!==a&&(a?S.enable(S.POLYGON_OFFSET_FILL):S.disable(S.POLYGON_OFFSET_FILL),mb=a),!a||nb===b&&ob===c||(S.polygonOffset(b,c),nb=b,ob=c)}function B(a){a=a.split("\n");for(var b=0,c=a.length;c>b;b++)a[b]=b+1+": "+a[b];return a.join("\n")}function C(a,b){var c;return"fragment"===a?c=S.createShader(S.FRAGMENT_SHADER):"vertex"===a&&(c=S.createShader(S.VERTEX_SHADER)),S.shaderSource(c,b),S.compileShader(c),S.getShaderParameter(c,S.COMPILE_STATUS)?c:(console.error(S.getShaderInfoLog(c)),console.error(B(b)),null)}function D(a,b,c){c?(S.texParameteri(a,S.TEXTURE_WRAP_S,G(b.wrapS)),S.texParameteri(a,S.TEXTURE_WRAP_T,G(b.wrapT)),S.texParameteri(a,S.TEXTURE_MAG_FILTER,G(b.magFilter)),S.texParameteri(a,S.TEXTURE_MIN_FILTER,G(b.minFilter))):(S.texParameteri(a,S.TEXTURE_WRAP_S,S.CLAMP_TO_EDGE),S.texParameteri(a,S.TEXTURE_WRAP_T,S.CLAMP_TO_EDGE),S.texParameteri(a,S.TEXTURE_MAG_FILTER,F(b.magFilter)),S.texParameteri(a,S.TEXTURE_MIN_FILTER,F(b.minFilter))),V&&b.type!==THREE.FloatType&&(1<b.anisotropy||b.__oldAnisotropy)&&(S.texParameterf(a,V.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(b.anisotropy,Hb)),b.__oldAnisotropy=b.anisotropy)}function E(a,b){S.bindRenderbuffer(S.RENDERBUFFER,a),b.depthBuffer&&!b.stencilBuffer?(S.renderbufferStorage(S.RENDERBUFFER,S.DEPTH_COMPONENT16,b.width,b.height),S.framebufferRenderbuffer(S.FRAMEBUFFER,S.DEPTH_ATTACHMENT,S.RENDERBUFFER,a)):b.depthBuffer&&b.stencilBuffer?(S.renderbufferStorage(S.RENDERBUFFER,S.DEPTH_STENCIL,b.width,b.height),S.framebufferRenderbuffer(S.FRAMEBUFFER,S.DEPTH_STENCIL_ATTACHMENT,S.RENDERBUFFER,a)):S.renderbufferStorage(S.RENDERBUFFER,S.RGBA4,b.width,b.height)}function F(a){return a===THREE.NearestFilter||a===THREE.NearestMipMapNearestFilter||a===THREE.NearestMipMapLinearFilter?S.NEAREST:S.LINEAR}function G(a){if(a===THREE.RepeatWrapping)return S.REPEAT;if(a===THREE.ClampToEdgeWrapping)return S.CLAMP_TO_EDGE;if(a===THREE.MirroredRepeatWrapping)return S.MIRRORED_REPEAT;if(a===THREE.NearestFilter)return S.NEAREST;if(a===THREE.NearestMipMapNearestFilter)return S.NEAREST_MIPMAP_NEAREST;if(a===THREE.NearestMipMapLinearFilter)return S.NEAREST_MIPMAP_LINEAR;if(a===THREE.LinearFilter)return S.LINEAR;if(a===THREE.LinearMipMapNearestFilter)return S.LINEAR_MIPMAP_NEAREST;if(a===THREE.LinearMipMapLinearFilter)return S.LINEAR_MIPMAP_LINEAR;if(a===THREE.UnsignedByteType)return S.UNSIGNED_BYTE;if(a===THREE.UnsignedShort4444Type)return S.UNSIGNED_SHORT_4_4_4_4;if(a===THREE.UnsignedShort5551Type)return S.UNSIGNED_SHORT_5_5_5_1;if(a===THREE.UnsignedShort565Type)return S.UNSIGNED_SHORT_5_6_5;if(a===THREE.ByteType)return S.BYTE;if(a===THREE.ShortType)return S.SHORT;if(a===THREE.UnsignedShortType)return S.UNSIGNED_SHORT;if(a===THREE.IntType)return S.INT;if(a===THREE.UnsignedIntType)return S.UNSIGNED_INT;if(a===THREE.FloatType)return S.FLOAT;if(a===THREE.AlphaFormat)return S.ALPHA;if(a===THREE.RGBFormat)return S.RGB;if(a===THREE.RGBAFormat)return S.RGBA;if(a===THREE.LuminanceFormat)return S.LUMINANCE;if(a===THREE.LuminanceAlphaFormat)return S.LUMINANCE_ALPHA;if(a===THREE.AddEquation)return S.FUNC_ADD;if(a===THREE.SubtractEquation)return S.FUNC_SUBTRACT;if(a===THREE.ReverseSubtractEquation)return S.FUNC_REVERSE_SUBTRACT;if(a===THREE.ZeroFactor)return S.ZERO;if(a===THREE.OneFactor)return S.ONE;if(a===THREE.SrcColorFactor)return S.SRC_COLOR;if(a===THREE.OneMinusSrcColorFactor)return S.ONE_MINUS_SRC_COLOR;if(a===THREE.SrcAlphaFactor)return S.SRC_ALPHA;if(a===THREE.OneMinusSrcAlphaFactor)return S.ONE_MINUS_SRC_ALPHA;if(a===THREE.DstAlphaFactor)return S.DST_ALPHA;if(a===THREE.OneMinusDstAlphaFactor)return S.ONE_MINUS_DST_ALPHA;if(a===THREE.DstColorFactor)return S.DST_COLOR;if(a===THREE.OneMinusDstColorFactor)return S.ONE_MINUS_DST_COLOR;if(a===THREE.SrcAlphaSaturateFactor)return S.SRC_ALPHA_SATURATE;if(void 0!==W){if(a===THREE.RGB_S3TC_DXT1_Format)return W.COMPRESSED_RGB_S3TC_DXT1_EXT;if(a===THREE.RGBA_S3TC_DXT1_Format)return W.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(a===THREE.RGBA_S3TC_DXT3_Format)return W.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(a===THREE.RGBA_S3TC_DXT5_Format)return W.COMPRESSED_RGBA_S3TC_DXT5_EXT}return 0}console.log("THREE.WebGLRenderer",THREE.REVISION),a=a||{};var H=void 0!==a.canvas?a.canvas:document.createElement("canvas"),I=void 0!==a.context?a.context:null,J=void 0!==a.precision?a.precision:"highp",K={},L=void 0!==a.alpha?a.alpha:!1,M=void 0!==a.premultipliedAlpha?a.premultipliedAlpha:!0,N=void 0!==a.antialias?a.antialias:!1,O=void 0!==a.stencil?a.stencil:!0,P=void 0!==a.preserveDrawingBuffer?a.preserveDrawingBuffer:!1,Q=new THREE.Color(0),R=0;this.domElement=H,this.context=null,this.devicePixelRatio=void 0!==a.devicePixelRatio?a.devicePixelRatio:void 0!==self.devicePixelRatio?self.devicePixelRatio:1,this.autoUpdateObjects=this.sortObjects=this.autoClearStencil=this.autoClearDepth=this.autoClearColor=this.autoClear=!0,this.shadowMapEnabled=this.gammaOutput=this.gammaInput=!1,this.shadowMapAutoUpdate=!0,this.shadowMapType=THREE.PCFShadowMap,this.shadowMapCullFace=THREE.CullFaceFront,this.shadowMapCascade=this.shadowMapDebug=!1,this.maxMorphTargets=8,this.maxMorphNormals=4,this.autoScaleCubemaps=!0,this.renderPluginsPre=[],this.renderPluginsPost=[],this.info={memory:{programs:0,geometries:0,textures:0},render:{calls:0,vertices:0,faces:0,points:0}};var S,T,U,V,W,X=this,Y=[],Z=0,$=null,_=null,ab=-1,bb=null,cb=null,db=0,eb=-1,fb=-1,gb=-1,hb=-1,ib=-1,jb=-1,kb=-1,lb=-1,mb=null,nb=null,ob=null,pb=null,qb=0,rb=0,sb=H.width,tb=H.height,ub=0,vb=0,wb=new Uint8Array(16),xb=new THREE.Frustum,yb=new THREE.Matrix4,zb=new THREE.Matrix4,Ab=new THREE.Vector3,Bb=new THREE.Vector3,Cb=!0,Db={ambient:[0,0,0],directional:{length:0,colors:[],positions:[]},point:{length:0,colors:[],positions:[],distances:[]},spot:{length:0,colors:[],positions:[],distances:[],directions:[],anglesCos:[],exponents:[]},hemi:{length:0,skyColors:[],groundColors:[],positions:[]}};!function(){try{var a={alpha:L,premultipliedAlpha:M,antialias:N,stencil:O,preserveDrawingBuffer:P};if(S=I||H.getContext("webgl",a)||H.getContext("experimental-webgl",a),null===S)throw"Error creating WebGL context."}catch(b){console.error(b)}T=S.getExtension("OES_texture_float"),S.getExtension("OES_texture_float_linear"),U=S.getExtension("OES_standard_derivatives"),V=S.getExtension("EXT_texture_filter_anisotropic")||S.getExtension("MOZ_EXT_texture_filter_anisotropic")||S.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),W=S.getExtension("WEBGL_compressed_texture_s3tc")||S.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||S.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),T||console.log("THREE.WebGLRenderer: Float textures not supported."),U||console.log("THREE.WebGLRenderer: Standard derivatives not supported."),V||console.log("THREE.WebGLRenderer: Anisotropic texture filtering not supported."),W||console.log("THREE.WebGLRenderer: S3TC compressed textures not supported."),void 0===S.getShaderPrecisionFormat&&(S.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}(),S.clearColor(0,0,0,1),S.clearDepth(1),S.clearStencil(0),S.enable(S.DEPTH_TEST),S.depthFunc(S.LEQUAL),S.frontFace(S.CCW),S.cullFace(S.BACK),S.enable(S.CULL_FACE),S.enable(S.BLEND),S.blendEquation(S.FUNC_ADD),S.blendFunc(S.SRC_ALPHA,S.ONE_MINUS_SRC_ALPHA),S.viewport(qb,rb,sb,tb),S.clearColor(Q.r,Q.g,Q.b,R),this.context=S;var Eb=S.getParameter(S.MAX_TEXTURE_IMAGE_UNITS),Fb=S.getParameter(S.MAX_VERTEX_TEXTURE_IMAGE_UNITS);S.getParameter(S.MAX_TEXTURE_SIZE);var Gb=S.getParameter(S.MAX_CUBE_MAP_TEXTURE_SIZE),Hb=V?S.getParameter(V.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0,Ib=Fb>0,Jb=Ib&&T;W&&S.getParameter(S.COMPRESSED_TEXTURE_FORMATS);var Kb=S.getShaderPrecisionFormat(S.VERTEX_SHADER,S.HIGH_FLOAT),Lb=S.getShaderPrecisionFormat(S.VERTEX_SHADER,S.MEDIUM_FLOAT);S.getShaderPrecisionFormat(S.VERTEX_SHADER,S.LOW_FLOAT);var Mb=S.getShaderPrecisionFormat(S.FRAGMENT_SHADER,S.HIGH_FLOAT),Nb=S.getShaderPrecisionFormat(S.FRAGMENT_SHADER,S.MEDIUM_FLOAT);S.getShaderPrecisionFormat(S.FRAGMENT_SHADER,S.LOW_FLOAT),S.getShaderPrecisionFormat(S.VERTEX_SHADER,S.HIGH_INT),S.getShaderPrecisionFormat(S.VERTEX_SHADER,S.MEDIUM_INT),S.getShaderPrecisionFormat(S.VERTEX_SHADER,S.LOW_INT),S.getShaderPrecisionFormat(S.FRAGMENT_SHADER,S.HIGH_INT),S.getShaderPrecisionFormat(S.FRAGMENT_SHADER,S.MEDIUM_INT),S.getShaderPrecisionFormat(S.FRAGMENT_SHADER,S.LOW_INT);var Ob=0<Kb.precision&&0<Mb.precision,Pb=0<Lb.precision&&0<Nb.precision;"highp"!==J||Ob||(Pb?(J="mediump",console.warn("WebGLRenderer: highp not supported, using mediump")):(J="lowp",console.warn("WebGLRenderer: highp and mediump not supported, using lowp"))),"mediump"!==J||Pb||(J="lowp",console.warn("WebGLRenderer: mediump not supported, using lowp")),this.getContext=function(){return S},this.supportsVertexTextures=function(){return Ib},this.supportsFloatTextures=function(){return T},this.supportsStandardDerivatives=function(){return U},this.supportsCompressedTextureS3TC=function(){return W},this.getMaxAnisotropy=function(){return Hb},this.getPrecision=function(){return J},this.setSize=function(a,b,c){H.width=a*this.devicePixelRatio,H.height=b*this.devicePixelRatio,1!==this.devicePixelRatio&&!1!==c&&(H.style.width=a+"px",H.style.height=b+"px"),this.setViewport(0,0,a,b)},this.setViewport=function(a,b,c,d){qb=a*this.devicePixelRatio,rb=b*this.devicePixelRatio,sb=c*this.devicePixelRatio,tb=d*this.devicePixelRatio,S.viewport(qb,rb,sb,tb)},this.setScissor=function(a,b,c,d){S.scissor(a*this.devicePixelRatio,b*this.devicePixelRatio,c*this.devicePixelRatio,d*this.devicePixelRatio)},this.enableScissorTest=function(a){a?S.enable(S.SCISSOR_TEST):S.disable(S.SCISSOR_TEST)},this.setClearColor=function(a,b){Q.set(a),R=void 0!==b?b:1,S.clearColor(Q.r,Q.g,Q.b,R)},this.setClearColorHex=function(a,b){console.warn("DEPRECATED: .setClearColorHex() is being removed. Use .setClearColor() instead."),this.setClearColor(a,b)},this.getClearColor=function(){return Q},this.getClearAlpha=function(){return R},this.clear=function(a,b,c){var d=0;(void 0===a||a)&&(d|=S.COLOR_BUFFER_BIT),(void 0===b||b)&&(d|=S.DEPTH_BUFFER_BIT),(void 0===c||c)&&(d|=S.STENCIL_BUFFER_BIT),S.clear(d)},this.clearColor=function(){S.clear(S.COLOR_BUFFER_BIT)},this.clearDepth=function(){S.clear(S.DEPTH_BUFFER_BIT)},this.clearStencil=function(){S.clear(S.STENCIL_BUFFER_BIT)},this.clearTarget=function(a,b,c,d){this.setRenderTarget(a),this.clear(b,c,d)},this.addPostPlugin=function(a){a.init(this),this.renderPluginsPost.push(a)},this.addPrePlugin=function(a){a.init(this),this.renderPluginsPre.push(a)},this.updateShadowMap=function(a,b){$=null,ab=bb=lb=kb=gb=-1,Cb=!0,fb=eb=-1,this.shadowMapPlugin.update(a,b)};var Qb=function(a){if(a=a.target,a.removeEventListener("dispose",Qb),a.__webglInit=void 0,a instanceof THREE.BufferGeometry){var b,c=a.attributes;for(b in c)void 0!==c[b].buffer&&S.deleteBuffer(c[b].buffer);X.info.memory.geometries--}if(a instanceof THREE.Geometry2)delete K[a.id],X.info.memory.geometries--;else if(void 0!==a.geometryGroups)for(var d in a.geometryGroups){if(b=a.geometryGroups[d],void 0!==b.numMorphTargets)for(var c=0,e=b.numMorphTargets;e>c;c++)S.deleteBuffer(b.__webglMorphTargetsBuffers[c]);if(void 0!==b.numMorphNormals)for(c=0,e=b.numMorphNormals;e>c;c++)S.deleteBuffer(b.__webglMorphNormalsBuffers[c]);Ub(b)}else Ub(a)},Rb=function(a){a=a.target,a.removeEventListener("dispose",Rb),a.image&&a.image.__webglTextureCube?S.deleteTexture(a.image.__webglTextureCube):a.__webglInit&&(a.__webglInit=!1,S.deleteTexture(a.__webglTexture)),X.info.memory.textures--},Sb=function(a){if(a=a.target,a.removeEventListener("dispose",Sb),a&&a.__webglTexture)if(S.deleteTexture(a.__webglTexture),a instanceof THREE.WebGLRenderTargetCube)for(var b=0;6>b;b++)S.deleteFramebuffer(a.__webglFramebuffer[b]),S.deleteRenderbuffer(a.__webglRenderbuffer[b]);else S.deleteFramebuffer(a.__webglFramebuffer),S.deleteRenderbuffer(a.__webglRenderbuffer);X.info.memory.textures--},Tb=function(a){a=a.target,a.removeEventListener("dispose",Tb),Vb(a)},Ub=function(a){if(void 0!==a.__webglVertexBuffer&&S.deleteBuffer(a.__webglVertexBuffer),void 0!==a.__webglNormalBuffer&&S.deleteBuffer(a.__webglNormalBuffer),void 0!==a.__webglTangentBuffer&&S.deleteBuffer(a.__webglTangentBuffer),void 0!==a.__webglColorBuffer&&S.deleteBuffer(a.__webglColorBuffer),void 0!==a.__webglUVBuffer&&S.deleteBuffer(a.__webglUVBuffer),void 0!==a.__webglUV2Buffer&&S.deleteBuffer(a.__webglUV2Buffer),void 0!==a.__webglSkinIndicesBuffer&&S.deleteBuffer(a.__webglSkinIndicesBuffer),void 0!==a.__webglSkinWeightsBuffer&&S.deleteBuffer(a.__webglSkinWeightsBuffer),void 0!==a.__webglFaceBuffer&&S.deleteBuffer(a.__webglFaceBuffer),void 0!==a.__webglLineBuffer&&S.deleteBuffer(a.__webglLineBuffer),void 0!==a.__webglLineDistanceBuffer&&S.deleteBuffer(a.__webglLineDistanceBuffer),void 0!==a.__webglCustomAttributesList)for(var b in a.__webglCustomAttributesList)S.deleteBuffer(a.__webglCustomAttributesList[b].buffer);X.info.memory.geometries--},Vb=function(a){var b=a.program;if(void 0!==b){a.program=void 0;var c,d,e=!1;for(a=0,c=Y.length;c>a;a++)if(d=Y[a],d.program===b){d.usedTimes--,0===d.usedTimes&&(e=!0);break}if(!0===e){for(e=[],a=0,c=Y.length;c>a;a++)d=Y[a],d.program!==b&&e.push(d);Y=e,S.deleteProgram(b),X.info.memory.programs--}}};this.renderBufferImmediate=function(a,b,c){if(a.hasPositions&&!a.__webglVertexBuffer&&(a.__webglVertexBuffer=S.createBuffer()),a.hasNormals&&!a.__webglNormalBuffer&&(a.__webglNormalBuffer=S.createBuffer()),a.hasUvs&&!a.__webglUvBuffer&&(a.__webglUvBuffer=S.createBuffer()),a.hasColors&&!a.__webglColorBuffer&&(a.__webglColorBuffer=S.createBuffer()),a.hasPositions&&(S.bindBuffer(S.ARRAY_BUFFER,a.__webglVertexBuffer),S.bufferData(S.ARRAY_BUFFER,a.positionArray,S.DYNAMIC_DRAW),S.enableVertexAttribArray(b.attributes.position),S.vertexAttribPointer(b.attributes.position,3,S.FLOAT,!1,0,0)),a.hasNormals){if(S.bindBuffer(S.ARRAY_BUFFER,a.__webglNormalBuffer),c.shading===THREE.FlatShading){var d,e,f,g,h,i,j,k,l,m,n,o=3*a.count;for(n=0;o>n;n+=9)m=a.normalArray,d=m[n],e=m[n+1],f=m[n+2],g=m[n+3],i=m[n+4],k=m[n+5],h=m[n+6],j=m[n+7],l=m[n+8],d=(d+g+h)/3,e=(e+i+j)/3,f=(f+k+l)/3,m[n]=d,m[n+1]=e,m[n+2]=f,m[n+3]=d,m[n+4]=e,m[n+5]=f,m[n+6]=d,m[n+7]=e,m[n+8]=f}S.bufferData(S.ARRAY_BUFFER,a.normalArray,S.DYNAMIC_DRAW),S.enableVertexAttribArray(b.attributes.normal),S.vertexAttribPointer(b.attributes.normal,3,S.FLOAT,!1,0,0)}a.hasUvs&&c.map&&(S.bindBuffer(S.ARRAY_BUFFER,a.__webglUvBuffer),S.bufferData(S.ARRAY_BUFFER,a.uvArray,S.DYNAMIC_DRAW),S.enableVertexAttribArray(b.attributes.uv),S.vertexAttribPointer(b.attributes.uv,2,S.FLOAT,!1,0,0)),a.hasColors&&c.vertexColors!==THREE.NoColors&&(S.bindBuffer(S.ARRAY_BUFFER,a.__webglColorBuffer),S.bufferData(S.ARRAY_BUFFER,a.colorArray,S.DYNAMIC_DRAW),S.enableVertexAttribArray(b.attributes.color),S.vertexAttribPointer(b.attributes.color,3,S.FLOAT,!1,0,0)),S.drawArrays(S.TRIANGLES,0,a.count),a.count=0},this.renderBufferGeometry2=function(a,b,c,d,e,f){a=v(a,b,c,d,f).attributes,b={position:"vertices",normal:"normals",uv:"uvs"},c={position:3,normal:3,uv:2},d=K[e.id],i();for(var g in a)if(f=a[g],f>=0){var j=e[b[g]];void 0!==j&&0<j.length?(S.bindBuffer(S.ARRAY_BUFFER,d[b[g]]),h(f),S.vertexAttribPointer(f,c[g],S.FLOAT,!1,0,0)):3===c[g]?S.vertexAttrib3fv(f,[0,0,0]):2===c[g]&&S.vertexAttrib2fv(f,[0,0])}S.drawArrays(S.TRIANGLES,0,e.vertices.length/3)},this.renderBufferDirect=function(a,b,c,d,e,f){if(!1!==d.visible){var j,k,l,m;if(j=v(a,b,c,d,f),a=j.attributes,b=e.attributes,c=!1,j=16777215*e.id+2*j.id+(d.wireframe?1:0),j!==bb&&(bb=j,c=!0),c&&i(),f instanceof THREE.Mesh)if(f=b.index){e=e.offsets,1<e.length&&(c=!0);for(var n=0,o=e.length;o>n;n++){var p=e[n].index;if(c){for(k in a)l=a[k],j=b[k],l>=0&&(j?(m=j.itemSize,S.bindBuffer(S.ARRAY_BUFFER,j.buffer),h(l),S.vertexAttribPointer(l,m,S.FLOAT,!1,0,p*m*4)):d.defaultAttributeValues&&(2===d.defaultAttributeValues[k].length?S.vertexAttrib2fv(l,d.defaultAttributeValues[k]):3===d.defaultAttributeValues[k].length&&S.vertexAttrib3fv(l,d.defaultAttributeValues[k])));S.bindBuffer(S.ELEMENT_ARRAY_BUFFER,f.buffer)}S.drawElements(S.TRIANGLES,e[n].count,S.UNSIGNED_SHORT,2*e[n].start),X.info.render.calls++,X.info.render.vertices+=e[n].count,X.info.render.faces+=e[n].count/3}}else{if(c)for(k in a)"index"!==k&&(l=a[k],j=b[k],l>=0&&(j?(m=j.itemSize,S.bindBuffer(S.ARRAY_BUFFER,j.buffer),h(l),S.vertexAttribPointer(l,m,S.FLOAT,!1,0,0)):d.defaultAttributeValues&&d.defaultAttributeValues[k]&&(2===d.defaultAttributeValues[k].length?S.vertexAttrib2fv(l,d.defaultAttributeValues[k]):3===d.defaultAttributeValues[k].length&&S.vertexAttrib3fv(l,d.defaultAttributeValues[k]))));d=e.attributes.position,S.drawArrays(S.TRIANGLES,0,d.array.length/3),X.info.render.calls++,X.info.render.vertices+=d.array.length/3,X.info.render.faces+=d.array.length/3/3}else if(f instanceof THREE.ParticleSystem){if(c)for(k in a)l=a[k],j=b[k],l>=0&&(j?(m=j.itemSize,S.bindBuffer(S.ARRAY_BUFFER,j.buffer),h(l),S.vertexAttribPointer(l,m,S.FLOAT,!1,0,0)):d.defaultAttributeValues&&d.defaultAttributeValues[k]&&(2===d.defaultAttributeValues[k].length?S.vertexAttrib2fv(l,d.defaultAttributeValues[k]):3===d.defaultAttributeValues[k].length&&S.vertexAttrib3fv(l,d.defaultAttributeValues[k])));d=b.position,S.drawArrays(S.POINTS,0,d.array.length/3),X.info.render.calls++,X.info.render.points+=d.array.length/3}else if(f instanceof THREE.Line)if(k=f.type===THREE.LineStrip?S.LINE_STRIP:S.LINES,z(d.linewidth),f=b.index)for(e=e.offsets,1<e.length&&(c=!0),n=0,o=e.length;o>n;n++)p=e[n].index,c&&(g(d,a,b,p),S.bindBuffer(S.ELEMENT_ARRAY_BUFFER,f.buffer)),S.drawElements(S.LINES,e[n].count,S.UNSIGNED_SHORT,2*e[n].start),X.info.render.calls++,X.info.render.vertices+=e[n].count;else c&&g(d,a,b,0),d=b.position,S.drawArrays(k,0,d.array.length/3),X.info.render.calls++,X.info.render.points+=d.array.length}},this.renderBuffer=function(a,b,c,d,e,f){if(!1!==d.visible){var g,j;if(c=v(a,b,c,d,f),a=c.attributes,b=!1,c=16777215*e.id+2*c.id+(d.wireframe?1:0),c!==bb&&(bb=c,b=!0),b&&i(),!d.morphTargets&&0<=a.position)b&&(S.bindBuffer(S.ARRAY_BUFFER,e.__webglVertexBuffer),h(a.position),S.vertexAttribPointer(a.position,3,S.FLOAT,!1,0,0));else if(f.morphTargetBase){if(c=d.program.attributes,-1!==f.morphTargetBase&&0<=c.position?(S.bindBuffer(S.ARRAY_BUFFER,e.__webglMorphTargetsBuffers[f.morphTargetBase]),h(c.position),S.vertexAttribPointer(c.position,3,S.FLOAT,!1,0,0)):0<=c.position&&(S.bindBuffer(S.ARRAY_BUFFER,e.__webglVertexBuffer),h(c.position),S.vertexAttribPointer(c.position,3,S.FLOAT,!1,0,0)),f.morphTargetForcedOrder.length){var l=0;for(j=f.morphTargetForcedOrder,g=f.morphTargetInfluences;l<d.numSupportedMorphTargets&&l<j.length;)0<=c["morphTarget"+l]&&(S.bindBuffer(S.ARRAY_BUFFER,e.__webglMorphTargetsBuffers[j[l]]),h(c["morphTarget"+l]),S.vertexAttribPointer(c["morphTarget"+l],3,S.FLOAT,!1,0,0)),0<=c["morphNormal"+l]&&d.morphNormals&&(S.bindBuffer(S.ARRAY_BUFFER,e.__webglMorphNormalsBuffers[j[l]]),h(c["morphNormal"+l]),S.vertexAttribPointer(c["morphNormal"+l],3,S.FLOAT,!1,0,0)),f.__webglMorphTargetInfluences[l]=g[j[l]],l++}else{j=[],g=f.morphTargetInfluences;var m,n=g.length;for(m=0;n>m;m++)l=g[m],l>0&&j.push([l,m]);for(j.length>d.numSupportedMorphTargets?(j.sort(k),j.length=d.numSupportedMorphTargets):j.length>d.numSupportedMorphNormals?j.sort(k):0===j.length&&j.push([0,0]),l=0;l<d.numSupportedMorphTargets;)j[l]?(m=j[l][1],0<=c["morphTarget"+l]&&(S.bindBuffer(S.ARRAY_BUFFER,e.__webglMorphTargetsBuffers[m]),h(c["morphTarget"+l]),S.vertexAttribPointer(c["morphTarget"+l],3,S.FLOAT,!1,0,0)),0<=c["morphNormal"+l]&&d.morphNormals&&(S.bindBuffer(S.ARRAY_BUFFER,e.__webglMorphNormalsBuffers[m]),h(c["morphNormal"+l]),S.vertexAttribPointer(c["morphNormal"+l],3,S.FLOAT,!1,0,0)),f.__webglMorphTargetInfluences[l]=g[m]):f.__webglMorphTargetInfluences[l]=0,l++}null!==d.program.uniforms.morphTargetInfluences&&S.uniform1fv(d.program.uniforms.morphTargetInfluences,f.__webglMorphTargetInfluences)}if(b){if(e.__webglCustomAttributesList)for(g=0,j=e.__webglCustomAttributesList.length;j>g;g++)c=e.__webglCustomAttributesList[g],0<=a[c.buffer.belongsToAttribute]&&(S.bindBuffer(S.ARRAY_BUFFER,c.buffer),h(a[c.buffer.belongsToAttribute]),S.vertexAttribPointer(a[c.buffer.belongsToAttribute],c.size,S.FLOAT,!1,0,0));
0<=a.color&&(0<f.geometry.colors.length||0<f.geometry.faces.length?(S.bindBuffer(S.ARRAY_BUFFER,e.__webglColorBuffer),h(a.color),S.vertexAttribPointer(a.color,3,S.FLOAT,!1,0,0)):d.defaultAttributeValues&&S.vertexAttrib3fv(a.color,d.defaultAttributeValues.color)),0<=a.normal&&(S.bindBuffer(S.ARRAY_BUFFER,e.__webglNormalBuffer),h(a.normal),S.vertexAttribPointer(a.normal,3,S.FLOAT,!1,0,0)),0<=a.tangent&&(S.bindBuffer(S.ARRAY_BUFFER,e.__webglTangentBuffer),h(a.tangent),S.vertexAttribPointer(a.tangent,4,S.FLOAT,!1,0,0)),0<=a.uv&&(f.geometry.faceVertexUvs[0]?(S.bindBuffer(S.ARRAY_BUFFER,e.__webglUVBuffer),h(a.uv),S.vertexAttribPointer(a.uv,2,S.FLOAT,!1,0,0)):d.defaultAttributeValues&&S.vertexAttrib2fv(a.uv,d.defaultAttributeValues.uv)),0<=a.uv2&&(f.geometry.faceVertexUvs[1]?(S.bindBuffer(S.ARRAY_BUFFER,e.__webglUV2Buffer),h(a.uv2),S.vertexAttribPointer(a.uv2,2,S.FLOAT,!1,0,0)):d.defaultAttributeValues&&S.vertexAttrib2fv(a.uv2,d.defaultAttributeValues.uv2)),d.skinning&&0<=a.skinIndex&&0<=a.skinWeight&&(S.bindBuffer(S.ARRAY_BUFFER,e.__webglSkinIndicesBuffer),h(a.skinIndex),S.vertexAttribPointer(a.skinIndex,4,S.FLOAT,!1,0,0),S.bindBuffer(S.ARRAY_BUFFER,e.__webglSkinWeightsBuffer),h(a.skinWeight),S.vertexAttribPointer(a.skinWeight,4,S.FLOAT,!1,0,0)),0<=a.lineDistance&&(S.bindBuffer(S.ARRAY_BUFFER,e.__webglLineDistanceBuffer),h(a.lineDistance),S.vertexAttribPointer(a.lineDistance,1,S.FLOAT,!1,0,0))}f instanceof THREE.Mesh?(d.wireframe?(z(d.wireframeLinewidth),b&&S.bindBuffer(S.ELEMENT_ARRAY_BUFFER,e.__webglLineBuffer),S.drawElements(S.LINES,e.__webglLineCount,S.UNSIGNED_SHORT,0)):(b&&S.bindBuffer(S.ELEMENT_ARRAY_BUFFER,e.__webglFaceBuffer),S.drawElements(S.TRIANGLES,e.__webglFaceCount,S.UNSIGNED_SHORT,0)),X.info.render.calls++,X.info.render.vertices+=e.__webglFaceCount,X.info.render.faces+=e.__webglFaceCount/3):f instanceof THREE.Line?(f=f.type===THREE.LineStrip?S.LINE_STRIP:S.LINES,z(d.linewidth),S.drawArrays(f,0,e.__webglLineCount),X.info.render.calls++):f instanceof THREE.ParticleSystem&&(S.drawArrays(S.POINTS,0,e.__webglParticleCount),X.info.render.calls++,X.info.render.points+=e.__webglParticleCount)}},this.render=function(a,b,c,d){if(0==b instanceof THREE.Camera)console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");else{var e,f,g,h,i=a.__lights,k=a.fog;for(ab=-1,Cb=!0,!0===a.autoUpdate&&a.updateMatrixWorld(),void 0===b.parent&&b.updateMatrixWorld(),b.matrixWorldInverse.getInverse(b.matrixWorld),yb.multiplyMatrices(b.projectionMatrix,b.matrixWorldInverse),xb.setFromMatrix(yb),this.autoUpdateObjects&&this.initWebGLObjects(a),l(this.renderPluginsPre,a,b),X.info.render.calls=0,X.info.render.vertices=0,X.info.render.faces=0,X.info.render.points=0,this.setRenderTarget(c),(this.autoClear||d)&&this.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil),h=a.__webglObjects,d=0,e=h.length;e>d;d++)if(f=h[d],g=f.object,f.id=d,f.render=!1,g.visible&&(!(g instanceof THREE.Mesh||g instanceof THREE.ParticleSystem)||!g.frustumCulled||xb.intersectsObject(g))){var o=g;o._modelViewMatrix.multiplyMatrices(b.matrixWorldInverse,o.matrixWorld),o._normalMatrix.getNormalMatrix(o._modelViewMatrix);var o=f,p=o.object,q=o.buffer,r=p.geometry,p=p.material;p instanceof THREE.MeshFaceMaterial?(p=p.materials[r instanceof THREE.BufferGeometry?0:q.materialIndex],p.transparent?(o.transparent=p,o.opaque=null):(o.opaque=p,o.transparent=null)):p&&(p.transparent?(o.transparent=p,o.opaque=null):(o.opaque=p,o.transparent=null)),f.render=!0,!0===this.sortObjects&&(null!==g.renderDepth?f.z=g.renderDepth:(Ab.setFromMatrixPosition(g.matrixWorld),Ab.applyProjection(yb),f.z=Ab.z))}for(this.sortObjects&&h.sort(j),h=a.__webglObjectsImmediate,d=0,e=h.length;e>d;d++)f=h[d],g=f.object,g.visible&&(g._modelViewMatrix.multiplyMatrices(b.matrixWorldInverse,g.matrixWorld),g._normalMatrix.getNormalMatrix(g._modelViewMatrix),g=f.object.material,g.transparent?(f.transparent=g,f.opaque=null):(f.opaque=g,f.transparent=null));a.overrideMaterial?(d=a.overrideMaterial,this.setBlending(d.blending,d.blendEquation,d.blendSrc,d.blendDst),this.setDepthTest(d.depthTest),this.setDepthWrite(d.depthWrite),A(d.polygonOffset,d.polygonOffsetFactor,d.polygonOffsetUnits),m(a.__webglObjects,!1,"",b,i,k,!0,d),n(a.__webglObjectsImmediate,"",b,i,k,!1,d)):(d=null,this.setBlending(THREE.NoBlending),m(a.__webglObjects,!0,"opaque",b,i,k,!1,d),n(a.__webglObjectsImmediate,"opaque",b,i,k,!1,d),m(a.__webglObjects,!1,"transparent",b,i,k,!0,d),n(a.__webglObjectsImmediate,"transparent",b,i,k,!0,d)),l(this.renderPluginsPost,a,b),c&&c.generateMipmaps&&c.minFilter!==THREE.NearestFilter&&c.minFilter!==THREE.LinearFilter&&(c instanceof THREE.WebGLRenderTargetCube?(S.bindTexture(S.TEXTURE_CUBE_MAP,c.__webglTexture),S.generateMipmap(S.TEXTURE_CUBE_MAP),S.bindTexture(S.TEXTURE_CUBE_MAP,null)):(S.bindTexture(S.TEXTURE_2D,c.__webglTexture),S.generateMipmap(S.TEXTURE_2D),S.bindTexture(S.TEXTURE_2D,null))),this.setDepthTest(!0),this.setDepthWrite(!0)}},this.renderImmediateObject=function(a,b,c,d,e){var f=v(a,b,c,d,e);bb=-1,X.setMaterialFaces(d),e.immediateRenderCallback?e.immediateRenderCallback(f,S,xb):e.render(function(a){X.renderBufferImmediate(a,f,d)})},this.initWebGLObjects=function(a){for(a.__webglObjects||(a.__webglObjects=[],a.__webglObjectsImmediate=[],a.__webglSprites=[],a.__webglFlares=[]);a.__objectsAdded.length;)o(a.__objectsAdded[0],a),a.__objectsAdded.splice(0,1);for(;a.__objectsRemoved.length;)s(a.__objectsRemoved[0],a),a.__objectsRemoved.splice(0,1);for(var b=0,g=a.__webglObjects.length;g>b;b++){var h=a.__webglObjects[b].object;void 0===h.__webglInit&&(void 0!==h.__webglActive&&s(h,a),o(h,a));var i=h,j=i.geometry,l=void 0,m=void 0,n=void 0;if(j instanceof THREE.BufferGeometry){var p=S.DYNAMIC_DRAW,t=j.attributes,u=void 0,v=void 0;for(u in t)v=t[u],v.needsUpdate&&("index"===u?(S.bindBuffer(S.ELEMENT_ARRAY_BUFFER,v.buffer),S.bufferData(S.ELEMENT_ARRAY_BUFFER,v.array,p)):(S.bindBuffer(S.ARRAY_BUFFER,v.buffer),S.bufferData(S.ARRAY_BUFFER,v.array,p)),v.needsUpdate=!1)}else if(j instanceof THREE.Geometry2){var w=j,x=S.DYNAMIC_DRAW;if(!1!==w.needsUpdate){var y=["vertices","normals","uvs"],z=K[w.id],A=void 0;for(A in y){var B=w[y[A]];S.bindBuffer(S.ARRAY_BUFFER,z[y[A]]),S.bufferData(S.ARRAY_BUFFER,B,x)}w.needsUpdate=!1}}else if(i instanceof THREE.Mesh){for(var C=0,D=j.geometryGroupsList.length;D>C;C++)if(l=j.geometryGroupsList[C],n=d(i,l),j.buffersNeedUpdate&&c(l,i),m=n.attributes&&q(n),j.verticesNeedUpdate||j.morphTargetsNeedUpdate||j.elementsNeedUpdate||j.uvsNeedUpdate||j.normalsNeedUpdate||j.colorsNeedUpdate||j.tangentsNeedUpdate||m){var E=l,F=i,G=S.DYNAMIC_DRAW,H=!j.dynamic,I=n;if(E.__inittedArrays){var J=e(I),L=I.vertexColors?I.vertexColors:!1,M=f(I),N=J===THREE.SmoothShading,O=void 0,P=void 0,Q=void 0,R=void 0,T=void 0,U=void 0,V=void 0,W=void 0,X=void 0,Y=void 0,Z=void 0,$=void 0,_=void 0,ab=void 0,bb=void 0,cb=void 0,db=void 0,eb=void 0,fb=void 0,gb=void 0,hb=void 0,ib=void 0,jb=void 0,kb=void 0,lb=void 0,mb=void 0,nb=void 0,ob=void 0,pb=void 0,qb=void 0,rb=void 0,sb=void 0,tb=void 0,ub=void 0,vb=void 0,wb=void 0,xb=void 0,Bb=void 0,Cb=void 0,Db=void 0,Eb=0,Fb=0,Gb=0,Hb=0,Ib=0,Jb=0,Kb=0,Lb=0,Mb=0,Nb=0,Ob=0,Pb=0,Qb=void 0,Rb=E.__vertexArray,Sb=E.__uvArray,Tb=E.__uv2Array,Ub=E.__normalArray,Vb=E.__tangentArray,Wb=E.__colorArray,Xb=E.__skinIndexArray,Yb=E.__skinWeightArray,Zb=E.__morphTargetsArrays,$b=E.__morphNormalsArrays,_b=E.__webglCustomAttributesList,ac=void 0,bc=E.__faceArray,cc=E.__lineArray,dc=F.geometry,ec=dc.elementsNeedUpdate,fc=dc.uvsNeedUpdate,gc=dc.normalsNeedUpdate,hc=dc.tangentsNeedUpdate,ic=dc.colorsNeedUpdate,jc=dc.morphTargetsNeedUpdate,kc=dc.vertices,lc=E.faces3,mc=dc.faces,nc=dc.faceVertexUvs[0],oc=dc.faceVertexUvs[1],pc=dc.skinIndices,qc=dc.skinWeights,rc=dc.morphTargets,sc=dc.morphNormals;if(dc.verticesNeedUpdate){for(O=0,P=lc.length;P>O;O++)R=mc[lc[O]],$=kc[R.a],_=kc[R.b],ab=kc[R.c],Rb[Fb]=$.x,Rb[Fb+1]=$.y,Rb[Fb+2]=$.z,Rb[Fb+3]=_.x,Rb[Fb+4]=_.y,Rb[Fb+5]=_.z,Rb[Fb+6]=ab.x,Rb[Fb+7]=ab.y,Rb[Fb+8]=ab.z,Fb+=9;S.bindBuffer(S.ARRAY_BUFFER,E.__webglVertexBuffer),S.bufferData(S.ARRAY_BUFFER,Rb,G)}if(jc)for(vb=0,wb=rc.length;wb>vb;vb++){for(O=Ob=0,P=lc.length;P>O;O++)Cb=lc[O],R=mc[Cb],$=rc[vb].vertices[R.a],_=rc[vb].vertices[R.b],ab=rc[vb].vertices[R.c],xb=Zb[vb],xb[Ob]=$.x,xb[Ob+1]=$.y,xb[Ob+2]=$.z,xb[Ob+3]=_.x,xb[Ob+4]=_.y,xb[Ob+5]=_.z,xb[Ob+6]=ab.x,xb[Ob+7]=ab.y,xb[Ob+8]=ab.z,I.morphNormals&&(N?(Db=sc[vb].vertexNormals[Cb],eb=Db.a,fb=Db.b,gb=Db.c):gb=fb=eb=sc[vb].faceNormals[Cb],Bb=$b[vb],Bb[Ob]=eb.x,Bb[Ob+1]=eb.y,Bb[Ob+2]=eb.z,Bb[Ob+3]=fb.x,Bb[Ob+4]=fb.y,Bb[Ob+5]=fb.z,Bb[Ob+6]=gb.x,Bb[Ob+7]=gb.y,Bb[Ob+8]=gb.z),Ob+=9;S.bindBuffer(S.ARRAY_BUFFER,E.__webglMorphTargetsBuffers[vb]),S.bufferData(S.ARRAY_BUFFER,Zb[vb],G),I.morphNormals&&(S.bindBuffer(S.ARRAY_BUFFER,E.__webglMorphNormalsBuffers[vb]),S.bufferData(S.ARRAY_BUFFER,$b[vb],G))}if(qc.length){for(O=0,P=lc.length;P>O;O++)R=mc[lc[O]],kb=qc[R.a],lb=qc[R.b],mb=qc[R.c],Yb[Nb]=kb.x,Yb[Nb+1]=kb.y,Yb[Nb+2]=kb.z,Yb[Nb+3]=kb.w,Yb[Nb+4]=lb.x,Yb[Nb+5]=lb.y,Yb[Nb+6]=lb.z,Yb[Nb+7]=lb.w,Yb[Nb+8]=mb.x,Yb[Nb+9]=mb.y,Yb[Nb+10]=mb.z,Yb[Nb+11]=mb.w,nb=pc[R.a],ob=pc[R.b],pb=pc[R.c],Xb[Nb]=nb.x,Xb[Nb+1]=nb.y,Xb[Nb+2]=nb.z,Xb[Nb+3]=nb.w,Xb[Nb+4]=ob.x,Xb[Nb+5]=ob.y,Xb[Nb+6]=ob.z,Xb[Nb+7]=ob.w,Xb[Nb+8]=pb.x,Xb[Nb+9]=pb.y,Xb[Nb+10]=pb.z,Xb[Nb+11]=pb.w,Nb+=12;Nb>0&&(S.bindBuffer(S.ARRAY_BUFFER,E.__webglSkinIndicesBuffer),S.bufferData(S.ARRAY_BUFFER,Xb,G),S.bindBuffer(S.ARRAY_BUFFER,E.__webglSkinWeightsBuffer),S.bufferData(S.ARRAY_BUFFER,Yb,G))}if(ic&&L){for(O=0,P=lc.length;P>O;O++)R=mc[lc[O]],V=R.vertexColors,W=R.color,3===V.length&&L===THREE.VertexColors?(hb=V[0],ib=V[1],jb=V[2]):jb=ib=hb=W,Wb[Mb]=hb.r,Wb[Mb+1]=hb.g,Wb[Mb+2]=hb.b,Wb[Mb+3]=ib.r,Wb[Mb+4]=ib.g,Wb[Mb+5]=ib.b,Wb[Mb+6]=jb.r,Wb[Mb+7]=jb.g,Wb[Mb+8]=jb.b,Mb+=9;Mb>0&&(S.bindBuffer(S.ARRAY_BUFFER,E.__webglColorBuffer),S.bufferData(S.ARRAY_BUFFER,Wb,G))}if(hc&&dc.hasTangents){for(O=0,P=lc.length;P>O;O++)R=mc[lc[O]],X=R.vertexTangents,bb=X[0],cb=X[1],db=X[2],Vb[Kb]=bb.x,Vb[Kb+1]=bb.y,Vb[Kb+2]=bb.z,Vb[Kb+3]=bb.w,Vb[Kb+4]=cb.x,Vb[Kb+5]=cb.y,Vb[Kb+6]=cb.z,Vb[Kb+7]=cb.w,Vb[Kb+8]=db.x,Vb[Kb+9]=db.y,Vb[Kb+10]=db.z,Vb[Kb+11]=db.w,Kb+=12;S.bindBuffer(S.ARRAY_BUFFER,E.__webglTangentBuffer),S.bufferData(S.ARRAY_BUFFER,Vb,G)}if(gc&&J){for(O=0,P=lc.length;P>O;O++)if(R=mc[lc[O]],T=R.vertexNormals,U=R.normal,3===T.length&&N)for(qb=0;3>qb;qb++)sb=T[qb],Ub[Jb]=sb.x,Ub[Jb+1]=sb.y,Ub[Jb+2]=sb.z,Jb+=3;else for(qb=0;3>qb;qb++)Ub[Jb]=U.x,Ub[Jb+1]=U.y,Ub[Jb+2]=U.z,Jb+=3;S.bindBuffer(S.ARRAY_BUFFER,E.__webglNormalBuffer),S.bufferData(S.ARRAY_BUFFER,Ub,G)}if(fc&&nc&&M){for(O=0,P=lc.length;P>O;O++)if(Q=lc[O],Y=nc[Q],void 0!==Y)for(qb=0;3>qb;qb++)tb=Y[qb],Sb[Gb]=tb.x,Sb[Gb+1]=tb.y,Gb+=2;Gb>0&&(S.bindBuffer(S.ARRAY_BUFFER,E.__webglUVBuffer),S.bufferData(S.ARRAY_BUFFER,Sb,G))}if(fc&&oc&&M){for(O=0,P=lc.length;P>O;O++)if(Q=lc[O],Z=oc[Q],void 0!==Z)for(qb=0;3>qb;qb++)ub=Z[qb],Tb[Hb]=ub.x,Tb[Hb+1]=ub.y,Hb+=2;Hb>0&&(S.bindBuffer(S.ARRAY_BUFFER,E.__webglUV2Buffer),S.bufferData(S.ARRAY_BUFFER,Tb,G))}if(ec){for(O=0,P=lc.length;P>O;O++)bc[Ib]=Eb,bc[Ib+1]=Eb+1,bc[Ib+2]=Eb+2,Ib+=3,cc[Lb]=Eb,cc[Lb+1]=Eb+1,cc[Lb+2]=Eb,cc[Lb+3]=Eb+2,cc[Lb+4]=Eb+1,cc[Lb+5]=Eb+2,Lb+=6,Eb+=3;S.bindBuffer(S.ELEMENT_ARRAY_BUFFER,E.__webglFaceBuffer),S.bufferData(S.ELEMENT_ARRAY_BUFFER,bc,G),S.bindBuffer(S.ELEMENT_ARRAY_BUFFER,E.__webglLineBuffer),S.bufferData(S.ELEMENT_ARRAY_BUFFER,cc,G)}if(_b)for(qb=0,rb=_b.length;rb>qb;qb++)if(ac=_b[qb],ac.__original.needsUpdate){if(Pb=0,1===ac.size){if(void 0===ac.boundTo||"vertices"===ac.boundTo)for(O=0,P=lc.length;P>O;O++)R=mc[lc[O]],ac.array[Pb]=ac.value[R.a],ac.array[Pb+1]=ac.value[R.b],ac.array[Pb+2]=ac.value[R.c],Pb+=3;else if("faces"===ac.boundTo)for(O=0,P=lc.length;P>O;O++)Qb=ac.value[lc[O]],ac.array[Pb]=Qb,ac.array[Pb+1]=Qb,ac.array[Pb+2]=Qb,Pb+=3}else if(2===ac.size){if(void 0===ac.boundTo||"vertices"===ac.boundTo)for(O=0,P=lc.length;P>O;O++)R=mc[lc[O]],$=ac.value[R.a],_=ac.value[R.b],ab=ac.value[R.c],ac.array[Pb]=$.x,ac.array[Pb+1]=$.y,ac.array[Pb+2]=_.x,ac.array[Pb+3]=_.y,ac.array[Pb+4]=ab.x,ac.array[Pb+5]=ab.y,Pb+=6;else if("faces"===ac.boundTo)for(O=0,P=lc.length;P>O;O++)ab=_=$=Qb=ac.value[lc[O]],ac.array[Pb]=$.x,ac.array[Pb+1]=$.y,ac.array[Pb+2]=_.x,ac.array[Pb+3]=_.y,ac.array[Pb+4]=ab.x,ac.array[Pb+5]=ab.y,Pb+=6}else if(3===ac.size){var tc;if(tc="c"===ac.type?["r","g","b"]:["x","y","z"],void 0===ac.boundTo||"vertices"===ac.boundTo)for(O=0,P=lc.length;P>O;O++)R=mc[lc[O]],$=ac.value[R.a],_=ac.value[R.b],ab=ac.value[R.c],ac.array[Pb]=$[tc[0]],ac.array[Pb+1]=$[tc[1]],ac.array[Pb+2]=$[tc[2]],ac.array[Pb+3]=_[tc[0]],ac.array[Pb+4]=_[tc[1]],ac.array[Pb+5]=_[tc[2]],ac.array[Pb+6]=ab[tc[0]],ac.array[Pb+7]=ab[tc[1]],ac.array[Pb+8]=ab[tc[2]],Pb+=9;else if("faces"===ac.boundTo)for(O=0,P=lc.length;P>O;O++)ab=_=$=Qb=ac.value[lc[O]],ac.array[Pb]=$[tc[0]],ac.array[Pb+1]=$[tc[1]],ac.array[Pb+2]=$[tc[2]],ac.array[Pb+3]=_[tc[0]],ac.array[Pb+4]=_[tc[1]],ac.array[Pb+5]=_[tc[2]],ac.array[Pb+6]=ab[tc[0]],ac.array[Pb+7]=ab[tc[1]],ac.array[Pb+8]=ab[tc[2]],Pb+=9;else if("faceVertices"===ac.boundTo)for(O=0,P=lc.length;P>O;O++)Qb=ac.value[lc[O]],$=Qb[0],_=Qb[1],ab=Qb[2],ac.array[Pb]=$[tc[0]],ac.array[Pb+1]=$[tc[1]],ac.array[Pb+2]=$[tc[2]],ac.array[Pb+3]=_[tc[0]],ac.array[Pb+4]=_[tc[1]],ac.array[Pb+5]=_[tc[2]],ac.array[Pb+6]=ab[tc[0]],ac.array[Pb+7]=ab[tc[1]],ac.array[Pb+8]=ab[tc[2]],Pb+=9}else if(4===ac.size)if(void 0===ac.boundTo||"vertices"===ac.boundTo)for(O=0,P=lc.length;P>O;O++)R=mc[lc[O]],$=ac.value[R.a],_=ac.value[R.b],ab=ac.value[R.c],ac.array[Pb]=$.x,ac.array[Pb+1]=$.y,ac.array[Pb+2]=$.z,ac.array[Pb+3]=$.w,ac.array[Pb+4]=_.x,ac.array[Pb+5]=_.y,ac.array[Pb+6]=_.z,ac.array[Pb+7]=_.w,ac.array[Pb+8]=ab.x,ac.array[Pb+9]=ab.y,ac.array[Pb+10]=ab.z,ac.array[Pb+11]=ab.w,Pb+=12;else if("faces"===ac.boundTo)for(O=0,P=lc.length;P>O;O++)ab=_=$=Qb=ac.value[lc[O]],ac.array[Pb]=$.x,ac.array[Pb+1]=$.y,ac.array[Pb+2]=$.z,ac.array[Pb+3]=$.w,ac.array[Pb+4]=_.x,ac.array[Pb+5]=_.y,ac.array[Pb+6]=_.z,ac.array[Pb+7]=_.w,ac.array[Pb+8]=ab.x,ac.array[Pb+9]=ab.y,ac.array[Pb+10]=ab.z,ac.array[Pb+11]=ab.w,Pb+=12;else if("faceVertices"===ac.boundTo)for(O=0,P=lc.length;P>O;O++)Qb=ac.value[lc[O]],$=Qb[0],_=Qb[1],ab=Qb[2],ac.array[Pb]=$.x,ac.array[Pb+1]=$.y,ac.array[Pb+2]=$.z,ac.array[Pb+3]=$.w,ac.array[Pb+4]=_.x,ac.array[Pb+5]=_.y,ac.array[Pb+6]=_.z,ac.array[Pb+7]=_.w,ac.array[Pb+8]=ab.x,ac.array[Pb+9]=ab.y,ac.array[Pb+10]=ab.z,ac.array[Pb+11]=ab.w,Pb+=12;S.bindBuffer(S.ARRAY_BUFFER,ac.buffer),S.bufferData(S.ARRAY_BUFFER,ac.array,G)}H&&(delete E.__inittedArrays,delete E.__colorArray,delete E.__normalArray,delete E.__tangentArray,delete E.__uvArray,delete E.__uv2Array,delete E.__faceArray,delete E.__vertexArray,delete E.__lineArray,delete E.__skinIndexArray,delete E.__skinWeightArray)}}j.verticesNeedUpdate=!1,j.morphTargetsNeedUpdate=!1,j.elementsNeedUpdate=!1,j.uvsNeedUpdate=!1,j.normalsNeedUpdate=!1,j.colorsNeedUpdate=!1,j.tangentsNeedUpdate=!1,j.buffersNeedUpdate=!1,n.attributes&&r(n)}else if(i instanceof THREE.Line){if(n=d(i,j),m=n.attributes&&q(n),j.verticesNeedUpdate||j.colorsNeedUpdate||j.lineDistancesNeedUpdate||m){var uc=j,vc=S.DYNAMIC_DRAW,wc=void 0,xc=void 0,yc=void 0,zc=void 0,Ac=void 0,Bc=void 0,Cc=uc.vertices,Dc=uc.colors,Ec=uc.lineDistances,Fc=Cc.length,Gc=Dc.length,Hc=Ec.length,Ic=uc.__vertexArray,Jc=uc.__colorArray,Kc=uc.__lineDistanceArray,Lc=uc.colorsNeedUpdate,Mc=uc.lineDistancesNeedUpdate,Nc=uc.__webglCustomAttributesList,Oc=void 0,Pc=void 0,Qc=void 0,Rc=void 0,Sc=void 0,Tc=void 0;if(uc.verticesNeedUpdate){for(wc=0;Fc>wc;wc++)zc=Cc[wc],Ac=3*wc,Ic[Ac]=zc.x,Ic[Ac+1]=zc.y,Ic[Ac+2]=zc.z;S.bindBuffer(S.ARRAY_BUFFER,uc.__webglVertexBuffer),S.bufferData(S.ARRAY_BUFFER,Ic,vc)}if(Lc){for(xc=0;Gc>xc;xc++)Bc=Dc[xc],Ac=3*xc,Jc[Ac]=Bc.r,Jc[Ac+1]=Bc.g,Jc[Ac+2]=Bc.b;S.bindBuffer(S.ARRAY_BUFFER,uc.__webglColorBuffer),S.bufferData(S.ARRAY_BUFFER,Jc,vc)}if(Mc){for(yc=0;Hc>yc;yc++)Kc[yc]=Ec[yc];S.bindBuffer(S.ARRAY_BUFFER,uc.__webglLineDistanceBuffer),S.bufferData(S.ARRAY_BUFFER,Kc,vc)}if(Nc)for(Oc=0,Pc=Nc.length;Pc>Oc;Oc++)if(Tc=Nc[Oc],Tc.needsUpdate&&(void 0===Tc.boundTo||"vertices"===Tc.boundTo)){if(Ac=0,Rc=Tc.value.length,1===Tc.size)for(Qc=0;Rc>Qc;Qc++)Tc.array[Qc]=Tc.value[Qc];else if(2===Tc.size)for(Qc=0;Rc>Qc;Qc++)Sc=Tc.value[Qc],Tc.array[Ac]=Sc.x,Tc.array[Ac+1]=Sc.y,Ac+=2;else if(3===Tc.size)if("c"===Tc.type)for(Qc=0;Rc>Qc;Qc++)Sc=Tc.value[Qc],Tc.array[Ac]=Sc.r,Tc.array[Ac+1]=Sc.g,Tc.array[Ac+2]=Sc.b,Ac+=3;else for(Qc=0;Rc>Qc;Qc++)Sc=Tc.value[Qc],Tc.array[Ac]=Sc.x,Tc.array[Ac+1]=Sc.y,Tc.array[Ac+2]=Sc.z,Ac+=3;else if(4===Tc.size)for(Qc=0;Rc>Qc;Qc++)Sc=Tc.value[Qc],Tc.array[Ac]=Sc.x,Tc.array[Ac+1]=Sc.y,Tc.array[Ac+2]=Sc.z,Tc.array[Ac+3]=Sc.w,Ac+=4;S.bindBuffer(S.ARRAY_BUFFER,Tc.buffer),S.bufferData(S.ARRAY_BUFFER,Tc.array,vc)}}j.verticesNeedUpdate=!1,j.colorsNeedUpdate=!1,j.lineDistancesNeedUpdate=!1,n.attributes&&r(n)}else if(i instanceof THREE.ParticleSystem){if(n=d(i,j),m=n.attributes&&q(n),j.verticesNeedUpdate||j.colorsNeedUpdate||i.sortParticles||m){var Uc=j,Vc=S.DYNAMIC_DRAW,Wc=i,Xc=void 0,Yc=void 0,Zc=void 0,$c=void 0,_c=void 0,ad=void 0,bd=Uc.vertices,cd=bd.length,dd=Uc.colors,ed=dd.length,fd=Uc.__vertexArray,gd=Uc.__colorArray,hd=Uc.__sortArray,id=Uc.verticesNeedUpdate,jd=Uc.colorsNeedUpdate,kd=Uc.__webglCustomAttributesList,ld=void 0,md=void 0,nd=void 0,od=void 0,pd=void 0,qd=void 0;if(Wc.sortParticles){for(zb.copy(yb),zb.multiply(Wc.matrixWorld),Xc=0;cd>Xc;Xc++)Zc=bd[Xc],Ab.copy(Zc),Ab.applyProjection(zb),hd[Xc]=[Ab.z,Xc];for(hd.sort(k),Xc=0;cd>Xc;Xc++)Zc=bd[hd[Xc][1]],$c=3*Xc,fd[$c]=Zc.x,fd[$c+1]=Zc.y,fd[$c+2]=Zc.z;for(Yc=0;ed>Yc;Yc++)$c=3*Yc,ad=dd[hd[Yc][1]],gd[$c]=ad.r,gd[$c+1]=ad.g,gd[$c+2]=ad.b;if(kd)for(ld=0,md=kd.length;md>ld;ld++)if(qd=kd[ld],void 0===qd.boundTo||"vertices"===qd.boundTo)if($c=0,od=qd.value.length,1===qd.size)for(nd=0;od>nd;nd++)_c=hd[nd][1],qd.array[nd]=qd.value[_c];else if(2===qd.size)for(nd=0;od>nd;nd++)_c=hd[nd][1],pd=qd.value[_c],qd.array[$c]=pd.x,qd.array[$c+1]=pd.y,$c+=2;else if(3===qd.size)if("c"===qd.type)for(nd=0;od>nd;nd++)_c=hd[nd][1],pd=qd.value[_c],qd.array[$c]=pd.r,qd.array[$c+1]=pd.g,qd.array[$c+2]=pd.b,$c+=3;else for(nd=0;od>nd;nd++)_c=hd[nd][1],pd=qd.value[_c],qd.array[$c]=pd.x,qd.array[$c+1]=pd.y,qd.array[$c+2]=pd.z,$c+=3;else if(4===qd.size)for(nd=0;od>nd;nd++)_c=hd[nd][1],pd=qd.value[_c],qd.array[$c]=pd.x,qd.array[$c+1]=pd.y,qd.array[$c+2]=pd.z,qd.array[$c+3]=pd.w,$c+=4}else{if(id)for(Xc=0;cd>Xc;Xc++)Zc=bd[Xc],$c=3*Xc,fd[$c]=Zc.x,fd[$c+1]=Zc.y,fd[$c+2]=Zc.z;if(jd)for(Yc=0;ed>Yc;Yc++)ad=dd[Yc],$c=3*Yc,gd[$c]=ad.r,gd[$c+1]=ad.g,gd[$c+2]=ad.b;if(kd)for(ld=0,md=kd.length;md>ld;ld++)if(qd=kd[ld],qd.needsUpdate&&(void 0===qd.boundTo||"vertices"===qd.boundTo))if(od=qd.value.length,$c=0,1===qd.size)for(nd=0;od>nd;nd++)qd.array[nd]=qd.value[nd];else if(2===qd.size)for(nd=0;od>nd;nd++)pd=qd.value[nd],qd.array[$c]=pd.x,qd.array[$c+1]=pd.y,$c+=2;else if(3===qd.size)if("c"===qd.type)for(nd=0;od>nd;nd++)pd=qd.value[nd],qd.array[$c]=pd.r,qd.array[$c+1]=pd.g,qd.array[$c+2]=pd.b,$c+=3;else for(nd=0;od>nd;nd++)pd=qd.value[nd],qd.array[$c]=pd.x,qd.array[$c+1]=pd.y,qd.array[$c+2]=pd.z,$c+=3;else if(4===qd.size)for(nd=0;od>nd;nd++)pd=qd.value[nd],qd.array[$c]=pd.x,qd.array[$c+1]=pd.y,qd.array[$c+2]=pd.z,qd.array[$c+3]=pd.w,$c+=4}if((id||Wc.sortParticles)&&(S.bindBuffer(S.ARRAY_BUFFER,Uc.__webglVertexBuffer),S.bufferData(S.ARRAY_BUFFER,fd,Vc)),(jd||Wc.sortParticles)&&(S.bindBuffer(S.ARRAY_BUFFER,Uc.__webglColorBuffer),S.bufferData(S.ARRAY_BUFFER,gd,Vc)),kd)for(ld=0,md=kd.length;md>ld;ld++)qd=kd[ld],(qd.needsUpdate||Wc.sortParticles)&&(S.bindBuffer(S.ARRAY_BUFFER,qd.buffer),S.bufferData(S.ARRAY_BUFFER,qd.array,Vc))}j.verticesNeedUpdate=!1,j.colorsNeedUpdate=!1,n.attributes&&r(n)}}},this.initMaterial=function(a,b,c,d){var e,f,g,h;a.addEventListener("dispose",Tb);var i,j,k,l,m;if(a instanceof THREE.MeshDepthMaterial?m="depth":a instanceof THREE.MeshNormalMaterial?m="normal":a instanceof THREE.MeshBasicMaterial?m="basic":a instanceof THREE.MeshLambertMaterial?m="lambert":a instanceof THREE.MeshPhongMaterial?m="phong":a instanceof THREE.LineBasicMaterial?m="basic":a instanceof THREE.LineDashedMaterial?m="dashed":a instanceof THREE.ParticleSystemMaterial&&(m="particle_basic"),m){var n=THREE.ShaderLib[m];a.uniforms=THREE.UniformsUtils.clone(n.uniforms),a.vertexShader=n.vertexShader,a.fragmentShader=n.fragmentShader}var o=e=0,p=0,q=n=0;for(f=b.length;f>q;q++)g=b[q],g.onlyShadow||(g instanceof THREE.DirectionalLight&&e++,g instanceof THREE.PointLight&&o++,g instanceof THREE.SpotLight&&p++,g instanceof THREE.HemisphereLight&&n++);for(f=o,g=p,h=n,p=n=0,o=b.length;o>p;p++)q=b[p],q.castShadow&&(q instanceof THREE.SpotLight&&n++,q instanceof THREE.DirectionalLight&&!q.shadowCascade&&n++);l=n,Jb&&d&&d.useVertexTexture?k=1024:(b=S.getParameter(S.MAX_VERTEX_UNIFORM_VECTORS),b=Math.floor((b-20)/4),void 0!==d&&d instanceof THREE.SkinnedMesh&&(b=Math.min(d.bones.length,b),b<d.bones.length&&console.warn("WebGLRenderer: too many bones - "+d.bones.length+", this GPU supports just "+b+" (try OpenGL instead of ANGLE)")),k=b);a:{p=a.fragmentShader,o=a.vertexShader,n=a.uniforms,b=a.attributes,q=a.defines,c={map:!!a.map,envMap:!!a.envMap,lightMap:!!a.lightMap,bumpMap:!!a.bumpMap,normalMap:!!a.normalMap,specularMap:!!a.specularMap,vertexColors:a.vertexColors,fog:c,useFog:a.fog,fogExp:c instanceof THREE.FogExp2,sizeAttenuation:a.sizeAttenuation,skinning:a.skinning,maxBones:k,useVertexTexture:Jb&&d&&d.useVertexTexture,morphTargets:a.morphTargets,morphNormals:a.morphNormals,maxMorphTargets:this.maxMorphTargets,maxMorphNormals:this.maxMorphNormals,maxDirLights:e,maxPointLights:f,maxSpotLights:g,maxHemiLights:h,maxShadows:l,shadowMapEnabled:this.shadowMapEnabled&&d.receiveShadow,shadowMapType:this.shadowMapType,shadowMapDebug:this.shadowMapDebug,shadowMapCascade:this.shadowMapCascade,alphaTest:a.alphaTest,metal:a.metal,wrapAround:a.wrapAround,doubleSided:a.side===THREE.DoubleSide,flipSided:a.side===THREE.BackSide},d=a.index0AttributeName;var r,s,t;e=[],m?e.push(m):(e.push(p),e.push(o));for(s in q)e.push(s),e.push(q[s]);for(r in c)e.push(r),e.push(c[r]);for(m=e.join(),r=0,s=Y.length;s>r;r++)if(e=Y[r],e.code===m){e.usedTimes++,j=e.program;break a}r="SHADOWMAP_TYPE_BASIC",c.shadowMapType===THREE.PCFShadowMap?r="SHADOWMAP_TYPE_PCF":c.shadowMapType===THREE.PCFSoftShadowMap&&(r="SHADOWMAP_TYPE_PCF_SOFT"),s=[];for(t in q)e=q[t],!1!==e&&(e="#define "+t+" "+e,s.push(e));e=s.join("\n"),t=S.createProgram(),s=["precision "+J+" float;","precision "+J+" int;",e,Ib?"#define VERTEX_TEXTURES":"",X.gammaInput?"#define GAMMA_INPUT":"",X.gammaOutput?"#define GAMMA_OUTPUT":"","#define MAX_DIR_LIGHTS "+c.maxDirLights,"#define MAX_POINT_LIGHTS "+c.maxPointLights,"#define MAX_SPOT_LIGHTS "+c.maxSpotLights,"#define MAX_HEMI_LIGHTS "+c.maxHemiLights,"#define MAX_SHADOWS "+c.maxShadows,"#define MAX_BONES "+c.maxBones,c.map?"#define USE_MAP":"",c.envMap?"#define USE_ENVMAP":"",c.lightMap?"#define USE_LIGHTMAP":"",c.bumpMap?"#define USE_BUMPMAP":"",c.normalMap?"#define USE_NORMALMAP":"",c.specularMap?"#define USE_SPECULARMAP":"",c.vertexColors?"#define USE_COLOR":"",c.skinning?"#define USE_SKINNING":"",c.useVertexTexture?"#define BONE_TEXTURE":"",c.morphTargets?"#define USE_MORPHTARGETS":"",c.morphNormals?"#define USE_MORPHNORMALS":"",c.wrapAround?"#define WRAP_AROUND":"",c.doubleSided?"#define DOUBLE_SIDED":"",c.flipSided?"#define FLIP_SIDED":"",c.shadowMapEnabled?"#define USE_SHADOWMAP":"",c.shadowMapEnabled?"#define "+r:"",c.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",c.shadowMapCascade?"#define SHADOWMAP_CASCADE":"",c.sizeAttenuation?"#define USE_SIZEATTENUATION":"","uniform mat4 modelMatrix;\nuniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform mat4 viewMatrix;\nuniform mat3 normalMatrix;\nuniform vec3 cameraPosition;\nattribute vec3 position;\nattribute vec3 normal;\nattribute vec2 uv;\nattribute vec2 uv2;\n#ifdef USE_COLOR\nattribute vec3 color;\n#endif\n#ifdef USE_MORPHTARGETS\nattribute vec3 morphTarget0;\nattribute vec3 morphTarget1;\nattribute vec3 morphTarget2;\nattribute vec3 morphTarget3;\n#ifdef USE_MORPHNORMALS\nattribute vec3 morphNormal0;\nattribute vec3 morphNormal1;\nattribute vec3 morphNormal2;\nattribute vec3 morphNormal3;\n#else\nattribute vec3 morphTarget4;\nattribute vec3 morphTarget5;\nattribute vec3 morphTarget6;\nattribute vec3 morphTarget7;\n#endif\n#endif\n#ifdef USE_SKINNING\nattribute vec4 skinIndex;\nattribute vec4 skinWeight;\n#endif\n"].join("\n"),r=["precision "+J+" float;","precision "+J+" int;",c.bumpMap||c.normalMap?"#extension GL_OES_standard_derivatives : enable":"",e,"#define MAX_DIR_LIGHTS "+c.maxDirLights,"#define MAX_POINT_LIGHTS "+c.maxPointLights,"#define MAX_SPOT_LIGHTS "+c.maxSpotLights,"#define MAX_HEMI_LIGHTS "+c.maxHemiLights,"#define MAX_SHADOWS "+c.maxShadows,c.alphaTest?"#define ALPHATEST "+c.alphaTest:"",X.gammaInput?"#define GAMMA_INPUT":"",X.gammaOutput?"#define GAMMA_OUTPUT":"",c.useFog&&c.fog?"#define USE_FOG":"",c.useFog&&c.fogExp?"#define FOG_EXP2":"",c.map?"#define USE_MAP":"",c.envMap?"#define USE_ENVMAP":"",c.lightMap?"#define USE_LIGHTMAP":"",c.bumpMap?"#define USE_BUMPMAP":"",c.normalMap?"#define USE_NORMALMAP":"",c.specularMap?"#define USE_SPECULARMAP":"",c.vertexColors?"#define USE_COLOR":"",c.metal?"#define METAL":"",c.wrapAround?"#define WRAP_AROUND":"",c.doubleSided?"#define DOUBLE_SIDED":"",c.flipSided?"#define FLIP_SIDED":"",c.shadowMapEnabled?"#define USE_SHADOWMAP":"",c.shadowMapEnabled?"#define "+r:"",c.shadowMapDebug?"#define SHADOWMAP_DEBUG":"",c.shadowMapCascade?"#define SHADOWMAP_CASCADE":"","uniform mat4 viewMatrix;\nuniform vec3 cameraPosition;\n"].join("\n"),s=C("vertex",s+o),r=C("fragment",r+p),S.attachShader(t,s),S.attachShader(t,r),void 0!==d?S.bindAttribLocation(t,0,d):S.bindAttribLocation(t,0,"position"),S.linkProgram(t),S.getProgramParameter(t,S.LINK_STATUS)||(console.error("Could not initialise shader\nVALIDATE_STATUS: "+S.getProgramParameter(t,S.VALIDATE_STATUS)+", gl error ["+S.getError()+"]"),console.error("Program Info Log: "+S.getProgramInfoLog(t))),S.deleteShader(r),S.deleteShader(s),t.uniforms={},t.attributes={};var u;r="viewMatrix modelViewMatrix projectionMatrix normalMatrix modelMatrix cameraPosition morphTargetInfluences".split(" "),c.useVertexTexture?(r.push("boneTexture"),r.push("boneTextureWidth"),r.push("boneTextureHeight")):r.push("boneGlobalMatrices");for(u in n)r.push(u);for(u=r,r=0,s=u.length;s>r;r++)n=u[r],t.uniforms[n]=S.getUniformLocation(t,n);for(r="position normal uv uv2 tangent color skinIndex skinWeight lineDistance".split(" "),u=0;u<c.maxMorphTargets;u++)r.push("morphTarget"+u);for(u=0;u<c.maxMorphNormals;u++)r.push("morphNormal"+u);for(j in b)r.push(j);for(j=r,u=0,b=j.length;b>u;u++)r=j[u],t.attributes[r]=S.getAttribLocation(t,r);t.id=Z++,Y.push({program:t,code:m,usedTimes:1}),X.info.memory.programs=Y.length,j=t}if(a.program=j,u=a.program.attributes,a.morphTargets)for(a.numSupportedMorphTargets=0,b="morphTarget",j=0;j<this.maxMorphTargets;j++)t=b+j,0<=u[t]&&a.numSupportedMorphTargets++;if(a.morphNormals)for(a.numSupportedMorphNormals=0,b="morphNormal",j=0;j<this.maxMorphNormals;j++)t=b+j,0<=u[t]&&a.numSupportedMorphNormals++;a.uniformsList=[];for(i in a.uniforms)a.uniformsList.push([a.uniforms[i],i])},this.setFaceCulling=function(a,b){a===THREE.CullFaceNone?S.disable(S.CULL_FACE):(S.frontFace(b===THREE.FrontFaceDirectionCW?S.CW:S.CCW),S.cullFace(a===THREE.CullFaceBack?S.BACK:a===THREE.CullFaceFront?S.FRONT:S.FRONT_AND_BACK),S.enable(S.CULL_FACE))},this.setMaterialFaces=function(a){var b=a.side===THREE.DoubleSide;a=a.side===THREE.BackSide,eb!==b&&(b?S.disable(S.CULL_FACE):S.enable(S.CULL_FACE),eb=b),fb!==a&&(S.frontFace(a?S.CW:S.CCW),fb=a)},this.setDepthTest=function(a){kb!==a&&(a?S.enable(S.DEPTH_TEST):S.disable(S.DEPTH_TEST),kb=a)},this.setDepthWrite=function(a){lb!==a&&(S.depthMask(a),lb=a)},this.setBlending=function(a,b,c,d){a!==gb&&(a===THREE.NoBlending?S.disable(S.BLEND):a===THREE.AdditiveBlending?(S.enable(S.BLEND),S.blendEquation(S.FUNC_ADD),S.blendFunc(S.SRC_ALPHA,S.ONE)):a===THREE.SubtractiveBlending?(S.enable(S.BLEND),S.blendEquation(S.FUNC_ADD),S.blendFunc(S.ZERO,S.ONE_MINUS_SRC_COLOR)):a===THREE.MultiplyBlending?(S.enable(S.BLEND),S.blendEquation(S.FUNC_ADD),S.blendFunc(S.ZERO,S.SRC_COLOR)):a===THREE.CustomBlending?S.enable(S.BLEND):(S.enable(S.BLEND),S.blendEquationSeparate(S.FUNC_ADD,S.FUNC_ADD),S.blendFuncSeparate(S.SRC_ALPHA,S.ONE_MINUS_SRC_ALPHA,S.ONE,S.ONE_MINUS_SRC_ALPHA)),gb=a),a===THREE.CustomBlending?(b!==hb&&(S.blendEquation(G(b)),hb=b),(c!==ib||d!==jb)&&(S.blendFunc(G(c),G(d)),ib=c,jb=d)):jb=ib=hb=null},this.setTexture=function(a,b){if(a.needsUpdate){a.__webglInit||(a.__webglInit=!0,a.addEventListener("dispose",Rb),a.__webglTexture=S.createTexture(),X.info.memory.textures++),S.activeTexture(S.TEXTURE0+b),S.bindTexture(S.TEXTURE_2D,a.__webglTexture),S.pixelStorei(S.UNPACK_FLIP_Y_WEBGL,a.flipY),S.pixelStorei(S.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a.premultiplyAlpha),S.pixelStorei(S.UNPACK_ALIGNMENT,a.unpackAlignment);var c=a.image,d=THREE.Math.isPowerOfTwo(c.width)&&THREE.Math.isPowerOfTwo(c.height),e=G(a.format),f=G(a.type);D(S.TEXTURE_2D,a,d);var g=a.mipmaps;if(a instanceof THREE.DataTexture)if(0<g.length&&d){for(var h=0,i=g.length;i>h;h++)c=g[h],S.texImage2D(S.TEXTURE_2D,h,e,c.width,c.height,0,e,f,c.data);a.generateMipmaps=!1}else S.texImage2D(S.TEXTURE_2D,0,e,c.width,c.height,0,e,f,c.data);else if(a instanceof THREE.CompressedTexture)for(h=0,i=g.length;i>h;h++)c=g[h],a.format!==THREE.RGBAFormat?S.compressedTexImage2D(S.TEXTURE_2D,h,e,c.width,c.height,0,c.data):S.texImage2D(S.TEXTURE_2D,h,e,c.width,c.height,0,e,f,c.data);else if(0<g.length&&d){for(h=0,i=g.length;i>h;h++)c=g[h],S.texImage2D(S.TEXTURE_2D,h,e,e,f,c);a.generateMipmaps=!1}else S.texImage2D(S.TEXTURE_2D,0,e,e,f,a.image);a.generateMipmaps&&d&&S.generateMipmap(S.TEXTURE_2D),a.needsUpdate=!1,a.onUpdate&&a.onUpdate()}else S.activeTexture(S.TEXTURE0+b),S.bindTexture(S.TEXTURE_2D,a.__webglTexture)},this.setRenderTarget=function(a){var b=a instanceof THREE.WebGLRenderTargetCube;if(a&&!a.__webglFramebuffer){void 0===a.depthBuffer&&(a.depthBuffer=!0),void 0===a.stencilBuffer&&(a.stencilBuffer=!0),a.addEventListener("dispose",Sb),a.__webglTexture=S.createTexture(),X.info.memory.textures++;var c=THREE.Math.isPowerOfTwo(a.width)&&THREE.Math.isPowerOfTwo(a.height),d=G(a.format),e=G(a.type);if(b){a.__webglFramebuffer=[],a.__webglRenderbuffer=[],S.bindTexture(S.TEXTURE_CUBE_MAP,a.__webglTexture),D(S.TEXTURE_CUBE_MAP,a,c);for(var f=0;6>f;f++){a.__webglFramebuffer[f]=S.createFramebuffer(),a.__webglRenderbuffer[f]=S.createRenderbuffer(),S.texImage2D(S.TEXTURE_CUBE_MAP_POSITIVE_X+f,0,d,a.width,a.height,0,d,e,null);var g=a,h=S.TEXTURE_CUBE_MAP_POSITIVE_X+f;S.bindFramebuffer(S.FRAMEBUFFER,a.__webglFramebuffer[f]),S.framebufferTexture2D(S.FRAMEBUFFER,S.COLOR_ATTACHMENT0,h,g.__webglTexture,0),E(a.__webglRenderbuffer[f],a)}c&&S.generateMipmap(S.TEXTURE_CUBE_MAP)}else a.__webglFramebuffer=S.createFramebuffer(),a.__webglRenderbuffer=a.shareDepthFrom?a.shareDepthFrom.__webglRenderbuffer:S.createRenderbuffer(),S.bindTexture(S.TEXTURE_2D,a.__webglTexture),D(S.TEXTURE_2D,a,c),S.texImage2D(S.TEXTURE_2D,0,d,a.width,a.height,0,d,e,null),d=S.TEXTURE_2D,S.bindFramebuffer(S.FRAMEBUFFER,a.__webglFramebuffer),S.framebufferTexture2D(S.FRAMEBUFFER,S.COLOR_ATTACHMENT0,d,a.__webglTexture,0),a.shareDepthFrom?a.depthBuffer&&!a.stencilBuffer?S.framebufferRenderbuffer(S.FRAMEBUFFER,S.DEPTH_ATTACHMENT,S.RENDERBUFFER,a.__webglRenderbuffer):a.depthBuffer&&a.stencilBuffer&&S.framebufferRenderbuffer(S.FRAMEBUFFER,S.DEPTH_STENCIL_ATTACHMENT,S.RENDERBUFFER,a.__webglRenderbuffer):E(a.__webglRenderbuffer,a),c&&S.generateMipmap(S.TEXTURE_2D);b?S.bindTexture(S.TEXTURE_CUBE_MAP,null):S.bindTexture(S.TEXTURE_2D,null),S.bindRenderbuffer(S.RENDERBUFFER,null),S.bindFramebuffer(S.FRAMEBUFFER,null)}a?(b=b?a.__webglFramebuffer[a.activeCubeFace]:a.__webglFramebuffer,c=a.width,a=a.height,e=d=0):(b=null,c=sb,a=tb,d=qb,e=rb),b!==_&&(S.bindFramebuffer(S.FRAMEBUFFER,b),S.viewport(d,e,c,a),_=b),ub=c,vb=a
},this.shadowMapPlugin=new THREE.ShadowMapPlugin,this.addPrePlugin(this.shadowMapPlugin),this.addPostPlugin(new THREE.SpritePlugin),this.addPostPlugin(new THREE.LensFlarePlugin)},THREE.WebGLRenderTarget=function(a,b,c){this.width=a,this.height=b,c=c||{},this.wrapS=void 0!==c.wrapS?c.wrapS:THREE.ClampToEdgeWrapping,this.wrapT=void 0!==c.wrapT?c.wrapT:THREE.ClampToEdgeWrapping,this.magFilter=void 0!==c.magFilter?c.magFilter:THREE.LinearFilter,this.minFilter=void 0!==c.minFilter?c.minFilter:THREE.LinearMipMapLinearFilter,this.anisotropy=void 0!==c.anisotropy?c.anisotropy:1,this.offset=new THREE.Vector2(0,0),this.repeat=new THREE.Vector2(1,1),this.format=void 0!==c.format?c.format:THREE.RGBAFormat,this.type=void 0!==c.type?c.type:THREE.UnsignedByteType,this.depthBuffer=void 0!==c.depthBuffer?c.depthBuffer:!0,this.stencilBuffer=void 0!==c.stencilBuffer?c.stencilBuffer:!0,this.generateMipmaps=!0,this.shareDepthFrom=null},THREE.WebGLRenderTarget.prototype={constructor:THREE.WebGLRenderTarget,clone:function(){var a=new THREE.WebGLRenderTarget(this.width,this.height);return a.wrapS=this.wrapS,a.wrapT=this.wrapT,a.magFilter=this.magFilter,a.minFilter=this.minFilter,a.anisotropy=this.anisotropy,a.offset.copy(this.offset),a.repeat.copy(this.repeat),a.format=this.format,a.type=this.type,a.depthBuffer=this.depthBuffer,a.stencilBuffer=this.stencilBuffer,a.generateMipmaps=this.generateMipmaps,a.shareDepthFrom=this.shareDepthFrom,a},dispose:function(){this.dispatchEvent({type:"dispose"})}},THREE.EventDispatcher.prototype.apply(THREE.WebGLRenderTarget.prototype),THREE.WebGLRenderTargetCube=function(a,b,c){THREE.WebGLRenderTarget.call(this,a,b,c),this.activeCubeFace=0},THREE.WebGLRenderTargetCube.prototype=Object.create(THREE.WebGLRenderTarget.prototype),THREE.RenderableVertex=function(){this.position=new THREE.Vector3,this.positionWorld=new THREE.Vector3,this.positionScreen=new THREE.Vector4,this.visible=!0},THREE.RenderableVertex.prototype.copy=function(a){this.positionWorld.copy(a.positionWorld),this.positionScreen.copy(a.positionScreen)},THREE.RenderableFace=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.v3=new THREE.RenderableVertex,this.centroidModel=new THREE.Vector3,this.normalModel=new THREE.Vector3,this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],this.vertexNormalsLength=0,this.material=this.color=null,this.uvs=[[]],this.z=0},THREE.RenderableObject=function(){this.id=0,this.object=null,this.z=0},THREE.RenderableSprite=function(){this.id=0,this.object=null,this.rotation=this.z=this.y=this.x=0,this.scale=new THREE.Vector2,this.material=null},THREE.RenderableLine=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.vertexColors=[new THREE.Color,new THREE.Color],this.material=null,this.z=0},THREE.GeometryUtils={merge:function(a,b,c){var d,e,f=a.vertices.length,g=b instanceof THREE.Mesh?b.geometry:b,h=a.vertices,i=g.vertices,j=a.faces,k=g.faces;a=a.faceVertexUvs[0],g=g.faceVertexUvs[0],void 0===c&&(c=0),b instanceof THREE.Mesh&&(b.matrixAutoUpdate&&b.updateMatrix(),d=b.matrix,e=(new THREE.Matrix3).getNormalMatrix(d)),b=0;for(var l=i.length;l>b;b++){var m=i[b].clone();d&&m.applyMatrix4(d),h.push(m)}for(b=0,l=k.length;l>b;b++){var n,o,m=k[b],p=m.vertexNormals,q=m.vertexColors;for(n=new THREE.Face3(m.a+f,m.b+f,m.c+f),n.normal.copy(m.normal),e&&n.normal.applyMatrix3(e).normalize(),h=0,i=p.length;i>h;h++)o=p[h].clone(),e&&o.applyMatrix3(e).normalize(),n.vertexNormals.push(o);for(n.color.copy(m.color),h=0,i=q.length;i>h;h++)o=q[h],n.vertexColors.push(o.clone());n.materialIndex=m.materialIndex+c,n.centroid.copy(m.centroid),d&&n.centroid.applyMatrix4(d),j.push(n)}for(b=0,l=g.length;l>b;b++){for(c=g[b],d=[],h=0,i=c.length;i>h;h++)d.push(new THREE.Vector2(c[h].x,c[h].y));a.push(d)}},randomPointInTriangle:function(){var a=new THREE.Vector3;return function(b,c,d){var e=new THREE.Vector3,f=THREE.Math.random16(),g=THREE.Math.random16();f+g>1&&(f=1-f,g=1-g);var h=1-f-g;return e.copy(b),e.multiplyScalar(f),a.copy(c),a.multiplyScalar(g),e.add(a),a.copy(d),a.multiplyScalar(h),e.add(a),e}}(),randomPointInFace:function(a,b){return THREE.GeometryUtils.randomPointInTriangle(b.vertices[a.a],b.vertices[a.b],b.vertices[a.c])},randomPointsInGeometry:function(a,b){function c(a){function b(c,d){if(c>d)return c;var e=c+Math.floor((d-c)/2);return m[e]>a?b(c,e-1):m[e]<a?b(e+1,d):e}return b(0,m.length-1)}var d,e,f,g,h,i=a.faces,j=a.vertices,k=i.length,l=0,m=[];for(e=0;k>e;e++)d=i[e],f=j[d.a],g=j[d.b],h=j[d.c],d._area=THREE.GeometryUtils.triangleArea(f,g,h),l+=d._area,m[e]=l;for(d=[],e=0;b>e;e++)j=THREE.Math.random16()*l,j=c(j),d[e]=THREE.GeometryUtils.randomPointInFace(i[j],a,!0);return d},triangleArea:function(){var a=new THREE.Vector3,b=new THREE.Vector3;return function(c,d,e){return a.subVectors(d,c),b.subVectors(e,c),a.cross(b),.5*a.length()}}(),center:function(a){a.computeBoundingBox();var b=a.boundingBox,c=new THREE.Vector3;return c.addVectors(b.min,b.max),c.multiplyScalar(-.5),a.applyMatrix((new THREE.Matrix4).makeTranslation(c.x,c.y,c.z)),a.computeBoundingBox(),c},triangulateQuads:function(a){var b,c,d,e,f=[],g=[];for(b=0,c=a.faceVertexUvs.length;c>b;b++)g[b]=[];for(b=0,c=a.faces.length;c>b;b++)for(f.push(a.faces[b]),d=0,e=a.faceVertexUvs.length;e>d;d++)g[d].push(a.faceVertexUvs[d][b]);a.faces=f,a.faceVertexUvs=g,a.computeCentroids(),a.computeFaceNormals(),a.computeVertexNormals(),a.hasTangents&&a.computeTangents()}},THREE.ImageUtils={crossOrigin:void 0,loadTexture:function(a,b,c,d){d=new THREE.ImageLoader,d.crossOrigin=this.crossOrigin;var e=new THREE.Texture(void 0,b);return b=d.load(a,function(){e.needsUpdate=!0,c&&c(e)}),e.image=b,e.sourceFile=a,e},loadCompressedTexture:function(a,b,c,d){var e=new THREE.CompressedTexture;e.mapping=b;var f=new XMLHttpRequest;return f.onload=function(){var a=THREE.ImageUtils.parseDDS(f.response,!0);e.format=a.format,e.mipmaps=a.mipmaps,e.image.width=a.width,e.image.height=a.height,e.generateMipmaps=!1,e.needsUpdate=!0,c&&c(e)},f.onerror=d,f.open("GET",a,!0),f.responseType="arraybuffer",f.send(null),e},loadTextureCube:function(a,b,c,d){var e=[];e.loadCount=0;var f=new THREE.Texture;f.image=e,void 0!==b&&(f.mapping=b),f.flipY=!1,b=0;for(var g=a.length;g>b;++b){var h=new Image;e[b]=h,h.onload=function(){e.loadCount+=1,6===e.loadCount&&(f.needsUpdate=!0,c&&c(f))},h.onerror=d,h.crossOrigin=this.crossOrigin,h.src=a[b]}return f},loadCompressedTextureCube:function(a,b,c,d){var e=[];e.loadCount=0;var f=new THREE.CompressedTexture;if(f.image=e,void 0!==b&&(f.mapping=b),f.flipY=!1,f.generateMipmaps=!1,b=function(a,b){return function(){var d=THREE.ImageUtils.parseDDS(a.response,!0);b.format=d.format,b.mipmaps=d.mipmaps,b.width=d.width,b.height=d.height,e.loadCount+=1,6===e.loadCount&&(f.format=d.format,f.needsUpdate=!0,c&&c(f))}},a instanceof Array)for(var g=0,h=a.length;h>g;++g){var i={};e[g]=i;var j=new XMLHttpRequest;j.onload=b(j,i),j.onerror=d,i=a[g],j.open("GET",i,!0),j.responseType="arraybuffer",j.send(null)}else j=new XMLHttpRequest,j.onload=function(){var a=THREE.ImageUtils.parseDDS(j.response,!0);if(a.isCubemap){for(var b=a.mipmaps.length/a.mipmapCount,d=0;b>d;d++){e[d]={mipmaps:[]};for(var g=0;g<a.mipmapCount;g++)e[d].mipmaps.push(a.mipmaps[d*a.mipmapCount+g]),e[d].format=a.format,e[d].width=a.width,e[d].height=a.height}f.format=a.format,f.needsUpdate=!0,c&&c(f)}},j.onerror=d,j.open("GET",a,!0),j.responseType="arraybuffer",j.send(null);return f},loadDDSTexture:function(a,b,c,d){var e=[];e.loadCount=0;var f=new THREE.CompressedTexture;f.image=e,void 0!==b&&(f.mapping=b),f.flipY=!1,f.generateMipmaps=!1;var g=new XMLHttpRequest;return g.onload=function(){var a=THREE.ImageUtils.parseDDS(g.response,!0);if(a.isCubemap)for(var b=a.mipmaps.length/a.mipmapCount,d=0;b>d;d++){e[d]={mipmaps:[]};for(var h=0;h<a.mipmapCount;h++)e[d].mipmaps.push(a.mipmaps[d*a.mipmapCount+h]),e[d].format=a.format,e[d].width=a.width,e[d].height=a.height}else f.image.width=a.width,f.image.height=a.height,f.mipmaps=a.mipmaps;f.format=a.format,f.needsUpdate=!0,c&&c(f)},g.onerror=d,g.open("GET",a,!0),g.responseType="arraybuffer",g.send(null),f},parseDDS:function(a,b){function c(a){return a.charCodeAt(0)+(a.charCodeAt(1)<<8)+(a.charCodeAt(2)<<16)+(a.charCodeAt(3)<<24)}function d(a,b,c,d){var e=c*d*4;a=new Uint8Array(a,b,e);for(var e=new Uint8Array(e),f=b=0,g=0;d>g;g++)for(var h=0;c>h;h++){var i=a[f];f++;var j=a[f];f++;var k=a[f];f++;var l=a[f];f++,e[b]=k,b++,e[b]=j,b++,e[b]=i,b++,e[b]=l,b++}return e}var e={mipmaps:[],width:0,height:0,format:null,mipmapCount:1},f=c("DXT1"),g=c("DXT3"),h=c("DXT5"),i=new Int32Array(a,0,31);if(542327876!==i[0])return console.error("ImageUtils.parseDDS(): Invalid magic number in DDS header"),e;if(4&!i[20])return console.error("ImageUtils.parseDDS(): Unsupported format, must contain a FourCC code"),e;var j=i[21],k=!1;switch(j){case f:f=8,e.format=THREE.RGB_S3TC_DXT1_Format;break;case g:f=16,e.format=THREE.RGBA_S3TC_DXT3_Format;break;case h:f=16,e.format=THREE.RGBA_S3TC_DXT5_Format;break;default:if(!(32==i[22]&&16711680&i[23]&&65280&i[24]&&255&i[25]&&4278190080&i[26]))return console.error("ImageUtils.parseDDS(): Unsupported FourCC code: ",String.fromCharCode(255&j,j>>8&255,j>>16&255,j>>24&255)),e;k=!0,f=64,e.format=THREE.RGBAFormat}e.mipmapCount=1,131072&i[2]&&!1!==b&&(e.mipmapCount=Math.max(1,i[7])),e.isCubemap=512&i[28]?!0:!1,e.width=i[4],e.height=i[3];for(var i=i[1]+4,g=e.width,h=e.height,j=e.isCubemap?6:1,l=0;j>l;l++){for(var m=0;m<e.mipmapCount;m++){if(k)var n=d(a,i,g,h),o=n.length;else o=Math.max(4,g)/4*Math.max(4,h)/4*f,n=new Uint8Array(a,i,o);e.mipmaps.push({data:n,width:g,height:h}),i+=o,g=Math.max(.5*g,1),h=Math.max(.5*h,1)}g=e.width,h=e.height}return e},getNormalMap:function(a,b){var c=function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);return[a[0]/b,a[1]/b,a[2]/b]};b|=1;var d=a.width,e=a.height,f=document.createElement("canvas");f.width=d,f.height=e;var g=f.getContext("2d");g.drawImage(a,0,0);for(var h=g.getImageData(0,0,d,e).data,i=g.createImageData(d,e),j=i.data,k=0;d>k;k++)for(var l=0;e>l;l++){var m=0>l-1?0:l-1,n=l+1>e-1?e-1:l+1,o=0>k-1?0:k-1,p=k+1>d-1?d-1:k+1,q=[],r=[0,0,h[4*(l*d+k)]/255*b];for(q.push([-1,0,h[4*(l*d+o)]/255*b]),q.push([-1,-1,h[4*(m*d+o)]/255*b]),q.push([0,-1,h[4*(m*d+k)]/255*b]),q.push([1,-1,h[4*(m*d+p)]/255*b]),q.push([1,0,h[4*(l*d+p)]/255*b]),q.push([1,1,h[4*(n*d+p)]/255*b]),q.push([0,1,h[4*(n*d+k)]/255*b]),q.push([-1,1,h[4*(n*d+o)]/255*b]),m=[],o=q.length,n=0;o>n;n++){var p=q[n],s=q[(n+1)%o],p=[p[0]-r[0],p[1]-r[1],p[2]-r[2]],s=[s[0]-r[0],s[1]-r[1],s[2]-r[2]];m.push(c([p[1]*s[2]-p[2]*s[1],p[2]*s[0]-p[0]*s[2],p[0]*s[1]-p[1]*s[0]]))}for(q=[0,0,0],n=0;n<m.length;n++)q[0]+=m[n][0],q[1]+=m[n][1],q[2]+=m[n][2];q[0]/=m.length,q[1]/=m.length,q[2]/=m.length,r=4*(l*d+k),j[r]=(q[0]+1)/2*255|0,j[r+1]=(q[1]+1)/2*255|0,j[r+2]=255*q[2]|0,j[r+3]=255}return g.putImageData(i,0,0),f},generateDataTexture:function(a,b,c){var d=a*b,e=new Uint8Array(3*d),f=Math.floor(255*c.r),g=Math.floor(255*c.g);c=Math.floor(255*c.b);for(var h=0;d>h;h++)e[3*h]=f,e[3*h+1]=g,e[3*h+2]=c;return a=new THREE.DataTexture(e,a,b,THREE.RGBFormat),a.needsUpdate=!0,a}},THREE.SceneUtils={createMultiMaterialObject:function(a,b){for(var c=new THREE.Object3D,d=0,e=b.length;e>d;d++)c.add(new THREE.Mesh(a,b[d]));return c},detach:function(a,b,c){a.applyMatrix(b.matrixWorld),b.remove(a),c.add(a)},attach:function(a,b,c){var d=new THREE.Matrix4;d.getInverse(c.matrixWorld),a.applyMatrix(d),b.remove(a),c.add(a)}},THREE.FontUtils={faces:{},face:"helvetiker",weight:"normal",style:"normal",size:150,divisions:10,getFace:function(){return this.faces[this.face][this.weight][this.style]},loadFace:function(a){var b=a.familyName.toLowerCase();return this.faces[b]=this.faces[b]||{},this.faces[b][a.cssFontWeight]=this.faces[b][a.cssFontWeight]||{},this.faces[b][a.cssFontWeight][a.cssFontStyle]=a,this.faces[b][a.cssFontWeight][a.cssFontStyle]=a},drawText:function(a){var b=this.getFace(),c=this.size/b.resolution,d=0,e=String(a).split(""),f=e.length,g=[];for(a=0;f>a;a++){var h=new THREE.Path,h=this.extractGlyphPoints(e[a],b,c,d,h),d=d+h.offset;g.push(h.path)}return{paths:g,offset:d/2}},extractGlyphPoints:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q=[],r=b.glyphs[a]||b.glyphs["?"];if(r){if(r.o)for(b=r._cachedOutline||(r._cachedOutline=r.o.split(" ")),i=b.length,a=0;i>a;)switch(h=b[a++]){case"m":h=b[a++]*c+d,j=b[a++]*c,e.moveTo(h,j);break;case"l":h=b[a++]*c+d,j=b[a++]*c,e.lineTo(h,j);break;case"q":if(h=b[a++]*c+d,j=b[a++]*c,m=b[a++]*c+d,n=b[a++]*c,e.quadraticCurveTo(m,n,h,j),f=q[q.length-1])for(k=f.x,l=f.y,f=1,g=this.divisions;g>=f;f++){var s=f/g;THREE.Shape.Utils.b2(s,k,m,h),THREE.Shape.Utils.b2(s,l,n,j)}break;case"b":if(h=b[a++]*c+d,j=b[a++]*c,m=b[a++]*c+d,n=b[a++]*-c,o=b[a++]*c+d,p=b[a++]*-c,e.bezierCurveTo(h,j,m,n,o,p),f=q[q.length-1])for(k=f.x,l=f.y,f=1,g=this.divisions;g>=f;f++)s=f/g,THREE.Shape.Utils.b3(s,k,m,o,h),THREE.Shape.Utils.b3(s,l,n,p,j)}return{offset:r.ha*c,path:e}}}},THREE.FontUtils.generateShapes=function(a,b){b=b||{};var c=void 0!==b.curveSegments?b.curveSegments:4,d=void 0!==b.font?b.font:"helvetiker",e=void 0!==b.weight?b.weight:"normal",f=void 0!==b.style?b.style:"normal";for(THREE.FontUtils.size=void 0!==b.size?b.size:100,THREE.FontUtils.divisions=c,THREE.FontUtils.face=d,THREE.FontUtils.weight=e,THREE.FontUtils.style=f,c=THREE.FontUtils.drawText(a).paths,d=[],e=0,f=c.length;f>e;e++)Array.prototype.push.apply(d,c[e].toShapes());return d},function(a){var b=function(a){for(var b=a.length,c=0,d=b-1,e=0;b>e;d=e++)c+=a[d].x*a[e].y-a[e].x*a[d].y;return.5*c};return a.Triangulate=function(a,c){var d=a.length;if(3>d)return null;var e,f,g,h=[],i=[],j=[];if(0<b(a))for(f=0;d>f;f++)i[f]=f;else for(f=0;d>f;f++)i[f]=d-1-f;var k=2*d;for(f=d-1;d>2;){if(0>=k--){console.log("Warning, unable to triangulate polygon!");break}e=f,e>=d&&(e=0),f=e+1,f>=d&&(f=0),g=f+1,g>=d&&(g=0);var l;a:{var m=l=void 0,n=void 0,o=void 0,p=void 0,q=void 0,r=void 0,s=void 0,t=void 0,m=a[i[e]].x,n=a[i[e]].y,o=a[i[f]].x,p=a[i[f]].y,q=a[i[g]].x,r=a[i[g]].y;if(1e-10>(o-m)*(r-n)-(p-n)*(q-m))l=!1;else{var u=void 0,v=void 0,w=void 0,x=void 0,y=void 0,z=void 0,A=void 0,B=void 0,C=void 0,D=void 0,C=B=A=t=s=void 0,u=q-o,v=r-p,w=m-q,x=n-r,y=o-m,z=p-n;for(l=0;d>l;l++)if(s=a[i[l]].x,t=a[i[l]].y,!(s===m&&t===n||s===o&&t===p||s===q&&t===r)&&(A=s-m,B=t-n,C=s-o,D=t-p,s-=q,t-=r,C=u*D-v*C,A=y*B-z*A,B=w*t-x*s,C>=-1e-10&&B>=-1e-10&&A>=-1e-10)){l=!1;break a}l=!0}}if(l){for(h.push([a[i[e]],a[i[f]],a[i[g]]]),j.push([i[e],i[f],i[g]]),e=f,g=f+1;d>g;e++,g++)i[e]=i[g];d--,k=2*d}}return c?j:h},a.Triangulate.area=b,a}(THREE.FontUtils),self._typeface_js={faces:THREE.FontUtils.faces,loadFace:THREE.FontUtils.loadFace},THREE.typeface_js=self._typeface_js,THREE.Curve=function(){},THREE.Curve.prototype.getPoint=function(){return console.log("Warning, getPoint() not implemented!"),null},THREE.Curve.prototype.getPointAt=function(a){return a=this.getUtoTmapping(a),this.getPoint(a)},THREE.Curve.prototype.getPoints=function(a){a||(a=5);var b,c=[];for(b=0;a>=b;b++)c.push(this.getPoint(b/a));return c},THREE.Curve.prototype.getSpacedPoints=function(a){a||(a=5);var b,c=[];for(b=0;a>=b;b++)c.push(this.getPointAt(b/a));return c},THREE.Curve.prototype.getLength=function(){var a=this.getLengths();return a[a.length-1]},THREE.Curve.prototype.getLengths=function(a){if(a||(a=this.__arcLengthDivisions?this.__arcLengthDivisions:200),this.cacheArcLengths&&this.cacheArcLengths.length==a+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var b,c,d=[],e=this.getPoint(0),f=0;for(d.push(0),c=1;a>=c;c++)b=this.getPoint(c/a),f+=b.distanceTo(e),d.push(f),e=b;return this.cacheArcLengths=d},THREE.Curve.prototype.updateArcLengths=function(){this.needsUpdate=!0,this.getLengths()},THREE.Curve.prototype.getUtoTmapping=function(a,b){var c,d=this.getLengths(),e=0,f=d.length;c=b?b:a*d[f-1];for(var g,h=0,i=f-1;i>=h;)if(e=Math.floor(h+(i-h)/2),g=d[e]-c,0>g)h=e+1;else{if(!(g>0)){i=e;break}i=e-1}return e=i,d[e]==c?e/(f-1):(h=d[e],d=(e+(c-h)/(d[e+1]-h))/(f-1))},THREE.Curve.prototype.getTangent=function(a){var b=a-1e-4;return a+=1e-4,0>b&&(b=0),a>1&&(a=1),b=this.getPoint(b),this.getPoint(a).clone().sub(b).normalize()},THREE.Curve.prototype.getTangentAt=function(a){return a=this.getUtoTmapping(a),this.getTangent(a)},THREE.Curve.Utils={tangentQuadraticBezier:function(a,b,c,d){return 2*(1-a)*(c-b)+2*a*(d-c)},tangentCubicBezier:function(a,b,c,d,e){return-3*b*(1-a)*(1-a)+3*c*(1-a)*(1-a)-6*a*c*(1-a)+6*a*d*(1-a)-3*a*a*d+3*a*a*e},tangentSpline:function(a){return 6*a*a-6*a+(3*a*a-4*a+1)+(-6*a*a+6*a)+(3*a*a-2*a)},interpolate:function(a,b,c,d,e){a=.5*(c-a),d=.5*(d-b);var f=e*e;return(2*b-2*c+a+d)*e*f+(-3*b+3*c-2*a-d)*f+a*e+b}},THREE.Curve.create=function(a,b){return a.prototype=Object.create(THREE.Curve.prototype),a.prototype.getPoint=b,a},THREE.CurvePath=function(){this.curves=[],this.bends=[],this.autoClose=!1},THREE.CurvePath.prototype=Object.create(THREE.Curve.prototype),THREE.CurvePath.prototype.add=function(a){this.curves.push(a)},THREE.CurvePath.prototype.checkConnection=function(){},THREE.CurvePath.prototype.closePath=function(){var a=this.curves[0].getPoint(0),b=this.curves[this.curves.length-1].getPoint(1);a.equals(b)||this.curves.push(new THREE.LineCurve(b,a))},THREE.CurvePath.prototype.getPoint=function(a){var b=a*this.getLength(),c=this.getCurveLengths();for(a=0;a<c.length;){if(c[a]>=b)return b=c[a]-b,a=this.curves[a],b=1-b/a.getLength(),a.getPointAt(b);a++}return null},THREE.CurvePath.prototype.getLength=function(){var a=this.getCurveLengths();return a[a.length-1]},THREE.CurvePath.prototype.getCurveLengths=function(){if(this.cacheLengths&&this.cacheLengths.length==this.curves.length)return this.cacheLengths;var a,b=[],c=0,d=this.curves.length;for(a=0;d>a;a++)c+=this.curves[a].getLength(),b.push(c);return this.cacheLengths=b},THREE.CurvePath.prototype.getBoundingBox=function(){var a,b,c,d,e,f,g=this.getPoints();a=b=Number.NEGATIVE_INFINITY,d=e=Number.POSITIVE_INFINITY;var h,i,j,k,l=g[0]instanceof THREE.Vector3;for(k=l?new THREE.Vector3:new THREE.Vector2,i=0,j=g.length;j>i;i++)h=g[i],h.x>a?a=h.x:h.x<d&&(d=h.x),h.y>b?b=h.y:h.y<e&&(e=h.y),l&&(h.z>c?c=h.z:h.z<f&&(f=h.z)),k.add(h);return g={minX:d,minY:e,maxX:a,maxY:b,centroid:k.divideScalar(j)},l&&(g.maxZ=c,g.minZ=f),g},THREE.CurvePath.prototype.createPointsGeometry=function(a){return a=this.getPoints(a,!0),this.createGeometry(a)},THREE.CurvePath.prototype.createSpacedPointsGeometry=function(a){return a=this.getSpacedPoints(a,!0),this.createGeometry(a)},THREE.CurvePath.prototype.createGeometry=function(a){for(var b=new THREE.Geometry,c=0;c<a.length;c++)b.vertices.push(new THREE.Vector3(a[c].x,a[c].y,a[c].z||0));return b},THREE.CurvePath.prototype.addWrapPath=function(a){this.bends.push(a)},THREE.CurvePath.prototype.getTransformedPoints=function(a,b){var c,d,e=this.getPoints(a);for(b||(b=this.bends),c=0,d=b.length;d>c;c++)e=this.getWrapPoints(e,b[c]);return e},THREE.CurvePath.prototype.getTransformedSpacedPoints=function(a,b){var c,d,e=this.getSpacedPoints(a);for(b||(b=this.bends),c=0,d=b.length;d>c;c++)e=this.getWrapPoints(e,b[c]);return e},THREE.CurvePath.prototype.getWrapPoints=function(a,b){var c,d,e,f,g,h,i=this.getBoundingBox();for(c=0,d=a.length;d>c;c++)e=a[c],f=e.x,g=e.y,h=f/i.maxX,h=b.getUtoTmapping(h,f),f=b.getPoint(h),h=b.getTangent(h),h.set(-h.y,h.x).multiplyScalar(g),e.x=f.x+h.x,e.y=f.y+h.y;return a},THREE.Gyroscope=function(){THREE.Object3D.call(this)},THREE.Gyroscope.prototype=Object.create(THREE.Object3D.prototype),THREE.Gyroscope.prototype.updateMatrixWorld=function(a){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||a)&&(this.parent?(this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorld.decompose(this.translationWorld,this.quaternionWorld,this.scaleWorld),this.matrix.decompose(this.translationObject,this.quaternionObject,this.scaleObject),this.matrixWorld.compose(this.translationWorld,this.quaternionObject,this.scaleWorld)):this.matrixWorld.copy(this.matrix),this.matrixWorldNeedsUpdate=!1,a=!0);for(var b=0,c=this.children.length;c>b;b++)this.children[b].updateMatrixWorld(a)},THREE.Gyroscope.prototype.translationWorld=new THREE.Vector3,THREE.Gyroscope.prototype.translationObject=new THREE.Vector3,THREE.Gyroscope.prototype.quaternionWorld=new THREE.Quaternion,THREE.Gyroscope.prototype.quaternionObject=new THREE.Quaternion,THREE.Gyroscope.prototype.scaleWorld=new THREE.Vector3,THREE.Gyroscope.prototype.scaleObject=new THREE.Vector3,THREE.Path=function(a){THREE.CurvePath.call(this),this.actions=[],a&&this.fromPoints(a)},THREE.Path.prototype=Object.create(THREE.CurvePath.prototype),THREE.PathActions={MOVE_TO:"moveTo",LINE_TO:"lineTo",QUADRATIC_CURVE_TO:"quadraticCurveTo",BEZIER_CURVE_TO:"bezierCurveTo",CSPLINE_THRU:"splineThru",ARC:"arc",ELLIPSE:"ellipse"},THREE.Path.prototype.fromPoints=function(a){this.moveTo(a[0].x,a[0].y);for(var b=1,c=a.length;c>b;b++)this.lineTo(a[b].x,a[b].y)},THREE.Path.prototype.moveTo=function(){var a=Array.prototype.slice.call(arguments);this.actions.push({action:THREE.PathActions.MOVE_TO,args:a})},THREE.Path.prototype.lineTo=function(a,b){var c=Array.prototype.slice.call(arguments),d=this.actions[this.actions.length-1].args,d=new THREE.LineCurve(new THREE.Vector2(d[d.length-2],d[d.length-1]),new THREE.Vector2(a,b));this.curves.push(d),this.actions.push({action:THREE.PathActions.LINE_TO,args:c})},THREE.Path.prototype.quadraticCurveTo=function(a,b,c,d){var e=Array.prototype.slice.call(arguments),f=this.actions[this.actions.length-1].args,f=new THREE.QuadraticBezierCurve(new THREE.Vector2(f[f.length-2],f[f.length-1]),new THREE.Vector2(a,b),new THREE.Vector2(c,d));this.curves.push(f),this.actions.push({action:THREE.PathActions.QUADRATIC_CURVE_TO,args:e})},THREE.Path.prototype.bezierCurveTo=function(a,b,c,d,e,f){var g=Array.prototype.slice.call(arguments),h=this.actions[this.actions.length-1].args,h=new THREE.CubicBezierCurve(new THREE.Vector2(h[h.length-2],h[h.length-1]),new THREE.Vector2(a,b),new THREE.Vector2(c,d),new THREE.Vector2(e,f));this.curves.push(h),this.actions.push({action:THREE.PathActions.BEZIER_CURVE_TO,args:g})},THREE.Path.prototype.splineThru=function(a){var b=Array.prototype.slice.call(arguments),c=this.actions[this.actions.length-1].args,c=[new THREE.Vector2(c[c.length-2],c[c.length-1])];Array.prototype.push.apply(c,a),c=new THREE.SplineCurve(c),this.curves.push(c),this.actions.push({action:THREE.PathActions.CSPLINE_THRU,args:b})},THREE.Path.prototype.arc=function(a,b,c,d,e,f){var g=this.actions[this.actions.length-1].args;this.absarc(a+g[g.length-2],b+g[g.length-1],c,d,e,f)},THREE.Path.prototype.absarc=function(a,b,c,d,e,f){this.absellipse(a,b,c,c,d,e,f)},THREE.Path.prototype.ellipse=function(a,b,c,d,e,f,g){var h=this.actions[this.actions.length-1].args;this.absellipse(a+h[h.length-2],b+h[h.length-1],c,d,e,f,g)},THREE.Path.prototype.absellipse=function(a,b,c,d,e,f,g){var h=Array.prototype.slice.call(arguments),i=new THREE.EllipseCurve(a,b,c,d,e,f,g);this.curves.push(i),i=i.getPoint(1),h.push(i.x),h.push(i.y),this.actions.push({action:THREE.PathActions.ELLIPSE,args:h})},THREE.Path.prototype.getSpacedPoints=function(a){a||(a=40);for(var b=[],c=0;a>c;c++)b.push(this.getPoint(c/a));return b},THREE.Path.prototype.getPoints=function(a,b){if(this.useSpacedPoints)return console.log("tata"),this.getSpacedPoints(a,b);a=a||12;var c,d,e,f,g,h,i,j,k,l,m,n,o,p=[];for(c=0,d=this.actions.length;d>c;c++)switch(e=this.actions[c],f=e.action,e=e.args,f){case THREE.PathActions.MOVE_TO:p.push(new THREE.Vector2(e[0],e[1]));break;case THREE.PathActions.LINE_TO:p.push(new THREE.Vector2(e[0],e[1]));break;case THREE.PathActions.QUADRATIC_CURVE_TO:for(g=e[2],h=e[3],k=e[0],l=e[1],0<p.length?(f=p[p.length-1],m=f.x,n=f.y):(f=this.actions[c-1].args,m=f[f.length-2],n=f[f.length-1]),e=1;a>=e;e++)o=e/a,f=THREE.Shape.Utils.b2(o,m,k,g),o=THREE.Shape.Utils.b2(o,n,l,h),p.push(new THREE.Vector2(f,o));break;case THREE.PathActions.BEZIER_CURVE_TO:for(g=e[4],h=e[5],k=e[0],l=e[1],i=e[2],j=e[3],0<p.length?(f=p[p.length-1],m=f.x,n=f.y):(f=this.actions[c-1].args,m=f[f.length-2],n=f[f.length-1]),e=1;a>=e;e++)o=e/a,f=THREE.Shape.Utils.b3(o,m,k,i,g),o=THREE.Shape.Utils.b3(o,n,l,j,h),p.push(new THREE.Vector2(f,o));break;case THREE.PathActions.CSPLINE_THRU:for(f=this.actions[c-1].args,o=[new THREE.Vector2(f[f.length-2],f[f.length-1])],f=a*e[0].length,o=o.concat(e[0]),o=new THREE.SplineCurve(o),e=1;f>=e;e++)p.push(o.getPointAt(e/f));break;case THREE.PathActions.ARC:for(g=e[0],h=e[1],l=e[2],i=e[3],f=e[4],k=!!e[5],m=f-i,n=2*a,e=1;n>=e;e++)o=e/n,k||(o=1-o),o=i+o*m,f=g+l*Math.cos(o),o=h+l*Math.sin(o),p.push(new THREE.Vector2(f,o));break;case THREE.PathActions.ELLIPSE:for(g=e[0],h=e[1],l=e[2],j=e[3],i=e[4],f=e[5],k=!!e[6],m=f-i,n=2*a,e=1;n>=e;e++)o=e/n,k||(o=1-o),o=i+o*m,f=g+l*Math.cos(o),o=h+j*Math.sin(o),p.push(new THREE.Vector2(f,o))}return c=p[p.length-1],1e-10>Math.abs(c.x-p[0].x)&&1e-10>Math.abs(c.y-p[0].y)&&p.splice(p.length-1,1),b&&p.push(p[0]),p},THREE.Path.prototype.toShapes=function(a){function b(a,b){for(var c=b.length,d=!1,e=c-1,f=0;c>f;e=f++){var g=b[e],h=b[f],i=h.x-g.x,j=h.y-g.y;if(1e-10<Math.abs(j)){if(0>j&&(g=b[f],i=-i,h=b[e],j=-j),!(a.y<g.y||a.y>h.y))if(a.y==g.y){if(a.x==g.x)return!0}else{if(e=j*(a.x-g.x)-i*(a.y-g.y),0==e)return!0;0>e||(d=!d)}}else if(a.y==g.y&&(h.x<=a.x&&a.x<=g.x||g.x<=a.x&&a.x<=h.x))return!0}return d}var c,d,e,f,g=[],h=new THREE.Path;for(c=0,d=this.actions.length;d>c;c++)e=this.actions[c],f=e.args,e=e.action,e==THREE.PathActions.MOVE_TO&&0!=h.actions.length&&(g.push(h),h=new THREE.Path),h[e].apply(h,f);if(0!=h.actions.length&&g.push(h),0==g.length)return[];var i,j,k;if(f=[],1==g.length)return j=g[0],k=new THREE.Shape,k.actions=j.actions,k.curves=j.curves,f.push(k),f;var l=!THREE.Shape.Utils.isClockWise(g[0].getPoints()),l=a?!l:l;k=[],h=[],e=[];var m,n=0;for(h[n]=void 0,e[n]=[],c=0,d=g.length;d>c;c++)j=g[c],m=j.getPoints(),i=THREE.Shape.Utils.isClockWise(m),(i=a?!i:i)?(!l&&h[n]&&n++,h[n]={s:new THREE.Shape,p:m},h[n].s.actions=j.actions,h[n].s.curves=j.curves,l&&n++,e[n]=[]):e[n].push({h:j,p:m[0]});if(1<h.length){for(c=!1,d=[],a=0,g=h.length;g>a;a++)k[a]=[];for(a=0,g=h.length;g>a;a++)for(j=e[a],i=0;i<j.length;i++){for(l=j[i],n=!0,m=0;m<h.length;m++)b(l.p,h[m].p)&&(a!=m&&d.push({froms:a,tos:m,hole:i}),n?(n=!1,k[m].push(l)):c=!0);n&&k[a].push(l)}0<d.length&&(c||(e=k))}for(c=0,d=h.length;d>c;c++)for(k=h[c].s,f.push(k),a=e[c],g=0,j=a.length;j>g;g++)k.holes.push(a[g].h);return f},THREE.Shape=function(){THREE.Path.apply(this,arguments),this.holes=[]},THREE.Shape.prototype=Object.create(THREE.Path.prototype),THREE.Shape.prototype.extrude=function(a){return new THREE.ExtrudeGeometry(this,a)},THREE.Shape.prototype.makeGeometry=function(a){return new THREE.ShapeGeometry(this,a)},THREE.Shape.prototype.getPointsHoles=function(a){var b,c=this.holes.length,d=[];for(b=0;c>b;b++)d[b]=this.holes[b].getTransformedPoints(a,this.bends);return d},THREE.Shape.prototype.getSpacedPointsHoles=function(a){var b,c=this.holes.length,d=[];for(b=0;c>b;b++)d[b]=this.holes[b].getTransformedSpacedPoints(a,this.bends);return d},THREE.Shape.prototype.extractAllPoints=function(a){return{shape:this.getTransformedPoints(a),holes:this.getPointsHoles(a)}},THREE.Shape.prototype.extractPoints=function(a){return this.useSpacedPoints?this.extractAllSpacedPoints(a):this.extractAllPoints(a)},THREE.Shape.prototype.extractAllSpacedPoints=function(a){return{shape:this.getTransformedSpacedPoints(a),holes:this.getSpacedPointsHoles(a)}},THREE.Shape.Utils={triangulateShape:function(a,b){function c(a,b,c){return a.x!=b.x?a.x<b.x?a.x<=c.x&&c.x<=b.x:b.x<=c.x&&c.x<=a.x:a.y<b.y?a.y<=c.y&&c.y<=b.y:b.y<=c.y&&c.y<=a.y}function d(a,b,d,e,f){var g=b.x-a.x,h=b.y-a.y,i=e.x-d.x,j=e.y-d.y,k=a.x-d.x,l=a.y-d.y,m=h*i-g*j,n=h*k-g*l;if(1e-10<Math.abs(m)){if(m>0){if(0>n||n>m)return[];if(i=j*k-i*l,0>i||i>m)return[]}else{if(n>0||m>n)return[];if(i=j*k-i*l,i>0||m>i)return[]}return 0==i?!f||0!=n&&n!=m?[a]:[]:i==m?!f||0!=n&&n!=m?[b]:[]:0==n?[d]:n==m?[e]:(f=i/m,[{x:a.x+f*g,y:a.y+f*h}])}return 0!=n||j*k!=i*l?[]:(h=0==g&&0==h,i=0==i&&0==j,h&&i?a.x!=d.x||a.y!=d.y?[]:[a]:h?c(d,e,a)?[a]:[]:i?c(a,b,d)?[d]:[]:(0!=g?(a.x<b.x?(g=a,i=a.x,h=b,a=b.x):(g=b,i=b.x,h=a,a=a.x),d.x<e.x?(b=d,m=d.x,j=e,d=e.x):(b=e,m=e.x,j=d,d=d.x)):(a.y<b.y?(g=a,i=a.y,h=b,a=b.y):(g=b,i=b.y,h=a,a=a.y),d.y<e.y?(b=d,m=d.y,j=e,d=e.y):(b=e,m=e.y,j=d,d=d.y)),m>=i?m>a?[]:a==m?f?[]:[b]:d>=a?[b,h]:[b,j]:i>d?[]:i==d?f?[]:[g]:d>=a?[g,h]:[g,j]))}function e(a,b,c,d){var e=b.x-a.x,f=b.y-a.y;b=c.x-a.x,c=c.y-a.y;var g=d.x-a.x;return d=d.y-a.y,a=e*c-f*b,e=e*d-f*g,1e-10<Math.abs(a)?(b=g*c-d*b,a>0?e>=0&&b>=0:e>=0||b>=0):e>0}var f,g,h,i,j,k={};h=a.concat();for(f in b)Array.prototype.push.apply(h,b[f]);for(f=0,g=h.length;g>f;f++)j=h[f].x+":"+h[f].y,void 0!==k[j]&&console.log("Duplicate point",j),k[j]=f;f=function(a,b){function c(a,b){var c=r.length-1,d=a-1;0>d&&(d=c);var f=a+1;return f>c&&(f=0),c=e(r[a],r[d],r[f],h[b]),c?(c=h.length-1,d=b-1,0>d&&(d=c),f=b+1,f>c&&(f=0),(c=e(h[b],h[d],h[f],r[a]))?!0:!1):!1}function f(a,b){var c,e;for(c=0;c<r.length;c++)if(e=c+1,e%=r.length,e=d(a,b,r[c],r[e],!0),0<e.length)return!0;return!1}function g(a,c){var e,f,g,h;for(e=0;e<s.length;e++)for(f=b[s[e]],g=0;g<f.length;g++)if(h=g+1,h%=f.length,h=d(a,c,f[g],f[h],!0),0<h.length)return!0;return!1}var h,i,j,k,l,m,n,o,p,q,r=a.concat(),s=[],t=[];for(l in b)s.push(l);for(var u=2*s.length;0<s.length;){if(u--,0>u){console.log("Infinite Loop! Holes left:"+s.length+", Probably Hole outside Shape!");break}for(j=0;j<r.length;j++){for(k=r[j],i=-1,l=0;l<s.length;l++)if(m=s[l],o=k.x+":"+k.y+":"+m,void 0===t[o]){for(h=b[m],m=0;m<h.length;m++)if(n=h[m],c(j,m)&&!f(k,n)&&!g(k,n)){i=m,s.splice(l,1),m=r.slice(0,j+1),n=r.slice(j),p=h.slice(i),q=h.slice(0,i+1),r=m.concat(p).concat(q).concat(n);break}if(i>=0)break;t[o]=!0}if(i>=0)break}}return r}(a,b);var l=THREE.FontUtils.Triangulate(f,!1);for(f=0,g=l.length;g>f;f++)for(i=l[f],h=0;3>h;h++)j=i[h].x+":"+i[h].y,j=k[j],void 0!==j&&(i[h]=j);return l.concat()},isClockWise:function(a){return 0>THREE.FontUtils.Triangulate.area(a)},b2p0:function(a,b){var c=1-a;return c*c*b},b2p1:function(a,b){return 2*(1-a)*a*b},b2p2:function(a,b){return a*a*b},b2:function(a,b,c,d){return this.b2p0(a,b)+this.b2p1(a,c)+this.b2p2(a,d)},b3p0:function(a,b){var c=1-a;return c*c*c*b},b3p1:function(a,b){var c=1-a;return 3*c*c*a*b},b3p2:function(a,b){return 3*(1-a)*a*a*b},b3p3:function(a,b){return a*a*a*b},b3:function(a,b,c,d,e){return this.b3p0(a,b)+this.b3p1(a,c)+this.b3p2(a,d)+this.b3p3(a,e)}},THREE.LineCurve=function(a,b){this.v1=a,this.v2=b},THREE.LineCurve.prototype=Object.create(THREE.Curve.prototype),THREE.LineCurve.prototype.getPoint=function(a){var b=this.v2.clone().sub(this.v1);return b.multiplyScalar(a).add(this.v1),b},THREE.LineCurve.prototype.getPointAt=function(a){return this.getPoint(a)},THREE.LineCurve.prototype.getTangent=function(){return this.v2.clone().sub(this.v1).normalize()},THREE.QuadraticBezierCurve=function(a,b,c){this.v0=a,this.v1=b,this.v2=c},THREE.QuadraticBezierCurve.prototype=Object.create(THREE.Curve.prototype),THREE.QuadraticBezierCurve.prototype.getPoint=function(a){var b;return b=THREE.Shape.Utils.b2(a,this.v0.x,this.v1.x,this.v2.x),a=THREE.Shape.Utils.b2(a,this.v0.y,this.v1.y,this.v2.y),new THREE.Vector2(b,a)},THREE.QuadraticBezierCurve.prototype.getTangent=function(a){var b;return b=THREE.Curve.Utils.tangentQuadraticBezier(a,this.v0.x,this.v1.x,this.v2.x),a=THREE.Curve.Utils.tangentQuadraticBezier(a,this.v0.y,this.v1.y,this.v2.y),b=new THREE.Vector2(b,a),b.normalize(),b},THREE.CubicBezierCurve=function(a,b,c,d){this.v0=a,this.v1=b,this.v2=c,this.v3=d},THREE.CubicBezierCurve.prototype=Object.create(THREE.Curve.prototype),THREE.CubicBezierCurve.prototype.getPoint=function(a){var b;return b=THREE.Shape.Utils.b3(a,this.v0.x,this.v1.x,this.v2.x,this.v3.x),a=THREE.Shape.Utils.b3(a,this.v0.y,this.v1.y,this.v2.y,this.v3.y),new THREE.Vector2(b,a)},THREE.CubicBezierCurve.prototype.getTangent=function(a){var b;
return b=THREE.Curve.Utils.tangentCubicBezier(a,this.v0.x,this.v1.x,this.v2.x,this.v3.x),a=THREE.Curve.Utils.tangentCubicBezier(a,this.v0.y,this.v1.y,this.v2.y,this.v3.y),b=new THREE.Vector2(b,a),b.normalize(),b},THREE.SplineCurve=function(a){this.points=void 0==a?[]:a},THREE.SplineCurve.prototype=Object.create(THREE.Curve.prototype),THREE.SplineCurve.prototype.getPoint=function(a){var b,c=new THREE.Vector2,d=[],e=this.points;return b=(e.length-1)*a,a=Math.floor(b),b-=a,d[0]=0==a?a:a-1,d[1]=a,d[2]=a>e.length-2?e.length-1:a+1,d[3]=a>e.length-3?e.length-1:a+2,c.x=THREE.Curve.Utils.interpolate(e[d[0]].x,e[d[1]].x,e[d[2]].x,e[d[3]].x,b),c.y=THREE.Curve.Utils.interpolate(e[d[0]].y,e[d[1]].y,e[d[2]].y,e[d[3]].y,b),c},THREE.EllipseCurve=function(a,b,c,d,e,f,g){this.aX=a,this.aY=b,this.xRadius=c,this.yRadius=d,this.aStartAngle=e,this.aEndAngle=f,this.aClockwise=g},THREE.EllipseCurve.prototype=Object.create(THREE.Curve.prototype),THREE.EllipseCurve.prototype.getPoint=function(a){var b;return b=this.aEndAngle-this.aStartAngle,0>b&&(b+=2*Math.PI),b>2*Math.PI&&(b-=2*Math.PI),b=!0===this.aClockwise?this.aEndAngle+(1-a)*(2*Math.PI-b):this.aStartAngle+a*b,a=this.aX+this.xRadius*Math.cos(b),b=this.aY+this.yRadius*Math.sin(b),new THREE.Vector2(a,b)},THREE.ArcCurve=function(a,b,c,d,e,f){THREE.EllipseCurve.call(this,a,b,c,c,d,e,f)},THREE.ArcCurve.prototype=Object.create(THREE.EllipseCurve.prototype),THREE.LineCurve3=THREE.Curve.create(function(a,b){this.v1=a,this.v2=b},function(a){var b=new THREE.Vector3;return b.subVectors(this.v2,this.v1),b.multiplyScalar(a),b.add(this.v1),b}),THREE.QuadraticBezierCurve3=THREE.Curve.create(function(a,b,c){this.v0=a,this.v1=b,this.v2=c},function(a){var b,c;return b=THREE.Shape.Utils.b2(a,this.v0.x,this.v1.x,this.v2.x),c=THREE.Shape.Utils.b2(a,this.v0.y,this.v1.y,this.v2.y),a=THREE.Shape.Utils.b2(a,this.v0.z,this.v1.z,this.v2.z),new THREE.Vector3(b,c,a)}),THREE.CubicBezierCurve3=THREE.Curve.create(function(a,b,c,d){this.v0=a,this.v1=b,this.v2=c,this.v3=d},function(a){var b,c;return b=THREE.Shape.Utils.b3(a,this.v0.x,this.v1.x,this.v2.x,this.v3.x),c=THREE.Shape.Utils.b3(a,this.v0.y,this.v1.y,this.v2.y,this.v3.y),a=THREE.Shape.Utils.b3(a,this.v0.z,this.v1.z,this.v2.z,this.v3.z),new THREE.Vector3(b,c,a)}),THREE.SplineCurve3=THREE.Curve.create(function(a){this.points=void 0==a?[]:a},function(a){var b,c=new THREE.Vector3,d=[],e=this.points;a*=e.length-1,b=Math.floor(a),a-=b,d[0]=0==b?b:b-1,d[1]=b,d[2]=b>e.length-2?e.length-1:b+1,d[3]=b>e.length-3?e.length-1:b+2,b=e[d[0]];var f=e[d[1]],g=e[d[2]],d=e[d[3]];return c.x=THREE.Curve.Utils.interpolate(b.x,f.x,g.x,d.x,a),c.y=THREE.Curve.Utils.interpolate(b.y,f.y,g.y,d.y,a),c.z=THREE.Curve.Utils.interpolate(b.z,f.z,g.z,d.z,a),c}),THREE.ClosedSplineCurve3=THREE.Curve.create(function(a){this.points=void 0==a?[]:a},function(a){var b,c=new THREE.Vector3,d=[],e=this.points;return b=(e.length-0)*a,a=Math.floor(b),b-=a,a+=a>0?0:(Math.floor(Math.abs(a)/e.length)+1)*e.length,d[0]=(a-1)%e.length,d[1]=a%e.length,d[2]=(a+1)%e.length,d[3]=(a+2)%e.length,c.x=THREE.Curve.Utils.interpolate(e[d[0]].x,e[d[1]].x,e[d[2]].x,e[d[3]].x,b),c.y=THREE.Curve.Utils.interpolate(e[d[0]].y,e[d[1]].y,e[d[2]].y,e[d[3]].y,b),c.z=THREE.Curve.Utils.interpolate(e[d[0]].z,e[d[1]].z,e[d[2]].z,e[d[3]].z,b),c}),THREE.AnimationHandler=function(){var a=[],b={},c={update:function(b){for(var c=0;c<a.length;c++)a[c].update(b)},addToUpdate:function(b){-1===a.indexOf(b)&&a.push(b)},removeFromUpdate:function(b){b=a.indexOf(b),-1!==b&&a.splice(b,1)},add:function(a){if(void 0!==b[a.name]&&console.log("THREE.AnimationHandler.add: Warning! "+a.name+" already exists in library. Overwriting."),b[a.name]=a,!0!==a.initialized){for(var c=0;c<a.hierarchy.length;c++){for(var d=0;d<a.hierarchy[c].keys.length;d++)if(0>a.hierarchy[c].keys[d].time&&(a.hierarchy[c].keys[d].time=0),void 0!==a.hierarchy[c].keys[d].rot&&!(a.hierarchy[c].keys[d].rot instanceof THREE.Quaternion)){var e=a.hierarchy[c].keys[d].rot;a.hierarchy[c].keys[d].rot=new THREE.Quaternion(e[0],e[1],e[2],e[3])}if(a.hierarchy[c].keys.length&&void 0!==a.hierarchy[c].keys[0].morphTargets){for(e={},d=0;d<a.hierarchy[c].keys.length;d++)for(var f=0;f<a.hierarchy[c].keys[d].morphTargets.length;f++){var g=a.hierarchy[c].keys[d].morphTargets[f];e[g]=-1}for(a.hierarchy[c].usedMorphTargets=e,d=0;d<a.hierarchy[c].keys.length;d++){var h={};for(g in e){for(f=0;f<a.hierarchy[c].keys[d].morphTargets.length;f++)if(a.hierarchy[c].keys[d].morphTargets[f]===g){h[g]=a.hierarchy[c].keys[d].morphTargetsInfluences[f];break}f===a.hierarchy[c].keys[d].morphTargets.length&&(h[g]=0)}a.hierarchy[c].keys[d].morphTargetsInfluences=h}}for(d=1;d<a.hierarchy[c].keys.length;d++)a.hierarchy[c].keys[d].time===a.hierarchy[c].keys[d-1].time&&(a.hierarchy[c].keys.splice(d,1),d--);for(d=0;d<a.hierarchy[c].keys.length;d++)a.hierarchy[c].keys[d].index=d}a.initialized=!0}},get:function(a){return"string"==typeof a?b[a]?b[a]:(console.log("THREE.AnimationHandler.get: Couldn't find animation "+a),null):void 0},parse:function(a){var b=[];if(a instanceof THREE.SkinnedMesh)for(var c=0;c<a.bones.length;c++)b.push(a.bones[c]);else d(a,b);return b}},d=function(a,b){b.push(a);for(var c=0;c<a.children.length;c++)d(a.children[c],b)};return c.LINEAR=0,c.CATMULLROM=1,c.CATMULLROM_FORWARD=2,c}(),THREE.Animation=function(a,b){this.root=a,this.data=THREE.AnimationHandler.get(b),this.hierarchy=THREE.AnimationHandler.parse(a),this.currentTime=0,this.timeScale=1,this.isPlaying=!1,this.loop=this.isPaused=!0,this.interpolationType=THREE.AnimationHandler.LINEAR,this.points=[],this.target=new THREE.Vector3},THREE.Animation.prototype.play=function(a){this.currentTime=void 0!==a?a:0,!1===this.isPlaying&&(this.isPlaying=!0,this.reset(),this.update(0)),this.isPaused=!1,THREE.AnimationHandler.addToUpdate(this)},THREE.Animation.prototype.pause=function(){!0===this.isPaused?THREE.AnimationHandler.addToUpdate(this):THREE.AnimationHandler.removeFromUpdate(this),this.isPaused=!this.isPaused},THREE.Animation.prototype.stop=function(){this.isPaused=this.isPlaying=!1,THREE.AnimationHandler.removeFromUpdate(this)},THREE.Animation.prototype.reset=function(){for(var a=0,b=this.hierarchy.length;b>a;a++){var c=this.hierarchy[a];c.matrixAutoUpdate=!0,void 0===c.animationCache&&(c.animationCache={},c.animationCache.prevKey={pos:0,rot:0,scl:0},c.animationCache.nextKey={pos:0,rot:0,scl:0},c.animationCache.originalMatrix=c instanceof THREE.Bone?c.skinMatrix:c.matrix);var d=c.animationCache.prevKey,c=c.animationCache.nextKey;d.pos=this.data.hierarchy[a].keys[0],d.rot=this.data.hierarchy[a].keys[0],d.scl=this.data.hierarchy[a].keys[0],c.pos=this.getNextKeyWith("pos",a,1),c.rot=this.getNextKeyWith("rot",a,1),c.scl=this.getNextKeyWith("scl",a,1)}},THREE.Animation.prototype.update=function(a){if(!1!==this.isPlaying){this.currentTime+=a*this.timeScale;var b;a=["pos","rot","scl"];var c=this.data.length;!0===this.loop&&this.currentTime>c&&(this.currentTime%=c,this.reset()),this.currentTime=Math.min(this.currentTime,c);for(var d=0,e=this.hierarchy.length;e>d;d++)for(var f=this.hierarchy[d],g=f.animationCache,h=0;3>h;h++){b=a[h];var i=g.prevKey[b],j=g.nextKey[b];if(j.time<=this.currentTime){for(i=this.data.hierarchy[d].keys[0],j=this.getNextKeyWith(b,d,1);j.time<this.currentTime&&j.index>i.index;)i=j,j=this.getNextKeyWith(b,d,j.index+1);g.prevKey[b]=i,g.nextKey[b]=j}f.matrixAutoUpdate=!0,f.matrixWorldNeedsUpdate=!0;var k=(this.currentTime-i.time)/(j.time-i.time),l=i[b],m=j[b];0>k&&(k=0),k>1&&(k=1),"pos"===b?(b=f.position,this.interpolationType===THREE.AnimationHandler.LINEAR?(b.x=l[0]+(m[0]-l[0])*k,b.y=l[1]+(m[1]-l[1])*k,b.z=l[2]+(m[2]-l[2])*k):(this.interpolationType===THREE.AnimationHandler.CATMULLROM||this.interpolationType===THREE.AnimationHandler.CATMULLROM_FORWARD)&&(this.points[0]=this.getPrevKeyWith("pos",d,i.index-1).pos,this.points[1]=l,this.points[2]=m,this.points[3]=this.getNextKeyWith("pos",d,j.index+1).pos,k=.33*k+.33,i=this.interpolateCatmullRom(this.points,k),b.x=i[0],b.y=i[1],b.z=i[2],this.interpolationType===THREE.AnimationHandler.CATMULLROM_FORWARD&&(k=this.interpolateCatmullRom(this.points,1.01*k),this.target.set(k[0],k[1],k[2]),this.target.sub(b),this.target.y=0,this.target.normalize(),b=Math.atan2(this.target.x,this.target.z),f.rotation.set(0,b,0)))):"rot"===b?THREE.Quaternion.slerp(l,m,f.quaternion,k):"scl"===b&&(b=f.scale,b.x=l[0]+(m[0]-l[0])*k,b.y=l[1]+(m[1]-l[1])*k,b.z=l[2]+(m[2]-l[2])*k)}!1===this.loop&&this.currentTime>c&&this.stop()}},THREE.Animation.prototype.interpolateCatmullRom=function(a,b){var c,d,e,f,g,h,i=[],j=[];return c=(a.length-1)*b,d=Math.floor(c),c-=d,i[0]=0===d?d:d-1,i[1]=d,i[2]=d>a.length-2?d:d+1,i[3]=d>a.length-3?d:d+2,d=a[i[0]],f=a[i[1]],g=a[i[2]],h=a[i[3]],i=c*c,e=c*i,j[0]=this.interpolate(d[0],f[0],g[0],h[0],c,i,e),j[1]=this.interpolate(d[1],f[1],g[1],h[1],c,i,e),j[2]=this.interpolate(d[2],f[2],g[2],h[2],c,i,e),j},THREE.Animation.prototype.interpolate=function(a,b,c,d,e,f,g){return a=.5*(c-a),d=.5*(d-b),(2*(b-c)+a+d)*g+(-3*(b-c)-2*a-d)*f+a*e+b},THREE.Animation.prototype.getNextKeyWith=function(a,b,c){var d=this.data.hierarchy[b].keys;for(c=this.interpolationType===THREE.AnimationHandler.CATMULLROM||this.interpolationType===THREE.AnimationHandler.CATMULLROM_FORWARD?c<d.length-1?c:d.length-1:c%d.length;c<d.length;c++)if(void 0!==d[c][a])return d[c];return this.data.hierarchy[b].keys[0]},THREE.Animation.prototype.getPrevKeyWith=function(a,b,c){var d=this.data.hierarchy[b].keys;for(c=this.interpolationType===THREE.AnimationHandler.CATMULLROM||this.interpolationType===THREE.AnimationHandler.CATMULLROM_FORWARD?c>0?c:0:c>=0?c:c+d.length;c>=0;c--)if(void 0!==d[c][a])return d[c];return this.data.hierarchy[b].keys[d.length-1]},THREE.KeyFrameAnimation=function(a,b){this.root=a,this.data=THREE.AnimationHandler.get(b),this.hierarchy=THREE.AnimationHandler.parse(a),this.currentTime=0,this.timeScale=.001,this.isPlaying=!1,this.loop=this.isPaused=!0;for(var c=0,d=this.hierarchy.length;d>c;c++){var e=this.data.hierarchy[c].sids,f=this.hierarchy[c];if(this.data.hierarchy[c].keys.length&&e){for(var g=0;g<e.length;g++){var h=e[g],i=this.getNextKeyWith(h,c,0);i&&i.apply(h)}f.matrixAutoUpdate=!1,this.data.hierarchy[c].node.updateMatrix(),f.matrixWorldNeedsUpdate=!0}}},THREE.KeyFrameAnimation.prototype.play=function(a){if(this.currentTime=void 0!==a?a:0,!1===this.isPlaying){this.isPlaying=!0;var b,c,d=this.hierarchy.length;for(a=0;d>a;a++)b=this.hierarchy[a],c=this.data.hierarchy[a],void 0===c.animationCache&&(c.animationCache={},c.animationCache.prevKey=null,c.animationCache.nextKey=null,c.animationCache.originalMatrix=b instanceof THREE.Bone?b.skinMatrix:b.matrix),b=this.data.hierarchy[a].keys,b.length&&(c.animationCache.prevKey=b[0],c.animationCache.nextKey=b[1],this.startTime=Math.min(b[0].time,this.startTime),this.endTime=Math.max(b[b.length-1].time,this.endTime));this.update(0)}this.isPaused=!1,THREE.AnimationHandler.addToUpdate(this)},THREE.KeyFrameAnimation.prototype.pause=function(){this.isPaused?THREE.AnimationHandler.addToUpdate(this):THREE.AnimationHandler.removeFromUpdate(this),this.isPaused=!this.isPaused},THREE.KeyFrameAnimation.prototype.stop=function(){this.isPaused=this.isPlaying=!1,THREE.AnimationHandler.removeFromUpdate(this);for(var a=0;a<this.data.hierarchy.length;a++){var b=this.hierarchy[a],c=this.data.hierarchy[a];if(void 0!==c.animationCache){var d=c.animationCache.originalMatrix;b instanceof THREE.Bone?(d.copy(b.skinMatrix),b.skinMatrix=d):(d.copy(b.matrix),b.matrix=d),delete c.animationCache}}},THREE.KeyFrameAnimation.prototype.update=function(a){if(!1!==this.isPlaying){this.currentTime+=a*this.timeScale,a=this.data.length,!0===this.loop&&this.currentTime>a&&(this.currentTime%=a),this.currentTime=Math.min(this.currentTime,a),a=0;for(var b=this.hierarchy.length;b>a;a++){var c=this.hierarchy[a],d=this.data.hierarchy[a],e=d.keys,d=d.animationCache;if(e.length){var f=d.prevKey,g=d.nextKey;if(g.time<=this.currentTime){for(;g.time<this.currentTime&&g.index>f.index;)f=g,g=e[f.index+1];d.prevKey=f,d.nextKey=g}g.time>=this.currentTime?f.interpolate(g,this.currentTime):f.interpolate(g,g.time),this.data.hierarchy[a].node.updateMatrix(),c.matrixWorldNeedsUpdate=!0}}}},THREE.KeyFrameAnimation.prototype.getNextKeyWith=function(a,b,c){for(b=this.data.hierarchy[b].keys,c%=b.length;c<b.length;c++)if(b[c].hasTarget(a))return b[c];return b[0]},THREE.KeyFrameAnimation.prototype.getPrevKeyWith=function(a,b,c){for(b=this.data.hierarchy[b].keys,c=c>=0?c:c+b.length;c>=0;c--)if(b[c].hasTarget(a))return b[c];return b[b.length-1]},THREE.MorphAnimation=function(a){this.mesh=a,this.frames=a.morphTargetInfluences.length,this.currentTime=0,this.duration=1e3,this.loop=!0,this.isPlaying=!1},THREE.MorphAnimation.prototype={play:function(){this.isPlaying=!0},pause:function(){this.isPlaying=!1},update:function(){var a=0,b=0;return function(c){if(!1!==this.isPlaying){this.currentTime+=c,!0===this.loop&&this.currentTime>this.duration&&(this.currentTime%=this.duration),this.currentTime=Math.min(this.currentTime,this.duration),c=this.duration/this.frames;var d=Math.floor(this.currentTime/c);d!=b&&(this.mesh.morphTargetInfluences[a]=0,this.mesh.morphTargetInfluences[b]=1,this.mesh.morphTargetInfluences[d]=0,a=b,b=d),this.mesh.morphTargetInfluences[d]=this.currentTime%c/c,this.mesh.morphTargetInfluences[a]=1-this.mesh.morphTargetInfluences[d]}}}()},THREE.CubeCamera=function(a,b,c){THREE.Object3D.call(this);var d=new THREE.PerspectiveCamera(90,1,a,b);d.up.set(0,-1,0),d.lookAt(new THREE.Vector3(1,0,0)),this.add(d);var e=new THREE.PerspectiveCamera(90,1,a,b);e.up.set(0,-1,0),e.lookAt(new THREE.Vector3(-1,0,0)),this.add(e);var f=new THREE.PerspectiveCamera(90,1,a,b);f.up.set(0,0,1),f.lookAt(new THREE.Vector3(0,1,0)),this.add(f);var g=new THREE.PerspectiveCamera(90,1,a,b);g.up.set(0,0,-1),g.lookAt(new THREE.Vector3(0,-1,0)),this.add(g);var h=new THREE.PerspectiveCamera(90,1,a,b);h.up.set(0,-1,0),h.lookAt(new THREE.Vector3(0,0,1)),this.add(h);var i=new THREE.PerspectiveCamera(90,1,a,b);i.up.set(0,-1,0),i.lookAt(new THREE.Vector3(0,0,-1)),this.add(i),this.renderTarget=new THREE.WebGLRenderTargetCube(c,c,{format:THREE.RGBFormat,magFilter:THREE.LinearFilter,minFilter:THREE.LinearFilter}),this.updateCubeMap=function(a,b){var c=this.renderTarget,j=c.generateMipmaps;c.generateMipmaps=!1,c.activeCubeFace=0,a.render(b,d,c),c.activeCubeFace=1,a.render(b,e,c),c.activeCubeFace=2,a.render(b,f,c),c.activeCubeFace=3,a.render(b,g,c),c.activeCubeFace=4,a.render(b,h,c),c.generateMipmaps=j,c.activeCubeFace=5,a.render(b,i,c)}},THREE.CubeCamera.prototype=Object.create(THREE.Object3D.prototype),THREE.CombinedCamera=function(a,b,c,d,e,f,g){THREE.Camera.call(this),this.fov=c,this.left=-a/2,this.right=a/2,this.top=b/2,this.bottom=-b/2,this.cameraO=new THREE.OrthographicCamera(a/-2,a/2,b/2,b/-2,f,g),this.cameraP=new THREE.PerspectiveCamera(c,a/b,d,e),this.zoom=1,this.toPerspective()},THREE.CombinedCamera.prototype=Object.create(THREE.Camera.prototype),THREE.CombinedCamera.prototype.toPerspective=function(){this.near=this.cameraP.near,this.far=this.cameraP.far,this.cameraP.fov=this.fov/this.zoom,this.cameraP.updateProjectionMatrix(),this.projectionMatrix=this.cameraP.projectionMatrix,this.inPerspectiveMode=!0,this.inOrthographicMode=!1},THREE.CombinedCamera.prototype.toOrthographic=function(){var a=this.cameraP.aspect,b=(this.cameraP.near+this.cameraP.far)/2,b=Math.tan(this.fov/2)*b,a=2*b*a/2,b=b/this.zoom,a=a/this.zoom;this.cameraO.left=-a,this.cameraO.right=a,this.cameraO.top=b,this.cameraO.bottom=-b,this.cameraO.updateProjectionMatrix(),this.near=this.cameraO.near,this.far=this.cameraO.far,this.projectionMatrix=this.cameraO.projectionMatrix,this.inPerspectiveMode=!1,this.inOrthographicMode=!0},THREE.CombinedCamera.prototype.setSize=function(a,b){this.cameraP.aspect=a/b,this.left=-a/2,this.right=a/2,this.top=b/2,this.bottom=-b/2},THREE.CombinedCamera.prototype.setFov=function(a){this.fov=a,this.inPerspectiveMode?this.toPerspective():this.toOrthographic()},THREE.CombinedCamera.prototype.updateProjectionMatrix=function(){this.inPerspectiveMode?this.toPerspective():(this.toPerspective(),this.toOrthographic())},THREE.CombinedCamera.prototype.setLens=function(a,b){void 0===b&&(b=24);var c=2*THREE.Math.radToDeg(Math.atan(b/(2*a)));return this.setFov(c),c},THREE.CombinedCamera.prototype.setZoom=function(a){this.zoom=a,this.inPerspectiveMode?this.toPerspective():this.toOrthographic()},THREE.CombinedCamera.prototype.toFrontView=function(){this.rotation.x=0,this.rotation.y=0,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CombinedCamera.prototype.toBackView=function(){this.rotation.x=0,this.rotation.y=Math.PI,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CombinedCamera.prototype.toLeftView=function(){this.rotation.x=0,this.rotation.y=-Math.PI/2,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CombinedCamera.prototype.toRightView=function(){this.rotation.x=0,this.rotation.y=Math.PI/2,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CombinedCamera.prototype.toTopView=function(){this.rotation.x=-Math.PI/2,this.rotation.y=0,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.CombinedCamera.prototype.toBottomView=function(){this.rotation.x=Math.PI/2,this.rotation.y=0,this.rotation.z=0,this.rotationAutoUpdate=!1},THREE.BoxGeometry=function(a,b,c,d,e,f){function g(a,b,c,d,e,f,g,i){var j,k=h.widthSegments,l=h.heightSegments,m=e/2,n=f/2,o=h.vertices.length;"x"===a&&"y"===b||"y"===a&&"x"===b?j="z":"x"===a&&"z"===b||"z"===a&&"x"===b?(j="y",l=h.depthSegments):("z"===a&&"y"===b||"y"===a&&"z"===b)&&(j="x",k=h.depthSegments);var p=k+1,q=l+1,r=e/k,s=f/l,t=new THREE.Vector3;for(t[j]=g>0?1:-1,e=0;q>e;e++)for(f=0;p>f;f++){var u=new THREE.Vector3;u[a]=(f*r-m)*c,u[b]=(e*s-n)*d,u[j]=g,h.vertices.push(u)}for(e=0;l>e;e++)for(f=0;k>f;f++)n=f+p*e,a=f+p*(e+1),b=f+1+p*(e+1),c=f+1+p*e,d=new THREE.Vector2(f/k,1-e/l),g=new THREE.Vector2(f/k,1-(e+1)/l),j=new THREE.Vector2((f+1)/k,1-(e+1)/l),m=new THREE.Vector2((f+1)/k,1-e/l),n=new THREE.Face3(n+o,a+o,c+o),n.normal.copy(t),n.vertexNormals.push(t.clone(),t.clone(),t.clone()),n.materialIndex=i,h.faces.push(n),h.faceVertexUvs[0].push([d,g,m]),n=new THREE.Face3(a+o,b+o,c+o),n.normal.copy(t),n.vertexNormals.push(t.clone(),t.clone(),t.clone()),n.materialIndex=i,h.faces.push(n),h.faceVertexUvs[0].push([g.clone(),j,m.clone()])}THREE.Geometry.call(this);var h=this;this.width=a,this.height=b,this.depth=c,this.widthSegments=d||1,this.heightSegments=e||1,this.depthSegments=f||1,a=this.width/2,b=this.height/2,c=this.depth/2,g("z","y",-1,-1,this.depth,this.height,a,0),g("z","y",1,-1,this.depth,this.height,-a,1),g("x","z",1,1,this.width,this.depth,b,2),g("x","z",1,-1,this.width,this.depth,-b,3),g("x","y",1,-1,this.width,this.height,c,4),g("x","y",-1,-1,this.width,this.height,-c,5),this.computeCentroids(),this.mergeVertices()},THREE.BoxGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.CircleGeometry=function(a,b,c,d){THREE.Geometry.call(this),this.radius=a=a||50,this.segments=b=void 0!==b?Math.max(3,b):8,this.thetaStart=c=void 0!==c?c:0,this.thetaLength=d=void 0!==d?d:2*Math.PI;var e,f=[];e=new THREE.Vector3;var g=new THREE.Vector2(.5,.5);for(this.vertices.push(e),f.push(g),e=0;b>=e;e++){var h=new THREE.Vector3,i=c+e/b*d;h.x=a*Math.cos(i),h.y=a*Math.sin(i),this.vertices.push(h),f.push(new THREE.Vector2((h.x/a+1)/2,(h.y/a+1)/2))}for(c=new THREE.Vector3(0,0,1),e=1;b>=e;e++)this.faces.push(new THREE.Face3(e,e+1,0,[c.clone(),c.clone(),c.clone()])),this.faceVertexUvs[0].push([f[e].clone(),f[e+1].clone(),g.clone()]);this.computeCentroids(),this.computeFaceNormals(),this.boundingSphere=new THREE.Sphere(new THREE.Vector3,a)},THREE.CircleGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.CubeGeometry=THREE.BoxGeometry,THREE.CylinderGeometry=function(a,b,c,d,e,f){THREE.Geometry.call(this),this.radiusTop=a=void 0!==a?a:20,this.radiusBottom=b=void 0!==b?b:20,this.height=c=void 0!==c?c:100,this.radialSegments=d=d||8,this.heightSegments=e=e||1,this.openEnded=f=void 0!==f?f:!1;var g,h,i=c/2,j=[],k=[];for(h=0;e>=h;h++){var l=[],m=[],n=h/e,o=n*(b-a)+a;for(g=0;d>=g;g++){var p=g/d,q=new THREE.Vector3;q.x=o*Math.sin(p*Math.PI*2),q.y=-n*c+i,q.z=o*Math.cos(p*Math.PI*2),this.vertices.push(q),l.push(this.vertices.length-1),m.push(new THREE.Vector2(p,1-n))}j.push(l),k.push(m)}for(c=(b-a)/c,g=0;d>g;g++)for(0!==a?(l=this.vertices[j[0][g]].clone(),m=this.vertices[j[0][g+1]].clone()):(l=this.vertices[j[1][g]].clone(),m=this.vertices[j[1][g+1]].clone()),l.setY(Math.sqrt(l.x*l.x+l.z*l.z)*c).normalize(),m.setY(Math.sqrt(m.x*m.x+m.z*m.z)*c).normalize(),h=0;e>h;h++){var n=j[h][g],o=j[h+1][g],p=j[h+1][g+1],q=j[h][g+1],r=l.clone(),s=l.clone(),t=m.clone(),u=m.clone(),v=k[h][g].clone(),w=k[h+1][g].clone(),x=k[h+1][g+1].clone(),y=k[h][g+1].clone();this.faces.push(new THREE.Face3(n,o,q,[r,s,u])),this.faceVertexUvs[0].push([v,w,y]),this.faces.push(new THREE.Face3(o,p,q,[s.clone(),t,u.clone()])),this.faceVertexUvs[0].push([w.clone(),x,y.clone()])}if(!1===f&&a>0)for(this.vertices.push(new THREE.Vector3(0,i,0)),g=0;d>g;g++)n=j[0][g],o=j[0][g+1],p=this.vertices.length-1,r=new THREE.Vector3(0,1,0),s=new THREE.Vector3(0,1,0),t=new THREE.Vector3(0,1,0),v=k[0][g].clone(),w=k[0][g+1].clone(),x=new THREE.Vector2(w.x,0),this.faces.push(new THREE.Face3(n,o,p,[r,s,t])),this.faceVertexUvs[0].push([v,w,x]);if(!1===f&&b>0)for(this.vertices.push(new THREE.Vector3(0,-i,0)),g=0;d>g;g++)n=j[h][g+1],o=j[h][g],p=this.vertices.length-1,r=new THREE.Vector3(0,-1,0),s=new THREE.Vector3(0,-1,0),t=new THREE.Vector3(0,-1,0),v=k[h][g+1].clone(),w=k[h][g].clone(),x=new THREE.Vector2(w.x,1),this.faces.push(new THREE.Face3(n,o,p,[r,s,t])),this.faceVertexUvs[0].push([v,w,x]);this.computeCentroids(),this.computeFaceNormals()},THREE.CylinderGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.ExtrudeGeometry=function(a,b){"undefined"!=typeof a&&(THREE.Geometry.call(this),a=a instanceof Array?a:[a],this.shapebb=a[a.length-1].getBoundingBox(),this.addShapeList(a,b),this.computeCentroids(),this.computeFaceNormals())},THREE.ExtrudeGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.ExtrudeGeometry.prototype.addShapeList=function(a,b){for(var c=a.length,d=0;c>d;d++)this.addShape(a[d],b)},THREE.ExtrudeGeometry.prototype.addShape=function(a,b){function c(a,b,c){return b||console.log("die"),b.clone().multiplyScalar(c).add(a)}function d(a,b,c){var d=THREE.Math.sign,e=1,e=a.x-b.x,f=a.y-b.y,g=c.x-a.x,h=c.y-a.y,i=e*e+f*f;if(1e-10<Math.abs(e*h-f*g)){var j=Math.sqrt(i),d=Math.sqrt(g*g+h*h),i=b.x-f/j;if(b=b.y+e/j,g=((c.x-h/d-i)*h-(c.y+g/d-b)*g)/(e*h-f*g),c=i+e*g-a.x,a=b+f*g-a.y,e=c*c+a*a,2>=e)return new THREE.Vector2(c,a);e=Math.sqrt(e/2)}else a=!1,e>1e-10?g>1e-10&&(a=!0):-1e-10>e?-1e-10>g&&(a=!0):d(f)==d(h)&&(a=!0),a?(c=-f,a=e,e=Math.sqrt(i)):(c=e,a=f,e=Math.sqrt(i/2));return new THREE.Vector2(c/e,a/e)}function e(c,d){var e,f;for(O=c.length;0<=--O;){e=O,f=O-1,0>f&&(f=c.length-1);for(var g=0,h=s+2*p,g=0;h>g;g++){var i=M*g,j=M*(g+1),k=d+e+i,i=d+f+i,l=d+f+j,j=d+e+j,m=c,n=g,o=h,q=e,r=f,k=k+C,i=i+C,l=l+C,j=j+C;B.faces.push(new THREE.Face3(k,i,j,null,null,w)),B.faces.push(new THREE.Face3(i,l,j,null,null,w)),k=x.generateSideWallUV(B,a,m,b,k,i,l,j,n,o,q,r),B.faceVertexUvs[0].push([k[0],k[1],k[3]]),B.faceVertexUvs[0].push([k[1],k[2],k[3]])}}}function f(a,b,c){B.vertices.push(new THREE.Vector3(a,b,c))}function g(c,d,e,f){c+=C,d+=C,e+=C,B.faces.push(new THREE.Face3(c,d,e,null,null,v)),c=f?x.generateBottomUV(B,a,b,c,d,e):x.generateTopUV(B,a,b,c,d,e),B.faceVertexUvs[0].push(c)}var h,i,j,k,l,m=void 0!==b.amount?b.amount:100,n=void 0!==b.bevelThickness?b.bevelThickness:6,o=void 0!==b.bevelSize?b.bevelSize:n-2,p=void 0!==b.bevelSegments?b.bevelSegments:3,q=void 0!==b.bevelEnabled?b.bevelEnabled:!0,r=void 0!==b.curveSegments?b.curveSegments:12,s=void 0!==b.steps?b.steps:1,t=b.extrudePath,u=!1,v=b.material,w=b.extrudeMaterial,x=void 0!==b.UVGenerator?b.UVGenerator:THREE.ExtrudeGeometry.WorldUVGenerator;t&&(h=t.getSpacedPoints(s),u=!0,q=!1,i=void 0!==b.frames?b.frames:new THREE.TubeGeometry.FrenetFrames(t,s,!1),j=new THREE.Vector3,k=new THREE.Vector3,l=new THREE.Vector3),q||(o=n=p=0);var y,z,A,B=this,C=this.vertices.length,t=a.extractPoints(r),r=t.shape,D=t.holes;if(t=!THREE.Shape.Utils.isClockWise(r)){for(r=r.reverse(),z=0,A=D.length;A>z;z++)y=D[z],THREE.Shape.Utils.isClockWise(y)&&(D[z]=y.reverse());t=!1}var E=THREE.Shape.Utils.triangulateShape(r,D),F=r;for(z=0,A=D.length;A>z;z++)y=D[z],r=r.concat(y);var G,H,I,J,K,L,M=r.length,N=E.length,t=[],O=0;for(I=F.length,G=I-1,H=O+1;I>O;O++,G++,H++)G===I&&(G=0),H===I&&(H=0),t[O]=d(F[O],F[G],F[H]);var P,Q=[],R=t.concat();for(z=0,A=D.length;A>z;z++){for(y=D[z],P=[],O=0,I=y.length,G=I-1,H=O+1;I>O;O++,G++,H++)G===I&&(G=0),H===I&&(H=0),P[O]=d(y[O],y[G],y[H]);Q.push(P),R=R.concat(P)}for(G=0;p>G;G++){for(I=G/p,J=n*(1-I),H=o*Math.sin(I*Math.PI/2),O=0,I=F.length;I>O;O++)K=c(F[O],t[O],H),f(K.x,K.y,-J);for(z=0,A=D.length;A>z;z++)for(y=D[z],P=Q[z],O=0,I=y.length;I>O;O++)K=c(y[O],P[O],H),f(K.x,K.y,-J)}for(H=o,O=0;M>O;O++)K=q?c(r[O],R[O],H):r[O],u?(k.copy(i.normals[0]).multiplyScalar(K.x),j.copy(i.binormals[0]).multiplyScalar(K.y),l.copy(h[0]).add(k).add(j),f(l.x,l.y,l.z)):f(K.x,K.y,0);for(I=1;s>=I;I++)for(O=0;M>O;O++)K=q?c(r[O],R[O],H):r[O],u?(k.copy(i.normals[I]).multiplyScalar(K.x),j.copy(i.binormals[I]).multiplyScalar(K.y),l.copy(h[I]).add(k).add(j),f(l.x,l.y,l.z)):f(K.x,K.y,m/s*I);for(G=p-1;G>=0;G--){for(I=G/p,J=n*(1-I),H=o*Math.sin(I*Math.PI/2),O=0,I=F.length;I>O;O++)K=c(F[O],t[O],H),f(K.x,K.y,m+J);for(z=0,A=D.length;A>z;z++)for(y=D[z],P=Q[z],O=0,I=y.length;I>O;O++)K=c(y[O],P[O],H),u?f(K.x,K.y+h[s-1].y,h[s-1].x+J):f(K.x,K.y,m+J)}!function(){if(q){var a;for(a=0*M,O=0;N>O;O++)L=E[O],g(L[2]+a,L[1]+a,L[0]+a,!0);for(a=s+2*p,a*=M,O=0;N>O;O++)L=E[O],g(L[0]+a,L[1]+a,L[2]+a,!1)}else{for(O=0;N>O;O++)L=E[O],g(L[2],L[1],L[0],!0);for(O=0;N>O;O++)L=E[O],g(L[0]+M*s,L[1]+M*s,L[2]+M*s,!1)}}(),function(){var a=0;for(e(F,a),a+=F.length,z=0,A=D.length;A>z;z++)y=D[z],e(y,a),a+=y.length}()},THREE.ExtrudeGeometry.WorldUVGenerator={generateTopUV:function(a,b,c,d,e,f){return b=a.vertices[e].x,e=a.vertices[e].y,c=a.vertices[f].x,f=a.vertices[f].y,[new THREE.Vector2(a.vertices[d].x,a.vertices[d].y),new THREE.Vector2(b,e),new THREE.Vector2(c,f)]},generateBottomUV:function(a,b,c,d,e,f){return this.generateTopUV(a,b,c,d,e,f)},generateSideWallUV:function(a,b,c,d,e,f,g,h,i,j,k,l){b=a.vertices[e].x,c=a.vertices[e].y,e=a.vertices[e].z,d=a.vertices[f].x,i=a.vertices[f].y,f=a.vertices[f].z,j=a.vertices[g].x,k=a.vertices[g].y,g=a.vertices[g].z,l=a.vertices[h].x;var m=a.vertices[h].y;return a=a.vertices[h].z,.01>Math.abs(c-i)?[new THREE.Vector2(b,1-e),new THREE.Vector2(d,1-f),new THREE.Vector2(j,1-g),new THREE.Vector2(l,1-a)]:[new THREE.Vector2(c,1-e),new THREE.Vector2(i,1-f),new THREE.Vector2(k,1-g),new THREE.Vector2(m,1-a)]}},THREE.ExtrudeGeometry.__v1=new THREE.Vector2,THREE.ExtrudeGeometry.__v2=new THREE.Vector2,THREE.ExtrudeGeometry.__v3=new THREE.Vector2,THREE.ExtrudeGeometry.__v4=new THREE.Vector2,THREE.ExtrudeGeometry.__v5=new THREE.Vector2,THREE.ExtrudeGeometry.__v6=new THREE.Vector2,THREE.ShapeGeometry=function(a,b){THREE.Geometry.call(this),0==a instanceof Array&&(a=[a]),this.shapebb=a[a.length-1].getBoundingBox(),this.addShapeList(a,b),this.computeCentroids(),this.computeFaceNormals()},THREE.ShapeGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.ShapeGeometry.prototype.addShapeList=function(a,b){for(var c=0,d=a.length;d>c;c++)this.addShape(a[c],b);return this},THREE.ShapeGeometry.prototype.addShape=function(a,b){void 0===b&&(b={});var c,d,e,f=b.material,g=void 0===b.UVGenerator?THREE.ExtrudeGeometry.WorldUVGenerator:b.UVGenerator,h=this.vertices.length;c=a.extractPoints(void 0!==b.curveSegments?b.curveSegments:12);var i=c.shape,j=c.holes;if(!THREE.Shape.Utils.isClockWise(i))for(i=i.reverse(),c=0,d=j.length;d>c;c++)e=j[c],THREE.Shape.Utils.isClockWise(e)&&(j[c]=e.reverse());var k=THREE.Shape.Utils.triangulateShape(i,j);for(c=0,d=j.length;d>c;c++)e=j[c],i=i.concat(e);for(j=i.length,d=k.length,c=0;j>c;c++)e=i[c],this.vertices.push(new THREE.Vector3(e.x,e.y,0));for(c=0;d>c;c++)j=k[c],i=j[0]+h,e=j[1]+h,j=j[2]+h,this.faces.push(new THREE.Face3(i,e,j,null,null,f)),this.faceVertexUvs[0].push(g.generateBottomUV(this,a,b,i,e,j))},THREE.LatheGeometry=function(a,b,c,d){THREE.Geometry.call(this),b=b||12,c=c||0,d=d||2*Math.PI;for(var e=1/(a.length-1),f=1/b,g=0,h=b;h>=g;g++)for(var i=c+g*f*d,j=Math.cos(i),k=Math.sin(i),i=0,l=a.length;l>i;i++){var m=a[i],n=new THREE.Vector3;n.x=j*m.x-k*m.y,n.y=k*m.x+j*m.y,n.z=m.z,this.vertices.push(n)}for(c=a.length,g=0,h=b;h>g;g++)for(i=0,l=a.length-1;l>i;i++){b=k=i+c*g,d=k+c;var j=k+1+c,k=k+1,m=g*f,n=i*e,o=m+f,p=n+e;this.faces.push(new THREE.Face3(b,d,k)),this.faceVertexUvs[0].push([new THREE.Vector2(m,n),new THREE.Vector2(o,n),new THREE.Vector2(m,p)]),this.faces.push(new THREE.Face3(d,j,k)),this.faceVertexUvs[0].push([new THREE.Vector2(o,n),new THREE.Vector2(o,p),new THREE.Vector2(m,p)])}this.mergeVertices(),this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals()},THREE.LatheGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.PlaneGeometry=function(a,b,c,d){THREE.Geometry.call(this),this.width=a,this.height=b,this.widthSegments=c||1,this.heightSegments=d||1;var e=a/2,f=b/2;c=this.widthSegments,d=this.heightSegments;var g=c+1,h=d+1,i=this.width/c,j=this.height/d,k=new THREE.Vector3(0,0,1);for(a=0;h>a;a++)for(b=0;g>b;b++)this.vertices.push(new THREE.Vector3(b*i-e,-(a*j-f),0));for(a=0;d>a;a++)for(b=0;c>b;b++){var l=b+g*a,e=b+g*(a+1),f=b+1+g*(a+1),h=b+1+g*a,i=new THREE.Vector2(b/c,1-a/d),j=new THREE.Vector2(b/c,1-(a+1)/d),m=new THREE.Vector2((b+1)/c,1-(a+1)/d),n=new THREE.Vector2((b+1)/c,1-a/d),l=new THREE.Face3(l,e,h);l.normal.copy(k),l.vertexNormals.push(k.clone(),k.clone(),k.clone()),this.faces.push(l),this.faceVertexUvs[0].push([i,j,n]),l=new THREE.Face3(e,f,h),l.normal.copy(k),l.vertexNormals.push(k.clone(),k.clone(),k.clone()),this.faces.push(l),this.faceVertexUvs[0].push([j.clone(),m,n.clone()])}this.computeCentroids()},THREE.PlaneGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.RingGeometry=function(a,b,c,d,e,f){THREE.Geometry.call(this),a=a||0,b=b||50,e=void 0!==e?e:0,f=void 0!==f?f:2*Math.PI,c=void 0!==c?Math.max(3,c):8,d=void 0!==d?Math.max(3,d):8;var g,h=[],i=a,j=(b-a)/d;for(a=0;d>=a;a++){for(g=0;c>=g;g++){var k=new THREE.Vector3,l=e+g/c*f;k.x=i*Math.cos(l),k.y=i*Math.sin(l),this.vertices.push(k),h.push(new THREE.Vector2((k.x/b+1)/2,(k.y/b+1)/2))}i+=j}for(b=new THREE.Vector3(0,0,1),a=0;d>a;a++)for(e=a*c,g=0;c>=g;g++)l=g+e,f=l+a,j=l+c+a,k=l+c+1+a,this.faces.push(new THREE.Face3(f,j,k,[b.clone(),b.clone(),b.clone()])),this.faceVertexUvs[0].push([h[f].clone(),h[j].clone(),h[k].clone()]),f=l+a,j=l+c+1+a,k=l+1+a,this.faces.push(new THREE.Face3(f,j,k,[b.clone(),b.clone(),b.clone()])),this.faceVertexUvs[0].push([h[f].clone(),h[j].clone(),h[k].clone()]);this.computeCentroids(),this.computeFaceNormals(),this.boundingSphere=new THREE.Sphere(new THREE.Vector3,i)},THREE.RingGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.SphereGeometry=function(a,b,c,d,e,f,g){THREE.Geometry.call(this),this.radius=a=a||50,this.widthSegments=b=Math.max(3,Math.floor(b)||8),this.heightSegments=c=Math.max(2,Math.floor(c)||6),this.phiStart=d=void 0!==d?d:0,this.phiLength=e=void 0!==e?e:2*Math.PI,this.thetaStart=f=void 0!==f?f:0,this.thetaLength=g=void 0!==g?g:Math.PI;var h,i,j=[],k=[];for(i=0;c>=i;i++){var l=[],m=[];for(h=0;b>=h;h++){var n=h/b,o=i/c,p=new THREE.Vector3;p.x=-a*Math.cos(d+n*e)*Math.sin(f+o*g),p.y=a*Math.cos(f+o*g),p.z=a*Math.sin(d+n*e)*Math.sin(f+o*g),this.vertices.push(p),l.push(this.vertices.length-1),m.push(new THREE.Vector2(n,1-o))}j.push(l),k.push(m)}for(i=0;i<this.heightSegments;i++)for(h=0;h<this.widthSegments;h++){b=j[i][h+1],c=j[i][h],d=j[i+1][h],e=j[i+1][h+1],f=this.vertices[b].clone().normalize(),g=this.vertices[c].clone().normalize();var l=this.vertices[d].clone().normalize(),m=this.vertices[e].clone().normalize(),n=k[i][h+1].clone(),o=k[i][h].clone(),p=k[i+1][h].clone(),q=k[i+1][h+1].clone();
Math.abs(this.vertices[b].y)===this.radius?(n.x=(n.x+o.x)/2,this.faces.push(new THREE.Face3(b,d,e,[f,l,m])),this.faceVertexUvs[0].push([n,p,q])):Math.abs(this.vertices[d].y)===this.radius?(p.x=(p.x+q.x)/2,this.faces.push(new THREE.Face3(b,c,d,[f,g,l])),this.faceVertexUvs[0].push([n,o,p])):(this.faces.push(new THREE.Face3(b,c,e,[f,g,m])),this.faceVertexUvs[0].push([n,o,q]),this.faces.push(new THREE.Face3(c,d,e,[g.clone(),l,m.clone()])),this.faceVertexUvs[0].push([o.clone(),p,q.clone()]))}this.computeCentroids(),this.computeFaceNormals(),this.boundingSphere=new THREE.Sphere(new THREE.Vector3,a)},THREE.SphereGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.TextGeometry=function(a,b){b=b||{};var c=THREE.FontUtils.generateShapes(a,b);b.amount=void 0!==b.height?b.height:50,void 0===b.bevelThickness&&(b.bevelThickness=10),void 0===b.bevelSize&&(b.bevelSize=8),void 0===b.bevelEnabled&&(b.bevelEnabled=!1),THREE.ExtrudeGeometry.call(this,c,b)},THREE.TextGeometry.prototype=Object.create(THREE.ExtrudeGeometry.prototype),THREE.TorusGeometry=function(a,b,c,d,e){for(THREE.Geometry.call(this),this.radius=a||100,this.tube=b||40,this.radialSegments=c||8,this.tubularSegments=d||6,this.arc=e||2*Math.PI,e=new THREE.Vector3,a=[],b=[],c=0;c<=this.radialSegments;c++)for(d=0;d<=this.tubularSegments;d++){var f=d/this.tubularSegments*this.arc,g=c/this.radialSegments*Math.PI*2;e.x=this.radius*Math.cos(f),e.y=this.radius*Math.sin(f);var h=new THREE.Vector3;h.x=(this.radius+this.tube*Math.cos(g))*Math.cos(f),h.y=(this.radius+this.tube*Math.cos(g))*Math.sin(f),h.z=this.tube*Math.sin(g),this.vertices.push(h),a.push(new THREE.Vector2(d/this.tubularSegments,c/this.radialSegments)),b.push(h.clone().sub(e).normalize())}for(c=1;c<=this.radialSegments;c++)for(d=1;d<=this.tubularSegments;d++){e=(this.tubularSegments+1)*c+d-1;var f=(this.tubularSegments+1)*(c-1)+d-1,g=(this.tubularSegments+1)*(c-1)+d,h=(this.tubularSegments+1)*c+d,i=new THREE.Face3(e,f,h,[b[e].clone(),b[f].clone(),b[h].clone()]);this.faces.push(i),this.faceVertexUvs[0].push([a[e].clone(),a[f].clone(),a[h].clone()]),i=new THREE.Face3(f,g,h,[b[f].clone(),b[g].clone(),b[h].clone()]),this.faces.push(i),this.faceVertexUvs[0].push([a[f].clone(),a[g].clone(),a[h].clone()])}this.computeCentroids(),this.computeFaceNormals()},THREE.TorusGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.TorusKnotGeometry=function(a,b,c,d,e,f,g){function h(a,b,c,d,e){var f=Math.cos(a),g=Math.sin(a);return a*=b/c,b=Math.cos(a),f*=d*(2+b)*.5,g=d*(2+b)*g*.5,d=e*d*Math.sin(a)*.5,new THREE.Vector3(f,g,d)}for(THREE.Geometry.call(this),this.radius=a||100,this.tube=b||40,this.radialSegments=c||64,this.tubularSegments=d||8,this.p=e||2,this.q=f||3,this.heightScale=g||1,this.grid=Array(this.radialSegments),c=new THREE.Vector3,d=new THREE.Vector3,e=new THREE.Vector3,a=0;a<this.radialSegments;++a)for(this.grid[a]=Array(this.tubularSegments),b=a/this.radialSegments*2*this.p*Math.PI,f=h(b,this.q,this.p,this.radius,this.heightScale),b=h(b+.01,this.q,this.p,this.radius,this.heightScale),c.subVectors(b,f),d.addVectors(b,f),e.crossVectors(c,d),d.crossVectors(e,c),e.normalize(),d.normalize(),b=0;b<this.tubularSegments;++b){var i=b/this.tubularSegments*2*Math.PI;g=-this.tube*Math.cos(i);var i=this.tube*Math.sin(i),j=new THREE.Vector3;j.x=f.x+g*d.x+i*e.x,j.y=f.y+g*d.y+i*e.y,j.z=f.z+g*d.z+i*e.z,this.grid[a][b]=this.vertices.push(j)-1}for(a=0;a<this.radialSegments;++a)for(b=0;b<this.tubularSegments;++b){e=(a+1)%this.radialSegments,f=(b+1)%this.tubularSegments,c=this.grid[a][b],d=this.grid[e][b],e=this.grid[e][f],f=this.grid[a][f],g=new THREE.Vector2(a/this.radialSegments,b/this.tubularSegments);var i=new THREE.Vector2((a+1)/this.radialSegments,b/this.tubularSegments),j=new THREE.Vector2((a+1)/this.radialSegments,(b+1)/this.tubularSegments),k=new THREE.Vector2(a/this.radialSegments,(b+1)/this.tubularSegments);this.faces.push(new THREE.Face3(c,d,f)),this.faceVertexUvs[0].push([g,i,k]),this.faces.push(new THREE.Face3(d,e,f)),this.faceVertexUvs[0].push([i.clone(),j,k.clone()])}this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals()},THREE.TorusKnotGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.TubeGeometry=function(a,b,c,d,e){THREE.Geometry.call(this),this.path=a,this.segments=b||64,this.radius=c||1,this.radialSegments=d||8,this.closed=e||!1,this.grid=[];var f,g;d=this.segments+1;var h,i,j;e=new THREE.Vector3;var k,l;for(b=new THREE.TubeGeometry.FrenetFrames(this.path,this.segments,this.closed),k=b.normals,l=b.binormals,this.tangents=b.tangents,this.normals=k,this.binormals=l,b=0;d>b;b++)for(this.grid[b]=[],c=b/(d-1),j=a.getPointAt(c),f=k[b],g=l[b],c=0;c<this.radialSegments;c++)h=c/this.radialSegments*2*Math.PI,i=-this.radius*Math.cos(h),h=this.radius*Math.sin(h),e.copy(j),e.x+=i*f.x+h*g.x,e.y+=i*f.y+h*g.y,e.z+=i*f.z+h*g.z,this.grid[b][c]=this.vertices.push(new THREE.Vector3(e.x,e.y,e.z))-1;for(b=0;b<this.segments;b++)for(c=0;c<this.radialSegments;c++)e=this.closed?(b+1)%this.segments:b+1,k=(c+1)%this.radialSegments,a=this.grid[b][c],d=this.grid[e][c],e=this.grid[e][k],k=this.grid[b][k],l=new THREE.Vector2(b/this.segments,c/this.radialSegments),f=new THREE.Vector2((b+1)/this.segments,c/this.radialSegments),g=new THREE.Vector2((b+1)/this.segments,(c+1)/this.radialSegments),i=new THREE.Vector2(b/this.segments,(c+1)/this.radialSegments),this.faces.push(new THREE.Face3(a,d,k)),this.faceVertexUvs[0].push([l,f,i]),this.faces.push(new THREE.Face3(d,e,k)),this.faceVertexUvs[0].push([f.clone(),g,i.clone()]);this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals()},THREE.TubeGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.TubeGeometry.FrenetFrames=function(a,b,c){new THREE.Vector3;var d=new THREE.Vector3;new THREE.Vector3;var e=[],f=[],g=[],h=new THREE.Vector3,i=new THREE.Matrix4;b+=1;var j,k,l;for(this.tangents=e,this.normals=f,this.binormals=g,j=0;b>j;j++)k=j/(b-1),e[j]=a.getTangentAt(k),e[j].normalize();for(f[0]=new THREE.Vector3,g[0]=new THREE.Vector3,a=Number.MAX_VALUE,j=Math.abs(e[0].x),k=Math.abs(e[0].y),l=Math.abs(e[0].z),a>=j&&(a=j,d.set(1,0,0)),a>=k&&(a=k,d.set(0,1,0)),a>=l&&d.set(0,0,1),h.crossVectors(e[0],d).normalize(),f[0].crossVectors(e[0],h),g[0].crossVectors(e[0],f[0]),j=1;b>j;j++)f[j]=f[j-1].clone(),g[j]=g[j-1].clone(),h.crossVectors(e[j-1],e[j]),1e-4<h.length()&&(h.normalize(),d=Math.acos(THREE.Math.clamp(e[j-1].dot(e[j]),-1,1)),f[j].applyMatrix4(i.makeRotationAxis(h,d))),g[j].crossVectors(e[j],f[j]);if(c)for(d=Math.acos(THREE.Math.clamp(f[0].dot(f[b-1]),-1,1)),d/=b-1,0<e[0].dot(h.crossVectors(f[0],f[b-1]))&&(d=-d),j=1;b>j;j++)f[j].applyMatrix4(i.makeRotationAxis(e[j],d*j)),g[j].crossVectors(e[j],f[j])},THREE.PolyhedronGeometry=function(a,b,c,d){function e(a){var b=a.normalize().clone();b.index=i.vertices.push(b)-1;var c=Math.atan2(a.z,-a.x)/2/Math.PI+.5;return a=Math.atan2(-a.y,Math.sqrt(a.x*a.x+a.z*a.z))/Math.PI+.5,b.uv=new THREE.Vector2(c,1-a),b}function f(a,b,c){var d=new THREE.Face3(a.index,b.index,c.index,[a.clone(),b.clone(),c.clone()]);d.centroid.add(a).add(b).add(c).divideScalar(3),i.faces.push(d),d=d.centroid,d=Math.atan2(d.z,-d.x),i.faceVertexUvs[0].push([h(a.uv,a,d),h(b.uv,b,d),h(c.uv,c,d)])}function g(a,b){var c=Math.pow(2,b);Math.pow(4,b);for(var d=e(i.vertices[a.a]),g=e(i.vertices[a.b]),h=e(i.vertices[a.c]),j=[],k=0;c>=k;k++){j[k]=[];for(var l=e(d.clone().lerp(h,k/c)),m=e(g.clone().lerp(h,k/c)),n=c-k,o=0;n>=o;o++)j[k][o]=0==o&&k==c?l:e(l.clone().lerp(m,o/n))}for(k=0;c>k;k++)for(o=0;2*(c-k)-1>o;o++)d=Math.floor(o/2),0==o%2?f(j[k][d+1],j[k+1][d],j[k][d]):f(j[k][d+1],j[k+1][d+1],j[k+1][d])}function h(a,b,c){return 0>c&&1===a.x&&(a=new THREE.Vector2(a.x-1,a.y)),0===b.x&&0===b.z&&(a=new THREE.Vector2(c/2/Math.PI+.5,a.y)),a.clone()}THREE.Geometry.call(this),c=c||1,d=d||0;for(var i=this,j=0,k=a.length;k>j;j++)e(new THREE.Vector3(a[j][0],a[j][1],a[j][2]));a=this.vertices;for(var l=[],j=0,k=b.length;k>j;j++){var m=a[b[j][0]],n=a[b[j][1]],o=a[b[j][2]];l[j]=new THREE.Face3(m.index,n.index,o.index,[m.clone(),n.clone(),o.clone()])}for(j=0,k=l.length;k>j;j++)g(l[j],d);for(j=0,k=this.faceVertexUvs[0].length;k>j;j++)b=this.faceVertexUvs[0][j],d=b[0].x,a=b[1].x,l=b[2].x,m=Math.max(d,Math.max(a,l)),n=Math.min(d,Math.min(a,l)),m>.9&&.1>n&&(.2>d&&(b[0].x+=1),.2>a&&(b[1].x+=1),.2>l&&(b[2].x+=1));for(j=0,k=this.vertices.length;k>j;j++)this.vertices[j].multiplyScalar(c);this.mergeVertices(),this.computeCentroids(),this.computeFaceNormals(),this.boundingSphere=new THREE.Sphere(new THREE.Vector3,c)},THREE.PolyhedronGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.IcosahedronGeometry=function(a,b){this.radius=a,this.detail=b;var c=(1+Math.sqrt(5))/2;THREE.PolyhedronGeometry.call(this,[[-1,c,0],[1,c,0],[-1,-c,0],[1,-c,0],[0,-1,c],[0,1,c],[0,-1,-c],[0,1,-c],[c,0,-1],[c,0,1],[-c,0,-1],[-c,0,1]],[[0,11,5],[0,5,1],[0,1,7],[0,7,10],[0,10,11],[1,5,9],[5,11,4],[11,10,2],[10,7,6],[7,1,8],[3,9,4],[3,4,2],[3,2,6],[3,6,8],[3,8,9],[4,9,5],[2,4,11],[6,2,10],[8,6,7],[9,8,1]],a,b)},THREE.IcosahedronGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.OctahedronGeometry=function(a,b){THREE.PolyhedronGeometry.call(this,[[1,0,0],[-1,0,0],[0,1,0],[0,-1,0],[0,0,1],[0,0,-1]],[[0,2,4],[0,4,3],[0,3,5],[0,5,2],[1,2,5],[1,5,3],[1,3,4],[1,4,2]],a,b)},THREE.OctahedronGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.TetrahedronGeometry=function(a,b){THREE.PolyhedronGeometry.call(this,[[1,1,1],[-1,-1,1],[-1,1,-1],[1,-1,-1]],[[2,1,0],[0,3,2],[1,3,0],[2,3,1]],a,b)},THREE.TetrahedronGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.ParametricGeometry=function(a,b,c){THREE.Geometry.call(this);var d,e,f,g,h=this.vertices,i=this.faces,j=this.faceVertexUvs[0],k=b+1;for(d=0;c>=d;d++)for(g=d/c,e=0;b>=e;e++)f=e/b,f=a(f,g),h.push(f);var l,m,n,o;for(d=0;c>d;d++)for(e=0;b>e;e++)a=d*k+e,h=d*k+e+1,g=(d+1)*k+e+1,f=(d+1)*k+e,l=new THREE.Vector2(e/b,d/c),m=new THREE.Vector2((e+1)/b,d/c),n=new THREE.Vector2((e+1)/b,(d+1)/c),o=new THREE.Vector2(e/b,(d+1)/c),i.push(new THREE.Face3(a,h,f)),j.push([l,m,o]),i.push(new THREE.Face3(h,g,f)),j.push([m.clone(),n,o.clone()]);this.computeCentroids(),this.computeFaceNormals(),this.computeVertexNormals()},THREE.ParametricGeometry.prototype=Object.create(THREE.Geometry.prototype),THREE.AxisHelper=function(a){a=a||1;var b=new THREE.Geometry;b.vertices.push(new THREE.Vector3,new THREE.Vector3(a,0,0),new THREE.Vector3,new THREE.Vector3(0,a,0),new THREE.Vector3,new THREE.Vector3(0,0,a)),b.colors.push(new THREE.Color(16711680),new THREE.Color(16755200),new THREE.Color(65280),new THREE.Color(11206400),new THREE.Color(255),new THREE.Color(43775)),a=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors}),THREE.Line.call(this,b,a,THREE.LinePieces)},THREE.AxisHelper.prototype=Object.create(THREE.Line.prototype),THREE.ArrowHelper=function(a,b,c,d,e,f){THREE.Object3D.call(this),void 0===d&&(d=16776960),void 0===c&&(c=1),void 0===e&&(e=.2*c),void 0===f&&(f=.2*e),this.position=b,b=new THREE.Geometry,b.vertices.push(new THREE.Vector3(0,0,0)),b.vertices.push(new THREE.Vector3(0,1,0)),this.line=new THREE.Line(b,new THREE.LineBasicMaterial({color:d})),this.line.matrixAutoUpdate=!1,this.add(this.line),b=new THREE.CylinderGeometry(0,.5,1,5,1),b.applyMatrix((new THREE.Matrix4).makeTranslation(0,-.5,0)),this.cone=new THREE.Mesh(b,new THREE.MeshBasicMaterial({color:d})),this.cone.matrixAutoUpdate=!1,this.add(this.cone),this.setDirection(a),this.setLength(c,e,f)},THREE.ArrowHelper.prototype=Object.create(THREE.Object3D.prototype),THREE.ArrowHelper.prototype.setDirection=function(){var a,b=new THREE.Vector3;return function(c){.99999<c.y?this.quaternion.set(0,0,0,1):-.99999>c.y?this.quaternion.set(1,0,0,0):(b.set(c.z,0,-c.x).normalize(),a=Math.acos(c.y),this.quaternion.setFromAxisAngle(b,a))}}(),THREE.ArrowHelper.prototype.setLength=function(a,b,c){void 0===b&&(b=.2*a),void 0===c&&(c=.2*b),this.line.scale.set(1,a,1),this.line.updateMatrix(),this.cone.scale.set(c,b,c),this.cone.position.y=a,this.cone.updateMatrix()},THREE.ArrowHelper.prototype.setColor=function(a){this.line.material.color.setHex(a),this.cone.material.color.setHex(a)},THREE.BoxHelper=function(a){var b=[new THREE.Vector3(1,1,1),new THREE.Vector3(-1,1,1),new THREE.Vector3(-1,-1,1),new THREE.Vector3(1,-1,1),new THREE.Vector3(1,1,-1),new THREE.Vector3(-1,1,-1),new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,-1,-1)];this.vertices=b;var c=new THREE.Geometry;c.vertices.push(b[0],b[1],b[1],b[2],b[2],b[3],b[3],b[0],b[4],b[5],b[5],b[6],b[6],b[7],b[7],b[4],b[0],b[4],b[1],b[5],b[2],b[6],b[3],b[7]),THREE.Line.call(this,c,new THREE.LineBasicMaterial({color:16776960}),THREE.LinePieces),void 0!==a&&this.update(a)},THREE.BoxHelper.prototype=Object.create(THREE.Line.prototype),THREE.BoxHelper.prototype.update=function(a){var b=a.geometry;null===b.boundingBox&&b.computeBoundingBox();var c=b.boundingBox.min,b=b.boundingBox.max,d=this.vertices;d[0].set(b.x,b.y,b.z),d[1].set(c.x,b.y,b.z),d[2].set(c.x,c.y,b.z),d[3].set(b.x,c.y,b.z),d[4].set(b.x,b.y,c.z),d[5].set(c.x,b.y,c.z),d[6].set(c.x,c.y,c.z),d[7].set(b.x,c.y,c.z),this.geometry.computeBoundingSphere(),this.geometry.verticesNeedUpdate=!0,this.matrixAutoUpdate=!1,this.matrixWorld=a.matrixWorld},THREE.BoundingBoxHelper=function(a,b){var c=void 0!==b?b:8947848;this.object=a,this.box=new THREE.Box3,THREE.Mesh.call(this,new THREE.BoxGeometry(1,1,1),new THREE.MeshBasicMaterial({color:c,wireframe:!0}))},THREE.BoundingBoxHelper.prototype=Object.create(THREE.Mesh.prototype),THREE.BoundingBoxHelper.prototype.update=function(){this.box.setFromObject(this.object),this.box.size(this.scale),this.box.center(this.position)},THREE.CameraHelper=function(a){function b(a,b,d){c(a,d),c(b,d)}function c(a,b){d.vertices.push(new THREE.Vector3),d.colors.push(new THREE.Color(b)),void 0===f[a]&&(f[a]=[]),f[a].push(d.vertices.length-1)}var d=new THREE.Geometry,e=new THREE.LineBasicMaterial({color:16777215,vertexColors:THREE.FaceColors}),f={};b("n1","n2",16755200),b("n2","n4",16755200),b("n4","n3",16755200),b("n3","n1",16755200),b("f1","f2",16755200),b("f2","f4",16755200),b("f4","f3",16755200),b("f3","f1",16755200),b("n1","f1",16755200),b("n2","f2",16755200),b("n3","f3",16755200),b("n4","f4",16755200),b("p","n1",16711680),b("p","n2",16711680),b("p","n3",16711680),b("p","n4",16711680),b("u1","u2",43775),b("u2","u3",43775),b("u3","u1",43775),b("c","t",16777215),b("p","c",3355443),b("cn1","cn2",3355443),b("cn3","cn4",3355443),b("cf1","cf2",3355443),b("cf3","cf4",3355443),THREE.Line.call(this,d,e,THREE.LinePieces),this.camera=a,this.matrixWorld=a.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap=f,this.update()},THREE.CameraHelper.prototype=Object.create(THREE.Line.prototype),THREE.CameraHelper.prototype.update=function(){var a=new THREE.Vector3,b=new THREE.Camera,c=new THREE.Projector;return function(){function d(d,f,g,h){if(a.set(f,g,h),c.unprojectVector(a,b),d=e.pointMap[d],void 0!==d)for(f=0,g=d.length;g>f;f++)e.geometry.vertices[d[f]].copy(a)}var e=this;b.projectionMatrix.copy(this.camera.projectionMatrix),d("c",0,0,-1),d("t",0,0,1),d("n1",-1,-1,-1),d("n2",1,-1,-1),d("n3",-1,1,-1),d("n4",1,1,-1),d("f1",-1,-1,1),d("f2",1,-1,1),d("f3",-1,1,1),d("f4",1,1,1),d("u1",.7,1.1,-1),d("u2",-.7,1.1,-1),d("u3",0,2,-1),d("cf1",-1,0,1),d("cf2",1,0,1),d("cf3",0,-1,1),d("cf4",0,1,1),d("cn1",-1,0,-1),d("cn2",1,0,-1),d("cn3",0,-1,-1),d("cn4",0,1,-1),this.geometry.verticesNeedUpdate=!0}}(),THREE.DirectionalLightHelper=function(a,b){THREE.Object3D.call(this),this.light=a,this.light.updateMatrixWorld(),this.matrixWorld=a.matrixWorld,this.matrixAutoUpdate=!1,b=b||1;var c=new THREE.PlaneGeometry(b,b),d=new THREE.MeshBasicMaterial({wireframe:!0,fog:!1});d.color.copy(this.light.color).multiplyScalar(this.light.intensity),this.lightPlane=new THREE.Mesh(c,d),this.add(this.lightPlane),c=new THREE.Geometry,c.vertices.push(new THREE.Vector3),c.vertices.push(new THREE.Vector3),d=new THREE.LineBasicMaterial({fog:!1}),d.color.copy(this.light.color).multiplyScalar(this.light.intensity),this.targetLine=new THREE.Line(c,d),this.add(this.targetLine),this.update()},THREE.DirectionalLightHelper.prototype=Object.create(THREE.Object3D.prototype),THREE.DirectionalLightHelper.prototype.dispose=function(){this.lightPlane.geometry.dispose(),this.lightPlane.material.dispose(),this.targetLine.geometry.dispose(),this.targetLine.material.dispose()},THREE.DirectionalLightHelper.prototype.update=function(){var a=new THREE.Vector3,b=new THREE.Vector3,c=new THREE.Vector3;return function(){a.setFromMatrixPosition(this.light.matrixWorld),b.setFromMatrixPosition(this.light.target.matrixWorld),c.subVectors(b,a),this.lightPlane.lookAt(c),this.lightPlane.material.color.copy(this.light.color).multiplyScalar(this.light.intensity),this.targetLine.geometry.vertices[1].copy(c),this.targetLine.geometry.verticesNeedUpdate=!0,this.targetLine.material.color.copy(this.lightPlane.material.color)}}(),THREE.EdgesHelper=function(a,b){var c=void 0!==b?b:16777215,d=[0,0],e={},f=function(a,b){return a-b},g=["a","b","c"],h=new THREE.BufferGeometry,i=a.geometry.clone();i.mergeVertices(),i.computeFaceNormals();for(var j=i.vertices,i=i.faces,k=0,l=0,m=i.length;m>l;l++)for(var n=i[l],o=0;3>o;o++){d[0]=n[g[o]],d[1]=n[g[(o+1)%3]],d.sort(f);var p=d.toString();void 0===e[p]?(e[p]={vert1:d[0],vert2:d[1],face1:l,face2:void 0},k++):e[p].face2=l}h.addAttribute("position",Float32Array,2*k,3),d=h.attributes.position.array,f=0;for(p in e)g=e[p],(void 0===g.face2||.9999>i[g.face1].normal.dot(i[g.face2].normal))&&(k=j[g.vert1],d[f++]=k.x,d[f++]=k.y,d[f++]=k.z,k=j[g.vert2],d[f++]=k.x,d[f++]=k.y,d[f++]=k.z);THREE.Line.call(this,h,new THREE.LineBasicMaterial({color:c}),THREE.LinePieces),this.matrixAutoUpdate=!1,this.matrixWorld=a.matrixWorld},THREE.EdgesHelper.prototype=Object.create(THREE.Line.prototype),THREE.FaceNormalsHelper=function(a,b,c,d){this.object=a,this.size=void 0!==b?b:1,a=void 0!==c?c:16776960,d=void 0!==d?d:1,b=new THREE.Geometry,c=0;for(var e=this.object.geometry.faces.length;e>c;c++)b.vertices.push(new THREE.Vector3),b.vertices.push(new THREE.Vector3);THREE.Line.call(this,b,new THREE.LineBasicMaterial({color:a,linewidth:d}),THREE.LinePieces),this.matrixAutoUpdate=!1,this.normalMatrix=new THREE.Matrix3,this.update()},THREE.FaceNormalsHelper.prototype=Object.create(THREE.Line.prototype),THREE.FaceNormalsHelper.prototype.update=function(){var a=new THREE.Vector3;return function(b){this.object.updateMatrixWorld(!0),this.normalMatrix.getNormalMatrix(this.object.matrixWorld),b=this.geometry.vertices;for(var c=this.object.geometry.faces,d=this.object.matrixWorld,e=0,f=c.length;f>e;e++){var g=c[e];a.copy(g.normal).applyMatrix3(this.normalMatrix).normalize().multiplyScalar(this.size);var h=2*e;b[h].copy(g.centroid).applyMatrix4(d),b[h+1].addVectors(b[h],a)}return this.geometry.verticesNeedUpdate=!0,this}}(),THREE.GridHelper=function(a,b){var c=new THREE.Geometry,d=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors});this.color1=new THREE.Color(4473924),this.color2=new THREE.Color(8947848);for(var e=-a;a>=e;e+=b){c.vertices.push(new THREE.Vector3(-a,0,e),new THREE.Vector3(a,0,e),new THREE.Vector3(e,0,-a),new THREE.Vector3(e,0,a));var f=0===e?this.color1:this.color2;c.colors.push(f,f,f,f)}THREE.Line.call(this,c,d,THREE.LinePieces)},THREE.GridHelper.prototype=Object.create(THREE.Line.prototype),THREE.GridHelper.prototype.setColors=function(a,b){this.color1.set(a),this.color2.set(b),this.geometry.colorsNeedUpdate=!0},THREE.HemisphereLightHelper=function(a,b){for(THREE.Object3D.call(this),this.light=a,this.light.updateMatrixWorld(),this.matrixWorld=a.matrixWorld,this.matrixAutoUpdate=!1,this.colors=[new THREE.Color,new THREE.Color],a=new THREE.SphereGeometry(b,4,2),a.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2)),b=0;8>b;b++)a.faces[b].color=this.colors[4>b?0:1];b=new THREE.MeshBasicMaterial({vertexColors:THREE.FaceColors,wireframe:!0}),this.lightSphere=new THREE.Mesh(a,b),this.add(this.lightSphere),this.update()},THREE.HemisphereLightHelper.prototype=Object.create(THREE.Object3D.prototype),THREE.HemisphereLightHelper.prototype.dispose=function(){this.lightSphere.geometry.dispose(),this.lightSphere.material.dispose()},THREE.HemisphereLightHelper.prototype.update=function(){var a=new THREE.Vector3;return function(){this.colors[0].copy(this.light.color).multiplyScalar(this.light.intensity),this.colors[1].copy(this.light.groundColor).multiplyScalar(this.light.intensity),this.lightSphere.lookAt(a.setFromMatrixPosition(this.light.matrixWorld).negate()),this.lightSphere.geometry.colorsNeedUpdate=!0}}(),THREE.PointLightHelper=function(a,b){this.light=a,this.light.updateMatrixWorld();var c=new THREE.SphereGeometry(b,4,2),d=new THREE.MeshBasicMaterial({wireframe:!0,fog:!1});d.color.copy(this.light.color).multiplyScalar(this.light.intensity),THREE.Mesh.call(this,c,d),this.matrixWorld=this.light.matrixWorld,this.matrixAutoUpdate=!1},THREE.PointLightHelper.prototype=Object.create(THREE.Mesh.prototype),THREE.PointLightHelper.prototype.dispose=function(){this.geometry.dispose(),this.material.dispose()},THREE.PointLightHelper.prototype.update=function(){this.material.color.copy(this.light.color).multiplyScalar(this.light.intensity)},THREE.SpotLightHelper=function(a){THREE.Object3D.call(this),this.light=a,this.light.updateMatrixWorld(),this.matrixWorld=a.matrixWorld,this.matrixAutoUpdate=!1,a=new THREE.CylinderGeometry(0,1,1,8,1,!0),a.applyMatrix((new THREE.Matrix4).makeTranslation(0,-.5,0)),a.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2));var b=new THREE.MeshBasicMaterial({wireframe:!0,fog:!1});this.cone=new THREE.Mesh(a,b),this.add(this.cone),this.update()},THREE.SpotLightHelper.prototype=Object.create(THREE.Object3D.prototype),THREE.SpotLightHelper.prototype.dispose=function(){this.cone.geometry.dispose(),this.cone.material.dispose()},THREE.SpotLightHelper.prototype.update=function(){var a=new THREE.Vector3,b=new THREE.Vector3;return function(){var c=this.light.distance?this.light.distance:1e4,d=c*Math.tan(this.light.angle);this.cone.scale.set(d,d,c),a.setFromMatrixPosition(this.light.matrixWorld),b.setFromMatrixPosition(this.light.target.matrixWorld),this.cone.lookAt(b.sub(a)),this.cone.material.color.copy(this.light.color).multiplyScalar(this.light.intensity)}}(),THREE.VertexNormalsHelper=function(a,b,c,d){this.object=a,this.size=void 0!==b?b:1,b=void 0!==c?c:16711680,d=void 0!==d?d:1,c=new THREE.Geometry,a=a.geometry.faces;for(var e=0,f=a.length;f>e;e++)for(var g=0,h=a[e].vertexNormals.length;h>g;g++)c.vertices.push(new THREE.Vector3),c.vertices.push(new THREE.Vector3);THREE.Line.call(this,c,new THREE.LineBasicMaterial({color:b,linewidth:d}),THREE.LinePieces),this.matrixAutoUpdate=!1,this.normalMatrix=new THREE.Matrix3,this.update()},THREE.VertexNormalsHelper.prototype=Object.create(THREE.Line.prototype),THREE.VertexNormalsHelper.prototype.update=function(){var a=new THREE.Vector3;return function(b){b=["a","b","c","d"],this.object.updateMatrixWorld(!0),this.normalMatrix.getNormalMatrix(this.object.matrixWorld);for(var c=this.geometry.vertices,d=this.object.geometry.vertices,e=this.object.geometry.faces,f=this.object.matrixWorld,g=0,h=0,i=e.length;i>h;h++)for(var j=e[h],k=0,l=j.vertexNormals.length;l>k;k++){var m=j.vertexNormals[k];c[g].copy(d[j[b[k]]]).applyMatrix4(f),a.copy(m).applyMatrix3(this.normalMatrix).normalize().multiplyScalar(this.size),a.add(c[g]),g+=1,c[g].copy(a),g+=1}return this.geometry.verticesNeedUpdate=!0,this}}(),THREE.VertexTangentsHelper=function(a,b,c,d){this.object=a,this.size=void 0!==b?b:1,b=void 0!==c?c:255,d=void 0!==d?d:1,c=new THREE.Geometry,a=a.geometry.faces;for(var e=0,f=a.length;f>e;e++)for(var g=0,h=a[e].vertexTangents.length;h>g;g++)c.vertices.push(new THREE.Vector3),c.vertices.push(new THREE.Vector3);THREE.Line.call(this,c,new THREE.LineBasicMaterial({color:b,linewidth:d}),THREE.LinePieces),this.matrixAutoUpdate=!1,this.update()},THREE.VertexTangentsHelper.prototype=Object.create(THREE.Line.prototype),THREE.VertexTangentsHelper.prototype.update=function(){var a=new THREE.Vector3;return function(b){b=["a","b","c","d"],this.object.updateMatrixWorld(!0);for(var c=this.geometry.vertices,d=this.object.geometry.vertices,e=this.object.geometry.faces,f=this.object.matrixWorld,g=0,h=0,i=e.length;i>h;h++)for(var j=e[h],k=0,l=j.vertexTangents.length;l>k;k++){var m=j.vertexTangents[k];c[g].copy(d[j[b[k]]]).applyMatrix4(f),a.copy(m).transformDirection(f).multiplyScalar(this.size),a.add(c[g]),g+=1,c[g].copy(a),g+=1}return this.geometry.verticesNeedUpdate=!0,this}}(),THREE.WireframeHelper=function(a,b){var c=void 0!==b?b:16777215,d=[0,0],e={},f=function(a,b){return a-b},g=["a","b","c"],h=new THREE.BufferGeometry;if(a.geometry instanceof THREE.Geometry){for(var i=a.geometry.vertices,j=a.geometry.faces,k=0,l=new Uint32Array(6*j.length),m=0,n=j.length;n>m;m++)for(var o=j[m],p=0;3>p;p++){d[0]=o[g[p]],d[1]=o[g[(p+1)%3]],d.sort(f);var q=d.toString();void 0===e[q]&&(l[2*k]=d[0],l[2*k+1]=d[1],e[q]=!0,k++)}for(h.addAttribute("position",Float32Array,2*k,3),d=h.attributes.position.array,m=0,n=k;n>m;m++)for(p=0;2>p;p++)k=i[l[2*m+p]],g=6*m+3*p,d[g+0]=k.x,d[g+1]=k.y,d[g+2]=k.z}else if(a.geometry instanceof THREE.BufferGeometry&&void 0!==a.geometry.attributes.index){for(var i=a.geometry.attributes.position.array,n=a.geometry.attributes.index.array,j=a.geometry.offsets,k=0,l=new Uint32Array(2*n.length),o=0,r=j.length;r>o;++o)for(var p=j[o].start,q=j[o].count,g=j[o].index,m=p,s=p+q;s>m;m+=3)for(p=0;3>p;p++)d[0]=g+n[m+p],d[1]=g+n[m+(p+1)%3],d.sort(f),q=d.toString(),void 0===e[q]&&(l[2*k]=d[0],l[2*k+1]=d[1],e[q]=!0,k++);for(h.addAttribute("position",Float32Array,2*k,3),d=h.attributes.position.array,m=0,n=k;n>m;m++)for(p=0;2>p;p++)g=6*m+3*p,k=3*l[2*m+p],d[g+0]=i[k],d[g+1]=i[k+1],d[g+2]=i[k+2]}else if(a.geometry instanceof THREE.BufferGeometry)for(i=a.geometry.attributes.position.array,k=i.length/3,l=k/3,h.addAttribute("position",Float32Array,2*k,3),d=h.attributes.position.array,m=0,n=l;n>m;m++)for(p=0;3>p;p++)g=18*m+6*p,l=9*m+3*p,d[g+0]=i[l],d[g+1]=i[l+1],d[g+2]=i[l+2],k=9*m+(p+1)%3*3,d[g+3]=i[k],d[g+4]=i[k+1],d[g+5]=i[k+2];THREE.Line.call(this,h,new THREE.LineBasicMaterial({color:c}),THREE.LinePieces),this.matrixAutoUpdate=!1,this.matrixWorld=a.matrixWorld},THREE.WireframeHelper.prototype=Object.create(THREE.Line.prototype),THREE.ImmediateRenderObject=function(){THREE.Object3D.call(this),this.render=function(){}},THREE.ImmediateRenderObject.prototype=Object.create(THREE.Object3D.prototype),THREE.LensFlare=function(a,b,c,d,e){THREE.Object3D.call(this),this.lensFlares=[],this.positionScreen=new THREE.Vector3,this.customUpdateCallback=void 0,void 0!==a&&this.add(a,b,c,d,e)},THREE.LensFlare.prototype=Object.create(THREE.Object3D.prototype),THREE.LensFlare.prototype.add=function(a,b,c,d,e,f){void 0===b&&(b=-1),void 0===c&&(c=0),void 0===f&&(f=1),void 0===e&&(e=new THREE.Color(16777215)),void 0===d&&(d=THREE.NormalBlending),c=Math.min(c,Math.max(0,c)),this.lensFlares.push({texture:a,size:b,distance:c,x:0,y:0,z:0,scale:1,rotation:1,opacity:f,color:e,blending:d})},THREE.LensFlare.prototype.updateLensFlares=function(){var a,b,c=this.lensFlares.length,d=2*-this.positionScreen.x,e=2*-this.positionScreen.y;for(a=0;c>a;a++)b=this.lensFlares[a],b.x=this.positionScreen.x+d*b.distance,b.y=this.positionScreen.y+e*b.distance,b.wantedRotation=b.x*Math.PI*.25,b.rotation+=.25*(b.wantedRotation-b.rotation)},THREE.MorphBlendMesh=function(a,b){THREE.Mesh.call(this,a,b),this.animationsMap={},this.animationsList=[];var c=this.geometry.morphTargets.length;this.createAnimation("__default",0,c-1,c/1),this.setAnimationWeight("__default",1)},THREE.MorphBlendMesh.prototype=Object.create(THREE.Mesh.prototype),THREE.MorphBlendMesh.prototype.createAnimation=function(a,b,c,d){b={startFrame:b,endFrame:c,length:c-b+1,fps:d,duration:(c-b)/d,lastFrame:0,currentFrame:0,active:!1,time:0,direction:1,weight:1,directionBackwards:!1,mirroredLoop:!1},this.animationsMap[a]=b,this.animationsList.push(b)},THREE.MorphBlendMesh.prototype.autoCreateAnimations=function(a){for(var b,c=/([a-z]+)(\d+)/,d={},e=this.geometry,f=0,g=e.morphTargets.length;g>f;f++){var h=e.morphTargets[f].name.match(c);if(h&&1<h.length){var i=h[1];d[i]||(d[i]={start:1/0,end:-1/0}),h=d[i],f<h.start&&(h.start=f),f>h.end&&(h.end=f),b||(b=i)}}for(i in d)h=d[i],this.createAnimation(i,h.start,h.end,a);this.firstAnimation=b},THREE.MorphBlendMesh.prototype.setAnimationDirectionForward=function(a){(a=this.animationsMap[a])&&(a.direction=1,a.directionBackwards=!1)},THREE.MorphBlendMesh.prototype.setAnimationDirectionBackward=function(a){(a=this.animationsMap[a])&&(a.direction=-1,a.directionBackwards=!0)},THREE.MorphBlendMesh.prototype.setAnimationFPS=function(a,b){var c=this.animationsMap[a];c&&(c.fps=b,c.duration=(c.end-c.start)/c.fps)},THREE.MorphBlendMesh.prototype.setAnimationDuration=function(a,b){var c=this.animationsMap[a];c&&(c.duration=b,c.fps=(c.end-c.start)/c.duration)},THREE.MorphBlendMesh.prototype.setAnimationWeight=function(a,b){var c=this.animationsMap[a];c&&(c.weight=b)},THREE.MorphBlendMesh.prototype.setAnimationTime=function(a,b){var c=this.animationsMap[a];c&&(c.time=b)},THREE.MorphBlendMesh.prototype.getAnimationTime=function(a){var b=0;return(a=this.animationsMap[a])&&(b=a.time),b},THREE.MorphBlendMesh.prototype.getAnimationDuration=function(a){var b=-1;return(a=this.animationsMap[a])&&(b=a.duration),b},THREE.MorphBlendMesh.prototype.playAnimation=function(a){var b=this.animationsMap[a];b?(b.time=0,b.active=!0):console.warn("animation["+a+"] undefined")},THREE.MorphBlendMesh.prototype.stopAnimation=function(a){(a=this.animationsMap[a])&&(a.active=!1)},THREE.MorphBlendMesh.prototype.update=function(a){for(var b=0,c=this.animationsList.length;c>b;b++){var d=this.animationsList[b];if(d.active){var e=d.duration/d.length;d.time+=d.direction*a,d.mirroredLoop?(d.time>d.duration||0>d.time)&&(d.direction*=-1,d.time>d.duration&&(d.time=d.duration,d.directionBackwards=!0),0>d.time&&(d.time=0,d.directionBackwards=!1)):(d.time%=d.duration,0>d.time&&(d.time+=d.duration));var f=d.startFrame+THREE.Math.clamp(Math.floor(d.time/e),0,d.length-1),g=d.weight;f!==d.currentFrame&&(this.morphTargetInfluences[d.lastFrame]=0,this.morphTargetInfluences[d.currentFrame]=1*g,this.morphTargetInfluences[f]=0,d.lastFrame=d.currentFrame,d.currentFrame=f),e=d.time%e/e,d.directionBackwards&&(e=1-e),this.morphTargetInfluences[d.currentFrame]=e*g,this.morphTargetInfluences[d.lastFrame]=(1-e)*g}}},THREE.LensFlarePlugin=function(){function a(a,c){var d=b.createProgram(),e=b.createShader(b.FRAGMENT_SHADER),f=b.createShader(b.VERTEX_SHADER),g="precision "+c+" float;\n";return b.shaderSource(e,g+a.fragmentShader),b.shaderSource(f,g+a.vertexShader),b.compileShader(e),b.compileShader(f),b.attachShader(d,e),b.attachShader(d,f),b.linkProgram(d),d}var b,c,d,e,f,g,h,i,j,k,l,m,n;this.init=function(o){b=o.context,c=o,d=o.getPrecision(),e=new Float32Array(16),f=new Uint16Array(6),o=0,e[o++]=-1,e[o++]=-1,e[o++]=0,e[o++]=0,e[o++]=1,e[o++]=-1,e[o++]=1,e[o++]=0,e[o++]=1,e[o++]=1,e[o++]=1,e[o++]=1,e[o++]=-1,e[o++]=1,e[o++]=0,e[o++]=1,o=0,f[o++]=0,f[o++]=1,f[o++]=2,f[o++]=0,f[o++]=2,f[o++]=3,g=b.createBuffer(),h=b.createBuffer(),b.bindBuffer(b.ARRAY_BUFFER,g),b.bufferData(b.ARRAY_BUFFER,e,b.STATIC_DRAW),b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,h),b.bufferData(b.ELEMENT_ARRAY_BUFFER,f,b.STATIC_DRAW),i=b.createTexture(),j=b.createTexture(),b.bindTexture(b.TEXTURE_2D,i),b.texImage2D(b.TEXTURE_2D,0,b.RGB,16,16,0,b.RGB,b.UNSIGNED_BYTE,null),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST),b.bindTexture(b.TEXTURE_2D,j),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,16,16,0,b.RGBA,b.UNSIGNED_BYTE,null),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.NEAREST),b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.NEAREST),0>=b.getParameter(b.MAX_VERTEX_TEXTURE_IMAGE_UNITS)?(k=!1,l=a(THREE.ShaderFlares.lensFlare,d)):(k=!0,l=a(THREE.ShaderFlares.lensFlareVertexTexture,d)),m={},n={},m.vertex=b.getAttribLocation(l,"position"),m.uv=b.getAttribLocation(l,"uv"),n.renderType=b.getUniformLocation(l,"renderType"),n.map=b.getUniformLocation(l,"map"),n.occlusionMap=b.getUniformLocation(l,"occlusionMap"),n.opacity=b.getUniformLocation(l,"opacity"),n.color=b.getUniformLocation(l,"color"),n.scale=b.getUniformLocation(l,"scale"),n.rotation=b.getUniformLocation(l,"rotation"),n.screenPosition=b.getUniformLocation(l,"screenPosition")
},this.render=function(a,d,e,f){a=a.__webglFlares;var o=a.length;if(o){var p=new THREE.Vector3,q=f/e,r=.5*e,s=.5*f,t=16/f,u=new THREE.Vector2(t*q,t),v=new THREE.Vector3(1,1,0),w=new THREE.Vector2(1,1),x=n,t=m;b.useProgram(l),b.enableVertexAttribArray(m.vertex),b.enableVertexAttribArray(m.uv),b.uniform1i(x.occlusionMap,0),b.uniform1i(x.map,1),b.bindBuffer(b.ARRAY_BUFFER,g),b.vertexAttribPointer(t.vertex,2,b.FLOAT,!1,16,0),b.vertexAttribPointer(t.uv,2,b.FLOAT,!1,16,8),b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,h),b.disable(b.CULL_FACE),b.depthMask(!1);var y,z,A,B,C;for(y=0;o>y;y++)if(t=16/f,u.set(t*q,t),B=a[y],p.set(B.matrixWorld.elements[12],B.matrixWorld.elements[13],B.matrixWorld.elements[14]),p.applyMatrix4(d.matrixWorldInverse),p.applyProjection(d.projectionMatrix),v.copy(p),w.x=v.x*r+r,w.y=v.y*s+s,k||0<w.x&&w.x<e&&0<w.y&&w.y<f)for(b.activeTexture(b.TEXTURE1),b.bindTexture(b.TEXTURE_2D,i),b.copyTexImage2D(b.TEXTURE_2D,0,b.RGB,w.x-8,w.y-8,16,16,0),b.uniform1i(x.renderType,0),b.uniform2f(x.scale,u.x,u.y),b.uniform3f(x.screenPosition,v.x,v.y,v.z),b.disable(b.BLEND),b.enable(b.DEPTH_TEST),b.drawElements(b.TRIANGLES,6,b.UNSIGNED_SHORT,0),b.activeTexture(b.TEXTURE0),b.bindTexture(b.TEXTURE_2D,j),b.copyTexImage2D(b.TEXTURE_2D,0,b.RGBA,w.x-8,w.y-8,16,16,0),b.uniform1i(x.renderType,1),b.disable(b.DEPTH_TEST),b.activeTexture(b.TEXTURE1),b.bindTexture(b.TEXTURE_2D,i),b.drawElements(b.TRIANGLES,6,b.UNSIGNED_SHORT,0),B.positionScreen.copy(v),B.customUpdateCallback?B.customUpdateCallback(B):B.updateLensFlares(),b.uniform1i(x.renderType,2),b.enable(b.BLEND),z=0,A=B.lensFlares.length;A>z;z++)C=B.lensFlares[z],.001<C.opacity&&.001<C.scale&&(v.x=C.x,v.y=C.y,v.z=C.z,t=C.size*C.scale/f,u.x=t*q,u.y=t,b.uniform3f(x.screenPosition,v.x,v.y,v.z),b.uniform2f(x.scale,u.x,u.y),b.uniform1f(x.rotation,C.rotation),b.uniform1f(x.opacity,C.opacity),b.uniform3f(x.color,C.color.r,C.color.g,C.color.b),c.setBlending(C.blending,C.blendEquation,C.blendSrc,C.blendDst),c.setTexture(C.texture,1),b.drawElements(b.TRIANGLES,6,b.UNSIGNED_SHORT,0));b.enable(b.CULL_FACE),b.enable(b.DEPTH_TEST),b.depthMask(!0)}}},THREE.ShadowMapPlugin=function(){var a,b,c,d,e,f,g=new THREE.Frustum,h=new THREE.Matrix4,i=new THREE.Vector3,j=new THREE.Vector3,k=new THREE.Vector3;this.init=function(g){a=g.context,b=g,g=THREE.ShaderLib.depthRGBA;var h=THREE.UniformsUtils.clone(g.uniforms);c=new THREE.ShaderMaterial({fragmentShader:g.fragmentShader,vertexShader:g.vertexShader,uniforms:h}),d=new THREE.ShaderMaterial({fragmentShader:g.fragmentShader,vertexShader:g.vertexShader,uniforms:h,morphTargets:!0}),e=new THREE.ShaderMaterial({fragmentShader:g.fragmentShader,vertexShader:g.vertexShader,uniforms:h,skinning:!0}),f=new THREE.ShaderMaterial({fragmentShader:g.fragmentShader,vertexShader:g.vertexShader,uniforms:h,morphTargets:!0,skinning:!0}),c._shadowPass=!0,d._shadowPass=!0,e._shadowPass=!0,f._shadowPass=!0},this.render=function(a,c){b.shadowMapEnabled&&b.shadowMapAutoUpdate&&this.update(a,c)},this.update=function(l,m){var n,o,p,q,r,s,t,u,v,w=[];for(q=0,a.clearColor(1,1,1,1),a.disable(a.BLEND),a.enable(a.CULL_FACE),a.frontFace(a.CCW),a.cullFace(b.shadowMapCullFace===THREE.CullFaceFront?a.FRONT:a.BACK),b.setDepthTest(!0),n=0,o=l.__lights.length;o>n;n++)if(p=l.__lights[n],p.castShadow)if(p instanceof THREE.DirectionalLight&&p.shadowCascade)for(r=0;r<p.shadowCascadeCount;r++){var x;if(p.shadowCascadeArray[r])x=p.shadowCascadeArray[r];else{v=p,t=r,x=new THREE.DirectionalLight,x.isVirtual=!0,x.onlyShadow=!0,x.castShadow=!0,x.shadowCameraNear=v.shadowCameraNear,x.shadowCameraFar=v.shadowCameraFar,x.shadowCameraLeft=v.shadowCameraLeft,x.shadowCameraRight=v.shadowCameraRight,x.shadowCameraBottom=v.shadowCameraBottom,x.shadowCameraTop=v.shadowCameraTop,x.shadowCameraVisible=v.shadowCameraVisible,x.shadowDarkness=v.shadowDarkness,x.shadowBias=v.shadowCascadeBias[t],x.shadowMapWidth=v.shadowCascadeWidth[t],x.shadowMapHeight=v.shadowCascadeHeight[t],x.pointsWorld=[],x.pointsFrustum=[],u=x.pointsWorld,s=x.pointsFrustum;for(var y=0;8>y;y++)u[y]=new THREE.Vector3,s[y]=new THREE.Vector3;u=v.shadowCascadeNearZ[t],v=v.shadowCascadeFarZ[t],s[0].set(-1,-1,u),s[1].set(1,-1,u),s[2].set(-1,1,u),s[3].set(1,1,u),s[4].set(-1,-1,v),s[5].set(1,-1,v),s[6].set(-1,1,v),s[7].set(1,1,v),x.originalCamera=m,s=new THREE.Gyroscope,s.position=p.shadowCascadeOffset,s.add(x),s.add(x.target),m.add(s),p.shadowCascadeArray[r]=x,console.log("Created virtualLight",x)}t=p,u=r,v=t.shadowCascadeArray[u],v.position.copy(t.position),v.target.position.copy(t.target.position),v.lookAt(v.target),v.shadowCameraVisible=t.shadowCameraVisible,v.shadowDarkness=t.shadowDarkness,v.shadowBias=t.shadowCascadeBias[u],s=t.shadowCascadeNearZ[u],t=t.shadowCascadeFarZ[u],v=v.pointsFrustum,v[0].z=s,v[1].z=s,v[2].z=s,v[3].z=s,v[4].z=t,v[5].z=t,v[6].z=t,v[7].z=t,w[q]=x,q++}else w[q]=p,q++;for(n=0,o=w.length;o>n;n++){if(p=w[n],p.shadowMap||(r=THREE.LinearFilter,b.shadowMapType===THREE.PCFSoftShadowMap&&(r=THREE.NearestFilter),p.shadowMap=new THREE.WebGLRenderTarget(p.shadowMapWidth,p.shadowMapHeight,{minFilter:r,magFilter:r,format:THREE.RGBAFormat}),p.shadowMapSize=new THREE.Vector2(p.shadowMapWidth,p.shadowMapHeight),p.shadowMatrix=new THREE.Matrix4),!p.shadowCamera){if(p instanceof THREE.SpotLight)p.shadowCamera=new THREE.PerspectiveCamera(p.shadowCameraFov,p.shadowMapWidth/p.shadowMapHeight,p.shadowCameraNear,p.shadowCameraFar);else{if(!(p instanceof THREE.DirectionalLight)){console.error("Unsupported light type for shadow");continue}p.shadowCamera=new THREE.OrthographicCamera(p.shadowCameraLeft,p.shadowCameraRight,p.shadowCameraTop,p.shadowCameraBottom,p.shadowCameraNear,p.shadowCameraFar)}l.add(p.shadowCamera),!0===l.autoUpdate&&l.updateMatrixWorld()}if(p.shadowCameraVisible&&!p.cameraHelper&&(p.cameraHelper=new THREE.CameraHelper(p.shadowCamera),p.shadowCamera.add(p.cameraHelper)),p.isVirtual&&x.originalCamera==m){for(r=m,q=p.shadowCamera,s=p.pointsFrustum,v=p.pointsWorld,i.set(1/0,1/0,1/0),j.set(-1/0,-1/0,-1/0),t=0;8>t;t++)u=v[t],u.copy(s[t]),THREE.ShadowMapPlugin.__projector.unprojectVector(u,r),u.applyMatrix4(q.matrixWorldInverse),u.x<i.x&&(i.x=u.x),u.x>j.x&&(j.x=u.x),u.y<i.y&&(i.y=u.y),u.y>j.y&&(j.y=u.y),u.z<i.z&&(i.z=u.z),u.z>j.z&&(j.z=u.z);q.left=i.x,q.right=j.x,q.top=j.y,q.bottom=i.y,q.updateProjectionMatrix()}for(q=p.shadowMap,s=p.shadowMatrix,r=p.shadowCamera,r.position.setFromMatrixPosition(p.matrixWorld),k.setFromMatrixPosition(p.target.matrixWorld),r.lookAt(k),r.updateMatrixWorld(),r.matrixWorldInverse.getInverse(r.matrixWorld),p.cameraHelper&&(p.cameraHelper.visible=p.shadowCameraVisible),p.shadowCameraVisible&&p.cameraHelper.update(),s.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),s.multiply(r.projectionMatrix),s.multiply(r.matrixWorldInverse),h.multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse),g.setFromMatrix(h),b.setRenderTarget(q),b.clear(),v=l.__webglObjects,p=0,q=v.length;q>p;p++)t=v[p],s=t.object,t.render=!1,!s.visible||!s.castShadow||(s instanceof THREE.Mesh||s instanceof THREE.ParticleSystem)&&s.frustumCulled&&!g.intersectsObject(s)||(s._modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,s.matrixWorld),t.render=!0);for(p=0,q=v.length;q>p;p++)t=v[p],t.render&&(s=t.object,t=t.buffer,y=s.material instanceof THREE.MeshFaceMaterial?s.material.materials[0]:s.material,u=void 0!==s.geometry.morphTargets&&0<s.geometry.morphTargets.length&&y.morphTargets,y=s instanceof THREE.SkinnedMesh&&y.skinning,u=s.customDepthMaterial?s.customDepthMaterial:y?u?f:e:u?d:c,t instanceof THREE.BufferGeometry?b.renderBufferDirect(r,l.__lights,null,u,t,s):b.renderBuffer(r,l.__lights,null,u,t,s));for(v=l.__webglObjectsImmediate,p=0,q=v.length;q>p;p++)t=v[p],s=t.object,s.visible&&s.castShadow&&(s._modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,s.matrixWorld),b.renderImmediateObject(r,l.__lights,null,c,s))}n=b.getClearColor(),o=b.getClearAlpha(),a.clearColor(n.r,n.g,n.b,o),a.enable(a.BLEND),b.shadowMapCullFace===THREE.CullFaceFront&&a.cullFace(a.BACK)}},THREE.ShadowMapPlugin.__projector=new THREE.Projector,THREE.SpritePlugin=function(){function a(a,b){return a.z!==b.z?b.z-a.z:b.id-a.id}var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z;this.init=function(a){s=a.context,t=a,v=new Float32Array([-.5,-.5,0,0,.5,-.5,1,0,.5,.5,1,1,-.5,.5,0,1]),w=new Uint16Array([0,1,2,0,2,3]),x=s.createBuffer(),y=s.createBuffer(),s.bindBuffer(s.ARRAY_BUFFER,x),s.bufferData(s.ARRAY_BUFFER,v,s.STATIC_DRAW),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,y),s.bufferData(s.ELEMENT_ARRAY_BUFFER,w,s.STATIC_DRAW),a=s.createProgram();var A=s.createShader(s.VERTEX_SHADER),B=s.createShader(s.FRAGMENT_SHADER);s.shaderSource(A,["precision "+t.getPrecision()+" float;","uniform mat4 modelViewMatrix;\nuniform mat4 projectionMatrix;\nuniform float rotation;\nuniform vec2 scale;\nuniform vec2 uvOffset;\nuniform vec2 uvScale;\nattribute vec2 position;\nattribute vec2 uv;\nvarying vec2 vUV;\nvoid main() {\nvUV = uvOffset + uv * uvScale;\nvec2 alignedPosition = position * scale;\nvec2 rotatedPosition;\nrotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\nrotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\nvec4 finalPosition;\nfinalPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );\nfinalPosition.xy += rotatedPosition;\nfinalPosition = projectionMatrix * finalPosition;\ngl_Position = finalPosition;\n}"].join("\n")),s.shaderSource(B,["precision "+t.getPrecision()+" float;","uniform vec3 color;\nuniform sampler2D map;\nuniform float opacity;\nuniform int fogType;\nuniform vec3 fogColor;\nuniform float fogDensity;\nuniform float fogNear;\nuniform float fogFar;\nuniform float alphaTest;\nvarying vec2 vUV;\nvoid main() {\nvec4 texture = texture2D( map, vUV );\nif ( texture.a < alphaTest ) discard;\ngl_FragColor = vec4( color * texture.xyz, texture.a * opacity );\nif ( fogType > 0 ) {\nfloat depth = gl_FragCoord.z / gl_FragCoord.w;\nfloat fogFactor = 0.0;\nif ( fogType == 1 ) {\nfogFactor = smoothstep( fogNear, fogFar, depth );\n} else {\nconst float LOG2 = 1.442695;\nfloat fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );\nfogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );\n}\ngl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );\n}\n}"].join("\n")),s.compileShader(A),s.compileShader(B),s.attachShader(a,A),s.attachShader(a,B),s.linkProgram(a),z=a,q=s.getAttribLocation(z,"position"),r=s.getAttribLocation(z,"uv"),b=s.getUniformLocation(z,"uvOffset"),c=s.getUniformLocation(z,"uvScale"),d=s.getUniformLocation(z,"rotation"),e=s.getUniformLocation(z,"scale"),f=s.getUniformLocation(z,"color"),g=s.getUniformLocation(z,"map"),h=s.getUniformLocation(z,"opacity"),i=s.getUniformLocation(z,"modelViewMatrix"),j=s.getUniformLocation(z,"projectionMatrix"),k=s.getUniformLocation(z,"fogType"),l=s.getUniformLocation(z,"fogDensity"),m=s.getUniformLocation(z,"fogNear"),n=s.getUniformLocation(z,"fogFar"),o=s.getUniformLocation(z,"fogColor"),p=s.getUniformLocation(z,"alphaTest"),a=document.createElement("canvas"),a.width=8,a.height=8,A=a.getContext("2d"),A.fillStyle="#ffffff",A.fillRect(0,0,a.width,a.height),u=new THREE.Texture(a),u.needsUpdate=!0},this.render=function(v,w,A,B){if(A=v.__webglSprites,B=A.length){s.useProgram(z),s.enableVertexAttribArray(q),s.enableVertexAttribArray(r),s.disable(s.CULL_FACE),s.enable(s.BLEND),s.bindBuffer(s.ARRAY_BUFFER,x),s.vertexAttribPointer(q,2,s.FLOAT,!1,16,0),s.vertexAttribPointer(r,2,s.FLOAT,!1,16,8),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,y),s.uniformMatrix4fv(j,!1,w.projectionMatrix.elements),s.activeTexture(s.TEXTURE0),s.uniform1i(g,0);var C=0,D=0,E=v.fog;E?(s.uniform3f(o,E.color.r,E.color.g,E.color.b),E instanceof THREE.Fog?(s.uniform1f(m,E.near),s.uniform1f(n,E.far),s.uniform1i(k,1),D=C=1):E instanceof THREE.FogExp2&&(s.uniform1f(l,E.density),s.uniform1i(k,2),D=C=2)):(s.uniform1i(k,0),D=C=0);for(var F,G=[],E=0;B>E;E++)F=A[E],!1!==F.visible&&(F._modelViewMatrix.multiplyMatrices(w.matrixWorldInverse,F.matrixWorld),F.z=-F._modelViewMatrix.elements[14]);for(A.sort(a),E=0;B>E;E++)F=A[E],!1!==F.visible&&(w=F.material,s.uniform1f(p,w.alphaTest),s.uniformMatrix4fv(i,!1,F._modelViewMatrix.elements),G[0]=F.scale.x,G[1]=F.scale.y,F=v.fog&&w.fog?D:0,C!==F&&(s.uniform1i(k,F),C=F),null!==w.map?(s.uniform2f(b,w.map.offset.x,w.map.offset.y),s.uniform2f(c,w.map.repeat.x,w.map.repeat.y)):(s.uniform2f(b,0,0),s.uniform2f(c,1,1)),s.uniform1f(h,w.opacity),s.uniform3f(f,w.color.r,w.color.g,w.color.b),s.uniform1f(d,w.rotation),s.uniform2fv(e,G),t.setBlending(w.blending,w.blendEquation,w.blendSrc,w.blendDst),t.setDepthTest(w.depthTest),t.setDepthWrite(w.depthWrite),w.map&&w.map.image&&w.map.image.width?t.setTexture(w.map,0):t.setTexture(u,0),s.drawElements(s.TRIANGLES,6,s.UNSIGNED_SHORT,0));s.enable(s.CULL_FACE)}}},THREE.DepthPassPlugin=function(){this.enabled=!1,this.renderTarget=null;var a,b,c,d,e,f,g=new THREE.Frustum,h=new THREE.Matrix4;this.init=function(g){a=g.context,b=g,g=THREE.ShaderLib.depthRGBA;var h=THREE.UniformsUtils.clone(g.uniforms);c=new THREE.ShaderMaterial({fragmentShader:g.fragmentShader,vertexShader:g.vertexShader,uniforms:h}),d=new THREE.ShaderMaterial({fragmentShader:g.fragmentShader,vertexShader:g.vertexShader,uniforms:h,morphTargets:!0}),e=new THREE.ShaderMaterial({fragmentShader:g.fragmentShader,vertexShader:g.vertexShader,uniforms:h,skinning:!0}),f=new THREE.ShaderMaterial({fragmentShader:g.fragmentShader,vertexShader:g.vertexShader,uniforms:h,morphTargets:!0,skinning:!0}),c._shadowPass=!0,d._shadowPass=!0,e._shadowPass=!0,f._shadowPass=!0},this.render=function(a,b){this.enabled&&this.update(a,b)},this.update=function(i,j){var k,l,m,n,o,p;for(a.clearColor(1,1,1,1),a.disable(a.BLEND),b.setDepthTest(!0),!0===i.autoUpdate&&i.updateMatrixWorld(),j.matrixWorldInverse.getInverse(j.matrixWorld),h.multiplyMatrices(j.projectionMatrix,j.matrixWorldInverse),g.setFromMatrix(h),b.setRenderTarget(this.renderTarget),b.clear(),p=i.__webglObjects,k=0,l=p.length;l>k;k++)m=p[k],o=m.object,m.render=!1,!o.visible||(o instanceof THREE.Mesh||o instanceof THREE.ParticleSystem)&&o.frustumCulled&&!g.intersectsObject(o)||(o._modelViewMatrix.multiplyMatrices(j.matrixWorldInverse,o.matrixWorld),m.render=!0);var q;for(k=0,l=p.length;l>k;k++)m=p[k],m.render&&(o=m.object,m=m.buffer,o instanceof THREE.ParticleSystem&&!o.customDepthMaterial||((q=o.material instanceof THREE.MeshFaceMaterial?o.material.materials[0]:o.material)&&b.setMaterialFaces(o.material),n=0<o.geometry.morphTargets.length&&q.morphTargets,q=o instanceof THREE.SkinnedMesh&&q.skinning,n=o.customDepthMaterial?o.customDepthMaterial:q?n?f:e:n?d:c,m instanceof THREE.BufferGeometry?b.renderBufferDirect(j,i.__lights,null,n,m,o):b.renderBuffer(j,i.__lights,null,n,m,o)));for(p=i.__webglObjectsImmediate,k=0,l=p.length;l>k;k++)m=p[k],o=m.object,o.visible&&(o._modelViewMatrix.multiplyMatrices(j.matrixWorldInverse,o.matrixWorld),b.renderImmediateObject(j,i.__lights,null,c,o));k=b.getClearColor(),l=b.getClearAlpha(),a.clearColor(k.r,k.g,k.b,l),a.enable(a.BLEND)}},THREE.ShaderFlares={lensFlareVertexTexture:{vertexShader:"uniform lowp int renderType;\nuniform vec3 screenPosition;\nuniform vec2 scale;\nuniform float rotation;\nuniform sampler2D occlusionMap;\nattribute vec2 position;\nattribute vec2 uv;\nvarying vec2 vUV;\nvarying float vVisibility;\nvoid main() {\nvUV = uv;\nvec2 pos = position;\nif( renderType == 2 ) {\nvec4 visibility = texture2D( occlusionMap, vec2( 0.1, 0.1 ) );\nvisibility += texture2D( occlusionMap, vec2( 0.5, 0.1 ) );\nvisibility += texture2D( occlusionMap, vec2( 0.9, 0.1 ) );\nvisibility += texture2D( occlusionMap, vec2( 0.9, 0.5 ) );\nvisibility += texture2D( occlusionMap, vec2( 0.9, 0.9 ) );\nvisibility += texture2D( occlusionMap, vec2( 0.5, 0.9 ) );\nvisibility += texture2D( occlusionMap, vec2( 0.1, 0.9 ) );\nvisibility += texture2D( occlusionMap, vec2( 0.1, 0.5 ) );\nvisibility += texture2D( occlusionMap, vec2( 0.5, 0.5 ) );\nvVisibility =        visibility.r / 9.0;\nvVisibility *= 1.0 - visibility.g / 9.0;\nvVisibility *=       visibility.b / 9.0;\nvVisibility *= 1.0 - visibility.a / 9.0;\npos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;\npos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;\n}\ngl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );\n}",fragmentShader:"uniform lowp int renderType;\nuniform sampler2D map;\nuniform float opacity;\nuniform vec3 color;\nvarying vec2 vUV;\nvarying float vVisibility;\nvoid main() {\nif( renderType == 0 ) {\ngl_FragColor = vec4( 1.0, 0.0, 1.0, 0.0 );\n} else if( renderType == 1 ) {\ngl_FragColor = texture2D( map, vUV );\n} else {\nvec4 texture = texture2D( map, vUV );\ntexture.a *= opacity * vVisibility;\ngl_FragColor = texture;\ngl_FragColor.rgb *= color;\n}\n}"},lensFlare:{vertexShader:"uniform lowp int renderType;\nuniform vec3 screenPosition;\nuniform vec2 scale;\nuniform float rotation;\nattribute vec2 position;\nattribute vec2 uv;\nvarying vec2 vUV;\nvoid main() {\nvUV = uv;\nvec2 pos = position;\nif( renderType == 2 ) {\npos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;\npos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;\n}\ngl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );\n}",fragmentShader:"precision mediump float;\nuniform lowp int renderType;\nuniform sampler2D map;\nuniform sampler2D occlusionMap;\nuniform float opacity;\nuniform vec3 color;\nvarying vec2 vUV;\nvoid main() {\nif( renderType == 0 ) {\ngl_FragColor = vec4( texture2D( map, vUV ).rgb, 0.0 );\n} else if( renderType == 1 ) {\ngl_FragColor = texture2D( map, vUV );\n} else {\nfloat visibility = texture2D( occlusionMap, vec2( 0.5, 0.1 ) ).a;\nvisibility += texture2D( occlusionMap, vec2( 0.9, 0.5 ) ).a;\nvisibility += texture2D( occlusionMap, vec2( 0.5, 0.9 ) ).a;\nvisibility += texture2D( occlusionMap, vec2( 0.1, 0.5 ) ).a;\nvisibility = ( 1.0 - visibility / 4.0 );\nvec4 texture = texture2D( map, vUV );\ntexture.a *= opacity * visibility;\ngl_FragColor = texture;\ngl_FragColor.rgb *= color;\n}\n}"}},define("lib/Three",function(){}),define("core/Math",["core/Monogatari","core/Constants","core/Util","lib/Three"],function(){function a(){this._X_ALIGNED_VECTOR=new THREE.Vector3(1,0,0),this._Y_ALIGNED_VECTOR=new THREE.Vector3(0,1,0),this._Z_ALIGNED_VECTOR=new THREE.Vector3(0,0,1),this._ONE=new THREE.Vector3(1,1,1),this._ZERO=new THREE.Vector3(0,0,0)}Monogatari.Math=new a,a.prototype.getXAlignedVector=function(){return this._X_ALIGNED_VECTOR},a.prototype.getYAlignedVector=function(){return this._Y_ALIGNED_VECTOR},a.prototype.getZAlignedVector=function(){return this._Z_ALIGNED_VECTOR},a.prototype.getVectorOne=function(){return this._ONE},a.prototype.getVectorZero=function(){return this._ZERO},a.prototype.toRadians=function(a){return a*Monogatari.Constants.DEGTORAD},a.prototype.toDegrees=function(a){return a*Monogatari.Constants.RADTODEG},a.prototype.decimalToBinary=function(a){return a.toString(2)},a.prototype.decimalToOctal=function(a){return a.toString(8)},a.prototype.decimalToHex=function(a){return a.toString(16)},a.prototype.binaryToDecimal=function(a){return parseInt(a,2)},a.prototype.octalToDecimal=function(a){return parseInt(a,8)},a.prototype.hexToDecimal=function(a){return parseInt(a,16)}}),define("core/collection/Set",["core/Monogatari","core/collection/Iterator"],function(){Monogatari.Set=Class.extend({init:function(){this._values=new Array},put:function(a){this.contains(a)||this._values.push(a)},clear:function(){this._values.length=0},contains:function(a){return this.indexOf(a)>-1},indexOf:function(a){return Monogatari.Array.indexOf(a,this._values)},size:function(){return this._values.length},concat:function(a){return this._values.concat(a.toArray()),this._values.slice(0)},remove:function(a){if(indexOf)return this._values.splice(this._values.indexOf(a),1);for(var b=0,c=this._values.length;c>b;b++)if(b in this._values&&this._values[b]===a)return this._values.splice(b,1)},isEmpty:function(){return 0===this.size()},toArray:function(){return this._values.slice(0)},toJSON:function(){return JSON.stringify(this._values)},iterator:function(){return new Monogatari.ListIterator(this._values)}})}),define("engine/render/Camera2D",["core/Monogatari","core/collection/Set","lib/Three"],function(){Monogatari.Camera2D=Class.extend({init:function(a,b,c,d,e,f){this.cam=new THREE.OrthographicCamera(a,b,c,d,e,f),this.cam.position.set(0,0,f),this._sceneIds=new Monogatari.Set,this._sceneIterator=this._sceneIds.iterator()},addScene:function(a){a&&"string"==typeof a&&this._sceneIds.put(a)}})});var Detector={canvas:!!window.CanvasRenderingContext2D,webgl:function(){try{var a=document.createElement("canvas");return!!window.WebGLRenderingContext&&(a.getContext("webgl")||a.getContext("experimental-webgl"))}catch(b){return!1}}(),workers:!!window.Worker,fileapi:window.File&&window.FileReader&&window.FileList&&window.Blob,getWebGLErrorMessage:function(){var a=document.createElement("div");return a.id="webgl-error-message",a.style.fontFamily="monospace",a.style.fontSize="13px",a.style.fontWeight="normal",a.style.textAlign="center",a.style.background="#fff",a.style.color="#000",a.style.padding="1.5em",a.style.width="400px",a.style.margin="5em auto 0",this.webgl||(a.innerHTML=window.WebGLRenderingContext?['Your graphics card does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br />','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n"):['Your browser does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">WebGL</a>.<br/>','Find out how to get it <a href="http://get.webgl.org/" style="color:#000">here</a>.'].join("\n")),a},addGetWebGLMessage:function(a){var b,c,d;a=a||{},b=void 0!==a.parent?a.parent:document.body,c=void 0!==a.id?a.id:"oldie",d=Detector.getWebGLErrorMessage(),d.id=c,b.appendChild(d)}};define("lib/Detector",function(){}),define("engine/SceneManager",["core/Monogatari","core/Math","core/collection/Map","engine/render/Camera2D","lib/Detector"],function(){function a(){this._cameras=new Monogatari.Map,this._cameraIterator=this._cameras.iterator(),this._scenes=new Monogatari.Map}Monogatari.SceneManager=new a,a.prototype.init=function(a,b,c,d){this._renderer=Detector.webgl?new THREE.WebGLRenderer({antialias:!1}):new THREE.CanvasRenderer,this._renderer.setClearColor(a?a:16777215,1),this._canvasWidth=b?b:window.innerWidth-25,this._canvasHeight=c?c:window.innerHeight-25,this._canvasHalfWidth=this._canvasWidth/2,this._canvasHalfHeight=this._canvasHeight/2,this._z=Monogatari.max(this._canvasWidth,this._canvasHeight),this._renderer.setSize(this._canvasWidth,this._canvasHeight);var e=d?d:document.getElementsByTagName("body")[0];e.appendChild(this._renderer.domElement)},a.prototype.getScenes=function(){return this._scenes},a.prototype.getScene=function(a){return this._scenes.get(a)},a.prototype.getCamera=function(a){return this._cameras.get(a)},a.prototype.createScene=function(a){this._scenes.put(a?a:Monogatari.Constants.DEFAULT_SCENE_ID,new THREE.Scene)},a.prototype.createCamera=function(a,b,c,d){var e=this._scenes.get(b?b:Monogatari.Constants.DEFAULT_SCENE_ID);if(a||(a=Monogatari.Constants.DEFAULT_CAMERA_ID),c||(c=this._canvasWidth),d||(d=this._canvasHeight),!e)return void console.log("Scene not found:"+b);var f=new Monogatari.Camera2D(c/-2,c/2,d/2,d/-2,1,Monogatari.max(c,d));f.addScene(b?b:Monogatari.Constants.DEFAULT_SCENE_ID),this._cameras.put(a,f)},a.prototype.addSceneToCamera=function(a,b){var c=this._cameras.get(a),d=this._scenes.get(b);d&&c&&c.addScene(b)},a.prototype.update=function(){},a.prototype.render=function(){this._cameraIterator.first();for(var a,b;this._cameraIterator.hasNext();)for(a=this._cameraIterator.next(),a._sceneIterator.first();a._sceneIterator.hasNext();)b=this._scenes.get(a._sceneIterator.next()),b&&this._renderer.render(b,a.cam)}}),define("core/collection/Tree",["core/Monogatari","core/collection/Map"],function(){Monogatari.Tree=Monogatari.Map.extend({init:function(){this._depth=1,this._super(),this._keys.push("trunk"),this._values.trunk=new Monogatari.TreeNode(null,"root",1)},put:function(a,b){var c=a||this.size();return this.contains(c)||this._keys.push(c),this._values[c]=new Monogatari.TreeNode(b,"trunk",this._depth),this._values[c]},isEmpty:function(){return 0==this.size()},getDepth:function(){return this._depth},remove:function(a){if("trunk"!=a&&this.contains(a)){var b=this.get(a),c=this.get(b.parent);"trunk"!=c.id&&this.disconnect(a),"function"==typeof b.value.reset&&b.value.reset();for(var d=0,e=this._keys.length;e>d;d++)this._keys[d]===a&&this._keys.splice(d,1)}},removeFromCache:function(a){if("trunk"!=a&&this.contains(a)){var b=this.get(a),c=this.get(b.parent);"trunk"!=c.id&&this.disconnect(a),this._values[a]=null,delete this._values[a];for(var d=0,e=this._keys.length;e>d;d++)this._keys[d]===a&&this._keys.splice(d,1)}},clear:function(){this._values.length=0,this._values={},this._keys.length=0,this._depth=1},connect:function(a,b){if(this.contains(a)&&this.contains(b)){var c=this.get(a),d=this.get(b);d.parent=a,d.order=c.order+1,c.children.push(b),this._depth<d.order&&(this._depth=d.order)}},disconnect:function(a){var b=this.get(a),c=this.get(b.parent),d=c.children.length>0?Monogatari.Array.inArray(c.children,a):-1;d>-1&&Monogatari.Array.remove(c.children,d),b.parent="trunk",b.order=1},listAncestors:function(a,b){for(var c=new Array,d=this.get(a),e=b||this._depth,f=0;e>f;f++)d.parent&&(c.push(d.parent),d=this.get(d.parent));return c.reverse(),c},listSuccessors:function(a){var b=new Array,c=this.get(a),d=null;if(c)for(var e=0,f=c.children.length;f>e;e++)d=this.get(c.children[e]),d&&(d.children.length>0&&b.concat(this.getSuccessors(c.children[e])),b.push(c.children[e]));return b},hasChildren:function(a){var b=this.get(a);return b&&b.children.length>0?!0:!1},isChildOf:function(a,b){for(var c=this.get(a),d=0;d<this._depth;d++)if(c.parent){if(c.parent==b)return!0;c=this.get(c.parent)}return!1},listChildrenOf:function(a){var b=new Array,c=this.get(a),d=null;if(c)for(var e=0,f=c.children.length;f>e;e++)d=this.get(c.children[e]),d&&b.push(d);return b},listChildrenValuesOf:function(a){var b=new Array,c=this.get(a),d=null;if(c)for(var e=0,f=c.children.length;f>e;e++)d=this.get(c.children[e]),d&&b.push(d.value);return b},isParentOf:function(a,b){var c=!1,d=this.get(a);if(d)for(var e=0,f=d.children.length;f>e;e++){if(b==d.children[e])return!0;c=this.isParentOf(d.children[e],b)}return c},getParentOf:function(a){var b=this.get(a);return b&&this.get(b.parent)?b.parent:null},iterator:function(){return new Monogatari.TreeIterator(this._keys,this._values)},nodeIterator:function(){return new Monogatari.MapIterator(this._keys,this._values)}}),Monogatari.TreeNode=function(a,b,c){this.value=a?a:null,this.parent=b?b:"trunk",this.children=new Array,this.order=c?c:1}}),define("engine/entity/GameObject",["core/Monogatari","core/Constants","core/Timer","core/Util","lib/Three","engine/SceneManager"],function(){Monogatari.GameObject=Class.extend({init:function(a,b){this._components=new Monogatari.Map,this._componentIterator=this._components.iterator(),this.isVisible=!0,this.isActive=!0,this._isRenderable=!1,this._hasPhysics=!1,this.uid=Monogatari.Util.createUniqueId(),this.id=a||this.uid,this.lastUpdate=0,this.update=b&&"function"==typeof b?b:function(){}},postUpdate:function(){this.lastUpdate=Monogatari.Time.getTime(),this.updateComponents()},addComponent:function(a){return this.checkComponent(a),this._components.put(a.componentType,a)},checkComponent:function(a){a.componentType&&a.componentType===Monogatari.Constants.COMPONENT_RIGID_BODY&&(this._hasPhysics=!0),(a.componentType===Monogatari.Constants.COMPONENT_THREE_OBJECT||a.componentType===Monogatari.Constants.COMPONENT_SPRITE||a.componentType===Monogatari.Constants.COMPONENT_PARTICLE_EMITTER||a.componentType===Monogatari.Constants.COMPONENT_STATIC_TEXT)&&(this._isRenderable=!0)},findComponent:function(a){return this._components.get(a)},removeComponent:function(a){this._components.remove(a)},clearComponents:function(){this._isRenderable=!1,this._hasPhysics=!1,this._components.clear()},findComponentByType:function(a){var b;for(this._componentIterator.first();this._componentIterator.hasNext();)if(b=this._componentIterator.next(),b.componentType===a)return b;return null},hasComponent:function(a){return this._components.contains(a)?!0:!1},listComponentsToRender:function(){var a,b=new Array;for(this._componentIterator.first();this._componentIterator.hasNext();)a=this._componentIterator.next(),(a.componentType===Monogatari.Constants.COMPONENT_THREE_OBJECT||a.componentType===Monogatari.Constants.COMPONENT_SPRITE||a.componentType===Monogatari.Constants.COMPONENT_STATIC_TEXT)&&(b[b.length]=a);return b},updateComponents:function(){var a,b=this.findComponent(Monogatari.Constants.COMPONENT_NODE);if(this._hasPhysics){var c=this.findComponentByType(Monogatari.Constants.COMPONENT_RIGID_BODY);b.position.x=c.body.GetPosition().x*c.conversionFactor,b.position.y=c.body.GetPosition().y*c.conversionFactor}for(this._componentIterator.first();this._componentIterator.hasNext();)a=this._componentIterator.next(),this._isRenderable&&"function"==typeof a.getMesh&&a.getMesh()&&(a.getMesh().position=b.position,a.getMesh().rotation.z=b.getEulerRotation(),a.getMesh().scale=b.scale),"function"==typeof a.update&&a.update()},equals:function(a){return a.id===this.id?!0:!1},setPosition:function(a,b,c){this.findComponent(Monogatari.Constants.COMPONENT_NODE).position.set(a,b,c)},setRotation:function(a,b,c){this.findComponent(Monogatari.Constants.COMPONENT_NODE).rotation.set(a,b,c)},setScale:function(a,b,c){this.findComponent(Monogatari.Constants.COMPONENT_NODE).scale.set(a,b,c)},toJSON:function(){}})}),define("engine/entity/component/Component",["core/Monogatari","core/Constants"],function(){Monogatari.Component=Class.extend({init:function(){this.componentType=Monogatari.Constants.COMPONENT_BASE}})}),define("engine/entity/component/Node",["core/Monogatari","core/Constants","core/Math","engine/entity/component/Component","lib/Three"],function(){Monogatari.Node=Monogatari.Component.extend({init:function(a,b,c){this.position=a?a:new THREE.Vector3(0,0,0),this.rotation=b?b:new THREE.Vector3(0,1,0),this.scale=c?c:new THREE.Vector3(1,1,1),this.componentType=Monogatari.Constants.COMPONENT_NODE},negate:function(){this.position.negate(),this.rotation.negate(),this.scale.negate()},getEulerRotation:function(a){var b=a?a:Monogatari.Math.getYAlignedVector(),c=this.rotation.angleTo(b);return this.rotation.y*b.x>this.rotation.x*b.y?-c:c},getEulerRotationToTarget:function(a,b){var c=this.clone(),d=b?b:Monogatari.Math.getYAlignedVector(),e=this.rotation.angleTo(d);return c.position.y=-c.position.y,c.rotation=a.sub(c.position),c.rotation.normalize(),c.rotation.y*d.x>c.rotation.x*d.y?-e:e},clone:function(){return new Monogatari.Node(this.position.clone(),this.rotation.clone(),this.scale.clone())}})}),define("engine/ObjectManager",["core/Monogatari","core/collection/Tree","engine/entity/GameObject","engine/entity/component/Node"],function(){function a(){this._objects=new Monogatari.Tree,this._iterator=this._objects.iterator()}Monogatari.ObjectManager=new a,a.prototype.add=function(a){return this._objects.put(a.id,a).value},a.prototype.create=function(a,b){var c=new Monogatari.GameObject(a,b);return c.addComponent(new Monogatari.Node),this._objects.put(a,c).value},a.prototype.get=function(a){return this._objects.contains(a)?this._objects.get(a).value:null},a.prototype.getObjectIterator=function(){return this._objects.iterator()},a.prototype.size=function(){return this._objects.size()},a.prototype.remove=function(a){return this._objects.remove(a).value},a.prototype.hasChildren=function(a){return this._objects.hasChildren(a)},a.prototype.isChildOf=function(a,b){return this._objects.isChildOf(a,b)
},a.prototype.listChildrenOf=function(a){return this._objects.listChildrenOf(a)},a.prototype.listChildrenValuesOf=function(a){return this._objects.listChildrenValuesOf(a)},a.prototype.isParentOf=function(a,b){return this._objects.isParentOf(a,b)},a.prototype.connect=function(a,b){this._objects.connect(a,b)},a.prototype.disconnect=function(a){this._objects.disconnect(a)},a.prototype.listAncestors=function(a){return this._objects.listAncestors(a)},a.prototype.listSuccessors=function(a){return this._objects.listSuccessors(a)},a.prototype.listIds=function(){return this._objects.getKeys()},a.prototype.toJSON=function(){},a.prototype.listIdsByComponentType=function(a){var b,c=new Array;for(this._iterator.first();this._iterator.hasNext();)b=this._iterator.next(),b&&b.hasComponent(a)&&c.push(b.id);return c},a.prototype.update=function(){var a;for(this._iterator.first();this._iterator.hasNext();)a=this._iterator.next(),a&&a.isActive&&(a.update(),a.postUpdate())},a.prototype.getGlobalPosition=function(a){if(this._objects.contains(a)){if("trunk"===this._objects.get(a).parent)return this._objects.get(a).value.findComponent(Monogatari.Constants.COMPONENT_NODE).position;var b=Monogatari.ObjectManager.getGlobalPosition(this._objects.get(a).parent),c=this._objects.get(a).value.findComponent(Monogatari.Constants.COMPONENT_NODE).position.clone();return c.add(b.getX(),b.getY(),b.getZ()),c}return null},a.prototype.getGlobalRotation=function(a){if(this._objects.contains(a)){if("trunk"===this._objects.get(a).parent)return this._objects.get(a).value.findComponent(Monogatari.Constants.COMPONENT_NODE).rotation;var b=Monogatari.ObjectManager.getGlobalRotation(this._objects.get(a).parent),c=this._objects.get(a).value.findComponent(Monogatari.Constants.COMPONENT_NODE).rotation.clone();return c.add(b.getX(),b.getY(),b.getZ()),c}return null},a.prototype.getGlobalScale=function(a){if(this._objects.contains(a)){if("trunk"===this._objects.get(a).parent)return this._objects.get(a).value.findComponent(Monogatari.Constants.COMPONENT_NODE).scale;var b=Monogatari.ObjectManager.getGlobalScale(this._objects.get(a).parent),c=this._objects.get(a).value.findComponent(Monogatari.Constants.COMPONENT_NODE).scale.clone();return c.add(b.getX(),b.getY(),b.getZ()),c}return null},a.prototype.getGlobalNode=function(a){if(this._objects.contains(a)){if("trunk"===this._objects.get(a).parent)return this._objects.get(a).value.findComponent(Monogatari.Constants.COMPONENT_NODE).scale;var b=Monogatari.ObjectManager.getGlobalNode(this._objects.get(a).parent),c=new Node(this._objects.get(a).value.findComponent(Monogatari.Constants.COMPONENT_NODE).position.clone(),this._objects.get(a).value.findComponent(Monogatari.Constants.COMPONENT_NODE).rotation.clone(),this._objects.get(a).value.findComponent(Monogatari.Constants.COMPONENT_NODE).scale.clone());return c.position.add(b.position.getX(),b.position.getY(),b.position.getZ()),c.rotation.add(b.rotation.getX(),b.rotation.getY(),b.rotation.getZ()),c.scale.add(b.scale.getX(),b.scale.getY(),b.scale.getZ()),c}return null}});var b2BoundValues=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2BoundValues.prototype.__constructor=function(){this.lowerValues=[],this.lowerValues[0]=0,this.lowerValues[1]=0,this.upperValues=[],this.upperValues[0]=0,this.upperValues[1]=0},b2BoundValues.prototype.__varz=function(){},b2BoundValues.prototype.lowerValues=null,b2BoundValues.prototype.upperValues=null;var b2PairManager=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2PairManager.prototype.__constructor=function(){this.m_pairs=[],this.m_pairBuffer=[],this.m_pairBufferCount=this.m_pairCount=0,this.m_freePair=null},b2PairManager.prototype.__varz=function(){},b2PairManager.prototype.AddPair=function(a,b){var c=a.pairs[b];return null!=c?c:(null==this.m_freePair&&(this.m_freePair=new b2Pair,this.m_pairs.push(this.m_freePair)),c=this.m_freePair,this.m_freePair=c.next,c.proxy1=a,c.proxy2=b,c.status=0,c.userData=null,c.next=null,a.pairs[b]=c,b.pairs[a]=c,++this.m_pairCount,c)},b2PairManager.prototype.RemovePair=function(a,b){var c=a.pairs[b];if(null==c)return null;var d=c.userData;return delete a.pairs[b],delete b.pairs[a],c.next=this.m_freePair,c.proxy1=null,c.proxy2=null,c.userData=null,c.status=0,this.m_freePair=c,--this.m_pairCount,d},b2PairManager.prototype.Find=function(a,b){return a.pairs[b]},b2PairManager.prototype.ValidateBuffer=function(){},b2PairManager.prototype.ValidateTable=function(){},b2PairManager.prototype.Initialize=function(a){this.m_broadPhase=a},b2PairManager.prototype.AddBufferedPair=function(a,b){var c=this.AddPair(a,b);0==c.IsBuffered()&&(c.SetBuffered(),this.m_pairBuffer[this.m_pairBufferCount]=c,++this.m_pairBufferCount),c.ClearRemoved(),b2BroadPhase.s_validate&&this.ValidateBuffer()},b2PairManager.prototype.RemoveBufferedPair=function(a,b){var c=this.Find(a,b);null!=c&&(0==c.IsBuffered()&&(c.SetBuffered(),this.m_pairBuffer[this.m_pairBufferCount]=c,++this.m_pairBufferCount),c.SetRemoved(),b2BroadPhase.s_validate&&this.ValidateBuffer())},b2PairManager.prototype.Commit=function(a){var b=0;for(b=0;b<this.m_pairBufferCount;++b){var c=this.m_pairBuffer[b];c.ClearBuffered();var d=c.proxy1,e=c.proxy2;c.IsRemoved()||0==c.IsFinal()&&a(d.userData,e.userData)}this.m_pairBufferCount=0,b2BroadPhase.s_validate&&this.ValidateTable()},b2PairManager.prototype.m_broadPhase=null,b2PairManager.prototype.m_pairs=null,b2PairManager.prototype.m_freePair=null,b2PairManager.prototype.m_pairCount=0,b2PairManager.prototype.m_pairBuffer=null,b2PairManager.prototype.m_pairBufferCount=0;var b2TimeStep=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2TimeStep.prototype.__constructor=function(){},b2TimeStep.prototype.__varz=function(){},b2TimeStep.prototype.Set=function(a){this.dt=a.dt,this.inv_dt=a.inv_dt,this.positionIterations=a.positionIterations,this.velocityIterations=a.velocityIterations,this.warmStarting=a.warmStarting},b2TimeStep.prototype.dt=null,b2TimeStep.prototype.inv_dt=null,b2TimeStep.prototype.dtRatio=null,b2TimeStep.prototype.velocityIterations=0,b2TimeStep.prototype.positionIterations=0,b2TimeStep.prototype.warmStarting=null;var b2Controller=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Controller.prototype.__constructor=function(){},b2Controller.prototype.__varz=function(){},b2Controller.prototype.Step=function(){},b2Controller.prototype.Draw=function(){},b2Controller.prototype.AddBody=function(a){var b=new b2ControllerEdge;b.controller=this,b.body=a,b.nextBody=m_bodyList,b.prevBody=null,m_bodyList=b,b.nextBody&&(b.nextBody.prevBody=b),m_bodyCount++,b.nextController=a.m_controllerList,b.prevController=null,a.m_controllerList=b,b.nextController&&(b.nextController.prevController=b),a.m_controllerCount++},b2Controller.prototype.RemoveBody=function(a){for(var b=a.m_controllerList;b&&b.controller!=this;)b=b.nextController;b.prevBody&&(b.prevBody.nextBody=b.nextBody),b.nextBody&&(b.nextBody.prevBody=b.prevBody),b.nextController&&(b.nextController.prevController=b.prevController),b.prevController&&(b.prevController.nextController=b.nextController),m_bodyList==b&&(m_bodyList=b.nextBody),a.m_controllerList==b&&(a.m_controllerList=b.nextController),a.m_controllerCount--,m_bodyCount--},b2Controller.prototype.Clear=function(){for(;m_bodyList;)this.RemoveBody(m_bodyList.body)},b2Controller.prototype.GetNext=function(){return this.m_next},b2Controller.prototype.GetWorld=function(){return this.m_world},b2Controller.prototype.GetBodyList=function(){return m_bodyList},b2Controller.prototype.m_next=null,b2Controller.prototype.m_prev=null,b2Controller.prototype.m_world=null;var b2GravityController=function(){b2Controller.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2GravityController.prototype,b2Controller.prototype),b2GravityController.prototype._super=b2Controller.prototype,b2GravityController.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments)},b2GravityController.prototype.__varz=function(){},b2GravityController.prototype.Step=function(){var a=null,b=null,c=null,d=0,e=null,f=null,g=null,h=0,i=0,j=0;if(h=null,this.invSqr)for(a=m_bodyList;a;a=a.nextBody)for(b=a.body,c=b.GetWorldCenter(),d=b.GetMass(),e=m_bodyList;e!=a;e=e.nextBody)f=e.body,g=f.GetWorldCenter(),h=g.x-c.x,i=g.y-c.y,j=h*h+i*i,j<Number.MIN_VALUE||(h=new b2Vec2(h,i),h.Multiply(this.G/j/Math.sqrt(j)*d*f.GetMass()),b.IsAwake()&&b.ApplyForce(h,c),h.Multiply(-1),f.IsAwake()&&f.ApplyForce(h,g));else for(a=m_bodyList;a;a=a.nextBody)for(b=a.body,c=b.GetWorldCenter(),d=b.GetMass(),e=m_bodyList;e!=a;e=e.nextBody)f=e.body,g=f.GetWorldCenter(),h=g.x-c.x,i=g.y-c.y,j=h*h+i*i,j<Number.MIN_VALUE||(h=new b2Vec2(h,i),h.Multiply(this.G/j*d*f.GetMass()),b.IsAwake()&&b.ApplyForce(h,c),h.Multiply(-1),f.IsAwake()&&f.ApplyForce(h,g))},b2GravityController.prototype.G=1,b2GravityController.prototype.invSqr=!0;var b2DestructionListener=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2DestructionListener.prototype.__constructor=function(){},b2DestructionListener.prototype.__varz=function(){},b2DestructionListener.prototype.SayGoodbyeJoint=function(){},b2DestructionListener.prototype.SayGoodbyeFixture=function(){};var b2ContactEdge=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ContactEdge.prototype.__constructor=function(){},b2ContactEdge.prototype.__varz=function(){},b2ContactEdge.prototype.other=null,b2ContactEdge.prototype.contact=null,b2ContactEdge.prototype.prev=null,b2ContactEdge.prototype.next=null;var b2EdgeChainDef=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2EdgeChainDef.prototype.__constructor=function(){this.vertexCount=0,this.isALoop=!0,this.vertices=[]},b2EdgeChainDef.prototype.__varz=function(){},b2EdgeChainDef.prototype.vertices=null,b2EdgeChainDef.prototype.vertexCount=null,b2EdgeChainDef.prototype.isALoop=null;var b2Vec2=function(a,b){2==arguments.length&&(this.x=a,this.y=b)};b2Vec2.Make=function(a,b){return new b2Vec2(a,b)},b2Vec2.prototype.SetZero=function(){this.y=this.x=0},b2Vec2.prototype.Set=function(a,b){this.x=a,this.y=b},b2Vec2.prototype.SetV=function(a){this.x=a.x,this.y=a.y},b2Vec2.prototype.GetNegative=function(){return new b2Vec2(-this.x,-this.y)},b2Vec2.prototype.NegativeSelf=function(){this.x=-this.x,this.y=-this.y},b2Vec2.prototype.Copy=function(){return new b2Vec2(this.x,this.y)},b2Vec2.prototype.Add=function(a){this.x+=a.x,this.y+=a.y},b2Vec2.prototype.Subtract=function(a){this.x-=a.x,this.y-=a.y},b2Vec2.prototype.Multiply=function(a){this.x*=a,this.y*=a},b2Vec2.prototype.MulM=function(a){var b=this.x;this.x=a.col1.x*b+a.col2.x*this.y,this.y=a.col1.y*b+a.col2.y*this.y},b2Vec2.prototype.MulTM=function(a){var b=b2Math.Dot(this,a.col1);this.y=b2Math.Dot(this,a.col2),this.x=b},b2Vec2.prototype.CrossVF=function(a){var b=this.x;this.x=a*this.y,this.y=-a*b},b2Vec2.prototype.CrossFV=function(a){var b=this.x;this.x=-a*this.y,this.y=a*b},b2Vec2.prototype.MinV=function(a){this.x=this.x<a.x?this.x:a.x,this.y=this.y<a.y?this.y:a.y},b2Vec2.prototype.MaxV=function(a){this.x=this.x>a.x?this.x:a.x,this.y=this.y>a.y?this.y:a.y},b2Vec2.prototype.Abs=function(){this.x<0&&(this.x=-this.x),this.y<0&&(this.y=-this.y)},b2Vec2.prototype.Length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},b2Vec2.prototype.LengthSquared=function(){return this.x*this.x+this.y*this.y},b2Vec2.prototype.Normalize=function(){var a=Math.sqrt(this.x*this.x+this.y*this.y);if(a<Number.MIN_VALUE)return 0;var b=1/a;return this.x*=b,this.y*=b,a},b2Vec2.prototype.IsValid=function(){return b2Math.IsValid(this.x)&&b2Math.IsValid(this.y)},b2Vec2.prototype.x=0,b2Vec2.prototype.y=0;var b2Vec3=function(a,b,c){3==arguments.length&&(this.x=a,this.y=b,this.z=c)};b2Vec3.prototype.SetZero=function(){this.x=this.y=this.z=0},b2Vec3.prototype.Set=function(a,b,c){this.x=a,this.y=b,this.z=c},b2Vec3.prototype.SetV=function(a){this.x=a.x,this.y=a.y,this.z=a.z},b2Vec3.prototype.GetNegative=function(){return new b2Vec3(-this.x,-this.y,-this.z)},b2Vec3.prototype.NegativeSelf=function(){this.x=-this.x,this.y=-this.y,this.z=-this.z},b2Vec3.prototype.Copy=function(){return new b2Vec3(this.x,this.y,this.z)},b2Vec3.prototype.Add=function(a){this.x+=a.x,this.y+=a.y,this.z+=a.z},b2Vec3.prototype.Subtract=function(a){this.x-=a.x,this.y-=a.y,this.z-=a.z},b2Vec3.prototype.Multiply=function(a){this.x*=a,this.y*=a,this.z*=a},b2Vec3.prototype.x=0,b2Vec3.prototype.y=0,b2Vec3.prototype.z=0;var b2DistanceProxy=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2DistanceProxy.prototype.__constructor=function(){},b2DistanceProxy.prototype.__varz=function(){},b2DistanceProxy.prototype.Set=function(a){switch(a.GetType()){case b2Shape.e_circleShape:this.m_vertices=Array(1),this.m_vertices[0]=a.m_p,this.m_count=1,this.m_radius=a.m_radius;break;case b2Shape.e_polygonShape:this.m_vertices=a.m_vertices,this.m_count=a.m_vertexCount,this.m_radius=a.m_radius;break;default:b2Settings.b2Assert(!1)}},b2DistanceProxy.prototype.GetSupport=function(a){for(var b=0,c=this.m_vertices[0].x*a.x+this.m_vertices[0].y*a.y,d=1;d<this.m_count;++d){var e=this.m_vertices[d].x*a.x+this.m_vertices[d].y*a.y;e>c&&(b=d,c=e)}return b},b2DistanceProxy.prototype.GetSupportVertex=function(a){for(var b=0,c=this.m_vertices[0].x*a.x+this.m_vertices[0].y*a.y,d=1;d<this.m_count;++d){var e=this.m_vertices[d].x*a.x+this.m_vertices[d].y*a.y;e>c&&(b=d,c=e)}return this.m_vertices[b]},b2DistanceProxy.prototype.GetVertexCount=function(){return this.m_count},b2DistanceProxy.prototype.GetVertex=function(a){return b2Settings.b2Assert(a>=0&&a<this.m_count),this.m_vertices[a]},b2DistanceProxy.prototype.m_vertices=null,b2DistanceProxy.prototype.m_count=0,b2DistanceProxy.prototype.m_radius=null;var b2ContactFactory=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ContactFactory.prototype.__constructor=function(a){this.m_allocator=a,this.InitializeRegisters()},b2ContactFactory.prototype.__varz=function(){},b2ContactFactory.prototype.AddType=function(a,b,c,d){this.m_registers[c][d].createFcn=a,this.m_registers[c][d].destroyFcn=b,this.m_registers[c][d].primary=!0,c!=d&&(this.m_registers[d][c].createFcn=a,this.m_registers[d][c].destroyFcn=b,this.m_registers[d][c].primary=!1)},b2ContactFactory.prototype.InitializeRegisters=function(){this.m_registers=Array(b2Shape.e_shapeTypeCount);for(var a=0;a<b2Shape.e_shapeTypeCount;a++){this.m_registers[a]=Array(b2Shape.e_shapeTypeCount);for(var b=0;b<b2Shape.e_shapeTypeCount;b++)this.m_registers[a][b]=new b2ContactRegister}this.AddType(b2CircleContact.Create,b2CircleContact.Destroy,b2Shape.e_circleShape,b2Shape.e_circleShape),this.AddType(b2PolyAndCircleContact.Create,b2PolyAndCircleContact.Destroy,b2Shape.e_polygonShape,b2Shape.e_circleShape),this.AddType(b2PolygonContact.Create,b2PolygonContact.Destroy,b2Shape.e_polygonShape,b2Shape.e_polygonShape),this.AddType(b2EdgeAndCircleContact.Create,b2EdgeAndCircleContact.Destroy,b2Shape.e_edgeShape,b2Shape.e_circleShape),this.AddType(b2PolyAndEdgeContact.Create,b2PolyAndEdgeContact.Destroy,b2Shape.e_polygonShape,b2Shape.e_edgeShape)},b2ContactFactory.prototype.Create=function(a,b){var c=a.GetType(),d=b.GetType();return c=this.m_registers[c][d],c.pool?(d=c.pool,c.pool=d.m_next,c.poolCount--,d.Reset(a,b),d):(d=c.createFcn,null!=d?(c.primary?(d=d(this.m_allocator),d.Reset(a,b)):(d=d(this.m_allocator),d.Reset(b,a)),d):null)},b2ContactFactory.prototype.Destroy=function(a){a.m_manifold.m_pointCount>0&&(a.m_fixtureA.m_body.SetAwake(!0),a.m_fixtureB.m_body.SetAwake(!0));var b=a.m_fixtureA.GetType(),c=a.m_fixtureB.GetType();b=this.m_registers[b][c],b.poolCount++,a.m_next=b.pool,b.pool=a,(b=b.destroyFcn)(a,this.m_allocator)},b2ContactFactory.prototype.m_registers=null,b2ContactFactory.prototype.m_allocator=null;var b2ConstantAccelController=function(){b2Controller.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2ConstantAccelController.prototype,b2Controller.prototype),b2ConstantAccelController.prototype._super=b2Controller.prototype,b2ConstantAccelController.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments)},b2ConstantAccelController.prototype.__varz=function(){this.A=new b2Vec2(0,0)},b2ConstantAccelController.prototype.Step=function(a){a=new b2Vec2(this.A.x*a.dt,this.A.y*a.dt);for(var b=m_bodyList;b;b=b.nextBody){var c=b.body;c.IsAwake()&&c.SetLinearVelocity(new b2Vec2(c.GetLinearVelocity().x+a.x,c.GetLinearVelocity().y+a.y))}},b2ConstantAccelController.prototype.A=new b2Vec2(0,0);var b2SeparationFunction=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2SeparationFunction.prototype.__constructor=function(){},b2SeparationFunction.prototype.__varz=function(){this.m_localPoint=new b2Vec2,this.m_axis=new b2Vec2},b2SeparationFunction.e_points=1,b2SeparationFunction.e_faceA=2,b2SeparationFunction.e_faceB=4,b2SeparationFunction.prototype.Initialize=function(a,b,c,d,e){this.m_proxyA=b,this.m_proxyB=d,b=a.count,b2Settings.b2Assert(b>0&&3>b);var f,g,h,i;if(1==b)this.m_type=b2SeparationFunction.e_points,f=this.m_proxyA.GetVertex(a.indexA[0]),g=this.m_proxyB.GetVertex(a.indexB[0]),i=f,h=c.R,f=c.position.x+(h.col1.x*i.x+h.col2.x*i.y),c=c.position.y+(h.col1.y*i.x+h.col2.y*i.y),i=g,h=e.R,g=e.position.x+(h.col1.x*i.x+h.col2.x*i.y),e=e.position.y+(h.col1.y*i.x+h.col2.y*i.y),this.m_axis.x=g-f,this.m_axis.y=e-c,this.m_axis.Normalize();else{if(a.indexB[0]==a.indexB[1])this.m_type=b2SeparationFunction.e_faceA,b=this.m_proxyA.GetVertex(a.indexA[0]),d=this.m_proxyA.GetVertex(a.indexA[1]),g=this.m_proxyB.GetVertex(a.indexB[0]),this.m_localPoint.x=.5*(b.x+d.x),this.m_localPoint.y=.5*(b.y+d.y),this.m_axis=b2Math.CrossVF(b2Math.SubtractVV(d,b),1),this.m_axis.Normalize(),i=this.m_axis,h=c.R,b=h.col1.x*i.x+h.col2.x*i.y,d=h.col1.y*i.x+h.col2.y*i.y,i=this.m_localPoint,h=c.R,f=c.position.x+(h.col1.x*i.x+h.col2.x*i.y),c=c.position.y+(h.col1.y*i.x+h.col2.y*i.y),i=g,h=e.R,g=e.position.x+(h.col1.x*i.x+h.col2.x*i.y),e=e.position.y+(h.col1.y*i.x+h.col2.y*i.y),a=(g-f)*b+(e-c)*d;else if(a.indexA[0]==a.indexA[0])this.m_type=b2SeparationFunction.e_faceB,h=this.m_proxyB.GetVertex(a.indexB[0]),i=this.m_proxyB.GetVertex(a.indexB[1]),f=this.m_proxyA.GetVertex(a.indexA[0]),this.m_localPoint.x=.5*(h.x+i.x),this.m_localPoint.y=.5*(h.y+i.y),this.m_axis=b2Math.CrossVF(b2Math.SubtractVV(i,h),1),this.m_axis.Normalize(),i=this.m_axis,h=e.R,b=h.col1.x*i.x+h.col2.x*i.y,d=h.col1.y*i.x+h.col2.y*i.y,i=this.m_localPoint,h=e.R,g=e.position.x+(h.col1.x*i.x+h.col2.x*i.y),e=e.position.y+(h.col1.y*i.x+h.col2.y*i.y),i=f,h=c.R,f=c.position.x+(h.col1.x*i.x+h.col2.x*i.y),c=c.position.y+(h.col1.y*i.x+h.col2.y*i.y),a=(f-g)*b+(c-e)*d;else{b=this.m_proxyA.GetVertex(a.indexA[0]),d=this.m_proxyA.GetVertex(a.indexA[1]),h=this.m_proxyB.GetVertex(a.indexB[0]),i=this.m_proxyB.GetVertex(a.indexB[1]),b2Math.MulX(c,f),f=b2Math.MulMV(c.R,b2Math.SubtractVV(d,b)),b2Math.MulX(e,g),a=b2Math.MulMV(e.R,b2Math.SubtractVV(i,h)),e=f.x*f.x+f.y*f.y,g=a.x*a.x+a.y*a.y;var j=b2Math.SubtractVV(a,f);c=f.x*j.x+f.y*j.y,j=a.x*j.x+a.y*j.y,f=f.x*a.x+f.y*a.y;var k=e*g-f*f;a=0,0!=k&&(a=b2Math.Clamp((f*j-c*g)/k,0,1)),0>(f*a+j)/g&&(a=b2Math.Clamp((f-c)/e,0,1)),f=new b2Vec2,f.x=b.x+a*(d.x-b.x),f.y=b.y+a*(d.y-b.y),g=new b2Vec2,g.x=h.x+a*(i.x-h.x),g.y=h.y+a*(i.y-h.y),0==a||1==a?(this.m_type=b2SeparationFunction.e_faceB,this.m_axis=b2Math.CrossVF(b2Math.SubtractVV(i,h),1),this.m_axis.Normalize(),this.m_localPoint=g):(this.m_type=b2SeparationFunction.e_faceA,this.m_axis=b2Math.CrossVF(b2Math.SubtractVV(d,b),1),this.m_localPoint=f)}0>a&&this.m_axis.NegativeSelf()}},b2SeparationFunction.prototype.Evaluate=function(a,b){var c,d,e;switch(this.m_type){case b2SeparationFunction.e_points:return c=b2Math.MulTMV(a.R,this.m_axis),d=b2Math.MulTMV(b.R,this.m_axis.GetNegative()),c=this.m_proxyA.GetSupportVertex(c),d=this.m_proxyB.GetSupportVertex(d),c=b2Math.MulX(a,c),d=b2Math.MulX(b,d),e=(d.x-c.x)*this.m_axis.x+(d.y-c.y)*this.m_axis.y;case b2SeparationFunction.e_faceA:return e=b2Math.MulMV(a.R,this.m_axis),c=b2Math.MulX(a,this.m_localPoint),d=b2Math.MulTMV(b.R,e.GetNegative()),d=this.m_proxyB.GetSupportVertex(d),d=b2Math.MulX(b,d),e=(d.x-c.x)*e.x+(d.y-c.y)*e.y;case b2SeparationFunction.e_faceB:return e=b2Math.MulMV(b.R,this.m_axis),d=b2Math.MulX(b,this.m_localPoint),c=b2Math.MulTMV(a.R,e.GetNegative()),c=this.m_proxyA.GetSupportVertex(c),c=b2Math.MulX(a,c),e=(c.x-d.x)*e.x+(c.y-d.y)*e.y;default:return b2Settings.b2Assert(!1),0}},b2SeparationFunction.prototype.m_proxyA=null,b2SeparationFunction.prototype.m_proxyB=null,b2SeparationFunction.prototype.m_type=0,b2SeparationFunction.prototype.m_localPoint=new b2Vec2,b2SeparationFunction.prototype.m_axis=new b2Vec2;var b2DynamicTreePair=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2DynamicTreePair.prototype.__constructor=function(){},b2DynamicTreePair.prototype.__varz=function(){},b2DynamicTreePair.prototype.proxyA=null,b2DynamicTreePair.prototype.proxyB=null;var b2ContactConstraintPoint=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ContactConstraintPoint.prototype.__constructor=function(){},b2ContactConstraintPoint.prototype.__varz=function(){this.localPoint=new b2Vec2,this.rA=new b2Vec2,this.rB=new b2Vec2},b2ContactConstraintPoint.prototype.localPoint=new b2Vec2,b2ContactConstraintPoint.prototype.rA=new b2Vec2,b2ContactConstraintPoint.prototype.rB=new b2Vec2,b2ContactConstraintPoint.prototype.normalImpulse=null,b2ContactConstraintPoint.prototype.tangentImpulse=null,b2ContactConstraintPoint.prototype.normalMass=null,b2ContactConstraintPoint.prototype.tangentMass=null,b2ContactConstraintPoint.prototype.equalizedMass=null,b2ContactConstraintPoint.prototype.velocityBias=null;var b2ControllerEdge=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ControllerEdge.prototype.__constructor=function(){},b2ControllerEdge.prototype.__varz=function(){},b2ControllerEdge.prototype.controller=null,b2ControllerEdge.prototype.body=null,b2ControllerEdge.prototype.prevBody=null,b2ControllerEdge.prototype.nextBody=null,b2ControllerEdge.prototype.prevController=null,b2ControllerEdge.prototype.nextController=null;var b2DistanceInput=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2DistanceInput.prototype.__constructor=function(){},b2DistanceInput.prototype.__varz=function(){},b2DistanceInput.prototype.proxyA=null,b2DistanceInput.prototype.proxyB=null,b2DistanceInput.prototype.transformA=null,b2DistanceInput.prototype.transformB=null,b2DistanceInput.prototype.useRadii=null;var b2Settings=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Settings.prototype.__constructor=function(){},b2Settings.prototype.__varz=function(){},b2Settings.b2MixFriction=function(a,b){return Math.sqrt(a*b)},b2Settings.b2MixRestitution=function(a,b){return a>b?a:b},b2Settings.b2Assert=function(a){if(!a)throw"Assertion Failed"},b2Settings.VERSION="2.1alpha",b2Settings.USHRT_MAX=65535,b2Settings.b2_pi=Math.PI,b2Settings.b2_maxManifoldPoints=2,b2Settings.b2_aabbExtension=.1,b2Settings.b2_aabbMultiplier=2,b2Settings.b2_polygonRadius=2*b2Settings.b2_linearSlop,b2Settings.b2_linearSlop=.005,b2Settings.b2_angularSlop=2/180*b2Settings.b2_pi,b2Settings.b2_toiSlop=8*b2Settings.b2_linearSlop,b2Settings.b2_maxTOIContactsPerIsland=32,b2Settings.b2_maxTOIJointsPerIsland=32,b2Settings.b2_velocityThreshold=1,b2Settings.b2_maxLinearCorrection=.2,b2Settings.b2_maxAngularCorrection=8/180*b2Settings.b2_pi,b2Settings.b2_maxTranslation=2,b2Settings.b2_maxTranslationSquared=b2Settings.b2_maxTranslation*b2Settings.b2_maxTranslation,b2Settings.b2_maxRotation=.5*b2Settings.b2_pi,b2Settings.b2_maxRotationSquared=b2Settings.b2_maxRotation*b2Settings.b2_maxRotation,b2Settings.b2_contactBaumgarte=.2,b2Settings.b2_timeToSleep=.5,b2Settings.b2_linearSleepTolerance=.01,b2Settings.b2_angularSleepTolerance=2/180*b2Settings.b2_pi;var b2Proxy=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Proxy.prototype.__constructor=function(){},b2Proxy.prototype.__varz=function(){this.lowerBounds=Array(2),this.upperBounds=Array(2),this.pairs={}},b2Proxy.prototype.IsValid=function(){return this.overlapCount!=b2BroadPhase.b2_invalid},b2Proxy.prototype.lowerBounds=Array(2),b2Proxy.prototype.upperBounds=Array(2),b2Proxy.prototype.overlapCount=0,b2Proxy.prototype.timeStamp=0,b2Proxy.prototype.pairs={},b2Proxy.prototype.next=null,b2Proxy.prototype.userData=null;var b2Point=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Point.prototype.__constructor=function(){},b2Point.prototype.__varz=function(){this.p=new b2Vec2},b2Point.prototype.Support=function(){return this.p},b2Point.prototype.GetFirstVertex=function(){return this.p},b2Point.prototype.p=new b2Vec2;var b2WorldManifold=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2WorldManifold.prototype.__constructor=function(){this.m_points=Array(b2Settings.b2_maxManifoldPoints);for(var a=0;a<b2Settings.b2_maxManifoldPoints;a++)this.m_points[a]=new b2Vec2},b2WorldManifold.prototype.__varz=function(){this.m_normal=new b2Vec2},b2WorldManifold.prototype.Initialize=function(a,b,c,d,e){if(0!=a.m_pointCount){var f,g,h,i,j,k,l,m=0;switch(a.m_type){case b2Manifold.e_circles:g=b.R,f=a.m_localPoint,m=b.position.x+g.col1.x*f.x+g.col2.x*f.y,b=b.position.y+g.col1.y*f.x+g.col2.y*f.y,g=d.R,f=a.m_points[0].m_localPoint,a=d.position.x+g.col1.x*f.x+g.col2.x*f.y,d=d.position.y+g.col1.y*f.x+g.col2.y*f.y,f=a-m,g=d-b,h=f*f+g*g,h>Number.MIN_VALUE*Number.MIN_VALUE?(h=Math.sqrt(h),this.m_normal.x=f/h,this.m_normal.y=g/h):(this.m_normal.x=1,this.m_normal.y=0),f=b+c*this.m_normal.y,d-=e*this.m_normal.y,this.m_points[0].x=.5*(m+c*this.m_normal.x+(a-e*this.m_normal.x)),this.m_points[0].y=.5*(f+d);break;case b2Manifold.e_faceA:for(g=b.R,f=a.m_localPlaneNormal,h=g.col1.x*f.x+g.col2.x*f.y,i=g.col1.y*f.x+g.col2.y*f.y,g=b.R,f=a.m_localPoint,j=b.position.x+g.col1.x*f.x+g.col2.x*f.y,k=b.position.y+g.col1.y*f.x+g.col2.y*f.y,this.m_normal.x=h,this.m_normal.y=i,m=0;m<a.m_pointCount;m++)g=d.R,f=a.m_points[m].m_localPoint,l=d.position.x+g.col1.x*f.x+g.col2.x*f.y,f=d.position.y+g.col1.y*f.x+g.col2.y*f.y,this.m_points[m].x=l+.5*(c-(l-j)*h-(f-k)*i-e)*h,this.m_points[m].y=f+.5*(c-(l-j)*h-(f-k)*i-e)*i;break;case b2Manifold.e_faceB:for(g=d.R,f=a.m_localPlaneNormal,h=g.col1.x*f.x+g.col2.x*f.y,i=g.col1.y*f.x+g.col2.y*f.y,g=d.R,f=a.m_localPoint,j=d.position.x+g.col1.x*f.x+g.col2.x*f.y,k=d.position.y+g.col1.y*f.x+g.col2.y*f.y,this.m_normal.x=-h,this.m_normal.y=-i,m=0;m<a.m_pointCount;m++)g=b.R,f=a.m_points[m].m_localPoint,l=b.position.x+g.col1.x*f.x+g.col2.x*f.y,f=b.position.y+g.col1.y*f.x+g.col2.y*f.y,this.m_points[m].x=l+.5*(e-(l-j)*h-(f-k)*i-c)*h,this.m_points[m].y=f+.5*(e-(l-j)*h-(f-k)*i-c)*i}}},b2WorldManifold.prototype.m_normal=new b2Vec2,b2WorldManifold.prototype.m_points=null;var b2RayCastOutput=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2RayCastOutput.prototype.__constructor=function(){},b2RayCastOutput.prototype.__varz=function(){this.normal=new b2Vec2},b2RayCastOutput.prototype.normal=new b2Vec2,b2RayCastOutput.prototype.fraction=null;var b2ConstantForceController=function(){b2Controller.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2ConstantForceController.prototype,b2Controller.prototype),b2ConstantForceController.prototype._super=b2Controller.prototype,b2ConstantForceController.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments)},b2ConstantForceController.prototype.__varz=function(){this.F=new b2Vec2(0,0)},b2ConstantForceController.prototype.Step=function(){for(var a=m_bodyList;a;a=a.nextBody){var b=a.body;b.IsAwake()&&b.ApplyForce(this.F,b.GetWorldCenter())}},b2ConstantForceController.prototype.F=new b2Vec2(0,0);var b2MassData=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2MassData.prototype.__constructor=function(){},b2MassData.prototype.__varz=function(){this.center=new b2Vec2(0,0)},b2MassData.prototype.mass=0,b2MassData.prototype.center=new b2Vec2(0,0),b2MassData.prototype.I=0;var b2DynamicTree=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2DynamicTree.prototype.__constructor=function(){this.m_freeList=this.m_root=null,this.m_insertionCount=this.m_path=0},b2DynamicTree.prototype.__varz=function(){},b2DynamicTree.prototype.AllocateNode=function(){if(this.m_freeList){var a=this.m_freeList;return this.m_freeList=a.parent,a.parent=null,a.child1=null,a.child2=null,a}return new b2DynamicTreeNode},b2DynamicTree.prototype.FreeNode=function(a){a.parent=this.m_freeList,this.m_freeList=a},b2DynamicTree.prototype.InsertLeaf=function(a){if(++this.m_insertionCount,null==this.m_root)this.m_root=a,this.m_root.parent=null;else{var b=a.aabb.GetCenter(),c=this.m_root;if(0==c.IsLeaf())do{var d=c.child1;c=c.child2,c=Math.abs((d.aabb.lowerBound.x+d.aabb.upperBound.x)/2-b.x)+Math.abs((d.aabb.lowerBound.y+d.aabb.upperBound.y)/2-b.y)<Math.abs((c.aabb.lowerBound.x+c.aabb.upperBound.x)/2-b.x)+Math.abs((c.aabb.lowerBound.y+c.aabb.upperBound.y)/2-b.y)?d:c}while(0==c.IsLeaf());if(b=c.parent,d=this.AllocateNode(),d.parent=b,d.userData=null,d.aabb.Combine(a.aabb,c.aabb),b){c.parent.child1==c?b.child1=d:b.child2=d,d.child1=c,d.child2=a,c.parent=d,a.parent=d;do{if(b.aabb.Contains(d.aabb))break;b.aabb.Combine(b.child1.aabb,b.child2.aabb),d=b,b=b.parent}while(b)}else d.child1=c,d.child2=a,c.parent=d,this.m_root=a.parent=d}},b2DynamicTree.prototype.RemoveLeaf=function(a){if(a==this.m_root)this.m_root=null;else{var b=a.parent,c=b.parent;if(a=b.child1==a?b.child2:b.child1,c)for(c.child1==b?c.child1=a:c.child2=a,a.parent=c,this.FreeNode(b);c&&(b=c.aabb,c.aabb=b2AABB.Combine(c.child1.aabb,c.child2.aabb),!b.Contains(c.aabb));)c=c.parent;else this.m_root=a,a.parent=null,this.FreeNode(b)}},b2DynamicTree.prototype.CreateProxy=function(a,b){var c=this.AllocateNode(),d=b2Settings.b2_aabbExtension,e=b2Settings.b2_aabbExtension;return c.aabb.lowerBound.x=a.lowerBound.x-d,c.aabb.lowerBound.y=a.lowerBound.y-e,c.aabb.upperBound.x=a.upperBound.x+d,c.aabb.upperBound.y=a.upperBound.y+e,c.userData=b,this.InsertLeaf(c),c},b2DynamicTree.prototype.DestroyProxy=function(a){this.RemoveLeaf(a),this.FreeNode(a)},b2DynamicTree.prototype.MoveProxy=function(a,b,c){if(b2Settings.b2Assert(a.IsLeaf()),a.aabb.Contains(b))return!1;this.RemoveLeaf(a);var d=b2Settings.b2_aabbExtension+b2Settings.b2_aabbMultiplier*(c.x>0?c.x:-c.x);return c=b2Settings.b2_aabbExtension+b2Settings.b2_aabbMultiplier*(c.y>0?c.y:-c.y),a.aabb.lowerBound.x=b.lowerBound.x-d,a.aabb.lowerBound.y=b.lowerBound.y-c,a.aabb.upperBound.x=b.upperBound.x+d,a.aabb.upperBound.y=b.upperBound.y+c,this.InsertLeaf(a),!0},b2DynamicTree.prototype.Rebalance=function(a){if(null!=this.m_root)for(var b=0;a>b;b++){for(var c=this.m_root,d=0;0==c.IsLeaf();)c=this.m_path>>d&1?c.child2:c.child1,d=d+1&31;++this.m_path,this.RemoveLeaf(c),this.InsertLeaf(c)}},b2DynamicTree.prototype.GetFatAABB=function(a){return a.aabb},b2DynamicTree.prototype.GetUserData=function(a){return a.userData},b2DynamicTree.prototype.Query=function(a,b){if(null!=this.m_root){var c=[],d=0;for(c[d++]=this.m_root;d>0;){var e=c[--d];if(e.aabb.TestOverlap(b))if(e.IsLeaf()){if(!a(e))break}else c[d++]=e.child1,c[d++]=e.child2}}},b2DynamicTree.prototype.RayCast=function(a,b){if(null!=this.m_root){var c=b.p1,d=b.p2,e=b2Math.SubtractVV(c,d);e.Normalize(),e=b2Math.CrossFV(1,e);var f,g=b2Math.AbsV(e),h=b.maxFraction,i=new b2AABB;f=c.x+h*(d.x-c.x),h=c.y+h*(d.y-c.y),i.lowerBound.x=Math.min(c.x,f),i.lowerBound.y=Math.min(c.y,h),i.upperBound.x=Math.max(c.x,f),i.upperBound.y=Math.max(c.y,h);var j=[],k=0;for(j[k++]=this.m_root;k>0;)if(f=j[--k],0!=f.aabb.TestOverlap(i)){h=f.aabb.GetCenter();var l=f.aabb.GetExtents();if(!(Math.abs(e.x*(c.x-h.x)+e.y*(c.y-h.y))-g.x*l.x-g.y*l.y>0))if(f.IsLeaf()){if(h=new b2RayCastInput,h.p1=b.p1,h.p2=b.p2,h.maxFraction=b.maxFraction,h=a(h,f),0==h)break;f=c.x+h*(d.x-c.x),h=c.y+h*(d.y-c.y),i.lowerBound.x=Math.min(c.x,f),i.lowerBound.y=Math.min(c.y,h),i.upperBound.x=Math.max(c.x,f),i.upperBound.y=Math.max(c.y,h)
}else j[k++]=f.child1,j[k++]=f.child2}}},b2DynamicTree.prototype.m_root=null,b2DynamicTree.prototype.m_freeList=null,b2DynamicTree.prototype.m_path=0,b2DynamicTree.prototype.m_insertionCount=0;var b2JointEdge=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2JointEdge.prototype.__constructor=function(){},b2JointEdge.prototype.__varz=function(){},b2JointEdge.prototype.other=null,b2JointEdge.prototype.joint=null,b2JointEdge.prototype.prev=null,b2JointEdge.prototype.next=null;var b2RayCastInput=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2RayCastInput.prototype.__constructor=function(a,b,c){a&&this.p1.SetV(a),b&&this.p2.SetV(b),c&&(this.maxFraction=c)},b2RayCastInput.prototype.__varz=function(){this.p1=new b2Vec2,this.p2=new b2Vec2},b2RayCastInput.prototype.p1=new b2Vec2,b2RayCastInput.prototype.p2=new b2Vec2,b2RayCastInput.prototype.maxFraction=null;var Features=function(){this.__varz(),this.__constructor.apply(this,arguments)};Features.prototype.__constructor=function(){},Features.prototype.__varz=function(){},Features.prototype.__defineGetter__("referenceEdge",function(){return this._referenceEdge}),Features.prototype.__defineSetter__("referenceEdge",function(a){this._referenceEdge=a,this._m_id._key=4294967040&this._m_id._key|255&this._referenceEdge}),Features.prototype.__defineGetter__("incidentEdge",function(){return this._incidentEdge}),Features.prototype.__defineSetter__("incidentEdge",function(a){this._incidentEdge=a,this._m_id._key=4294902015&this._m_id._key|this._incidentEdge<<8&65280}),Features.prototype.__defineGetter__("incidentVertex",function(){return this._incidentVertex}),Features.prototype.__defineSetter__("incidentVertex",function(a){this._incidentVertex=a,this._m_id._key=4278255615&this._m_id._key|this._incidentVertex<<16&16711680}),Features.prototype.__defineGetter__("flip",function(){return this._flip}),Features.prototype.__defineSetter__("flip",function(a){this._flip=a,this._m_id._key=16777215&this._m_id._key|this._flip<<24&4278190080}),Features.prototype._referenceEdge=0,Features.prototype._incidentEdge=0,Features.prototype._incidentVertex=0,Features.prototype._flip=0,Features.prototype._m_id=null;var b2FilterData=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2FilterData.prototype.__constructor=function(){},b2FilterData.prototype.__varz=function(){this.categoryBits=1,this.maskBits=65535},b2FilterData.prototype.Copy=function(){var a=new b2FilterData;return a.categoryBits=this.categoryBits,a.maskBits=this.maskBits,a.groupIndex=this.groupIndex,a},b2FilterData.prototype.categoryBits=1,b2FilterData.prototype.maskBits=65535,b2FilterData.prototype.groupIndex=0;var b2AABB=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2AABB.prototype.__constructor=function(){},b2AABB.prototype.__varz=function(){this.lowerBound=new b2Vec2,this.upperBound=new b2Vec2},b2AABB.Combine=function(a,b){var c=new b2AABB;return c.Combine(a,b),c},b2AABB.prototype.IsValid=function(){var a=this.upperBound.y-this.lowerBound.y;return a=(a=this.upperBound.x-this.lowerBound.x>=0&&a>=0)&&this.lowerBound.IsValid()&&this.upperBound.IsValid()},b2AABB.prototype.GetCenter=function(){return new b2Vec2((this.lowerBound.x+this.upperBound.x)/2,(this.lowerBound.y+this.upperBound.y)/2)},b2AABB.prototype.GetExtents=function(){return new b2Vec2((this.upperBound.x-this.lowerBound.x)/2,(this.upperBound.y-this.lowerBound.y)/2)},b2AABB.prototype.Contains=function(a){return this.lowerBound.x<=a.lowerBound.x&&this.lowerBound.y<=a.lowerBound.y&&a.upperBound.x<=this.upperBound.x&&a.upperBound.y<=this.upperBound.y},b2AABB.prototype.RayCast=function(a,b){var c,d=-Number.MAX_VALUE,e=Number.MAX_VALUE,f=b.p1.x,g=b.p1.y,h=b.p2.x-b.p1.x,i=b.p2.y-b.p1.y,j=Math.abs(i),k=a.normal;if(Math.abs(h)<Number.MIN_VALUE){if(f<this.lowerBound.x||this.upperBound.x<f)return!1}else if(c=1/h,h=(this.lowerBound.x-f)*c,f=(this.upperBound.x-f)*c,c=-1,h>f&&(c=h,h=f,f=c,c=1),h>d&&(k.x=c,k.y=0,d=h),e=Math.min(e,f),d>e)return!1;if(j<Number.MIN_VALUE){if(g<this.lowerBound.y||this.upperBound.y<g)return!1}else if(c=1/i,h=(this.lowerBound.y-g)*c,f=(this.upperBound.y-g)*c,c=-1,h>f&&(c=h,h=f,f=c,c=1),h>d&&(k.y=c,k.x=0,d=h),e=Math.min(e,f),d>e)return!1;return a.fraction=d,!0},b2AABB.prototype.TestOverlap=function(a){var b=a.lowerBound.y-this.upperBound.y,c=this.lowerBound.y-a.upperBound.y;return a.lowerBound.x-this.upperBound.x>0||b>0?!1:this.lowerBound.x-a.upperBound.x>0||c>0?!1:!0},b2AABB.prototype.Combine=function(a,b){this.lowerBound.x=Math.min(a.lowerBound.x,b.lowerBound.x),this.lowerBound.y=Math.min(a.lowerBound.y,b.lowerBound.y),this.upperBound.x=Math.max(a.upperBound.x,b.upperBound.x),this.upperBound.y=Math.max(a.upperBound.y,b.upperBound.y)},b2AABB.prototype.lowerBound=new b2Vec2,b2AABB.prototype.upperBound=new b2Vec2;var b2Jacobian=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Jacobian.prototype.__constructor=function(){},b2Jacobian.prototype.__varz=function(){this.linearA=new b2Vec2,this.linearB=new b2Vec2},b2Jacobian.prototype.SetZero=function(){this.linearA.SetZero(),this.angularA=0,this.linearB.SetZero(),this.angularB=0},b2Jacobian.prototype.Set=function(a,b,c,d){this.linearA.SetV(a),this.angularA=b,this.linearB.SetV(c),this.angularB=d},b2Jacobian.prototype.Compute=function(a,b,c,d){return this.linearA.x*a.x+this.linearA.y*a.y+this.angularA*b+(this.linearB.x*c.x+this.linearB.y*c.y)+this.angularB*d},b2Jacobian.prototype.linearA=new b2Vec2,b2Jacobian.prototype.angularA=null,b2Jacobian.prototype.linearB=new b2Vec2,b2Jacobian.prototype.angularB=null;var b2Bound=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Bound.prototype.__constructor=function(){},b2Bound.prototype.__varz=function(){},b2Bound.prototype.IsLower=function(){return 0==(1&this.value)},b2Bound.prototype.IsUpper=function(){return 1==(1&this.value)},b2Bound.prototype.Swap=function(a){var b=this.value,c=this.proxy,d=this.stabbingCount;this.value=a.value,this.proxy=a.proxy,this.stabbingCount=a.stabbingCount,a.value=b,a.proxy=c,a.stabbingCount=d},b2Bound.prototype.value=0,b2Bound.prototype.proxy=null,b2Bound.prototype.stabbingCount=0;var b2SimplexVertex=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2SimplexVertex.prototype.__constructor=function(){},b2SimplexVertex.prototype.__varz=function(){},b2SimplexVertex.prototype.Set=function(a){this.wA.SetV(a.wA),this.wB.SetV(a.wB),this.w.SetV(a.w),this.a=a.a,this.indexA=a.indexA,this.indexB=a.indexB},b2SimplexVertex.prototype.wA=null,b2SimplexVertex.prototype.wB=null,b2SimplexVertex.prototype.w=null,b2SimplexVertex.prototype.a=null,b2SimplexVertex.prototype.indexA=0,b2SimplexVertex.prototype.indexB=0;var b2Mat22=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Mat22.prototype.__constructor=function(){this.col1.x=this.col2.y=1},b2Mat22.prototype.__varz=function(){this.col1=new b2Vec2,this.col2=new b2Vec2},b2Mat22.FromAngle=function(a){var b=new b2Mat22;return b.Set(a),b},b2Mat22.FromVV=function(a,b){var c=new b2Mat22;return c.SetVV(a,b),c},b2Mat22.prototype.Set=function(a){var b=Math.cos(a);a=Math.sin(a),this.col1.x=b,this.col2.x=-a,this.col1.y=a,this.col2.y=b},b2Mat22.prototype.SetVV=function(a,b){this.col1.SetV(a),this.col2.SetV(b)},b2Mat22.prototype.Copy=function(){var a=new b2Mat22;return a.SetM(this),a},b2Mat22.prototype.SetM=function(a){this.col1.SetV(a.col1),this.col2.SetV(a.col2)},b2Mat22.prototype.AddM=function(a){this.col1.x+=a.col1.x,this.col1.y+=a.col1.y,this.col2.x+=a.col2.x,this.col2.y+=a.col2.y},b2Mat22.prototype.SetIdentity=function(){this.col1.x=1,this.col2.x=0,this.col1.y=0,this.col2.y=1},b2Mat22.prototype.SetZero=function(){this.col1.x=0,this.col2.x=0,this.col1.y=0,this.col2.y=0},b2Mat22.prototype.GetAngle=function(){return Math.atan2(this.col1.y,this.col1.x)},b2Mat22.prototype.GetInverse=function(a){var b=this.col1.x,c=this.col2.x,d=this.col1.y,e=this.col2.y,f=b*e-c*d;return 0!=f&&(f=1/f),a.col1.x=f*e,a.col2.x=-f*c,a.col1.y=-f*d,a.col2.y=f*b,a},b2Mat22.prototype.Solve=function(a,b,c){var d=this.col1.x,e=this.col2.x,f=this.col1.y,g=this.col2.y,h=d*g-e*f;return 0!=h&&(h=1/h),a.x=h*(g*b-e*c),a.y=h*(d*c-f*b),a},b2Mat22.prototype.Abs=function(){this.col1.Abs(),this.col2.Abs()},b2Mat22.prototype.col1=new b2Vec2,b2Mat22.prototype.col2=new b2Vec2;var b2SimplexCache=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2SimplexCache.prototype.__constructor=function(){},b2SimplexCache.prototype.__varz=function(){this.indexA=Array(3),this.indexB=Array(3)},b2SimplexCache.prototype.metric=null,b2SimplexCache.prototype.count=0,b2SimplexCache.prototype.indexA=Array(3),b2SimplexCache.prototype.indexB=Array(3);var b2Shape=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Shape.prototype.__constructor=function(){this.m_type=b2Shape.e_unknownShape,this.m_radius=b2Settings.b2_linearSlop},b2Shape.prototype.__varz=function(){},b2Shape.TestOverlap=function(a,b,c,d){var e=new b2DistanceInput;return e.proxyA=new b2DistanceProxy,e.proxyA.Set(a),e.proxyB=new b2DistanceProxy,e.proxyB.Set(c),e.transformA=b,e.transformB=d,e.useRadii=!0,a=new b2SimplexCache,a.count=0,b=new b2DistanceOutput,b2Distance.Distance(b,a,e),b.distance<10*Number.MIN_VALUE},b2Shape.e_hitCollide=1,b2Shape.e_missCollide=0,b2Shape.e_startsInsideCollide=-1,b2Shape.e_unknownShape=-1,b2Shape.e_circleShape=0,b2Shape.e_polygonShape=1,b2Shape.e_edgeShape=2,b2Shape.e_shapeTypeCount=3,b2Shape.prototype.Copy=function(){return null},b2Shape.prototype.Set=function(a){this.m_radius=a.m_radius},b2Shape.prototype.GetType=function(){return this.m_type},b2Shape.prototype.TestPoint=function(){return!1},b2Shape.prototype.RayCast=function(){return!1},b2Shape.prototype.ComputeAABB=function(){},b2Shape.prototype.ComputeMass=function(){},b2Shape.prototype.ComputeSubmergedArea=function(){return 0},b2Shape.prototype.m_type=0,b2Shape.prototype.m_radius=null;var b2Segment=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Segment.prototype.__constructor=function(){},b2Segment.prototype.__varz=function(){this.p1=new b2Vec2,this.p2=new b2Vec2},b2Segment.prototype.TestSegment=function(a,b,c,d){var e=c.p1,f=c.p2.x-e.x,g=c.p2.y-e.y;c=this.p2.y-this.p1.y;var h=-(this.p2.x-this.p1.x),i=100*Number.MIN_VALUE,j=-(f*c+g*h);if(j>i){var k=e.x-this.p1.x,l=e.y-this.p1.y;if(e=k*c+l*h,e>=0&&d*j>=e&&(d=-f*l+g*k,d>=-i*j&&j*(1+i)>=d))return e/=j,d=Math.sqrt(c*c+h*h),c/=d,h/=d,a[0]=e,b.Set(c,h),!0}return!1},b2Segment.prototype.Extend=function(a){this.ExtendForward(a),this.ExtendBackward(a)},b2Segment.prototype.ExtendForward=function(a){var b=this.p2.x-this.p1.x,c=this.p2.y-this.p1.y;a=Math.min(b>0?(a.upperBound.x-this.p1.x)/b:0>b?(a.lowerBound.x-this.p1.x)/b:Number.POSITIVE_INFINITY,c>0?(a.upperBound.y-this.p1.y)/c:0>c?(a.lowerBound.y-this.p1.y)/c:Number.POSITIVE_INFINITY),this.p2.x=this.p1.x+b*a,this.p2.y=this.p1.y+c*a},b2Segment.prototype.ExtendBackward=function(a){var b=-this.p2.x+this.p1.x,c=-this.p2.y+this.p1.y;a=Math.min(b>0?(a.upperBound.x-this.p2.x)/b:0>b?(a.lowerBound.x-this.p2.x)/b:Number.POSITIVE_INFINITY,c>0?(a.upperBound.y-this.p2.y)/c:0>c?(a.lowerBound.y-this.p2.y)/c:Number.POSITIVE_INFINITY),this.p1.x=this.p2.x+b*a,this.p1.y=this.p2.y+c*a},b2Segment.prototype.p1=new b2Vec2,b2Segment.prototype.p2=new b2Vec2;var b2ContactRegister=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ContactRegister.prototype.__constructor=function(){},b2ContactRegister.prototype.__varz=function(){},b2ContactRegister.prototype.createFcn=null,b2ContactRegister.prototype.destroyFcn=null,b2ContactRegister.prototype.primary=null,b2ContactRegister.prototype.pool=null,b2ContactRegister.prototype.poolCount=0;var b2DebugDraw=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2DebugDraw.prototype.__constructor=function(){this.m_drawFlags=0},b2DebugDraw.prototype.__varz=function(){},b2DebugDraw.e_shapeBit=1,b2DebugDraw.e_jointBit=2,b2DebugDraw.e_aabbBit=4,b2DebugDraw.e_pairBit=8,b2DebugDraw.e_centerOfMassBit=16,b2DebugDraw.e_controllerBit=32,b2DebugDraw.prototype.SetFlags=function(a){this.m_drawFlags=a},b2DebugDraw.prototype.GetFlags=function(){return this.m_drawFlags},b2DebugDraw.prototype.AppendFlags=function(a){this.m_drawFlags|=a},b2DebugDraw.prototype.ClearFlags=function(a){this.m_drawFlags&=~a},b2DebugDraw.prototype.SetSprite=function(a){this.m_sprite=a},b2DebugDraw.prototype.GetSprite=function(){return this.m_sprite},b2DebugDraw.prototype.SetDrawScale=function(a){this.m_drawScale=a},b2DebugDraw.prototype.GetDrawScale=function(){return this.m_drawScale},b2DebugDraw.prototype.SetLineThickness=function(a){this.m_lineThickness=a},b2DebugDraw.prototype.GetLineThickness=function(){return this.m_lineThickness},b2DebugDraw.prototype.SetAlpha=function(a){this.m_alpha=a},b2DebugDraw.prototype.GetAlpha=function(){return this.m_alpha},b2DebugDraw.prototype.SetFillAlpha=function(a){this.m_fillAlpha=a},b2DebugDraw.prototype.GetFillAlpha=function(){return this.m_fillAlpha},b2DebugDraw.prototype.SetXFormScale=function(a){this.m_xformScale=a},b2DebugDraw.prototype.GetXFormScale=function(){return this.m_xformScale},b2DebugDraw.prototype.Clear=function(){this.m_sprite.clearRect(0,0,this.m_sprite.canvas.width,this.m_sprite.canvas.height)},b2DebugDraw.prototype.Y=function(a){return this.m_sprite.canvas.height-a},b2DebugDraw.prototype.ToWorldPoint=function(a){return new b2Vec2(a.x/this.m_drawScale,this.Y(a.y)/this.m_drawScale)},b2DebugDraw.prototype.ColorStyle=function(a,b){return"rgba("+a.r+", "+a.g+", "+a.b+", "+b+")"},b2DebugDraw.prototype.DrawPolygon=function(a,b,c){for(this.m_sprite.graphics.lineStyle(this.m_lineThickness,c.color,this.m_alpha),this.m_sprite.graphics.moveTo(a[0].x*this.m_drawScale,a[0].y*this.m_drawScale),c=1;b>c;c++)this.m_sprite.graphics.lineTo(a[c].x*this.m_drawScale,a[c].y*this.m_drawScale);this.m_sprite.graphics.lineTo(a[0].x*this.m_drawScale,a[0].y*this.m_drawScale)},b2DebugDraw.prototype.DrawSolidPolygon=function(a,b,c){for(this.m_sprite.strokeSyle=this.ColorStyle(c,this.m_alpha),this.m_sprite.lineWidth=this.m_lineThickness,this.m_sprite.fillStyle=this.ColorStyle(c,this.m_fillAlpha),this.m_sprite.beginPath(),this.m_sprite.moveTo(a[0].x*this.m_drawScale,this.Y(a[0].y*this.m_drawScale)),c=1;b>c;c++)this.m_sprite.lineTo(a[c].x*this.m_drawScale,this.Y(a[c].y*this.m_drawScale));this.m_sprite.lineTo(a[0].x*this.m_drawScale,this.Y(a[0].y*this.m_drawScale)),this.m_sprite.fill(),this.m_sprite.stroke(),this.m_sprite.closePath()},b2DebugDraw.prototype.DrawCircle=function(a,b,c){this.m_sprite.graphics.lineStyle(this.m_lineThickness,c.color,this.m_alpha),this.m_sprite.graphics.drawCircle(a.x*this.m_drawScale,a.y*this.m_drawScale,b*this.m_drawScale)},b2DebugDraw.prototype.DrawSolidCircle=function(a,b,c,d){this.m_sprite.strokeSyle=this.ColorStyle(d,this.m_alpha),this.m_sprite.lineWidth=this.m_lineThickness,this.m_sprite.fillStyle=this.ColorStyle(d,this.m_fillAlpha),this.m_sprite.beginPath(),this.m_sprite.arc(a.x*this.m_drawScale,this.Y(a.y*this.m_drawScale),b*this.m_drawScale,0,2*Math.PI,!0),this.m_sprite.fill(),this.m_sprite.stroke(),this.m_sprite.closePath()},b2DebugDraw.prototype.DrawSegment=function(a,b,c){this.m_sprite.lineWidth=this.m_lineThickness,this.m_sprite.strokeSyle=this.ColorStyle(c,this.m_alpha),this.m_sprite.beginPath(),this.m_sprite.moveTo(a.x*this.m_drawScale,this.Y(a.y*this.m_drawScale)),this.m_sprite.lineTo(b.x*this.m_drawScale,this.Y(b.y*this.m_drawScale)),this.m_sprite.stroke(),this.m_sprite.closePath()},b2DebugDraw.prototype.DrawTransform=function(a){this.m_sprite.lineWidth=this.m_lineThickness,this.m_sprite.strokeSyle=this.ColorStyle(new b2Color(255,0,0),this.m_alpha),this.m_sprite.beginPath(),this.m_sprite.moveTo(a.position.x*this.m_drawScale,this.Y(a.position.y*this.m_drawScale)),this.m_sprite.lineTo((a.position.x+this.m_xformScale*a.R.col1.x)*this.m_drawScale,this.Y((a.position.y+this.m_xformScale*a.R.col1.y)*this.m_drawScale)),this.m_sprite.stroke(),this.m_sprite.closePath(),this.m_sprite.strokeSyle=this.ColorStyle(new b2Color(0,255,0),this.m_alpha),this.m_sprite.beginPath(),this.m_sprite.moveTo(a.position.x*this.m_drawScale,this.Y(a.position.y*this.m_drawScale)),this.m_sprite.lineTo((a.position.x+this.m_xformScale*a.R.col2.x)*this.m_drawScale,this.Y((a.position.y+this.m_xformScale*a.R.col2.y)*this.m_drawScale)),this.m_sprite.stroke(),this.m_sprite.closePath()},b2DebugDraw.prototype.m_drawFlags=0,b2DebugDraw.prototype.m_sprite=null,b2DebugDraw.prototype.m_drawScale=1,b2DebugDraw.prototype.m_lineThickness=1,b2DebugDraw.prototype.m_alpha=1,b2DebugDraw.prototype.m_fillAlpha=1,b2DebugDraw.prototype.m_xformScale=1;var b2Sweep=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Sweep.prototype.__constructor=function(){},b2Sweep.prototype.__varz=function(){this.localCenter=new b2Vec2,this.c0=new b2Vec2,this.c=new b2Vec2},b2Sweep.prototype.Set=function(a){this.localCenter.SetV(a.localCenter),this.c0.SetV(a.c0),this.c.SetV(a.c),this.a0=a.a0,this.a=a.a,this.t0=a.t0},b2Sweep.prototype.Copy=function(){var a=new b2Sweep;return a.localCenter.SetV(this.localCenter),a.c0.SetV(this.c0),a.c.SetV(this.c),a.a0=this.a0,a.a=this.a,a.t0=this.t0,a},b2Sweep.prototype.GetTransform=function(a,b){a.position.x=(1-b)*this.c0.x+b*this.c.x,a.position.y=(1-b)*this.c0.y+b*this.c.y,a.R.Set((1-b)*this.a0+b*this.a);var c=a.R;a.position.x-=c.col1.x*this.localCenter.x+c.col2.x*this.localCenter.y,a.position.y-=c.col1.y*this.localCenter.x+c.col2.y*this.localCenter.y},b2Sweep.prototype.Advance=function(a){if(this.t0<a&&1-this.t0>Number.MIN_VALUE){var b=(a-this.t0)/(1-this.t0);this.c0.x=(1-b)*this.c0.x+b*this.c.x,this.c0.y=(1-b)*this.c0.y+b*this.c.y,this.a0=(1-b)*this.a0+b*this.a,this.t0=a}},b2Sweep.prototype.localCenter=new b2Vec2,b2Sweep.prototype.c0=new b2Vec2,b2Sweep.prototype.c=new b2Vec2,b2Sweep.prototype.a0=null,b2Sweep.prototype.a=null,b2Sweep.prototype.t0=null;var b2DistanceOutput=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2DistanceOutput.prototype.__constructor=function(){},b2DistanceOutput.prototype.__varz=function(){this.pointA=new b2Vec2,this.pointB=new b2Vec2},b2DistanceOutput.prototype.pointA=new b2Vec2,b2DistanceOutput.prototype.pointB=new b2Vec2,b2DistanceOutput.prototype.distance=null,b2DistanceOutput.prototype.iterations=0;var b2Mat33=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Mat33.prototype.__constructor=function(a,b,c){a||b||c?(this.col1.SetV(a),this.col2.SetV(b),this.col3.SetV(c)):(this.col1.SetZero(),this.col2.SetZero(),this.col3.SetZero())},b2Mat33.prototype.__varz=function(){this.col1=new b2Vec3,this.col2=new b2Vec3,this.col3=new b2Vec3},b2Mat33.prototype.SetVVV=function(a,b,c){this.col1.SetV(a),this.col2.SetV(b),this.col3.SetV(c)},b2Mat33.prototype.Copy=function(){return new b2Mat33(this.col1,this.col2,this.col3)},b2Mat33.prototype.SetM=function(a){this.col1.SetV(a.col1),this.col2.SetV(a.col2),this.col3.SetV(a.col3)},b2Mat33.prototype.AddM=function(a){this.col1.x+=a.col1.x,this.col1.y+=a.col1.y,this.col1.z+=a.col1.z,this.col2.x+=a.col2.x,this.col2.y+=a.col2.y,this.col2.z+=a.col2.z,this.col3.x+=a.col3.x,this.col3.y+=a.col3.y,this.col3.z+=a.col3.z},b2Mat33.prototype.SetIdentity=function(){this.col1.x=1,this.col2.x=0,this.col3.x=0,this.col1.y=0,this.col2.y=1,this.col3.y=0,this.col1.z=0,this.col2.z=0,this.col3.z=1},b2Mat33.prototype.SetZero=function(){this.col1.x=0,this.col2.x=0,this.col3.x=0,this.col1.y=0,this.col2.y=0,this.col3.y=0,this.col1.z=0,this.col2.z=0,this.col3.z=0},b2Mat33.prototype.Solve22=function(a,b,c){var d=this.col1.x,e=this.col2.x,f=this.col1.y,g=this.col2.y,h=d*g-e*f;return 0!=h&&(h=1/h),a.x=h*(g*b-e*c),a.y=h*(d*c-f*b),a},b2Mat33.prototype.Solve33=function(a,b,c,d){var e=this.col1.x,f=this.col1.y,g=this.col1.z,h=this.col2.x,i=this.col2.y,j=this.col2.z,k=this.col3.x,l=this.col3.y,m=this.col3.z,n=e*(i*m-j*l)+f*(j*k-h*m)+g*(h*l-i*k);return 0!=n&&(n=1/n),a.x=n*(b*(i*m-j*l)+c*(j*k-h*m)+d*(h*l-i*k)),a.y=n*(e*(c*m-d*l)+f*(d*k-b*m)+g*(b*l-c*k)),a.z=n*(e*(i*d-j*c)+f*(j*b-h*d)+g*(h*c-i*b)),a},b2Mat33.prototype.col1=new b2Vec3,b2Mat33.prototype.col2=new b2Vec3,b2Mat33.prototype.col3=new b2Vec3;var b2PositionSolverManifold=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2PositionSolverManifold.prototype.__constructor=function(){this.m_normal=new b2Vec2,this.m_separations=Array(b2Settings.b2_maxManifoldPoints),this.m_points=Array(b2Settings.b2_maxManifoldPoints);for(var a=0;a<b2Settings.b2_maxManifoldPoints;a++)this.m_points[a]=new b2Vec2},b2PositionSolverManifold.prototype.__varz=function(){},b2PositionSolverManifold.circlePointA=new b2Vec2,b2PositionSolverManifold.circlePointB=new b2Vec2,b2PositionSolverManifold.prototype.Initialize=function(a){b2Settings.b2Assert(a.pointCount>0);var b,c,d,e,f,g=0;switch(a.type){case b2Manifold.e_circles:d=a.bodyA.m_xf.R,c=a.localPoint,g=a.bodyA.m_xf.position.x+(d.col1.x*c.x+d.col2.x*c.y),b=a.bodyA.m_xf.position.y+(d.col1.y*c.x+d.col2.y*c.y),d=a.bodyB.m_xf.R,c=a.points[0].localPoint,e=a.bodyB.m_xf.position.x+(d.col1.x*c.x+d.col2.x*c.y),d=a.bodyB.m_xf.position.y+(d.col1.y*c.x+d.col2.y*c.y),c=e-g,f=d-b;var h=c*c+f*f;h>Number.MIN_VALUE*Number.MIN_VALUE?(h=Math.sqrt(h),this.m_normal.x=c/h,this.m_normal.y=f/h):(this.m_normal.x=1,this.m_normal.y=0),this.m_points[0].x=.5*(g+e),this.m_points[0].y=.5*(b+d),this.m_separations[0]=c*this.m_normal.x+f*this.m_normal.y-a.radius;break;case b2Manifold.e_faceA:for(d=a.bodyA.m_xf.R,c=a.localPlaneNormal,this.m_normal.x=d.col1.x*c.x+d.col2.x*c.y,this.m_normal.y=d.col1.y*c.x+d.col2.y*c.y,d=a.bodyA.m_xf.R,c=a.localPoint,e=a.bodyA.m_xf.position.x+(d.col1.x*c.x+d.col2.x*c.y),f=a.bodyA.m_xf.position.y+(d.col1.y*c.x+d.col2.y*c.y),d=a.bodyB.m_xf.R,g=0;g<a.pointCount;++g)c=a.points[g].localPoint,b=a.bodyB.m_xf.position.x+(d.col1.x*c.x+d.col2.x*c.y),c=a.bodyB.m_xf.position.y+(d.col1.y*c.x+d.col2.y*c.y),this.m_separations[g]=(b-e)*this.m_normal.x+(c-f)*this.m_normal.y-a.radius,this.m_points[g].x=b,this.m_points[g].y=c;break;case b2Manifold.e_faceB:for(d=a.bodyB.m_xf.R,c=a.localPlaneNormal,this.m_normal.x=d.col1.x*c.x+d.col2.x*c.y,this.m_normal.y=d.col1.y*c.x+d.col2.y*c.y,d=a.bodyB.m_xf.R,c=a.localPoint,e=a.bodyB.m_xf.position.x+(d.col1.x*c.x+d.col2.x*c.y),f=a.bodyB.m_xf.position.y+(d.col1.y*c.x+d.col2.y*c.y),d=a.bodyA.m_xf.R,g=0;g<a.pointCount;++g)c=a.points[g].localPoint,b=a.bodyA.m_xf.position.x+(d.col1.x*c.x+d.col2.x*c.y),c=a.bodyA.m_xf.position.y+(d.col1.y*c.x+d.col2.y*c.y),this.m_separations[g]=(b-e)*this.m_normal.x+(c-f)*this.m_normal.y-a.radius,this.m_points[g].Set(b,c);this.m_normal.x*=-1,this.m_normal.y*=-1}},b2PositionSolverManifold.prototype.m_normal=null,b2PositionSolverManifold.prototype.m_points=null,b2PositionSolverManifold.prototype.m_separations=null;var b2OBB=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2OBB.prototype.__constructor=function(){},b2OBB.prototype.__varz=function(){this.R=new b2Mat22,this.center=new b2Vec2,this.extents=new b2Vec2},b2OBB.prototype.R=new b2Mat22,b2OBB.prototype.center=new b2Vec2,b2OBB.prototype.extents=new b2Vec2;var b2Pair=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Pair.prototype.__constructor=function(){},b2Pair.prototype.__varz=function(){},b2Pair.b2_nullProxy=b2Settings.USHRT_MAX,b2Pair.e_pairBuffered=1,b2Pair.e_pairRemoved=2,b2Pair.e_pairFinal=4,b2Pair.prototype.SetBuffered=function(){this.status|=b2Pair.e_pairBuffered},b2Pair.prototype.ClearBuffered=function(){this.status&=~b2Pair.e_pairBuffered},b2Pair.prototype.IsBuffered=function(){return(this.status&b2Pair.e_pairBuffered)==b2Pair.e_pairBuffered},b2Pair.prototype.SetRemoved=function(){this.status|=b2Pair.e_pairRemoved},b2Pair.prototype.ClearRemoved=function(){this.status&=~b2Pair.e_pairRemoved},b2Pair.prototype.IsRemoved=function(){return(this.status&b2Pair.e_pairRemoved)==b2Pair.e_pairRemoved},b2Pair.prototype.SetFinal=function(){this.status|=b2Pair.e_pairFinal},b2Pair.prototype.IsFinal=function(){return(this.status&b2Pair.e_pairFinal)==b2Pair.e_pairFinal},b2Pair.prototype.userData=null,b2Pair.prototype.proxy1=null,b2Pair.prototype.proxy2=null,b2Pair.prototype.next=null,b2Pair.prototype.status=0;var b2FixtureDef=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2FixtureDef.prototype.__constructor=function(){this.userData=this.shape=null,this.friction=.2,this.density=this.restitution=0,this.filter.categoryBits=1,this.filter.maskBits=65535,this.filter.groupIndex=0,this.isSensor=!1},b2FixtureDef.prototype.__varz=function(){this.filter=new b2FilterData},b2FixtureDef.prototype.shape=null,b2FixtureDef.prototype.userData=null,b2FixtureDef.prototype.friction=null,b2FixtureDef.prototype.restitution=null,b2FixtureDef.prototype.density=null,b2FixtureDef.prototype.isSensor=null,b2FixtureDef.prototype.filter=new b2FilterData;var b2ContactID=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ContactID.prototype.__constructor=function(){this.features._m_id=this},b2ContactID.prototype.__varz=function(){this.features=new Features},b2ContactID.prototype.Set=function(a){key=a._key},b2ContactID.prototype.Copy=function(){var a=new b2ContactID;return a.key=key,a},b2ContactID.prototype.__defineSetter__("key",function(){return this._key}),b2ContactID.prototype.__defineSetter__("key",function(a){this._key=a,this.features._referenceEdge=255&this._key,this.features._incidentEdge=(65280&this._key)>>8&255,this.features._incidentVertex=(16711680&this._key)>>16&255,this.features._flip=(4278190080&this._key)>>24&255}),b2ContactID.prototype._key=0,b2ContactID.prototype.features=new Features;var b2Transform=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Transform.prototype.__constructor=function(a,b){a&&(this.position.SetV(a),this.R.SetM(b))},b2Transform.prototype.__varz=function(){this.position=new b2Vec2,this.R=new b2Mat22},b2Transform.prototype.Initialize=function(a,b){this.position.SetV(a),this.R.SetM(b)},b2Transform.prototype.SetIdentity=function(){this.position.SetZero(),this.R.SetIdentity()},b2Transform.prototype.Set=function(a){this.position.SetV(a.position),this.R.SetM(a.R)},b2Transform.prototype.GetAngle=function(){return Math.atan2(this.R.col1.y,this.R.col1.x)},b2Transform.prototype.position=new b2Vec2,b2Transform.prototype.R=new b2Mat22;var b2EdgeShape=function(){b2Shape.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2EdgeShape.prototype,b2Shape.prototype),b2EdgeShape.prototype._super=b2Shape.prototype,b2EdgeShape.prototype.__constructor=function(a,b){this._super.__constructor.apply(this,[]),this.m_type=b2Shape.e_edgeShape,this.m_nextEdge=this.m_prevEdge=null,this.m_v1=a,this.m_v2=b,this.m_direction.Set(this.m_v2.x-this.m_v1.x,this.m_v2.y-this.m_v1.y),this.m_length=this.m_direction.Normalize(),this.m_normal.Set(this.m_direction.y,-this.m_direction.x),this.m_coreV1.Set(-b2Settings.b2_toiSlop*(this.m_normal.x-this.m_direction.x)+this.m_v1.x,-b2Settings.b2_toiSlop*(this.m_normal.y-this.m_direction.y)+this.m_v1.y),this.m_coreV2.Set(-b2Settings.b2_toiSlop*(this.m_normal.x+this.m_direction.x)+this.m_v2.x,-b2Settings.b2_toiSlop*(this.m_normal.y+this.m_direction.y)+this.m_v2.y),this.m_cornerDir1=this.m_normal,this.m_cornerDir2.Set(-this.m_normal.x,-this.m_normal.y)},b2EdgeShape.prototype.__varz=function(){this.s_supportVec=new b2Vec2,this.m_v1=new b2Vec2,this.m_v2=new b2Vec2,this.m_coreV1=new b2Vec2,this.m_coreV2=new b2Vec2,this.m_normal=new b2Vec2,this.m_direction=new b2Vec2,this.m_cornerDir1=new b2Vec2,this.m_cornerDir2=new b2Vec2},b2EdgeShape.prototype.SetPrevEdge=function(a,b,c,d){this.m_prevEdge=a,this.m_coreV1=b,this.m_cornerDir1=c,this.m_cornerConvex1=d},b2EdgeShape.prototype.SetNextEdge=function(a,b,c,d){this.m_nextEdge=a,this.m_coreV2=b,this.m_cornerDir2=c,this.m_cornerConvex2=d},b2EdgeShape.prototype.TestPoint=function(){return!1},b2EdgeShape.prototype.RayCast=function(a,b,c){var d,e=b.p2.x-b.p1.x,f=b.p2.y-b.p1.y;d=c.R;var g=c.position.x+(d.col1.x*this.m_v1.x+d.col2.x*this.m_v1.y),h=c.position.y+(d.col1.y*this.m_v1.x+d.col2.y*this.m_v1.y),i=c.position.y+(d.col1.y*this.m_v2.x+d.col2.y*this.m_v2.y)-h;c=-(c.position.x+(d.col1.x*this.m_v2.x+d.col2.x*this.m_v2.y)-g),d=100*Number.MIN_VALUE;var j=-(e*i+f*c);if(j>d){g=b.p1.x-g;var k=b.p1.y-h;if(h=g*i+k*c,h>=0&&h<=b.maxFraction*j&&(b=-e*k+f*g,b>=-d*j&&j*(1+d)>=b))return h/=j,a.fraction=h,b=Math.sqrt(i*i+c*c),a.normal.x=i/b,a.normal.y=c/b,!0}return!1},b2EdgeShape.prototype.ComputeAABB=function(a,b){var c=b.R,d=b.position.x+(c.col1.x*this.m_v1.x+c.col2.x*this.m_v1.y),e=b.position.y+(c.col1.y*this.m_v1.x+c.col2.y*this.m_v1.y),f=b.position.x+(c.col1.x*this.m_v2.x+c.col2.x*this.m_v2.y);c=b.position.y+(c.col1.y*this.m_v2.x+c.col2.y*this.m_v2.y),f>d?(a.lowerBound.x=d,a.upperBound.x=f):(a.lowerBound.x=f,a.upperBound.x=d),c>e?(a.lowerBound.y=e,a.upperBound.y=c):(a.lowerBound.y=c,a.upperBound.y=e)},b2EdgeShape.prototype.ComputeMass=function(a){a.mass=0,a.center.SetV(this.m_v1),a.I=0},b2EdgeShape.prototype.ComputeSubmergedArea=function(a,b,c,d){var e=new b2Vec2(a.x*b,a.y*b),f=b2Math.MulX(c,this.m_v1);c=b2Math.MulX(c,this.m_v2);var g=b2Math.Dot(a,f)-b;if(a=b2Math.Dot(a,c)-b,g>0){if(a>0)return 0;f.x=-a/(g-a)*f.x+g/(g-a)*c.x,f.y=-a/(g-a)*f.y+g/(g-a)*c.y}else a>0&&(c.x=-a/(g-a)*f.x+g/(g-a)*c.x,c.y=-a/(g-a)*f.y+g/(g-a)*c.y);return d.x=(e.x+f.x+c.x)/3,d.y=(e.y+f.y+c.y)/3,.5*((f.x-e.x)*(c.y-e.y)-(f.y-e.y)*(c.x-e.x))},b2EdgeShape.prototype.GetLength=function(){return this.m_length},b2EdgeShape.prototype.GetVertex1=function(){return this.m_v1},b2EdgeShape.prototype.GetVertex2=function(){return this.m_v2},b2EdgeShape.prototype.GetCoreVertex1=function(){return this.m_coreV1},b2EdgeShape.prototype.GetCoreVertex2=function(){return this.m_coreV2},b2EdgeShape.prototype.GetNormalVector=function(){return this.m_normal},b2EdgeShape.prototype.GetDirectionVector=function(){return this.m_direction},b2EdgeShape.prototype.GetCorner1Vector=function(){return this.m_cornerDir1},b2EdgeShape.prototype.GetCorner2Vector=function(){return this.m_cornerDir2},b2EdgeShape.prototype.Corner1IsConvex=function(){return this.m_cornerConvex1},b2EdgeShape.prototype.Corner2IsConvex=function(){return this.m_cornerConvex2},b2EdgeShape.prototype.GetFirstVertex=function(a){var b=a.R;return new b2Vec2(a.position.x+(b.col1.x*this.m_coreV1.x+b.col2.x*this.m_coreV1.y),a.position.y+(b.col1.y*this.m_coreV1.x+b.col2.y*this.m_coreV1.y))},b2EdgeShape.prototype.GetNextEdge=function(){return this.m_nextEdge},b2EdgeShape.prototype.GetPrevEdge=function(){return this.m_prevEdge},b2EdgeShape.prototype.Support=function(a,b,c){var d=a.R,e=a.position.x+(d.col1.x*this.m_coreV1.x+d.col2.x*this.m_coreV1.y),f=a.position.y+(d.col1.y*this.m_coreV1.x+d.col2.y*this.m_coreV1.y),g=a.position.x+(d.col1.x*this.m_coreV2.x+d.col2.x*this.m_coreV2.y);return a=a.position.y+(d.col1.y*this.m_coreV2.x+d.col2.y*this.m_coreV2.y),e*b+f*c>g*b+a*c?(this.s_supportVec.x=e,this.s_supportVec.y=f):(this.s_supportVec.x=g,this.s_supportVec.y=a),this.s_supportVec},b2EdgeShape.prototype.s_supportVec=new b2Vec2,b2EdgeShape.prototype.m_v1=new b2Vec2,b2EdgeShape.prototype.m_v2=new b2Vec2,b2EdgeShape.prototype.m_coreV1=new b2Vec2,b2EdgeShape.prototype.m_coreV2=new b2Vec2,b2EdgeShape.prototype.m_length=null,b2EdgeShape.prototype.m_normal=new b2Vec2,b2EdgeShape.prototype.m_direction=new b2Vec2,b2EdgeShape.prototype.m_cornerDir1=new b2Vec2,b2EdgeShape.prototype.m_cornerDir2=new b2Vec2,b2EdgeShape.prototype.m_cornerConvex1=null,b2EdgeShape.prototype.m_cornerConvex2=null,b2EdgeShape.prototype.m_nextEdge=null,b2EdgeShape.prototype.m_prevEdge=null;var b2BuoyancyController=function(){b2Controller.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2BuoyancyController.prototype,b2Controller.prototype),b2BuoyancyController.prototype._super=b2Controller.prototype,b2BuoyancyController.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments)},b2BuoyancyController.prototype.__varz=function(){this.normal=new b2Vec2(0,-1),this.velocity=new b2Vec2(0,0)
},b2BuoyancyController.prototype.Step=function(){if(m_bodyList){this.useWorldGravity&&(this.gravity=this.GetWorld().GetGravity().Copy());for(var a=m_bodyList;a;a=a.nextBody){var b=a.body;if(0!=b.IsAwake()){for(var c=new b2Vec2,d=new b2Vec2,e=0,f=0,g=b.GetFixtureList();g;g=g.GetNext()){var h=new b2Vec2,i=g.GetShape().ComputeSubmergedArea(this.normal,this.offset,b.GetTransform(),h);e+=i,c.x+=i*h.x,c.y+=i*h.y,f+=1*i,d.x+=i*h.x*1,d.y+=i*h.y*1}c.x/=e,c.y/=e,d.x/=f,d.y/=f,e<Number.MIN_VALUE||(f=this.gravity.GetNegative(),f.Multiply(this.density*e),b.ApplyForce(f,d),d=b.GetLinearVelocityFromWorldPoint(c),d.Subtract(this.velocity),d.Multiply(-this.linearDrag*e),b.ApplyForce(d,c),b.ApplyTorque(-b.GetInertia()/b.GetMass()*e*b.GetAngularVelocity()*this.angularDrag))}}}},b2BuoyancyController.prototype.Draw=function(a){var b=new b2Vec2,c=new b2Vec2;b.x=this.normal.x*this.offset+1e3*this.normal.y,b.y=this.normal.y*this.offset-1e3*this.normal.x,c.x=this.normal.x*this.offset-1e3*this.normal.y,c.y=this.normal.y*this.offset+1e3*this.normal.x;var d=new b2Color(0,0,1);a.DrawSegment(b,c,d)},b2BuoyancyController.prototype.normal=new b2Vec2(0,-1),b2BuoyancyController.prototype.offset=0,b2BuoyancyController.prototype.density=0,b2BuoyancyController.prototype.velocity=new b2Vec2(0,0),b2BuoyancyController.prototype.linearDrag=2,b2BuoyancyController.prototype.angularDrag=1,b2BuoyancyController.prototype.useDensity=!1,b2BuoyancyController.prototype.useWorldGravity=!0,b2BuoyancyController.prototype.gravity=null;var b2Body=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Body.prototype.__constructor=function(a,b){this.m_flags=0,a.bullet&&(this.m_flags|=b2Body.e_bulletFlag),a.fixedRotation&&(this.m_flags|=b2Body.e_fixedRotationFlag),a.allowSleep&&(this.m_flags|=b2Body.e_allowSleepFlag),a.awake&&(this.m_flags|=b2Body.e_awakeFlag),a.active&&(this.m_flags|=b2Body.e_activeFlag),this.m_world=b,this.m_xf.position.SetV(a.position),this.m_xf.R.Set(a.angle),this.m_sweep.localCenter.SetZero(),this.m_sweep.t0=1,this.m_sweep.a0=this.m_sweep.a=a.angle;var c=this.m_xf.R,d=this.m_sweep.localCenter;this.m_sweep.c.x=c.col1.x*d.x+c.col2.x*d.y,this.m_sweep.c.y=c.col1.y*d.x+c.col2.y*d.y,this.m_sweep.c.x+=this.m_xf.position.x,this.m_sweep.c.y+=this.m_xf.position.y,this.m_sweep.c0.SetV(this.m_sweep.c),this.m_contactList=this.m_controllerList=this.m_jointList=null,this.m_controllerCount=0,this.m_next=this.m_prev=null,this.m_linearVelocity.SetV(a.linearVelocity),this.m_angularVelocity=a.angularVelocity,this.m_linearDamping=a.linearDamping,this.m_angularDamping=a.angularDamping,this.m_force.Set(0,0),this.m_sleepTime=this.m_torque=0,this.m_type=a.type,this.m_invMass=this.m_mass=this.m_type==b2Body.b2_dynamicBody?1:0,this.m_invI=this.m_I=0,this.m_inertiaScale=a.inertiaScale,this.m_userData=a.userData,this.m_fixtureList=null,this.m_fixtureCount=0},b2Body.prototype.__varz=function(){this.m_xf=new b2Transform,this.m_sweep=new b2Sweep,this.m_linearVelocity=new b2Vec2,this.m_force=new b2Vec2},b2Body.b2_staticBody=0,b2Body.b2_kinematicBody=1,b2Body.b2_dynamicBody=2,b2Body.s_xf1=new b2Transform,b2Body.e_islandFlag=1,b2Body.e_awakeFlag=2,b2Body.e_allowSleepFlag=4,b2Body.e_bulletFlag=8,b2Body.e_fixedRotationFlag=16,b2Body.e_activeFlag=32,b2Body.prototype.connectEdges=function(a,b,c){var d=Math.atan2(b.GetDirectionVector().y,b.GetDirectionVector().x);c=b2Math.MulFV(Math.tan(.5*(d-c)),b.GetDirectionVector()),c=b2Math.SubtractVV(c,b.GetNormalVector()),c=b2Math.MulFV(b2Settings.b2_toiSlop,c),c=b2Math.AddVV(c,b.GetVertex1());var e=b2Math.AddVV(a.GetDirectionVector(),b.GetDirectionVector());e.Normalize();var f=b2Math.Dot(a.GetDirectionVector(),b.GetNormalVector())>0;return a.SetNextEdge(b,c,e,f),b.SetPrevEdge(a,c,e,f),d},b2Body.prototype.SynchronizeFixtures=function(){var a=b2Body.s_xf1;a.R.Set(this.m_sweep.a0);var b=a.R,c=this.m_sweep.localCenter;for(a.position.x=this.m_sweep.c0.x-(b.col1.x*c.x+b.col2.x*c.y),a.position.y=this.m_sweep.c0.y-(b.col1.y*c.x+b.col2.y*c.y),c=this.m_world.m_contactManager.m_broadPhase,b=this.m_fixtureList;b;b=b.m_next)b.Synchronize(c,a,this.m_xf)},b2Body.prototype.SynchronizeTransform=function(){this.m_xf.R.Set(this.m_sweep.a);var a=this.m_xf.R,b=this.m_sweep.localCenter;this.m_xf.position.x=this.m_sweep.c.x-(a.col1.x*b.x+a.col2.x*b.y),this.m_xf.position.y=this.m_sweep.c.y-(a.col1.y*b.x+a.col2.y*b.y)},b2Body.prototype.ShouldCollide=function(a){if(this.m_type!=b2Body.b2_dynamicBody&&a.m_type!=b2Body.b2_dynamicBody)return!1;for(var b=this.m_jointList;b;b=b.next)if(b.other==a&&0==b.joint.m_collideConnected)return!1;return!0},b2Body.prototype.Advance=function(a){this.m_sweep.Advance(a),this.m_sweep.c.SetV(this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.SynchronizeTransform()},b2Body.prototype.CreateFixture=function(a){if(1==this.m_world.IsLocked())return null;var b=new b2Fixture;return b.Create(this,this.m_xf,a),this.m_flags&b2Body.e_activeFlag&&b.CreateProxy(this.m_world.m_contactManager.m_broadPhase,this.m_xf),b.m_next=this.m_fixtureList,this.m_fixtureList=b,++this.m_fixtureCount,b.m_body=this,b.m_density>0&&this.ResetMassData(),this.m_world.m_flags|=b2World.e_newFixture,b},b2Body.prototype.CreateFixture2=function(a,b){var c=new b2FixtureDef;return c.shape=a,c.density=b,this.CreateFixture(c)},b2Body.prototype.DestroyFixture=function(a){if(1!=this.m_world.IsLocked()){for(var b=this.m_fixtureList,c=null;null!=b;){if(b==a){c?c.m_next=a.m_next:this.m_fixtureList=a.m_next;break}c=b,b=b.m_next}for(b=this.m_contactList;b;){c=b.contact,b=b.next;var d=c.GetFixtureA(),e=c.GetFixtureB();(a==d||a==e)&&this.m_world.m_contactManager.Destroy(c)}this.m_flags&b2Body.e_activeFlag&&a.DestroyProxy(this.m_world.m_contactManager.m_broadPhase),a.Destroy(),a.m_body=null,a.m_next=null,--this.m_fixtureCount,this.ResetMassData()}},b2Body.prototype.SetPositionAndAngle=function(a,b){var c;if(1!=this.m_world.IsLocked()){this.m_xf.R.Set(b),this.m_xf.position.SetV(a),c=this.m_xf.R;var d=this.m_sweep.localCenter;for(this.m_sweep.c.x=c.col1.x*d.x+c.col2.x*d.y,this.m_sweep.c.y=c.col1.y*d.x+c.col2.y*d.y,this.m_sweep.c.x+=this.m_xf.position.x,this.m_sweep.c.y+=this.m_xf.position.y,this.m_sweep.c0.SetV(this.m_sweep.c),this.m_sweep.a0=this.m_sweep.a=b,d=this.m_world.m_contactManager.m_broadPhase,c=this.m_fixtureList;c;c=c.m_next)c.Synchronize(d,this.m_xf,this.m_xf);this.m_world.m_contactManager.FindNewContacts()}},b2Body.prototype.SetTransform=function(a){this.SetPositionAndAngle(a.position,a.GetAngle())},b2Body.prototype.GetTransform=function(){return this.m_xf},b2Body.prototype.GetPosition=function(){return this.m_xf.position},b2Body.prototype.SetPosition=function(a){this.SetPositionAndAngle(a,this.GetAngle())},b2Body.prototype.GetAngle=function(){return this.m_sweep.a},b2Body.prototype.SetAngle=function(a){this.SetPositionAndAngle(this.GetPosition(),a)},b2Body.prototype.GetWorldCenter=function(){return this.m_sweep.c},b2Body.prototype.GetLocalCenter=function(){return this.m_sweep.localCenter},b2Body.prototype.SetLinearVelocity=function(a){this.m_type!=b2Body.b2_staticBody&&this.m_linearVelocity.SetV(a)},b2Body.prototype.GetLinearVelocity=function(){return this.m_linearVelocity},b2Body.prototype.SetAngularVelocity=function(a){this.m_type!=b2Body.b2_staticBody&&(this.m_angularVelocity=a)},b2Body.prototype.GetAngularVelocity=function(){return this.m_angularVelocity},b2Body.prototype.GetDefinition=function(){var a=new b2BodyDef;return a.type=this.GetType(),a.allowSleep=(this.m_flags&b2Body.e_allowSleepFlag)==b2Body.e_allowSleepFlag,a.angle=this.GetAngle(),a.angularDamping=this.m_angularDamping,a.angularVelocity=this.m_angularVelocity,a.fixedRotation=(this.m_flags&b2Body.e_fixedRotationFlag)==b2Body.e_fixedRotationFlag,a.bullet=(this.m_flags&b2Body.e_bulletFlag)==b2Body.e_bulletFlag,a.awake=(this.m_flags&b2Body.e_awakeFlag)==b2Body.e_awakeFlag,a.linearDamping=this.m_linearDamping,a.linearVelocity.SetV(this.GetLinearVelocity()),a.position=this.GetPosition(),a.userData=this.GetUserData(),a},b2Body.prototype.ApplyForce=function(a,b){this.m_type==b2Body.b2_dynamicBody&&(0==this.IsAwake()&&this.SetAwake(!0),this.m_force.x+=a.x,this.m_force.y+=a.y,this.m_torque+=(b.x-this.m_sweep.c.x)*a.y-(b.y-this.m_sweep.c.y)*a.x)},b2Body.prototype.ApplyTorque=function(a){this.m_type==b2Body.b2_dynamicBody&&(0==this.IsAwake()&&this.SetAwake(!0),this.m_torque+=a)},b2Body.prototype.ApplyImpulse=function(a,b){this.m_type==b2Body.b2_dynamicBody&&(0==this.IsAwake()&&this.SetAwake(!0),this.m_linearVelocity.x+=this.m_invMass*a.x,this.m_linearVelocity.y+=this.m_invMass*a.y,this.m_angularVelocity+=this.m_invI*((b.x-this.m_sweep.c.x)*a.y-(b.y-this.m_sweep.c.y)*a.x))},b2Body.prototype.Split=function(a){for(var b,c=this.GetLinearVelocity().Copy(),d=this.GetAngularVelocity(),e=this.GetWorldCenter(),f=this.m_world.CreateBody(this.GetDefinition()),g=this.m_fixtureList;g;)if(a(g)){var h=g.m_next;b?b.m_next=h:this.m_fixtureList=h,this.m_fixtureCount--,g.m_next=f.m_fixtureList,f.m_fixtureList=g,f.m_fixtureCount++,g.m_body=f,g=h}else b=g,g=g.m_next;return this.ResetMassData(),f.ResetMassData(),b=this.GetWorldCenter(),a=f.GetWorldCenter(),b=b2Math.AddVV(c,b2Math.CrossFV(d,b2Math.SubtractVV(b,e))),c=b2Math.AddVV(c,b2Math.CrossFV(d,b2Math.SubtractVV(a,e))),this.SetLinearVelocity(b),f.SetLinearVelocity(c),this.SetAngularVelocity(d),f.SetAngularVelocity(d),this.SynchronizeFixtures(),f.SynchronizeFixtures(),f},b2Body.prototype.Merge=function(a){var b;for(b=a.m_fixtureList;b;){var c=b.m_next;a.m_fixtureCount--,b.m_next=this.m_fixtureList,this.m_fixtureList=b,this.m_fixtureCount++,b.m_body=e,b=c}d.m_fixtureCount=0;var d=this,e=a;d.GetWorldCenter(),e.GetWorldCenter(),d.GetLinearVelocity().Copy(),e.GetLinearVelocity().Copy(),d.GetAngularVelocity(),e.GetAngularVelocity(),d.ResetMassData(),this.SynchronizeFixtures()},b2Body.prototype.GetMass=function(){return this.m_mass},b2Body.prototype.GetInertia=function(){return this.m_I},b2Body.prototype.GetMassData=function(a){a.mass=this.m_mass,a.I=this.m_I,a.center.SetV(this.m_sweep.localCenter)},b2Body.prototype.SetMassData=function(a){if(b2Settings.b2Assert(0==this.m_world.IsLocked()),1!=this.m_world.IsLocked()&&this.m_type==b2Body.b2_dynamicBody){this.m_invI=this.m_I=this.m_invMass=0,this.m_mass=a.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,a.I>0&&0==(this.m_flags&b2Body.e_fixedRotationFlag)&&(this.m_I=a.I-this.m_mass*(a.center.x*a.center.x+a.center.y*a.center.y),this.m_invI=1/this.m_I);var b=this.m_sweep.c.Copy();this.m_sweep.localCenter.SetV(a.center),this.m_sweep.c0.SetV(b2Math.MulX(this.m_xf,this.m_sweep.localCenter)),this.m_sweep.c.SetV(this.m_sweep.c0),this.m_linearVelocity.x+=this.m_angularVelocity*-(this.m_sweep.c.y-b.y),this.m_linearVelocity.y+=this.m_angularVelocity*+(this.m_sweep.c.x-b.x)}},b2Body.prototype.ResetMassData=function(){if(this.m_invI=this.m_I=this.m_invMass=this.m_mass=0,this.m_sweep.localCenter.SetZero(),this.m_type!=b2Body.b2_staticBody&&this.m_type!=b2Body.b2_kinematicBody){for(var a=b2Vec2.Make(0,0),b=this.m_fixtureList;b;b=b.m_next)if(0!=b.m_density){var c=b.GetMassData();this.m_mass+=c.mass,a.x+=c.center.x*c.mass,a.y+=c.center.y*c.mass,this.m_I+=c.I}this.m_mass>0?(this.m_invMass=1/this.m_mass,a.x*=this.m_invMass,a.y*=this.m_invMass):this.m_invMass=this.m_mass=1,this.m_I>0&&0==(this.m_flags&b2Body.e_fixedRotationFlag)?(this.m_I-=this.m_mass*(a.x*a.x+a.y*a.y),this.m_I*=this.m_inertiaScale,b2Settings.b2Assert(this.m_I>0),this.m_invI=1/this.m_I):this.m_invI=this.m_I=0,b=this.m_sweep.c.Copy(),this.m_sweep.localCenter.SetV(a),this.m_sweep.c0.SetV(b2Math.MulX(this.m_xf,this.m_sweep.localCenter)),this.m_sweep.c.SetV(this.m_sweep.c0),this.m_linearVelocity.x+=this.m_angularVelocity*-(this.m_sweep.c.y-b.y),this.m_linearVelocity.y+=this.m_angularVelocity*+(this.m_sweep.c.x-b.x)}},b2Body.prototype.GetWorldPoint=function(a){var b=this.m_xf.R;return a=new b2Vec2(b.col1.x*a.x+b.col2.x*a.y,b.col1.y*a.x+b.col2.y*a.y),a.x+=this.m_xf.position.x,a.y+=this.m_xf.position.y,a},b2Body.prototype.GetWorldVector=function(a){return b2Math.MulMV(this.m_xf.R,a)},b2Body.prototype.GetLocalPoint=function(a){return b2Math.MulXT(this.m_xf,a)},b2Body.prototype.GetLocalVector=function(a){return b2Math.MulTMV(this.m_xf.R,a)},b2Body.prototype.GetLinearVelocityFromWorldPoint=function(a){return new b2Vec2(this.m_linearVelocity.x-this.m_angularVelocity*(a.y-this.m_sweep.c.y),this.m_linearVelocity.y+this.m_angularVelocity*(a.x-this.m_sweep.c.x))},b2Body.prototype.GetLinearVelocityFromLocalPoint=function(a){var b=this.m_xf.R;return a=new b2Vec2(b.col1.x*a.x+b.col2.x*a.y,b.col1.y*a.x+b.col2.y*a.y),a.x+=this.m_xf.position.x,a.y+=this.m_xf.position.y,new b2Vec2(this.m_linearVelocity.x-this.m_angularVelocity*(a.y-this.m_sweep.c.y),this.m_linearVelocity.y+this.m_angularVelocity*(a.x-this.m_sweep.c.x))},b2Body.prototype.GetLinearDamping=function(){return this.m_linearDamping},b2Body.prototype.SetLinearDamping=function(a){this.m_linearDamping=a},b2Body.prototype.GetAngularDamping=function(){return this.m_angularDamping},b2Body.prototype.SetAngularDamping=function(a){this.m_angularDamping=a},b2Body.prototype.SetType=function(a){if(this.m_type!=a)for(this.m_type=a,this.ResetMassData(),this.m_type==b2Body.b2_staticBody&&(this.m_linearVelocity.SetZero(),this.m_angularVelocity=0),this.SetAwake(!0),this.m_force.SetZero(),this.m_torque=0,a=this.m_contactList;a;a=a.next)a.contact.FlagForFiltering()},b2Body.prototype.GetType=function(){return this.m_type},b2Body.prototype.SetBullet=function(a){a?this.m_flags|=b2Body.e_bulletFlag:this.m_flags&=~b2Body.e_bulletFlag},b2Body.prototype.IsBullet=function(){return(this.m_flags&b2Body.e_bulletFlag)==b2Body.e_bulletFlag},b2Body.prototype.SetSleepingAllowed=function(a){a?this.m_flags|=b2Body.e_allowSleepFlag:(this.m_flags&=~b2Body.e_allowSleepFlag,this.SetAwake(!0))},b2Body.prototype.SetAwake=function(a){a?(this.m_flags|=b2Body.e_awakeFlag,this.m_sleepTime=0):(this.m_flags&=~b2Body.e_awakeFlag,this.m_sleepTime=0,this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_force.SetZero(),this.m_torque=0)},b2Body.prototype.IsAwake=function(){return(this.m_flags&b2Body.e_awakeFlag)==b2Body.e_awakeFlag},b2Body.prototype.SetFixedRotation=function(a){a?this.m_flags|=b2Body.e_fixedRotationFlag:this.m_flags&=~b2Body.e_fixedRotationFlag,this.ResetMassData()},b2Body.prototype.IsFixedRotation=function(){return(this.m_flags&b2Body.e_fixedRotationFlag)==b2Body.e_fixedRotationFlag},b2Body.prototype.SetActive=function(a){if(a!=this.IsActive()){var b;if(a)for(this.m_flags|=b2Body.e_activeFlag,a=this.m_world.m_contactManager.m_broadPhase,b=this.m_fixtureList;b;b=b.m_next)b.CreateProxy(a,this.m_xf);else{for(this.m_flags&=~b2Body.e_activeFlag,a=this.m_world.m_contactManager.m_broadPhase,b=this.m_fixtureList;b;b=b.m_next)b.DestroyProxy(a);for(a=this.m_contactList;a;)b=a,a=a.next,this.m_world.m_contactManager.Destroy(b.contact);this.m_contactList=null}}},b2Body.prototype.IsActive=function(){return(this.m_flags&b2Body.e_activeFlag)==b2Body.e_activeFlag},b2Body.prototype.IsSleepingAllowed=function(){return(this.m_flags&b2Body.e_allowSleepFlag)==b2Body.e_allowSleepFlag},b2Body.prototype.GetFixtureList=function(){return this.m_fixtureList},b2Body.prototype.GetJointList=function(){return this.m_jointList},b2Body.prototype.GetControllerList=function(){return this.m_controllerList},b2Body.prototype.GetContactList=function(){return this.m_contactList},b2Body.prototype.GetNext=function(){return this.m_next},b2Body.prototype.GetUserData=function(){return this.m_userData},b2Body.prototype.SetUserData=function(a){this.m_userData=a},b2Body.prototype.GetWorld=function(){return this.m_world},b2Body.prototype.m_flags=0,b2Body.prototype.m_type=0,b2Body.prototype.m_islandIndex=0,b2Body.prototype.m_xf=new b2Transform,b2Body.prototype.m_sweep=new b2Sweep,b2Body.prototype.m_linearVelocity=new b2Vec2,b2Body.prototype.m_angularVelocity=null,b2Body.prototype.m_force=new b2Vec2,b2Body.prototype.m_torque=null,b2Body.prototype.m_world=null,b2Body.prototype.m_prev=null,b2Body.prototype.m_next=null,b2Body.prototype.m_fixtureList=null,b2Body.prototype.m_fixtureCount=0,b2Body.prototype.m_controllerList=null,b2Body.prototype.m_controllerCount=0,b2Body.prototype.m_jointList=null,b2Body.prototype.m_contactList=null,b2Body.prototype.m_mass=null,b2Body.prototype.m_invMass=null,b2Body.prototype.m_I=null,b2Body.prototype.m_invI=null,b2Body.prototype.m_inertiaScale=null,b2Body.prototype.m_linearDamping=null,b2Body.prototype.m_angularDamping=null,b2Body.prototype.m_sleepTime=null,b2Body.prototype.m_userData=null;var b2ContactImpulse=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ContactImpulse.prototype.__constructor=function(){},b2ContactImpulse.prototype.__varz=function(){this.normalImpulses=Array(b2Settings.b2_maxManifoldPoints),this.tangentImpulses=Array(b2Settings.b2_maxManifoldPoints)},b2ContactImpulse.prototype.normalImpulses=Array(b2Settings.b2_maxManifoldPoints),b2ContactImpulse.prototype.tangentImpulses=Array(b2Settings.b2_maxManifoldPoints);var b2TensorDampingController=function(){b2Controller.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2TensorDampingController.prototype,b2Controller.prototype),b2TensorDampingController.prototype._super=b2Controller.prototype,b2TensorDampingController.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments)},b2TensorDampingController.prototype.__varz=function(){this.T=new b2Mat22},b2TensorDampingController.prototype.SetAxisAligned=function(a,b){this.T.col1.x=-a,this.T.col1.y=0,this.T.col2.x=0,this.T.col2.y=-b,this.maxTimestep=a>0||b>0?1/Math.max(a,b):0},b2TensorDampingController.prototype.Step=function(a){if(a=a.dt,!(a<=Number.MIN_VALUE)){a>this.maxTimestep&&this.maxTimestep>0&&(a=this.maxTimestep);for(var b=m_bodyList;b;b=b.nextBody){var c=b.body;if(c.IsAwake()){var d=c.GetWorldVector(b2Math.MulMV(this.T,c.GetLocalVector(c.GetLinearVelocity())));c.SetLinearVelocity(new b2Vec2(c.GetLinearVelocity().x+d.x*a,c.GetLinearVelocity().y+d.y*a))}}}},b2TensorDampingController.prototype.T=new b2Mat22,b2TensorDampingController.prototype.maxTimestep=0;var b2ManifoldPoint=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ManifoldPoint.prototype.__constructor=function(){this.Reset()},b2ManifoldPoint.prototype.__varz=function(){this.m_localPoint=new b2Vec2,this.m_id=new b2ContactID},b2ManifoldPoint.prototype.Reset=function(){this.m_localPoint.SetZero(),this.m_tangentImpulse=this.m_normalImpulse=0,this.m_id.key=0},b2ManifoldPoint.prototype.Set=function(a){this.m_localPoint.SetV(a.m_localPoint),this.m_normalImpulse=a.m_normalImpulse,this.m_tangentImpulse=a.m_tangentImpulse,this.m_id.Set(a.m_id)},b2ManifoldPoint.prototype.m_localPoint=new b2Vec2,b2ManifoldPoint.prototype.m_normalImpulse=null,b2ManifoldPoint.prototype.m_tangentImpulse=null,b2ManifoldPoint.prototype.m_id=new b2ContactID;var b2PolygonShape=function(){b2Shape.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2PolygonShape.prototype,b2Shape.prototype),b2PolygonShape.prototype._super=b2Shape.prototype,b2PolygonShape.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments),this.m_type=b2Shape.e_polygonShape,this.m_centroid=new b2Vec2,this.m_vertices=[],this.m_normals=[]},b2PolygonShape.prototype.__varz=function(){},b2PolygonShape.AsArray=function(a,b){var c=new b2PolygonShape;return c.SetAsArray(a,b),c},b2PolygonShape.AsVector=function(a,b){var c=new b2PolygonShape;return c.SetAsVector(a,b),c},b2PolygonShape.AsBox=function(a,b){var c=new b2PolygonShape;return c.SetAsBox(a,b),c},b2PolygonShape.AsOrientedBox=function(a,b,c,d){var e=new b2PolygonShape;return e.SetAsOrientedBox(a,b,c,d),e},b2PolygonShape.AsEdge=function(a,b){var c=new b2PolygonShape;return c.SetAsEdge(a,b),c},b2PolygonShape.ComputeCentroid=function(a,b){for(var c=new b2Vec2,d=0,e=1/3,f=0;b>f;++f){var g=a[f],h=b>f+1?a[parseInt(f+1)]:a[0],i=.5*((g.x-0)*(h.y-0)-(g.y-0)*(h.x-0));d+=i,c.x+=i*e*(0+g.x+h.x),c.y+=i*e*(0+g.y+h.y)}return c.x*=1/d,c.y*=1/d,c},b2PolygonShape.ComputeOBB=function(a,b,c){var d=0,e=Array(c+1);for(d=0;c>d;++d)e[d]=b[d];for(e[c]=e[0],b=Number.MAX_VALUE,d=1;c>=d;++d){var f=e[parseInt(d-1)],g=e[d].x-f.x,h=e[d].y-f.y,i=Math.sqrt(g*g+h*h);g/=i,h/=i;for(var j=-h,k=g,l=i=Number.MAX_VALUE,m=-Number.MAX_VALUE,n=-Number.MAX_VALUE,o=0;c>o;++o){var p=e[o].x-f.x,q=e[o].y-f.y,r=g*p+h*q;p=j*p+k*q,i>r&&(i=r),l>p&&(l=p),r>m&&(m=r),p>n&&(n=p)}o=(m-i)*(n-l),.95*b>o&&(b=o,a.R.col1.x=g,a.R.col1.y=h,a.R.col2.x=j,a.R.col2.y=k,g=.5*(i+m),h=.5*(l+n),j=a.R,a.center.x=f.x+(j.col1.x*g+j.col2.x*h),a.center.y=f.y+(j.col1.y*g+j.col2.y*h),a.extents.x=.5*(m-i),a.extents.y=.5*(n-l))}},b2PolygonShape.s_mat=new b2Mat22,b2PolygonShape.prototype.Validate=function(){return!1},b2PolygonShape.prototype.Reserve=function(a){for(var b=this.m_vertices.length;a>b;b++)this.m_vertices[b]=new b2Vec2,this.m_normals[b]=new b2Vec2},b2PolygonShape.prototype.Copy=function(){var a=new b2PolygonShape;return a.Set(this),a},b2PolygonShape.prototype.Set=function(a){if(this._super.Set.apply(this,[a]),isInstanceOf(a,b2PolygonShape)){this.m_centroid.SetV(a.m_centroid),this.m_vertexCount=a.m_vertexCount,this.Reserve(this.m_vertexCount);for(var b=0;b<this.m_vertexCount;b++)this.m_vertices[b].SetV(a.m_vertices[b]),this.m_normals[b].SetV(a.m_normals[b])}},b2PolygonShape.prototype.SetAsArray=function(a,b){for(var c=[],d=0,e=null;e=a[d];d++)c.push(e);this.SetAsVector(c,b)},b2PolygonShape.prototype.SetAsVector=function(a,b){"undefined"==typeof b&&(b=a.length),b2Settings.b2Assert(b>=2),this.m_vertexCount=b,this.Reserve(b);var c=0;for(c=0;c<this.m_vertexCount;c++)this.m_vertices[c].SetV(a[c]);for(c=0;c<this.m_vertexCount;++c){var d=b2Math.SubtractVV(this.m_vertices[c+1<this.m_vertexCount?c+1:0],this.m_vertices[c]);b2Settings.b2Assert(d.LengthSquared()>Number.MIN_VALUE),this.m_normals[c].SetV(b2Math.CrossVF(d,1)),this.m_normals[c].Normalize()}this.m_centroid=b2PolygonShape.ComputeCentroid(this.m_vertices,this.m_vertexCount)},b2PolygonShape.prototype.SetAsBox=function(a,b){this.m_vertexCount=4,this.Reserve(4),this.m_vertices[0].Set(-a,-b),this.m_vertices[1].Set(a,-b),this.m_vertices[2].Set(a,b),this.m_vertices[3].Set(-a,b),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid.SetZero()},b2PolygonShape.prototype.SetAsOrientedBox=function(a,b,c,d){for(this.m_vertexCount=4,this.Reserve(4),this.m_vertices[0].Set(-a,-b),this.m_vertices[1].Set(a,-b),this.m_vertices[2].Set(a,b),this.m_vertices[3].Set(-a,b),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid=c,a=new b2Transform,a.position=c,a.R.Set(d),c=0;c<this.m_vertexCount;++c)this.m_vertices[c]=b2Math.MulX(a,this.m_vertices[c]),this.m_normals[c]=b2Math.MulMV(a.R,this.m_normals[c])},b2PolygonShape.prototype.SetAsEdge=function(a,b){this.m_vertexCount=2,this.Reserve(2),this.m_vertices[0].SetV(a),this.m_vertices[1].SetV(b),this.m_centroid.x=.5*(a.x+b.x),this.m_centroid.y=.5*(a.y+b.y),this.m_normals[0]=b2Math.CrossVF(b2Math.SubtractVV(b,a),1),this.m_normals[0].Normalize(),this.m_normals[1].x=-this.m_normals[0].x,this.m_normals[1].y=-this.m_normals[0].y},b2PolygonShape.prototype.TestPoint=function(a,b){var c;c=a.R;for(var d=b.x-a.position.x,e=b.y-a.position.y,f=d*c.col1.x+e*c.col1.y,g=d*c.col2.x+e*c.col2.y,h=0;h<this.m_vertexCount;++h)if(c=this.m_vertices[h],d=f-c.x,e=g-c.y,c=this.m_normals[h],c.x*d+c.y*e>0)return!1;return!0},b2PolygonShape.prototype.RayCast=function(a,b,c){var d,e,f,g,h=0,i=b.maxFraction;d=b.p1.x-c.position.x,e=b.p1.y-c.position.y,f=c.R;var j=d*f.col1.x+e*f.col1.y,k=d*f.col2.x+e*f.col2.y;d=b.p2.x-c.position.x,e=b.p2.y-c.position.y,f=c.R,b=d*f.col1.x+e*f.col1.y-j,f=d*f.col2.x+e*f.col2.y-k;for(var l=-1,m=0;m<this.m_vertexCount;++m){if(g=this.m_vertices[m],d=g.x-j,e=g.y-k,g=this.m_normals[m],d=g.x*d+g.y*e,e=g.x*b+g.y*f,0==e){if(0>d)return!1}else 0>e&&h*e>d?(h=d/e,l=m):e>0&&i*e>d&&(i=d/e);if(i<h-Number.MIN_VALUE)return!1}return l>=0?(a.fraction=h,f=c.R,g=this.m_normals[l],a.normal.x=f.col1.x*g.x+f.col2.x*g.y,a.normal.y=f.col1.y*g.x+f.col2.y*g.y,!0):!1},b2PolygonShape.prototype.ComputeAABB=function(a,b){for(var c=b.R,d=this.m_vertices[0],e=b.position.x+(c.col1.x*d.x+c.col2.x*d.y),f=b.position.y+(c.col1.y*d.x+c.col2.y*d.y),g=e,h=f,i=1;i<this.m_vertexCount;++i){d=this.m_vertices[i];var j=b.position.x+(c.col1.x*d.x+c.col2.x*d.y);d=b.position.y+(c.col1.y*d.x+c.col2.y*d.y),e=j>e?e:j,f=d>f?f:d,g=g>j?g:j,h=h>d?h:d}a.lowerBound.x=e-this.m_radius,a.lowerBound.y=f-this.m_radius,a.upperBound.x=g+this.m_radius,a.upperBound.y=h+this.m_radius},b2PolygonShape.prototype.ComputeMass=function(a,b){if(2==this.m_vertexCount)a.center.x=.5*(this.m_vertices[0].x+this.m_vertices[1].x),a.center.y=.5*(this.m_vertices[0].y+this.m_vertices[1].y),a.mass=0,a.I=0;else{for(var c=0,d=0,e=0,f=0,g=1/3,h=0;h<this.m_vertexCount;++h){var i=this.m_vertices[h],j=h+1<this.m_vertexCount?this.m_vertices[parseInt(h+1)]:this.m_vertices[0],k=i.x-0,l=i.y-0,m=j.x-0,n=j.y-0,o=k*n-l*m,p=.5*o;e+=p,c+=p*g*(0+i.x+j.x),d+=p*g*(0+i.y+j.y),i=k,l=l,m=m,n=n,f+=o*(g*(.25*(i*i+m*i+m*m)+(0*i+0*m))+0+(g*(.25*(l*l+n*l+n*n)+(0*l+0*n))+0))}a.mass=b*e,c*=1/e,d*=1/e,a.center.Set(c,d),a.I=b*f}},b2PolygonShape.prototype.ComputeSubmergedArea=function(a,b,c,d){var e=b2Math.MulTMV(c.R,a),f=b-b2Math.Dot(a,c.position),g=[],h=0,i=-1;b=-1;var j=!1;for(a=a=0;a<this.m_vertexCount;++a){g[a]=b2Math.Dot(e,this.m_vertices[a])-f;var k=g[a]<-Number.MIN_VALUE;a>0&&(k?j||(i=a-1,h++):j&&(b=a-1,h++)),j=k}switch(h){case 0:return j?(a=new b2MassData,this.ComputeMass(a,1),d.SetV(b2Math.MulX(c,a.center)),a.mass):0;case 1:-1==i?i=this.m_vertexCount-1:b=this.m_vertexCount-1}for(a=(i+1)%this.m_vertexCount,e=(b+1)%this.m_vertexCount,f=(0-g[i])/(g[a]-g[i]),g=(0-g[b])/(g[e]-g[b]),i=new b2Vec2(this.m_vertices[i].x*(1-f)+this.m_vertices[a].x*f,this.m_vertices[i].y*(1-f)+this.m_vertices[a].y*f),b=new b2Vec2(this.m_vertices[b].x*(1-g)+this.m_vertices[e].x*g,this.m_vertices[b].y*(1-g)+this.m_vertices[e].y*g),g=0,f=new b2Vec2,h=this.m_vertices[a],a=a;a!=e;)a=(a+1)%this.m_vertexCount,j=a==e?b:this.m_vertices[a],k=.5*((h.x-i.x)*(j.y-i.y)-(h.y-i.y)*(j.x-i.x)),g+=k,f.x+=k*(i.x+h.x+j.x)/3,f.y+=k*(i.y+h.y+j.y)/3,h=j;return f.Multiply(1/g),d.SetV(b2Math.MulX(c,f)),g},b2PolygonShape.prototype.GetVertexCount=function(){return this.m_vertexCount},b2PolygonShape.prototype.GetVertices=function(){return this.m_vertices},b2PolygonShape.prototype.GetNormals=function(){return this.m_normals},b2PolygonShape.prototype.GetSupport=function(a){for(var b=0,c=this.m_vertices[0].x*a.x+this.m_vertices[0].y*a.y,d=1;d<this.m_vertexCount;++d){var e=this.m_vertices[d].x*a.x+this.m_vertices[d].y*a.y;e>c&&(b=d,c=e)}return b},b2PolygonShape.prototype.GetSupportVertex=function(a){for(var b=0,c=this.m_vertices[0].x*a.x+this.m_vertices[0].y*a.y,d=1;d<this.m_vertexCount;++d){var e=this.m_vertices[d].x*a.x+this.m_vertices[d].y*a.y;e>c&&(b=d,c=e)}return this.m_vertices[b]},b2PolygonShape.prototype.m_centroid=null,b2PolygonShape.prototype.m_vertices=null,b2PolygonShape.prototype.m_normals=null,b2PolygonShape.prototype.m_vertexCount=0;var b2Fixture=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Fixture.prototype.__constructor=function(){this.m_aabb=new b2AABB,this.m_shape=this.m_next=this.m_body=this.m_userData=null,this.m_restitution=this.m_friction=this.m_density=0},b2Fixture.prototype.__varz=function(){this.m_filter=new b2FilterData},b2Fixture.prototype.Create=function(a,b,c){this.m_userData=c.userData,this.m_friction=c.friction,this.m_restitution=c.restitution,this.m_body=a,this.m_next=null,this.m_filter=c.filter.Copy(),this.m_isSensor=c.isSensor,this.m_shape=c.shape.Copy(),this.m_density=c.density},b2Fixture.prototype.Destroy=function(){this.m_shape=null},b2Fixture.prototype.CreateProxy=function(a,b){this.m_shape.ComputeAABB(this.m_aabb,b),this.m_proxy=a.CreateProxy(this.m_aabb,this)},b2Fixture.prototype.DestroyProxy=function(a){null!=this.m_proxy&&(a.DestroyProxy(this.m_proxy),this.m_proxy=null)},b2Fixture.prototype.Synchronize=function(a,b,c){if(this.m_proxy){var d=new b2AABB,e=new b2AABB;this.m_shape.ComputeAABB(d,b),this.m_shape.ComputeAABB(e,c),this.m_aabb.Combine(d,e),b=b2Math.SubtractVV(c.position,b.position),a.MoveProxy(this.m_proxy,this.m_aabb,b)}},b2Fixture.prototype.GetType=function(){return this.m_shape.GetType()},b2Fixture.prototype.GetShape=function(){return this.m_shape},b2Fixture.prototype.SetSensor=function(a){if(this.m_isSensor!=a&&(this.m_isSensor=a,null!=this.m_body))for(a=this.m_body.GetContactList();a;){var b=a.contact,c=b.GetFixtureA(),d=b.GetFixtureB();(c==this||d==this)&&b.SetSensor(c.IsSensor()||d.IsSensor()),a=a.next}},b2Fixture.prototype.IsSensor=function(){return this.m_isSensor},b2Fixture.prototype.SetFilterData=function(a){if(this.m_filter=a.Copy(),!this.m_body)for(a=this.m_body.GetContactList();a;){var b=a.contact,c=b.GetFixtureA(),d=b.GetFixtureB();(c==this||d==this)&&b.FlagForFiltering(),a=a.next}},b2Fixture.prototype.GetFilterData=function(){return this.m_filter.Copy()},b2Fixture.prototype.GetBody=function(){return this.m_body},b2Fixture.prototype.GetNext=function(){return this.m_next},b2Fixture.prototype.GetUserData=function(){return this.m_userData},b2Fixture.prototype.SetUserData=function(a){this.m_userData=a},b2Fixture.prototype.TestPoint=function(a){return this.m_shape.TestPoint(this.m_body.GetTransform(),a)},b2Fixture.prototype.RayCast=function(a,b){return this.m_shape.RayCast(a,b,this.m_body.GetTransform())},b2Fixture.prototype.GetMassData=function(a){return null==a&&(a=new b2MassData),this.m_shape.ComputeMass(a,this.m_density),a},b2Fixture.prototype.SetDensity=function(a){this.m_density=a},b2Fixture.prototype.GetDensity=function(){return this.m_density},b2Fixture.prototype.GetFriction=function(){return this.m_friction},b2Fixture.prototype.SetFriction=function(a){this.m_friction=a},b2Fixture.prototype.GetRestitution=function(){return this.m_restitution},b2Fixture.prototype.SetRestitution=function(a){this.m_restitution=a},b2Fixture.prototype.GetAABB=function(){return this.m_aabb},b2Fixture.prototype.m_massData=null,b2Fixture.prototype.m_aabb=null,b2Fixture.prototype.m_density=null,b2Fixture.prototype.m_next=null,b2Fixture.prototype.m_body=null,b2Fixture.prototype.m_shape=null,b2Fixture.prototype.m_friction=null,b2Fixture.prototype.m_restitution=null,b2Fixture.prototype.m_proxy=null,b2Fixture.prototype.m_filter=new b2FilterData,b2Fixture.prototype.m_isSensor=null,b2Fixture.prototype.m_userData=null;var b2DynamicTreeNode=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2DynamicTreeNode.prototype.__constructor=function(){},b2DynamicTreeNode.prototype.__varz=function(){this.aabb=new b2AABB},b2DynamicTreeNode.prototype.IsLeaf=function(){return null==this.child1},b2DynamicTreeNode.prototype.userData=null,b2DynamicTreeNode.prototype.aabb=new b2AABB,b2DynamicTreeNode.prototype.parent=null,b2DynamicTreeNode.prototype.child1=null,b2DynamicTreeNode.prototype.child2=null;var b2BodyDef=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2BodyDef.prototype.__constructor=function(){this.userData=null,this.position.Set(0,0),this.angle=0,this.linearVelocity.Set(0,0),this.angularDamping=this.linearDamping=this.angularVelocity=0,this.awake=this.allowSleep=!0,this.bullet=this.fixedRotation=!1,this.type=b2Body.b2_staticBody,this.active=!0,this.inertiaScale=1},b2BodyDef.prototype.__varz=function(){this.position=new b2Vec2,this.linearVelocity=new b2Vec2},b2BodyDef.prototype.type=0,b2BodyDef.prototype.position=new b2Vec2,b2BodyDef.prototype.angle=null,b2BodyDef.prototype.linearVelocity=new b2Vec2,b2BodyDef.prototype.angularVelocity=null,b2BodyDef.prototype.linearDamping=null,b2BodyDef.prototype.angularDamping=null,b2BodyDef.prototype.allowSleep=null,b2BodyDef.prototype.awake=null,b2BodyDef.prototype.fixedRotation=null,b2BodyDef.prototype.bullet=null,b2BodyDef.prototype.active=null,b2BodyDef.prototype.userData=null,b2BodyDef.prototype.inertiaScale=null;
var b2DynamicTreeBroadPhase=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2DynamicTreeBroadPhase.prototype.__constructor=function(){},b2DynamicTreeBroadPhase.prototype.__varz=function(){this.m_tree=new b2DynamicTree,this.m_moveBuffer=[],this.m_pairBuffer=[]},b2DynamicTreeBroadPhase.prototype.BufferMove=function(a){this.m_moveBuffer[this.m_moveBuffer.length]=a},b2DynamicTreeBroadPhase.prototype.UnBufferMove=function(a){this.m_moveBuffer.splice(this.m_moveBuffer.indexOf(a),1)},b2DynamicTreeBroadPhase.prototype.ComparePairs=function(){return 0},b2DynamicTreeBroadPhase.prototype.CreateProxy=function(a,b){var c=this.m_tree.CreateProxy(a,b);return++this.m_proxyCount,this.BufferMove(c),c},b2DynamicTreeBroadPhase.prototype.DestroyProxy=function(a){this.UnBufferMove(a),--this.m_proxyCount,this.m_tree.DestroyProxy(a)},b2DynamicTreeBroadPhase.prototype.MoveProxy=function(a,b,c){this.m_tree.MoveProxy(a,b,c)&&this.BufferMove(a)},b2DynamicTreeBroadPhase.prototype.TestOverlap=function(a,b){var c=this.m_tree.GetFatAABB(a),d=this.m_tree.GetFatAABB(b);return c.TestOverlap(d)},b2DynamicTreeBroadPhase.prototype.GetUserData=function(a){return this.m_tree.GetUserData(a)},b2DynamicTreeBroadPhase.prototype.GetFatAABB=function(a){return this.m_tree.GetFatAABB(a)},b2DynamicTreeBroadPhase.prototype.GetProxyCount=function(){return this.m_proxyCount},b2DynamicTreeBroadPhase.prototype.UpdatePairs=function(a){for(var b=this.m_pairCount=0,c=null;c=this.m_moveBuffer[b];b++){var d=this;this.m_tree.Query(function(a){if(a==c)return!0;d.m_pairCount==d.m_pairBuffer.length&&(d.m_pairBuffer[d.m_pairCount]=new b2DynamicTreePair);var b=d.m_pairBuffer[d.m_pairCount];return b.proxyA=c>a?a:c,b.proxyB=a>=c?a:c,++d.m_pairCount,!0},this.m_tree.GetFatAABB(c))}for(b=this.m_moveBuffer.length=0;b<this.m_pairCount;){var e=this.m_pairBuffer[b],f=this.m_tree.GetUserData(e.proxyA),g=this.m_tree.GetUserData(e.proxyB);for(a(f,g),++b;b<this.m_pairCount&&(f=this.m_pairBuffer[b],f.proxyA==e.proxyA&&f.proxyB==e.proxyB);)++b}},b2DynamicTreeBroadPhase.prototype.Query=function(a,b){this.m_tree.Query(a,b)},b2DynamicTreeBroadPhase.prototype.RayCast=function(a,b){this.m_tree.RayCast(a,b)},b2DynamicTreeBroadPhase.prototype.Validate=function(){},b2DynamicTreeBroadPhase.prototype.Rebalance=function(a){this.m_tree.Rebalance(a)},b2DynamicTreeBroadPhase.prototype.m_tree=new b2DynamicTree,b2DynamicTreeBroadPhase.prototype.m_proxyCount=0,b2DynamicTreeBroadPhase.prototype.m_moveBuffer=[],b2DynamicTreeBroadPhase.prototype.m_pairBuffer=[],b2DynamicTreeBroadPhase.prototype.m_pairCount=0;var b2BroadPhase=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2BroadPhase.prototype.__constructor=function(a){var b=0;for(this.m_pairManager.Initialize(this),this.m_worldAABB=a,this.m_proxyCount=0,this.m_bounds=[],b=0;2>b;b++)this.m_bounds[b]=[];b=a.upperBound.y-a.lowerBound.y,this.m_quantizationFactor.x=b2Settings.USHRT_MAX/(a.upperBound.x-a.lowerBound.x),this.m_quantizationFactor.y=b2Settings.USHRT_MAX/b,this.m_timeStamp=1,this.m_queryResultCount=0},b2BroadPhase.prototype.__varz=function(){this.m_pairManager=new b2PairManager,this.m_proxyPool=[],this.m_querySortKeys=[],this.m_queryResults=[],this.m_quantizationFactor=new b2Vec2},b2BroadPhase.BinarySearch=function(a,b,c){var d=0;for(b-=1;b>=d;){var e=Math.round((d+b)/2),f=a[e];if(f.value>c)b=e-1;else{if(!(f.value<c))return parseInt(e);d=e+1}}return parseInt(d)},b2BroadPhase.s_validate=!1,b2BroadPhase.b2_invalid=b2Settings.USHRT_MAX,b2BroadPhase.b2_nullEdge=b2Settings.USHRT_MAX,b2BroadPhase.prototype.ComputeBounds=function(a,b,c){var d=c.lowerBound.x,e=c.lowerBound.y;d=b2Math.Min(d,this.m_worldAABB.upperBound.x),e=b2Math.Min(e,this.m_worldAABB.upperBound.y),d=b2Math.Max(d,this.m_worldAABB.lowerBound.x),e=b2Math.Max(e,this.m_worldAABB.lowerBound.y);var f=c.upperBound.x;c=c.upperBound.y,f=b2Math.Min(f,this.m_worldAABB.upperBound.x),c=b2Math.Min(c,this.m_worldAABB.upperBound.y),f=b2Math.Max(f,this.m_worldAABB.lowerBound.x),c=b2Math.Max(c,this.m_worldAABB.lowerBound.y),a[0]=parseInt(this.m_quantizationFactor.x*(d-this.m_worldAABB.lowerBound.x))&b2Settings.USHRT_MAX-1,b[0]=parseInt(this.m_quantizationFactor.x*(f-this.m_worldAABB.lowerBound.x))%65535|1,a[1]=parseInt(this.m_quantizationFactor.y*(e-this.m_worldAABB.lowerBound.y))&b2Settings.USHRT_MAX-1,b[1]=parseInt(this.m_quantizationFactor.y*(c-this.m_worldAABB.lowerBound.y))%65535|1},b2BroadPhase.prototype.TestOverlapValidate=function(a,b){for(var c=0;2>c;++c){var d=this.m_bounds[c],e=d[a.lowerBounds[c]],f=d[b.upperBounds[c]];if(e.value>f.value)return!1;if(e=d[a.upperBounds[c]],f=d[b.lowerBounds[c]],e.value<f.value)return!1}return!0},b2BroadPhase.prototype.QueryAxis=function(a,b,c,d,e,f,g){c=b2BroadPhase.BinarySearch(e,f,c),d=b2BroadPhase.BinarySearch(e,f,d);for(var h=c;d>h;++h)f=e[h],f.IsLower()&&this.IncrementOverlapCount(f.proxy);if(c>0){h=c-1,f=e[h];for(var i=f.stabbingCount;i;)f=e[h],f.IsLower()&&c<=f.proxy.upperBounds[g]&&(this.IncrementOverlapCount(f.proxy),--i),--h}a[0]=c,b[0]=d},b2BroadPhase.prototype.IncrementOverlapCount=function(a){a.timeStamp<this.m_timeStamp?(a.timeStamp=this.m_timeStamp,a.overlapCount=1):(a.overlapCount=2,this.m_queryResults[this.m_queryResultCount]=a,++this.m_queryResultCount)},b2BroadPhase.prototype.IncrementTimeStamp=function(){if(this.m_timeStamp==b2Settings.USHRT_MAX){for(var a=0;a<this.m_proxyPool.length;++a)this.m_proxyPool[a].timeStamp=0;this.m_timeStamp=1}else++this.m_timeStamp},b2BroadPhase.prototype.InRange=function(a){var b,c,d,e;return b=a.lowerBound.x,c=a.lowerBound.y,b-=this.m_worldAABB.upperBound.x,c-=this.m_worldAABB.upperBound.y,d=this.m_worldAABB.lowerBound.x,e=this.m_worldAABB.lowerBound.y,d-=a.upperBound.x,e-=a.upperBound.y,b=b2Math.Max(b,d),c=b2Math.Max(c,e),b2Math.Max(b,c)<0},b2BroadPhase.prototype.CreateProxy=function(a,b){var c,d=0,e=0;if(c=0,!this.m_freeProxy)for(this.m_freeProxy=this.m_proxyPool[this.m_proxyCount]=new b2Proxy,this.m_freeProxy.next=null,this.m_freeProxy.timeStamp=0,this.m_freeProxy.overlapCount=b2BroadPhase.b2_invalid,this.m_freeProxy.userData=null,e=0;2>e;e++)c=2*this.m_proxyCount,this.m_bounds[e][c++]=new b2Bound,this.m_bounds[e][c]=new b2Bound;c=this.m_freeProxy,this.m_freeProxy=c.next,c.overlapCount=0,c.userData=b,e=2*this.m_proxyCount;var f=[],g=[];this.ComputeBounds(f,g,a);for(var h=0;2>h;++h){var i=this.m_bounds[h],j=0,k=0,l=[];l.push(j),d=[],d.push(k),this.QueryAxis(l,d,f[h],g[h],i,e,h),j=l[0],k=d[0],i.splice(k,0,i[i.length-1]),i.length--,i.splice(j,0,i[i.length-1]),i.length--,++k,l=i[j],d=i[k],l.value=f[h],l.proxy=c,d.value=g[h],d.proxy=c;var m=i[parseInt(j-1)];for(l.stabbingCount=0==j?0:m.stabbingCount,m=i[parseInt(k-1)],d.stabbingCount=m.stabbingCount,d=j;k>d;++d)m=i[d],m.stabbingCount++;for(d=j;e+2>d;++d)l=i[d],j=l.proxy,l.IsLower()?j.lowerBounds[h]=d:j.upperBounds[h]=d}for(++this.m_proxyCount,e=0;e<this.m_queryResultCount;++e)this.m_pairManager.AddBufferedPair(c,this.m_queryResults[e]);return this.m_queryResultCount=0,this.IncrementTimeStamp(),c},b2BroadPhase.prototype.DestroyProxy=function(a){for(var b,c,d=2*this.m_proxyCount,e=0;2>e;++e){var f=this.m_bounds[e],g=a.lowerBounds[e],h=a.upperBounds[e];b=f[g];var i=b.value;c=f[h];var j=c.value;f.splice(h,1),f.splice(g,1),f.push(b),f.push(c),c=d-2;for(var k=g;c>k;++k){b=f[k];var l=b.proxy;b.IsLower()?l.lowerBounds[e]=k:l.upperBounds[e]=k}for(c=h-1,g=g;c>g;++g)b=f[g],b.stabbingCount--;b=[],this.QueryAxis(b,b,i,j,f,d-2,e)}for(d=0;d<this.m_queryResultCount;++d)this.m_pairManager.RemoveBufferedPair(a,this.m_queryResults[d]);this.m_queryResultCount=0,this.IncrementTimeStamp(),a.userData=null,a.overlapCount=b2BroadPhase.b2_invalid,a.lowerBounds[0]=b2BroadPhase.b2_invalid,a.lowerBounds[1]=b2BroadPhase.b2_invalid,a.upperBounds[0]=b2BroadPhase.b2_invalid,a.upperBounds[1]=b2BroadPhase.b2_invalid,a.next=this.m_freeProxy,this.m_freeProxy=a,--this.m_proxyCount},b2BroadPhase.prototype.MoveProxy=function(a,b){var c,d,e,f=0,g=0,h=0;if(null!=a&&0!=b.IsValid()){var i=2*this.m_proxyCount,j=new b2BoundValues;this.ComputeBounds(j.lowerValues,j.upperValues,b);var k=new b2BoundValues;for(g=0;2>g;++g)d=this.m_bounds[g][a.lowerBounds[g]],k.lowerValues[g]=d.value,d=this.m_bounds[g][a.upperBounds[g]],k.upperValues[g]=d.value;for(g=0;2>g;++g){var l=this.m_bounds[g],m=a.lowerBounds[g],n=a.upperBounds[g],o=j.lowerValues[g],p=j.upperValues[g];d=l[m];var q=o-d.value;d.value=o,d=l[n];var r=p-d.value;if(d.value=p,0>q)for(h=m;h>0&&o<l[parseInt(h-1)].value;)d=l[h],e=l[parseInt(h-1)],c=e.proxy,e.stabbingCount++,1==e.IsUpper()?(this.TestOverlapBound(j,c)&&this.m_pairManager.AddBufferedPair(a,c),c=c.upperBounds,f=c[g],f++,c[g]=f,d.stabbingCount++):(c=c.lowerBounds,f=c[g],f++,c[g]=f,d.stabbingCount--),c=a.lowerBounds,f=c[g],f--,c[g]=f,d.Swap(e),--h;if(r>0)for(h=n;i-1>h&&l[parseInt(h+1)].value<=p;)d=l[h],e=l[parseInt(h+1)],c=e.proxy,e.stabbingCount++,1==e.IsLower()?(this.TestOverlapBound(j,c)&&this.m_pairManager.AddBufferedPair(a,c),c=c.lowerBounds,f=c[g],f--,c[g]=f,d.stabbingCount++):(c=c.upperBounds,f=c[g],f--,c[g]=f,d.stabbingCount--),c=a.upperBounds,f=c[g],f++,c[g]=f,d.Swap(e),h++;if(q>0)for(h=m;i-1>h&&l[parseInt(h+1)].value<=o;)d=l[h],e=l[parseInt(h+1)],c=e.proxy,e.stabbingCount--,e.IsUpper()?(this.TestOverlapBound(k,c)&&this.m_pairManager.RemoveBufferedPair(a,c),c=c.upperBounds,f=c[g],f--,c[g]=f,d.stabbingCount--):(c=c.lowerBounds,f=c[g],f--,c[g]=f,d.stabbingCount++),c=a.lowerBounds,f=c[g],f++,c[g]=f,d.Swap(e),h++;if(0>r)for(h=n;h>0&&p<l[parseInt(h-1)].value;)d=l[h],e=l[parseInt(h-1)],c=e.proxy,e.stabbingCount--,1==e.IsLower()?(this.TestOverlapBound(k,c)&&this.m_pairManager.RemoveBufferedPair(a,c),c=c.lowerBounds,f=c[g],f++,c[g]=f,d.stabbingCount--):(c=c.upperBounds,f=c[g],f++,c[g]=f,d.stabbingCount++),c=a.upperBounds,f=c[g],f--,c[g]=f,d.Swap(e),h--}}},b2BroadPhase.prototype.UpdatePairs=function(a){this.m_pairManager.Commit(a)},b2BroadPhase.prototype.TestOverlap=function(a,b){return a.lowerBounds[0]>b.upperBounds[0]?!1:b.lowerBounds[0]>a.upperBounds[0]?!1:a.lowerBounds[1]>b.upperBounds[1]?!1:b.lowerBounds[1]>a.upperBounds[1]?!1:!0},b2BroadPhase.prototype.GetUserData=function(a){return a.userData},b2BroadPhase.prototype.GetFatAABB=function(a){var b=new b2AABB;return b.lowerBound.x=this.m_worldAABB.lowerBound.x+this.m_bounds[0][a.lowerBounds[0]].value/this.m_quantizationFactor.x,b.lowerBound.y=this.m_worldAABB.lowerBound.y+this.m_bounds[1][a.lowerBounds[1]].value/this.m_quantizationFactor.y,b.upperBound.x=this.m_worldAABB.lowerBound.x+this.m_bounds[0][a.upperBounds[0]].value/this.m_quantizationFactor.x,b.upperBound.y=this.m_worldAABB.lowerBound.y+this.m_bounds[1][a.upperBounds[1]].value/this.m_quantizationFactor.y,b},b2BroadPhase.prototype.GetProxyCount=function(){return this.m_proxyCount},b2BroadPhase.prototype.Query=function(a,b){var c=[],d=[];this.ComputeBounds(c,d,b);var e=[];e.push(0);var f=[];for(f.push(0),this.QueryAxis(e,f,c[0],d[0],this.m_bounds[0],2*this.m_proxyCount,0),this.QueryAxis(e,f,c[1],d[1],this.m_bounds[1],2*this.m_proxyCount,1),c=0;c<this.m_queryResultCount&&a(this.m_queryResults[c]);++c);this.m_queryResultCount=0,this.IncrementTimeStamp()},b2BroadPhase.prototype.Validate=function(){for(var a=0;2>a;++a)for(var b=this.m_bounds[a],c=2*this.m_proxyCount,d=0,e=0;c>e;++e)1==b[e].IsLower()?d++:d--},b2BroadPhase.prototype.Rebalance=function(){},b2BroadPhase.prototype.RayCast=function(a,b){var c=new b2RayCastInput;c.p1.SetV(b.p1),c.p2.SetV(b.p2),c.maxFraction=b.maxFraction;var d=(b.p2.x-b.p1.x)*this.m_quantizationFactor.x,e=(b.p2.y-b.p1.y)*this.m_quantizationFactor.y,f=d<-Number.MIN_VALUE?-1:d>Number.MIN_VALUE?1:0,g=e<-Number.MIN_VALUE?-1:e>Number.MIN_VALUE?1:0,h=this.m_quantizationFactor.x*(b.p1.x-this.m_worldAABB.lowerBound.x),i=this.m_quantizationFactor.y*(b.p1.y-this.m_worldAABB.lowerBound.y),j=[],k=[];j[0]=parseInt(h)&b2Settings.USHRT_MAX-1,j[1]=parseInt(i)&b2Settings.USHRT_MAX-1,k[0]=j[0]+1,k[1]=j[1]+1;var l=0,m=0;m=[],m.push(0);var n=[];for(n.push(0),this.QueryAxis(m,n,j[0],k[0],this.m_bounds[0],2*this.m_proxyCount,0),l=f>=0?n[0]-1:m[0],this.QueryAxis(m,n,j[1],k[1],this.m_bounds[1],2*this.m_proxyCount,1),m=g>=0?n[0]-1:m[0],j=0;j<this.m_queryResultCount;j++)c.maxFraction=a(this.m_queryResults[j],c);for(;(n=k=0,l+=f>=0?1:-1,!(0>l||l>=2*this.m_proxyCount))&&(0!=f&&(k=(this.m_bounds[0][l].value-h)/d),m+=g>=0?1:-1,!(0>m||m>=2*this.m_proxyCount));){for(0!=g&&(n=(this.m_bounds[1][m].value-i)/e);;)if(0==g||0!=f&&n>k){if(k>c.maxFraction)break;if((f>0?this.m_bounds[0][l].IsLower():this.m_bounds[0][l].IsUpper())&&(j=this.m_bounds[0][l].proxy,g>=0?j.lowerBounds[1]<=m-1&&j.upperBounds[1]>=m&&(c.maxFraction=a(j,c)):j.lowerBounds[1]<=m&&j.upperBounds[1]>=m+1&&(c.maxFraction=a(j,c))),0==c.maxFraction)break;if(f>0){if(l++,l==2*this.m_proxyCount)break}else if(l--,0>l)break;k=(this.m_bounds[0][l].value-h)/d}else{if(n>c.maxFraction)break;if((g>0?this.m_bounds[1][m].IsLower():this.m_bounds[1][m].IsUpper())&&(j=this.m_bounds[1][m].proxy,f>=0?j.lowerBounds[0]<=l-1&&j.upperBounds[0]>=l&&(c.maxFraction=a(j,c)):j.lowerBounds[0]<=l&&j.upperBounds[0]>=l+1&&(c.maxFraction=a(j,c))),0==c.maxFraction)break;if(g>0){if(m++,m==2*this.m_proxyCount)break}else if(m--,0>m)break;n=(this.m_bounds[1][m].value-i)/e}break}this.m_queryResultCount=0,this.IncrementTimeStamp()},b2BroadPhase.prototype.TestOverlapBound=function(a,b){for(var c=0;2>c;++c){var d=this.m_bounds[c],e=d[b.upperBounds[c]];if(a.lowerValues[c]>e.value)return!1;if(e=d[b.lowerBounds[c]],a.upperValues[c]<e.value)return!1}return!0},b2BroadPhase.prototype.m_pairManager=new b2PairManager,b2BroadPhase.prototype.m_proxyPool=[],b2BroadPhase.prototype.m_freeProxy=null,b2BroadPhase.prototype.m_bounds=null,b2BroadPhase.prototype.m_querySortKeys=[],b2BroadPhase.prototype.m_queryResults=[],b2BroadPhase.prototype.m_queryResultCount=0,b2BroadPhase.prototype.m_worldAABB=null,b2BroadPhase.prototype.m_quantizationFactor=new b2Vec2,b2BroadPhase.prototype.m_proxyCount=0,b2BroadPhase.prototype.m_timeStamp=0;var b2Manifold=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Manifold.prototype.__constructor=function(){this.m_points=Array(b2Settings.b2_maxManifoldPoints);for(var a=0;a<b2Settings.b2_maxManifoldPoints;a++)this.m_points[a]=new b2ManifoldPoint;this.m_localPlaneNormal=new b2Vec2,this.m_localPoint=new b2Vec2},b2Manifold.prototype.__varz=function(){},b2Manifold.e_circles=1,b2Manifold.e_faceA=2,b2Manifold.e_faceB=4,b2Manifold.prototype.Reset=function(){for(var a=0;a<b2Settings.b2_maxManifoldPoints;a++)this.m_points[a].Reset();this.m_localPlaneNormal.SetZero(),this.m_localPoint.SetZero(),this.m_pointCount=this.m_type=0},b2Manifold.prototype.Set=function(a){this.m_pointCount=a.m_pointCount;for(var b=0;b<b2Settings.b2_maxManifoldPoints;b++)this.m_points[b].Set(a.m_points[b]);this.m_localPlaneNormal.SetV(a.m_localPlaneNormal),this.m_localPoint.SetV(a.m_localPoint),this.m_type=a.m_type},b2Manifold.prototype.Copy=function(){var a=new b2Manifold;return a.Set(this),a},b2Manifold.prototype.m_points=null,b2Manifold.prototype.m_localPlaneNormal=null,b2Manifold.prototype.m_localPoint=null,b2Manifold.prototype.m_type=0,b2Manifold.prototype.m_pointCount=0;var b2CircleShape=function(){b2Shape.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2CircleShape.prototype,b2Shape.prototype),b2CircleShape.prototype._super=b2Shape.prototype,b2CircleShape.prototype.__constructor=function(a){this._super.__constructor.apply(this,[]),this.m_type=b2Shape.e_circleShape,this.m_radius=a},b2CircleShape.prototype.__varz=function(){this.m_p=new b2Vec2},b2CircleShape.prototype.Copy=function(){var a=new b2CircleShape;return a.Set(this),a},b2CircleShape.prototype.Set=function(a){this._super.Set.apply(this,[a]),isInstanceOf(a,b2CircleShape)&&this.m_p.SetV(a.m_p)},b2CircleShape.prototype.TestPoint=function(a,b){var c=a.R,d=a.position.x+(c.col1.x*this.m_p.x+c.col2.x*this.m_p.y);return c=a.position.y+(c.col1.y*this.m_p.x+c.col2.y*this.m_p.y),d=b.x-d,c=b.y-c,d*d+c*c<=this.m_radius*this.m_radius},b2CircleShape.prototype.RayCast=function(a,b,c){var d=c.R,e=b.p1.x-(c.position.x+(d.col1.x*this.m_p.x+d.col2.x*this.m_p.y));c=b.p1.y-(c.position.y+(d.col1.y*this.m_p.x+d.col2.y*this.m_p.y)),d=b.p2.x-b.p1.x;var f=b.p2.y-b.p1.y,g=e*d+c*f,h=d*d+f*f,i=g*g-h*(e*e+c*c-this.m_radius*this.m_radius);return 0>i||h<Number.MIN_VALUE?!1:(g=-(g+Math.sqrt(i)),g>=0&&g<=b.maxFraction*h?(g/=h,a.fraction=g,a.normal.x=e+g*d,a.normal.y=c+g*f,a.normal.Normalize(),!0):!1)},b2CircleShape.prototype.ComputeAABB=function(a,b){var c=b.R,d=b.position.x+(c.col1.x*this.m_p.x+c.col2.x*this.m_p.y);c=b.position.y+(c.col1.y*this.m_p.x+c.col2.y*this.m_p.y),a.lowerBound.Set(d-this.m_radius,c-this.m_radius),a.upperBound.Set(d+this.m_radius,c+this.m_radius)},b2CircleShape.prototype.ComputeMass=function(a,b){a.mass=b*b2Settings.b2_pi*this.m_radius*this.m_radius,a.center.SetV(this.m_p),a.I=a.mass*(.5*this.m_radius*this.m_radius+(this.m_p.x*this.m_p.x+this.m_p.y*this.m_p.y))},b2CircleShape.prototype.ComputeSubmergedArea=function(a,b,c,d){c=b2Math.MulX(c,this.m_p);var e=-(b2Math.Dot(a,c)-b);if(e<-this.m_radius+Number.MIN_VALUE)return 0;if(e>this.m_radius)return d.SetV(c),Math.PI*this.m_radius*this.m_radius;b=this.m_radius*this.m_radius;var f=e*e;return e=b*(Math.asin(e/this.m_radius)+Math.PI/2)+e*Math.sqrt(b-f),b=-2/3*Math.pow(b-f,1.5)/e,d.x=c.x+a.x*b,d.y=c.y+a.y*b,e},b2CircleShape.prototype.GetLocalPosition=function(){return this.m_p},b2CircleShape.prototype.SetLocalPosition=function(a){this.m_p.SetV(a)},b2CircleShape.prototype.GetRadius=function(){return this.m_radius},b2CircleShape.prototype.SetRadius=function(a){this.m_radius=a},b2CircleShape.prototype.m_p=new b2Vec2;var b2Joint=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Joint.prototype.__constructor=function(a){b2Settings.b2Assert(a.bodyA!=a.bodyB),this.m_type=a.type,this.m_next=this.m_prev=null,this.m_bodyA=a.bodyA,this.m_bodyB=a.bodyB,this.m_collideConnected=a.collideConnected,this.m_islandFlag=!1,this.m_userData=a.userData},b2Joint.prototype.__varz=function(){this.m_edgeA=new b2JointEdge,this.m_edgeB=new b2JointEdge,this.m_localCenterA=new b2Vec2,this.m_localCenterB=new b2Vec2},b2Joint.Create=function(a){var b=null;switch(a.type){case b2Joint.e_distanceJoint:b=new b2DistanceJoint(a);break;case b2Joint.e_mouseJoint:b=new b2MouseJoint(a);break;case b2Joint.e_prismaticJoint:b=new b2PrismaticJoint(a);break;case b2Joint.e_revoluteJoint:b=new b2RevoluteJoint(a);break;case b2Joint.e_pulleyJoint:b=new b2PulleyJoint(a);break;case b2Joint.e_gearJoint:b=new b2GearJoint(a);break;case b2Joint.e_lineJoint:b=new b2LineJoint(a);break;case b2Joint.e_weldJoint:b=new b2WeldJoint(a);break;case b2Joint.e_frictionJoint:b=new b2FrictionJoint(a)}return b},b2Joint.Destroy=function(){},b2Joint.e_unknownJoint=0,b2Joint.e_revoluteJoint=1,b2Joint.e_prismaticJoint=2,b2Joint.e_distanceJoint=3,b2Joint.e_pulleyJoint=4,b2Joint.e_mouseJoint=5,b2Joint.e_gearJoint=6,b2Joint.e_lineJoint=7,b2Joint.e_weldJoint=8,b2Joint.e_frictionJoint=9,b2Joint.e_inactiveLimit=0,b2Joint.e_atLowerLimit=1,b2Joint.e_atUpperLimit=2,b2Joint.e_equalLimits=3,b2Joint.prototype.InitVelocityConstraints=function(){},b2Joint.prototype.SolveVelocityConstraints=function(){},b2Joint.prototype.FinalizeVelocityConstraints=function(){},b2Joint.prototype.SolvePositionConstraints=function(){return!1},b2Joint.prototype.GetType=function(){return this.m_type},b2Joint.prototype.GetAnchorA=function(){return null},b2Joint.prototype.GetAnchorB=function(){return null},b2Joint.prototype.GetReactionForce=function(){return null},b2Joint.prototype.GetReactionTorque=function(){return 0},b2Joint.prototype.GetBodyA=function(){return this.m_bodyA},b2Joint.prototype.GetBodyB=function(){return this.m_bodyB},b2Joint.prototype.GetNext=function(){return this.m_next},b2Joint.prototype.GetUserData=function(){return this.m_userData},b2Joint.prototype.SetUserData=function(a){this.m_userData=a},b2Joint.prototype.IsActive=function(){return this.m_bodyA.IsActive()&&this.m_bodyB.IsActive()},b2Joint.prototype.m_type=0,b2Joint.prototype.m_prev=null,b2Joint.prototype.m_next=null,b2Joint.prototype.m_edgeA=new b2JointEdge,b2Joint.prototype.m_edgeB=new b2JointEdge,b2Joint.prototype.m_bodyA=null,b2Joint.prototype.m_bodyB=null,b2Joint.prototype.m_islandFlag=null,b2Joint.prototype.m_collideConnected=null,b2Joint.prototype.m_userData=null,b2Joint.prototype.m_localCenterA=new b2Vec2,b2Joint.prototype.m_localCenterB=new b2Vec2,b2Joint.prototype.m_invMassA=null,b2Joint.prototype.m_invMassB=null,b2Joint.prototype.m_invIA=null,b2Joint.prototype.m_invIB=null;var b2LineJoint=function(){b2Joint.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2LineJoint.prototype,b2Joint.prototype),b2LineJoint.prototype._super=b2Joint.prototype,b2LineJoint.prototype.__constructor=function(a){this._super.__constructor.apply(this,[a]),this.m_localAnchor1.SetV(a.localAnchorA),this.m_localAnchor2.SetV(a.localAnchorB),this.m_localXAxis1.SetV(a.localAxisA),this.m_localYAxis1.x=-this.m_localXAxis1.y,this.m_localYAxis1.y=this.m_localXAxis1.x,this.m_impulse.SetZero(),this.m_motorImpulse=this.m_motorMass=0,this.m_lowerTranslation=a.lowerTranslation,this.m_upperTranslation=a.upperTranslation,this.m_maxMotorForce=a.maxMotorForce,this.m_motorSpeed=a.motorSpeed,this.m_enableLimit=a.enableLimit,this.m_enableMotor=a.enableMotor,this.m_limitState=b2Joint.e_inactiveLimit,this.m_axis.SetZero(),this.m_perp.SetZero()},b2LineJoint.prototype.__varz=function(){this.m_localAnchor1=new b2Vec2,this.m_localAnchor2=new b2Vec2,this.m_localXAxis1=new b2Vec2,this.m_localYAxis1=new b2Vec2,this.m_axis=new b2Vec2,this.m_perp=new b2Vec2,this.m_K=new b2Mat22,this.m_impulse=new b2Vec2},b2LineJoint.prototype.InitVelocityConstraints=function(a){var b,c,d=this.m_bodyA,e=this.m_bodyB;this.m_localCenterA.SetV(d.GetLocalCenter()),this.m_localCenterB.SetV(e.GetLocalCenter());var f=d.GetTransform();e.GetTransform(),b=d.m_xf.R;var g=this.m_localAnchor1.x-this.m_localCenterA.x,h=this.m_localAnchor1.y-this.m_localCenterA.y;c=b.col1.x*g+b.col2.x*h,h=b.col1.y*g+b.col2.y*h,g=c,b=e.m_xf.R;var i=this.m_localAnchor2.x-this.m_localCenterB.x,j=this.m_localAnchor2.y-this.m_localCenterB.y;c=b.col1.x*i+b.col2.x*j,j=b.col1.y*i+b.col2.y*j,i=c,b=e.m_sweep.c.x+i-d.m_sweep.c.x-g,c=e.m_sweep.c.y+j-d.m_sweep.c.y-h,this.m_invMassA=d.m_invMass,this.m_invMassB=e.m_invMass,this.m_invIA=d.m_invI,this.m_invIB=e.m_invI,this.m_axis.SetV(b2Math.MulMV(f.R,this.m_localXAxis1)),this.m_a1=(b+g)*this.m_axis.y-(c+h)*this.m_axis.x,this.m_a2=i*this.m_axis.y-j*this.m_axis.x,this.m_motorMass=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_a1*this.m_a1+this.m_invIB*this.m_a2*this.m_a2,this.m_motorMass=this.m_motorMass>Number.MIN_VALUE?1/this.m_motorMass:0,this.m_perp.SetV(b2Math.MulMV(f.R,this.m_localYAxis1)),this.m_s1=(b+g)*this.m_perp.y-(c+h)*this.m_perp.x,this.m_s2=i*this.m_perp.y-j*this.m_perp.x,f=this.m_invMassA,g=this.m_invMassB,h=this.m_invIA,i=this.m_invIB,this.m_K.col1.x=f+g+h*this.m_s1*this.m_s1+i*this.m_s2*this.m_s2,this.m_K.col1.y=h*this.m_s1*this.m_a1+i*this.m_s2*this.m_a2,this.m_K.col2.x=this.m_K.col1.y,this.m_K.col2.y=f+g+h*this.m_a1*this.m_a1+i*this.m_a2*this.m_a2,this.m_enableLimit?(b=this.m_axis.x*b+this.m_axis.y*c,b2Math.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*b2Settings.b2_linearSlop?this.m_limitState=b2Joint.e_equalLimits:b<=this.m_lowerTranslation?this.m_limitState!=b2Joint.e_atLowerLimit&&(this.m_limitState=b2Joint.e_atLowerLimit,this.m_impulse.y=0):b>=this.m_upperTranslation?this.m_limitState!=b2Joint.e_atUpperLimit&&(this.m_limitState=b2Joint.e_atUpperLimit,this.m_impulse.y=0):(this.m_limitState=b2Joint.e_inactiveLimit,this.m_impulse.y=0)):this.m_limitState=b2Joint.e_inactiveLimit,0==this.m_enableMotor&&(this.m_motorImpulse=0),a.warmStarting?(this.m_impulse.x*=a.dtRatio,this.m_impulse.y*=a.dtRatio,this.m_motorImpulse*=a.dtRatio,a=this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.x,b=this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.y,c=this.m_impulse.x*this.m_s1+(this.m_motorImpulse+this.m_impulse.y)*this.m_a1,f=this.m_impulse.x*this.m_s2+(this.m_motorImpulse+this.m_impulse.y)*this.m_a2,d.m_linearVelocity.x-=this.m_invMassA*a,d.m_linearVelocity.y-=this.m_invMassA*b,d.m_angularVelocity-=this.m_invIA*c,e.m_linearVelocity.x+=this.m_invMassB*a,e.m_linearVelocity.y+=this.m_invMassB*b,e.m_angularVelocity+=this.m_invIB*f):(this.m_impulse.SetZero(),this.m_motorImpulse=0)},b2LineJoint.prototype.SolveVelocityConstraints=function(a){var b,c,d,e=this.m_bodyA,f=this.m_bodyB,g=e.m_linearVelocity,h=e.m_angularVelocity,i=f.m_linearVelocity,j=f.m_angularVelocity;this.m_enableMotor&&this.m_limitState!=b2Joint.e_equalLimits&&(d=this.m_motorMass*(this.m_motorSpeed-(this.m_axis.x*(i.x-g.x)+this.m_axis.y*(i.y-g.y)+this.m_a2*j-this.m_a1*h)),b=this.m_motorImpulse,a=a.dt*this.m_maxMotorForce,this.m_motorImpulse=b2Math.Clamp(this.m_motorImpulse+d,-a,a),d=this.m_motorImpulse-b,b=d*this.m_axis.x,a=d*this.m_axis.y,c=d*this.m_a1,d*=this.m_a2,g.x-=this.m_invMassA*b,g.y-=this.m_invMassA*a,h-=this.m_invIA*c,i.x+=this.m_invMassB*b,i.y+=this.m_invMassB*a,j+=this.m_invIB*d),a=this.m_perp.x*(i.x-g.x)+this.m_perp.y*(i.y-g.y)+this.m_s2*j-this.m_s1*h,this.m_enableLimit&&this.m_limitState!=b2Joint.e_inactiveLimit?(c=this.m_axis.x*(i.x-g.x)+this.m_axis.y*(i.y-g.y)+this.m_a2*j-this.m_a1*h,b=this.m_impulse.Copy(),d=this.m_K.Solve(new b2Vec2,-a,-c),this.m_impulse.Add(d),this.m_limitState==b2Joint.e_atLowerLimit?this.m_impulse.y=b2Math.Max(this.m_impulse.y,0):this.m_limitState==b2Joint.e_atUpperLimit&&(this.m_impulse.y=b2Math.Min(this.m_impulse.y,0)),a=-a-(this.m_impulse.y-b.y)*this.m_K.col2.x,this.m_impulse.x=0!=this.m_K.col1.x?a/this.m_K.col1.x+b.x:b.x,d.x=this.m_impulse.x-b.x,d.y=this.m_impulse.y-b.y,b=d.x*this.m_perp.x+d.y*this.m_axis.x,a=d.x*this.m_perp.y+d.y*this.m_axis.y,c=d.x*this.m_s1+d.y*this.m_a1,d=d.x*this.m_s2+d.y*this.m_a2):(d=0!=this.m_K.col1.x?-a/this.m_K.col1.x:0,this.m_impulse.x+=d,b=d*this.m_perp.x,a=d*this.m_perp.y,c=d*this.m_s1,d*=this.m_s2),g.x-=this.m_invMassA*b,g.y-=this.m_invMassA*a,h-=this.m_invIA*c,i.x+=this.m_invMassB*b,i.y+=this.m_invMassB*a,j+=this.m_invIB*d,e.m_linearVelocity.SetV(g),e.m_angularVelocity=h,f.m_linearVelocity.SetV(i),f.m_angularVelocity=j},b2LineJoint.prototype.SolvePositionConstraints=function(){var a,b,c,d,e,f=this.m_bodyA,g=this.m_bodyB,h=f.m_sweep.c,i=f.m_sweep.a,j=g.m_sweep.c,k=g.m_sweep.a,l=0,m=0;c=!1;var n=0,o=b2Mat22.FromAngle(i);d=b2Mat22.FromAngle(k),a=o,m=this.m_localAnchor1.x-this.m_localCenterA.x;var p=this.m_localAnchor1.y-this.m_localCenterA.y;if(b=a.col1.x*m+a.col2.x*p,p=a.col1.y*m+a.col2.y*p,m=b,a=d,d=this.m_localAnchor2.x-this.m_localCenterB.x,e=this.m_localAnchor2.y-this.m_localCenterB.y,b=a.col1.x*d+a.col2.x*e,e=a.col1.y*d+a.col2.y*e,d=b,a=j.x+d-h.x-m,b=j.y+e-h.y-p,this.m_enableLimit){this.m_axis=b2Math.MulMV(o,this.m_localXAxis1),this.m_a1=(a+m)*this.m_axis.y-(b+p)*this.m_axis.x,this.m_a2=d*this.m_axis.y-e*this.m_axis.x;var q=this.m_axis.x*a+this.m_axis.y*b;b2Math.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*b2Settings.b2_linearSlop?(n=b2Math.Clamp(q,-b2Settings.b2_maxLinearCorrection,b2Settings.b2_maxLinearCorrection),l=b2Math.Abs(q),c=!0):q<=this.m_lowerTranslation?(n=b2Math.Clamp(q-this.m_lowerTranslation+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0),l=this.m_lowerTranslation-q,c=!0):q>=this.m_upperTranslation&&(n=b2Math.Clamp(q-this.m_upperTranslation+b2Settings.b2_linearSlop,0,b2Settings.b2_maxLinearCorrection),l=q-this.m_upperTranslation,c=!0)}return this.m_perp=b2Math.MulMV(o,this.m_localYAxis1),this.m_s1=(a+m)*this.m_perp.y-(b+p)*this.m_perp.x,this.m_s2=d*this.m_perp.y-e*this.m_perp.x,o=new b2Vec2,p=this.m_perp.x*a+this.m_perp.y*b,l=b2Math.Max(l,b2Math.Abs(p)),m=0,c?(c=this.m_invMassA,d=this.m_invMassB,e=this.m_invIA,a=this.m_invIB,this.m_K.col1.x=c+d+e*this.m_s1*this.m_s1+a*this.m_s2*this.m_s2,this.m_K.col1.y=e*this.m_s1*this.m_a1+a*this.m_s2*this.m_a2,this.m_K.col2.x=this.m_K.col1.y,this.m_K.col2.y=c+d+e*this.m_a1*this.m_a1+a*this.m_a2*this.m_a2,this.m_K.Solve(o,-p,-n)):(c=this.m_invMassA,d=this.m_invMassB,e=this.m_invIA,a=this.m_invIB,n=c+d+e*this.m_s1*this.m_s1+a*this.m_s2*this.m_s2,o.x=0!=n?-p/n:0,o.y=0),n=o.x*this.m_perp.x+o.y*this.m_axis.x,c=o.x*this.m_perp.y+o.y*this.m_axis.y,p=o.x*this.m_s1+o.y*this.m_a1,o=o.x*this.m_s2+o.y*this.m_a2,h.x-=this.m_invMassA*n,h.y-=this.m_invMassA*c,i-=this.m_invIA*p,j.x+=this.m_invMassB*n,j.y+=this.m_invMassB*c,k+=this.m_invIB*o,f.m_sweep.a=i,g.m_sweep.a=k,f.SynchronizeTransform(),g.SynchronizeTransform(),l<=b2Settings.b2_linearSlop&&m<=b2Settings.b2_angularSlop},b2LineJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},b2LineJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},b2LineJoint.prototype.GetReactionForce=function(a){return new b2Vec2(a*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.x),a*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.y)*this.m_axis.y))},b2LineJoint.prototype.GetReactionTorque=function(a){return a*this.m_impulse.y},b2LineJoint.prototype.GetJointTranslation=function(){var a=this.m_bodyA,b=this.m_bodyB,c=a.GetWorldPoint(this.m_localAnchor1),d=b.GetWorldPoint(this.m_localAnchor2);return b=d.x-c.x,c=d.y-c.y,a=a.GetWorldVector(this.m_localXAxis1),a.x*b+a.y*c},b2LineJoint.prototype.GetJointSpeed=function(){var a,b=this.m_bodyA,c=this.m_bodyB;a=b.m_xf.R;var d=this.m_localAnchor1.x-b.m_sweep.localCenter.x,e=this.m_localAnchor1.y-b.m_sweep.localCenter.y,f=a.col1.x*d+a.col2.x*e;e=a.col1.y*d+a.col2.y*e,d=f,a=c.m_xf.R;var g=this.m_localAnchor2.x-c.m_sweep.localCenter.x,h=this.m_localAnchor2.y-c.m_sweep.localCenter.y;f=a.col1.x*g+a.col2.x*h,h=a.col1.y*g+a.col2.y*h,g=f,a=c.m_sweep.c.x+g-(b.m_sweep.c.x+d),f=c.m_sweep.c.y+h-(b.m_sweep.c.y+e);var i=b.GetWorldVector(this.m_localXAxis1),j=b.m_linearVelocity,k=c.m_linearVelocity;return b=b.m_angularVelocity,c=c.m_angularVelocity,a*-b*i.y+f*b*i.x+(i.x*(k.x+-c*h-j.x- -b*e)+i.y*(k.y+c*g-j.y-b*d))},b2LineJoint.prototype.IsLimitEnabled=function(){return this.m_enableLimit},b2LineJoint.prototype.EnableLimit=function(a){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=a},b2LineJoint.prototype.GetLowerLimit=function(){return this.m_lowerTranslation},b2LineJoint.prototype.GetUpperLimit=function(){return this.m_upperTranslation},b2LineJoint.prototype.SetLimits=function(a,b){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=a,this.m_upperTranslation=b},b2LineJoint.prototype.IsMotorEnabled=function(){return this.m_enableMotor},b2LineJoint.prototype.EnableMotor=function(a){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=a},b2LineJoint.prototype.SetMotorSpeed=function(a){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=a},b2LineJoint.prototype.GetMotorSpeed=function(){return this.m_motorSpeed},b2LineJoint.prototype.SetMaxMotorForce=function(a){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=a},b2LineJoint.prototype.GetMaxMotorForce=function(){return this.m_maxMotorForce},b2LineJoint.prototype.GetMotorForce=function(){return this.m_motorImpulse},b2LineJoint.prototype.m_localAnchor1=new b2Vec2,b2LineJoint.prototype.m_localAnchor2=new b2Vec2,b2LineJoint.prototype.m_localXAxis1=new b2Vec2,b2LineJoint.prototype.m_localYAxis1=new b2Vec2,b2LineJoint.prototype.m_axis=new b2Vec2,b2LineJoint.prototype.m_perp=new b2Vec2,b2LineJoint.prototype.m_s1=null,b2LineJoint.prototype.m_s2=null,b2LineJoint.prototype.m_a1=null,b2LineJoint.prototype.m_a2=null,b2LineJoint.prototype.m_K=new b2Mat22,b2LineJoint.prototype.m_impulse=new b2Vec2,b2LineJoint.prototype.m_motorMass=null,b2LineJoint.prototype.m_motorImpulse=null,b2LineJoint.prototype.m_lowerTranslation=null,b2LineJoint.prototype.m_upperTranslation=null,b2LineJoint.prototype.m_maxMotorForce=null,b2LineJoint.prototype.m_motorSpeed=null,b2LineJoint.prototype.m_enableLimit=null,b2LineJoint.prototype.m_enableMotor=null,b2LineJoint.prototype.m_limitState=0;
var b2ContactSolver=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ContactSolver.prototype.__constructor=function(){},b2ContactSolver.prototype.__varz=function(){this.m_step=new b2TimeStep,this.m_constraints=[]},b2ContactSolver.s_worldManifold=new b2WorldManifold,b2ContactSolver.s_psm=new b2PositionSolverManifold,b2ContactSolver.prototype.Initialize=function(a,b,c,d){var e;for(this.m_step.Set(a),this.m_allocator=d,a=0,this.m_constraintCount=c;this.m_constraints.length<this.m_constraintCount;)this.m_constraints[this.m_constraints.length]=new b2ContactConstraint;for(a=0;c>a;++a){e=b[a],d=e.m_fixtureA;var f=e.m_fixtureB,g=d.m_shape.m_radius,h=f.m_shape.m_radius,i=d.m_body,j=f.m_body,k=e.GetManifold(),l=b2Settings.b2MixFriction(d.GetFriction(),f.GetFriction()),m=b2Settings.b2MixRestitution(d.GetRestitution(),f.GetRestitution()),n=i.m_linearVelocity.x,o=i.m_linearVelocity.y,p=j.m_linearVelocity.x,q=j.m_linearVelocity.y,r=i.m_angularVelocity,s=j.m_angularVelocity;for(b2Settings.b2Assert(k.m_pointCount>0),b2ContactSolver.s_worldManifold.Initialize(k,i.m_xf,g,j.m_xf,h),f=b2ContactSolver.s_worldManifold.m_normal.x,e=b2ContactSolver.s_worldManifold.m_normal.y,d=this.m_constraints[a],d.bodyA=i,d.bodyB=j,d.manifold=k,d.normal.x=f,d.normal.y=e,d.pointCount=k.m_pointCount,d.friction=l,d.restitution=m,d.localPlaneNormal.x=k.m_localPlaneNormal.x,d.localPlaneNormal.y=k.m_localPlaneNormal.y,d.localPoint.x=k.m_localPoint.x,d.localPoint.y=k.m_localPoint.y,d.radius=g+h,d.type=k.m_type,g=0;g<d.pointCount;++g){l=k.m_points[g],h=d.points[g],h.normalImpulse=l.m_normalImpulse,h.tangentImpulse=l.m_tangentImpulse,h.localPoint.SetV(l.m_localPoint),l=h.rA.x=b2ContactSolver.s_worldManifold.m_points[g].x-i.m_sweep.c.x,m=h.rA.y=b2ContactSolver.s_worldManifold.m_points[g].y-i.m_sweep.c.y;var t=h.rB.x=b2ContactSolver.s_worldManifold.m_points[g].x-j.m_sweep.c.x,u=h.rB.y=b2ContactSolver.s_worldManifold.m_points[g].y-j.m_sweep.c.y,v=l*e-m*f,w=t*e-u*f;v*=v,w*=w,h.normalMass=1/(i.m_invMass+j.m_invMass+i.m_invI*v+j.m_invI*w);var x=i.m_mass*i.m_invMass+j.m_mass*j.m_invMass;x+=i.m_mass*i.m_invI*v+j.m_mass*j.m_invI*w,h.equalizedMass=1/x,w=e,x=-f,v=l*x-m*w,w=t*x-u*w,v*=v,w*=w,h.tangentMass=1/(i.m_invMass+j.m_invMass+i.m_invI*v+j.m_invI*w),h.velocityBias=0,l=d.normal.x*(p+-s*u-n- -r*m)+d.normal.y*(q+s*t-o-r*l),l<-b2Settings.b2_velocityThreshold&&(h.velocityBias+=-d.restitution*l)}2==d.pointCount&&(q=d.points[0],p=d.points[1],k=i.m_invMass,i=i.m_invI,n=j.m_invMass,j=j.m_invI,o=q.rA.x*e-q.rA.y*f,q=q.rB.x*e-q.rB.y*f,r=p.rA.x*e-p.rA.y*f,p=p.rB.x*e-p.rB.y*f,f=k+n+i*o*o+j*q*q,e=k+n+i*r*r+j*p*p,j=k+n+i*o*r+j*q*p,100*(f*e-j*j)>f*f?(d.K.col1.Set(f,j),d.K.col2.Set(j,e),d.K.GetInverse(d.normalMass)):d.pointCount=1)}},b2ContactSolver.prototype.InitVelocityConstraints=function(a){for(var b=0;b<this.m_constraintCount;++b){var c=this.m_constraints[b],d=c.bodyA,e=c.bodyB,f=d.m_invMass,g=d.m_invI,h=e.m_invMass,i=e.m_invI,j=c.normal.x,k=c.normal.y,l=k,m=-j,n=0,o=0;if(a.warmStarting)for(o=c.pointCount,n=0;o>n;++n){var p=c.points[n];p.normalImpulse*=a.dtRatio,p.tangentImpulse*=a.dtRatio;var q=p.normalImpulse*j+p.tangentImpulse*l,r=p.normalImpulse*k+p.tangentImpulse*m;d.m_angularVelocity-=g*(p.rA.x*r-p.rA.y*q),d.m_linearVelocity.x-=f*q,d.m_linearVelocity.y-=f*r,e.m_angularVelocity+=i*(p.rB.x*r-p.rB.y*q),e.m_linearVelocity.x+=h*q,e.m_linearVelocity.y+=h*r}else for(o=c.pointCount,n=0;o>n;++n)d=c.points[n],d.normalImpulse=0,d.tangentImpulse=0}},b2ContactSolver.prototype.SolveVelocityConstraints=function(){for(var a,b,c,d,e,f,g,h,i,j=0,k=0;k<this.m_constraintCount;++k){d=this.m_constraints[k];var l=d.bodyA,m=d.bodyB,n=l.m_angularVelocity,o=m.m_angularVelocity,p=l.m_linearVelocity,q=m.m_linearVelocity,r=l.m_invMass,s=l.m_invI,t=m.m_invMass,u=m.m_invI;g=d.normal.x;var v=h=d.normal.y;for(i=-g,f=d.friction,j=0;j<d.pointCount;j++)a=d.points[j],b=q.x-o*a.rB.y-p.x+n*a.rA.y,c=q.y+o*a.rB.x-p.y-n*a.rA.x,b=b*v+c*i,b=a.tangentMass*-b,c=f*a.normalImpulse,c=b2Math.Clamp(a.tangentImpulse+b,-c,c),b=c-a.tangentImpulse,e=b*v,b*=i,p.x-=r*e,p.y-=r*b,n-=s*(a.rA.x*b-a.rA.y*e),q.x+=t*e,q.y+=t*b,o+=u*(a.rB.x*b-a.rB.y*e),a.tangentImpulse=c;if(1==d.pointCount)a=d.points[0],b=q.x+-o*a.rB.y-p.x- -n*a.rA.y,c=q.y+o*a.rB.x-p.y-n*a.rA.x,d=b*g+c*h,b=-a.normalMass*(d-a.velocityBias),c=a.normalImpulse+b,c=c>0?c:0,b=c-a.normalImpulse,e=b*g,b*=h,p.x-=r*e,p.y-=r*b,n-=s*(a.rA.x*b-a.rA.y*e),q.x+=t*e,q.y+=t*b,o+=u*(a.rB.x*b-a.rB.y*e),a.normalImpulse=c;else{a=d.points[0],j=d.points[1],b=a.normalImpulse,f=j.normalImpulse;var w=(q.x-o*a.rB.y-p.x+n*a.rA.y)*g+(q.y+o*a.rB.x-p.y-n*a.rA.x)*h,x=(q.x-o*j.rB.y-p.x+n*j.rA.y)*g+(q.y+o*j.rB.x-p.y-n*j.rA.x)*h;for(c=w-a.velocityBias,e=x-j.velocityBias,i=d.K,c-=i.col1.x*b+i.col2.x*f,e-=i.col1.y*b+i.col2.y*f;;){if(i=d.normalMass,v=-(i.col1.x*c+i.col2.x*e),i=-(i.col1.y*c+i.col2.y*e),v>=0&&i>=0){b=v-b,f=i-f,d=b*g,b*=h,g=f*g,h=f*h,p.x-=r*(d+g),p.y-=r*(b+h),n-=s*(a.rA.x*b-a.rA.y*d+j.rA.x*h-j.rA.y*g),q.x+=t*(d+g),q.y+=t*(b+h),o+=u*(a.rB.x*b-a.rB.y*d+j.rB.x*h-j.rB.y*g),a.normalImpulse=v,j.normalImpulse=i;break}if(v=-a.normalMass*c,i=0,x=d.K.col1.y*v+e,v>=0&&x>=0){b=v-b,f=i-f,d=b*g,b*=h,g=f*g,h=f*h,p.x-=r*(d+g),p.y-=r*(b+h),n-=s*(a.rA.x*b-a.rA.y*d+j.rA.x*h-j.rA.y*g),q.x+=t*(d+g),q.y+=t*(b+h),o+=u*(a.rB.x*b-a.rB.y*d+j.rB.x*h-j.rB.y*g),a.normalImpulse=v,j.normalImpulse=i;break}if(v=0,i=-j.normalMass*e,w=d.K.col2.x*i+c,i>=0&&w>=0){b=v-b,f=i-f,d=b*g,b*=h,g=f*g,h=f*h,p.x-=r*(d+g),p.y-=r*(b+h),n-=s*(a.rA.x*b-a.rA.y*d+j.rA.x*h-j.rA.y*g),q.x+=t*(d+g),q.y+=t*(b+h),o+=u*(a.rB.x*b-a.rB.y*d+j.rB.x*h-j.rB.y*g),a.normalImpulse=v,j.normalImpulse=i;break}if(i=v=0,w=c,x=e,w>=0&&x>=0){b=v-b,f=i-f,d=b*g,b*=h,g=f*g,h=f*h,p.x-=r*(d+g),p.y-=r*(b+h),n-=s*(a.rA.x*b-a.rA.y*d+j.rA.x*h-j.rA.y*g),q.x+=t*(d+g),q.y+=t*(b+h),o+=u*(a.rB.x*b-a.rB.y*d+j.rB.x*h-j.rB.y*g),a.normalImpulse=v,j.normalImpulse=i;break}break}}l.m_angularVelocity=n,m.m_angularVelocity=o}},b2ContactSolver.prototype.FinalizeVelocityConstraints=function(){for(var a=0;a<this.m_constraintCount;++a)for(var b=this.m_constraints[a],c=b.manifold,d=0;d<b.pointCount;++d){var e=c.m_points[d],f=b.points[d];e.m_normalImpulse=f.normalImpulse,e.m_tangentImpulse=f.tangentImpulse}},b2ContactSolver.prototype.SolvePositionConstraints=function(a){for(var b=0,c=0;c<this.m_constraintCount;c++){var d=this.m_constraints[c],e=d.bodyA,f=d.bodyB,g=e.m_mass*e.m_invMass,h=e.m_mass*e.m_invI,i=f.m_mass*f.m_invMass,j=f.m_mass*f.m_invI;b2ContactSolver.s_psm.Initialize(d);for(var k=b2ContactSolver.s_psm.m_normal,l=0;l<d.pointCount;l++){var m=d.points[l],n=b2ContactSolver.s_psm.m_points[l],o=b2ContactSolver.s_psm.m_separations[l],p=n.x-e.m_sweep.c.x,q=n.y-e.m_sweep.c.y,r=n.x-f.m_sweep.c.x;n=n.y-f.m_sweep.c.y,b=o>b?b:o,o=b2Math.Clamp(a*(o+b2Settings.b2_linearSlop),-b2Settings.b2_maxLinearCorrection,0),o=-m.equalizedMass*o,m=o*k.x,o*=k.y,e.m_sweep.c.x-=g*m,e.m_sweep.c.y-=g*o,e.m_sweep.a-=h*(p*o-q*m),e.SynchronizeTransform(),f.m_sweep.c.x+=i*m,f.m_sweep.c.y+=i*o,f.m_sweep.a+=j*(r*o-n*m),f.SynchronizeTransform()}}return b>-1.5*b2Settings.b2_linearSlop},b2ContactSolver.prototype.m_step=new b2TimeStep,b2ContactSolver.prototype.m_allocator=null,b2ContactSolver.prototype.m_constraints=[],b2ContactSolver.prototype.m_constraintCount=0;var b2Simplex=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Simplex.prototype.__constructor=function(){this.m_vertices[0]=this.m_v1,this.m_vertices[1]=this.m_v2,this.m_vertices[2]=this.m_v3},b2Simplex.prototype.__varz=function(){this.m_v1=new b2SimplexVertex,this.m_v2=new b2SimplexVertex,this.m_v3=new b2SimplexVertex,this.m_vertices=Array(3)},b2Simplex.prototype.ReadCache=function(a,b,c,d,e){b2Settings.b2Assert(0<=a.count&&a.count<=3);var f,g;this.m_count=a.count;for(var h=this.m_vertices,i=0;i<this.m_count;i++){var j=h[i];j.indexA=a.indexA[i],j.indexB=a.indexB[i],f=b.GetVertex(j.indexA),g=d.GetVertex(j.indexB),j.wA=b2Math.MulX(c,f),j.wB=b2Math.MulX(e,g),j.w=b2Math.SubtractVV(j.wB,j.wA),j.a=0}this.m_count>1&&(a=a.metric,f=this.GetMetric(),(.5*a>f||f>2*a||f<Number.MIN_VALUE)&&(this.m_count=0)),0==this.m_count&&(j=h[0],j.indexA=0,j.indexB=0,f=b.GetVertex(0),g=d.GetVertex(0),j.wA=b2Math.MulX(c,f),j.wB=b2Math.MulX(e,g),j.w=b2Math.SubtractVV(j.wB,j.wA),this.m_count=1)},b2Simplex.prototype.WriteCache=function(a){a.metric=this.GetMetric(),a.count=parseInt(this.m_count);for(var b=this.m_vertices,c=0;c<this.m_count;c++)a.indexA[c]=parseInt(b[c].indexA),a.indexB[c]=parseInt(b[c].indexB)},b2Simplex.prototype.GetSearchDirection=function(){switch(this.m_count){case 1:return this.m_v1.w.GetNegative();case 2:var a=b2Math.SubtractVV(this.m_v2.w,this.m_v1.w);return b2Math.CrossVV(a,this.m_v1.w.GetNegative())>0?b2Math.CrossFV(1,a):b2Math.CrossVF(a,1);default:return b2Settings.b2Assert(!1),new b2Vec2}},b2Simplex.prototype.GetClosestPoint=function(){switch(this.m_count){case 0:return b2Settings.b2Assert(!1),new b2Vec2;case 1:return this.m_v1.w;case 2:return new b2Vec2(this.m_v1.a*this.m_v1.w.x+this.m_v2.a*this.m_v2.w.x,this.m_v1.a*this.m_v1.w.y+this.m_v2.a*this.m_v2.w.y);default:return b2Settings.b2Assert(!1),new b2Vec2}},b2Simplex.prototype.GetWitnessPoints=function(a,b){switch(this.m_count){case 0:b2Settings.b2Assert(!1);break;case 1:a.SetV(this.m_v1.wA),b.SetV(this.m_v1.wB);break;case 2:a.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x,a.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y,b.x=this.m_v1.a*this.m_v1.wB.x+this.m_v2.a*this.m_v2.wB.x,b.y=this.m_v1.a*this.m_v1.wB.y+this.m_v2.a*this.m_v2.wB.y;break;case 3:b.x=a.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x+this.m_v3.a*this.m_v3.wA.x,b.y=a.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y+this.m_v3.a*this.m_v3.wA.y;break;default:b2Settings.b2Assert(!1)}},b2Simplex.prototype.GetMetric=function(){switch(this.m_count){case 0:return b2Settings.b2Assert(!1),0;case 1:return 0;case 2:return b2Math.SubtractVV(this.m_v1.w,this.m_v2.w).Length();case 3:return b2Math.CrossVV(b2Math.SubtractVV(this.m_v2.w,this.m_v1.w),b2Math.SubtractVV(this.m_v3.w,this.m_v1.w));default:return b2Settings.b2Assert(!1),0}},b2Simplex.prototype.Solve2=function(){var a=this.m_v1.w,b=this.m_v2.w,c=b2Math.SubtractVV(b,a);a=-(a.x*c.x+a.y*c.y),0>=a?this.m_count=this.m_v1.a=1:(b=b.x*c.x+b.y*c.y,0>=b?(this.m_count=this.m_v2.a=1,this.m_v1.Set(this.m_v2)):(c=1/(b+a),this.m_v1.a=b*c,this.m_v2.a=a*c,this.m_count=2))},b2Simplex.prototype.Solve3=function(){var a=this.m_v1.w,b=this.m_v2.w,c=this.m_v3.w,d=b2Math.SubtractVV(b,a),e=b2Math.Dot(a,d),f=b2Math.Dot(b,d);e=-e;var g=b2Math.SubtractVV(c,a),h=b2Math.Dot(a,g),i=b2Math.Dot(c,g);h=-h;var j=b2Math.SubtractVV(c,b),k=b2Math.Dot(b,j);j=b2Math.Dot(c,j),k=-k,g=b2Math.CrossVV(d,g),d=g*b2Math.CrossVV(b,c),c=g*b2Math.CrossVV(c,a),a=g*b2Math.CrossVV(a,b),0>=e&&0>=h?this.m_count=this.m_v1.a=1:f>0&&e>0&&0>=a?(i=1/(f+e),this.m_v1.a=f*i,this.m_v2.a=e*i,this.m_count=2):i>0&&h>0&&0>=c?(f=1/(i+h),this.m_v1.a=i*f,this.m_v3.a=h*f,this.m_count=2,this.m_v2.Set(this.m_v3)):0>=f&&0>=k?(this.m_count=this.m_v2.a=1,this.m_v1.Set(this.m_v2)):0>=i&&0>=j?(this.m_count=this.m_v3.a=1,this.m_v1.Set(this.m_v3)):j>0&&k>0&&0>=d?(f=1/(j+k),this.m_v2.a=j*f,this.m_v3.a=k*f,this.m_count=2,this.m_v1.Set(this.m_v3)):(f=1/(d+c+a),this.m_v1.a=d*f,this.m_v2.a=c*f,this.m_v3.a=a*f,this.m_count=3)},b2Simplex.prototype.m_v1=new b2SimplexVertex,b2Simplex.prototype.m_v2=new b2SimplexVertex,b2Simplex.prototype.m_v3=new b2SimplexVertex,b2Simplex.prototype.m_vertices=Array(3),b2Simplex.prototype.m_count=0;var b2WeldJoint=function(){b2Joint.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2WeldJoint.prototype,b2Joint.prototype),b2WeldJoint.prototype._super=b2Joint.prototype,b2WeldJoint.prototype.__constructor=function(a){this._super.__constructor.apply(this,[a]),this.m_localAnchorA.SetV(a.localAnchorA),this.m_localAnchorB.SetV(a.localAnchorB),this.m_referenceAngle=a.referenceAngle,this.m_impulse.SetZero(),this.m_mass=new b2Mat33},b2WeldJoint.prototype.__varz=function(){this.m_localAnchorA=new b2Vec2,this.m_localAnchorB=new b2Vec2,this.m_impulse=new b2Vec3,this.m_mass=new b2Mat33},b2WeldJoint.prototype.InitVelocityConstraints=function(a){var b,c,d=this.m_bodyA,e=this.m_bodyB;b=d.m_xf.R;var f=this.m_localAnchorA.x-d.m_sweep.localCenter.x,g=this.m_localAnchorA.y-d.m_sweep.localCenter.y;c=b.col1.x*f+b.col2.x*g,g=b.col1.y*f+b.col2.y*g,f=c,b=e.m_xf.R;var h=this.m_localAnchorB.x-e.m_sweep.localCenter.x,i=this.m_localAnchorB.y-e.m_sweep.localCenter.y;c=b.col1.x*h+b.col2.x*i,i=b.col1.y*h+b.col2.y*i,h=c,b=d.m_invMass,c=e.m_invMass;var j=d.m_invI,k=e.m_invI;this.m_mass.col1.x=b+c+g*g*j+i*i*k,this.m_mass.col2.x=-g*f*j-i*h*k,this.m_mass.col3.x=-g*j-i*k,this.m_mass.col1.y=this.m_mass.col2.x,this.m_mass.col2.y=b+c+f*f*j+h*h*k,this.m_mass.col3.y=f*j+h*k,this.m_mass.col1.z=this.m_mass.col3.x,this.m_mass.col2.z=this.m_mass.col3.y,this.m_mass.col3.z=j+k,a.warmStarting?(this.m_impulse.x*=a.dtRatio,this.m_impulse.y*=a.dtRatio,this.m_impulse.z*=a.dtRatio,d.m_linearVelocity.x-=b*this.m_impulse.x,d.m_linearVelocity.y-=b*this.m_impulse.y,d.m_angularVelocity-=j*(f*this.m_impulse.y-g*this.m_impulse.x+this.m_impulse.z),e.m_linearVelocity.x+=c*this.m_impulse.x,e.m_linearVelocity.y+=c*this.m_impulse.y,e.m_angularVelocity+=k*(h*this.m_impulse.y-i*this.m_impulse.x+this.m_impulse.z)):this.m_impulse.SetZero()},b2WeldJoint.prototype.SolveVelocityConstraints=function(){var a,b,c=this.m_bodyA,d=this.m_bodyB,e=c.m_linearVelocity,f=c.m_angularVelocity,g=d.m_linearVelocity,h=d.m_angularVelocity,i=c.m_invMass,j=d.m_invMass,k=c.m_invI,l=d.m_invI;a=c.m_xf.R;var m=this.m_localAnchorA.x-c.m_sweep.localCenter.x,n=this.m_localAnchorA.y-c.m_sweep.localCenter.y;b=a.col1.x*m+a.col2.x*n,n=a.col1.y*m+a.col2.y*n,m=b,a=d.m_xf.R;var o=this.m_localAnchorB.x-d.m_sweep.localCenter.x,p=this.m_localAnchorB.y-d.m_sweep.localCenter.y;b=a.col1.x*o+a.col2.x*p,p=a.col1.y*o+a.col2.y*p,o=b,a=g.x-h*p-e.x+f*n,b=g.y+h*o-e.y-f*m;var q=h-f,r=new b2Vec3;this.m_mass.Solve33(r,-a,-b,-q),this.m_impulse.Add(r),e.x-=i*r.x,e.y-=i*r.y,f-=k*(m*r.y-n*r.x+r.z),g.x+=j*r.x,g.y+=j*r.y,h+=l*(o*r.y-p*r.x+r.z),c.m_angularVelocity=f,d.m_angularVelocity=h},b2WeldJoint.prototype.SolvePositionConstraints=function(){var a,b,c=this.m_bodyA,d=this.m_bodyB;a=c.m_xf.R;var e=this.m_localAnchorA.x-c.m_sweep.localCenter.x,f=this.m_localAnchorA.y-c.m_sweep.localCenter.y;b=a.col1.x*e+a.col2.x*f,f=a.col1.y*e+a.col2.y*f,e=b,a=d.m_xf.R;var g=this.m_localAnchorB.x-d.m_sweep.localCenter.x,h=this.m_localAnchorB.y-d.m_sweep.localCenter.y;b=a.col1.x*g+a.col2.x*h,h=a.col1.y*g+a.col2.y*h,g=b,a=c.m_invMass,b=d.m_invMass;var i=c.m_invI,j=d.m_invI,k=d.m_sweep.c.x+g-c.m_sweep.c.x-e,l=d.m_sweep.c.y+h-c.m_sweep.c.y-f,m=d.m_sweep.a-c.m_sweep.a-this.m_referenceAngle,n=10*b2Settings.b2_linearSlop,o=Math.sqrt(k*k+l*l),p=b2Math.Abs(m);return o>n&&(i*=1,j*=1),this.m_mass.col1.x=a+b+f*f*i+h*h*j,this.m_mass.col2.x=-f*e*i-h*g*j,this.m_mass.col3.x=-f*i-h*j,this.m_mass.col1.y=this.m_mass.col2.x,this.m_mass.col2.y=a+b+e*e*i+g*g*j,this.m_mass.col3.y=e*i+g*j,this.m_mass.col1.z=this.m_mass.col3.x,this.m_mass.col2.z=this.m_mass.col3.y,this.m_mass.col3.z=i+j,n=new b2Vec3,this.m_mass.Solve33(n,-k,-l,-m),c.m_sweep.c.x-=a*n.x,c.m_sweep.c.y-=a*n.y,c.m_sweep.a-=i*(e*n.y-f*n.x+n.z),d.m_sweep.c.x+=b*n.x,d.m_sweep.c.y+=b*n.y,d.m_sweep.a+=j*(g*n.y-h*n.x+n.z),c.SynchronizeTransform(),d.SynchronizeTransform(),o<=b2Settings.b2_linearSlop&&p<=b2Settings.b2_angularSlop},b2WeldJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA)},b2WeldJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB)},b2WeldJoint.prototype.GetReactionForce=function(a){return new b2Vec2(a*this.m_impulse.x,a*this.m_impulse.y)},b2WeldJoint.prototype.GetReactionTorque=function(a){return a*this.m_impulse.z},b2WeldJoint.prototype.m_localAnchorA=new b2Vec2,b2WeldJoint.prototype.m_localAnchorB=new b2Vec2,b2WeldJoint.prototype.m_referenceAngle=null,b2WeldJoint.prototype.m_impulse=new b2Vec3,b2WeldJoint.prototype.m_mass=new b2Mat33;var b2Math=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Math.prototype.__constructor=function(){},b2Math.prototype.__varz=function(){},b2Math.IsValid=function(a){return isFinite(a)},b2Math.Dot=function(a,b){return a.x*b.x+a.y*b.y},b2Math.CrossVV=function(a,b){return a.x*b.y-a.y*b.x},b2Math.CrossVF=function(a,b){return new b2Vec2(b*a.y,-b*a.x)},b2Math.CrossFV=function(a,b){return new b2Vec2(-a*b.y,a*b.x)},b2Math.MulMV=function(a,b){return new b2Vec2(a.col1.x*b.x+a.col2.x*b.y,a.col1.y*b.x+a.col2.y*b.y)},b2Math.MulTMV=function(a,b){return new b2Vec2(b2Math.Dot(b,a.col1),b2Math.Dot(b,a.col2))},b2Math.MulX=function(a,b){var c=b2Math.MulMV(a.R,b);return c.x+=a.position.x,c.y+=a.position.y,c},b2Math.MulXT=function(a,b){var c=b2Math.SubtractVV(b,a.position),d=c.x*a.R.col1.x+c.y*a.R.col1.y;return c.y=c.x*a.R.col2.x+c.y*a.R.col2.y,c.x=d,c},b2Math.AddVV=function(a,b){return new b2Vec2(a.x+b.x,a.y+b.y)},b2Math.SubtractVV=function(a,b){return new b2Vec2(a.x-b.x,a.y-b.y)},b2Math.Distance=function(a,b){var c=a.x-b.x,d=a.y-b.y;return Math.sqrt(c*c+d*d)},b2Math.DistanceSquared=function(a,b){var c=a.x-b.x,d=a.y-b.y;return c*c+d*d},b2Math.MulFV=function(a,b){return new b2Vec2(a*b.x,a*b.y)},b2Math.AddMM=function(a,b){return b2Mat22.FromVV(b2Math.AddVV(a.col1,b.col1),b2Math.AddVV(a.col2,b.col2))},b2Math.MulMM=function(a,b){return b2Mat22.FromVV(b2Math.MulMV(a,b.col1),b2Math.MulMV(a,b.col2))},b2Math.MulTMM=function(a,b){var c=new b2Vec2(b2Math.Dot(a.col1,b.col1),b2Math.Dot(a.col2,b.col1)),d=new b2Vec2(b2Math.Dot(a.col1,b.col2),b2Math.Dot(a.col2,b.col2));return b2Mat22.FromVV(c,d)},b2Math.Abs=function(a){return a>0?a:-a},b2Math.AbsV=function(a){return new b2Vec2(b2Math.Abs(a.x),b2Math.Abs(a.y))},b2Math.AbsM=function(a){return b2Mat22.FromVV(b2Math.AbsV(a.col1),b2Math.AbsV(a.col2))},b2Math.Min=function(a,b){return b>a?a:b},b2Math.MinV=function(a,b){return new b2Vec2(b2Math.Min(a.x,b.x),b2Math.Min(a.y,b.y))},b2Math.Max=function(a,b){return a>b?a:b},b2Math.MaxV=function(a,b){return new b2Vec2(b2Math.Max(a.x,b.x),b2Math.Max(a.y,b.y))},b2Math.Clamp=function(a,b,c){return b>a?b:a>c?c:a},b2Math.ClampV=function(a,b,c){return b2Math.MaxV(b,b2Math.MinV(a,c))},b2Math.Swap=function(a,b){var c=a[0];a[0]=b[0],b[0]=c},b2Math.Random=function(){return 2*Math.random()-1},b2Math.RandomRange=function(a,b){var c=Math.random();return c=(b-a)*c+a},b2Math.NextPowerOfTwo=function(a){return a|=a>>1&2147483647,a|=a>>2&1073741823,a|=a>>4&268435455,a|=a>>8&16777215,a|=a>>16&65535,a+1},b2Math.IsPowerOfTwo=function(a){return a>0&&0==(a&a-1)},b2Math.b2Vec2_zero=new b2Vec2(0,0),b2Math.b2Mat22_identity=b2Mat22.FromVV(new b2Vec2(1,0),new b2Vec2(0,1)),b2Math.b2Transform_identity=new b2Transform(b2Math.b2Vec2_zero,b2Math.b2Mat22_identity);var b2PulleyJoint=function(){b2Joint.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2PulleyJoint.prototype,b2Joint.prototype),b2PulleyJoint.prototype._super=b2Joint.prototype,b2PulleyJoint.prototype.__constructor=function(a){this._super.__constructor.apply(this,[a]),this.m_ground=this.m_bodyA.m_world.m_groundBody,this.m_groundAnchor1.x=a.groundAnchorA.x-this.m_ground.m_xf.position.x,this.m_groundAnchor1.y=a.groundAnchorA.y-this.m_ground.m_xf.position.y,this.m_groundAnchor2.x=a.groundAnchorB.x-this.m_ground.m_xf.position.x,this.m_groundAnchor2.y=a.groundAnchorB.y-this.m_ground.m_xf.position.y,this.m_localAnchor1.SetV(a.localAnchorA),this.m_localAnchor2.SetV(a.localAnchorB),this.m_ratio=a.ratio,this.m_constant=a.lengthA+this.m_ratio*a.lengthB,this.m_maxLength1=b2Math.Min(a.maxLengthA,this.m_constant-this.m_ratio*b2PulleyJoint.b2_minPulleyLength),this.m_maxLength2=b2Math.Min(a.maxLengthB,(this.m_constant-b2PulleyJoint.b2_minPulleyLength)/this.m_ratio),this.m_limitImpulse2=this.m_limitImpulse1=this.m_impulse=0},b2PulleyJoint.prototype.__varz=function(){this.m_groundAnchor1=new b2Vec2,this.m_groundAnchor2=new b2Vec2,this.m_localAnchor1=new b2Vec2,this.m_localAnchor2=new b2Vec2,this.m_u1=new b2Vec2,this.m_u2=new b2Vec2},b2PulleyJoint.b2_minPulleyLength=2,b2PulleyJoint.prototype.InitVelocityConstraints=function(a){var b,c=this.m_bodyA,d=this.m_bodyB;b=c.m_xf.R;var e=this.m_localAnchor1.x-c.m_sweep.localCenter.x,f=this.m_localAnchor1.y-c.m_sweep.localCenter.y,g=b.col1.x*e+b.col2.x*f;f=b.col1.y*e+b.col2.y*f,e=g,b=d.m_xf.R;var h=this.m_localAnchor2.x-d.m_sweep.localCenter.x,i=this.m_localAnchor2.y-d.m_sweep.localCenter.y;g=b.col1.x*h+b.col2.x*i,i=b.col1.y*h+b.col2.y*i,h=g,b=d.m_sweep.c.x+h,g=d.m_sweep.c.y+i;var j=this.m_ground.m_xf.position.x+this.m_groundAnchor2.x,k=this.m_ground.m_xf.position.y+this.m_groundAnchor2.y;this.m_u1.Set(c.m_sweep.c.x+e-(this.m_ground.m_xf.position.x+this.m_groundAnchor1.x),c.m_sweep.c.y+f-(this.m_ground.m_xf.position.y+this.m_groundAnchor1.y)),this.m_u2.Set(b-j,g-k),b=this.m_u1.Length(),g=this.m_u2.Length(),b>b2Settings.b2_linearSlop?this.m_u1.Multiply(1/b):this.m_u1.SetZero(),g>b2Settings.b2_linearSlop?this.m_u2.Multiply(1/g):this.m_u2.SetZero(),this.m_constant-b-this.m_ratio*g>0?(this.m_state=b2Joint.e_inactiveLimit,this.m_impulse=0):this.m_state=b2Joint.e_atUpperLimit,b<this.m_maxLength1?(this.m_limitState1=b2Joint.e_inactiveLimit,this.m_limitImpulse1=0):this.m_limitState1=b2Joint.e_atUpperLimit,g<this.m_maxLength2?(this.m_limitState2=b2Joint.e_inactiveLimit,this.m_limitImpulse2=0):this.m_limitState2=b2Joint.e_atUpperLimit,b=e*this.m_u1.y-f*this.m_u1.x,g=h*this.m_u2.y-i*this.m_u2.x,this.m_limitMass1=c.m_invMass+c.m_invI*b*b,this.m_limitMass2=d.m_invMass+d.m_invI*g*g,this.m_pulleyMass=this.m_limitMass1+this.m_ratio*this.m_ratio*this.m_limitMass2,this.m_limitMass1=1/this.m_limitMass1,this.m_limitMass2=1/this.m_limitMass2,this.m_pulleyMass=1/this.m_pulleyMass,a.warmStarting?(this.m_impulse*=a.dtRatio,this.m_limitImpulse1*=a.dtRatio,this.m_limitImpulse2*=a.dtRatio,a=(-this.m_impulse-this.m_limitImpulse1)*this.m_u1.x,b=(-this.m_impulse-this.m_limitImpulse1)*this.m_u1.y,g=(-this.m_ratio*this.m_impulse-this.m_limitImpulse2)*this.m_u2.x,j=(-this.m_ratio*this.m_impulse-this.m_limitImpulse2)*this.m_u2.y,c.m_linearVelocity.x+=c.m_invMass*a,c.m_linearVelocity.y+=c.m_invMass*b,c.m_angularVelocity+=c.m_invI*(e*b-f*a),d.m_linearVelocity.x+=d.m_invMass*g,d.m_linearVelocity.y+=d.m_invMass*j,d.m_angularVelocity+=d.m_invI*(h*j-i*g)):this.m_limitImpulse2=this.m_limitImpulse1=this.m_impulse=0},b2PulleyJoint.prototype.SolveVelocityConstraints=function(){var a,b=this.m_bodyA,c=this.m_bodyB;a=b.m_xf.R;var d=this.m_localAnchor1.x-b.m_sweep.localCenter.x,e=this.m_localAnchor1.y-b.m_sweep.localCenter.y,f=a.col1.x*d+a.col2.x*e;e=a.col1.y*d+a.col2.y*e,d=f,a=c.m_xf.R;var g=this.m_localAnchor2.x-c.m_sweep.localCenter.x,h=this.m_localAnchor2.y-c.m_sweep.localCenter.y;f=a.col1.x*g+a.col2.x*h,h=a.col1.y*g+a.col2.y*h,g=f;var i,j;this.m_state==b2Joint.e_atUpperLimit&&(a=b.m_linearVelocity.x+-b.m_angularVelocity*e,f=b.m_linearVelocity.y+b.m_angularVelocity*d,i=c.m_linearVelocity.x+-c.m_angularVelocity*h,j=c.m_linearVelocity.y+c.m_angularVelocity*g,a=-(this.m_u1.x*a+this.m_u1.y*f)-this.m_ratio*(this.m_u2.x*i+this.m_u2.y*j),j=this.m_pulleyMass*-a,a=this.m_impulse,this.m_impulse=b2Math.Max(0,this.m_impulse+j),j=this.m_impulse-a,a=-j*this.m_u1.x,f=-j*this.m_u1.y,i=-this.m_ratio*j*this.m_u2.x,j=-this.m_ratio*j*this.m_u2.y,b.m_linearVelocity.x+=b.m_invMass*a,b.m_linearVelocity.y+=b.m_invMass*f,b.m_angularVelocity+=b.m_invI*(d*f-e*a),c.m_linearVelocity.x+=c.m_invMass*i,c.m_linearVelocity.y+=c.m_invMass*j,c.m_angularVelocity+=c.m_invI*(g*j-h*i)),this.m_limitState1==b2Joint.e_atUpperLimit&&(a=b.m_linearVelocity.x+-b.m_angularVelocity*e,f=b.m_linearVelocity.y+b.m_angularVelocity*d,a=-(this.m_u1.x*a+this.m_u1.y*f),j=-this.m_limitMass1*a,a=this.m_limitImpulse1,this.m_limitImpulse1=b2Math.Max(0,this.m_limitImpulse1+j),j=this.m_limitImpulse1-a,a=-j*this.m_u1.x,f=-j*this.m_u1.y,b.m_linearVelocity.x+=b.m_invMass*a,b.m_linearVelocity.y+=b.m_invMass*f,b.m_angularVelocity+=b.m_invI*(d*f-e*a)),this.m_limitState2==b2Joint.e_atUpperLimit&&(i=c.m_linearVelocity.x+-c.m_angularVelocity*h,j=c.m_linearVelocity.y+c.m_angularVelocity*g,a=-(this.m_u2.x*i+this.m_u2.y*j),j=-this.m_limitMass2*a,a=this.m_limitImpulse2,this.m_limitImpulse2=b2Math.Max(0,this.m_limitImpulse2+j),j=this.m_limitImpulse2-a,i=-j*this.m_u2.x,j=-j*this.m_u2.y,c.m_linearVelocity.x+=c.m_invMass*i,c.m_linearVelocity.y+=c.m_invMass*j,c.m_angularVelocity+=c.m_invI*(g*j-h*i))},b2PulleyJoint.prototype.SolvePositionConstraints=function(){var a,b,c,d,e,f,g,h,i=this.m_bodyA,j=this.m_bodyB,k=this.m_ground.m_xf.position.x+this.m_groundAnchor1.x,l=this.m_ground.m_xf.position.y+this.m_groundAnchor1.y,m=this.m_ground.m_xf.position.x+this.m_groundAnchor2.x,n=this.m_ground.m_xf.position.y+this.m_groundAnchor2.y,o=0;return this.m_state==b2Joint.e_atUpperLimit&&(a=i.m_xf.R,b=this.m_localAnchor1.x-i.m_sweep.localCenter.x,c=this.m_localAnchor1.y-i.m_sweep.localCenter.y,f=a.col1.x*b+a.col2.x*c,c=a.col1.y*b+a.col2.y*c,b=f,a=j.m_xf.R,d=this.m_localAnchor2.x-j.m_sweep.localCenter.x,e=this.m_localAnchor2.y-j.m_sweep.localCenter.y,f=a.col1.x*d+a.col2.x*e,e=a.col1.y*d+a.col2.y*e,d=f,a=i.m_sweep.c.x+b,f=i.m_sweep.c.y+c,g=j.m_sweep.c.x+d,h=j.m_sweep.c.y+e,this.m_u1.Set(a-k,f-l),this.m_u2.Set(g-m,h-n),a=this.m_u1.Length(),f=this.m_u2.Length(),a>b2Settings.b2_linearSlop?this.m_u1.Multiply(1/a):this.m_u1.SetZero(),f>b2Settings.b2_linearSlop?this.m_u2.Multiply(1/f):this.m_u2.SetZero(),a=this.m_constant-a-this.m_ratio*f,o=b2Math.Max(o,-a),a=b2Math.Clamp(a+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0),h=-this.m_pulleyMass*a,a=-h*this.m_u1.x,f=-h*this.m_u1.y,g=-this.m_ratio*h*this.m_u2.x,h=-this.m_ratio*h*this.m_u2.y,i.m_sweep.c.x+=i.m_invMass*a,i.m_sweep.c.y+=i.m_invMass*f,i.m_sweep.a+=i.m_invI*(b*f-c*a),j.m_sweep.c.x+=j.m_invMass*g,j.m_sweep.c.y+=j.m_invMass*h,j.m_sweep.a+=j.m_invI*(d*h-e*g),i.SynchronizeTransform(),j.SynchronizeTransform()),this.m_limitState1==b2Joint.e_atUpperLimit&&(a=i.m_xf.R,b=this.m_localAnchor1.x-i.m_sweep.localCenter.x,c=this.m_localAnchor1.y-i.m_sweep.localCenter.y,f=a.col1.x*b+a.col2.x*c,c=a.col1.y*b+a.col2.y*c,b=f,a=i.m_sweep.c.x+b,f=i.m_sweep.c.y+c,this.m_u1.Set(a-k,f-l),a=this.m_u1.Length(),a>b2Settings.b2_linearSlop?(this.m_u1.x*=1/a,this.m_u1.y*=1/a):this.m_u1.SetZero(),a=this.m_maxLength1-a,o=b2Math.Max(o,-a),a=b2Math.Clamp(a+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0),h=-this.m_limitMass1*a,a=-h*this.m_u1.x,f=-h*this.m_u1.y,i.m_sweep.c.x+=i.m_invMass*a,i.m_sweep.c.y+=i.m_invMass*f,i.m_sweep.a+=i.m_invI*(b*f-c*a),i.SynchronizeTransform()),this.m_limitState2==b2Joint.e_atUpperLimit&&(a=j.m_xf.R,d=this.m_localAnchor2.x-j.m_sweep.localCenter.x,e=this.m_localAnchor2.y-j.m_sweep.localCenter.y,f=a.col1.x*d+a.col2.x*e,e=a.col1.y*d+a.col2.y*e,d=f,g=j.m_sweep.c.x+d,h=j.m_sweep.c.y+e,this.m_u2.Set(g-m,h-n),f=this.m_u2.Length(),f>b2Settings.b2_linearSlop?(this.m_u2.x*=1/f,this.m_u2.y*=1/f):this.m_u2.SetZero(),a=this.m_maxLength2-f,o=b2Math.Max(o,-a),a=b2Math.Clamp(a+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0),h=-this.m_limitMass2*a,g=-h*this.m_u2.x,h=-h*this.m_u2.y,j.m_sweep.c.x+=j.m_invMass*g,j.m_sweep.c.y+=j.m_invMass*h,j.m_sweep.a+=j.m_invI*(d*h-e*g),j.SynchronizeTransform()),o<b2Settings.b2_linearSlop},b2PulleyJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},b2PulleyJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},b2PulleyJoint.prototype.GetReactionForce=function(a){return new b2Vec2(a*this.m_impulse*this.m_u2.x,a*this.m_impulse*this.m_u2.y)},b2PulleyJoint.prototype.GetReactionTorque=function(){return 0},b2PulleyJoint.prototype.GetGroundAnchorA=function(){var a=this.m_ground.m_xf.position.Copy();return a.Add(this.m_groundAnchor1),a},b2PulleyJoint.prototype.GetGroundAnchorB=function(){var a=this.m_ground.m_xf.position.Copy();return a.Add(this.m_groundAnchor2),a},b2PulleyJoint.prototype.GetLength1=function(){var a=this.m_bodyA.GetWorldPoint(this.m_localAnchor1),b=a.x-(this.m_ground.m_xf.position.x+this.m_groundAnchor1.x);return a=a.y-(this.m_ground.m_xf.position.y+this.m_groundAnchor1.y),Math.sqrt(b*b+a*a)},b2PulleyJoint.prototype.GetLength2=function(){var a=this.m_bodyB.GetWorldPoint(this.m_localAnchor2),b=a.x-(this.m_ground.m_xf.position.x+this.m_groundAnchor2.x);return a=a.y-(this.m_ground.m_xf.position.y+this.m_groundAnchor2.y),Math.sqrt(b*b+a*a)},b2PulleyJoint.prototype.GetRatio=function(){return this.m_ratio},b2PulleyJoint.prototype.m_ground=null,b2PulleyJoint.prototype.m_groundAnchor1=new b2Vec2,b2PulleyJoint.prototype.m_groundAnchor2=new b2Vec2,b2PulleyJoint.prototype.m_localAnchor1=new b2Vec2,b2PulleyJoint.prototype.m_localAnchor2=new b2Vec2,b2PulleyJoint.prototype.m_u1=new b2Vec2,b2PulleyJoint.prototype.m_u2=new b2Vec2,b2PulleyJoint.prototype.m_constant=null,b2PulleyJoint.prototype.m_ratio=null,b2PulleyJoint.prototype.m_maxLength1=null,b2PulleyJoint.prototype.m_maxLength2=null,b2PulleyJoint.prototype.m_pulleyMass=null,b2PulleyJoint.prototype.m_limitMass1=null,b2PulleyJoint.prototype.m_limitMass2=null,b2PulleyJoint.prototype.m_impulse=null,b2PulleyJoint.prototype.m_limitImpulse1=null,b2PulleyJoint.prototype.m_limitImpulse2=null,b2PulleyJoint.prototype.m_state=0,b2PulleyJoint.prototype.m_limitState1=0,b2PulleyJoint.prototype.m_limitState2=0;var b2PrismaticJoint=function(){b2Joint.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2PrismaticJoint.prototype,b2Joint.prototype),b2PrismaticJoint.prototype._super=b2Joint.prototype,b2PrismaticJoint.prototype.__constructor=function(a){this._super.__constructor.apply(this,[a]),this.m_localAnchor1.SetV(a.localAnchorA),this.m_localAnchor2.SetV(a.localAnchorB),this.m_localXAxis1.SetV(a.localAxisA),this.m_localYAxis1.x=-this.m_localXAxis1.y,this.m_localYAxis1.y=this.m_localXAxis1.x,this.m_refAngle=a.referenceAngle,this.m_impulse.SetZero(),this.m_motorImpulse=this.m_motorMass=0,this.m_lowerTranslation=a.lowerTranslation,this.m_upperTranslation=a.upperTranslation,this.m_maxMotorForce=a.maxMotorForce,this.m_motorSpeed=a.motorSpeed,this.m_enableLimit=a.enableLimit,this.m_enableMotor=a.enableMotor,this.m_limitState=b2Joint.e_inactiveLimit,this.m_axis.SetZero(),this.m_perp.SetZero()},b2PrismaticJoint.prototype.__varz=function(){this.m_localAnchor1=new b2Vec2,this.m_localAnchor2=new b2Vec2,this.m_localXAxis1=new b2Vec2,this.m_localYAxis1=new b2Vec2,this.m_axis=new b2Vec2,this.m_perp=new b2Vec2,this.m_K=new b2Mat33,this.m_impulse=new b2Vec3},b2PrismaticJoint.prototype.InitVelocityConstraints=function(a){var b,c,d=this.m_bodyA,e=this.m_bodyB;this.m_localCenterA.SetV(d.GetLocalCenter()),this.m_localCenterB.SetV(e.GetLocalCenter());var f=d.GetTransform();e.GetTransform(),b=d.m_xf.R;var g=this.m_localAnchor1.x-this.m_localCenterA.x,h=this.m_localAnchor1.y-this.m_localCenterA.y;c=b.col1.x*g+b.col2.x*h,h=b.col1.y*g+b.col2.y*h,g=c,b=e.m_xf.R;var i=this.m_localAnchor2.x-this.m_localCenterB.x,j=this.m_localAnchor2.y-this.m_localCenterB.y;c=b.col1.x*i+b.col2.x*j,j=b.col1.y*i+b.col2.y*j,i=c,b=e.m_sweep.c.x+i-d.m_sweep.c.x-g,c=e.m_sweep.c.y+j-d.m_sweep.c.y-h,this.m_invMassA=d.m_invMass,this.m_invMassB=e.m_invMass,this.m_invIA=d.m_invI,this.m_invIB=e.m_invI,this.m_axis.SetV(b2Math.MulMV(f.R,this.m_localXAxis1)),this.m_a1=(b+g)*this.m_axis.y-(c+h)*this.m_axis.x,this.m_a2=i*this.m_axis.y-j*this.m_axis.x,this.m_motorMass=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_a1*this.m_a1+this.m_invIB*this.m_a2*this.m_a2,this.m_motorMass>Number.MIN_VALUE&&(this.m_motorMass=1/this.m_motorMass),this.m_perp.SetV(b2Math.MulMV(f.R,this.m_localYAxis1)),this.m_s1=(b+g)*this.m_perp.y-(c+h)*this.m_perp.x,this.m_s2=i*this.m_perp.y-j*this.m_perp.x,f=this.m_invMassA,g=this.m_invMassB,h=this.m_invIA,i=this.m_invIB,this.m_K.col1.x=f+g+h*this.m_s1*this.m_s1+i*this.m_s2*this.m_s2,this.m_K.col1.y=h*this.m_s1+i*this.m_s2,this.m_K.col1.z=h*this.m_s1*this.m_a1+i*this.m_s2*this.m_a2,this.m_K.col2.x=this.m_K.col1.y,this.m_K.col2.y=h+i,this.m_K.col2.z=h*this.m_a1+i*this.m_a2,this.m_K.col3.x=this.m_K.col1.z,this.m_K.col3.y=this.m_K.col2.z,this.m_K.col3.z=f+g+h*this.m_a1*this.m_a1+i*this.m_a2*this.m_a2,this.m_enableLimit?(b=this.m_axis.x*b+this.m_axis.y*c,b2Math.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*b2Settings.b2_linearSlop?this.m_limitState=b2Joint.e_equalLimits:b<=this.m_lowerTranslation?this.m_limitState!=b2Joint.e_atLowerLimit&&(this.m_limitState=b2Joint.e_atLowerLimit,this.m_impulse.z=0):b>=this.m_upperTranslation?this.m_limitState!=b2Joint.e_atUpperLimit&&(this.m_limitState=b2Joint.e_atUpperLimit,this.m_impulse.z=0):(this.m_limitState=b2Joint.e_inactiveLimit,this.m_impulse.z=0)):this.m_limitState=b2Joint.e_inactiveLimit,0==this.m_enableMotor&&(this.m_motorImpulse=0),a.warmStarting?(this.m_impulse.x*=a.dtRatio,this.m_impulse.y*=a.dtRatio,this.m_motorImpulse*=a.dtRatio,a=this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x,b=this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y,c=this.m_impulse.x*this.m_s1+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a1,f=this.m_impulse.x*this.m_s2+this.m_impulse.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_a2,d.m_linearVelocity.x-=this.m_invMassA*a,d.m_linearVelocity.y-=this.m_invMassA*b,d.m_angularVelocity-=this.m_invIA*c,e.m_linearVelocity.x+=this.m_invMassB*a,e.m_linearVelocity.y+=this.m_invMassB*b,e.m_angularVelocity+=this.m_invIB*f):(this.m_impulse.SetZero(),this.m_motorImpulse=0)
},b2PrismaticJoint.prototype.SolveVelocityConstraints=function(a){var b,c,d,e=this.m_bodyA,f=this.m_bodyB,g=e.m_linearVelocity,h=e.m_angularVelocity,i=f.m_linearVelocity,j=f.m_angularVelocity;this.m_enableMotor&&this.m_limitState!=b2Joint.e_equalLimits&&(d=this.m_motorMass*(this.m_motorSpeed-(this.m_axis.x*(i.x-g.x)+this.m_axis.y*(i.y-g.y)+this.m_a2*j-this.m_a1*h)),b=this.m_motorImpulse,a=a.dt*this.m_maxMotorForce,this.m_motorImpulse=b2Math.Clamp(this.m_motorImpulse+d,-a,a),d=this.m_motorImpulse-b,b=d*this.m_axis.x,a=d*this.m_axis.y,c=d*this.m_a1,d*=this.m_a2,g.x-=this.m_invMassA*b,g.y-=this.m_invMassA*a,h-=this.m_invIA*c,i.x+=this.m_invMassB*b,i.y+=this.m_invMassB*a,j+=this.m_invIB*d),c=this.m_perp.x*(i.x-g.x)+this.m_perp.y*(i.y-g.y)+this.m_s2*j-this.m_s1*h,a=j-h,this.m_enableLimit&&this.m_limitState!=b2Joint.e_inactiveLimit?(d=this.m_axis.x*(i.x-g.x)+this.m_axis.y*(i.y-g.y)+this.m_a2*j-this.m_a1*h,b=this.m_impulse.Copy(),d=this.m_K.Solve33(new b2Vec3,-c,-a,-d),this.m_impulse.Add(d),this.m_limitState==b2Joint.e_atLowerLimit?this.m_impulse.z=b2Math.Max(this.m_impulse.z,0):this.m_limitState==b2Joint.e_atUpperLimit&&(this.m_impulse.z=b2Math.Min(this.m_impulse.z,0)),c=-c-(this.m_impulse.z-b.z)*this.m_K.col3.x,a=-a-(this.m_impulse.z-b.z)*this.m_K.col3.y,a=this.m_K.Solve22(new b2Vec2,c,a),a.x+=b.x,a.y+=b.y,this.m_impulse.x=a.x,this.m_impulse.y=a.y,d.x=this.m_impulse.x-b.x,d.y=this.m_impulse.y-b.y,d.z=this.m_impulse.z-b.z,b=d.x*this.m_perp.x+d.z*this.m_axis.x,a=d.x*this.m_perp.y+d.z*this.m_axis.y,c=d.x*this.m_s1+d.y+d.z*this.m_a1,d=d.x*this.m_s2+d.y+d.z*this.m_a2):(d=this.m_K.Solve22(new b2Vec2,-c,-a),this.m_impulse.x+=d.x,this.m_impulse.y+=d.y,b=d.x*this.m_perp.x,a=d.x*this.m_perp.y,c=d.x*this.m_s1+d.y,d=d.x*this.m_s2+d.y),g.x-=this.m_invMassA*b,g.y-=this.m_invMassA*a,h-=this.m_invIA*c,i.x+=this.m_invMassB*b,i.y+=this.m_invMassB*a,j+=this.m_invIB*d,e.m_linearVelocity.SetV(g),e.m_angularVelocity=h,f.m_linearVelocity.SetV(i),f.m_angularVelocity=j},b2PrismaticJoint.prototype.SolvePositionConstraints=function(){var a,b,c,d,e=this.m_bodyA,f=this.m_bodyB,g=e.m_sweep.c,h=e.m_sweep.a,i=f.m_sweep.c,j=f.m_sweep.a,k=0,l=0;c=!1;var m=0,n=b2Mat22.FromAngle(h),o=b2Mat22.FromAngle(j);a=n,l=this.m_localAnchor1.x-this.m_localCenterA.x;var p=this.m_localAnchor1.y-this.m_localCenterA.y;if(b=a.col1.x*l+a.col2.x*p,p=a.col1.y*l+a.col2.y*p,l=b,a=o,o=this.m_localAnchor2.x-this.m_localCenterB.x,d=this.m_localAnchor2.y-this.m_localCenterB.y,b=a.col1.x*o+a.col2.x*d,d=a.col1.y*o+a.col2.y*d,o=b,a=i.x+o-g.x-l,b=i.y+d-g.y-p,this.m_enableLimit){this.m_axis=b2Math.MulMV(n,this.m_localXAxis1),this.m_a1=(a+l)*this.m_axis.y-(b+p)*this.m_axis.x,this.m_a2=o*this.m_axis.y-d*this.m_axis.x;var q=this.m_axis.x*a+this.m_axis.y*b;b2Math.Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*b2Settings.b2_linearSlop?(m=b2Math.Clamp(q,-b2Settings.b2_maxLinearCorrection,b2Settings.b2_maxLinearCorrection),k=b2Math.Abs(q),c=!0):q<=this.m_lowerTranslation?(m=b2Math.Clamp(q-this.m_lowerTranslation+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0),k=this.m_lowerTranslation-q,c=!0):q>=this.m_upperTranslation&&(m=b2Math.Clamp(q-this.m_upperTranslation+b2Settings.b2_linearSlop,0,b2Settings.b2_maxLinearCorrection),k=q-this.m_upperTranslation,c=!0)}return this.m_perp=b2Math.MulMV(n,this.m_localYAxis1),this.m_s1=(a+l)*this.m_perp.y-(b+p)*this.m_perp.x,this.m_s2=o*this.m_perp.y-d*this.m_perp.x,n=new b2Vec3,p=this.m_perp.x*a+this.m_perp.y*b,o=j-h-this.m_refAngle,k=b2Math.Max(k,b2Math.Abs(p)),l=b2Math.Abs(o),c?(c=this.m_invMassA,d=this.m_invMassB,a=this.m_invIA,b=this.m_invIB,this.m_K.col1.x=c+d+a*this.m_s1*this.m_s1+b*this.m_s2*this.m_s2,this.m_K.col1.y=a*this.m_s1+b*this.m_s2,this.m_K.col1.z=a*this.m_s1*this.m_a1+b*this.m_s2*this.m_a2,this.m_K.col2.x=this.m_K.col1.y,this.m_K.col2.y=a+b,this.m_K.col2.z=a*this.m_a1+b*this.m_a2,this.m_K.col3.x=this.m_K.col1.z,this.m_K.col3.y=this.m_K.col2.z,this.m_K.col3.z=c+d+a*this.m_a1*this.m_a1+b*this.m_a2*this.m_a2,this.m_K.Solve33(n,-p,-o,-m)):(c=this.m_invMassA,d=this.m_invMassB,a=this.m_invIA,b=this.m_invIB,m=a*this.m_s1+b*this.m_s2,q=a+b,this.m_K.col1.Set(c+d+a*this.m_s1*this.m_s1+b*this.m_s2*this.m_s2,m,0),this.m_K.col2.Set(m,q,0),m=this.m_K.Solve22(new b2Vec2,-p,-o),n.x=m.x,n.y=m.y,n.z=0),m=n.x*this.m_perp.x+n.z*this.m_axis.x,c=n.x*this.m_perp.y+n.z*this.m_axis.y,p=n.x*this.m_s1+n.y+n.z*this.m_a1,n=n.x*this.m_s2+n.y+n.z*this.m_a2,g.x-=this.m_invMassA*m,g.y-=this.m_invMassA*c,h-=this.m_invIA*p,i.x+=this.m_invMassB*m,i.y+=this.m_invMassB*c,j+=this.m_invIB*n,e.m_sweep.a=h,f.m_sweep.a=j,e.SynchronizeTransform(),f.SynchronizeTransform(),k<=b2Settings.b2_linearSlop&&l<=b2Settings.b2_angularSlop},b2PrismaticJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},b2PrismaticJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},b2PrismaticJoint.prototype.GetReactionForce=function(a){return new b2Vec2(a*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.x),a*(this.m_impulse.x*this.m_perp.y+(this.m_motorImpulse+this.m_impulse.z)*this.m_axis.y))},b2PrismaticJoint.prototype.GetReactionTorque=function(a){return a*this.m_impulse.y},b2PrismaticJoint.prototype.GetJointTranslation=function(){var a=this.m_bodyA,b=this.m_bodyB,c=a.GetWorldPoint(this.m_localAnchor1),d=b.GetWorldPoint(this.m_localAnchor2);return b=d.x-c.x,c=d.y-c.y,a=a.GetWorldVector(this.m_localXAxis1),a.x*b+a.y*c},b2PrismaticJoint.prototype.GetJointSpeed=function(){var a,b=this.m_bodyA,c=this.m_bodyB;a=b.m_xf.R;var d=this.m_localAnchor1.x-b.m_sweep.localCenter.x,e=this.m_localAnchor1.y-b.m_sweep.localCenter.y,f=a.col1.x*d+a.col2.x*e;e=a.col1.y*d+a.col2.y*e,d=f,a=c.m_xf.R;var g=this.m_localAnchor2.x-c.m_sweep.localCenter.x,h=this.m_localAnchor2.y-c.m_sweep.localCenter.y;f=a.col1.x*g+a.col2.x*h,h=a.col1.y*g+a.col2.y*h,g=f,a=c.m_sweep.c.x+g-(b.m_sweep.c.x+d),f=c.m_sweep.c.y+h-(b.m_sweep.c.y+e);var i=b.GetWorldVector(this.m_localXAxis1),j=b.m_linearVelocity,k=c.m_linearVelocity;return b=b.m_angularVelocity,c=c.m_angularVelocity,a*-b*i.y+f*b*i.x+(i.x*(k.x+-c*h-j.x- -b*e)+i.y*(k.y+c*g-j.y-b*d))},b2PrismaticJoint.prototype.IsLimitEnabled=function(){return this.m_enableLimit},b2PrismaticJoint.prototype.EnableLimit=function(a){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=a},b2PrismaticJoint.prototype.GetLowerLimit=function(){return this.m_lowerTranslation},b2PrismaticJoint.prototype.GetUpperLimit=function(){return this.m_upperTranslation},b2PrismaticJoint.prototype.SetLimits=function(a,b){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=a,this.m_upperTranslation=b},b2PrismaticJoint.prototype.IsMotorEnabled=function(){return this.m_enableMotor},b2PrismaticJoint.prototype.EnableMotor=function(a){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=a},b2PrismaticJoint.prototype.SetMotorSpeed=function(a){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=a},b2PrismaticJoint.prototype.GetMotorSpeed=function(){return this.m_motorSpeed},b2PrismaticJoint.prototype.SetMaxMotorForce=function(a){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=a},b2PrismaticJoint.prototype.GetMotorForce=function(){return this.m_motorImpulse},b2PrismaticJoint.prototype.m_localAnchor1=new b2Vec2,b2PrismaticJoint.prototype.m_localAnchor2=new b2Vec2,b2PrismaticJoint.prototype.m_localXAxis1=new b2Vec2,b2PrismaticJoint.prototype.m_localYAxis1=new b2Vec2,b2PrismaticJoint.prototype.m_refAngle=null,b2PrismaticJoint.prototype.m_axis=new b2Vec2,b2PrismaticJoint.prototype.m_perp=new b2Vec2,b2PrismaticJoint.prototype.m_s1=null,b2PrismaticJoint.prototype.m_s2=null,b2PrismaticJoint.prototype.m_a1=null,b2PrismaticJoint.prototype.m_a2=null,b2PrismaticJoint.prototype.m_K=new b2Mat33,b2PrismaticJoint.prototype.m_impulse=new b2Vec3,b2PrismaticJoint.prototype.m_motorMass=null,b2PrismaticJoint.prototype.m_motorImpulse=null,b2PrismaticJoint.prototype.m_lowerTranslation=null,b2PrismaticJoint.prototype.m_upperTranslation=null,b2PrismaticJoint.prototype.m_maxMotorForce=null,b2PrismaticJoint.prototype.m_motorSpeed=null,b2PrismaticJoint.prototype.m_enableLimit=null,b2PrismaticJoint.prototype.m_enableMotor=null,b2PrismaticJoint.prototype.m_limitState=0;var b2RevoluteJoint=function(){b2Joint.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2RevoluteJoint.prototype,b2Joint.prototype),b2RevoluteJoint.prototype._super=b2Joint.prototype,b2RevoluteJoint.prototype.__constructor=function(a){this._super.__constructor.apply(this,[a]),this.m_localAnchor1.SetV(a.localAnchorA),this.m_localAnchor2.SetV(a.localAnchorB),this.m_referenceAngle=a.referenceAngle,this.m_impulse.SetZero(),this.m_motorImpulse=0,this.m_lowerAngle=a.lowerAngle,this.m_upperAngle=a.upperAngle,this.m_maxMotorTorque=a.maxMotorTorque,this.m_motorSpeed=a.motorSpeed,this.m_enableLimit=a.enableLimit,this.m_enableMotor=a.enableMotor,this.m_limitState=b2Joint.e_inactiveLimit},b2RevoluteJoint.prototype.__varz=function(){this.K=new b2Mat22,this.K1=new b2Mat22,this.K2=new b2Mat22,this.K3=new b2Mat22,this.impulse3=new b2Vec3,this.impulse2=new b2Vec2,this.reduced=new b2Vec2,this.m_localAnchor1=new b2Vec2,this.m_localAnchor2=new b2Vec2,this.m_impulse=new b2Vec3,this.m_mass=new b2Mat33},b2RevoluteJoint.tImpulse=new b2Vec2,b2RevoluteJoint.prototype.InitVelocityConstraints=function(a){var b,c,d=this.m_bodyA,e=this.m_bodyB;b=d.m_xf.R;var f=this.m_localAnchor1.x-d.m_sweep.localCenter.x,g=this.m_localAnchor1.y-d.m_sweep.localCenter.y;c=b.col1.x*f+b.col2.x*g,g=b.col1.y*f+b.col2.y*g,f=c,b=e.m_xf.R;var h=this.m_localAnchor2.x-e.m_sweep.localCenter.x,i=this.m_localAnchor2.y-e.m_sweep.localCenter.y;c=b.col1.x*h+b.col2.x*i,i=b.col1.y*h+b.col2.y*i,h=c,b=d.m_invMass,c=e.m_invMass;var j=d.m_invI,k=e.m_invI;if(this.m_mass.col1.x=b+c+g*g*j+i*i*k,this.m_mass.col2.x=-g*f*j-i*h*k,this.m_mass.col3.x=-g*j-i*k,this.m_mass.col1.y=this.m_mass.col2.x,this.m_mass.col2.y=b+c+f*f*j+h*h*k,this.m_mass.col3.y=f*j+h*k,this.m_mass.col1.z=this.m_mass.col3.x,this.m_mass.col2.z=this.m_mass.col3.y,this.m_mass.col3.z=j+k,this.m_motorMass=1/(j+k),0==this.m_enableMotor&&(this.m_motorImpulse=0),this.m_enableLimit){var l=e.m_sweep.a-d.m_sweep.a-this.m_referenceAngle;b2Math.Abs(this.m_upperAngle-this.m_lowerAngle)<2*b2Settings.b2_angularSlop?this.m_limitState=b2Joint.e_equalLimits:l<=this.m_lowerAngle?(this.m_limitState!=b2Joint.e_atLowerLimit&&(this.m_impulse.z=0),this.m_limitState=b2Joint.e_atLowerLimit):l>=this.m_upperAngle?(this.m_limitState!=b2Joint.e_atUpperLimit&&(this.m_impulse.z=0),this.m_limitState=b2Joint.e_atUpperLimit):(this.m_limitState=b2Joint.e_inactiveLimit,this.m_impulse.z=0)}else this.m_limitState=b2Joint.e_inactiveLimit;a.warmStarting?(this.m_impulse.x*=a.dtRatio,this.m_impulse.y*=a.dtRatio,this.m_motorImpulse*=a.dtRatio,a=this.m_impulse.x,l=this.m_impulse.y,d.m_linearVelocity.x-=b*a,d.m_linearVelocity.y-=b*l,d.m_angularVelocity-=j*(f*l-g*a+this.m_motorImpulse+this.m_impulse.z),e.m_linearVelocity.x+=c*a,e.m_linearVelocity.y+=c*l,e.m_angularVelocity+=k*(h*l-i*a+this.m_motorImpulse+this.m_impulse.z)):(this.m_impulse.SetZero(),this.m_motorImpulse=0)},b2RevoluteJoint.prototype.SolveVelocityConstraints=function(a){var b,c,d,e,f,g=this.m_bodyA,h=this.m_bodyB,i=g.m_linearVelocity,j=g.m_angularVelocity,k=h.m_linearVelocity,l=h.m_angularVelocity,m=g.m_invMass,n=h.m_invMass,o=g.m_invI,p=h.m_invI;if(this.m_enableMotor&&this.m_limitState!=b2Joint.e_equalLimits&&(d=this.m_motorMass*-(l-j-this.m_motorSpeed),e=this.m_motorImpulse,a=a.dt*this.m_maxMotorTorque,this.m_motorImpulse=b2Math.Clamp(this.m_motorImpulse+d,-a,a),d=this.m_motorImpulse-e,j-=o*d,l+=p*d),this.m_enableLimit&&this.m_limitState!=b2Joint.e_inactiveLimit){b=g.m_xf.R,d=this.m_localAnchor1.x-g.m_sweep.localCenter.x,e=this.m_localAnchor1.y-g.m_sweep.localCenter.y,c=b.col1.x*d+b.col2.x*e,e=b.col1.y*d+b.col2.y*e,d=c,b=h.m_xf.R,a=this.m_localAnchor2.x-h.m_sweep.localCenter.x,f=this.m_localAnchor2.y-h.m_sweep.localCenter.y,c=b.col1.x*a+b.col2.x*f,f=b.col1.y*a+b.col2.y*f,a=c,c=k.x+-l*f-i.x- -j*e;var q=k.y+l*a-i.y-j*d;this.m_mass.Solve33(this.impulse3,-c,-q,-(l-j)),this.m_limitState==b2Joint.e_equalLimits?this.m_impulse.Add(this.impulse3):this.m_limitState==b2Joint.e_atLowerLimit?(b=this.m_impulse.z+this.impulse3.z,0>b&&(this.m_mass.Solve22(this.reduced,-c,-q),this.impulse3.x=this.reduced.x,this.impulse3.y=this.reduced.y,this.impulse3.z=-this.m_impulse.z,this.m_impulse.x+=this.reduced.x,this.m_impulse.y+=this.reduced.y,this.m_impulse.z=0)):this.m_limitState==b2Joint.e_atUpperLimit&&(b=this.m_impulse.z+this.impulse3.z,b>0&&(this.m_mass.Solve22(this.reduced,-c,-q),this.impulse3.x=this.reduced.x,this.impulse3.y=this.reduced.y,this.impulse3.z=-this.m_impulse.z,this.m_impulse.x+=this.reduced.x,this.m_impulse.y+=this.reduced.y,this.m_impulse.z=0)),i.x-=m*this.impulse3.x,i.y-=m*this.impulse3.y,j-=o*(d*this.impulse3.y-e*this.impulse3.x+this.impulse3.z),k.x+=n*this.impulse3.x,k.y+=n*this.impulse3.y,l+=p*(a*this.impulse3.y-f*this.impulse3.x+this.impulse3.z)}else b=g.m_xf.R,d=this.m_localAnchor1.x-g.m_sweep.localCenter.x,e=this.m_localAnchor1.y-g.m_sweep.localCenter.y,c=b.col1.x*d+b.col2.x*e,e=b.col1.y*d+b.col2.y*e,d=c,b=h.m_xf.R,a=this.m_localAnchor2.x-h.m_sweep.localCenter.x,f=this.m_localAnchor2.y-h.m_sweep.localCenter.y,c=b.col1.x*a+b.col2.x*f,f=b.col1.y*a+b.col2.y*f,a=c,this.m_mass.Solve22(this.impulse2,-(k.x+-l*f-i.x- -j*e),-(k.y+l*a-i.y-j*d)),this.m_impulse.x+=this.impulse2.x,this.m_impulse.y+=this.impulse2.y,i.x-=m*this.impulse2.x,i.y-=m*this.impulse2.y,j-=o*(d*this.impulse2.y-e*this.impulse2.x),k.x+=n*this.impulse2.x,k.y+=n*this.impulse2.y,l+=p*(a*this.impulse2.y-f*this.impulse2.x);g.m_linearVelocity.SetV(i),g.m_angularVelocity=j,h.m_linearVelocity.SetV(k),h.m_angularVelocity=l},b2RevoluteJoint.prototype.SolvePositionConstraints=function(){var a,b,c=this.m_bodyA,d=this.m_bodyB,e=0;b=0;var f,g,h;if(this.m_enableLimit&&this.m_limitState!=b2Joint.e_inactiveLimit){a=d.m_sweep.a-c.m_sweep.a-this.m_referenceAngle;var i=0;this.m_limitState==b2Joint.e_equalLimits?(a=b2Math.Clamp(a-this.m_lowerAngle,-b2Settings.b2_maxAngularCorrection,b2Settings.b2_maxAngularCorrection),i=-this.m_motorMass*a,e=b2Math.Abs(a)):this.m_limitState==b2Joint.e_atLowerLimit?(a-=this.m_lowerAngle,e=-a,a=b2Math.Clamp(a+b2Settings.b2_angularSlop,-b2Settings.b2_maxAngularCorrection,0),i=-this.m_motorMass*a):this.m_limitState==b2Joint.e_atUpperLimit&&(e=a-=this.m_upperAngle,a=b2Math.Clamp(a-b2Settings.b2_angularSlop,0,b2Settings.b2_maxAngularCorrection),i=-this.m_motorMass*a),c.m_sweep.a-=c.m_invI*i,d.m_sweep.a+=d.m_invI*i,c.SynchronizeTransform(),d.SynchronizeTransform()}b=c.m_xf.R,i=this.m_localAnchor1.x-c.m_sweep.localCenter.x,a=this.m_localAnchor1.y-c.m_sweep.localCenter.y,f=b.col1.x*i+b.col2.x*a,a=b.col1.y*i+b.col2.y*a,i=f,b=d.m_xf.R;var j=this.m_localAnchor2.x-d.m_sweep.localCenter.x,k=this.m_localAnchor2.y-d.m_sweep.localCenter.y;f=b.col1.x*j+b.col2.x*k,k=b.col1.y*j+b.col2.y*k,j=f,g=d.m_sweep.c.x+j-c.m_sweep.c.x-i,h=d.m_sweep.c.y+k-c.m_sweep.c.y-a;var l=g*g+h*h;b=Math.sqrt(l),f=c.m_invMass;var m=d.m_invMass,n=c.m_invI,o=d.m_invI,p=10*b2Settings.b2_linearSlop;return l>p*p&&(l=1/(f+m),g=l*-g,h=l*-h,c.m_sweep.c.x-=.5*f*g,c.m_sweep.c.y-=.5*f*h,d.m_sweep.c.x+=.5*m*g,d.m_sweep.c.y+=.5*m*h,g=d.m_sweep.c.x+j-c.m_sweep.c.x-i,h=d.m_sweep.c.y+k-c.m_sweep.c.y-a),this.K1.col1.x=f+m,this.K1.col2.x=0,this.K1.col1.y=0,this.K1.col2.y=f+m,this.K2.col1.x=n*a*a,this.K2.col2.x=-n*i*a,this.K2.col1.y=-n*i*a,this.K2.col2.y=n*i*i,this.K3.col1.x=o*k*k,this.K3.col2.x=-o*j*k,this.K3.col1.y=-o*j*k,this.K3.col2.y=o*j*j,this.K.SetM(this.K1),this.K.AddM(this.K2),this.K.AddM(this.K3),this.K.Solve(b2RevoluteJoint.tImpulse,-g,-h),g=b2RevoluteJoint.tImpulse.x,h=b2RevoluteJoint.tImpulse.y,c.m_sweep.c.x-=c.m_invMass*g,c.m_sweep.c.y-=c.m_invMass*h,c.m_sweep.a-=c.m_invI*(i*h-a*g),d.m_sweep.c.x+=d.m_invMass*g,d.m_sweep.c.y+=d.m_invMass*h,d.m_sweep.a+=d.m_invI*(j*h-k*g),c.SynchronizeTransform(),d.SynchronizeTransform(),b<=b2Settings.b2_linearSlop&&e<=b2Settings.b2_angularSlop},b2RevoluteJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},b2RevoluteJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},b2RevoluteJoint.prototype.GetReactionForce=function(a){return new b2Vec2(a*this.m_impulse.x,a*this.m_impulse.y)},b2RevoluteJoint.prototype.GetReactionTorque=function(a){return a*this.m_impulse.z},b2RevoluteJoint.prototype.GetJointAngle=function(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a-this.m_referenceAngle},b2RevoluteJoint.prototype.GetJointSpeed=function(){return this.m_bodyB.m_angularVelocity-this.m_bodyA.m_angularVelocity},b2RevoluteJoint.prototype.IsLimitEnabled=function(){return this.m_enableLimit},b2RevoluteJoint.prototype.EnableLimit=function(a){this.m_enableLimit=a},b2RevoluteJoint.prototype.GetLowerLimit=function(){return this.m_lowerAngle},b2RevoluteJoint.prototype.GetUpperLimit=function(){return this.m_upperAngle},b2RevoluteJoint.prototype.SetLimits=function(a,b){this.m_lowerAngle=a,this.m_upperAngle=b},b2RevoluteJoint.prototype.IsMotorEnabled=function(){return this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor},b2RevoluteJoint.prototype.EnableMotor=function(a){this.m_enableMotor=a},b2RevoluteJoint.prototype.SetMotorSpeed=function(a){this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=a},b2RevoluteJoint.prototype.GetMotorSpeed=function(){return this.m_motorSpeed},b2RevoluteJoint.prototype.SetMaxMotorTorque=function(a){this.m_maxMotorTorque=a},b2RevoluteJoint.prototype.GetMotorTorque=function(){return this.m_maxMotorTorque},b2RevoluteJoint.prototype.K=new b2Mat22,b2RevoluteJoint.prototype.K1=new b2Mat22,b2RevoluteJoint.prototype.K2=new b2Mat22,b2RevoluteJoint.prototype.K3=new b2Mat22,b2RevoluteJoint.prototype.impulse3=new b2Vec3,b2RevoluteJoint.prototype.impulse2=new b2Vec2,b2RevoluteJoint.prototype.reduced=new b2Vec2,b2RevoluteJoint.prototype.m_localAnchor1=new b2Vec2,b2RevoluteJoint.prototype.m_localAnchor2=new b2Vec2,b2RevoluteJoint.prototype.m_impulse=new b2Vec3,b2RevoluteJoint.prototype.m_motorImpulse=null,b2RevoluteJoint.prototype.m_mass=new b2Mat33,b2RevoluteJoint.prototype.m_motorMass=null,b2RevoluteJoint.prototype.m_enableMotor=null,b2RevoluteJoint.prototype.m_maxMotorTorque=null,b2RevoluteJoint.prototype.m_motorSpeed=null,b2RevoluteJoint.prototype.m_enableLimit=null,b2RevoluteJoint.prototype.m_referenceAngle=null,b2RevoluteJoint.prototype.m_lowerAngle=null,b2RevoluteJoint.prototype.m_upperAngle=null,b2RevoluteJoint.prototype.m_limitState=0;var b2JointDef=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2JointDef.prototype.__constructor=function(){this.type=b2Joint.e_unknownJoint,this.bodyB=this.bodyA=this.userData=null,this.collideConnected=!1},b2JointDef.prototype.__varz=function(){},b2JointDef.prototype.type=0,b2JointDef.prototype.userData=null,b2JointDef.prototype.bodyA=null,b2JointDef.prototype.bodyB=null,b2JointDef.prototype.collideConnected=null;var b2LineJointDef=function(){b2JointDef.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2LineJointDef.prototype,b2JointDef.prototype),b2LineJointDef.prototype._super=b2JointDef.prototype,b2LineJointDef.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments),this.type=b2Joint.e_lineJoint,this.localAxisA.Set(1,0),this.enableLimit=!1,this.upperTranslation=this.lowerTranslation=0,this.enableMotor=!1,this.motorSpeed=this.maxMotorForce=0},b2LineJointDef.prototype.__varz=function(){this.localAnchorA=new b2Vec2,this.localAnchorB=new b2Vec2,this.localAxisA=new b2Vec2},b2LineJointDef.prototype.Initialize=function(a,b,c,d){this.bodyA=a,this.bodyB=b,this.localAnchorA=this.bodyA.GetLocalPoint(c),this.localAnchorB=this.bodyB.GetLocalPoint(c),this.localAxisA=this.bodyA.GetLocalVector(d)},b2LineJointDef.prototype.localAnchorA=new b2Vec2,b2LineJointDef.prototype.localAnchorB=new b2Vec2,b2LineJointDef.prototype.localAxisA=new b2Vec2,b2LineJointDef.prototype.enableLimit=null,b2LineJointDef.prototype.lowerTranslation=null,b2LineJointDef.prototype.upperTranslation=null,b2LineJointDef.prototype.enableMotor=null,b2LineJointDef.prototype.maxMotorForce=null,b2LineJointDef.prototype.motorSpeed=null;var b2DistanceJoint=function(){b2Joint.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2DistanceJoint.prototype,b2Joint.prototype),b2DistanceJoint.prototype._super=b2Joint.prototype,b2DistanceJoint.prototype.__constructor=function(a){this._super.__constructor.apply(this,[a]),this.m_localAnchor1.SetV(a.localAnchorA),this.m_localAnchor2.SetV(a.localAnchorB),this.m_length=a.length,this.m_frequencyHz=a.frequencyHz,this.m_dampingRatio=a.dampingRatio,this.m_bias=this.m_gamma=this.m_impulse=0},b2DistanceJoint.prototype.__varz=function(){this.m_localAnchor1=new b2Vec2,this.m_localAnchor2=new b2Vec2,this.m_u=new b2Vec2},b2DistanceJoint.prototype.InitVelocityConstraints=function(a){var b,c,d=this.m_bodyA,e=this.m_bodyB;b=d.m_xf.R;var f=this.m_localAnchor1.x-d.m_sweep.localCenter.x,g=this.m_localAnchor1.y-d.m_sweep.localCenter.y;c=b.col1.x*f+b.col2.x*g,g=b.col1.y*f+b.col2.y*g,f=c,b=e.m_xf.R;var h=this.m_localAnchor2.x-e.m_sweep.localCenter.x,i=this.m_localAnchor2.y-e.m_sweep.localCenter.y;c=b.col1.x*h+b.col2.x*i,i=b.col1.y*h+b.col2.y*i,h=c,this.m_u.x=e.m_sweep.c.x+h-d.m_sweep.c.x-f,this.m_u.y=e.m_sweep.c.y+i-d.m_sweep.c.y-g,c=Math.sqrt(this.m_u.x*this.m_u.x+this.m_u.y*this.m_u.y),c>b2Settings.b2_linearSlop?this.m_u.Multiply(1/c):this.m_u.SetZero(),b=f*this.m_u.y-g*this.m_u.x;var j=h*this.m_u.y-i*this.m_u.x;if(b=d.m_invMass+d.m_invI*b*b+e.m_invMass+e.m_invI*j*j,this.m_mass=0!=b?1/b:0,this.m_frequencyHz>0){c-=this.m_length,j=2*Math.PI*this.m_frequencyHz;var k=this.m_mass*j*j;this.m_gamma=a.dt*(2*this.m_mass*this.m_dampingRatio*j+a.dt*k),this.m_gamma=0!=this.m_gamma?1/this.m_gamma:0,this.m_bias=c*a.dt*k*this.m_gamma,this.m_mass=b+this.m_gamma,this.m_mass=0!=this.m_mass?1/this.m_mass:0}a.warmStarting?(this.m_impulse*=a.dtRatio,a=this.m_impulse*this.m_u.x,b=this.m_impulse*this.m_u.y,d.m_linearVelocity.x-=d.m_invMass*a,d.m_linearVelocity.y-=d.m_invMass*b,d.m_angularVelocity-=d.m_invI*(f*b-g*a),e.m_linearVelocity.x+=e.m_invMass*a,e.m_linearVelocity.y+=e.m_invMass*b,e.m_angularVelocity+=e.m_invI*(h*b-i*a)):this.m_impulse=0},b2DistanceJoint.prototype.SolveVelocityConstraints=function(){var a,b=this.m_bodyA,c=this.m_bodyB;a=b.m_xf.R;var d=this.m_localAnchor1.x-b.m_sweep.localCenter.x,e=this.m_localAnchor1.y-b.m_sweep.localCenter.y,f=a.col1.x*d+a.col2.x*e;e=a.col1.y*d+a.col2.y*e,d=f,a=c.m_xf.R;var g=this.m_localAnchor2.x-c.m_sweep.localCenter.x,h=this.m_localAnchor2.y-c.m_sweep.localCenter.y;f=a.col1.x*g+a.col2.x*h,h=a.col1.y*g+a.col2.y*h,g=f,f=-this.m_mass*(this.m_u.x*(c.m_linearVelocity.x+-c.m_angularVelocity*h-(b.m_linearVelocity.x+-b.m_angularVelocity*e))+this.m_u.y*(c.m_linearVelocity.y+c.m_angularVelocity*g-(b.m_linearVelocity.y+b.m_angularVelocity*d))+this.m_bias+this.m_gamma*this.m_impulse),this.m_impulse+=f,a=f*this.m_u.x,f*=this.m_u.y,b.m_linearVelocity.x-=b.m_invMass*a,b.m_linearVelocity.y-=b.m_invMass*f,b.m_angularVelocity-=b.m_invI*(d*f-e*a),c.m_linearVelocity.x+=c.m_invMass*a,c.m_linearVelocity.y+=c.m_invMass*f,c.m_angularVelocity+=c.m_invI*(g*f-h*a)},b2DistanceJoint.prototype.SolvePositionConstraints=function(){var a;if(this.m_frequencyHz>0)return!0;var b=this.m_bodyA,c=this.m_bodyB;a=b.m_xf.R;var d=this.m_localAnchor1.x-b.m_sweep.localCenter.x,e=this.m_localAnchor1.y-b.m_sweep.localCenter.y,f=a.col1.x*d+a.col2.x*e;e=a.col1.y*d+a.col2.y*e,d=f,a=c.m_xf.R;var g=this.m_localAnchor2.x-c.m_sweep.localCenter.x,h=this.m_localAnchor2.y-c.m_sweep.localCenter.y;f=a.col1.x*g+a.col2.x*h,h=a.col1.y*g+a.col2.y*h,g=f,f=c.m_sweep.c.x+g-b.m_sweep.c.x-d;var i=c.m_sweep.c.y+h-b.m_sweep.c.y-e;a=Math.sqrt(f*f+i*i),f/=a,i/=a,a-=this.m_length,a=b2Math.Clamp(a,-b2Settings.b2_maxLinearCorrection,b2Settings.b2_maxLinearCorrection);var j=-this.m_mass*a;return this.m_u.Set(f,i),f=j*this.m_u.x,i=j*this.m_u.y,b.m_sweep.c.x-=b.m_invMass*f,b.m_sweep.c.y-=b.m_invMass*i,b.m_sweep.a-=b.m_invI*(d*i-e*f),c.m_sweep.c.x+=c.m_invMass*f,c.m_sweep.c.y+=c.m_invMass*i,c.m_sweep.a+=c.m_invI*(g*i-h*f),b.SynchronizeTransform(),c.SynchronizeTransform(),b2Math.Abs(a)<b2Settings.b2_linearSlop},b2DistanceJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},b2DistanceJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},b2DistanceJoint.prototype.GetReactionForce=function(a){return new b2Vec2(a*this.m_impulse*this.m_u.x,a*this.m_impulse*this.m_u.y)},b2DistanceJoint.prototype.GetReactionTorque=function(){return 0},b2DistanceJoint.prototype.GetLength=function(){return this.m_length},b2DistanceJoint.prototype.SetLength=function(a){this.m_length=a},b2DistanceJoint.prototype.GetFrequency=function(){return this.m_frequencyHz},b2DistanceJoint.prototype.SetFrequency=function(a){this.m_frequencyHz=a},b2DistanceJoint.prototype.GetDampingRatio=function(){return this.m_dampingRatio},b2DistanceJoint.prototype.SetDampingRatio=function(a){this.m_dampingRatio=a},b2DistanceJoint.prototype.m_localAnchor1=new b2Vec2,b2DistanceJoint.prototype.m_localAnchor2=new b2Vec2,b2DistanceJoint.prototype.m_u=new b2Vec2,b2DistanceJoint.prototype.m_frequencyHz=null,b2DistanceJoint.prototype.m_dampingRatio=null,b2DistanceJoint.prototype.m_gamma=null,b2DistanceJoint.prototype.m_bias=null,b2DistanceJoint.prototype.m_impulse=null,b2DistanceJoint.prototype.m_mass=null,b2DistanceJoint.prototype.m_length=null;var b2PulleyJointDef=function(){b2JointDef.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2PulleyJointDef.prototype,b2JointDef.prototype),b2PulleyJointDef.prototype._super=b2JointDef.prototype,b2PulleyJointDef.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments),this.type=b2Joint.e_pulleyJoint,this.groundAnchorA.Set(-1,1),this.groundAnchorB.Set(1,1),this.localAnchorA.Set(-1,0),this.localAnchorB.Set(1,0),this.maxLengthB=this.lengthB=this.maxLengthA=this.lengthA=0,this.ratio=1,this.collideConnected=!0},b2PulleyJointDef.prototype.__varz=function(){this.groundAnchorA=new b2Vec2,this.groundAnchorB=new b2Vec2,this.localAnchorA=new b2Vec2,this.localAnchorB=new b2Vec2},b2PulleyJointDef.prototype.Initialize=function(a,b,c,d,e,f,g){this.bodyA=a,this.bodyB=b,this.groundAnchorA.SetV(c),this.groundAnchorB.SetV(d),this.localAnchorA=this.bodyA.GetLocalPoint(e),this.localAnchorB=this.bodyB.GetLocalPoint(f),a=e.x-c.x,c=e.y-c.y,this.lengthA=Math.sqrt(a*a+c*c),c=f.x-d.x,d=f.y-d.y,this.lengthB=Math.sqrt(c*c+d*d),this.ratio=g,g=this.lengthA+this.ratio*this.lengthB,this.maxLengthA=g-this.ratio*b2PulleyJoint.b2_minPulleyLength,this.maxLengthB=(g-b2PulleyJoint.b2_minPulleyLength)/this.ratio},b2PulleyJointDef.prototype.groundAnchorA=new b2Vec2,b2PulleyJointDef.prototype.groundAnchorB=new b2Vec2,b2PulleyJointDef.prototype.localAnchorA=new b2Vec2,b2PulleyJointDef.prototype.localAnchorB=new b2Vec2,b2PulleyJointDef.prototype.lengthA=null,b2PulleyJointDef.prototype.maxLengthA=null,b2PulleyJointDef.prototype.lengthB=null,b2PulleyJointDef.prototype.maxLengthB=null,b2PulleyJointDef.prototype.ratio=null;var b2DistanceJointDef=function(){b2JointDef.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2DistanceJointDef.prototype,b2JointDef.prototype),b2DistanceJointDef.prototype._super=b2JointDef.prototype,b2DistanceJointDef.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments),this.type=b2Joint.e_distanceJoint,this.length=1,this.dampingRatio=this.frequencyHz=0},b2DistanceJointDef.prototype.__varz=function(){this.localAnchorA=new b2Vec2,this.localAnchorB=new b2Vec2},b2DistanceJointDef.prototype.Initialize=function(a,b,c,d){this.bodyA=a,this.bodyB=b,this.localAnchorA.SetV(this.bodyA.GetLocalPoint(c)),this.localAnchorB.SetV(this.bodyB.GetLocalPoint(d)),a=d.x-c.x,c=d.y-c.y,this.length=Math.sqrt(a*a+c*c),this.dampingRatio=this.frequencyHz=0},b2DistanceJointDef.prototype.localAnchorA=new b2Vec2,b2DistanceJointDef.prototype.localAnchorB=new b2Vec2,b2DistanceJointDef.prototype.length=null,b2DistanceJointDef.prototype.frequencyHz=null,b2DistanceJointDef.prototype.dampingRatio=null;var b2FrictionJointDef=function(){b2JointDef.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2FrictionJointDef.prototype,b2JointDef.prototype),b2FrictionJointDef.prototype._super=b2JointDef.prototype,b2FrictionJointDef.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments),this.type=b2Joint.e_frictionJoint,this.maxTorque=this.maxForce=0},b2FrictionJointDef.prototype.__varz=function(){this.localAnchorA=new b2Vec2,this.localAnchorB=new b2Vec2},b2FrictionJointDef.prototype.Initialize=function(a,b,c){this.bodyA=a,this.bodyB=b,this.localAnchorA.SetV(this.bodyA.GetLocalPoint(c)),this.localAnchorB.SetV(this.bodyB.GetLocalPoint(c))},b2FrictionJointDef.prototype.localAnchorA=new b2Vec2,b2FrictionJointDef.prototype.localAnchorB=new b2Vec2,b2FrictionJointDef.prototype.maxForce=null,b2FrictionJointDef.prototype.maxTorque=null;var b2WeldJointDef=function(){b2JointDef.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2WeldJointDef.prototype,b2JointDef.prototype),b2WeldJointDef.prototype._super=b2JointDef.prototype,b2WeldJointDef.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments),this.type=b2Joint.e_weldJoint,this.referenceAngle=0},b2WeldJointDef.prototype.__varz=function(){this.localAnchorA=new b2Vec2,this.localAnchorB=new b2Vec2},b2WeldJointDef.prototype.Initialize=function(a,b,c){this.bodyA=a,this.bodyB=b,this.localAnchorA.SetV(this.bodyA.GetLocalPoint(c)),this.localAnchorB.SetV(this.bodyB.GetLocalPoint(c)),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},b2WeldJointDef.prototype.localAnchorA=new b2Vec2,b2WeldJointDef.prototype.localAnchorB=new b2Vec2,b2WeldJointDef.prototype.referenceAngle=null;var b2GearJointDef=function(){b2JointDef.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2GearJointDef.prototype,b2JointDef.prototype),b2GearJointDef.prototype._super=b2JointDef.prototype,b2GearJointDef.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments),this.type=b2Joint.e_gearJoint,this.joint2=this.joint1=null,this.ratio=1},b2GearJointDef.prototype.__varz=function(){},b2GearJointDef.prototype.joint1=null,b2GearJointDef.prototype.joint2=null,b2GearJointDef.prototype.ratio=null;var b2Color=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Color.prototype.__constructor=function(a,b,c){this._r=parseInt(255*b2Math.Clamp(a,0,1)),this._g=parseInt(255*b2Math.Clamp(b,0,1)),this._b=parseInt(255*b2Math.Clamp(c,0,1))},b2Color.prototype.__varz=function(){},b2Color.prototype.Set=function(a,b,c){this._r=parseInt(255*b2Math.Clamp(a,0,1)),this._g=parseInt(255*b2Math.Clamp(b,0,1)),this._b=parseInt(255*b2Math.Clamp(c,0,1))},b2Color.prototype.__defineGetter__("r",function(){return this._r}),b2Color.prototype.__defineSetter__("r",function(a){this._r=parseInt(255*b2Math.Clamp(a,0,1))}),b2Color.prototype.__defineGetter__("g",function(){return this._g}),b2Color.prototype.__defineSetter__("g",function(a){this._g=parseInt(255*b2Math.Clamp(a,0,1))}),b2Color.prototype.__defineGetter__("b",function(){return this._b}),b2Color.prototype.__defineSetter__("b",function(a){this._b=parseInt(255*b2Math.Clamp(a,0,1))}),b2Color.prototype.__defineGetter__("color",function(){return this._r<<16|this._g<<8|this._b}),b2Color.prototype._r=0,b2Color.prototype._g=0,b2Color.prototype._b=0;var b2FrictionJoint=function(){b2Joint.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2FrictionJoint.prototype,b2Joint.prototype),b2FrictionJoint.prototype._super=b2Joint.prototype,b2FrictionJoint.prototype.__constructor=function(a){this._super.__constructor.apply(this,[a]),this.m_localAnchorA.SetV(a.localAnchorA),this.m_localAnchorB.SetV(a.localAnchorB),this.m_linearMass.SetZero(),this.m_angularMass=0,this.m_linearImpulse.SetZero(),this.m_angularImpulse=0,this.m_maxForce=a.maxForce,this.m_maxTorque=a.maxTorque
},b2FrictionJoint.prototype.__varz=function(){this.m_localAnchorA=new b2Vec2,this.m_localAnchorB=new b2Vec2,this.m_linearImpulse=new b2Vec2,this.m_linearMass=new b2Mat22},b2FrictionJoint.prototype.InitVelocityConstraints=function(a){var b,c,d=this.m_bodyA,e=this.m_bodyB;b=d.m_xf.R;var f=this.m_localAnchorA.x-d.m_sweep.localCenter.x,g=this.m_localAnchorA.y-d.m_sweep.localCenter.y;c=b.col1.x*f+b.col2.x*g,g=b.col1.y*f+b.col2.y*g,f=c,b=e.m_xf.R;var h=this.m_localAnchorB.x-e.m_sweep.localCenter.x,i=this.m_localAnchorB.y-e.m_sweep.localCenter.y;c=b.col1.x*h+b.col2.x*i,i=b.col1.y*h+b.col2.y*i,h=c,b=d.m_invMass,c=e.m_invMass;var j=d.m_invI,k=e.m_invI,l=new b2Mat22;l.col1.x=b+c,l.col2.x=0,l.col1.y=0,l.col2.y=b+c,l.col1.x+=j*g*g,l.col2.x+=-j*f*g,l.col1.y+=-j*f*g,l.col2.y+=j*f*f,l.col1.x+=k*i*i,l.col2.x+=-k*h*i,l.col1.y+=-k*h*i,l.col2.y+=k*h*h,l.GetInverse(this.m_linearMass),this.m_angularMass=j+k,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),a.warmStarting?(this.m_linearImpulse.x*=a.dtRatio,this.m_linearImpulse.y*=a.dtRatio,this.m_angularImpulse*=a.dtRatio,a=this.m_linearImpulse,d.m_linearVelocity.x-=b*a.x,d.m_linearVelocity.y-=b*a.y,d.m_angularVelocity-=j*(f*a.y-g*a.x+this.m_angularImpulse),e.m_linearVelocity.x+=c*a.x,e.m_linearVelocity.y+=c*a.y,e.m_angularVelocity+=k*(h*a.y-i*a.x+this.m_angularImpulse)):(this.m_linearImpulse.SetZero(),this.m_angularImpulse=0)},b2FrictionJoint.prototype.SolveVelocityConstraints=function(a){var b,c,d=this.m_bodyA,e=this.m_bodyB,f=d.m_linearVelocity,g=d.m_angularVelocity,h=e.m_linearVelocity,i=e.m_angularVelocity,j=d.m_invMass,k=e.m_invMass,l=d.m_invI,m=e.m_invI;b=d.m_xf.R;var n=this.m_localAnchorA.x-d.m_sweep.localCenter.x,o=this.m_localAnchorA.y-d.m_sweep.localCenter.y;c=b.col1.x*n+b.col2.x*o,o=b.col1.y*n+b.col2.y*o,n=c,b=e.m_xf.R;var p=this.m_localAnchorB.x-e.m_sweep.localCenter.x,q=this.m_localAnchorB.y-e.m_sweep.localCenter.y;c=b.col1.x*p+b.col2.x*q,q=b.col1.y*p+b.col2.y*q,p=c,c=-this.m_angularMass*(i-g);var r=this.m_angularImpulse;b=a.dt*this.m_maxTorque,this.m_angularImpulse=b2Math.Clamp(this.m_angularImpulse+c,-b,b),c=this.m_angularImpulse-r,g-=l*c,i+=m*c,b=b2Math.MulMV(this.m_linearMass,new b2Vec2(-(h.x-i*q-f.x+g*o),-(h.y+i*p-f.y-g*n))),c=this.m_linearImpulse.Copy(),this.m_linearImpulse.Add(b),b=a.dt*this.m_maxForce,this.m_linearImpulse.LengthSquared()>b*b&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.Multiply(b)),b=b2Math.SubtractVV(this.m_linearImpulse,c),f.x-=j*b.x,f.y-=j*b.y,g-=l*(n*b.y-o*b.x),h.x+=k*b.x,h.y+=k*b.y,i+=m*(p*b.y-q*b.x),d.m_angularVelocity=g,e.m_angularVelocity=i},b2FrictionJoint.prototype.SolvePositionConstraints=function(){return!0},b2FrictionJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA)},b2FrictionJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB)},b2FrictionJoint.prototype.GetReactionForce=function(a){return new b2Vec2(a*this.m_linearImpulse.x,a*this.m_linearImpulse.y)},b2FrictionJoint.prototype.GetReactionTorque=function(a){return a*this.m_angularImpulse},b2FrictionJoint.prototype.SetMaxForce=function(a){this.m_maxForce=a},b2FrictionJoint.prototype.GetMaxForce=function(){return this.m_maxForce},b2FrictionJoint.prototype.SetMaxTorque=function(a){this.m_maxTorque=a},b2FrictionJoint.prototype.GetMaxTorque=function(){return this.m_maxTorque},b2FrictionJoint.prototype.m_localAnchorA=new b2Vec2,b2FrictionJoint.prototype.m_localAnchorB=new b2Vec2,b2FrictionJoint.prototype.m_linearImpulse=new b2Vec2,b2FrictionJoint.prototype.m_angularImpulse=null,b2FrictionJoint.prototype.m_maxForce=null,b2FrictionJoint.prototype.m_maxTorque=null,b2FrictionJoint.prototype.m_linearMass=new b2Mat22,b2FrictionJoint.prototype.m_angularMass=null;var b2Distance=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Distance.prototype.__constructor=function(){},b2Distance.prototype.__varz=function(){},b2Distance.Distance=function(a,b,c){++b2Distance.b2_gjkCalls;var d=c.proxyA,e=c.proxyB,f=c.transformA,g=c.transformB,h=b2Distance.s_simplex;h.ReadCache(b,d,f,e,g);var i=h.m_vertices,j=b2Distance.s_saveA,k=b2Distance.s_saveB,l=0;h.GetClosestPoint().LengthSquared();for(var m,n=0,o=0;20>o;){for(l=h.m_count,n=0;l>n;n++)j[n]=i[n].indexA,k[n]=i[n].indexB;switch(h.m_count){case 1:break;case 2:h.Solve2();break;case 3:h.Solve3();break;default:b2Settings.b2Assert(!1)}if(3==h.m_count)break;if(m=h.GetClosestPoint(),m.LengthSquared(),n=h.GetSearchDirection(),n.LengthSquared()<Number.MIN_VALUE*Number.MIN_VALUE)break;m=i[h.m_count],m.indexA=d.GetSupport(b2Math.MulTMV(f.R,n.GetNegative())),m.wA=b2Math.MulX(f,d.GetVertex(m.indexA)),m.indexB=e.GetSupport(b2Math.MulTMV(g.R,n)),m.wB=b2Math.MulX(g,e.GetVertex(m.indexB)),m.w=b2Math.SubtractVV(m.wB,m.wA),++o,++b2Distance.b2_gjkIters;var p=!1;for(n=0;l>n;n++)if(m.indexA==j[n]&&m.indexB==k[n]){p=!0;break}if(p)break;++h.m_count}b2Distance.b2_gjkMaxIters=b2Math.Max(b2Distance.b2_gjkMaxIters,o),h.GetWitnessPoints(a.pointA,a.pointB),a.distance=b2Math.SubtractVV(a.pointA,a.pointB).Length(),a.iterations=o,h.WriteCache(b),c.useRadii&&(b=d.m_radius,e=e.m_radius,a.distance>b+e&&a.distance>Number.MIN_VALUE?(a.distance-=b+e,c=b2Math.SubtractVV(a.pointB,a.pointA),c.Normalize(),a.pointA.x+=b*c.x,a.pointA.y+=b*c.y,a.pointB.x-=e*c.x,a.pointB.y-=e*c.y):(m=new b2Vec2,m.x=.5*(a.pointA.x+a.pointB.x),m.y=.5*(a.pointA.y+a.pointB.y),a.pointA.x=a.pointB.x=m.x,a.pointA.y=a.pointB.y=m.y,a.distance=0))},b2Distance.b2_gjkCalls=0,b2Distance.b2_gjkIters=0,b2Distance.b2_gjkMaxIters=0,b2Distance.s_simplex=new b2Simplex,b2Distance.s_saveA=Array(3),b2Distance.s_saveB=Array(3);var b2MouseJoint=function(){b2Joint.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2MouseJoint.prototype,b2Joint.prototype),b2MouseJoint.prototype._super=b2Joint.prototype,b2MouseJoint.prototype.__constructor=function(a){this._super.__constructor.apply(this,[a]),this.m_target.SetV(a.target);var b=this.m_target.x-this.m_bodyB.m_xf.position.x,c=this.m_target.y-this.m_bodyB.m_xf.position.y,d=this.m_bodyB.m_xf.R;this.m_localAnchor.x=b*d.col1.x+c*d.col1.y,this.m_localAnchor.y=b*d.col2.x+c*d.col2.y,this.m_maxForce=a.maxForce,this.m_impulse.SetZero(),this.m_frequencyHz=a.frequencyHz,this.m_dampingRatio=a.dampingRatio,this.m_gamma=this.m_beta=0},b2MouseJoint.prototype.__varz=function(){this.K=new b2Mat22,this.K1=new b2Mat22,this.K2=new b2Mat22,this.m_localAnchor=new b2Vec2,this.m_target=new b2Vec2,this.m_impulse=new b2Vec2,this.m_mass=new b2Mat22,this.m_C=new b2Vec2},b2MouseJoint.prototype.InitVelocityConstraints=function(a){var b=this.m_bodyB,c=b.GetMass(),d=2*Math.PI*this.m_frequencyHz,e=c*d*d;this.m_gamma=a.dt*(2*c*this.m_dampingRatio*d+a.dt*e),this.m_gamma=0!=this.m_gamma?1/this.m_gamma:0,this.m_beta=a.dt*e*this.m_gamma,e=b.m_xf.R,c=this.m_localAnchor.x-b.m_sweep.localCenter.x,d=this.m_localAnchor.y-b.m_sweep.localCenter.y;var f=e.col1.x*c+e.col2.x*d;d=e.col1.y*c+e.col2.y*d,c=f,e=b.m_invMass,f=b.m_invI,this.K1.col1.x=e,this.K1.col2.x=0,this.K1.col1.y=0,this.K1.col2.y=e,this.K2.col1.x=f*d*d,this.K2.col2.x=-f*c*d,this.K2.col1.y=-f*c*d,this.K2.col2.y=f*c*c,this.K.SetM(this.K1),this.K.AddM(this.K2),this.K.col1.x+=this.m_gamma,this.K.col2.y+=this.m_gamma,this.K.GetInverse(this.m_mass),this.m_C.x=b.m_sweep.c.x+c-this.m_target.x,this.m_C.y=b.m_sweep.c.y+d-this.m_target.y,b.m_angularVelocity*=.98,this.m_impulse.x*=a.dtRatio,this.m_impulse.y*=a.dtRatio,b.m_linearVelocity.x+=e*this.m_impulse.x,b.m_linearVelocity.y+=e*this.m_impulse.y,b.m_angularVelocity+=f*(c*this.m_impulse.y-d*this.m_impulse.x)},b2MouseJoint.prototype.SolveVelocityConstraints=function(a){var b,c,d,e=this.m_bodyB;b=e.m_xf.R;var f=this.m_localAnchor.x-e.m_sweep.localCenter.x,g=this.m_localAnchor.y-e.m_sweep.localCenter.y;c=b.col1.x*f+b.col2.x*g,g=b.col1.y*f+b.col2.y*g,f=c,c=e.m_linearVelocity.x+-e.m_angularVelocity*g;var h=e.m_linearVelocity.y+e.m_angularVelocity*f;b=this.m_mass,c=c+this.m_beta*this.m_C.x+this.m_gamma*this.m_impulse.x,d=h+this.m_beta*this.m_C.y+this.m_gamma*this.m_impulse.y,h=-(b.col1.x*c+b.col2.x*d),d=-(b.col1.y*c+b.col2.y*d),b=this.m_impulse.x,c=this.m_impulse.y,this.m_impulse.x+=h,this.m_impulse.y+=d,a=a.dt*this.m_maxForce,this.m_impulse.LengthSquared()>a*a&&this.m_impulse.Multiply(a/this.m_impulse.Length()),h=this.m_impulse.x-b,d=this.m_impulse.y-c,e.m_linearVelocity.x+=e.m_invMass*h,e.m_linearVelocity.y+=e.m_invMass*d,e.m_angularVelocity+=e.m_invI*(f*d-g*h)},b2MouseJoint.prototype.SolvePositionConstraints=function(){return!0},b2MouseJoint.prototype.GetAnchorA=function(){return this.m_target},b2MouseJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor)},b2MouseJoint.prototype.GetReactionForce=function(a){return new b2Vec2(a*this.m_impulse.x,a*this.m_impulse.y)},b2MouseJoint.prototype.GetReactionTorque=function(){return 0},b2MouseJoint.prototype.GetTarget=function(){return this.m_target},b2MouseJoint.prototype.SetTarget=function(a){0==this.m_bodyB.IsAwake()&&this.m_bodyB.SetAwake(!0),this.m_target=a},b2MouseJoint.prototype.GetMaxForce=function(){return this.m_maxForce},b2MouseJoint.prototype.SetMaxForce=function(a){this.m_maxForce=a},b2MouseJoint.prototype.GetFrequency=function(){return this.m_frequencyHz},b2MouseJoint.prototype.SetFrequency=function(a){this.m_frequencyHz=a},b2MouseJoint.prototype.GetDampingRatio=function(){return this.m_dampingRatio},b2MouseJoint.prototype.SetDampingRatio=function(a){this.m_dampingRatio=a},b2MouseJoint.prototype.K=new b2Mat22,b2MouseJoint.prototype.K1=new b2Mat22,b2MouseJoint.prototype.K2=new b2Mat22,b2MouseJoint.prototype.m_localAnchor=new b2Vec2,b2MouseJoint.prototype.m_target=new b2Vec2,b2MouseJoint.prototype.m_impulse=new b2Vec2,b2MouseJoint.prototype.m_mass=new b2Mat22,b2MouseJoint.prototype.m_C=new b2Vec2,b2MouseJoint.prototype.m_maxForce=null,b2MouseJoint.prototype.m_frequencyHz=null,b2MouseJoint.prototype.m_dampingRatio=null,b2MouseJoint.prototype.m_beta=null,b2MouseJoint.prototype.m_gamma=null;var b2PrismaticJointDef=function(){b2JointDef.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2PrismaticJointDef.prototype,b2JointDef.prototype),b2PrismaticJointDef.prototype._super=b2JointDef.prototype,b2PrismaticJointDef.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments),this.type=b2Joint.e_prismaticJoint,this.localAxisA.Set(1,0),this.referenceAngle=0,this.enableLimit=!1,this.upperTranslation=this.lowerTranslation=0,this.enableMotor=!1,this.motorSpeed=this.maxMotorForce=0},b2PrismaticJointDef.prototype.__varz=function(){this.localAnchorA=new b2Vec2,this.localAnchorB=new b2Vec2,this.localAxisA=new b2Vec2},b2PrismaticJointDef.prototype.Initialize=function(a,b,c,d){this.bodyA=a,this.bodyB=b,this.localAnchorA=this.bodyA.GetLocalPoint(c),this.localAnchorB=this.bodyB.GetLocalPoint(c),this.localAxisA=this.bodyA.GetLocalVector(d),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},b2PrismaticJointDef.prototype.localAnchorA=new b2Vec2,b2PrismaticJointDef.prototype.localAnchorB=new b2Vec2,b2PrismaticJointDef.prototype.localAxisA=new b2Vec2,b2PrismaticJointDef.prototype.referenceAngle=null,b2PrismaticJointDef.prototype.enableLimit=null,b2PrismaticJointDef.prototype.lowerTranslation=null,b2PrismaticJointDef.prototype.upperTranslation=null,b2PrismaticJointDef.prototype.enableMotor=null,b2PrismaticJointDef.prototype.maxMotorForce=null,b2PrismaticJointDef.prototype.motorSpeed=null;var b2TimeOfImpact=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2TimeOfImpact.prototype.__constructor=function(){},b2TimeOfImpact.prototype.__varz=function(){},b2TimeOfImpact.TimeOfImpact=function(a){++b2TimeOfImpact.b2_toiCalls;var b=a.proxyA,c=a.proxyB,d=a.sweepA,e=a.sweepB;b2Settings.b2Assert(d.t0==e.t0),b2Settings.b2Assert(1-d.t0>Number.MIN_VALUE);var f=b.m_radius+c.m_radius;a=a.tolerance;var g=0,h=0,i=0;for(b2TimeOfImpact.s_cache.count=0,b2TimeOfImpact.s_distanceInput.useRadii=!1;;){if(d.GetTransform(b2TimeOfImpact.s_xfA,g),e.GetTransform(b2TimeOfImpact.s_xfB,g),b2TimeOfImpact.s_distanceInput.proxyA=b,b2TimeOfImpact.s_distanceInput.proxyB=c,b2TimeOfImpact.s_distanceInput.transformA=b2TimeOfImpact.s_xfA,b2TimeOfImpact.s_distanceInput.transformB=b2TimeOfImpact.s_xfB,b2Distance.Distance(b2TimeOfImpact.s_distanceOutput,b2TimeOfImpact.s_cache,b2TimeOfImpact.s_distanceInput),b2TimeOfImpact.s_distanceOutput.distance<=0){g=1;break}b2TimeOfImpact.s_fcn.Initialize(b2TimeOfImpact.s_cache,b,b2TimeOfImpact.s_xfA,c,b2TimeOfImpact.s_xfB);var j=b2TimeOfImpact.s_fcn.Evaluate(b2TimeOfImpact.s_xfA,b2TimeOfImpact.s_xfB);if(0>=j){g=1;break}if(0==h&&(i=j>f?b2Math.Max(f-a,.75*f):b2Math.Max(j-a,.02*f)),.5*a>j-i){if(0==h){g=1;break}break}var k=g,l=g,m=1;j=j,d.GetTransform(b2TimeOfImpact.s_xfA,m),e.GetTransform(b2TimeOfImpact.s_xfB,m);var n=b2TimeOfImpact.s_fcn.Evaluate(b2TimeOfImpact.s_xfA,b2TimeOfImpact.s_xfB);if(n>=i){g=1;break}for(var o=0;;){var p;p=1&o?l+(i-j)*(m-l)/(n-j):.5*(l+m),d.GetTransform(b2TimeOfImpact.s_xfA,p),e.GetTransform(b2TimeOfImpact.s_xfB,p);var q=b2TimeOfImpact.s_fcn.Evaluate(b2TimeOfImpact.s_xfA,b2TimeOfImpact.s_xfB);if(b2Math.Abs(q-i)<.025*a){k=p;break}if(q>i?(l=p,j=q):(m=p,n=q),++o,++b2TimeOfImpact.b2_toiRootIters,50==o)break}if(b2TimeOfImpact.b2_toiMaxRootIters=b2Math.Max(b2TimeOfImpact.b2_toiMaxRootIters,o),k<(1+100*Number.MIN_VALUE)*g)break;if(g=k,h++,++b2TimeOfImpact.b2_toiIters,1e3==h)break}return b2TimeOfImpact.b2_toiMaxIters=b2Math.Max(b2TimeOfImpact.b2_toiMaxIters,h),g},b2TimeOfImpact.b2_toiCalls=0,b2TimeOfImpact.b2_toiIters=0,b2TimeOfImpact.b2_toiMaxIters=0,b2TimeOfImpact.b2_toiRootIters=0,b2TimeOfImpact.b2_toiMaxRootIters=0,b2TimeOfImpact.s_cache=new b2SimplexCache,b2TimeOfImpact.s_distanceInput=new b2DistanceInput,b2TimeOfImpact.s_xfA=new b2Transform,b2TimeOfImpact.s_xfB=new b2Transform,b2TimeOfImpact.s_fcn=new b2SeparationFunction,b2TimeOfImpact.s_distanceOutput=new b2DistanceOutput;var b2GearJoint=function(){b2Joint.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2GearJoint.prototype,b2Joint.prototype),b2GearJoint.prototype._super=b2Joint.prototype,b2GearJoint.prototype.__constructor=function(a){this._super.__constructor.apply(this,[a]);var b=a.joint1.m_type,c=a.joint2.m_type;this.m_prismatic2=this.m_revolute2=this.m_prismatic1=this.m_revolute1=null,this.m_ground1=a.joint1.GetBodyA(),this.m_bodyA=a.joint1.GetBodyB(),b==b2Joint.e_revoluteJoint?(this.m_revolute1=a.joint1,this.m_groundAnchor1.SetV(this.m_revolute1.m_localAnchor1),this.m_localAnchor1.SetV(this.m_revolute1.m_localAnchor2),b=this.m_revolute1.GetJointAngle()):(this.m_prismatic1=a.joint1,this.m_groundAnchor1.SetV(this.m_prismatic1.m_localAnchor1),this.m_localAnchor1.SetV(this.m_prismatic1.m_localAnchor2),b=this.m_prismatic1.GetJointTranslation()),this.m_ground2=a.joint2.GetBodyA(),this.m_bodyB=a.joint2.GetBodyB(),c==b2Joint.e_revoluteJoint?(this.m_revolute2=a.joint2,this.m_groundAnchor2.SetV(this.m_revolute2.m_localAnchor1),this.m_localAnchor2.SetV(this.m_revolute2.m_localAnchor2),c=this.m_revolute2.GetJointAngle()):(this.m_prismatic2=a.joint2,this.m_groundAnchor2.SetV(this.m_prismatic2.m_localAnchor1),this.m_localAnchor2.SetV(this.m_prismatic2.m_localAnchor2),c=this.m_prismatic2.GetJointTranslation()),this.m_ratio=a.ratio,this.m_constant=b+this.m_ratio*c,this.m_impulse=0},b2GearJoint.prototype.__varz=function(){this.m_groundAnchor1=new b2Vec2,this.m_groundAnchor2=new b2Vec2,this.m_localAnchor1=new b2Vec2,this.m_localAnchor2=new b2Vec2,this.m_J=new b2Jacobian},b2GearJoint.prototype.InitVelocityConstraints=function(a){var b,c,d,e,f,g=this.m_ground1,h=this.m_ground2,i=this.m_bodyA,j=this.m_bodyB,k=0;this.m_J.SetZero(),this.m_revolute1?(this.m_J.angularA=-1,k+=i.m_invI):(e=g.m_xf.R,b=this.m_prismatic1.m_localXAxis1,g=e.col1.x*b.x+e.col2.x*b.y,b=e.col1.y*b.x+e.col2.y*b.y,e=i.m_xf.R,c=this.m_localAnchor1.x-i.m_sweep.localCenter.x,d=this.m_localAnchor1.y-i.m_sweep.localCenter.y,f=e.col1.x*c+e.col2.x*d,d=e.col1.y*c+e.col2.y*d,c=f,e=c*b-d*g,this.m_J.linearA.Set(-g,-b),this.m_J.angularA=-e,k+=i.m_invMass+i.m_invI*e*e),this.m_revolute2?(this.m_J.angularB=-this.m_ratio,k+=this.m_ratio*this.m_ratio*j.m_invI):(e=h.m_xf.R,b=this.m_prismatic2.m_localXAxis1,g=e.col1.x*b.x+e.col2.x*b.y,b=e.col1.y*b.x+e.col2.y*b.y,e=j.m_xf.R,c=this.m_localAnchor2.x-j.m_sweep.localCenter.x,d=this.m_localAnchor2.y-j.m_sweep.localCenter.y,f=e.col1.x*c+e.col2.x*d,d=e.col1.y*c+e.col2.y*d,c=f,e=c*b-d*g,this.m_J.linearB.Set(-this.m_ratio*g,-this.m_ratio*b),this.m_J.angularB=-this.m_ratio*e,k+=this.m_ratio*this.m_ratio*(j.m_invMass+j.m_invI*e*e)),this.m_mass=k>0?1/k:0,a.warmStarting?(i.m_linearVelocity.x+=i.m_invMass*this.m_impulse*this.m_J.linearA.x,i.m_linearVelocity.y+=i.m_invMass*this.m_impulse*this.m_J.linearA.y,i.m_angularVelocity+=i.m_invI*this.m_impulse*this.m_J.angularA,j.m_linearVelocity.x+=j.m_invMass*this.m_impulse*this.m_J.linearB.x,j.m_linearVelocity.y+=j.m_invMass*this.m_impulse*this.m_J.linearB.y,j.m_angularVelocity+=j.m_invI*this.m_impulse*this.m_J.angularB):this.m_impulse=0},b2GearJoint.prototype.SolveVelocityConstraints=function(){var a=this.m_bodyA,b=this.m_bodyB,c=-this.m_mass*this.m_J.Compute(a.m_linearVelocity,a.m_angularVelocity,b.m_linearVelocity,b.m_angularVelocity);this.m_impulse+=c,a.m_linearVelocity.x+=a.m_invMass*c*this.m_J.linearA.x,a.m_linearVelocity.y+=a.m_invMass*c*this.m_J.linearA.y,a.m_angularVelocity+=a.m_invI*c*this.m_J.angularA,b.m_linearVelocity.x+=b.m_invMass*c*this.m_J.linearB.x,b.m_linearVelocity.y+=b.m_invMass*c*this.m_J.linearB.y,b.m_angularVelocity+=b.m_invI*c*this.m_J.angularB},b2GearJoint.prototype.SolvePositionConstraints=function(){var a,b,c=this.m_bodyA,d=this.m_bodyB;return a=this.m_revolute1?this.m_revolute1.GetJointAngle():this.m_prismatic1.GetJointTranslation(),b=this.m_revolute2?this.m_revolute2.GetJointAngle():this.m_prismatic2.GetJointTranslation(),a=-this.m_mass*(this.m_constant-(a+this.m_ratio*b)),c.m_sweep.c.x+=c.m_invMass*a*this.m_J.linearA.x,c.m_sweep.c.y+=c.m_invMass*a*this.m_J.linearA.y,c.m_sweep.a+=c.m_invI*a*this.m_J.angularA,d.m_sweep.c.x+=d.m_invMass*a*this.m_J.linearB.x,d.m_sweep.c.y+=d.m_invMass*a*this.m_J.linearB.y,d.m_sweep.a+=d.m_invI*a*this.m_J.angularB,c.SynchronizeTransform(),d.SynchronizeTransform(),0<b2Settings.b2_linearSlop},b2GearJoint.prototype.GetAnchorA=function(){return this.m_bodyA.GetWorldPoint(this.m_localAnchor1)},b2GearJoint.prototype.GetAnchorB=function(){return this.m_bodyB.GetWorldPoint(this.m_localAnchor2)},b2GearJoint.prototype.GetReactionForce=function(a){return new b2Vec2(a*this.m_impulse*this.m_J.linearB.x,a*this.m_impulse*this.m_J.linearB.y)},b2GearJoint.prototype.GetReactionTorque=function(a){var b=this.m_bodyB.m_xf.R,c=this.m_localAnchor1.x-this.m_bodyB.m_sweep.localCenter.x,d=this.m_localAnchor1.y-this.m_bodyB.m_sweep.localCenter.y,e=b.col1.x*c+b.col2.x*d;return d=b.col1.y*c+b.col2.y*d,c=e,a*(this.m_impulse*this.m_J.angularB-c*this.m_impulse*this.m_J.linearB.y+d*this.m_impulse*this.m_J.linearB.x)},b2GearJoint.prototype.GetRatio=function(){return this.m_ratio},b2GearJoint.prototype.SetRatio=function(a){this.m_ratio=a},b2GearJoint.prototype.m_ground1=null,b2GearJoint.prototype.m_ground2=null,b2GearJoint.prototype.m_revolute1=null,b2GearJoint.prototype.m_prismatic1=null,b2GearJoint.prototype.m_revolute2=null,b2GearJoint.prototype.m_prismatic2=null,b2GearJoint.prototype.m_groundAnchor1=new b2Vec2,b2GearJoint.prototype.m_groundAnchor2=new b2Vec2,b2GearJoint.prototype.m_localAnchor1=new b2Vec2,b2GearJoint.prototype.m_localAnchor2=new b2Vec2,b2GearJoint.prototype.m_J=new b2Jacobian,b2GearJoint.prototype.m_constant=null,b2GearJoint.prototype.m_ratio=null,b2GearJoint.prototype.m_mass=null,b2GearJoint.prototype.m_impulse=null;var b2TOIInput=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2TOIInput.prototype.__constructor=function(){},b2TOIInput.prototype.__varz=function(){this.proxyA=new b2DistanceProxy,this.proxyB=new b2DistanceProxy,this.sweepA=new b2Sweep,this.sweepB=new b2Sweep},b2TOIInput.prototype.proxyA=new b2DistanceProxy,b2TOIInput.prototype.proxyB=new b2DistanceProxy,b2TOIInput.prototype.sweepA=new b2Sweep,b2TOIInput.prototype.sweepB=new b2Sweep,b2TOIInput.prototype.tolerance=null;var b2RevoluteJointDef=function(){b2JointDef.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2RevoluteJointDef.prototype,b2JointDef.prototype),b2RevoluteJointDef.prototype._super=b2JointDef.prototype,b2RevoluteJointDef.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments),this.type=b2Joint.e_revoluteJoint,this.localAnchorA.Set(0,0),this.localAnchorB.Set(0,0),this.motorSpeed=this.maxMotorTorque=this.upperAngle=this.lowerAngle=this.referenceAngle=0,this.enableMotor=this.enableLimit=!1},b2RevoluteJointDef.prototype.__varz=function(){this.localAnchorA=new b2Vec2,this.localAnchorB=new b2Vec2},b2RevoluteJointDef.prototype.Initialize=function(a,b,c){this.bodyA=a,this.bodyB=b,this.localAnchorA=this.bodyA.GetLocalPoint(c),this.localAnchorB=this.bodyB.GetLocalPoint(c),this.referenceAngle=this.bodyB.GetAngle()-this.bodyA.GetAngle()},b2RevoluteJointDef.prototype.localAnchorA=new b2Vec2,b2RevoluteJointDef.prototype.localAnchorB=new b2Vec2,b2RevoluteJointDef.prototype.referenceAngle=null,b2RevoluteJointDef.prototype.enableLimit=null,b2RevoluteJointDef.prototype.lowerAngle=null,b2RevoluteJointDef.prototype.upperAngle=null,b2RevoluteJointDef.prototype.enableMotor=null,b2RevoluteJointDef.prototype.motorSpeed=null,b2RevoluteJointDef.prototype.maxMotorTorque=null;var b2MouseJointDef=function(){b2JointDef.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2MouseJointDef.prototype,b2JointDef.prototype),b2MouseJointDef.prototype._super=b2JointDef.prototype,b2MouseJointDef.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments),this.type=b2Joint.e_mouseJoint,this.maxForce=0,this.frequencyHz=5,this.dampingRatio=.7},b2MouseJointDef.prototype.__varz=function(){this.target=new b2Vec2},b2MouseJointDef.prototype.target=new b2Vec2,b2MouseJointDef.prototype.maxForce=null,b2MouseJointDef.prototype.frequencyHz=null,b2MouseJointDef.prototype.dampingRatio=null;var b2Contact=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Contact.prototype.__constructor=function(){},b2Contact.prototype.__varz=function(){this.m_nodeA=new b2ContactEdge,this.m_nodeB=new b2ContactEdge,this.m_manifold=new b2Manifold,this.m_oldManifold=new b2Manifold},b2Contact.s_input=new b2TOIInput,b2Contact.e_sensorFlag=1,b2Contact.e_continuousFlag=2,b2Contact.e_islandFlag=4,b2Contact.e_toiFlag=8,b2Contact.e_touchingFlag=16,b2Contact.e_enabledFlag=32,b2Contact.e_filterFlag=64,b2Contact.prototype.Reset=function(a,b){if(this.m_flags=b2Contact.e_enabledFlag,a&&b){(a.IsSensor()||b.IsSensor())&&(this.m_flags|=b2Contact.e_sensorFlag);var c=a.GetBody(),d=b.GetBody();(c.GetType()!=b2Body.b2_dynamicBody||c.IsBullet()||d.GetType()!=b2Body.b2_dynamicBody||d.IsBullet())&&(this.m_flags|=b2Contact.e_continuousFlag),this.m_fixtureA=a,this.m_fixtureB=b,this.m_manifold.m_pointCount=0,this.m_next=this.m_prev=null,this.m_nodeA.contact=null,this.m_nodeA.prev=null,this.m_nodeA.next=null,this.m_nodeA.other=null,this.m_nodeB.contact=null,this.m_nodeB.prev=null,this.m_nodeB.next=null,this.m_nodeB.other=null}else this.m_fixtureB=this.m_fixtureA=null},b2Contact.prototype.Update=function(a){var b=this.m_oldManifold;this.m_oldManifold=this.m_manifold,this.m_manifold=b,this.m_flags|=b2Contact.e_enabledFlag;var c=!1;b=(this.m_flags&b2Contact.e_touchingFlag)==b2Contact.e_touchingFlag;var d=this.m_fixtureA.m_body,e=this.m_fixtureB.m_body,f=this.m_fixtureA.m_aabb.TestOverlap(this.m_fixtureB.m_aabb);if(this.m_flags&b2Contact.e_sensorFlag)f&&(c=this.m_fixtureA.GetShape(),f=this.m_fixtureB.GetShape(),d=d.GetTransform(),e=e.GetTransform(),c=b2Shape.TestOverlap(c,d,f,e)),this.m_manifold.m_pointCount=0;else{if(d.GetType()!=b2Body.b2_dynamicBody||d.IsBullet()||e.GetType()!=b2Body.b2_dynamicBody||e.IsBullet()?this.m_flags|=b2Contact.e_continuousFlag:this.m_flags&=~b2Contact.e_continuousFlag,f)for(this.Evaluate(),c=this.m_manifold.m_pointCount>0,f=0;f<this.m_manifold.m_pointCount;++f){var g=this.m_manifold.m_points[f];g.m_normalImpulse=0,g.m_tangentImpulse=0;for(var h=g.m_id,i=0;i<this.m_oldManifold.m_pointCount;++i){var j=this.m_oldManifold.m_points[i];if(j.m_id.key==h.key){g.m_normalImpulse=j.m_normalImpulse,g.m_tangentImpulse=j.m_tangentImpulse;break}}}else this.m_manifold.m_pointCount=0;c!=b&&(d.SetAwake(!0),e.SetAwake(!0))}c?this.m_flags|=b2Contact.e_touchingFlag:this.m_flags&=~b2Contact.e_touchingFlag,0==b&&1==c&&a.BeginContact(this),1==b&&0==c&&a.EndContact(this),0==(this.m_flags&b2Contact.e_sensorFlag)&&a.PreSolve(this,this.m_oldManifold)},b2Contact.prototype.Evaluate=function(){},b2Contact.prototype.ComputeTOI=function(a,b){return b2Contact.s_input.proxyA.Set(this.m_fixtureA.GetShape()),b2Contact.s_input.proxyB.Set(this.m_fixtureB.GetShape()),b2Contact.s_input.sweepA=a,b2Contact.s_input.sweepB=b,b2Contact.s_input.tolerance=b2Settings.b2_linearSlop,b2TimeOfImpact.TimeOfImpact(b2Contact.s_input)},b2Contact.prototype.GetManifold=function(){return this.m_manifold},b2Contact.prototype.GetWorldManifold=function(a){var b=this.m_fixtureA.GetBody(),c=this.m_fixtureB.GetBody(),d=this.m_fixtureA.GetShape(),e=this.m_fixtureB.GetShape();a.Initialize(this.m_manifold,b.GetTransform(),d.m_radius,c.GetTransform(),e.m_radius)},b2Contact.prototype.IsTouching=function(){return(this.m_flags&b2Contact.e_touchingFlag)==b2Contact.e_touchingFlag},b2Contact.prototype.IsContinuous=function(){return(this.m_flags&b2Contact.e_continuousFlag)==b2Contact.e_continuousFlag},b2Contact.prototype.SetSensor=function(a){a?this.m_flags|=b2Contact.e_sensorFlag:this.m_flags&=~b2Contact.e_sensorFlag},b2Contact.prototype.IsSensor=function(){return(this.m_flags&b2Contact.e_sensorFlag)==b2Contact.e_sensorFlag},b2Contact.prototype.SetEnabled=function(a){a?this.m_flags|=b2Contact.e_enabledFlag:this.m_flags&=~b2Contact.e_enabledFlag},b2Contact.prototype.IsEnabled=function(){return(this.m_flags&b2Contact.e_enabledFlag)==b2Contact.e_enabledFlag},b2Contact.prototype.GetNext=function(){return this.m_next},b2Contact.prototype.GetFixtureA=function(){return this.m_fixtureA},b2Contact.prototype.GetFixtureB=function(){return this.m_fixtureB},b2Contact.prototype.FlagForFiltering=function(){this.m_flags|=b2Contact.e_filterFlag},b2Contact.prototype.m_flags=0,b2Contact.prototype.m_prev=null,b2Contact.prototype.m_next=null,b2Contact.prototype.m_nodeA=new b2ContactEdge,b2Contact.prototype.m_nodeB=new b2ContactEdge,b2Contact.prototype.m_fixtureA=null,b2Contact.prototype.m_fixtureB=null,b2Contact.prototype.m_manifold=new b2Manifold,b2Contact.prototype.m_oldManifold=new b2Manifold,b2Contact.prototype.m_toi=null;var b2ContactConstraint=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ContactConstraint.prototype.__constructor=function(){this.points=Array(b2Settings.b2_maxManifoldPoints);for(var a=0;a<b2Settings.b2_maxManifoldPoints;a++)this.points[a]=new b2ContactConstraintPoint},b2ContactConstraint.prototype.__varz=function(){this.localPlaneNormal=new b2Vec2,this.localPoint=new b2Vec2,this.normal=new b2Vec2,this.normalMass=new b2Mat22,this.K=new b2Mat22},b2ContactConstraint.prototype.points=null,b2ContactConstraint.prototype.localPlaneNormal=new b2Vec2,b2ContactConstraint.prototype.localPoint=new b2Vec2,b2ContactConstraint.prototype.normal=new b2Vec2,b2ContactConstraint.prototype.normalMass=new b2Mat22,b2ContactConstraint.prototype.K=new b2Mat22,b2ContactConstraint.prototype.bodyA=null,b2ContactConstraint.prototype.bodyB=null,b2ContactConstraint.prototype.type=0,b2ContactConstraint.prototype.radius=null,b2ContactConstraint.prototype.friction=null,b2ContactConstraint.prototype.restitution=null,b2ContactConstraint.prototype.pointCount=0,b2ContactConstraint.prototype.manifold=null;var b2ContactResult=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ContactResult.prototype.__constructor=function(){},b2ContactResult.prototype.__varz=function(){this.position=new b2Vec2,this.normal=new b2Vec2,this.id=new b2ContactID},b2ContactResult.prototype.shape1=null,b2ContactResult.prototype.shape2=null,b2ContactResult.prototype.position=new b2Vec2,b2ContactResult.prototype.normal=new b2Vec2,b2ContactResult.prototype.normalImpulse=null,b2ContactResult.prototype.tangentImpulse=null,b2ContactResult.prototype.id=new b2ContactID;var b2PolygonContact=function(){b2Contact.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2PolygonContact.prototype,b2Contact.prototype),b2PolygonContact.prototype._super=b2Contact.prototype,b2PolygonContact.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments)},b2PolygonContact.prototype.__varz=function(){},b2PolygonContact.Create=function(){return new b2PolygonContact},b2PolygonContact.Destroy=function(){},b2PolygonContact.prototype.Evaluate=function(){var a=this.m_fixtureA.GetBody(),b=this.m_fixtureB.GetBody();b2Collision.CollidePolygons(this.m_manifold,this.m_fixtureA.GetShape(),a.m_xf,this.m_fixtureB.GetShape(),b.m_xf)},b2PolygonContact.prototype.Reset=function(a,b){this._super.Reset.apply(this,[a,b])};var ClipVertex=function(){this.__varz(),this.__constructor.apply(this,arguments)};ClipVertex.prototype.__constructor=function(){},ClipVertex.prototype.__varz=function(){this.v=new b2Vec2,this.id=new b2ContactID},ClipVertex.prototype.Set=function(a){this.v.SetV(a.v),this.id.Set(a.id)},ClipVertex.prototype.v=new b2Vec2,ClipVertex.prototype.id=new b2ContactID;var b2ContactFilter=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ContactFilter.prototype.__constructor=function(){},b2ContactFilter.prototype.__varz=function(){},b2ContactFilter.b2_defaultFilter=new b2ContactFilter,b2ContactFilter.prototype.ShouldCollide=function(a,b){var c=a.GetFilterData(),d=b.GetFilterData();return c.groupIndex==d.groupIndex&&0!=c.groupIndex?c.groupIndex>0:0!=(c.maskBits&d.categoryBits)&&0!=(c.categoryBits&d.maskBits)},b2ContactFilter.prototype.RayCollide=function(a,b){return a?this.ShouldCollide(a,b):!0};var b2NullContact=function(){b2Contact.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2NullContact.prototype,b2Contact.prototype),b2NullContact.prototype._super=b2Contact.prototype,b2NullContact.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments)},b2NullContact.prototype.__varz=function(){},b2NullContact.prototype.Evaluate=function(){};var b2ContactListener=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ContactListener.prototype.__constructor=function(){},b2ContactListener.prototype.__varz=function(){},b2ContactListener.b2_defaultListener=new b2ContactListener,b2ContactListener.prototype.BeginContact=function(){},b2ContactListener.prototype.EndContact=function(){},b2ContactListener.prototype.PreSolve=function(){},b2ContactListener.prototype.PostSolve=function(){};var b2Island=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Island.prototype.__constructor=function(){this.m_bodies=[],this.m_contacts=[],this.m_joints=[]},b2Island.prototype.__varz=function(){},b2Island.s_impulse=new b2ContactImpulse,b2Island.prototype.Initialize=function(a,b,c,d,e,f){var g=0;for(this.m_bodyCapacity=a,this.m_contactCapacity=b,this.m_jointCapacity=c,this.m_jointCount=this.m_contactCount=this.m_bodyCount=0,this.m_allocator=d,this.m_listener=e,this.m_contactSolver=f,g=this.m_bodies.length;a>g;g++)this.m_bodies[g]=null;for(g=this.m_contacts.length;b>g;g++)this.m_contacts[g]=null;for(g=this.m_joints.length;c>g;g++)this.m_joints[g]=null},b2Island.prototype.Clear=function(){this.m_jointCount=this.m_contactCount=this.m_bodyCount=0},b2Island.prototype.Solve=function(a,b,c){var d,e=0,f=0;for(e=0;e<this.m_bodyCount;++e)f=this.m_bodies[e],f.GetType()==b2Body.b2_dynamicBody&&(f.m_linearVelocity.x+=a.dt*(b.x+f.m_invMass*f.m_force.x),f.m_linearVelocity.y+=a.dt*(b.y+f.m_invMass*f.m_force.y),f.m_angularVelocity+=a.dt*f.m_invI*f.m_torque,f.m_linearVelocity.Multiply(b2Math.Clamp(1-a.dt*f.m_linearDamping,0,1)),f.m_angularVelocity*=b2Math.Clamp(1-a.dt*f.m_angularDamping,0,1));
for(this.m_contactSolver.Initialize(a,this.m_contacts,this.m_contactCount,this.m_allocator),b=this.m_contactSolver,b.InitVelocityConstraints(a),e=0;e<this.m_jointCount;++e)d=this.m_joints[e],d.InitVelocityConstraints(a);for(e=0;e<a.velocityIterations;++e){for(f=0;f<this.m_jointCount;++f)d=this.m_joints[f],d.SolveVelocityConstraints(a);b.SolveVelocityConstraints()}for(e=0;e<this.m_jointCount;++e)d=this.m_joints[e],d.FinalizeVelocityConstraints();for(b.FinalizeVelocityConstraints(),e=0;e<this.m_bodyCount;++e)if(f=this.m_bodies[e],f.GetType()!=b2Body.b2_staticBody){var g=a.dt*f.m_linearVelocity.x,h=a.dt*f.m_linearVelocity.y;g*g+h*h>b2Settings.b2_maxTranslationSquared&&(f.m_linearVelocity.Normalize(),f.m_linearVelocity.x*=b2Settings.b2_maxTranslation*a.inv_dt,f.m_linearVelocity.y*=b2Settings.b2_maxTranslation*a.inv_dt),g=a.dt*f.m_angularVelocity,g*g>b2Settings.b2_maxRotationSquared&&(f.m_angularVelocity=f.m_angularVelocity<0?-b2Settings.b2_maxRotation*a.inv_dt:b2Settings.b2_maxRotation*a.inv_dt),f.m_sweep.c0.SetV(f.m_sweep.c),f.m_sweep.a0=f.m_sweep.a,f.m_sweep.c.x+=a.dt*f.m_linearVelocity.x,f.m_sweep.c.y+=a.dt*f.m_linearVelocity.y,f.m_sweep.a+=a.dt*f.m_angularVelocity,f.SynchronizeTransform()}for(e=0;e<a.positionIterations;++e){for(g=b.SolvePositionConstraints(b2Settings.b2_contactBaumgarte),h=!0,f=0;f<this.m_jointCount;++f)d=this.m_joints[f],d=d.SolvePositionConstraints(b2Settings.b2_contactBaumgarte),h=h&&d;if(g&&h)break}if(this.Report(b.m_constraints),c){for(c=Number.MAX_VALUE,b=b2Settings.b2_linearSleepTolerance*b2Settings.b2_linearSleepTolerance,g=b2Settings.b2_angularSleepTolerance*b2Settings.b2_angularSleepTolerance,e=0;e<this.m_bodyCount;++e)f=this.m_bodies[e],f.GetType()!=b2Body.b2_staticBody&&(0==(f.m_flags&b2Body.e_allowSleepFlag)&&(c=f.m_sleepTime=0),0==(f.m_flags&b2Body.e_allowSleepFlag)||f.m_angularVelocity*f.m_angularVelocity>g||b2Math.Dot(f.m_linearVelocity,f.m_linearVelocity)>b?c=f.m_sleepTime=0:(f.m_sleepTime+=a.dt,c=b2Math.Min(c,f.m_sleepTime)));if(c>=b2Settings.b2_timeToSleep)for(e=0;e<this.m_bodyCount;++e)f=this.m_bodies[e],f.SetAwake(!1)}},b2Island.prototype.SolveTOI=function(a){var b=0,c=0;this.m_contactSolver.Initialize(a,this.m_contacts,this.m_contactCount,this.m_allocator);var d=this.m_contactSolver;for(b=0;b<this.m_jointCount;++b)this.m_joints[b].InitVelocityConstraints(a);for(b=0;b<a.velocityIterations;++b)for(d.SolveVelocityConstraints(),c=0;c<this.m_jointCount;++c)this.m_joints[c].SolveVelocityConstraints(a);for(b=0;b<this.m_bodyCount;++b)if(c=this.m_bodies[b],c.GetType()!=b2Body.b2_staticBody){var e=a.dt*c.m_linearVelocity.x,f=a.dt*c.m_linearVelocity.y;e*e+f*f>b2Settings.b2_maxTranslationSquared&&(c.m_linearVelocity.Normalize(),c.m_linearVelocity.x*=b2Settings.b2_maxTranslation*a.inv_dt,c.m_linearVelocity.y*=b2Settings.b2_maxTranslation*a.inv_dt),e=a.dt*c.m_angularVelocity,e*e>b2Settings.b2_maxRotationSquared&&(c.m_angularVelocity=c.m_angularVelocity<0?-b2Settings.b2_maxRotation*a.inv_dt:b2Settings.b2_maxRotation*a.inv_dt),c.m_sweep.c0.SetV(c.m_sweep.c),c.m_sweep.a0=c.m_sweep.a,c.m_sweep.c.x+=a.dt*c.m_linearVelocity.x,c.m_sweep.c.y+=a.dt*c.m_linearVelocity.y,c.m_sweep.a+=a.dt*c.m_angularVelocity,c.SynchronizeTransform()}for(b=0;b<a.positionIterations;++b){for(e=d.SolvePositionConstraints(.75),f=!0,c=0;c<this.m_jointCount;++c){var g=this.m_joints[c].SolvePositionConstraints(b2Settings.b2_contactBaumgarte);f=f&&g}if(e&&f)break}this.Report(d.m_constraints)},b2Island.prototype.Report=function(a){if(null!=this.m_listener)for(var b=0;b<this.m_contactCount;++b){for(var c=this.m_contacts[b],d=a[b],e=0;e<d.pointCount;++e)b2Island.s_impulse.normalImpulses[e]=d.points[e].normalImpulse,b2Island.s_impulse.tangentImpulses[e]=d.points[e].tangentImpulse;this.m_listener.PostSolve(c,b2Island.s_impulse)}},b2Island.prototype.AddBody=function(a){a.m_islandIndex=this.m_bodyCount,this.m_bodies[this.m_bodyCount++]=a},b2Island.prototype.AddContact=function(a){this.m_contacts[this.m_contactCount++]=a},b2Island.prototype.AddJoint=function(a){this.m_joints[this.m_jointCount++]=a},b2Island.prototype.m_allocator=null,b2Island.prototype.m_listener=null,b2Island.prototype.m_contactSolver=null,b2Island.prototype.m_bodies=null,b2Island.prototype.m_contacts=null,b2Island.prototype.m_joints=null,b2Island.prototype.m_bodyCount=0,b2Island.prototype.m_jointCount=0,b2Island.prototype.m_contactCount=0,b2Island.prototype.m_bodyCapacity=0,b2Island.prototype.m_contactCapacity=0,b2Island.prototype.m_jointCapacity=0;var b2PolyAndEdgeContact=function(){b2Contact.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2PolyAndEdgeContact.prototype,b2Contact.prototype),b2PolyAndEdgeContact.prototype._super=b2Contact.prototype,b2PolyAndEdgeContact.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments)},b2PolyAndEdgeContact.prototype.__varz=function(){},b2PolyAndEdgeContact.Create=function(){return new b2PolyAndEdgeContact},b2PolyAndEdgeContact.Destroy=function(){},b2PolyAndEdgeContact.prototype.Evaluate=function(){var a=this.m_fixtureA.GetBody(),b=this.m_fixtureB.GetBody();this.b2CollidePolyAndEdge(this.m_manifold,this.m_fixtureA.GetShape(),a.m_xf,this.m_fixtureB.GetShape(),b.m_xf)},b2PolyAndEdgeContact.prototype.b2CollidePolyAndEdge=function(){},b2PolyAndEdgeContact.prototype.Reset=function(a,b){this._super.Reset.apply(this,[a,b]),b2Settings.b2Assert(a.GetType()==b2Shape.e_polygonShape),b2Settings.b2Assert(b.GetType()==b2Shape.e_edgeShape)};var b2Collision=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2Collision.prototype.__constructor=function(){},b2Collision.prototype.__varz=function(){},b2Collision.MakeClipPointVector=function(){var a=Array(2);return a[0]=new ClipVertex,a[1]=new ClipVertex,a},b2Collision.ClipSegmentToLine=function(a,b,c,d){var e,f=0;e=b[0];var g=e.v;e=b[1];var h=e.v,i=c.x*g.x+c.y*g.y-d;return e=c.x*h.x+c.y*h.y-d,0>=i&&a[f++].Set(b[0]),0>=e&&a[f++].Set(b[1]),0>i*e&&(c=i/(i-e),e=a[f],e=e.v,e.x=g.x+c*(h.x-g.x),e.y=g.y+c*(h.y-g.y),e=a[f],e.id=(i>0?b[0]:b[1]).id,++f),f},b2Collision.EdgeSeparation=function(a,b,c,d,e){var f=a.m_vertices;a=a.m_normals;var g,h,i=d.m_vertexCount,j=d.m_vertices;g=b.R,h=a[c],a=g.col1.x*h.x+g.col2.x*h.y,d=g.col1.y*h.x+g.col2.y*h.y,g=e.R;var k=g.col1.x*a+g.col1.y*d;g=g.col2.x*a+g.col2.y*d;for(var l=0,m=Number.MAX_VALUE,n=0;i>n;++n)h=j[n],h=h.x*k+h.y*g,m>h&&(m=h,l=n);return h=f[c],g=b.R,c=b.position.x+(g.col1.x*h.x+g.col2.x*h.y),b=b.position.y+(g.col1.y*h.x+g.col2.y*h.y),h=j[l],g=e.R,f=e.position.x+(g.col1.x*h.x+g.col2.x*h.y),e=e.position.y+(g.col1.y*h.x+g.col2.y*h.y),f-=c,e-=b,f*a+e*d},b2Collision.FindMaxSeparation=function(a,b,c,d,e){var f,g,h=b.m_vertexCount,i=b.m_normals;g=e.R,f=d.m_centroid;var j=e.position.x+(g.col1.x*f.x+g.col2.x*f.y),k=e.position.y+(g.col1.y*f.x+g.col2.y*f.y);g=c.R,f=b.m_centroid,j-=c.position.x+(g.col1.x*f.x+g.col2.x*f.y),k-=c.position.y+(g.col1.y*f.x+g.col2.y*f.y),g=j*c.R.col1.x+k*c.R.col1.y,k=j*c.R.col2.x+k*c.R.col2.y,j=0;for(var l=-Number.MAX_VALUE,m=0;h>m;++m)f=i[m],f=f.x*g+f.y*k,f>l&&(l=f,j=m);i=b2Collision.EdgeSeparation(b,c,j,d,e),k=j-1>=0?j-1:h-1,l=b2Collision.EdgeSeparation(b,c,k,d,e),m=h>j+1?j+1:0;var n=b2Collision.EdgeSeparation(b,c,m,d,e);if(g=f=0,l>i&&l>n)g=-1,f=k,k=l;else{if(!(n>i))return a[0]=j,i;g=1,f=m,k=n}for(;j=-1==g?f-1>=0?f-1:h-1:h>f+1?f+1:0,i=b2Collision.EdgeSeparation(b,c,j,d,e),i>k;)f=j,k=i;return a[0]=f,k},b2Collision.FindIncidentEdge=function(a,b,c,d,e,f){var g=b.m_normals,h=e.m_vertexCount;b=e.m_vertices,e=e.m_normals;var i;i=c.R,c=g[d],g=i.col1.x*c.x+i.col2.x*c.y;var j=i.col1.y*c.x+i.col2.y*c.y;i=f.R,c=i.col1.x*g+i.col1.y*j,j=i.col2.x*g+i.col2.y*j,g=c,i=0;for(var k=Number.MAX_VALUE,l=0;h>l;++l)c=e[l],c=g*c.x+j*c.y,k>c&&(k=c,i=l);e=i,g=h>e+1?e+1:0,h=a[0],c=b[e],i=f.R,h.v.x=f.position.x+(i.col1.x*c.x+i.col2.x*c.y),h.v.y=f.position.y+(i.col1.y*c.x+i.col2.y*c.y),h.id.features.referenceEdge=d,h.id.features.incidentEdge=e,h.id.features.incidentVertex=0,h=a[1],c=b[g],i=f.R,h.v.x=f.position.x+(i.col1.x*c.x+i.col2.x*c.y),h.v.y=f.position.y+(i.col1.y*c.x+i.col2.y*c.y),h.id.features.referenceEdge=d,h.id.features.incidentEdge=g,h.id.features.incidentVertex=1},b2Collision.CollidePolygons=function(a,b,c,d,e){var f;a.m_pointCount=0;var g=b.m_radius+d.m_radius;f=0,b2Collision.s_edgeAO[0]=f;var h=b2Collision.FindMaxSeparation(b2Collision.s_edgeAO,b,c,d,e);if(f=b2Collision.s_edgeAO[0],!(h>g)){var i=0;b2Collision.s_edgeBO[0]=i;var j=b2Collision.FindMaxSeparation(b2Collision.s_edgeBO,d,e,b,c);if(i=b2Collision.s_edgeBO[0],!(j>g)){var k=0,l=0;j>.98*h+.001?(h=d,d=b,b=e,c=c,k=i,a.m_type=b2Manifold.e_faceB,l=1):(h=b,d=d,b=c,c=e,k=f,a.m_type=b2Manifold.e_faceA,l=0),f=b2Collision.s_incidentEdge,b2Collision.FindIncidentEdge(f,h,b,k,d,c),e=h.m_vertices,i=e[k];var m;m=k+1<h.m_vertexCount?e[parseInt(k+1)]:e[0],k=b2Collision.s_localTangent,k.Set(m.x-i.x,m.y-i.y),k.Normalize(),e=b2Collision.s_localNormal,e.x=k.y,e.y=-k.x,d=b2Collision.s_planePoint,d.Set(.5*(i.x+m.x),.5*(i.y+m.y)),j=b2Collision.s_tangent,h=b.R,j.x=h.col1.x*k.x+h.col2.x*k.y,j.y=h.col1.y*k.x+h.col2.y*k.y;var n=b2Collision.s_tangent2;n.x=-j.x,n.y=-j.y,k=b2Collision.s_normal,k.x=j.y,k.y=-j.x;var o=b2Collision.s_v11,p=b2Collision.s_v12;if(o.x=b.position.x+(h.col1.x*i.x+h.col2.x*i.y),o.y=b.position.y+(h.col1.y*i.x+h.col2.y*i.y),p.x=b.position.x+(h.col1.x*m.x+h.col2.x*m.y),p.y=b.position.y+(h.col1.y*m.x+h.col2.y*m.y),b=k.x*o.x+k.y*o.y,h=j.x*p.x+j.y*p.y+g,m=b2Collision.s_clipPoints1,i=b2Collision.s_clipPoints2,p=0,p=b2Collision.ClipSegmentToLine(m,f,n,-j.x*o.x-j.y*o.y+g),!(2>p||(p=b2Collision.ClipSegmentToLine(i,m,j,h),2>p))){for(a.m_localPlaneNormal.SetV(e),a.m_localPoint.SetV(d),d=e=0;d<b2Settings.b2_maxManifoldPoints;++d)f=i[d],k.x*f.v.x+k.y*f.v.y-b<=g&&(j=a.m_points[e],h=c.R,n=f.v.x-c.position.x,o=f.v.y-c.position.y,j.m_localPoint.x=n*h.col1.x+o*h.col1.y,j.m_localPoint.y=n*h.col2.x+o*h.col2.y,j.m_id.Set(f.id),j.m_id.features.flip=l,++e);a.m_pointCount=e}}}},b2Collision.CollideCircles=function(a,b,c,d,e){a.m_pointCount=0;var f,g;f=c.R,g=b.m_p;var h=c.position.x+(f.col1.x*g.x+f.col2.x*g.y);c=c.position.y+(f.col1.y*g.x+f.col2.y*g.y),f=e.R,g=d.m_p,h=e.position.x+(f.col1.x*g.x+f.col2.x*g.y)-h,e=e.position.y+(f.col1.y*g.x+f.col2.y*g.y)-c,f=b.m_radius+d.m_radius,h*h+e*e>f*f||(a.m_type=b2Manifold.e_circles,a.m_localPoint.SetV(b.m_p),a.m_localPlaneNormal.SetZero(),a.m_pointCount=1,a.m_points[0].m_localPoint.SetV(d.m_p),a.m_points[0].m_id.key=0)},b2Collision.CollidePolygonAndCircle=function(a,b,c,d,e){a.m_pointCount=0;var f,g,h,i;i=e.R,h=d.m_p;var j=e.position.y+(i.col1.y*h.x+i.col2.y*h.y);f=e.position.x+(i.col1.x*h.x+i.col2.x*h.y)-c.position.x,g=j-c.position.y,i=c.R,c=f*i.col1.x+g*i.col1.y,i=f*i.col2.x+g*i.col2.y;var k=0;e=-Number.MAX_VALUE,j=b.m_radius+d.m_radius;var l=b.m_vertexCount,m=b.m_vertices;b=b.m_normals;for(var n=0;l>n;++n){if(h=m[n],f=c-h.x,g=i-h.y,h=b[n],h=h.x*f+h.y*g,h>j)return;h>e&&(e=h,k=n)}if(h=k,f=m[h],l=m[l>h+1?h+1:0],e<Number.MIN_VALUE)a.m_pointCount=1,a.m_type=b2Manifold.e_faceA,a.m_localPlaneNormal.SetV(b[k]),a.m_localPoint.x=.5*(f.x+l.x),a.m_localPoint.y=.5*(f.y+l.y);else if(e=(c-l.x)*(f.x-l.x)+(i-l.y)*(f.y-l.y),(c-f.x)*(l.x-f.x)+(i-f.y)*(l.y-f.y)<=0){if((c-f.x)*(c-f.x)+(i-f.y)*(i-f.y)>j*j)return;a.m_pointCount=1,a.m_type=b2Manifold.e_faceA,a.m_localPlaneNormal.x=c-f.x,a.m_localPlaneNormal.y=i-f.y,a.m_localPlaneNormal.Normalize(),a.m_localPoint.SetV(f)}else if(0>=e){if((c-l.x)*(c-l.x)+(i-l.y)*(i-l.y)>j*j)return;a.m_pointCount=1,a.m_type=b2Manifold.e_faceA,a.m_localPlaneNormal.x=c-l.x,a.m_localPlaneNormal.y=i-l.y,a.m_localPlaneNormal.Normalize(),a.m_localPoint.SetV(l)}else{if(k=.5*(f.x+l.x),f=.5*(f.y+l.y),e=(c-k)*b[h].x+(i-f)*b[h].y,e>j)return;a.m_pointCount=1,a.m_type=b2Manifold.e_faceA,a.m_localPlaneNormal.x=b[h].x,a.m_localPlaneNormal.y=b[h].y,a.m_localPlaneNormal.Normalize(),a.m_localPoint.Set(k,f)}a.m_points[0].m_localPoint.SetV(d.m_p),a.m_points[0].m_id.key=0},b2Collision.TestOverlap=function(a,b){var c=b.lowerBound,d=a.upperBound,e=c.x-d.x,f=c.y-d.y;c=a.lowerBound,d=b.upperBound;var g=c.y-d.y;return e>0||f>0?!1:c.x-d.x>0||g>0?!1:!0},b2Collision.b2_nullFeature=255,b2Collision.s_incidentEdge=b2Collision.MakeClipPointVector(),b2Collision.s_clipPoints1=b2Collision.MakeClipPointVector(),b2Collision.s_clipPoints2=b2Collision.MakeClipPointVector(),b2Collision.s_edgeAO=Array(1),b2Collision.s_edgeBO=Array(1),b2Collision.s_localTangent=new b2Vec2,b2Collision.s_localNormal=new b2Vec2,b2Collision.s_planePoint=new b2Vec2,b2Collision.s_normal=new b2Vec2,b2Collision.s_tangent=new b2Vec2,b2Collision.s_tangent2=new b2Vec2,b2Collision.s_v11=new b2Vec2,b2Collision.s_v12=new b2Vec2,b2Collision.b2CollidePolyTempVec=new b2Vec2;var b2PolyAndCircleContact=function(){b2Contact.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2PolyAndCircleContact.prototype,b2Contact.prototype),b2PolyAndCircleContact.prototype._super=b2Contact.prototype,b2PolyAndCircleContact.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments)},b2PolyAndCircleContact.prototype.__varz=function(){},b2PolyAndCircleContact.Create=function(){return new b2PolyAndCircleContact},b2PolyAndCircleContact.Destroy=function(){},b2PolyAndCircleContact.prototype.Evaluate=function(){var a=this.m_fixtureA.m_body,b=this.m_fixtureB.m_body;b2Collision.CollidePolygonAndCircle(this.m_manifold,this.m_fixtureA.GetShape(),a.m_xf,this.m_fixtureB.GetShape(),b.m_xf)},b2PolyAndCircleContact.prototype.Reset=function(a,b){this._super.Reset.apply(this,[a,b]),b2Settings.b2Assert(a.GetType()==b2Shape.e_polygonShape),b2Settings.b2Assert(b.GetType()==b2Shape.e_circleShape)};var b2ContactPoint=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ContactPoint.prototype.__constructor=function(){},b2ContactPoint.prototype.__varz=function(){this.position=new b2Vec2,this.velocity=new b2Vec2,this.normal=new b2Vec2,this.id=new b2ContactID},b2ContactPoint.prototype.shape1=null,b2ContactPoint.prototype.shape2=null,b2ContactPoint.prototype.position=new b2Vec2,b2ContactPoint.prototype.velocity=new b2Vec2,b2ContactPoint.prototype.normal=new b2Vec2,b2ContactPoint.prototype.separation=null,b2ContactPoint.prototype.friction=null,b2ContactPoint.prototype.restitution=null,b2ContactPoint.prototype.id=new b2ContactID;var b2CircleContact=function(){b2Contact.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2CircleContact.prototype,b2Contact.prototype),b2CircleContact.prototype._super=b2Contact.prototype,b2CircleContact.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments)},b2CircleContact.prototype.__varz=function(){},b2CircleContact.Create=function(){return new b2CircleContact},b2CircleContact.Destroy=function(){},b2CircleContact.prototype.Evaluate=function(){var a=this.m_fixtureA.GetBody(),b=this.m_fixtureB.GetBody();b2Collision.CollideCircles(this.m_manifold,this.m_fixtureA.GetShape(),a.m_xf,this.m_fixtureB.GetShape(),b.m_xf)},b2CircleContact.prototype.Reset=function(a,b){this._super.Reset.apply(this,[a,b])};var b2EdgeAndCircleContact=function(){b2Contact.prototype.__varz.call(this),this.__varz(),this.__constructor.apply(this,arguments)};extend(b2EdgeAndCircleContact.prototype,b2Contact.prototype),b2EdgeAndCircleContact.prototype._super=b2Contact.prototype,b2EdgeAndCircleContact.prototype.__constructor=function(){this._super.__constructor.apply(this,arguments)},b2EdgeAndCircleContact.prototype.__varz=function(){},b2EdgeAndCircleContact.Create=function(){return new b2EdgeAndCircleContact},b2EdgeAndCircleContact.Destroy=function(){},b2EdgeAndCircleContact.prototype.Evaluate=function(){var a=this.m_fixtureA.GetBody(),b=this.m_fixtureB.GetBody();this.b2CollideEdgeAndCircle(this.m_manifold,this.m_fixtureA.GetShape(),a.m_xf,this.m_fixtureB.GetShape(),b.m_xf)},b2EdgeAndCircleContact.prototype.b2CollideEdgeAndCircle=function(){},b2EdgeAndCircleContact.prototype.Reset=function(a,b){this._super.Reset.apply(this,[a,b])};var b2ContactManager=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2ContactManager.prototype.__constructor=function(){this.m_world=null,this.m_contactCount=0,this.m_contactFilter=b2ContactFilter.b2_defaultFilter,this.m_contactListener=b2ContactListener.b2_defaultListener,this.m_contactFactory=new b2ContactFactory(this.m_allocator),this.m_broadPhase=new b2DynamicTreeBroadPhase},b2ContactManager.prototype.__varz=function(){},b2ContactManager.s_evalCP=new b2ContactPoint,b2ContactManager.prototype.AddPair=function(a,b){var c=a,d=b,e=c.GetBody(),f=d.GetBody();if(e!=f){for(var g=f.GetContactList();g;){if(g.other==e){var h=g.contact.GetFixtureA(),i=g.contact.GetFixtureB();if(h==c&&i==d)return;if(h==d&&i==c)return}g=g.next}0!=f.ShouldCollide(e)&&0!=this.m_contactFilter.ShouldCollide(c,d)&&(g=this.m_contactFactory.Create(c,d),c=g.GetFixtureA(),d=g.GetFixtureB(),e=c.m_body,f=d.m_body,g.m_prev=null,g.m_next=this.m_world.m_contactList,null!=this.m_world.m_contactList&&(this.m_world.m_contactList.m_prev=g),this.m_world.m_contactList=g,g.m_nodeA.contact=g,g.m_nodeA.other=f,g.m_nodeA.prev=null,g.m_nodeA.next=e.m_contactList,null!=e.m_contactList&&(e.m_contactList.prev=g.m_nodeA),e.m_contactList=g.m_nodeA,g.m_nodeB.contact=g,g.m_nodeB.other=e,g.m_nodeB.prev=null,g.m_nodeB.next=f.m_contactList,null!=f.m_contactList&&(f.m_contactList.prev=g.m_nodeB),f.m_contactList=g.m_nodeB,++this.m_world.m_contactCount)}},b2ContactManager.prototype.FindNewContacts=function(){var a=this;this.m_broadPhase.UpdatePairs(function(b,c){return a.AddPair(b,c)})},b2ContactManager.prototype.Destroy=function(a){var b=a.GetFixtureA(),c=a.GetFixtureB();b=b.GetBody(),c=c.GetBody(),a.IsTouching()&&this.m_contactListener.EndContact(a),a.m_prev&&(a.m_prev.m_next=a.m_next),a.m_next&&(a.m_next.m_prev=a.m_prev),a==this.m_world.m_contactList&&(this.m_world.m_contactList=a.m_next),a.m_nodeA.prev&&(a.m_nodeA.prev.next=a.m_nodeA.next),a.m_nodeA.next&&(a.m_nodeA.next.prev=a.m_nodeA.prev),a.m_nodeA==b.m_contactList&&(b.m_contactList=a.m_nodeA.next),a.m_nodeB.prev&&(a.m_nodeB.prev.next=a.m_nodeB.next),a.m_nodeB.next&&(a.m_nodeB.next.prev=a.m_nodeB.prev),a.m_nodeB==c.m_contactList&&(c.m_contactList=a.m_nodeB.next),this.m_contactFactory.Destroy(a),--this.m_contactCount},b2ContactManager.prototype.Collide=function(){for(var a=this.m_world.m_contactList;a;){var b=a.GetFixtureA(),c=a.GetFixtureB(),d=b.GetBody(),e=c.GetBody();if(0==d.IsAwake()&&0==e.IsAwake())a=a.GetNext();else{if(a.m_flags&b2Contact.e_filterFlag){if(0==e.ShouldCollide(d)){b=a,a=b.GetNext(),this.Destroy(b);continue}if(0==this.m_contactFilter.ShouldCollide(b,c)){b=a,a=b.GetNext(),this.Destroy(b);continue}a.m_flags&=~b2Contact.e_filterFlag}0==this.m_broadPhase.TestOverlap(b.m_proxy,c.m_proxy)?(b=a,a=b.GetNext(),this.Destroy(b)):(a.Update(this.m_contactListener),a=a.GetNext())}}},b2ContactManager.prototype.m_world=null,b2ContactManager.prototype.m_broadPhase=null,b2ContactManager.prototype.m_contactList=null,b2ContactManager.prototype.m_contactCount=0,b2ContactManager.prototype.m_contactFilter=null,b2ContactManager.prototype.m_contactListener=null,b2ContactManager.prototype.m_contactFactory=null,b2ContactManager.prototype.m_allocator=null;var b2World=function(){this.__varz(),this.__constructor.apply(this,arguments)};b2World.prototype.__constructor=function(a,b){this.m_controllerList=this.m_jointList=this.m_contactList=this.m_bodyList=this.m_debugDraw=this.m_destructionListener=null,this.m_controllerCount=this.m_jointCount=this.m_contactCount=this.m_bodyCount=0,b2World.m_warmStarting=!0,b2World.m_continuousPhysics=!0,this.m_allowSleep=b,this.m_gravity=a,this.m_inv_dt0=0,this.m_contactManager.m_world=this,this.m_groundBody=this.CreateBody(new b2BodyDef)},b2World.prototype.__varz=function(){this.s_stack=[],this.m_contactManager=new b2ContactManager,this.m_contactSolver=new b2ContactSolver,this.m_island=new b2Island},b2World.s_timestep2=new b2TimeStep,b2World.s_backupA=new b2Sweep,b2World.s_backupB=new b2Sweep,b2World.s_timestep=new b2TimeStep,b2World.s_queue=[],b2World.e_newFixture=1,b2World.e_locked=2,b2World.s_xf=new b2Transform,b2World.s_jointColor=new b2Color(.5,.8,.8),b2World.m_warmStarting=null,b2World.m_continuousPhysics=null,b2World.prototype.Solve=function(a){for(var b,c=this.m_controllerList;c;c=c.m_next)c.Step(a);for(c=this.m_island,c.Initialize(this.m_bodyCount,this.m_contactCount,this.m_jointCount,null,this.m_contactManager.m_contactListener,this.m_contactSolver),b=this.m_bodyList;b;b=b.m_next)b.m_flags&=~b2Body.e_islandFlag;for(var d=this.m_contactList;d;d=d.m_next)d.m_flags&=~b2Contact.e_islandFlag;for(d=this.m_jointList;d;d=d.m_next)d.m_islandFlag=!1;d=this.s_stack;for(var e=this.m_bodyList;e;e=e.m_next)if(!(e.m_flags&b2Body.e_islandFlag)&&0!=e.IsAwake()&&0!=e.IsActive()&&e.GetType()!=b2Body.b2_staticBody){c.Clear();var f=0;for(d[f++]=e,e.m_flags|=b2Body.e_islandFlag;f>0;)if(b=d[--f],c.AddBody(b),0==b.IsAwake()&&b.SetAwake(!0),b.GetType()!=b2Body.b2_staticBody){for(var g,h=b.m_contactList;h;h=h.next)h.contact.m_flags&b2Contact.e_islandFlag||1!=h.contact.IsSensor()&&0!=h.contact.IsEnabled()&&0!=h.contact.IsTouching()&&(c.AddContact(h.contact),h.contact.m_flags|=b2Contact.e_islandFlag,g=h.other,g.m_flags&b2Body.e_islandFlag||(d[f++]=g,g.m_flags|=b2Body.e_islandFlag));for(b=b.m_jointList;b;b=b.next)1!=b.joint.m_islandFlag&&(g=b.other,0!=g.IsActive()&&(c.AddJoint(b.joint),b.joint.m_islandFlag=!0,g.m_flags&b2Body.e_islandFlag||(d[f++]=g,g.m_flags|=b2Body.e_islandFlag)))}for(c.Solve(a,this.m_gravity,this.m_allowSleep),f=0;f<c.m_bodyCount;++f)b=c.m_bodies[f],b.GetType()==b2Body.b2_staticBody&&(b.m_flags&=~b2Body.e_islandFlag)}for(f=0;f<d.length&&d[f];++f)d[f]=null;for(b=this.m_bodyList;b;b=b.m_next)0==b.IsAwake()||0==b.IsActive()||b.GetType()!=b2Body.b2_staticBody&&b.SynchronizeFixtures();this.m_contactManager.FindNewContacts()},b2World.prototype.SolveTOI=function(a){var b,c,d,e=this.m_island;e.Initialize(this.m_bodyCount,b2Settings.b2_maxTOIContactsPerIsland,b2Settings.b2_maxTOIJointsPerIsland,null,this.m_contactManager.m_contactListener,this.m_contactSolver);var f=b2World.s_queue;for(b=this.m_bodyList;b;b=b.m_next)b.m_flags&=~b2Body.e_islandFlag,b.m_sweep.t0=0;for(d=this.m_contactList;d;d=d.m_next)d.m_flags&=~(b2Contact.e_toiFlag|b2Contact.e_islandFlag);for(d=this.m_jointList;d;d=d.m_next)d.m_islandFlag=!1;for(;;){var g=null,h=1;for(d=this.m_contactList;d;d=d.m_next)if(1!=d.IsSensor()&&0!=d.IsEnabled()&&0!=d.IsContinuous()){if(b=1,d.m_flags&b2Contact.e_toiFlag)b=d.m_toi;else{if(b=d.m_fixtureA,c=d.m_fixtureB,b=b.m_body,c=c.m_body,!(b.GetType()==b2Body.b2_dynamicBody&&0!=b.IsAwake()||c.GetType()==b2Body.b2_dynamicBody&&0!=c.IsAwake()))continue;var i=b.m_sweep.t0;b.m_sweep.t0<c.m_sweep.t0?(i=c.m_sweep.t0,b.m_sweep.Advance(i)):c.m_sweep.t0<b.m_sweep.t0&&(i=b.m_sweep.t0,c.m_sweep.Advance(i)),b=d.ComputeTOI(b.m_sweep,c.m_sweep),b2Settings.b2Assert(b>=0&&1>=b),b>0&&1>b&&(b=(1-b)*i+b,b>1&&(b=1)),d.m_toi=b,d.m_flags|=b2Contact.e_toiFlag}Number.MIN_VALUE<b&&h>b&&(g=d,h=b)}if(null==g||1-100*Number.MIN_VALUE<h)break;if(b=g.m_fixtureA,c=g.m_fixtureB,b=b.m_body,c=c.m_body,b2World.s_backupA.Set(b.m_sweep),b2World.s_backupB.Set(c.m_sweep),b.Advance(h),c.Advance(h),g.Update(this.m_contactManager.m_contactListener),g.m_flags&=~b2Contact.e_toiFlag,1==g.IsSensor()||0==g.IsEnabled())b.m_sweep.Set(b2World.s_backupA),c.m_sweep.Set(b2World.s_backupB),b.SynchronizeTransform(),c.SynchronizeTransform();else if(0!=g.IsTouching()){for(b=b,b.GetType()!=b2Body.b2_dynamicBody&&(b=c),e.Clear(),g=d=0,f[d+g++]=b,b.m_flags|=b2Body.e_islandFlag;g>0;)if(b=f[d++],--g,e.AddBody(b),0==b.IsAwake()&&b.SetAwake(!0),b.GetType()==b2Body.b2_dynamicBody){for(c=b.m_contactList;c&&e.m_contactCount!=e.m_contactCapacity;c=c.next)c.contact.m_flags&b2Contact.e_islandFlag||1!=c.contact.IsSensor()&&0!=c.contact.IsEnabled()&&0!=c.contact.IsTouching()&&(e.AddContact(c.contact),c.contact.m_flags|=b2Contact.e_islandFlag,i=c.other,i.m_flags&b2Body.e_islandFlag||(i.GetType()!=b2Body.b2_staticBody&&(i.Advance(h),i.SetAwake(!0)),f[d+g]=i,++g,i.m_flags|=b2Body.e_islandFlag));for(b=b.m_jointList;b;b=b.next)e.m_jointCount!=e.m_jointCapacity&&1!=b.joint.m_islandFlag&&(i=b.other,0!=i.IsActive()&&(e.AddJoint(b.joint),b.joint.m_islandFlag=!0,i.m_flags&b2Body.e_islandFlag||(i.GetType()!=b2Body.b2_staticBody&&(i.Advance(h),i.SetAwake(!0)),f[d+g]=i,++g,i.m_flags|=b2Body.e_islandFlag)))}for(d=b2World.s_timestep,d.warmStarting=!1,d.dt=(1-h)*a.dt,d.inv_dt=1/d.dt,d.dtRatio=0,d.velocityIterations=a.velocityIterations,d.positionIterations=a.positionIterations,e.SolveTOI(d),h=h=0;h<e.m_bodyCount;++h)if(b=e.m_bodies[h],b.m_flags&=~b2Body.e_islandFlag,0!=b.IsAwake()&&b.GetType()==b2Body.b2_dynamicBody)for(b.SynchronizeFixtures(),c=b.m_contactList;c;c=c.next)c.contact.m_flags&=~b2Contact.e_toiFlag;for(h=0;h<e.m_contactCount;++h)d=e.m_contacts[h],d.m_flags&=~(b2Contact.e_toiFlag|b2Contact.e_islandFlag);for(h=0;h<e.m_jointCount;++h)d=e.m_joints[h],d.m_islandFlag=!1;this.m_contactManager.FindNewContacts()}}},b2World.prototype.DrawJoint=function(a){var b=a.GetBodyA(),c=a.GetBodyB(),d=b.m_xf.position,e=c.m_xf.position,f=a.GetAnchorA(),g=a.GetAnchorB(),h=b2World.s_jointColor;switch(a.m_type){case b2Joint.e_distanceJoint:this.m_debugDraw.DrawSegment(f,g,h);break;case b2Joint.e_pulleyJoint:b=a.GetGroundAnchorA(),a=a.GetGroundAnchorB(),this.m_debugDraw.DrawSegment(b,f,h),this.m_debugDraw.DrawSegment(a,g,h),this.m_debugDraw.DrawSegment(b,a,h);break;case b2Joint.e_mouseJoint:this.m_debugDraw.DrawSegment(f,g,h);break;default:b!=this.m_groundBody&&this.m_debugDraw.DrawSegment(d,f,h),this.m_debugDraw.DrawSegment(f,g,h),c!=this.m_groundBody&&this.m_debugDraw.DrawSegment(e,g,h)}},b2World.prototype.DrawShape=function(a,b,c){switch(a.m_type){case b2Shape.e_circleShape:this.m_debugDraw.DrawSolidCircle(b2Math.MulX(b,a.m_p),a.m_radius,b.R.col1,c);break;case b2Shape.e_polygonShape:var d=0,e=a.GetVertexCount();a=a.GetVertices();var f=Array(e);for(d=0;e>d;++d)f[d]=b2Math.MulX(b,a[d]);this.m_debugDraw.DrawSolidPolygon(f,e,c);break;case b2Shape.e_edgeShape:this.m_debugDraw.DrawSegment(b2Math.MulX(b,a.GetVertex1()),b2Math.MulX(b,a.GetVertex2()),c)}},b2World.prototype.SetDestructionListener=function(a){this.m_destructionListener=a},b2World.prototype.SetContactFilter=function(a){this.m_contactManager.m_contactFilter=a},b2World.prototype.SetContactListener=function(a){this.m_contactManager.m_contactListener=a},b2World.prototype.SetDebugDraw=function(a){this.m_debugDraw=a},b2World.prototype.SetBroadPhase=function(a){var b=this.m_contactManager.m_broadPhase;this.m_contactManager.m_broadPhase=a;for(var c=this.m_bodyList;c;c=c.m_next)for(var d=c.m_fixtureList;d;d=d.m_next)d.m_proxy=a.CreateProxy(b.GetFatAABB(d.m_proxy),d)},b2World.prototype.Validate=function(){this.m_contactManager.m_broadPhase.Validate()},b2World.prototype.GetProxyCount=function(){return this.m_contactManager.m_broadPhase.GetProxyCount()},b2World.prototype.CreateBody=function(a){return 1==this.IsLocked()?null:(a=new b2Body(a,this),a.m_prev=null,(a.m_next=this.m_bodyList)&&(this.m_bodyList.m_prev=a),this.m_bodyList=a,++this.m_bodyCount,a)},b2World.prototype.DestroyBody=function(a){if(1!=this.IsLocked()){for(var b=a.m_jointList;b;){var c=b;b=b.next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeJoint(c.joint),this.DestroyJoint(c.joint)}for(b=a.m_controllerList;b;)c=b,b=b.nextController,c.controller.RemoveBody(a);for(b=a.m_contactList;b;)c=b,b=b.next,this.m_contactManager.Destroy(c.contact);for(a.m_contactList=null,b=a.m_fixtureList;b;)c=b,b=b.m_next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeFixture(c),c.DestroyProxy(this.m_contactManager.m_broadPhase),c.Destroy();a.m_fixtureList=null,a.m_fixtureCount=0,a.m_prev&&(a.m_prev.m_next=a.m_next),a.m_next&&(a.m_next.m_prev=a.m_prev),a==this.m_bodyList&&(this.m_bodyList=a.m_next),--this.m_bodyCount}},b2World.prototype.CreateJoint=function(a){var b=b2Joint.Create(a,null);b.m_prev=null,(b.m_next=this.m_jointList)&&(this.m_jointList.m_prev=b),this.m_jointList=b,++this.m_jointCount,b.m_edgeA.joint=b,b.m_edgeA.other=b.m_bodyB,b.m_edgeA.prev=null,(b.m_edgeA.next=b.m_bodyA.m_jointList)&&(b.m_bodyA.m_jointList.prev=b.m_edgeA),b.m_bodyA.m_jointList=b.m_edgeA,b.m_edgeB.joint=b,b.m_edgeB.other=b.m_bodyA,b.m_edgeB.prev=null,(b.m_edgeB.next=b.m_bodyB.m_jointList)&&(b.m_bodyB.m_jointList.prev=b.m_edgeB),b.m_bodyB.m_jointList=b.m_edgeB;var c=a.bodyA,d=a.bodyB;if(0==a.collideConnected)for(a=d.GetContactList();a;)a.other==c&&a.contact.FlagForFiltering(),a=a.next;return b},b2World.prototype.DestroyJoint=function(a){var b=a.m_collideConnected;a.m_prev&&(a.m_prev.m_next=a.m_next),a.m_next&&(a.m_next.m_prev=a.m_prev),a==this.m_jointList&&(this.m_jointList=a.m_next);var c=a.m_bodyA,d=a.m_bodyB;if(c.SetAwake(!0),d.SetAwake(!0),a.m_edgeA.prev&&(a.m_edgeA.prev.next=a.m_edgeA.next),a.m_edgeA.next&&(a.m_edgeA.next.prev=a.m_edgeA.prev),a.m_edgeA==c.m_jointList&&(c.m_jointList=a.m_edgeA.next),a.m_edgeA.prev=null,a.m_edgeA.next=null,a.m_edgeB.prev&&(a.m_edgeB.prev.next=a.m_edgeB.next),a.m_edgeB.next&&(a.m_edgeB.next.prev=a.m_edgeB.prev),a.m_edgeB==d.m_jointList&&(d.m_jointList=a.m_edgeB.next),a.m_edgeB.prev=null,a.m_edgeB.next=null,b2Joint.Destroy(a,null),--this.m_jointCount,0==b)for(a=d.GetContactList();a;)a.other==c&&a.contact.FlagForFiltering(),a=a.next},b2World.prototype.AddController=function(a){return a.m_next=this.m_controllerList,a.m_prev=null,this.m_controllerList=a,a.m_world=this,this.m_controllerCount++,a},b2World.prototype.RemoveController=function(a){a.m_prev&&(a.m_prev.m_next=a.m_next),a.m_next&&(a.m_next.m_prev=a.m_prev),this.m_controllerList==a&&(this.m_controllerList=a.m_next),this.m_controllerCount--},b2World.prototype.CreateController=function(a){if(a.m_world!=this)throw Error("Controller can only be a member of one world");return a.m_next=this.m_controllerList,a.m_prev=null,this.m_controllerList&&(this.m_controllerList.m_prev=a),this.m_controllerList=a,++this.m_controllerCount,a.m_world=this,a},b2World.prototype.DestroyController=function(a){a.Clear(),a.m_next&&(a.m_next.m_prev=a.m_prev),a.m_prev&&(a.m_prev.m_next=a.m_next),a==this.m_controllerList&&(this.m_controllerList=a.m_next),--this.m_controllerCount},b2World.prototype.SetWarmStarting=function(a){b2World.m_warmStarting=a},b2World.prototype.SetContinuousPhysics=function(a){b2World.m_continuousPhysics=a},b2World.prototype.GetBodyCount=function(){return this.m_bodyCount},b2World.prototype.GetJointCount=function(){return this.m_jointCount},b2World.prototype.GetContactCount=function(){return this.m_contactCount},b2World.prototype.SetGravity=function(a){this.m_gravity=a},b2World.prototype.GetGravity=function(){return this.m_gravity},b2World.prototype.GetGroundBody=function(){return this.m_groundBody},b2World.prototype.Step=function(a,b,c){this.m_flags&b2World.e_newFixture&&(this.m_contactManager.FindNewContacts(),this.m_flags&=~b2World.e_newFixture),this.m_flags|=b2World.e_locked;var d=b2World.s_timestep2;d.dt=a,d.velocityIterations=b,d.positionIterations=c,d.inv_dt=a>0?1/a:0,d.dtRatio=this.m_inv_dt0*a,d.warmStarting=b2World.m_warmStarting,this.m_contactManager.Collide(),d.dt>0&&this.Solve(d),b2World.m_continuousPhysics&&d.dt>0&&this.SolveTOI(d),d.dt>0&&(this.m_inv_dt0=d.inv_dt),this.m_flags&=~b2World.e_locked},b2World.prototype.ClearForces=function(){for(var a=this.m_bodyList;a;a=a.m_next)a.m_force.SetZero(),a.m_torque=0},b2World.prototype.DrawDebugData=function(){if(null!=this.m_debugDraw){this.m_debugDraw.Clear();var a,b,c,d=this.m_debugDraw.GetFlags();new b2Vec2,new b2Vec2,new b2Vec2;var e;new b2AABB,new b2AABB,e=[new b2Vec2,new b2Vec2,new b2Vec2,new b2Vec2];var f=new b2Color(0,0,0);if(d&b2DebugDraw.e_shapeBit)for(a=this.m_bodyList;a;a=a.m_next)for(e=a.m_xf,b=a.GetFixtureList();b;b=b.m_next)c=b.GetShape(),0==a.IsActive()?f.Set(.5,.5,.3):a.GetType()==b2Body.b2_staticBody?f.Set(.5,.9,.5):a.GetType()==b2Body.b2_kinematicBody?f.Set(.5,.5,.9):0==a.IsAwake()?f.Set(.6,.6,.6):f.Set(.9,.7,.7),this.DrawShape(c,e,f);if(d&b2DebugDraw.e_jointBit)for(a=this.m_jointList;a;a=a.m_next)this.DrawJoint(a);
if(d&b2DebugDraw.e_controllerBit)for(a=this.m_controllerList;a;a=a.m_next)a.Draw(this.m_debugDraw);if(d&b2DebugDraw.e_pairBit)for(f.Set(.3,.9,.9),a=this.m_contactManager.m_contactList;a;a=a.GetNext())c=a.GetFixtureA(),b=a.GetFixtureB(),c=c.GetAABB().GetCenter(),b=b.GetAABB().GetCenter(),this.m_debugDraw.DrawSegment(c,b,f);if(d&b2DebugDraw.e_aabbBit)for(c=this.m_contactManager.m_broadPhase,e=[new b2Vec2,new b2Vec2,new b2Vec2,new b2Vec2],a=this.m_bodyList;a;a=a.GetNext())if(0!=a.IsActive())for(b=a.GetFixtureList();b;b=b.GetNext()){var g=c.GetFatAABB(b.m_proxy);e[0].Set(g.lowerBound.x,g.lowerBound.y),e[1].Set(g.upperBound.x,g.lowerBound.y),e[2].Set(g.upperBound.x,g.upperBound.y),e[3].Set(g.lowerBound.x,g.upperBound.y),this.m_debugDraw.DrawPolygon(e,4,f)}if(d&b2DebugDraw.e_centerOfMassBit)for(a=this.m_bodyList;a;a=a.m_next)e=b2World.s_xf,e.R=a.m_xf.R,e.position=a.GetWorldCenter(),this.m_debugDraw.DrawTransform(e)}},b2World.prototype.QueryAABB=function(a,b){var c=this.m_contactManager.m_broadPhase;c.Query(function(b){return a(c.GetUserData(b))},b)},b2World.prototype.QueryShape=function(a,b,c){null==c&&(c=new b2Transform,c.SetIdentity());var d=this.m_contactManager.m_broadPhase,e=new b2AABB;b.ComputeAABB(e,c),d.Query(function(e){return e=d.GetUserData(e),b2Shape.TestOverlap(b,c,e.GetShape(),e.GetBody().GetTransform())?a(e):!0},e)},b2World.prototype.QueryPoint=function(a,b){var c=this.m_contactManager.m_broadPhase,d=new b2AABB;d.lowerBound.Set(b.x-b2Settings.b2_linearSlop,b.y-b2Settings.b2_linearSlop),d.upperBound.Set(b.x+b2Settings.b2_linearSlop,b.y+b2Settings.b2_linearSlop),c.Query(function(d){return d=c.GetUserData(d),d.TestPoint(b)?a(d):!0},d)},b2World.prototype.RayCast=function(a,b,c){var d=this.m_contactManager.m_broadPhase,e=new b2RayCastOutput,f=new b2RayCastInput(b,c);d.RayCast(function(f,g){var h=d.GetUserData(g);if(h.RayCast(e,f)){var i=e.fraction,j=new b2Vec2((1-i)*b.x+i*c.x,(1-i)*b.y+i*c.y);return a(h,j,e.normal,i)}return f.maxFraction},f)},b2World.prototype.RayCastOne=function(a,b){var c;return this.RayCast(function(a,b,d,e){return c=a,e},a,b),c},b2World.prototype.RayCastAll=function(a,b){var c=[];return this.RayCast(function(a){return c[c.length]=a,1},a,b),c},b2World.prototype.GetBodyList=function(){return this.m_bodyList},b2World.prototype.GetJointList=function(){return this.m_jointList},b2World.prototype.GetContactList=function(){return this.m_contactList},b2World.prototype.IsLocked=function(){return(this.m_flags&b2World.e_locked)>0},b2World.prototype.s_stack=[],b2World.prototype.m_flags=0,b2World.prototype.m_contactManager=new b2ContactManager,b2World.prototype.m_contactSolver=new b2ContactSolver,b2World.prototype.m_island=new b2Island,b2World.prototype.m_bodyList=null,b2World.prototype.m_jointList=null,b2World.prototype.m_contactList=null,b2World.prototype.m_bodyCount=0,b2World.prototype.m_contactCount=0,b2World.prototype.m_jointCount=0,b2World.prototype.m_controllerList=null,b2World.prototype.m_controllerCount=0,b2World.prototype.m_gravity=null,b2World.prototype.m_allowSleep=null,b2World.prototype.m_groundBody=null,b2World.prototype.m_destructionListener=null,b2World.prototype.m_debugDraw=null,b2World.prototype.m_inv_dt0=null,"undefined"!=typeof exports&&(exports.b2BoundValues=b2BoundValues,exports.b2Math=b2Math,exports.b2DistanceOutput=b2DistanceOutput,exports.b2Mat33=b2Mat33,exports.b2ContactPoint=b2ContactPoint,exports.b2PairManager=b2PairManager,exports.b2PositionSolverManifold=b2PositionSolverManifold,exports.b2OBB=b2OBB,exports.b2CircleContact=b2CircleContact,exports.b2PulleyJoint=b2PulleyJoint,exports.b2Pair=b2Pair,exports.b2TimeStep=b2TimeStep,exports.b2FixtureDef=b2FixtureDef,exports.b2World=b2World,exports.b2PrismaticJoint=b2PrismaticJoint,exports.b2Controller=b2Controller,exports.b2ContactID=b2ContactID,exports.b2RevoluteJoint=b2RevoluteJoint,exports.b2JointDef=b2JointDef,exports.b2Transform=b2Transform,exports.b2GravityController=b2GravityController,exports.b2EdgeAndCircleContact=b2EdgeAndCircleContact,exports.b2EdgeShape=b2EdgeShape,exports.b2BuoyancyController=b2BuoyancyController,exports.b2LineJointDef=b2LineJointDef,exports.b2Contact=b2Contact,exports.b2DistanceJoint=b2DistanceJoint,exports.b2Body=b2Body,exports.b2DestructionListener=b2DestructionListener,exports.b2PulleyJointDef=b2PulleyJointDef,exports.b2ContactEdge=b2ContactEdge,exports.b2ContactConstraint=b2ContactConstraint,exports.b2ContactImpulse=b2ContactImpulse,exports.b2DistanceJointDef=b2DistanceJointDef,exports.b2ContactResult=b2ContactResult,exports.b2EdgeChainDef=b2EdgeChainDef,exports.b2Vec2=b2Vec2,exports.b2Vec3=b2Vec3,exports.b2DistanceProxy=b2DistanceProxy,exports.b2FrictionJointDef=b2FrictionJointDef,exports.b2PolygonContact=b2PolygonContact,exports.b2TensorDampingController=b2TensorDampingController,exports.b2ContactFactory=b2ContactFactory,exports.b2WeldJointDef=b2WeldJointDef,exports.b2ConstantAccelController=b2ConstantAccelController,exports.b2GearJointDef=b2GearJointDef,exports.ClipVertex=ClipVertex,exports.b2SeparationFunction=b2SeparationFunction,exports.b2ManifoldPoint=b2ManifoldPoint,exports.b2Color=b2Color,exports.b2PolygonShape=b2PolygonShape,exports.b2DynamicTreePair=b2DynamicTreePair,exports.b2ContactConstraintPoint=b2ContactConstraintPoint,exports.b2FrictionJoint=b2FrictionJoint,exports.b2ContactFilter=b2ContactFilter,exports.b2ControllerEdge=b2ControllerEdge,exports.b2Distance=b2Distance,exports.b2Fixture=b2Fixture,exports.b2DynamicTreeNode=b2DynamicTreeNode,exports.b2MouseJoint=b2MouseJoint,exports.b2DistanceInput=b2DistanceInput,exports.b2BodyDef=b2BodyDef,exports.b2DynamicTreeBroadPhase=b2DynamicTreeBroadPhase,exports.b2Settings=b2Settings,exports.b2Proxy=b2Proxy,exports.b2Point=b2Point,exports.b2BroadPhase=b2BroadPhase,exports.b2Manifold=b2Manifold,exports.b2WorldManifold=b2WorldManifold,exports.b2PrismaticJointDef=b2PrismaticJointDef,exports.b2RayCastOutput=b2RayCastOutput,exports.b2ConstantForceController=b2ConstantForceController,exports.b2TimeOfImpact=b2TimeOfImpact,exports.b2CircleShape=b2CircleShape,exports.b2MassData=b2MassData,exports.b2Joint=b2Joint,exports.b2GearJoint=b2GearJoint,exports.b2DynamicTree=b2DynamicTree,exports.b2JointEdge=b2JointEdge,exports.b2LineJoint=b2LineJoint,exports.b2NullContact=b2NullContact,exports.b2ContactListener=b2ContactListener,exports.b2RayCastInput=b2RayCastInput,exports.b2TOIInput=b2TOIInput,exports.Features=Features,exports.b2FilterData=b2FilterData,exports.b2Island=b2Island,exports.b2ContactManager=b2ContactManager,exports.b2ContactSolver=b2ContactSolver,exports.b2Simplex=b2Simplex,exports.b2AABB=b2AABB,exports.b2Jacobian=b2Jacobian,exports.b2Bound=b2Bound,exports.b2RevoluteJointDef=b2RevoluteJointDef,exports.b2PolyAndEdgeContact=b2PolyAndEdgeContact,exports.b2SimplexVertex=b2SimplexVertex,exports.b2WeldJoint=b2WeldJoint,exports.b2Collision=b2Collision,exports.b2Mat22=b2Mat22,exports.b2SimplexCache=b2SimplexCache,exports.b2PolyAndCircleContact=b2PolyAndCircleContact,exports.b2MouseJointDef=b2MouseJointDef,exports.b2Shape=b2Shape,exports.b2Segment=b2Segment,exports.b2ContactRegister=b2ContactRegister,exports.b2DebugDraw=b2DebugDraw,exports.b2Sweep=b2Sweep),define("lib/Box2d",function(){}),define("engine/PhysicsManager",["core/Monogatari","core/Constants","core/Timer","core/collection/Map","lib/Three","lib/Box2d","engine/EventManager"],function(){function a(){this.world=null,this.velocityIterations=10,this.positionIterations=10,this.clearForcesOnUpdate=!1}Monogatari.PhysicsManager=new a,a.prototype.createWorld=function(a,b){this.world=new b2World(new b2Vec2(a.x,a.y),b),this.createListener()},a.prototype.createBody=function(a){return this.world.CreateBody(a)},a.prototype.createListener=function(){var a=new b2ContactListener;a.BeginContact=function(a){Monogatari.EventManager.notify("PhysicsManager.beginContact",a)},a.EndContact=function(a){Monogatari.EventManager.notify("PhysicsManager.endContact",a)},this.world.SetContactListener(a)},a.prototype.update=function(){if(this.world){var a=Monogatari.Frames.getFps();this.world.Step(a?1/a:Monogatari.Constants.FRAME_RATE_60FPS,this.velocityIterations,this.positionIterations),this.clearForcesOnUpdate&&this.world.ClearForces()}}}),define("engine/GameManager",["core/Monogatari","core/Timer","core/String","engine/EventManager","engine/AudioManager","engine/FontManager","engine/SceneManager","engine/ObjectManager","engine/PhysicsManager"],function(){function a(){}Monogatari.GameManager=new a,a.prototype.init=function(a,b,c,d){Monogatari.SceneManager.init(a,b,c,d)},a.prototype.update=function(){Monogatari.Time.tick(),Monogatari.PhysicsManager.update(),Monogatari.ObjectManager.update()},a.prototype.render=function(){Monogatari.SceneManager.render()},a.prototype.run=function(){requestAnimationFrame(Monogatari.GameManager.run),Monogatari.GameManager.update(),Monogatari.GameManager.render()}});