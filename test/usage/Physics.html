<!DOCTYPE html>
<meta charset="UTF-8">
<html>

<head>
  <title>Physics Usage - Monogatari</title>
  <link href="css/style.css" rel="stylesheet">
  <script src="../../dist/latest/monogatari.js"></script>
</head>

<body>

</body>
<script>
  var m = Monogatari;

  m.init();

  m.physicsManager.createWorld(new m.THREE.Vector2(0, 10), true, null, m.world);

  // zombieShape
  var zombieShape = new m.Box2D.b2CircleShape();
  zombieShape.set_m_radius(0.5);

  // zombie1
  var zombie = new m.GameObject('zombie1');
  var rb1 = new m.RigidBody(50);

  rb1.setType(m.RigidBody.TYPE.DYNAMIC);
  rb1.setDensity(1);
  rb1.setFriction(0);
  rb1.setBounciness(1);
  rb1.setPosition(3, 1);
  rb1.setUserData(zombie.uid);

  var sprite = new m.Sprite('../assets/zombies.png', 64, 64, 1, 3);

  zombie.addComponent(sprite);
  zombie.addComponent(rb1);

  rb1.setShape(zombieShape);
  rb1.createFixture();

  // Only zombie 1 displays messages, to avoid flood of information
  zombie.update = function () {
    var message = this.messages.pop();
    sprite.nextFrame();
    if (message) {
      console.log(message);
    }
  };

  m.world.children.push(zombie);

  // zombie2
  var zombie2 = new m.GameObject('zombie2');
  var rb2 = new m.RigidBody(50);

  rb2.setType(m.RigidBody.TYPE.DYNAMIC);
  rb2.setDensity(1);
  rb2.setFriction(0);
  rb2.setBounciness(1);
  rb2.setPosition(2.7, 0.5);
  rb2.setUserData(zombie2.uid);

  zombie2.addComponent(new m.Sprite('../assets/zombies.png', 64, 64, 1, 3));
  zombie2.addComponent(rb2);

  rb2.setShape(zombieShape);
  rb2.createFixture();

  //<hacking>
  //          var buffer = Box2D.allocate( Box2D.intArrayFromString( "bolovo" ), 'i8', Box2D.ALLOC_STACK );
  //
  //          rb2.body.SetUserData( buffer );
  //          //rb2.body.SetUserData( 35 );
  //          //console.log(  rb2.body.GetUserData() );
  //
  //          var userData = rb2.body.GetUserData();
  //          console.log( String.fromCharCode( Box2D.getValue( userData, 'i8' ) ) ); // b
  //          console.log( String.fromCharCode( Box2D.getValue( userData + 1, 'i8' ) ) ); // o
  //          console.log( String.fromCharCode( Box2D.getValue( userData + 2, 'i8' ) ) ); // l
  //          console.log( String.fromCharCode( Box2D.getValue( userData + 3, 'i8' ) ) ); // o
  //          console.log( String.fromCharCode( Box2D.getValue( userData + 4, 'i8' ) ) ); // v
  //          console.log( String.fromCharCode( Box2D.getValue( userData + 5, 'i8' ) ) ); // o
  //</hacking>

  m.world.children.push(zombie2);

  //zombie3
  var zombie3 = new m.GameObject('zombie3');
  var rb3 = new m.RigidBody(50);

  rb3.setType(m.RigidBody.TYPE.DYNAMIC);
  rb3.setDensity(1);
  rb3.setFriction(0);
  rb3.setBounciness(1);
  rb3.setPosition(1.7, 0.5);
  rb3.setUserData(zombie3.uid);

  zombie3.addComponent(new m.Sprite('../assets/zombies.png', 64, 64, 1, 3));
  zombie3.addComponent(rb3);

  rb3.setShape(zombieShape);
  rb3.createFixture();

  m.world.children.push(zombie3);

  //zombie4
  var zombie4 = new m.GameObject('zombie4');
  var rb4 = new m.RigidBody(50);

  rb4.setType(m.RigidBody.TYPE.DYNAMIC);
  rb4.setDensity(1);
  rb4.setFriction(0);
  rb4.setBounciness(1);
  rb4.setPosition(2.1, 0.5);
  rb4.setUserData(zombie4.uid);

  zombie4.addComponent(new m.Sprite('../assets/zombies.png', 64, 64, 1, 3));
  zombie4.addComponent(rb4);

  rb4.setShape(zombieShape);
  rb4.createFixture();

  m.world.children.push(zombie4);

  // ground
  var ground = new m.GameObject('ground');
  var groundBody = new m.RigidBody(50);

  groundBody.setType(m.RigidBody.TYPE.STATIC);
  groundBody.setDensity(1);
  groundBody.setFriction(0);
  groundBody.setBounciness(1);
  groundBody.setPosition(0, 10);
  groundBody.setUserData(ground.uid);

  ground.addComponent(groundBody);

  var groundShape = new m.Box2D.b2PolygonShape();
  groundShape.SetAsBox(100, 0.5);
  groundBody.setShape(groundShape);
  groundBody.createFixture();

  m.world.children.push(ground);

  // wall shape
  var wallShape = new m.Box2D.b2PolygonShape();
  wallShape.SetAsBox(0.5, 100);

  // left wall
  var lWall = new m.GameObject('lWall');
  var lWallBody = new m.RigidBody(50);

  lWallBody.setType(m.RigidBody.TYPE.STATIC);
  lWallBody.setDensity(1);
  lWallBody.setFriction(0);
  lWallBody.setBounciness(1);
  lWallBody.setPosition(0, 0);
  lWallBody.setUserData(lWall.uid);

  lWall.addComponent(lWallBody);

  lWallBody.setShape(wallShape);
  lWallBody.createFixture();

  m.world.children.push(lWall);

  // right wall
  var rWall = new m.GameObject('rWall');
  var rWallBody = new m.RigidBody(50);

  rWallBody.setType(m.RigidBody.TYPE.STATIC);
  rWallBody.setDensity(1);
  rWallBody.setFriction(0);
  rWallBody.setBounciness(1);
  rWallBody.setPosition(10, 0);
  rWallBody.setUserData(rWall.uid);

  rWall.addComponent(rWallBody);

  rWallBody.setShape(wallShape);
  rWallBody.createFixture();

  m.world.children.push(rWall);
  m.run();
</script>

</html>