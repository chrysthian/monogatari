<!DOCTYPE html>
<html>
    <head>
        <title>Endless Zombies</title>
        <script type="text/javascript" src="../../lib/Require.js"></script>
        <script>

        require.config( {
          baseUrl : '../../src',
          paths: {
              lib: '../lib'
          }
        } );

        require( [ 'Monogatari' ], function( m ) {

          m.init( "#000" );

          // game objects
          var hero = new m.GameObject('hero');
          var r = new m.Random();

          //center the hero on the screen
          hero.position.set( m.sceneManager.canvasWidth / 2, m.sceneManager.canvasHeight / 2, 0 );

          var sprite = new m.Sprite( 'assets/sprites/generico_tosco.png', 64, 64 );
          hero.addComponent(sprite);
          hero.life = 100;

          hero.update = function(){
            var speed = 200 / m.timer.fps;

            if ( m.keyboard.isDown( m.keyboard.W ) ) { this.position.y -= speed; }
            if ( m.keyboard.isDown( m.keyboard.A ) ) { this.position.x -= speed; }
            if ( m.keyboard.isDown( m.keyboard.S ) ) { this.position.y += speed; }
            if ( m.keyboard.isDown( m.keyboard.D ) ) { this.position.x += speed; }

            if ( m.keyboard.isDown( m.keyboard.UP_ARROW ) ) { this.position.y -= speed; }
            if ( m.keyboard.isDown( m.keyboard.LEFT_ARROW ) ) { this.position.x -= speed; }
            if ( m.keyboard.isDown( m.keyboard.DOWN_ARROW ) ) { this.position.y += speed; }
            if ( m.keyboard.isDown( m.keyboard.RIGHT_ARROW ) ) { this.position.x += speed; }

            if ( m.mouse.isDown( m.mouse.LMB ) ) shoot( this.position.x, this.position.y );

            this.lookAt( m.mouse.position );
          };

          m.sceneManager.attachToScene( hero );

          m.world.children.push( hero );

          //zombies
          var NUM_ZOMBIES = 30;
          var ZOMBIE_LIFE = 2;
          var ZOMBIE_SPEED = 150;
          var ZOMBIE_ATTACK_SPEED = 400;
          var ZOMBIE_ANIMATION_SPEED = 300;

          var zombies = new m.Map();
          var zombieIt = zombies.iterator(); 

          function bufferZombies(){
            var zombie = null;

            for ( var i = 0; i < NUM_ZOMBIES; i++ ) {
              var sprite = new m.Sprite( 'assets/sprites/zombies2.png', 64, 64, 1, 3 );
              zombie = new m.GameObject( 'zombie_' + i );
              zombie.position.set( -2000, 2000, 0 );
              zombie.isActive = false;
              zombie.isVisible = false;
              zombie.lastUpdate = 0;

              zombie.addComponent( sprite );

              zombie.lastAttackUpdate = 0;
              zombie.life = ZOMBIE_LIFE;
              zombie.speed = ZOMBIE_SPEED;
              zombie.attackSpeed = ZOMBIE_ATTACK_SPEED;
              zombie.animationSpeed = ZOMBIE_ANIMATION_SPEED;

              zombie.reset = function(){
                this.isActive = false;
                this.isVisible = false;
                this.lastUpdate = 0;
                this.position.set( -2000, 2000, 0 );
                this.life = ZOMBIE_LIFE;
              }

              zombie.attack = function(){
                if ( (m.timer.time - this.lastAttackUpdate) > this.attackSpeed ) {
                  hero.life--;
                  this.lastAttackUpdate = m.timer.time;
                }
              }

              zombie.update = function() {
                if( this.isActive ) {
                  var sprite = this.findComponent( m.Base.SPRITE );
                  var speed = this.speed / m.timer.fps ;

                  this.lookAt( hero.position );

                  this.position.x += this.rotation.x * speed;
                  this.position.y += this.rotation.y * speed;

                  if ( (m.timer.time - sprite.lastUpdate ) > this.animationSpeed ) {
                    sprite.nextFrame();
                    sprite.lastUpdate = m.timer.time;
                  }

                  if ( this.position.x < -64 || this.position.x > m.sceneManager.canvasWidth + 64 || this.position.y < -64 || this.position.y > m.sceneManager.canvasHeight +64 ){
                    this.reset();
                  }

                }
              }

              m.sceneManager.attachToScene( zombie );
              m.world.children.push( zombie );
              zombies.put( zombie.id, zombie );

            }
          };
          bufferZombies();
          // game objects

          // game specifics
          function die() {
            hero.position.set(-2000, 2000);
            hero.update = function() {};
            alert( "You died!\nKilling " + score + " zombies" );
          };

          function collision( positionA, radiusA, positionB, radiusB ) {
            var dist = positionA.distanceTo( positionB );
            var radius = radiusA + radiusB;
            return ( dist < radius ) ? true : false;
          }

          function spawnZombies(){
            zombieIt.first();
            var obj = null;

            while ( zombieIt.hasNext() ) {
              obj = zombieIt.next();

              if ( obj && !obj.isActive && !obj.isVisible) {
                obj.isActive = true;
                obj.isVisible = true;

                switch ( r.integer( { min : 1, max : 4 } ) ) {
                case 1:
                  obj.position.x = r.floating( { min : 0, max : m.sceneManager.canvasWidth } );
                  obj.position.y = - 63;
                  obj.position.z = 0;
                  break;
                case 2:
                  obj.position.x = - 63;
                  obj.position.y = r.floating( { min : 0, max : m.sceneManager.canvasHeight } );
                  obj.position.z = 0;
                  break;
                case 3:
                  obj.position.x = m.sceneManager.canvasWidth + 63;
                  obj.position.y = r.floating( { min : 0, max : m.sceneManager.canvasHeight } );
                  obj.position.z = 0;
                  break;
                case 4:
                  obj.position.x = r.floating( { min : 0, max : m.sceneManager.canvasWidth } );
                  obj.position.y = m.sceneManager.canvasHeight + 63;
                  obj.position.z = 0;
                  break;
                }
              }
            }

          };

          // bullets
          var MAX_BULLETS = 40;
          var BULLET_SPEED = 600;
          var BULLET_ANIMATION_SPEED = 300;
          var TIME_BETWEEN_SHOTS = 100;

          var bullets = new m.Map();
          var bulletIt = bullets.iterator(); 

          function bufferBullets(){
            var bullet = null;

            for ( var i = 0; i < MAX_BULLETS; i++ ) {
              var sprite = new m.Sprite( 'assets/sprites/bullet.png', 16, 16, 2, 1 );

              bullet = new m.GameObject( 'bullet_' + i );
              bullet.position.set( -2000, 2000, 0 );
              bullet.isActive = false;
              bullet.isVisible = false;

              bullet.addComponent( sprite );
              bullet.speed = BULLET_SPEED;
              bullet.animationSpeed = BULLET_ANIMATION_SPEED;

              bullet.reset = function() {
                this.isActive = false;
                this.isVisible = false;
                this.position.set(-2000, 3000, 0);
              };

              bullet.update = function() {
                var speed = this.speed / m.timer.fps ;
                var sprite = this.findComponent( m.Base.SPRITE );

                if ( (m.timer.time - sprite.lastUpdate ) > this.animationSpeed ) {
                  sprite.nextFrame();
                  sprite.lastUpdate = m.timer.time;
                }

                this.position.x += this.rotation.x * speed;
                this.position.y += this.rotation.y * speed;

                if ( this.position.x < 0 || this.position.x > m.sceneManager.canvasWidth || this.position.y < 0 || this.position.y > m.sceneManager.canvasHeight ){
                  this.reset();
                }

              };

              m.sceneManager.attachToScene( bullet );
              m.world.children.push( bullet );
              bullets.put( bullet.id, bullet );

             }
          };
          bufferBullets();

          var lastShot = m.timer.time;
          function shoot( fromX, fromY ) {

            if ( (m.timer.time - lastShot ) > TIME_BETWEEN_SHOTS ) {
              bulletIt.first();

              while ( bulletIt.hasNext() ) {
                obj = bulletIt.next();

                if ( obj ) {
                  if ( !obj.isActive && !obj.isVisible ) {
                    var sprite = obj.findComponent( m.Base.SPRITE );

                    obj.isActive = true;
                    obj.isVisible = true;

                    obj.position.set(fromX, fromY, 0);

                    obj.lookAt( m.mouse.position );

                    lastShot = m.timer.time;
                    return;
                  }
                }
              }

            }
          }

          var score = 0;
          function checkCollisions(){

            // verifica colisão de zombies com bullets
            var z = null;
            var b = null;

            zombieIt.first();

            while ( zombieIt.hasNext() ) {
              z = zombieIt.next();

              bulletIt.first();

              while ( bulletIt.hasNext() ) {
                b = bulletIt.next();

                if ( collision( b.position, 8, z.position, 32 ) ) {
                  b.reset();
                  z.life--;

                  if ( z.life <= 0 ) {
                    z.reset();
                    score++;
                  }
                }
              }
            }

            // verifica colisão de hero com zombies
            zombieIt.first();
            while ( zombieIt.hasNext() ) {
              z = zombieIt.next();
              if ( collision( hero.position, 32, z.position, 32 ) ) {
                z.attack();
              }
            }

          }

          var gameOver = false;
          function checkForGameOver(){
            // check if the hero is dead and finish the game
            if( hero.life < 100 && !gameOver){
              die();
              gameOver = true;
            }
          }

          m.world.update = function() {
            spawnZombies();
            checkCollisions();
            checkForGameOver();
          };
          // game specifics

          m.run();
        });
        </script>
    </head>
    <body>

    </body>
</html>
