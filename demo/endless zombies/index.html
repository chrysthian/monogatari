<!DOCTYPE html>
<html>
<head>
<title>Endless Zombies</title>
<style type="text/css">
body {
	margin: 0;
	padding: 0;
	overflow: hidden;
}
</style>
<script type="text/javascript" src="../../dist/monogatari-0.1.0-dev.js"></script>
<!--
<script type="text/javascript" src="../../lib/Require.js"></script>
<script>
  require.config( {
    baseUrl : '../../src',
    paths: {
        lib: '../lib'
    }
  } );    
</script>
-->
<script>
  require( [ 'Monogatari' ], function( m ) {

    m.init( "#000" );

    require( [ 'go/single/Hero', 'buffer/Bullets', 'buffer/Zombies' ], function( Hero, Bullets, Zombies ) {

      var score = 0;
      var gameOver = false;

      function collision( positionA, radiusA, positionB, radiusB ) {
        var dist = positionA.distanceTo( positionB );
        var radius = radiusA + radiusB;
        return ( dist < radius ) ? true : false;
      };

      function checkCollisions() {
        var z = null;
        Zombies.bufferIt.first();

        while ( Zombies.bufferIt.hasNext() ) {
          z = Zombies.bufferIt.next();

          // checks zombie/hero collision
          if ( collision( Hero.position, 32, z.position, 32 ) ) {
            z.attack();
          }

          // checks zombie/bullet collision
          var b = null;
          Bullets.bufferIt.first();

          while ( Bullets.bufferIt.hasNext() ) {
            b = Bullets.bufferIt.next();

            if ( collision( b.position, 8, z.position, 32 ) ) {
              b.reset();
              z.life--;
              if ( z.life <= 0 ) {
                score++;
              }
            }
          }
        }
      }

      function die() {
        Hero.position.set( -2000, 2000 );
        Hero.update = function() {};
        alert( 'You died!\nKilling ' + score + ' zombies' );
      };

      m.world.update = function() {
        Zombies.spawnZombies();
        checkCollisions();

        // check if the hero is dead and finish the game
        if ( Hero.life < 0 && !gameOver ) {
          die();
          gameOver = true;
        }
      };

      m.run();

    } );
  } );
</script>
</head>
<body>
</body>
</html>
