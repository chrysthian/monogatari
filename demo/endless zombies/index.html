<!DOCTYPE html>
<html>
    <head>
        <title>Endless Zombies</title>
        <style type="text/css">
        body {
          margin: 0;
          padding: 0;
          overflow: hidden;
        }
        </style>
        
        <script type="text/javascript" src="../../dist/monogatari-0.1.0-dev.js"></script> 
		<!--
        <script type="text/javascript" src="../../lib/Require.js"></script>
        <script>
        require.config( {
          baseUrl : '../../src',
          paths: {
              lib: '../lib'
          }
        } );
        
        </script>
         -->   
        
        <script>
        require( [ 'Monogatari' ], function( m ) {

          m.init( "#000" );

          require( [ 'gos/Hero', 'buffers/Bullets' ], function( hero, bullets ) {
        
            m.sceneManager.attachToScene( hero );
            m.world.children.push( hero );
                      
	        	var r = new m.Random();
	
	          //zombies
	          var NUM_ZOMBIES = 30;
	          var ZOMBIE_LIFE = 2;
	          var ZOMBIE_SPEED = 150;
	          var ZOMBIE_ATTACK_SPEED = 150;
	          var ZOMBIE_ANIMATION_SPEED = 300;
	
	          var zombies = new m.Map();
	          var zombieIt = zombies.iterator(); 
	
	          function bufferZombies(){
	            var zombie = null;
	
	            for ( var i = 0; i < NUM_ZOMBIES; i++ ) {
	              var sprite = new m.Sprite( 'assets/sprites/zombies2.png', 64, 64, 1, 3 );
	              zombie = new m.GameObject( 'zombie_' + i );
	              zombie.position.set( -2000, 2000, 0 );
	              zombie.isActive = false;
	              zombie.isVisible = false;
	              zombie.lastUpdate = 0;
	
	              zombie.addComponent( sprite );
	
	              zombie.lastAttackUpdate = 0;
	              zombie.life = ZOMBIE_LIFE;
	              zombie.speed = ZOMBIE_SPEED;
	              zombie.attackInterval = ZOMBIE_ATTACK_SPEED;
	              zombie.animationSpeed = ZOMBIE_ANIMATION_SPEED;
	
	              zombie.reset = function(){
	                this.isActive = false;
	                this.isVisible = false;
	                this.lastUpdate = 0;
	                this.position.set( -2000, 2000, 0 );
	                this.life = ZOMBIE_LIFE;
	              }
	
	              zombie.attack = function(){
	                if ( (m.timer.time - this.lastAttackUpdate) > this.attackInterval ) {
	                  hero.life--;
	                  this.lastAttackUpdate = m.timer.time;
	                }
	              }
	
	              zombie.update = function() {
	                if( this.isActive ) {
	                  var sprite = this.findComponent( m.Base.SPRITE );
	                  var speed = this.speed / m.timer.fps ;
	
	                  this.lookAt( hero.position );
	
	                  this.position.x += this.rotation.x * speed;
	                  this.position.y += this.rotation.y * speed;
	
	                  if ( (m.timer.time - sprite.lastUpdate ) > this.animationSpeed && r.integer( { min : 1, max : 2 } ) ) {
	                    sprite.nextFrame();
	                    sprite.lastUpdate = m.timer.time;
	                  }
	
	                  if ( this.position.x < -64 || this.position.x > m.sceneManager.canvasWidth + 64 || this.position.y < -64 || this.position.y > m.sceneManager.canvasHeight +64 ){
	                    this.reset();
	                  }
	
	                }
	              }
	
	              m.sceneManager.attachToScene( zombie );
	              m.world.children.push( zombie );
	              zombies.put( zombie.id, zombie );
	
	            }
	          };
	          
	          bufferZombies();
	
	          // game specifics
	          function die() {
	            hero.position.set(-2000, 2000);
	            hero.update = function() {};
	            alert( "You died!\nKilling " + score + " zombies" );
	          };
	
	          function collision( positionA, radiusA, positionB, radiusB ) {
	            var dist = positionA.distanceTo( positionB );
	            var radius = radiusA + radiusB;
	            return ( dist < radius ) ? true : false;
	          }
	
	          function spawnZombies(){
	            zombieIt.first();
	            var obj = null;
	
	            while ( zombieIt.hasNext() ) {
	              obj = zombieIt.next();
	
	              if ( obj && !obj.isActive && !obj.isVisible) {
	                obj.isActive = true;
	                obj.isVisible = true;
	
	                switch ( r.integer( { min : 1, max : 4 } ) ) {
	                case 1:
	                  obj.position.x = r.floating( { min : 0, max : m.sceneManager.canvasWidth } );
	                  obj.position.y = - 63;
	                  obj.position.z = 0;
	                  break;
	                case 2:
	                  obj.position.x = - 63;
	                  obj.position.y = r.floating( { min : 0, max : m.sceneManager.canvasHeight } );
	                  obj.position.z = 0;
	                  break;
	                case 3:
	                  obj.position.x = m.sceneManager.canvasWidth + 63;
	                  obj.position.y = r.floating( { min : 0, max : m.sceneManager.canvasHeight } );
	                  obj.position.z = 0;
	                  break;
	                case 4:
	                  obj.position.x = r.floating( { min : 0, max : m.sceneManager.canvasWidth } );
	                  obj.position.y = m.sceneManager.canvasHeight + 63;
	                  obj.position.z = 0;
	                  break;
	                }
	              }
	            }
	
	          };

	          var score = 0;
	          function checkCollisions(){
	
	            // verifica colisão de zombies com bullets
	            var z = null;
	            var b = null;
	
	            zombieIt.first();
	
	            while ( zombieIt.hasNext() ) {
	              z = zombieIt.next();
	
	              bullets.bufferIt.first();
	
	              while ( bullets.bufferIt.hasNext() ) {
	                b = bullets.bufferIt.next();
	
	                if ( collision( b.position, 8, z.position, 32 ) ) {
	                  b.reset();
	                  z.life--;
	
	                  if ( z.life <= 0 ) {
	                    z.reset();
	                    score++;
	                  }
	                }
	              }
	            }
	
	            // verifica colisão de hero com zombies
	            zombieIt.first();
	            while ( zombieIt.hasNext() ) {
	              z = zombieIt.next();
	              if ( collision( hero.position, 32, z.position, 32 ) ) {
	                z.attack();
	              }
	            }
	
	          }
	
	          var gameOver = false;
	          function checkForGameOver(){
	            // check if the hero is dead and finish the game
	            if( hero.life < 0 && !gameOver){
	              die();
	              gameOver = true;
	            }
	          }
	
	          m.world.update = function() {
	            spawnZombies();
	            checkCollisions();
	            checkForGameOver();
	          };
	          // game specifics
	
	          m.run();                  
          });
        });
        </script>
    </head>
    <body>
    </body>
</html>
